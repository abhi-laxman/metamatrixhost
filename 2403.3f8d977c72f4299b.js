"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[2403],{22403:(et,K,u)=>{u.r(K),u.d(K,{uploadAssets:()=>je});var l=u(10467),m=u(89563),F=u(3248),ae=u(35150),p=u(56492),T=u(82595),d=u(45272),ie=u(43085),ue=u(32034),v=u(33019),g=u(41377);const b={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};var le=u(68438),pe=u(17715),ce=u(60797);function P(s,e=(n=>{}),t){return new fe(s,e,t)}class fe{constructor(e,t=(r=>{}),n){if(this.onProgress=t,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,"number"==typeof e){this._weights={};for(let r=0;r<e;r++){const o=r;this._weights[o]=1/e,this._progressMap.set(o,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(const[t,n]of this._progressMap.entries())e+=n*this._weights[t];if(1===e&&(0,F.A)("enable-feature:esri-3dofl-upload-timings")){const t=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${t} sec`);for(const[n,r]of this._timingsMap){const o=Math.round(r.end-r.start)/1e3,a=Math.round(o/t*100);console.log(this.taskName??"Task",{stepKey:n,stepTime:o,relativeTime:a})}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),(0,F.A)("enable-feature:esri-3dofl-upload-timings")){const n=performance.now();this._startTime??=n;const r=(0,ce.tE)(this._timingsMap,e,()=>({start:n,end:0}));1===t&&(r.end=n)}this.emitProgress()}simulate(e,t){return Q(n=>this.setProgress(e,n),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}}function Q(s=(t=>{}),e=Ae){const t=performance.now();s(0);const n=setInterval(()=>{const r=performance.now()-t,o=1-Math.exp(-r/e);s(o)},ye);return(0,pe.hA)(()=>{clearInterval(n),s(1)})}function me(s,e=ge){return(0,T.gr)((0,T.Kp)(s*_/e))}const ge=10,he=10,_=8e-6,ye=(0,T.l5)(50),Ae=(0,T.l5)(1e3),V=1e6,Y=20*V,xe=2e9,Te=3;function N(){return N=(0,l.A)(function*({data:s,name:e,description:t},n,r){let o=null;try{const a=(0,d.fj)(n,"uploads"),i=(0,d.fj)(a,"info"),{data:f}=yield(0,m.A)(i,{query:{f:"json"},responseType:"json"});(0,p.Te)(r);const A=(0,le.Wo)(n),x=f.maxUploadFileSize*V,h=A?xe:x,c=A?Math.min(Y,x):Y;if(s.size>h)throw new Error("Data too large");const Qe=(0,d.fj)(a,"register"),{data:te}=yield(0,m.A)(Qe,{query:{f:"json",itemName:Pe(e),description:t},responseType:"json",method:"post"});if((0,p.Te)(r),!te.success)throw new Error("Registration failed");const{itemID:_e}=te.item;o=(0,d.fj)(a,_e);const Ve=(0,d.fj)(o,"uploadPart"),se=Math.ceil(s.size/c),M=new Array;for(let y=0;y<se;++y)M.push(s.slice(y*c,Math.min((y+1)*c,s.size)));const S=M.slice().reverse(),ne=new Array,Ye=P(se,r?.onProgress,"uploadItem"),ke=function(){var y=(0,l.A)(function*(){for(;0!==S.length;){const j=M.length-S.length,oe=S.pop(),U=new FormData,Ze=Ye.simulate(j,me(oe.size));try{U.append("f","json"),U.append("file",oe),U.append("partId",`${j}`);const{data:qe}=yield(0,m.A)(Ve,{timeout:0,body:U,responseType:"json",method:"post"});if((0,p.Te)(r),!qe.success)throw new Error("Part upload failed")}finally{Ze.remove()}}});return function(){return y.apply(this,arguments)}}();for(let y=0;y<Te&&0!==S.length;++y)ne.push(ke());yield Promise.all(ne);const Xe=(0,d.fj)(o,"commit"),{data:re}=yield(0,m.A)(Xe,{query:{f:"json",parts:M.map((y,j)=>j).join(",")},responseType:"json",method:"post"});if((0,p.Te)(r),!re.success)throw new Error("Commit failed");return re.item}catch(a){if(null!=o){const i=(0,d.fj)(o,"delete");yield(0,m.A)(i,{query:{f:"json"},responseType:"json",method:"post"})}throw a}}),N.apply(this,arguments)}function Pe(s){return s.replaceAll("/","_").replaceAll("\\","_")}var w=u(6829),we=u(3158),k=u(89761);function je(s,e,t){return E.apply(this,arguments)}function E(){return E=(0,l.A)(function*(s,e,t){const n=s.length;if(!n)return t?.onProgress?.(1),[];const r=P(n,t?.onProgress,"uploadAssets");return Promise.all(s.map((o,a)=>function Fe(s,e,t){return C.apply(this,arguments)}(o,e,{...t,onProgress:r.makeOnProgress(a)})))}),E.apply(this,arguments)}function C(){return C=(0,l.A)(function*(s,{layer:e,ongoingUploads:t},n){const r=t.get(s);if(r)return r;if(!function Ge(s){return!!s.infoFor3D&&!!s.url}(e))throw new g.Wt;if(function Me(s,e){const{parsedUrl:t}=e;return null!=t&&s.metadata.externalSources.some(n=>(0,v.eN)(n,t))}(s,e))return n?.onProgress?.(1),s;const o=function Se(s,e,t){return D.apply(this,arguments)}(s,e,n);t.set(s,o);try{yield o}finally{t.delete(s)}return s}),C.apply(this,arguments)}function D(){return D=(0,l.A)(function*(s,e,t){const{metadata:n}=s,{displaySource:r}=n,o=X(r?.source,e,{checkForConversionRequired:(0,F.A)("enable-feature:georeferenced-uploads")}),a=null!=o?function Ue(s,e,t){return R.apply(this,arguments)}(o,e,t):n.externalSources.length>0?function be(s,e,t){return I.apply(this,arguments)}(s,e,t):function Ne(s,e,t){return B.apply(this,arguments)}(s,e,t),i=yield a;return(0,p.Te)(t),s.addExternalSources([i]),s}),D.apply(this,arguments)}function R(){return(R=(0,l.A)(function*(s,e,t){return{source:yield Z(s,e,t),original:!0,unitConversionDisabled:!0}})).apply(this,arguments)}function I(){return I=(0,l.A)(function*(s,e,t){const n=ee(e),{externalSources:r}=s.metadata,o=function Ce(s,e){for(const t of s){const n=X(t.source,e);if(n)return n}return null}(r,e);if(!o)throw new g.xY;const a=P(b.uploadConvertibleSource,t?.onProgress,"uploadConvertibleSource"),i=yield Z(o,e,{onProgress:a.makeOnProgress("uploadEditSource")});s.addExternalSources([{source:i,original:!0}]);const f=o.reduce((x,{asset:h})=>h instanceof File?x+h.size:x,0),A=a.simulate("serviceAssetsToGlb",function de(s,e=he){return(0,T.gr)((0,T.Kp)(s*_/e))}(f));try{const{source:x,transform:h,origin:c}=yield function Le(s,e,t){return G.apply(this,arguments)}(i,e,n);return s.transform=h,c&&(s.metadata.georeferenced=!0,t?.useAssetOrigin&&(s.vertexSpace.origin=[c.x,c.y,c.z??0],s.spatialReference=c.spatialReference)),{source:x,unitConversionDisabled:!0}}finally{A.remove()}}),I.apply(this,arguments)}function B(){return B=(0,l.A)(function*(s,e,t){const n=P(b.uploadLocalMesh,t?.onProgress,"uploadLocalMesh"),r=function Ee(s,e,t){return O.apply(this,arguments)}(s,e,{...t,onProgress:n.makeOnProgress("meshToAssetBlob")});return{source:yield q([r],e,{...t,onProgress:n.makeOnProgress("uploadAssetBlobs")}),extent:s.extent.clone(),original:!0}}),B.apply(this,arguments)}function O(){return(O=(0,l.A)(function*(s,e,t){const n=ee(e),r=yield s.load(t),o=yield r.toBinaryGLTF({origin:r.origin,signal:t?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return(0,p.Te)(t),{blob:new Blob([o],{type:"model/gltf-binary"}),assetName:`${(0,ie.yS)()}.glb`,assetType:n}})).apply(this,arguments)}function X(s,{infoFor3D:e},t={}){if(!s)return null;const{supportedFormats:n,editFormats:r}=e,o=(0,v.WN)(s),a=new Array,i=(0,w.ND)(e),f=(0,w.nr)(e);let A=!1;for(const x of o){const h=De(x,n);if(!h)return null;const{assetType:c}=h;if(t.checkForConversionRequired&&(c===i||c===f))return null;r.includes(c)&&(A=!0),a.push(h)}return A?a:null}function De(s,e){const t=(0,v.fH)(s,e);return t?{asset:s,assetType:t}:null}function Z(s,e,t){return z.apply(this,arguments)}function z(){return z=(0,l.A)(function*(s,e,t){return q(s.map(n=>function Re(s,e){return $.apply(this,arguments)}(n,t)),e,t)}),z.apply(this,arguments)}function q(s,e,t){return L.apply(this,arguments)}function L(){return L=(0,l.A)(function*(s,e,t){const n=P(b.uploadAssetBlobs,t?.onProgress,"uploadAssetBlobs"),r=yield function Be(s,e,t){const n=P(s.length,t?.onProgress,"prepareAssetItems");return Promise.all(s.map(function(){var r=(0,l.A)(function*(o,a){const i=function Ie(s,e,t){return H.apply(this,arguments)}(yield o,e,{...t,onProgress:n.makeOnProgress(a)});return(0,p.Te)(t),i});return function(o,a){return r.apply(this,arguments)}}()))}(s,e,{...t,onProgress:n.makeOnProgress("prepareAssetItems")});(0,p.Te)(t);const o=r.map(({item:i})=>i),{uploadResults:a}=yield function Oe(s,e,t){return W.apply(this,arguments)}(o,e,{...t,onProgress:n.makeOnProgress("uploadAssetItems")});return(0,p.Te)(t),s.map((i,f)=>function ze(s,e,t){const{success:n}=e;if(!n){const{error:A}=e;throw new g.hK(s.assetName,A)}const{assetHash:r}=e,{assetName:o,item:{assetType:a}}=s,{infoFor3D:{supportedFormats:i}}=t,f=(0,w.Fm)(a,i);if(!f)throw new g.H2(a);return new v.Qp(o,f,[new v.Bq(`${t.parsedUrl.path}/assets/${r}`,r)])}(r[f],a[f],e))}),L.apply(this,arguments)}function $(){return($=(0,l.A)(function*(s,e){const{asset:t,assetType:n}=s;if(t instanceof File)return{blob:t,assetName:t.name,assetType:n};const r=yield t.toBlob(e);return(0,p.Te)(e),{blob:r,assetName:t.assetName,assetType:n}})).apply(this,arguments)}function H(){return H=(0,l.A)(function*(s,e,t){const{blob:n,assetType:r,assetName:o}=s;let a=null;try{const i=yield function ve(s,e,t){return N.apply(this,arguments)}({data:n,name:o},e.url,t);(0,p.Te)(t),a={assetType:r,assetUploadId:i.itemID}}catch(i){(0,p.QP)(i),function Je(){return ae.A.getLogger("esri.layers.graphics.sources.support.uploadAssets")}().warnOnce(`Service ${e.url} does not support the REST Uploads API.`)}if(!a){const i=yield(0,d._0)(n);if((0,p.Te)(t),!i.isBase64)throw new g.$1;a={assetType:r,assetData:i.data}}if(!a)throw new g.WF;return{item:a,assetName:o}}),H.apply(this,arguments)}function W(){return(W=(0,l.A)(function*(s,e,t){const n=Q(t?.onProgress);try{const r=yield(0,m.A)((0,d.fj)(e.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(s)},method:"post",responseType:"json"});if((0,p.Te)(t),r.data.uploadResults.length!==s.length)throw new g.nS(s.length,r.data.uploadResults.length);return r.data}finally{n.remove()}})).apply(this,arguments)}function G(){return(G=(0,l.A)(function*(s,e,t){const n=s.map(({assetName:o,parts:a})=>({assetName:o,assetHash:a[0].partHash}));let r;try{const o=(0,d.fj)(e.parsedUrl.path,"convert3D"),a=e.capabilities?.operations.supportsAsyncConvert3D;r=(yield(a?We:He)(o,{query:{f:"json",assets:JSON.stringify(n),transportType:"esriTransportTypeUrl",targetFormat:t,async:a},responseType:"json",timeout:0})).data}catch{throw new g.MT}return function $e(s,e){const t={source:e.assets.map(n=>{const r=(0,w.R_)(n.contentType,s.infoFor3D.supportedFormats);if(!r)throw new g.H2(r);return new v.Qp(n.assetName,n.contentType,[new v.Bq(n.assetURL,n.assetHash)])}),origin:void 0,transform:void 0};if((0,F.A)("enable-feature:georeferenced-uploads")&&e.transform){if(t.transform=(0,k.f)(e.transform),e.spatialReference){const n=ue.A.fromJSON(e.spatialReference);t.origin=(0,k.V)(e.transform,n)}}else t.transform=(0,we.Z)(s.spatialReference);return t}(e,r)})).apply(this,arguments)}function He(s,e){return(0,m.A)(s,e)}function We(s,e){return J.apply(this,arguments)}function J(){return(J=(0,l.A)(function*(s,e){const t=(yield(0,m.A)(s,e)).data.statusUrl;for(;;){const n=(yield(0,m.A)(t,{query:{f:"json"},responseType:"json"})).data;switch(n.status){case"Completed":return(0,m.A)(n.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(n.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}yield(0,p.Pl)(Ke)}})).apply(this,arguments)}function ee({infoFor3D:s}){const e=(0,w.U9)(s);if(!e)throw new g.uh;return e}const Ke=(0,T.l5)(1e3)}}]);