"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[143],{33087:(mt,ot,b)=>{b.d(ot,{q:()=>j});var K=b(60611);class j{constructor(O,$){this._storage=new K.F,this.id="",this.name="",this.size=0,this._storage.maxSize=O,this._storage.register(this),$&&this._storage.registerRemoveFunc("",$)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(O,$,st=1){this._storage.put(this,O,$,st,1)}pop(O){return this._storage.pop(this,O)}get(O){return this._storage.get(this,O)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(O){this._storage.maxSize=O}resetHitRate(){}}},60611:(mt,ot,b)=>{b.d(ot,{F:()=>st,Ti:()=>j});var K=b(12438);const j=-3,Q=j-1;var O,H;(H=O||(O={}))[H.ALL=0]="ALL",H[H.SOME=1]="SOME";class st{get size(){return this._size}constructor(c=10485760){this._maxSize=c,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new K.A,this._users=new K.A}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear()}register(c){this._users.push(c)}deregister(c){this._users.removeUnordered(c)}registerRemoveFunc(c,r){this._removeFuncs.push([c,r])}deregisterRemoveFunc(c){this._removeFuncs.filterInPlace(r=>r[0]!==c)}get maxSize(){return this._maxSize}set maxSize(c){this._maxSize=Math.max(c,-1),this._checkSize()}getSize(c,r){return this._db.get(c.id+r)?.size??0}put(c,r,o,d,m){const v=this._db.get(r=c.id+r);if(v&&(this._size-=v.size,c.size-=v.size,this._db.delete(r),v.entry!==o&&this._notifyRemove(r,v.entry,v.size,O.ALL)),d>this._maxSize)return void this._notifyRemove(r,o,d,O.ALL);if(void 0===o)return void console.warn("Refusing to cache undefined entry ");if(!d||d<0)return console.warn(`Refusing to cache entry with size ${d} for key ${r}`),void this._notifyRemove(r,o,0,O.ALL);const R=1+Math.max(m,Q)-j;this._db.set(r,new G(o,d,R)),this._size+=d,c.size+=d,this._checkSize()}updateSize(c,r,o,d){const m=this._db.get(r=c.id+r);if(m&&m.entry===o){for(this._size-=m.size,c.size-=m.size;d>this._maxSize;){const v=this._notifyRemove(r,o,d,O.SOME);if(!(null!=v&&v>0))return void this._db.delete(r);d=v}m.size=d,this._size+=d,c.size+=d,this._checkSize()}}pop(c,r){const o=this._db.get(r=c.id+r);if(o)return this._size-=o.size,c.size-=o.size,this._db.delete(r),++this._hit,o.entry;++this._miss}get(c,r){const o=this._db.get(r=c.id+r);if(void 0!==o)return this._db.delete(r),o.lives=o.lifetime,this._db.set(r,o),++this._hit,o.entry;++this._miss}peek(c,r){const o=this._db.get(c.id+r);return o?++this._hit:++this._miss,o?.entry}get performanceInfo(){const c={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},r={},o=new Array;this._db.forEach((v,R)=>{const F=v.lifetime;o[F]=(o[F]||0)+v.size,this._users.forAll(V=>{const{id:E,name:rt}=V;R.startsWith(E)&&(r[rt]=(r[rt]||0)+v.size)})});const d={};this._users.forAll(v=>{const R=v.name;"hitRate"in v&&"number"==typeof v.hitRate&&!isNaN(v.hitRate)&&v.hitRate>0?(r[R]=r[R]||0,d[R]=Math.round(100*v.hitRate)+"%"):d[R]="0%"});const m=Object.keys(r);m.sort((v,R)=>r[R]-r[v]),m.forEach(v=>c[v]=Math.round(r[v]/2**20)+"MB / "+d[v]);for(let v=o.length-1;v>=0;--v){const R=o[v];R&&(c["Priority "+(v+j-1)]=Math.round(R/this._size*100)+"%")}return c}resetStats(){this._hit=this._miss=0,this._users.forAll(c=>c.resetHitRate())}clear(c){const r=c.id;this._db.forEach((o,d)=>{d.startsWith(r)&&(this._size-=o.size,this._db.delete(d),this._notifyRemove(d,o.entry,o.size,O.ALL))}),c.size=0}clearAll(){this._db.forEach((c,r)=>this._notifyRemove(r,c.entry,c.size,O.ALL)),this._users.forAll(c=>c.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(c,r,o,d){let m;return this._removeFuncs.some(v=>{if(c.startsWith(v[0])){const R=v[1](r,d,o);return"number"==typeof R&&(m=R),!0}return!1}),m}_checkSize(){this._users.forAll(c=>this._checkSizeLimits(c)),this._checkSizeLimits()}_checkSizeLimits(c){const r=c??this;if(r.maxSize<0||r.size<=r.maxSize)return;const o=c?.id;let d=!0;for(;d;){d=!1;for(const[m,v]of this._db)if(0===v.lifetime&&(!o||m.startsWith(o))){if(this._purgeItem(m,v,c),r.size<=.9*r.maxSize)return;d||=this._db.has(m)}}for(const[m,v]of this._db)if((!o||m.startsWith(o))&&(this._purgeItem(m,v,c),r.size<=.9*r.maxSize))return}_purgeItem(c,r,o=this._users.find(d=>c.startsWith(d.id))){if(this._db.delete(c),r.lives<=1){this._size-=r.size,o&&(o.size-=r.size);const d=this._notifyRemove(c,r.entry,r.size,O.SOME);null!=d&&d>0&&(this._size+=d,o&&(o.size+=d),r.lives=r.lifetime,r.size=d,this._db.set(c,r))}else--r.lives,this._db.set(c,r)}}class G{constructor(c,r,o){this.entry=c,this.size=r,this.lifetime=o,this.lives=o}}},86468:(mt,ot,b)=>{b.d(ot,{T:()=>Q,U:()=>j});var K=b(69287);function j(G,H,c=0){const r=(0,K.qE)(G,0,st);for(let o=0;o<4;o++)H[c+o]=Math.floor(256*ct(r*O[o]))}function Q(G,H=0){let c=0;for(let r=0;r<4;r++)c+=G[H+r]*$[r];return c}const O=[1,256,65536,16777216],$=[1/256,1/65536,1/16777216,1/4294967296],st=Q(new Uint8ClampedArray([255,255,255,255]));function ct(G){return G-Math.floor(G)}},3567:(mt,ot,b)=>{b.d(ot,{E:()=>x,w:()=>st});var K=b(89952),j=b(69690),O=(b(3248),b(12438)),$=b(17694);class st{constructor(u=9,y){this._compareMinX=d,this._compareMinY=m,this._toBBox=f=>f,this._maxEntries=Math.max(4,u||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),y&&("function"==typeof y?this._toBBox=y:this._initFormat(y)),this.clear()}destroy(){this.clear(),X.prune(),it.prune(),U.prune(),W.prune()}all(u){G(this._data,u)}search(u,y){let f=this._data;const A=this._toBBox;if(rt(u,f))for(X.clear();f;){for(let M=0,z=f.children.length;M<z;M++){const L=f.children[M],q=f.leaf?A(L):L;rt(u,q)&&(f.leaf?y(L):E(u,q)?G(L,y):X.push(L))}f=X.pop()}}collides(u){let y=this._data;const f=this._toBBox;if(!rt(u,y))return!1;for(X.clear();y;){for(let A=0,M=y.children.length;A<M;A++){const z=y.children[A],L=y.leaf?f(z):z;if(rt(u,L)){if(y.leaf||E(u,L))return!0;X.push(z)}}y=X.pop()}return!1}load(u){if(!u.length)return this;if(u.length<this._minEntries){for(let f=0,A=u.length;f<A;f++)this.insert(u[f]);return this}let y=this._build(u.slice(),0,u.length-1,0);if(this._data.children.length)if(this._data.height===y.height)this._splitRoot(this._data,y);else{if(this._data.height<y.height){const f=this._data;this._data=y,y=f}this._insert(y,this._data.height-y.height-1,!0)}else this._data=y;return this}insert(u){return u&&this._insert(u,this._data.height-1),this}clear(){return this._data=new D([]),this}remove(u){if(!u)return this;let y,f=this._data,A=null,M=0,z=!1;const L=this._toBBox(u);for(U.clear(),W.clear();f||U.length>0;){if(f||(f=U.pop(),A=U.data[U.length-1],M=W.pop()??0,z=!0),f.leaf&&(y=(0,K.qh)(f.children,(0,j.zI)(u),f.children.length,f.indexHint),-1!==y))return f.children.splice(y,1),U.push(f),this._condense(U),this;z||f.leaf||!E(f,L)?A?(M++,f=A.children[M],z=!1):f=null:(U.push(f),W.push(M),M=0,A=f,f=f.children[0])}return this}toJSON(){return this._data}fromJSON(u){return this._data=u,this}_build(u,y,f,A){const M=f-y+1;let z=this._maxEntries;if(M<=z){const et=new D(u.slice(y,f+1));return c(et,this._toBBox),et}A||(A=Math.ceil(Math.log(M)/Math.log(z)),z=Math.ceil(M/z**(A-1)));const L=new P([]);L.height=A;const q=Math.ceil(M/z),J=q*Math.ceil(Math.sqrt(z));nt(u,y,f,J,this._compareMinX);for(let et=y;et<=f;et+=J){const _t=Math.min(et+J-1,f);nt(u,et,_t,q,this._compareMinY);for(let St=et;St<=_t;St+=q){const dt=Math.min(St+q-1,_t);L.children.push(this._build(u,St,dt,A-1))}}return c(L,this._toBBox),L}_insert(u,y,f){const M=f?u:(0,this._toBBox)(u);U.clear();const z=function ct(p,u,y,f){for(;f.push(u),!0!==u.leaf&&f.length-1!==y;){let A,M=1/0,z=1/0;for(let L=0,q=u.children.length;L<q;L++){const J=u.children[L],et=v(J),_t=F(p,J)-et;_t<z?(z=_t,M=et<M?et:M,A=J):_t===z&&et<M&&(M=et,A=J)}u=A||u.children[0]}return u}(M,this._data,y,U);for(z.children.push(u),o(z,M);y>=0&&U.data[y].children.length>this._maxEntries;)this._split(U,y),y--;!function H(p,u,y){for(let f=y;f>=0;f--)o(u.data[f],p)}(M,U,y)}_split(u,y){const f=u.data[y],A=f.children.length,M=this._minEntries;this._chooseSplitAxis(f,M,A);const z=this._chooseSplitIndex(f,M,A);if(!z)return;const L=f.children.splice(z,f.children.length-z),q=f.leaf?new D(L):new P(L);q.height=f.height,c(f,this._toBBox),c(q,this._toBBox),y?u.data[y-1].children.push(q):this._splitRoot(f,q)}_splitRoot(u,y){this._data=new P([u,y]),this._data.height=u.height+1,c(this._data,this._toBBox)}_chooseSplitIndex(u,y,f){let A,M,z;A=M=1/0;for(let L=y;L<=f-y;L++){const q=r(u,0,L,this._toBBox),J=r(u,L,f,this._toBBox),et=V(q,J),_t=v(q)+v(J);et<A?(A=et,z=L,M=_t<M?_t:M):et===A&&_t<M&&(M=_t,z=L)}return z}_chooseSplitAxis(u,y,f){const A=u.leaf?this._compareMinX:d,M=u.leaf?this._compareMinY:m;this._allDistMargin(u,y,f,A)<this._allDistMargin(u,y,f,M)&&u.children.sort(A)}_allDistMargin(u,y,f,A){u.children.sort(A);const M=this._toBBox,z=r(u,0,y,M),L=r(u,f-y,f,M);let q=R(z)+R(L);for(let J=y;J<f-y;J++){const et=u.children[J];o(z,u.leaf?M(et):et),q+=R(z)}for(let J=f-y-1;J>=y;J--){const et=u.children[J];o(L,u.leaf?M(et):et),q+=R(L)}return q}_condense(u){for(let y=u.length-1;y>=0;y--){const f=u.data[y];if(0===f.children.length)if(y>0){const A=u.data[y-1],M=A.children;M.splice((0,K.qh)(M,f,M.length,A.indexHint),1)}else this.clear();else c(f,this._toBBox)}}_initFormat(u){const y=["return a"," - b",";"];this._compareMinX=new Function("a","b",y.join(u[0])),this._compareMinY=new Function("a","b",y.join(u[1])),this._toBBox=new Function("a","return {minX: a"+u[0]+", minY: a"+u[1]+", maxX: a"+u[2]+", maxY: a"+u[3]+"};")}}function G(p,u){let y=p;for(it.clear();y;){if(!0===y.leaf)for(const f of y.children)u((0,j.zI)(f));else it.pushArray(y.children);y=it.pop()??null}}function c(p,u){r(p,0,p.children.length,u,p)}function r(p,u,y,f,A){A||(A=new D([])),A.minX=1/0,A.minY=1/0,A.maxX=-1/0,A.maxY=-1/0;for(let M,z=u;z<y;z++)M=p.children[z],o(A,p.leaf?f(M):M);return A}function o(p,u){p.minX=Math.min(p.minX,u.minX),p.minY=Math.min(p.minY,u.minY),p.maxX=Math.max(p.maxX,u.maxX),p.maxY=Math.max(p.maxY,u.maxY)}function d(p,u){return p.minX-u.minX}function m(p,u){return p.minY-u.minY}function v(p){return(p.maxX-p.minX)*(p.maxY-p.minY)}function R(p){return p.maxX-p.minX+(p.maxY-p.minY)}function F(p,u){return(Math.max(u.maxX,p.maxX)-Math.min(u.minX,p.minX))*(Math.max(u.maxY,p.maxY)-Math.min(u.minY,p.minY))}function V(p,u){const y=Math.max(p.minX,u.minX),f=Math.max(p.minY,u.minY),A=Math.min(p.maxX,u.maxX),M=Math.min(p.maxY,u.maxY);return Math.max(0,A-y)*Math.max(0,M-f)}function E(p,u){return p.minX<=u.minX&&p.minY<=u.minY&&u.maxX<=p.maxX&&u.maxY<=p.maxY}function rt(p,u){return u.minX<=p.maxX&&u.minY<=p.maxY&&u.maxX>=p.minX&&u.maxY>=p.minY}function nt(p,u,y,f,A){const M=[u,y];for(;M.length;){const z=M.pop(),L=M.pop();if(z-L<=f)continue;const q=L+Math.ceil((z-L)/f/2)*f;(0,$.q)(p,q,L,z,A),M.push(L,q,q,z)}}const X=new O.A,it=new O.A,U=new O.A,W=new O.A({deallocator:void 0});class x{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class C extends x{constructor(){super(...arguments),this.height=1,this.indexHint=new K.vW}}class D extends C{constructor(u){super(),this.children=u,this.leaf=!0}}class P extends C{constructor(u){super(),this.children=u,this.leaf=!1}}},55912:(mt,ot,b)=>{b.d(ot,{A:()=>G});var O,H,K=b(3248),j=b(11445),Q=b(61591);(H=O||(O={}))[H.varint=0]="varint",H[H.fixed64=1]="fixed64",H[H.delimited=2]="delimited",H[H.fixed32=5]="fixed32",H[H.unknown=99]="unknown";const $=4294967296,st=new TextDecoder("utf-8"),ct=(0,K.A)("safari")||(0,K.A)("ios")?6:(0,K.A)("ff")?12:32;class G{constructor(c,r,o=0,d=(c?c.byteLength:0)){this._tag=0,this._dataType=O.unknown,this._init(c,r,o,d)}_init(c,r,o,d){this._data=c,this._dataView=r,this._pos=o,this._end=d}get usedMemory(){return 64+(0,j.Qf)(this._data)}asUnsafe(){return this}clone(){return new G(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(c){this._pos=c}nextTag(c){for(;;){if(this._pos===this._end)return!1;const r=this._decodeVarint();if(this._tag=r>>3,this._dataType=7&r,!c||c===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const c=this._decodeVarint();return this._tag=c>>3,this._dataType=7&c,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let c=4294967295;if(c=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128||(c=(c|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128)||(c=(c|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128)||(c=(c|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128)||(c=(c|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128))return c;throw new Error("Varint overflow")}getUInt64(){return this._decodeVarint()}getSInt32(){const c=this.getUInt32();return c>>>1^-(1&c)}getSInt64(){return this._decodeSVarint()}getBool(){const c=0!==this._data[this._pos];return this._skip(1),c}getEnum(){return this._decodeVarint()}getFixed64(){const c=this._dataView,r=this._pos,o=c.getUint32(r,!0)+c.getUint32(r+4,!0)*$;return this._skip(8),o}getSFixed64(){const c=this._dataView,r=this._pos,o=c.getUint32(r,!0)+c.getInt32(r+4,!0)*$;return this._skip(8),o}getDouble(){const c=this._dataView.getFloat64(this._pos,!0);return this._skip(8),c}getFixed32(){const c=this._dataView.getUint32(this._pos,!0);return this._skip(4),c}getSFixed32(){const c=this._dataView.getInt32(this._pos,!0);return this._skip(4),c}getFloat(){const c=this._dataView.getFloat32(this._pos,!0);return this._skip(4),c}getString(){const c=this._getLength(),r=this._pos,o=this._toString(this._data,r,r+c);return this._skip(c),o}getBytes(){const c=this._getLength(),r=this._pos,o=this._toBytes(this._data,r,r+c);return this._skip(c),o}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(c,r,o,d){const m=this.getMessage(),v=c(m,r,o,d);return m.release(),v}processMessage(c){const r=this.getMessage(),o=c(r);return r.release(),o}getMessage(){const c=this._getLength(),r=G.pool.acquire();return r._init(this._data,this._dataView,this._pos,this._pos+c),this._skip(c),r}release(){G.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case O.varint:this._decodeVarint();break;case O.fixed64:this._skip(8);break;case O.delimited:this._skip(this._getLength());break;case O.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(c){this._skip(c)}_skip(c){if(this._pos+c>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=c}_decodeVarint(){const c=this._data;let r=this._pos,o=0,d=0;if(this._end-r>=10)do{if(d=c[r++],o|=127&d,!(128&d&&(d=c[r++],o|=(127&d)<<7,128&d)&&(d=c[r++],o|=(127&d)<<14,128&d)&&(d=c[r++],o|=(127&d)<<21,128&d)&&(d=c[r++],o+=268435456*(127&d),128&d)&&(d=c[r++],o+=34359738368*(127&d),128&d)&&(d=c[r++],o+=4398046511104*(127&d),128&d)&&(d=c[r++],o+=562949953421312*(127&d),128&d)&&(d=c[r++],o+=72057594037927940*(127&d),128&d)&&(d=c[r++],o+=0x8000000000000000*(127&d),128&d)))break;throw new Error("Varint too long!")}while(0);else{let m=1;for(;r!==this._end&&(d=c[r],128&d);)++r,o+=(127&d)*m,m*=128;if(r===this._end)throw new Error("Varint overrun!");++r,o+=d*m}return this._pos=r,o}_decodeSVarint(){const c=this._data;let r,o=0,d=0;const m=1&c[this._pos];if(d=c[this._pos++],o|=127&d,!(128&d&&(d=c[this._pos++],o|=(127&d)<<7,128&d)&&(d=c[this._pos++],o|=(127&d)<<14,128&d)&&(d=c[this._pos++],o|=(127&d)<<21,128&d)&&(d=c[this._pos++],o+=268435456*(127&d),128&d)&&(d=c[this._pos++],o+=34359738368*(127&d),128&d)&&(d=c[this._pos++],o+=4398046511104*(127&d),128&d)))return m?-(o+1)/2:o/2;if(r=BigInt(o),d=c[this._pos++],r+=0x2000000000000n*BigInt(127&d),!(128&d&&(d=c[this._pos++],r+=0x100000000000000n*BigInt(127&d),128&d)&&(d=c[this._pos++],r+=0x8000000000000000n*BigInt(127&d),128&d)))return Number(m?-(r+1n)/2n:r/2n);throw new Error("Varint too long!")}_getLength(){if(this._dataType!==O.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(c,r,o){if((o=Math.min(this._end,o))-r>ct){const v=c.subarray(r,o);return st.decode(v)}let d="",m="";for(let v=r;v<o;++v){const R=c[v];128&R?m+="%"+R.toString(16):(d+=decodeURIComponent(m)+String.fromCharCode(R),m="")}return m.length&&(d+=decodeURIComponent(m)),d}_toBytes(c,r,o){return o=Math.min(this._end,o),new Uint8Array(c.buffer,r,o-r)}}G.pool=new Q.A(G,void 0,H=>{H._data=null,H._dataView=null})},91766:(mt,ot,b)=>{var j,Q,c;b.d(ot,{O3:()=>st,Ox:()=>ct,bR:()=>O,dC:()=>j}),(c=j||(j={}))[c.Unknown=0]="Unknown",c[c.Point=1]="Point",c[c.LineString=2]="LineString",c[c.Polygon=3]="Polygon";class O{constructor(r,o){this.x=r,this.y=o}clone(){return new O(this.x,this.y)}equals(r,o){return r===this.x&&o===this.y}isEqual(r){return r.x===this.x&&r.y===this.y}setCoords(r,o){return this.x=r,this.y=o,this}normalize(){const r=this.x,o=this.y,d=Math.sqrt(r*r+o*o);return this.x/=d,this.y/=d,this}rightPerpendicular(){const r=this.x;return this.x=this.y,this.y=-r,this}leftPerpendicular(){const r=this.x;return this.x=-this.y,this.y=r,this}move(r,o){return this.x+=r,this.y+=o,this}assign(r){return this.x=r.x,this.y=r.y,this}assignAdd(r,o){return this.x=r.x+o.x,this.y=r.y+o.y,this}assignSub(r,o){return this.x=r.x-o.x,this.y=r.y-o.y,this}rotate(r,o){const d=this.x,m=this.y;return this.x=d*r-m*o,this.y=d*o+m*r,this}scale(r){return this.x*=r,this.y*=r,this}length(){const r=this.x,o=this.y;return Math.sqrt(r*r+o*o)}sub(r){return this.x-=r.x,this.y-=r.y,this}add(r){return this.x+=r.x,this.y+=r.y,this}static distance(r,o){const d=o.x-r.x,m=o.y-r.y;return Math.sqrt(d*d+m*m)}static add(r,o){return new O(r.x+o.x,r.y+o.y)}static sub(r,o){return new O(r.x-o.x,r.y-o.y)}}class ${constructor(r,o,d){this.ratio=r,this.x=o,this.y=d}}class st{constructor(r,o,d,m=8,v=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=m,this._pixelMargin=v,this._tileSize=512*m,this._dz=r,this._yPos=o,this._xPos=d}setPixelMargin(r){r!==this._pixelMargin&&(this._pixelMargin=r,this.setExtent(this._extent))}setExtent(r){this._extent=r,this._finalRatio=this._tileSize/r*(1<<this._dz);let o=this._pixelRatio*this._pixelMargin;o/=this._finalRatio;const d=r>>this._dz;o>d&&(o=d),this._margin=o,this._xmin=d*this._xPos-o,this._ymin=d*this._yPos-o,this._xmax=this._xmin+d+2*o,this._ymax=this._ymin+d+2*o}reset(r){this._type=r,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(r,o){this._pushLine(),this._prevIsIn=this._isIn(r,o),this._moveTo(r,o,this._prevIsIn),this._prevPt=new O(r,o),this._firstPt=new O(r,o),this._dist=0}lineTo(r,o){const d=this._isIn(r,o),m=new O(r,o),v=O.distance(this._prevPt,m);let R,F,V,E,rt,nt,X,it;if(d)this._prevIsIn?this._lineTo(r,o,!0):(R=this._prevPt,F=m,V=this._intersect(F,R),this._start=this._dist+v*(1-this._r),this._lineTo(V.x,V.y,!0),this._lineTo(F.x,F.y,!0));else if(this._prevIsIn)F=this._prevPt,R=m,V=this._intersect(F,R),this._lineTo(V.x,V.y,!0),this._lineTo(R.x,R.y,!1);else{const U=this._prevPt,W=m;if(U.x<=this._xmin&&W.x<=this._xmin||U.x>=this._xmax&&W.x>=this._xmax||U.y<=this._ymin&&W.y<=this._ymin||U.y>=this._ymax&&W.y>=this._ymax)this._lineTo(W.x,W.y,!1);else{const x=[];if((U.x<this._xmin&&W.x>this._xmin||U.x>this._xmin&&W.x<this._xmin)&&(E=(this._xmin-U.x)/(W.x-U.x),it=U.y+E*(W.y-U.y),it<=this._ymin?nt=!1:it>=this._ymax?nt=!0:x.push(new $(E,this._xmin,it))),(U.x<this._xmax&&W.x>this._xmax||U.x>this._xmax&&W.x<this._xmax)&&(E=(this._xmax-U.x)/(W.x-U.x),it=U.y+E*(W.y-U.y),it<=this._ymin?nt=!1:it>=this._ymax?nt=!0:x.push(new $(E,this._xmax,it))),(U.y<this._ymin&&W.y>this._ymin||U.y>this._ymin&&W.y<this._ymin)&&(E=(this._ymin-U.y)/(W.y-U.y),X=U.x+E*(W.x-U.x),X<=this._xmin?rt=!1:X>=this._xmax?rt=!0:x.push(new $(E,X,this._ymin))),(U.y<this._ymax&&W.y>this._ymax||U.y>this._ymax&&W.y<this._ymax)&&(E=(this._ymax-U.y)/(W.y-U.y),X=U.x+E*(W.x-U.x),X<=this._xmin?rt=!1:X>=this._xmax?rt=!0:x.push(new $(E,X,this._ymax))),0===x.length)this._lineTo(rt?this._xmax:this._xmin,nt?this._ymax:this._ymin,!0);else if(x.length>1&&x[0].ratio>x[1].ratio)this._start=this._dist+v*x[1].ratio,this._lineTo(x[1].x,x[1].y,!0),this._lineTo(x[0].x,x[0].y,!0);else{this._start=this._dist+v*x[0].ratio;for(let C=0;C<x.length;C++)this._lineTo(x[C].x,x[C].y,!0)}this._lineTo(W.x,W.y,!1)}}this._dist+=v,this._prevIsIn=d,this._prevPt=m}close(){if(this._line.length>2){const r=this._firstPt,o=this._prevPt;r.x===o.x&&r.y===o.y||this.lineTo(r.x,r.y);const d=this._line;let m=d.length;for(;m>=4&&(d[0].x===d[1].x&&d[0].x===d[m-2].x||d[0].y===d[1].y&&d[0].y===d[m-2].y);)d.pop(),d[0].x=d[m-2].x,d[0].y=d[m-2].y,--m}}result(r=!0){return this._pushLine(),0===this._lines.length?null:(this._type===j.Polygon&&r&&G.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==j.LineString)throw new Error("Only valid for lines");this._pushLine();const r=this._lines,o=r.length;if(0===o)return null;const d=[];for(let m=0;m<o;m++)d.push({line:r[m],start:this._starts[m]||0});return d}_isIn(r,o){return r>=this._xmin&&r<=this._xmax&&o>=this._ymin&&o<=this._ymax}_intersect(r,o){let d,m,v;if(o.x>=this._xmin&&o.x<=this._xmax)m=o.y<=this._ymin?this._ymin:this._ymax,v=(m-r.y)/(o.y-r.y),d=r.x+v*(o.x-r.x);else if(o.y>=this._ymin&&o.y<=this._ymax)d=o.x<=this._xmin?this._xmin:this._xmax,v=(d-r.x)/(o.x-r.x),m=r.y+v*(o.y-r.y);else{m=o.y<=this._ymin?this._ymin:this._ymax,d=o.x<=this._xmin?this._xmin:this._xmax;const R=(d-r.x)/(o.x-r.x),F=(m-r.y)/(o.y-r.y);R<F?(v=R,m=r.y+R*(o.y-r.y)):(v=F,d=r.x+F*(o.x-r.x))}return this._r=v,new O(d,m)}_pushLine(){this._line&&(this._type===j.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===j.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===j.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(r,o,d){this._type!==j.Polygon?d&&(r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),o=Math.round((o-(this._ymin+this._margin))*this._finalRatio),this._line.push(new O(r,o))):(d||(r<this._xmin&&(r=this._xmin),r>this._xmax&&(r=this._xmax),o<this._ymin&&(o=this._ymin),o>this._ymax&&(o=this._ymax)),r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),o=Math.round((o-(this._ymin+this._margin))*this._finalRatio),this._line.push(new O(r,o)),this._isH=!1,this._isV=!1)}_lineTo(r,o,d){let m,v;if(this._type!==j.Polygon)if(d){if(r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),o=Math.round((o-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(m=this._line[this._line.length-1],m.equals(r,o)))return;this._line.push(new O(r,o))}else this._line&&this._line.length>0&&this._pushLine();else if(d||(r<this._xmin&&(r=this._xmin),r>this._xmax&&(r=this._xmax),o<this._ymin&&(o=this._ymin),o>this._ymax&&(o=this._ymax)),r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),o=Math.round((o-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){m=this._line[this._line.length-1];const R=m.x===r,F=m.y===o;if(R&&F)return;this._isH&&R||this._isV&&F?(m.x=r,m.y=o,v=this._line[this._line.length-2],v.x===r&&v.y===o?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(v=this._line[this._line.length-2],this._isH=v.x===r,this._isV=v.y===o)):(this._isH=v.x===r,this._isV=v.y===o)):(this._line.push(new O(r,o)),this._isH=R,this._isV=F)}else this._line.push(new O(r,o))}}class ct{setExtent(r){this._ratio=4096===r?1:4096/r}get validateTessellation(){return this._ratio<1}reset(r){this._lines=[],this._line=null}moveTo(r,o){this._line&&this._lines.push(this._line),this._line=[];const d=this._ratio;this._line.push(new O(r*d,o*d))}lineTo(r,o){const d=this._ratio;this._line.push(new O(r*d,o*d))}close(){const r=this._line;r&&!r[0].isEqual(r[r.length-1])&&r.push(r[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}}!function(c){c[c.sideLeft=0]="sideLeft",c[c.sideRight=1]="sideRight",c[c.sideTop=2]="sideTop",c[c.sideBottom=3]="sideBottom"}(Q||(Q={}));class G{static simplify(r,o,d){if(!d)return;const m=-o,v=r+o,R=-o,F=r+o,V=[],E=[],rt=d.length;for(let X=0;X<rt;++X){const it=d[X];if(!it||it.length<2)continue;let U,W=it[0];const x=it.length;for(let C=1;C<x;++C)U=it[C],W.x===U.x&&(W.x<=m&&(W.y>U.y?(V.push(X),V.push(C),V.push(Q.sideLeft),V.push(-1)):(E.push(X),E.push(C),E.push(Q.sideLeft),E.push(-1))),W.x>=v&&(W.y<U.y?(V.push(X),V.push(C),V.push(Q.sideRight),V.push(-1)):(E.push(X),E.push(C),E.push(Q.sideRight),E.push(-1)))),W.y===U.y&&(W.y<=R&&(W.x<U.x?(V.push(X),V.push(C),V.push(Q.sideTop),V.push(-1)):(E.push(X),E.push(C),E.push(Q.sideTop),E.push(-1))),W.y>=F&&(W.x>U.x?(V.push(X),V.push(C),V.push(Q.sideBottom),V.push(-1)):(E.push(X),E.push(C),E.push(Q.sideBottom),E.push(-1)))),W=U}if(0===V.length||0===E.length)return;G.fillParent(d,E,V),G.fillParent(d,V,E);const nt=[];G.calcDeltas(nt,E,V),G.calcDeltas(nt,V,E),G.addDeltas(nt,d)}static fillParent(r,o,d){const m=d.length,v=o.length;for(let R=0;R<v;R+=4){const F=o[R],V=o[R+1],E=o[R+2],rt=r[F][V-1],nt=r[F][V];let X=8092,it=-1;for(let U=0;U<m;U+=4){if(d[U+2]!==E)continue;const W=d[U],x=d[U+1],C=r[W][x-1],D=r[W][x];switch(E){case Q.sideLeft:case Q.sideRight:if(H(rt.y,C.y,D.y)&&H(nt.y,C.y,D.y)){const P=Math.abs(D.y-C.y);P<X&&(X=P,it=U)}break;case Q.sideTop:case Q.sideBottom:if(H(rt.x,C.x,D.x)&&H(nt.x,C.x,D.x)){const P=Math.abs(D.x-C.x);P<X&&(X=P,it=U)}}}o[R+3]=it}}static calcDeltas(r,o,d){const m=o.length;for(let v=0;v<m;v+=4){const F=G.calcDelta(v,o,d,[]);r.push(o[v]),r.push(o[v+1]),r.push(o[v+2]),r.push(F)}}static calcDelta(r,o,d,m){const v=o[r+3];if(-1===v)return 0;const R=m.length;return R>1&&m[R-2]===v?0:(m.push(v),G.calcDelta(v,d,o,m)+1)}static addDeltas(r,o){const d=r.length;let m=0;for(let v=0;v<d;v+=4){const R=r[v+3];R>m&&(m=R)}for(let v=0;v<d;v+=4){const R=o[r[v]],F=r[v+1],V=m-r[v+3];switch(r[v+2]){case Q.sideLeft:R[F-1].x-=V,R[F].x-=V,1===F&&(R[R.length-1].x-=V),F===R.length-1&&(R[0].x-=V);break;case Q.sideRight:R[F-1].x+=V,R[F].x+=V,1===F&&(R[R.length-1].x+=V),F===R.length-1&&(R[0].x+=V);break;case Q.sideTop:R[F-1].y-=V,R[F].y-=V,1===F&&(R[R.length-1].y-=V),F===R.length-1&&(R[0].y-=V);break;case Q.sideBottom:R[F-1].y+=V,R[F].y+=V,1===F&&(R[R.length-1].y+=V),F===R.length-1&&(R[0].y+=V)}}}}const H=(c,r,o)=>c>=r&&c<=o||c>=o&&c<=r},84289:(mt,ot,b)=>{b.d(ot,{$o:()=>K,$u:()=>O,gR:()=>Q,zA:()=>j});const K=15.5,j=4,Q=64,O=1024},28685:(mt,ot,b)=>{b.d(ot,{AH:()=>v,Kj:()=>d,Tl:()=>W,c5:()=>c,f0:()=>r,hs:()=>U,k2:()=>o});var K=b(86468),j=b(35150),Q=b(69287),O=b(84289),$=b(46988),st=b(47669);const ct=()=>j.A.getLogger("esri.symbols.cim.rasterizingUtils"),G=32,H=x=>"vertical"===x||"horizontal"===x||"cross"===x||"esriSFSCross"===x||"esriSFSVertical"===x||"esriSFSHorizontal"===x;function c(x,C,D){const P=C.style,p=(0,Q.yR)(Math.ceil(D)),u=H(P)?8*p:16*p,y=2*p;x.width=u,x.height=u;const f=x.getContext("2d");f.strokeStyle="#ffffff",f.lineWidth=p,f.beginPath(),"vertical"!==P&&"cross"!==P&&"esriSFSCross"!==P&&"esriSFSVertical"!==P||(f.moveTo(u/2,-y),f.lineTo(u/2,u+y)),"horizontal"!==P&&"cross"!==P&&"esriSFSCross"!==P&&"esriSFSHorizontal"!==P||(f.moveTo(-y,u/2),f.lineTo(u+y,u/2)),"backward-diagonal"!==P&&"diagonal-cross"!==P&&"esriSFSDiagonalCross"!==P&&"esriSFSBackwardDiagonal"!==P||(f.moveTo(-y,-y),f.lineTo(u+y,u+y),f.moveTo(u-y,-y),f.lineTo(u+y,y),f.moveTo(-y,u-y),f.lineTo(y,u+y)),"forward-diagonal"!==P&&"diagonal-cross"!==P&&"esriSFSForwardDiagonal"!==P&&"esriSFSDiagonalCross"!==P||(f.moveTo(u+y,-y),f.lineTo(-y,u+y),f.moveTo(y,-y),f.lineTo(-y,y),f.moveTo(u+y,u-y),f.lineTo(u-y,u+y)),f.stroke();const A=f.getImageData(0,0,x.width,x.height),M=new Uint8Array(A.data);let z;for(let L=0;L<M.length;L+=4)z=M[L+3]/255,M[L]=M[L]*z,M[L+1]=M[L+1]*z,M[L+2]=M[L+2]*z;return[M,x.width,x.height,p]}function r(x){x.length%2==1&&(x=[...x,...x]);const C=x.reduce((L,q)=>L+q,0),D=Math.round(C*O.zA),p=new Float32Array(1*D);let u=0,y=0,f=.5,A=!0;for(const L of x){for(u=y,y+=L*O.zA;f<=y;){const q=f-.5,J=Math.min(Math.abs(f-u),Math.abs(f-y));p[q]=A?-J:J,f++}A=!A}const M=p.length,z=new Uint8Array(4*M);for(let L=0;L<M;++L)(0,K.U)(p[L]/O.zA/O.gR*.5+.5,z,4*L);return[z,D,1]}function o(x,C){null==x&&(x=[]);const D="Butt"===C,P="Square"===C,p=!D&&!P;x.length%2==1&&(x=[...x,...x]);const u=O.$o,y=2*u;let f=0;for(const dt of x)f+=dt;const A=Math.round(f*u),M=new Float32Array(A*y),z=.5*u;let L=0,q=0,J=.5,et=!0;for(const dt of x){for(L=q,q+=dt*u;J<=q;){let yt=.5;for(;yt<y;){const Mt=(yt-.5)*A+J-.5,xt=p?(yt-u)*(yt-u):Math.abs(yt-u);M[Mt]=et?D?Math.max(Math.max(L+z-J,xt),Math.max(J-q+z,xt)):xt:p?Math.min((J-L)*(J-L)+xt,(J-q)*(J-q)+xt):P?Math.min(Math.max(J-L,xt),Math.max(q-J,xt)):Math.min(Math.max(J-L+z,xt),Math.max(q+z-J,xt)),yt++}J++}et=!et}const _t=M.length,St=new Uint8Array(4*_t);for(let dt=0;dt<_t;++dt){const yt=(p?Math.sqrt(M[dt]):M[dt])/u;(0,K.U)(yt,St,4*dt)}return[St,A,y]}function d(x,C){const{colorRamp:D,gradientType:P}=C,p="CIMFixedColorRamp"===D.type,u=C.interval||$.D.CIMGradientFill.interval;let y=R(D);return p&&(y=F(y,u)),"Discrete"===P||p?function E(x,C,D){return nt(x,C,D,1,st.MZ),X(x)}(x,y,u):function V(x,C){return nt(x,C,G,1,st.MZ),X(x)}(x,y)}let m;function v(x,C){const{colorRamp:D,gradientType:P}=C,p=R(D),u="CIMFixedColorRamp"===D.type;if("Continuous"===P&&!u)return rt(x,p);const y=C.interval??$.D.CIMGradientFill.interval;if(u)return rt(x,F(p,y));const f=[];m??=document.createElement("canvas"),nt(m,p,y,1,0);const A=m.getContext("2d").getImageData(0,0,y,1).data;for(let M=0,z=0;M<y;M++,z=4*M){const L=[A[z+0],A[z+1],A[z+2],A[z+3]];f.push({offset:M/y,color:L}),f.push({offset:(M+1)/y,color:L})}return rt(x,f)}function R(x){const C=[];switch(x.type){case"CIMPolarContinuousColorRamp":case"CIMLinearContinuousColorRamp":{"CIMPolarContinuousColorRamp"===x.type&&ct().warnOnce("CIMPolarContinuousColorRamp is currently unsupported. Falling back to CIMLinearContinuousColorRamp.");const D=x;C.push({offset:0,color:[D.fromColor[0],D.fromColor[1],D.fromColor[2],D.fromColor[3]/255]}),C.push({offset:1,color:[D.toColor[0],D.toColor[1],D.toColor[2],D.toColor[3]/255]});break}case"CIMFixedColorRamp":{const D=x,P=1/(D.colors.length-1);let p=0;for(const u of D.colors)C.push({offset:p,color:[u[0],u[1],u[2],u[3]/255]}),p+=P;break}case"CIMMultipartColorRamp":{const D=x,P=D.weights.reduce((u,y)=>u+y,0);let p=0;for(let u=0;u<D.colorRamps.length;u++){const f=D.weights[u],A=R(D.colorRamps[u]);for(const M of A)C.push({offset:(p+M.offset*f)/P,color:M.color});p+=f}break}default:ct().error(`Color ramp "${x.type}" currently unsupported.`)}return C}function F(x,C){const D=[],P=(x.length-1)/(C-1);for(let p=0;p<C;p++){const u=x[Math.round(p*P)].color;D.push({offset:p/C,color:u}),D.push({offset:(p+1)/C,color:u})}return D}function rt(x,C,D=0){for(const{offset:P,color:p}of C)x.addColorStop(Math.min(Math.max(P,D),1-D),`rgba(${p[0]}, ${p[1]}, ${p[2]}, ${p[3]})`)}function nt(x,C,D,P,p){const u=D+2*p;x.width=u,x.height=P;const y=(p+1)/u,f=x.getContext("2d",{willReadFrequently:!0});if(C.length>0){const A=f.createLinearGradient(0,0,u,P);rt(A,C,y),f.fillStyle=A}else f.fillStyle="rgba(128, 128, 128, 1)";f.fillRect(0,0,u,P)}function X(x){const{width:C,height:D}=x,P=x.getContext("2d").getImageData(0,0,C,D),p=new Uint8Array(P.data);for(let u=0;u<p.length;u+=4){const y=p[u+3]/255;p[u]*=y,p[u+1]*=y,p[u+2]*=y}return[p,C,D]}function U(x,C){const D=function it(x){const C=x[0]?.[0]?.[0]??0,D=x[0]?.[0]?.[1]??0,P={ymin:D,xmin:C,ymax:D,xmax:C,width:0,height:0};for(let p=0;p<x.length;p++){const u=x[p];for(let y=0;y<u.length;y++){const f=u[y][0],A=u[y][1];f<P.xmin&&(P.xmin=f),f>P.xmax&&(P.xmax=f),A<P.ymin&&(P.ymin=A),A>P.ymax&&(P.ymax=A)}}return P.width=Math.abs(P.xmax-P.xmin),P.height=Math.abs(P.ymax-P.ymin),P}(x),P=0===D.width?1:D.width,p=0===D.height?1:D.height,u=[];for(let y=0;y<x.length;y++){const f=x[y],A=[];for(let M=0;M<f.length;M++){let z=Math.round(f[M][0]-D.xmin),L=Math.round(f[M][1]-D.ymin);if(z=C.xmin+z*C.width/P,L=C.ymin+L*C.height/p,isNaN(z)||isNaN(L))throw new Error("Scaled shape has NaN values");A.push([z,L])}u.push(A)}return u}function W(x,C,D){const P=[];for(let p=0;p<x.length;p++){const u=x[p],y=[];for(let f=0;f<u.length;f++){const A=u[f][0]+C,M=u[f][1]+D;if(isNaN(A)||isNaN(M))throw new Error("Scaled shape has NaN values");y.push([A,M])}P.push(y)}return P}},4139:(mt,ot,b)=>{b.d(ot,{GW:()=>v,IU:()=>rt,Jo:()=>O,MG:()=>Q,Wh:()=>c,cP:()=>U,os:()=>G,p6:()=>d,pJ:()=>$,ru:()=>X,s3:()=>nt,w4:()=>it,wV:()=>o,yM:()=>W,z0:()=>r});var K=b(15268),j=b(91766);const Q=Number.POSITIVE_INFINITY,O=Math.PI,$=2*O,st=128/O,ct=256/360,G=O/180,H=1/Math.LN2;function c(x,C){return(x%=C)>=0?x:x+C}function r(x){return c(x*st,256)}function o(x){return c(x*ct,256)}function d(x){return Math.log(x)*H}function v(x,C,D){return x*(1-D)+C*D}const F=8,V=14,E=16;function rt(x){return F+Math.max((x-V)*E,0)}function nt(x,C,D){let P,p,u,y=0;for(const f of D){P=f.length;for(let A=1;A<P;++A)p=f[A-1],u=f[A],p.y>C!=u.y>C&&((u.x-p.x)*(C-p.y)-(u.y-p.y)*(x-p.x)>0?y++:y--)}return 0!==y}function X(x,C,D,P){let p,u,y,f;const A=P*P;for(const M of D){const z=M.length;if(!(z<2)){p=M[0].x,u=M[0].y;for(let L=1;L<z;++L){if(y=M[L].x,f=M[L].y,(0,K.Ng)(x,C,p,u,y,f)<A)return!0;p=y,u=f}}}return!1}function it(x,C,D,P,p,u,y){const f=Math.max(P,Math.min(C,u))-C,A=Math.max(p,Math.min(D,y))-D;return f*f+A*A<=x*x}function U(x,C){if(0===C||Number.isNaN(C))return x;const D=[],P=new j.bR(0,0),p=new j.bR(0,0),u=new j.bR(0,0);for(let y=0;y<x.length;y++){const f=x[y],A=[];for(let M=0;M<f.length;M++){const z=f[M-1],L=f[M],q=f[M+1];0===M?P.setCoords(0,0):P.assignSub(L,z).normalize().rightPerpendicular(),M===f.length-1?p.setCoords(0,0):p.assignSub(q,L).normalize().rightPerpendicular(),u.assignAdd(P,p).normalize();const J=u.x*p.x+u.y*p.y;0!==J&&u.scale(1/J),A.push(j.bR.add(L,u.scale(C)))}D.push(A)}return D}function W(x,C,D,P){const p=new j.bR(x[0],x[1]);if(p.scale(P),"viewport"===C){const u=-D*(Math.PI/180),y=Math.cos(u),f=Math.sin(u);p.rotate(y,f)}return p}},68973:(mt,ot,b)=>{b.d(ot,{A:()=>K});class K{constructor(Q=0,O=0,$=0,st=0){this.x=Q,this.y=O,this.width=$,this.height=st}get isEmpty(){return this.width<=0||this.height<=0}union(Q){this.x=Math.min(this.x,Q.x),this.y=Math.min(this.y,Q.y),this.width=Math.max(this.width,Q.width),this.height=Math.max(this.height,Q.height)}}},37188:(mt,ot,b)=>{b.d(ot,{A:()=>ct});var K=b(3248),j=b(69473),Q=b(54382),O=b(89298),$=b(99065);const st=(G,H)=>G.key.level-H.key.level!=0?G.key.level-H.key.level:G.key.row-H.key.row!=0?G.key.row-H.key.row:G.key.col-H.key.col;class ct extends Q.A{constructor(H){super(),this.tileInfoView=H,this.sortFunction=st}renderChildren(H){this.setStencilReference(H),super.renderChildren(H)}createRenderParams(H){const{state:c}=H,r=super.createRenderParams(H);return r.requiredLevel=this.tileInfoView.getClosestInfoForScale(c.scale).level,r.displayLevel=this.tileInfoView.tileInfo.scaleToZoom(c.scale),r}prepareRenderPasses(H){const c=super.prepareRenderPasses(H);return c.push(H.registerRenderPass({name:"stencil",brushes:[O.A],drawPhase:j.S5.DEBUG|j.S5.MAP|j.S5.HIGHLIGHT|j.S5.LABEL,target:()=>this.getStencilTarget()})),(0,K.A)("esri-tiles-debug")&&c.push(H.registerRenderPass({name:"tileInfo",brushes:[$.A],drawPhase:j.S5.DEBUG,target:()=>this.children})),c}getStencilTarget(){return this.children}setStencilReference(H){let c=1;for(const r of this.children)r.stencilRef=c++}}},90143:(mt,ot,b)=>{b.r(ot),b.d(ot,{default:()=>Be});var K=b(10467),j=b(8189),Q=b(77806),O=b(35150),$=b(11432),st=b(56492),ct=b(85211),H=(b(3248),b(76576)),c=b(48237),r=b(1749),o=b(51995),d=b(58701),m=b(20904),v=b(45272),R=b(19284),F=b(68973);class V{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new F.A(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new F.A;let s=null,i=-1;for(let n=0;n<this._free.length;++n){const a=this._free[n];t<=a.width&&e<=a.height&&(null===s||a.y<=s.y&&a.x<=s.x)&&(s=a,i=n)}return null===s?new F.A:(this._free.splice(i,1),s.width<s.height?(s.width>t&&this._free.push(new F.A(s.x+t,s.y,s.width-t,e)),s.height>e&&this._free.push(new F.A(s.x,s.y+e,s.width,s.height-e))):(s.width>t&&this._free.push(new F.A(s.x+t,s.y,s.width-t,s.height)),s.height>e&&this._free.push(new F.A(s.x,s.y+e,t,s.height-e))),new F.A(s.x,s.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const s=this._free[e];if(s.y===t.y&&s.height===t.height&&s.x+s.width===t.x)s.width+=t.width;else if(s.x===t.x&&s.width===t.width&&s.y+s.height===t.y)s.height+=t.height;else if(t.y===s.y&&t.height===s.height&&t.x+t.width===s.x)s.x=t.x,s.width+=t.width;else{if(t.x!==s.x||t.width!==s.width||t.y+t.height!==s.y)continue;s.y=t.y,s.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}var E=b(50915),rt=b(76169),nt=b(4931);class X{constructor(t,e,s){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=s,this._binPack=new V(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,e){const s=[],i=this._glyphSource,n=new Set;for(const _ of e){const g=Math.floor(.00390625*_);n.add(g)}const l=[];return n.forEach(_=>{const g=t+_;if(this._rangePromises.has(g))l.push(this._rangePromises.get(g));else{const w=i.getRange(t,_).then(()=>{this._rangePromises.delete(g)},()=>{this._rangePromises.delete(g)});this._rangePromises.set(g,w),l.push(w)}}),Promise.all(l).then(()=>{let _=this._glyphIndex[t];_||(_={},this._glyphIndex[t]=_);for(const g of e){const w=_[g];if(w){s[g]={sdf:!0,rect:w.rect,metrics:w.metrics,page:w.page,code:g};continue}const I=i.getGlyph(t,g);if(!I?.metrics)continue;const T=I.metrics;let S;if(0===T.width)S=new F.A(0,0,0,0);else{const k=T.width+6,Y=T.height+6;let N=k%4?4-k%4:4,Z=Y%4?4-Y%4:4;1===N&&(N=5),1===Z&&(Z=5),S=this._binPack.allocate(k+N,Y+Z),S.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new V(this.width-4,this.height-4),S=this._binPack.allocate(k+N,Y+Z));const tt=this._glyphData[this._currentPage],ht=I.bitmap;let gt,lt;if(ht)for(let ut=0;ut<Y;ut++){gt=k*ut,lt=this.width*(S.y+ut+1)+S.x;for(let wt=0;wt<k;wt++)tt[lt+wt+1]=ht.at(gt+wt)}}_[g]={rect:S,metrics:T,tileIDs:null,page:this._currentPage},s[g]={sdf:!0,rect:S,metrics:T,page:this._currentPage,code:g},this._dirties[this._currentPage]=!0}return s})}removeGlyphs(t){for(const e in this._glyphIndex){const s=this._glyphIndex[e];if(!s)continue;let i;for(const n in s)if(i=s[n],i.tileIDs.delete(t),0===i.tileIDs.size){const a=this._glyphData[i.page],l=i.rect;let _,g;for(let w=0;w<l.height;w++)for(_=this.width*(l.y+w)+l.x,g=0;g<l.width;g++)a[_+g]=0;delete s[n],this._dirties[i.page]=!0}}}bind(t,e,s,i=0){if(!this._textures[s]){const a=new nt.R;a.pixelFormat=E.Ab.ALPHA,a.wrapMode=E.pF.CLAMP_TO_EDGE,a.width=this.width,a.height=this.height,this._textures[s]=new rt.g(t,a,new Uint8Array(this.width*this.height))}const n=this._textures[s];n.setSamplingMode(e),this._dirties[s]&&n.setData(this._glyphData[s]),t.bindTexture(n,i),this._dirties[s]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0}}var it=b(89563),U=b(55912);class W{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);const e=new Map;let s=0;for(;t.next();)switch(t.tag()){case 1:{const a=t.getMessage();for(;a.next();)switch(a.tag()){case 3:{const l=a.getMessage();let _,g,w,I,T,S,B;for(;l.next();)switch(l.tag()){case 1:_=l.getUInt32();break;case 2:g=l.getBytes();break;case 3:w=l.getUInt32();break;case 4:I=l.getUInt32();break;case 5:T=l.getSInt32();break;case 6:S=l.getSInt32();break;case 7:B=l.getUInt32();break;default:l.skip()}if(l.release(),_){const k=g?.length??0;this._metrics[_]={width:w,height:I,left:T,top:S,advance:B,startOffset:s,length:k},e.set(_,g),s+=k}break}default:a.skip()}a.release();break}default:t.skip()}const i=new Uint8Array(s),n=this._metrics;for(const[a,l]of e){const{startOffset:_,length:g}=n[a];if(l)for(let w=0;w<g;++w)i[_+w]=l[w]}this._allBitmaps=i}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;const e=this._metrics[t];if(void 0===e)return;const{startOffset:s,length:i}=e;return 0!==i?new D(this._allBitmaps,s,i):void 0}}class x{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class C{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e){const s=this._getFontStack(t);if(s.getRange(e))return Promise.resolve();const i=256*e,n=i+255;if(this._baseURL){const a=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+n);return(0,it.A)(a,{responseType:"array-buffer"}).then(l=>{s.addRange(e,new W(new U.A(new Uint8Array(l.data),new DataView(l.data))))}).catch(()=>{s.addRange(e,new W)})}return s.addRange(e,new W),Promise.resolve()}getGlyph(t,e){const s=this._getFontStack(t);if(!s)return;const i=Math.floor(e/256),n=s.getRange(i);return n?{metrics:n.getMetrics(e),bitmap:n.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new x),e}}class D{constructor(t,e,s){this._array=t,this._start=e,this.length=s}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}}var P=b(28685);class u{constructor(t,e,s=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,e<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,s>0&&(this._maxItemSize=s),this._binPack=new V(t-4,e-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new V(this._pageWidth-4,this._pageHeight-4);const e=Math.floor(this._pageWidth),s=Math.floor(this._pageHeight),i=new Uint32Array(e*s);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,e=!1){let s,i,n=this._mosaicRects[t];if(n)return n;if(!this._sprites||"loaded"!==this._sprites.loadStatus||(t&&t.startsWith("dasharray-")?([s,i]=this._rasterizeDash(t),e=!0):s=this._sprites.getSpriteInfo(t),!s?.width||!s.height||s.width<0||s.height<0))return null;const a=s.width,l=s.height,[_,g,w]=this._allocateImage(a,l);return _.width<=0?null:(this._copy(_,s,g,w,e,i),n={type:"sprite",rect:_,width:a,height:l,sdf:s.sdf,simplePattern:!1,rasterizationScale:s.pixelRatio??1,samplingMode:"Linear",page:g},this._mosaicRects[t]=n,n)}getSpriteItems(t){const e={};for(const s of t)e[s.name]=this.getSpriteItem(s.name,s.repeat);return e}getMosaicItemPosition(t,e){const s=this.getSpriteItem(t,e),i=s?.rect;return i?(i.width=s.width,i.height=s.height,{tl:[i.x+2,i.y+2],br:[i.x+2+s.width,i.y+2+s.height],page:s.page}):null}bind(t,e,s=0,i=0){if(s>=this._size.length||s>=this._mosaicsData.length)return;if(!this._textures[s]){const a=new nt.R;a.wrapMode=E.pF.CLAMP_TO_EDGE,a.width=this._size[s][0],a.height=this._size[s][1],this._textures[s]=new rt.g(t,a,new Uint8Array(this._mosaicsData[s].buffer))}const n=this._textures[s];n.setSamplingMode(e),this._dirties[s]&&n.setData(new Uint8Array(this._mosaicsData[s].buffer)),t.bindTexture(n,i),this._dirties[s]=!1}static _copyBits(t,e,s,i,n,a,l,_,g,w,I){let T=i*e+s,S=_*a+l;if(I){S-=a;for(let B=-1;B<=w;B++,T=((B+w)%w+i)*e+s,S+=a)for(let k=-1;k<=g;k++)n[S+k]=t[T+(k+g)%g]}else for(let B=0;B<w;B++){for(let k=0;k<g;k++)n[S+k]=t[T+k];T+=e,S+=a}}_copy(t,e,s,i,n,a){if(!this._sprites||"loaded"!==this._sprites.loadStatus||s>=this._mosaicsData.length)return;const l=new Uint32Array(a?a.buffer:this._sprites.image.buffer);u._copyBits(l,a?e.width:this._sprites.width,e.x,e.y,this._mosaicsData[s],i[0],t.x+2,t.y+2,e.width,e.height,n),this._dirties[s]=!0}_allocateImage(t,e){t+=2,e+=2;const s=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<s){const l=new F.A(0,0,t,e);return this._mosaicsData.push(new Uint32Array(t*e)),this._dirties.push(!0),this._size.push([t,e]),this._textures.push(void 0),[l,this._mosaicsData.length-1,[t,e]]}let i=t%4?4-t%4:4,n=e%4?4-e%4:4;1===i&&(i=5),1===n&&(n=5);const a=this._binPack.allocate(t+i,e+n);return a.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new V(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,e)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){const s=t.match(/\[(.*?)\]/);if(!s)return null;const i=s[1].split(",").map(Number),n=t.slice(t.lastIndexOf("-")+1),[a,l,_]=(0,P.k2)(i,n);return[{x:0,y:0,width:l,height:_,sdf:!0,pixelRatio:1},new Uint8Array(a.buffer)]}}var y=b(74847);class f{constructor(t,e,s,i){this._layer=t,this._styleRepository=e,this.devicePixelRatio=s,this._sourceDataMaxLOD=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,$.DC)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}start(t){var e=this;return(0,K.A)(function*(){e._requestSprite(t);const s=e._layer.currentStyleInfo.glyphsUrl,i=new C(s?(0,v.a6)(s,{...e._layer.customParameters,token:e._layer.apiKey}):null);e._glyphMosaic=new X(1024,1024,i),e._broadcastPromise=(0,R.ho)("WorkerTileHandler",{client:e,schedule:t.schedule,signal:t.signal}).then(n=>{if(e._layer&&(e._connection?.close(),e._connection=n,e._layer&&!e._connection.closed)){const a=n.broadcast("setStyle",{style:e._layer.currentStyleInfo.style,sourceDataMaxLOD:e._sourceDataMaxLOD},t);Promise.all(a).catch(l=>(0,st.jH)(l))}})})()}_requestSprite(t){this._spriteSourceAbortController?.abort();const e=new AbortController;this._spriteSourceAbortController=e;const s=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,s&&(this._inputSignalEventListener=function A(h){return()=>h.abort()}(e),s.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=e,n={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,n),this._spriteSourcePromise.then(a=>{(0,st.QP)(i),this._spriteMosaic=new u(1024,1024,250),this._spriteMosaic.setSpriteSource(a)})}updateStyle(t){var e=this;return(0,K.A)(function*(){const s=[];for(const i of t)s.push(i.type===m.$q.SPRITES_CHANGED?{type:m.$q.SPRITES_CHANGED,data:{spriteSource:null}}:i);return yield e._broadcastPromise,e._broadcastPromise=Promise.all(e._connection.broadcast("updateStyle",s)),e._broadcastPromise})()}setSpriteSource(t){const e=new u(1024,1024,250);return e.setSpriteSource(t),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,e}setStyle(t,e,s){var i=this;return(0,K.A)(function*(){yield i._broadcastPromise,i._styleRepository=t,i._sourceDataMaxLOD=s,i._requestSprite();const n=new C(i._layer.currentStyleInfo.glyphsUrl?(0,v.a6)(i._layer.currentStyleInfo.glyphsUrl,{...i._layer.customParameters,token:i._layer.apiKey}):null);return i._glyphMosaic=new X(1024,1024,n),i._broadcastPromise=Promise.all(i._connection.broadcast("setStyle",{style:e,sourceDataMaxLOD:i._sourceDataMaxLOD})),i._broadcastPromise})()}fetchTileData(t,e){var s=this;return(0,K.A)(function*(){const i=yield s._getRefKeys(t,e);return s._getSourcesData(Object.keys(s._layer.sourceNameToSource),i,e)})()}fetchTilePBFs(t){var e=this;return(0,K.A)(function*(){const s=Object.keys(e._layer.sourceNameToSource),i={},n=yield e._getRefKeys(t,i),a=[],l=[];for(let _=0;_<n.length;_++)if(null==n[_].value||null==s[_])l.push(null);else{const g=n[_].value,w=e._getTilePayload(g,s[_],i);w.then(I=>{a.push({...I,key:g})}),l.push(w)}return Promise.all(l).then(()=>a)})()}parseTileData(t,e){var s=this;return(0,K.A)(function*(){const i=t&&t.data;if(!i)return null;const{sourceName2DataAndRefKey:n,transferList:a}=i;return 0===Object.keys(n).length?null:s._broadcastPromise.then(()=>s._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:n,styleLayerUIDs:t.styleLayerUIDs},{...e,transferList:a}))})()}getSprites(t){var e=this;return(0,K.A)(function*(){return yield e._spriteSourcePromise,e._spriteMosaic.getSpriteItems(t)})()}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}_getTilePayload(t,e,s){var i=this;return(0,K.A)(function*(){const n=y.A.pool.acquire(t.id),a=i._layer.sourceNameToSource[e],{level:l,row:_,col:g}=n;y.A.pool.release(n);try{return{protobuff:yield a.requestTile(l,_,g,s),sourceName:e}}catch(w){if((0,st.zf)(w))throw w;return{protobuff:null,sourceName:e}}})()}_getRefKeys(t,e){var s=this;return(0,K.A)(function*(){const i=s._layer.sourceNameToSource,n=new Array;for(const a in i){const l=i[a].getRefKey(t,e);n.push(l)}return(0,st.Lx)(n)})()}_getSourcesData(t,e,s){const i=[];for(let n=0;n<e.length;n++)if(null==e[n].value||null==t[n])i.push(null);else{const l=this._getTilePayload(e[n].value,t[n],s);i.push(l)}return(0,st.Lx)(i).then(n=>{const a={},l=[];for(let _=0;_<n.length;_++){const g=n[_].value;g&&g.protobuff&&g.protobuff.byteLength>0&&(a[g.sourceName]={refKey:e[_].value.id,protobuff:g.protobuff},l.push(g.protobuff))}return{sourceName2DataAndRefKey:a,transferList:l}})}}var M=b(33087),z=b(75324);const J=(h,t)=>h+1/(1<<2*t);class et{constructor(t,e){this._tiles=new Map,this._tileCache=new M.q(40,s=>s.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=e}destroy(){for(const t of this._tiles.values())t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const e=this.tileInfoView,s=e.getTileCoverage(t.state,0,!0,"smallest");if(!s)return!0;const{spans:i,lodInfo:n}=s,{level:a}=n,l=this._tiles,_=new Set,g=new Set;for(const{row:I,colFrom:T,colTo:S}of i)for(let B=T;B<=S;B++){const k=y.A.getId(a,I,n.normalizeCol(B),n.getWorldForColumn(B)),Y=this._getOrAcquireTile(k);_.add(k),Y.processed()?this._addToContainer(Y):g.add(new y.A(k))}for(const[I,T]of l)T.isCoverage=_.has(I);for(const I of g)this._findPlaceholdersForMissingTiles(I,_);let w=!1;for(const[I,T]of l)T.neededForCoverage=_.has(I),T.neededForCoverage||T.isHoldingForFade&&e.intersects(s,T.key)&&_.add(I),T.isFading&&(w=!0);for(const I of this._tiles.keys())_.has(I)||this._releaseTile(I);return z.A.pool.release(s),!w}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(t,e,s,i,n){const a=[0,0],l=[0,0];i.toMap(a,t-s,e+s),i.toMap(l,t+s,e-s);const _=Math.min(a[0],l[0]),g=Math.min(a[1],l[1]),w=Math.max(a[0],l[0]),I=Math.max(a[1],l[1]),T=(0,o.fA)(_,g,w,I),S=(0,o.vt)(),B=[];for(const k of this._visibleTiles.values())this.tileInfoView.getTileBounds(S,k.key),(0,o.HY)(T,S)&&B.push(k);if(null!=n&&n.length>0){const k=new Set(B.map(N=>N.id)),Y=n.filter(N=>!k.has(N.tileKey.id)).map(N=>this._visibleTiles.get(N.tileKey.id)).filter(N=>void 0!==N);B.push(...Y)}return B}_findPlaceholdersForMissingTiles(t,e){const s=[];for(const n of this._tiles.values())this._addPlaceholderChild(s,n,t,e);const i=s.reduce(J,0);Math.abs(1-i)<1e-6||this._addPlaceholderParent(t.id,e)}_addPlaceholderChild(t,e,s,i){e.key.level<=s.level||!e.hasData()||function St(h,t){const e=t.level-h.level;return h.row===t.row>>e&&h.col===t.col>>e&&h.world===t.world}(s,e.key)&&(this._addToContainer(e),i.add(e.id),t.push(e.key.level-s.level))}_addPlaceholderParent(t,e){const s=this._tiles;let i=t;for(;;){if(i=_t(i),!i||e.has(i))return;const n=s.get(i);if(n?.hasData())return this._addToContainer(n),void e.add(n.id)}}_getOrAcquireTile(t){let e=this._tiles.get(t);return e||(e=this._tileCache.pop(t),e||(e=this.acquireTile(new y.A(t))),this._tiles.set(t,e),e)}_releaseTile(t){const e=this._tiles.get(t);this.releaseTile(e),this._removeFromContainer(e),this._tiles.delete(t),e.hasData()?this._tileCache.put(t,e,1):e.dispose()}_addToContainer(t){let e;const s=[],i=this._container;if(i.contains(t))return;const n=this._visibleTiles;for(const a of n.values())this._canConnectDirectly(t,a)&&s.push(a),null==e&&this._canConnectDirectly(a,t)&&(e=a);if(null!=e){for(const a of s)e.childrenTiles.delete(a),t.childrenTiles.add(a),a.parentTile=t;e.childrenTiles.add(t),t.parentTile=e}else for(const a of s)t.childrenTiles.add(a),a.parentTile=t;n.set(t.id,t),i.addChild(t)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),null!=t.parentTile){t.parentTile.childrenTiles.delete(t);for(const e of t.childrenTiles)null!=t.parentTile&&t.parentTile.childrenTiles.add(e)}for(const e of t.childrenTiles)e.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,e){const s=t.key;let{level:i,row:n,col:a,world:l}=e.key;const _=this._visibleTiles;for(;i>0;){if(i--,n>>=1,a>>=1,s.level===i&&s.row===n&&s.col===a&&s.world===l)return!0;if(_.has(`${i}/${n}/${a}/${l}`))return!1}return!1}_updateCacheSize(t){const e=t.state.size;if(e[0]===this._viewSize[0]&&e[1]===this._viewSize[1])return;const s=Math.ceil(e[0]/512)+1,i=Math.ceil(e[1]/512)+1;this._viewSize[0]=e[0],this._viewSize[1]=e[1],this._tileCache.maxSize=5*s*i}}function _t(h){const[t,e,s,i]=h.split("/"),n=parseInt(t,10);return 0===n?null:`${n-1}/${parseInt(e,10)>>1}/${parseInt(s,10)>>1}/${parseInt(i,10)}`}var dt=b(31610),yt=b(12273),Mt=b(11445),xt=b(54290),Ot=b(15215),zt=(b(77031),b(4139));class te{constructor(t,e){this.sourceTile=e,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class ee{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function Ut(h,t,e,s,i,n){const a=e-i;if(a>=0)return(t>>a)+(s-(n<<a))*(h>>a);const l=-a;return t-(n-(s<<l))*(h>>l)<<l}class Bt{constructor(t,e,s){this._rows=Math.ceil(e/s),this._columns=Math.ceil(t/s),this._cellSize=s,this.cells=new Array(this._rows);for(let i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[i][n]=[]}}getCell(t,e){const s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[s]&&this.cells[s][i]||null}getCellSpan(t,e,s,i){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function re(h,t,e,s,i){const n=h.layerData.get(i);if(n.type===m.NP.SYMBOL){for(const a of s){const l=a.unique;let _;if(a.selectedForRendering){const g=l.parts[0],w=g.startOpacity,I=g.targetOpacity;h.allSymbolsFadingOut=h.allSymbolsFadingOut&&0===I;const T=e?Math.floor(127*w)|I<<7:I?255:0;_=T<<24|T<<16|T<<8|T}else _=0;for(const[g,w]of a.iconVertexRanges)for(let I=g;I<g+w;I+=4)n.iconOpacity[I/4]=_;if(a.selectedForRendering){const g=l.parts[1],w=g.startOpacity,I=g.targetOpacity;h.allSymbolsFadingOut=h.allSymbolsFadingOut&&0===I;const T=e?Math.floor(127*w)|I<<7:I?255:0;_=T<<24|T<<16|T<<8|T}else _=0;for(const[g,w]of a.textVertexRanges)for(let I=g;I<g+w;I+=4)n.textOpacity[I/4]=_}n.lastOpacityUpdate=t,n.opacityChanged=!0}}function ne(h,t,e,s){const i=h.colliders;let n,a,l,_;for(const g of i)if(h.unique.show&&h.unique.parts[g.partIndex].show&&(n=g.xScreen-s[0]+g.dxScreen,a=g.yScreen-s[1]+g.dyScreen,l=n+g.width,_=a+g.height,(0,zt.w4)(e,t.x,t.y,n,a,l,_)))return!0;return!1}var ft=b(32788),bt=b(45513);class Tt{constructor(t,e){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let s=1;const i=new Uint32Array(t);this.layerUIDs=[];const n=i[s++];for(let a=0;a<n;a++)this.layerUIDs[a]=i[s++];this.bufferDataOffset=s,e&&(this.layer=e.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(t){null!=this._data&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null)}}class oe extends Tt{constructor(t,e){super(t,e),this.type=m.NP.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const s=new Uint32Array(t);let i=this.bufferDataOffset;this.lineIndexStart=s[i++],this.lineIndexCount=s[i++];const n=s[i++];if(n>0){this.patternMap=new Map;for(let a=0;a<n;a++){const l=s[i++],_=s[i++],g=s[i++];this.patternMap.set(l,[_,g])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,$.WD)(this.vao)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),n=new Int32Array(i.buffer),a=i[s++],l=ft.g.createVertex(t,E._U.STATIC_DRAW,new Int32Array(n.buffer,4*s,a));s+=a;const _=i[s++],g=ft.g.createIndex(t,E._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,_));s+=_;const w=this.layer.lineMaterial;this.vao=new bt.Z(t,w.getAttributeLocations(),w.getLayoutInfo(),new Map([["geometry",l]]),g)}}class ae extends Tt{constructor(t,e){super(t,e),this.type=m.NP.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const s=new Uint32Array(t);let i=this.bufferDataOffset;this.fillIndexStart=s[i++],this.fillIndexCount=s[i++],this.outlineIndexStart=s[i++],this.outlineIndexCount=s[i++];const n=s[i++];if(n>0){this.patternMap=new Map;for(let a=0;a<n;a++){const l=s[i++],_=s[i++],g=s[i++];this.patternMap.set(l,[_,g])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,$.WD)(this.fillVAO),this.outlineVAO=(0,$.WD)(this.outlineVAO)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),n=new Int32Array(i.buffer),a=i[s++],l=ft.g.createVertex(t,E._U.STATIC_DRAW,new Int32Array(n.buffer,4*s,a));s+=a;const _=i[s++],g=ft.g.createIndex(t,E._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,_));s+=_;const w=i[s++],I=ft.g.createVertex(t,E._U.STATIC_DRAW,new Int32Array(n.buffer,4*s,w));s+=w;const T=i[s++],S=ft.g.createIndex(t,E._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,T));s+=T;const B=this.layer,k=B.fillMaterial,Y=B.outlineMaterial;this.fillVAO=new bt.Z(t,k.getAttributeLocations(),k.getLayoutInfo(),new Map([["geometry",l]]),g),this.outlineVAO=new bt.Z(t,Y.getAttributeLocations(),Y.getLayoutInfo(),new Map([["geometry",I]]),S)}}class le extends Tt{constructor(t,e,s){super(t,e),this.type=m.NP.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(t),n=new Int32Array(t),a=new Float32Array(t);let l=this.bufferDataOffset;this.isIconSDF=!!i[l++];const _=i[l++],g=i[l++],w=i[l++],I=new y.A(_,g,w,0),T=i[l++];for(let Y=0;Y<T;Y++){const N=i[l++],Z=i[l++],tt=i[l++];this.iconPerPageElementsMap.set(N,[Z,tt])}const S=i[l++];for(let Y=0;Y<S;Y++){const N=i[l++],Z=i[l++],tt=i[l++];this.glyphPerPageElementsMap.set(N,[Z,tt])}const B=i[l++],k=i[l++];this.iconOpacity=new Int32Array(B),this.textOpacity=new Int32Array(k),l=function se(h,t,e,s,i,n,a){const l=t[s++];for(let _=0;_<l;_++){const g=new te(n,a);g.xTile=t[s++],g.yTile=t[s++],g.hash=t[s++],g.priority=t[s++],g.featureIndex=t[s++];const w=t[s++];for(let S=0;S<w;S++){const B=t[s++],k=t[s++],Y=t[s++],N=t[s++],Z=!!t[s++],tt=t[s++],ht=e[s++],gt=e[s++],lt=t[s++],ut=t[s++];g.colliders.push({xTile:B,yTile:k,dxPixels:Y,dyPixels:N,hard:Z,partIndex:tt,width:lt,height:ut,minLod:ht,maxLod:gt})}const I=h[s++];for(let S=0;S<I;S++)g.textVertexRanges.push([h[s++],h[s++]]);const T=h[s++];for(let S=0;S<T;S++)g.iconVertexRanges.push([h[s++],h[s++]]);i.push(g)}return s}(i,n,a,l,this.symbols,s,I),this.bufferDataOffset=l}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+(0,Mt.Qf)(this.iconOpacity)+(0,Mt.Qf)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const e of this.iconPerPageElementsMap.values())t+=e[1];for(const e of this.glyphPerPageElementsMap.values())t+=e[1];return t/3}doDestroy(){this.iconVAO=(0,$.WD)(this.iconVAO),this.textVAO=(0,$.WD)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,e=this.iconVAO.vertexBuffers.get("opacity");t.length>0&&t.byteLength===e.usedMemory&&e.setSubData(t,0,0,t.length);const s=this.textOpacity,i=this.textVAO.vertexBuffers.get("opacity");s.length>0&&s.byteLength===i.usedMemory&&i.setSubData(s,0,0,s.length)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),n=new Int32Array(i.buffer),a=i[s++],l=ft.g.createVertex(t,E._U.STATIC_DRAW,new Int32Array(n.buffer,4*s,a));s+=a;const _=i[s++],g=ft.g.createIndex(t,E._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,_));s+=_;const w=i[s++],I=ft.g.createVertex(t,E._U.STATIC_DRAW,new Int32Array(n.buffer,4*s,w));s+=w;const T=i[s++],S=ft.g.createIndex(t,E._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,T));s+=T;const B=ft.g.createVertex(t,E._U.STATIC_DRAW,this.iconOpacity.buffer),k=ft.g.createVertex(t,E._U.STATIC_DRAW,this.textOpacity.buffer),Y=this.layer,N=Y.iconMaterial,Z=Y.textMaterial;this.iconVAO=new bt.Z(t,N.getAttributeLocations(),N.getLayoutInfo(),new Map([["geometry",l],["opacity",B]]),g),this.textVAO=new bt.Z(t,Z.getAttributeLocations(),Z.getLayoutInfo(),new Map([["geometry",I],["opacity",k]]),S)}}class he extends Tt{constructor(t,e){super(t,e),this.type=m.NP.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const s=new Uint32Array(t);let i=this.bufferDataOffset;this.circleIndexStart=s[i++],this.circleIndexCount=s[i++],this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,$.WD)(this.vao)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),n=new Int32Array(i.buffer),a=i[s++],l=ft.g.createVertex(t,E._U.STATIC_DRAW,new Int32Array(n.buffer,4*s,a));s+=a;const _=i[s++],g=ft.g.createIndex(t,E._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,_));s+=_;const w=this.layer.circleMaterial;this.vao=new bt.Z(t,w.getAttributeLocations(),w.getLayoutInfo(),new Map([["geometry",l]]),g)}}var vt=b(24505),kt=b(15442);class Pt extends kt.Y{constructor(t,e,s,i,n,a,l,_=null){super(t,e,s,i,n,a,4096,4096),this.styleRepository=l,this._memCache=_,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<vt.zk}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<vt.zk)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(t){let e=!1;for(const s of t){const i=this.layerData.get(s);i&&(this._usedMemory-=i.usedMemory,i.type===m.NP.SYMBOL&&this.symbols.delete(s)&&(e=!0),i.destroy(),this.layerData.delete(s))}this._memCache?.updateSize(this.key.id,this),e&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const t=this.layerData.values();for(const e of t)if(e.hasData())return!0;return!1}dispose(){"unloaded"!==this.status&&(Pt._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){0==--this._referenced&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(t){this.featureIndex?.clear();let e=!1;if(t){const{bucketsWithData:s,emptyBuckets:i}=t,n=this._createRenderBuckets(s);if(i&&i.byteLength>0){const a=new Uint32Array(i);for(const l of a)this._deleteLayerData(l)}for(const[a,l]of n)this._deleteLayerData(a),l.type===m.NP.SYMBOL&&(this.symbols.set(a,l.symbols),e=!0),this._usedMemory+=l.usedMemory,this.layerData.set(a,l);this._memCache?.updateSize(this.key.id,this)}this._hasSymbolBuckets=!1;for(const s of this.layerData.values())s.type===m.NP.SYMBOL&&(this._hasSymbolBuckets=!0);e&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t){super.setTransform(t);const e=this.resolution/(t.resolution*t.pixelRatio),s=this.width/this.rangeX*e,i=this.height/this.rangeY*e,n=[0,0];t.toScreen(n,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;(0,dt.D_)(a),(0,dt.Tl)(a,a,n),(0,dt.e$)(a,a,Math.PI*t.rotation/180),(0,dt.hs)(a,a,[s,i,1])}_createTransforms(){return{displayViewScreenMat3:(0,yt.vt)(),tileMat3:(0,yt.vt)(),tileUnitsToPixels:(0,yt.vt)()}}static _destroyRenderBuckets(t){if(!t)return;const e=new Set;for(const s of t.values())e.has(s)||(s.destroy(),e.add(s));t.clear()}_createRenderBuckets(t){const e=new Map,s=new Map;for(const i of t){const n=this._deserializeBucket(i,s);for(const a of n.layerUIDs)e.set(a,n)}return e}_deserializeBucket(t,e){let s=e.get(t);if(s)return s;switch(new Uint32Array(t)[0]){case m.NP.FILL:s=new ae(t,this.styleRepository);break;case m.NP.LINE:s=new oe(t,this.styleRepository);break;case m.NP.SYMBOL:s=new le(t,this.styleRepository,this);break;case m.NP.CIRCLE:s=new he(t,this.styleRepository)}return e.set(t,s),s}_deleteLayerData(t){if(!this.layerData.has(t))return;const e=this.layerData.get(t);this._usedMemory-=e.usedMemory,e.destroy(),this.layerData.delete(t)}}var Vt=b(11333),ce=b(54029),at=b(54e3);function ue(h,t,e,s,i,n){const{iconRotationAlignment:a,textRotationAlignment:l,iconTranslate:_,iconTranslateAnchor:g,textTranslate:w,textTranslateAnchor:I}=s;let T=0;for(const S of h.colliders){const[B,k]=0===S.partIndex?_:w,Y=0===S.partIndex?g:I,N=S.minLod<=n&&n<=S.maxLod;T+=N?0:1,S.enabled=N,S.xScreen=S.xTile*i[0]+S.yTile*i[3]+i[6],S.yScreen=S.xTile*i[1]+S.yTile*i[4]+i[7],Y===at.Cq.MAP?(S.xScreen+=e*B-t*k,S.yScreen+=t*B+e*k):(S.xScreen+=B,S.yScreen+=k),at.I5.VIEWPORT===(0===S.partIndex?a:l)?(S.dxScreen=S.dxPixels,S.dyScreen=S.dyPixels):(S.dxScreen=e*(S.dxPixels+S.width/2)-t*(S.dyPixels+S.height/2)-S.width/2,S.dyScreen=t*(S.dxPixels+S.width/2)+e*(S.dyPixels+S.height/2)-S.height/2)}h.colliders.length>0&&T===h.colliders.length&&(h.unique.show=!1)}class _e{constructor(t,e,s,i,n,a){this._symbols=t,this._styleRepository=i,this._zoom=n,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new Bt(e,s,vt.o2),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180);for(const l of t)for(const _ of l.symbols)this._allNeededMatrices.has(_.tile)||this._allNeededMatrices.set(_.tile,(0,yt.o8)(_.tile.transforms.tileUnitsToPixels))}work(t){const e=this._gridIndex;function s(n){const a=n.xScreen+n.dxScreen,l=n.yScreen+n.dyScreen,_=a+n.width,g=l+n.height,[w,I,T,S]=e.getCellSpan(a,l,_,g);for(let B=I;B<=S;B++)for(let k=w;k<=T;k++){const Y=e.cells[B][k];for(const N of Y){const Z=N.xScreen+N.dxScreen,tt=N.yScreen+N.dyScreen;if(!(_<Z||a>Z+N.width||g<tt||l>tt+N.height))return!0}}return!1}const i=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const n=this._symbols[this._currentLayerCursor],a=this._getProperties(n.styleLayerUID);for(;this._currentSymbolCursor<n.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-i>t)return!1;const l=n.symbols[this._currentSymbolCursor];if(!l.unique.show)continue;ue(l,this._si,this._co,a,this._allNeededMatrices.get(l.tile),this._zoom);const _=l.unique;if(!_.show)continue;const{iconAllowOverlap:g,iconIgnorePlacement:w,textAllowOverlap:I,textIgnorePlacement:T}=a;for(const S of l.colliders){if(!S.enabled)continue;const B=_.parts[S.partIndex];B.show&&!(S.partIndex?I:g)&&s(S)&&(S.hard?_.show=!1:B.show=!1)}if(_.show)for(const S of l.colliders){if(!S.enabled||(S.partIndex?T:w)||!_.parts[S.partIndex].show)continue;const B=S.xScreen+S.dxScreen,k=S.yScreen+S.dyScreen,Y=B+S.width,N=k+S.height,[Z,tt,ht,gt]=this._gridIndex.getCellSpan(B,k,Y,N);for(let lt=tt;lt<=gt;lt++)for(let ut=Z;ut<=ht;ut++)this._gridIndex.cells[lt][ut].push(S)}}}return!0}_getProperties(t){const e=this._styleProps.get(t);if(e)return e;const s=this._zoom,i=this._styleRepository.getStyleLayerByUID(t),n=i.getLayoutValue("symbol-placement",s)!==at.kt.POINT;let a=i.getLayoutValue("icon-rotation-alignment",s);a===at.I5.AUTO&&(a=n?at.I5.MAP:at.I5.VIEWPORT);let l=i.getLayoutValue("text-rotation-alignment",s);l===at.I5.AUTO&&(l=n?at.I5.MAP:at.I5.VIEWPORT);const _=i.getPaintValue("icon-translate",s),g=i.getPaintValue("icon-translate-anchor",s),w=i.getPaintValue("text-translate",s),I=i.getPaintValue("text-translate-anchor",s),T={iconAllowOverlap:i.getLayoutValue("icon-allow-overlap",s),iconIgnorePlacement:i.getLayoutValue("icon-ignore-placement",s),textAllowOverlap:i.getLayoutValue("text-allow-overlap",s),textIgnorePlacement:i.getLayoutValue("text-ignore-placement",s),iconRotationAlignment:a,textRotationAlignment:l,iconTranslateAnchor:g,iconTranslate:_,textTranslateAnchor:I,textTranslate:w};return this._styleProps.set(t,T),T}}function de(h,t){if(h.priority-t.priority)return h.priority-t.priority;const e=h.tile.key,s=t.tile.key;return e.world-s.world?e.world-s.world:e.level-s.level?e.level-s.level:e.row-s.row?e.row-s.row:e.col-s.col?e.col-s.col:h.xTile-t.xTile?h.xTile-t.xTile:h.yTile-t.yTile}class ye{get running(){return this._running}constructor(t,e,s,i,n,a){this._visibleTiles=t,this._symbolRepository=e,this._createCollisionJob=s,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=n,this._isLayerVisible=a,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(t,e){this._screenWidth===t&&this._screenHeight===e||this.restart(),this._screenWidth=t,this._screenHeight=e}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(t){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const e=performance.now();if(!this._selectionJob.work(t)||(this._selectionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-e)))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const e=performance.now();if(!this._collisionJob.work(t)||(this._collisionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-e)))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const e=performance.now();if(!this._opacityJob.work(t)||(this._opacityJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-e)))))return!1}return this._running=!1,!0}_createSelectionJob(){const t=this._symbolRepository.uniqueSymbols;for(let _=0;_<t.length;_++){const g=t[_];for(let w=0;w<g.uniqueSymbols.length;w++){const I=g.uniqueSymbols[w];for(const T of I.tileSymbols)T.selectedForRendering=!1}}const e=[];let s=0,i=0;const n=this._isLayerVisible,l=this._symbolLayerSorter;return{work:function a(_){let g;const w=performance.now();for(;i<t.length;i++,s=0){const I=t[i],T=I.styleLayerUID;if(!n(T)){e[i]||(e[i]={styleLayerUID:T,symbols:[]});continue}e[i]=e[i]||{styleLayerUID:T,symbols:[]};const S=e[i];for(;s<I.uniqueSymbols.length;s++){if(g=I.uniqueSymbols[s],s%100==99&&performance.now()-w>_)return!1;let B=null,k=!1,Y=!1;for(const N of g.tileSymbols)if(!Y||!k){const Z=N.tile;(!B||Z.isCoverage||Z.neededForCoverage&&!k)&&(B=N,(Z.neededForCoverage||Z.isCoverage)&&(Y=!0),Z.isCoverage&&(k=!0))}if(B.selectedForRendering=!0,Y){S.symbols.push(B),g.show=!0;for(const N of g.parts)N.show=!0}else g.show=!1}}for(const I of e)I.symbols.sort(de);return!0},get sortedSymbols(){return e.sort(l)}}}_createOpacityJob(){const t=this._assignTileSymbolsOpacity,e=this._visibleTiles;let s=0;function i(n,a){for(const l of n.symbols.values())fe(l,a);t(n,a);for(const l of n.childrenTiles)i(l,a)}return{work(n){const a=performance.now();for(;s<e.length;s++){if(performance.now()-a>n)return!1;const l=e[s];null==l.parentTile&&i(l,performance.now())}return!0}}}}function fe(h,t){for(const e of h){const s=e.unique;for(const i of s.parts)i.startOpacity+=(t-i.startTime)/vt.zk*(i.targetOpacity>.5?1:-1),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=s.show&&i.show?1:0}}class we{constructor(t,e,s){this.tileCoordRange=t,this._visibleTiles=e,this._createUnique=s,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(t,e){this._uniqueSymbolLayerArray=null;let s=this._tiles.get(t.id);s||(s={symbols:new Map},this._tiles.set(t.id,s));const i=new Map;if(e)for(const l of e)s.symbols.has(l)&&(i.set(l,s.symbols.get(l)),s.symbols.delete(l));else for(const[l,_]of t.layerData)s.symbols.has(l)&&(i.set(l,s.symbols.get(l)),s.symbols.delete(l));this._removeSymbols(i);const n=t.symbols,a=new Map;for(const[l,_]of n){let g=_.length;if(g>=32){let w=this.tileCoordRange;do{w/=2,g/=4}while(g>8&&w>64);const I=new Bt(this.tileCoordRange,this.tileCoordRange,w);a.set(l,{flat:_,index:I}),s.symbols.set(l,{flat:_,index:I});for(const T of _)I.getCell(T.xTile,T.yTile).push(T)}else a.set(l,{flat:_}),s.symbols.set(l,{flat:_})}this._addSymbols(t.key,n)}deleteStyleLayers(t){this._uniqueSymbolLayerArray=null;for(const[e,s]of this._tiles){const i=new Map;for(const n of t)s.symbols.has(n)&&(i.set(n,s.symbols.get(n)),s.symbols.delete(n));this._removeSymbols(i),0===s.symbols.size&&this._tiles.delete(e)}}removeTile(t){this._uniqueSymbolLayerArray=null;const e=this._tiles.get(t.id);if(!e)return;const s=new Map;for(const[i,n]of t.symbols)e.symbols.has(i)&&(s.set(i,e.symbols.get(i)),e.symbols.delete(i));this._removeSymbols(s),0===e.symbols.size&&this._tiles.delete(t.id)}querySymbols(t,e,s,i){const n=[],a=this.uniqueSymbols;for(const l of a){const _=l.styleLayerUID,g=l.uniqueSymbols;for(const w of g){const I=w.tileSymbols.find(T=>T.selectedForRendering);I&&ne(I,t,e*(window.devicePixelRatio||1),s)&&n.push({vtlSymbol:I,styleLayerUID:_,tileKey:I.tile.key})}}return n}_removeSymbols(t){for(const[e,{flat:s}]of t)for(const i of s){const n=i.unique,a=n.tileSymbols,l=a.length-1;for(let _=0;_<l;_++)if(a[_]===i){a[_]=a[l];break}if(a.length=l,0===l){const _=this._uniqueSymbolsReferences.get(e);_.delete(n),0===_.size&&this._uniqueSymbolsReferences.delete(e)}i.unique=null}}_addSymbols(t,e){if(0===e.size)return;const s=this._visibleTiles;for(const i of s)i.parentTile||i.key.world!==t.world||i.key.level===t.level&&!i.key.equals(t)||this._matchSymbols(i,t,e);for(const[i,n]of e)for(const a of n)if(null==a.unique){const l=this._createUnique();a.unique=l,l.tileSymbols.push(a);let _=this._uniqueSymbolsReferences.get(i);_||(_=new Set,this._uniqueSymbolsReferences.set(i,_)),_.add(l)}}_matchSymbols(t,e,s){if(t.key.level>e.level){const n=t.key.level-e.level;if(t.key.row>>n!==e.row||t.key.col>>n!==e.col)return}if(e.level>t.key.level){const n=e.level-t.key.level;if(e.row>>n!==t.key.row||e.col>>n!==t.key.col)return}if(e.equals(t.key)){for(const n of t.childrenTiles)this._matchSymbols(n,e,s);return}const i=new Map;for(const[n,a]of s){const l=[];for(const I of a){const T=Ut(this.tileCoordRange,I.xTile,e.level,e.col,t.key.level,t.key.col),S=Ut(this.tileCoordRange,I.yTile,e.level,e.row,t.key.level,t.key.row);T>=0&&T<this.tileCoordRange&&S>=0&&S<this.tileCoordRange&&l.push({symbol:I,xTransformed:T,yTransformed:S})}const _=[],g=20+(t.key.level<e.level?1:1<<t.key.level-e.level),w=this._tiles.get(t.id).symbols.get(n);if(w){const I=w.flat;for(const T of l){let S,B=!1;const k=T.xTransformed,Y=T.yTransformed;S=null!=w.index?w.index.getCell(k,Y):I;const N=T.symbol,Z=N.hash;for(const tt of S)if(Z===tt.hash&&Math.abs(k-tt.xTile)<=g&&Math.abs(Y-tt.yTile)<=g){const ht=tt.unique;N.unique=ht,ht.tileSymbols.push(N),B=!0;break}B||_.push(N)}}_.length>0&&i.set(n,_)}for(const n of t.childrenTiles)this._matchSymbols(n,e,i)}_createUniqueSymbolLayerArray(){const t=this._uniqueSymbolsReferences,e=new Array(t.size);let s,i=0;for(const[n,a]of t){const l=new Array(a.size);s=0;for(const _ of a)l[s++]=_;e[i]={styleLayerUID:n,uniqueSymbols:l},i++}return e}}class be{constructor(t,e){this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=(0,ce.v)(!1),this._symbolRepository=new we(4096,e,()=>new ee),this._symbolDeclutterer=new ye(e,this._symbolRepository,(s,i,n)=>this._createCollisionJob(s,i,n),(s,i)=>{s.allSymbolsFadingOut=!0,s.lastOpacityUpdate=i,function ie(h,t,e){for(const[s,i]of h.symbols)re(h,t,e,i,s)}(s,i,!0),s.decluttered=!0,s.requestRender()},(s,i)=>this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z,s=>{const i=this.styleRepository.getStyleLayerByUID(s);if(this._zoom+1e-6<i.minzoom||this._zoom-1e-6>=i.maxzoom)return!1;const n=i.getLayoutProperty("visibility");return!n||n.getValue()!==at.bv.NONE})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(t,e,s){return this.updateDecluttererViewState(),new _e(t,e,s,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",()=>{this._symbolRepository.add(t),this.restartDeclutter()})),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const e=this._tileToHandle.get(t);e&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),e.remove(),this._tileToHandle.delete(t))}update(t,e){this._zoom=t,this._viewState={scale:e.scale,rotation:e.rotation,center:[e.center[0],e.center[1]],size:[e.size[0],e.size[1]]};const s=[0,0];e.toScreen(s,e.center);const i=[0,0];return e.toScreen(i,this._declutterViewState.center),this._offsetFromScreenCenter[0]=s[0]-i[0],this._offsetFromScreenCenter[1]=s[1]-i[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(t=>t.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(vt.av),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},1.5*vt.zk)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}var It=b(69473);class ve extends kt.Y{_createTransforms(){return{displayViewScreenMat3:(0,yt.vt)(),tileMat3:(0,yt.vt)()}}}var Me=b(37188);const At=1e-6;function Ht(h,t){if(h){const e=h.getLayoutProperty("visibility");if(!e||e.getValue()!==at.bv.NONE&&(void 0===h.minzoom||h.minzoom<t+At)&&(void 0===h.maxzoom||h.maxzoom>=t-At))return!0}return!1}class Te extends Me.A{constructor(t){super(t),this._backgroundTiles=[],this._computeDisplayInfoView(t)}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(t,e,s,i){this._spriteMosaic=t,this._glyphMosaic=e,this._styleRepository=s,this.tileInfoView=i,this._computeDisplayInfoView(i),null==this._symbolFader&&(this._symbolFader=new be(this._styleRepository,this.children)),this._symbolFader.styleRepository=s}setSpriteMosaic(t){this._spriteMosaic?.dispose(),this._spriteMosaic=t}deleteStyleLayers(t){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(t)}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==It.S5.MAP&&t.drawPhase!==It.S5.DEBUG||void 0===this._spriteMosaic||super.doRender(t)}addChild(t){return super.addChild(t),null!=this._symbolFader?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return null!=this._symbolFader&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:e}=t;e!==It.S5.DEBUG?this._doRender(t):super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const e=this.children[t];null!=this._symbolFader&&this._symbolFader.removeTile(e),e.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(t=>t.neededForCoverage&&t.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:e,state:s}=t,i=this._styleRepository;if(!i)return;const n=i.layers,a=this._displayInfo.scaleToZoom(s.scale);i.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,i.backgroundBucketIds,a)),super.renderChildren(t),t.drawPhase===It.S5.MAP&&this._fade(a,s);const l=this.children.filter(_=>_.visible&&_.hasData());if(!l||0===l.length)return e.bindVAO(),e.setStencilTestEnabled(!0),void e.setBlendingEnabled(!0);for(const _ of l)_.triangleCount=0;e.setStencilWriteMask(0),e.setColorMask(!0,!0,!0,!0),e.setStencilOp(E.eA.KEEP,E.eA.KEEP,E.eA.REPLACE),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(!0),e.setDepthFunction(E.MT.LEQUAL),e.setClearDepth(1),e.clear(e.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let _=n.length-1;_>=0;_--)this._renderStyleLayer(n[_],t,l);e.setDepthWriteEnabled(!1),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(E.dn.ONE,E.dn.ONE_MINUS_SRC_ALPHA,E.dn.ONE,E.dn.ONE_MINUS_SRC_ALPHA),t.renderPass="translucent";for(let _=0;_<n.length;_++)this._renderStyleLayer(n[_],t,l);e.bindVAO(),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!0);for(const _ of l)_.debugInfo.display.triangleCount=_.triangleCount}_fade(t,e){null!=this._symbolFader&&(this._symbolFader.update(t,e)||this.requestRender())}_renderStyleLayer(t,e,s){const{displayLevel:i,painter:n,renderPass:a}=e;if(void 0===t)return;const l=t.getLayoutProperty("visibility");if(l&&l.getValue()===at.bv.NONE)return;let _;switch(t.type){case at.Dc.BACKGROUND:return;case at.Dc.FILL:if("opaque"!==a&&"translucent"!==e.renderPass)return;_="vtlFill";break;case at.Dc.LINE:if("translucent"!==a)return;_="vtlLine";break;case at.Dc.CIRCLE:if("translucent"!==a)return;_="vtlCircle";break;case at.Dc.SYMBOL:if("translucent"!==a)return;_="vtlSymbol"}if(s=s.filter(t.type===at.Dc.SYMBOL?w=>w.decluttered:w=>w.neededForCoverage),"vtlSymbol"!==_&&(0===s.length||void 0!==t.minzoom&&t.minzoom>=i+At||void 0!==t.maxzoom&&t.maxzoom<i-At))return;const g=t.uid;e.styleLayerUID=g,e.styleLayer=t;for(const w of s)if(w.layerData.has(g)){n.renderObjects(e,s,_);break}}_renderBackgroundLayers(t,e,s){const{context:i,painter:n,state:a}=t,l=this._styleRepository;let _=!1;for(const tt of e)if(l.getLayerById(tt).type===at.Dc.BACKGROUND&&Ht(l.getLayerById(tt),s)){_=!0;break}if(!_)return;const g=this.tileInfoView,w=g.getTileCoverage(t.state,0,!0,"smallest"),{spans:I,lodInfo:T}=w,{level:S}=T,B=(0,o.vt)(),k=[];if(this._renderPasses){const tt=this._renderPasses[0];null!=this._clippingInfos&&(tt.brushes[0].prepareState(t),tt.brushes[0].drawMany(t,this._clippingInfos))}const Y=this._backgroundTiles;let N,Z=0;for(const{row:tt,colFrom:ht,colTo:gt}of I)for(let lt=ht;lt<=gt;lt++){if(Z<Y.length)N=Y[Z],N.key.set(S,tt,T.normalizeCol(lt),T.getWorldForColumn(lt)),g.getTileBounds(B,N.key,!1),N.x=B[0],N.y=B[3],N.resolution=g.getTileResolution(S);else{const ut=new y.A(S,tt,T.normalizeCol(lt),T.getWorldForColumn(lt)),wt=g.getTileBounds((0,o.vt)(),ut),Rt=g.getTileResolution(S);N=new ve(ut,Rt,wt[0],wt[3],512,512,4096,4096),Y.push(N)}N.setTransform(a),k.push(N),Z++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(E.eA.KEEP,E.eA.KEEP,E.eA.REPLACE),i.setStencilFunction(E.MT.EQUAL,0,255),i.setStencilTestEnabled(!0);for(const tt of e){const ht=l.getLayerById(tt);ht.type===at.Dc.BACKGROUND&&Ht(ht,s)&&(t.styleLayerUID=ht.uid,t.styleLayer=ht,n.renderObjects(t,k,"vtlBackground"))}z.A.pool.release(w)}_computeDisplayInfoView(t){let e=t.tileInfo.lods[0].scale;const s=Math.max(25,t.tileInfo.lods.length),i=[];for(let n=0;n<=s;n++)i.push(e),e/=2;this._displayInfo=Vt.A.create({scales:i,size:512,spatialReference:t.spatialReference,numLODs:s})}}var Nt=b(81098),Ie=b(60797),Ae=b(3567),Wt=b(20788),Yt=b(97944),Ce=b(53220);const Pe=(h,t)=>{const e=h.vtlSymbol.sourceTile,s=t.vtlSymbol.sourceTile;return e.level!==s.level?e.level-s.level:e.row!==s.row?e.row-s.row:e.col!==s.col?e.col-s.col:h.styleLayerUID-t.styleLayerUID};class Lt{constructor(t,e,s,i,n){this.tileKey=t,this._tileLayerData=e,this._styleRepository=s,this._tileHandler=i,this._parentLayer=n,this._index=null,this._tileKeyToPBF=new Map}static create(t,e,s,i,n){return new Lt(t,e,s,i,n)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}queryAttributes(t,e,s,i,n){var a=this;return(0,K.A)(function*(){if(0===a._tileLayerData.size||!a._styleRepository||!a._tileHandler)return[];null===a._index&&(a._index=new Ae.w(100,Le),yield a._indexLayers());const l=[];return a._queryIndex(l,t,e,s,a.tileKey.level,i),n&&n?.length>0&&(yield a._getSymbolsAttributes(l,n)),l})()}_indexLayers(){var t=this;return(0,K.A)(function*(){const e=t.tileKey,s=t._styleRepository.layers,i=yield t._getTilePayload(e);for(const[n,a]of t._tileLayerData){const l=s[n],_=i.find(I=>I.sourceName===l.source);if(!_)continue;const{protobuff:g,key:w}=_;if(a.type!==m.NP.SYMBOL){const I=1<<e.level-w.level;t._indexLayer(l,g,e.level,I,e.row-w.row*I,e.col-w.col*I)}}})()}_indexLayer(t,e,s,i,n,a){const l=t.sourceLayer,_=t.getFeatureFilter(),g=s,w=s+1,I=(0,zt.IU)(g),T=new U.A(new Uint8Array(e),new DataView(e));for(;T.next();)switch(T.tag()){case 3:{const S=T.getMessage(),B=new Yt.A(S);if(S.release(),B.name!==l)continue;const k=B.getData(),Y=B.extent/i,N=Y*a-I,Z=Y*n-I,tt=N+Y+2*I,ht=Z+Y+2*I,gt=Y/512,lt=4096/Y,ut=Y*a,wt=Y*n;for(;k.nextTag(2);){const Rt=k.getMessage(),Dt=new Wt.A(Rt,B);if(Rt.release(),_&&!_.filter(Dt,s))continue;const Jt=Dt.values||{},$t=Jt._minzoom,Zt=Jt._maxzoom;if($t&&$t>=10*w||Zt&&Zt<=10*g)continue;const pt=t.getFeatureInflatedBounds(Dt,g,B.extent,gt);null==pt||pt[0]>tt||pt[1]>ht||pt[2]<N||pt[3]<Z||(pt[0]=(pt[0]-ut)*lt,pt[1]=(pt[1]-wt)*lt,pt[2]=(pt[2]-ut)*lt,pt[3]=(pt[3]-wt)*lt,this._index.insert(new Ce.e4(t,Dt,pt,lt,ut,wt)))}break}default:T.skip()}}_getSymbolsAttributes(t,e){var s=this;return(0,K.A)(function*(){if(!e||0===e.length)return t;const i=[];e.sort(Pe);let n=e[0].styleLayerUID,a=0;for(let _=0;_<e.length;_++)n!==e[_].styleLayerUID&&(i.push({from:a,to:_,styleLayerUID:n,sourceTileKey:e[_].vtlSymbol.sourceTile}),a=_,n=e[_].styleLayerUID);i.push({from:a,to:e.length,styleLayerUID:n,sourceTileKey:e[e.length-1].vtlSymbol.sourceTile});const l=s._styleRepository.layers;for(const _ of i){const g=yield s._getTilePayload(_.sourceTileKey),w=l[_.styleLayerUID],I=!!w&&g.find(T=>T.sourceName===w.source);I&&s._addSymbolsAttributes(t,e.slice(_.from,_.to).map(T=>T.vtlSymbol),n,I)}return t})()}_addSymbolsAttributes(t,e,s,i){const n=this._styleRepository.layers,a=i.key,l=this.tileKey,_=1<<l.level-a.level;this._getSymbolAttributes(i.protobuff,e,s,_,l.row-a.row*_,l.col-a.col*_).forEach(I=>{const{attributes:T,tilePoint:S}=I;t.push({layerId:n[s].id,layerIndex:s,graphic:new Nt.A({attributes:T,origin:{type:"vector-tile",layerId:n[s].id,layerIndex:s,layer:this._parentLayer}}),tilePoint:S})})}_getSymbolAttributes(t,e,s,i,n,a){const l=[],_=this._styleRepository.layers;let g=0;e.sort((I,T)=>I.featureIndex-T.featureIndex);const w=new U.A(new Uint8Array(t),new DataView(t));for(;w.next();)switch(w.tag()){case 3:{const I=w.getMessage(),T=new Yt.A(I);if(I.release(),T.name!==_[s].sourceLayer)continue;const S=T.getData(),B=T.extent/i,k=4096/B,Y=B*a,N=B*n;let Z=0;for(;S.nextTag(2);){const tt=S.getMessage();if(Z++===e[g].featureIndex){const ht=new Wt.A(tt,T),gt=ht.values,lt=ht.getGeometry();l.push({attributes:gt,tilePoint:null!=lt?[k*(lt[0][0].x-Y),k*(lt[0][0].y-N)]:null}),g++}if(tt.release(),g===e.length)return l}break}default:w.skip()}return l}_queryIndex(t,e,s,i,n,a){const l=8*i*(window.devicePixelRatio||1);return this._index?.search({minX:e-l,minY:s-l,maxX:e+l,maxY:s+l},_=>{const{layer:g,feature:w}=_;g.isIntersectingFeature(e,s,i,w,n,a,_)&&t.push({layerId:g.id,layerIndex:g.uid,tilePoint:null,graphic:new Nt.A({attributes:w.values,origin:{type:"vector-tile",layerId:_.layer.id,layerIndex:_.layer.uid,layer:this._parentLayer}})})}),t}_getTilePayload(t){var e=this;return(0,K.A)(function*(){return(0,Ie.tE)(e._tileKeyToPBF,t.id,()=>e._tileHandler.fetchTilePBFs(t)).then(s=>s)})()}}const Le=h=>({minX:h.bounds[0],minY:h.bounds[1],maxX:h.bounds[2],maxY:h.bounds[3]});var jt=b(6517),Ee=b(88219);class Qt extends xt.A{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const e=y.A.pool.acquire(t),s=0===e.level?null:y.A.getId(e.level-1,e.row>>1,e.col>>1,e.world);return y.A.pool.release(e),s}getTileCoverage(t,e,s=!0,i){const n=super.getTileCoverage(t,e,s,i);if(!n)return n;const a=1<<n.lodInfo.level;return n.spans=n.spans.filter(l=>l.row>=0&&l.row<a),n}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const e=this._fullCacheLodInfos;if(t>e[0].scale)return e[0].level;let s,i;for(let n=0;n<e.length-1;n++)if(i=e[n+1],t>i.scale)return s=e[n],s.level+(s.scale-t)/(s.scale-i.scale);return e[e.length-1].level}}_initializeFullCacheLODs(t){let e;e=0===t[0].level?t.map(s=>({level:s.level,resolution:s.resolution,scale:s.scale})):Vt.A.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map(n=>({level:n.level,resolution:n.resolution,scale:n.scale}));for(let s=0;s<e.length;s++)this._levelByScale[e[s].scale]=e[s].level;this._fullCacheLodInfos=e}}var Oe=b(41474),ze=b(96081),qt=b(34150);let Ct=class extends((0,ze.A)((0,Ee.e)(Oe.A))){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._styeChanged=!1,this._spriteSourceChanged=!1}get fading(){return this._vectorTileContainer?.fading??!1}get hasVisibleFeatures(){const h=this._vectorTileContainer.children;for(const t of h)if(t.hasFeatures())return!0;return!1}get spriteSourceChanged(){return this._spriteSourceChanged}get styleChanged(){return this._styeChanged}hitTest(h,t){var e=this;return(0,K.A)(function*(){const s=e._tileHandlerPromise,i=e._vectorTileContainer?.symbolFader;if(!s||!e._isTileHandlerReady||!i)return;yield s;let n=null;const a=e._vectorTileContainer?.symbolRepository;a&&(n=a.querySymbols(t,2,i.decluttererOffset,{}));const _=e._tileManager.getIntersectingTiles(t.x,t.y,2,e.view.state,n);if((!_||0===_.length)&&0===n?.length)return null;h=h.clone().normalize();const g=[],w=[];for(const I of _)g.push(e._queryTile(w,h,2,e.view.state.rotation,I,n?.filter(T=>T.tileKey.id===I.id)));return yield Promise.all(g),w})()}update(h){if(this._tileHandlerPromise&&this._isTileHandlerReady)return h.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=h.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._pauseQueues(),this._fetchQueue.state=h.state,this._parseQueue.state=h.state,this._tileManager.update(h)||this.requestUpdate(),this._resumeQueues()))}attach(){const{style:h}=this.layer.currentStyleInfo;this._styleRepository=new jt.A(h),this._tileInfoView=new Qt(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Te(this._tileInfoView),this._tileHandler=new f(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",t=>{if(this._styeChanged=!0,t.isDataDriven)this._styleChanges.push({type:m.$q.PAINTER_CHANGED,data:t}),this.requestUpdate();else{const e=this._styleRepository,s=e.getLayerById(t.layer);if(!s)return;const i=s.type===at.Dc.SYMBOL;e.setPaintProperties(t.layer,t.paint),i&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on("layout-change",t=>{const e=this._styleRepository,s=e.getLayerById(t.layer);if(!s)return;this._styeChanged=!0;const i=(0,c.Ui)(s.layout,t.layout);if(null!=i){if((0,c.EB)(i,"visibility")&&1===function Ue(h){if(null==h)return 0;switch(h.type){case"partial":return Object.keys(h.diff).length;case"complete":return Math.max(Object.keys(h.oldValue).length,Object.keys(h.newValue).length);case"collection":return Object.keys(h.added).length+Object.keys(h.changed).length+Object.keys(h.removed).length}}(i))return e.setLayoutProperties(t.layer,t.layout),s.type===at.Dc.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:m.$q.LAYOUT_CHANGED,data:t}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",t=>{const e=this._styleRepository,s=e.getLayerById(t.layer);s&&(this._styeChanged=!0,e.setStyleLayerVisibility(t.layer,t.visibility),s.type===at.Dc.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on("style-layer-change",t=>{this._styleChanges.push({type:m.$q.LAYER_CHANGED,data:t}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on("delete-style-layer",t=>{this._styleChanges.push({type:m.$q.LAYER_REMOVED,data:t}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",t=>{this._spriteSourceChanged=!0,this._styleChanges.push({type:m.$q.SPRITES_CHANGED,data:t});const e=this._styleRepository.layers;for(const s of e)switch(s.type){case at.Dc.SYMBOL:s.getLayoutProperty("icon-image")&&this._styleChanges.push({type:m.$q.LAYOUT_CHANGED,data:{layer:s.id,layout:s.layout}});break;case at.Dc.LINE:s.getPaintProperty("line-pattern")&&this._styleChanges.push({type:m.$q.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}});break;case at.Dc.FILL:s.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:m.$q.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,$.pR)(this._vectorTileContainer),this._tileHandler=(0,$.pR)(this._tileHandler)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(h){return(0,d.aI)(this.layer.tileInfo?.spatialReference,h)}canResume(){let h=super.canResume();const{currentStyleInfo:t}=this.layer;if(h&&t?.layerDefinition){const e=this.view.scale,{minScale:s,maxScale:i}=t.layerDefinition;t?.layerDefinition&&(s&&s<e&&(h=!1),i&&i>e&&(h=!1))}return h}isUpdating(){return this.fading}acquireTile(h){const t=this._createVectorTile(h);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(e=>this._parseQueue.push({key:t.key,data:e})).then(e=>{t.once("attach",()=>this.requestUpdate()),t.setData(e),this.requestUpdate()}).catch(e=>{(0,st.zf)(e)||O.A.getLogger(this).error(e)})),t}releaseTile(h){const t=h.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}doRefresh(){var h=this;return(0,K.A)(function*(){if(!h.attached)return;if(h.suspended)return h._tileManager.clear(),void h.requestUpdate();h._isTileHandlerReady=!1,h._pauseQueues(),h._clearQueues(),h._tileManager.clearCache(),h._resumeQueues();const t=h._vectorTileContainer.children,e=[];try{for(const s of t){const i=h._updatingHandles.addPromise(h._fetchQueue.push(s.key).then(n=>h._parseQueue.push({key:s.key,data:n})).then(n=>s.setData(n)).finally(()=>s.featureIndex=null));e.push(i)}yield Promise.all(e)}catch(s){O.A.getLogger(h).error("error refreshing vector-tiles layer-view",s),h._resumeQueues(),h._isTileHandlerReady=!0}h._isTileHandlerReady=!0,h.requestUpdate()})()}_start(){if(this._stop(),this._tileManager=new et({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const h=new AbortController,t=this._tileHandler.start({signal:h.signal}).then(()=>{this._fetchQueue=new Ot.A({tileInfoView:this._tileInfoView,process:(e,s)=>this._getTileData(e,s),concurrency:15,scheduler:this.scheduler,priority:qt.W6.MAPVIEW_FETCH_QUEUE}),this._parseQueue=new Ot.A({tileInfoView:this._tileInfoView,process:(e,s)=>this._parseTileData(e,s),concurrency:8,scheduler:this.scheduler,priority:qt.W6.MAPVIEW_VECTOR_TILE_PARSING_QUEUE}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=h,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const h=this._tileHandlerAbortController;h&&h.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,$.pR)(this._fetchQueue),this._parseQueue=(0,$.pR)(this._parseQueue),this._tileManager=(0,$.pR)(this._tileManager),this._vectorTileContainer.removeAllChildren()}_getTileData(h,t){var e=this;return(0,K.A)(function*(){return e._tileHandler.fetchTileData(h,t)})()}_parseTileData(h,t){var e=this;return(0,K.A)(function*(){return e._tileHandler.parseTileData(h,t)})()}_applyStyleChanges(){var h=this;return(0,K.A)(function*(){h._isTileHandlerReady=!1,h._pauseQueues(),h._clearQueues(),h._tileManager.clearCache();const t=h._styleChanges;try{yield h._tileHandler.updateStyle(t)}catch(a){O.A.getLogger(h).error("error applying vector-tiles style update",a.message),h._resumeQueues(),h._isTileHandlerReady=!0}const e=h._styleRepository,s=new Set;t.forEach(a=>{if(a.type!==m.$q.LAYER_REMOVED)return;const _=e.getLayerById(a.data.layer);_&&s.add(_.uid)});const i=new Set;t.forEach(a=>{let l;switch(a.type){case m.$q.PAINTER_CHANGED:e.setPaintProperties(a.data.layer,a.data.paint),l=a.data.layer;break;case m.$q.LAYOUT_CHANGED:e.setLayoutProperties(a.data.layer,a.data.layout),l=a.data.layer;break;case m.$q.LAYER_REMOVED:return void e.deleteStyleLayer(a.data.layer);case m.$q.LAYER_CHANGED:e.setStyleLayer(a.data.layer,a.data.index),l=a.data.layer.id;break;case m.$q.SPRITES_CHANGED:h._vectorTileContainer.setSpriteMosaic(h._tileHandler.setSpriteSource(a.data.spriteSource))}if(l){const _=e.getLayerById(l);_&&i.add(_.uid)}});const n=h._vectorTileContainer.children;if(s.size>0){const a=Array.from(s);h._vectorTileContainer.deleteStyleLayers(a);for(const l of n)l.deleteLayerData(a)}if(h._resumeQueues(),i.size>0){const a=Array.from(i),l=[];for(const _ of n){const g=h._updatingHandles.addPromise(h._fetchQueue.push(_.key).then(w=>h._parseQueue.push({key:_.key,data:w,styleLayerUIDs:a})).then(w=>_.setData(w)).finally(()=>_.featureIndex=null));l.push(g)}yield Promise.all(l)}h._styleChanges=[],h._isTileHandlerReady=!0,h.requestUpdate()})()}_loadStyle(){var h=this;return(0,K.A)(function*(){const{style:t}=h.layer.currentStyleInfo,e=(0,Q.o8)(t);h._isTileHandlerReady=!1,h._pauseQueues(),h._clearQueues(),h._styleRepository=new jt.A(e),h._vectorTileContainer.destroy(),h._tileManager.clear(),h._tileHandlerAbortController.abort(),h._tileHandlerAbortController=new AbortController;const{signal:s}=h._tileHandlerAbortController;try{h._tileHandlerPromise=h._tileHandler.setStyle(h._styleRepository,e,h.layer.tileInfo.lods.length-1),yield h._tileHandlerPromise}catch(a){if(!(0,st.zf)(a))throw a}if(s.aborted)return h._resumeQueues(),h._isTileHandlerReady=!0,h._styeChanged=!1,h._spriteSourceChanged=!1,void h.requestUpdate();const i=yield h._tileHandler.spriteMosaic,n=h._vectorTileContainer;h._tileInfoView=new Qt(h.layer.tileInfo,h.layer.fullExtent),n.setStyleResources(i,h._tileHandler.glyphMosaic,h._styleRepository,h._tileInfoView),h._tileManager=new et({acquireTile:a=>h.acquireTile(a),releaseTile:a=>h.releaseTile(a),tileInfoView:h._tileInfoView},h._vectorTileContainer),h._resumeQueues(),h._isTileHandlerReady=!0,h.requestUpdate(),h._styeChanged=!1,h._spriteSourceChanged=!1})()}_createVectorTile(h){const t=this._tileInfoView.getTileBounds((0,o.vt)(),h),e=this._tileInfoView.getTileResolution(h.level);return new Pt(h,e,t[0],t[3],512,512,this._styleRepository)}_queryTile(h,t,e,s,i,n){var a=this;return(0,K.A)(function*(){if(0===i.layerData.size)return;const l=a._ensureTileIndex(i),_=a._tileInfoView.getTileBounds((0,o.vt)(),i.key,!0),g=(t.x-_[0])/(_[2]-_[0])*4096,w=4096*(1-(t.y-_[1])/(_[3]-_[1])),I=yield l.queryAttributes(g,w,e,s,n);for(const T of I)T.graphic.geometry=a._tileToMapPoint(T.tilePoint,i.transforms.tileUnitsToPixels),h.push({type:"graphic",layer:a.layer,graphic:T.graphic,mapPoint:t.clone()});h.sort((T,S)=>S.graphic.origin.layerIndex-T.graphic.origin.layerIndex)})()}_tileToMapPoint(h,t){if(!h)return null;const i=this.view.state,n=[0,0];return i.toMap(n,[h[0]*t[0]+h[1]*t[3]+t[6],h[0]*t[1]+h[1]*t[4]+t[7]]),new r.A({x:n[0],y:n[1],spatialReference:i.spatialReference})}_ensureTileIndex(h){let t=h.featureIndex;return t||(t=Lt.create(h.key,h.layerData,this._styleRepository,this._tileHandler,this.layer),h.featureIndex=t),t}_pauseQueues(){this._fetchQueue.pause(),this._parseQueue.pause()}_resumeQueues(){this._fetchQueue.resume(),this._parseQueue.resume()}_clearQueues(){this._fetchQueue.clear(),this._parseQueue.clear()}};(0,j._)([(0,ct.MZ)()],Ct.prototype,"_isTileHandlerReady",void 0),Ct=(0,j._)([(0,H.$)("esri.views.2d.layers.VectorTileLayerView2D")],Ct);const Be=Ct},96081:(mt,ot,b)=>{b.d(ot,{A:()=>H});var K=b(8189),j=b(35150),Q=b(56492),O=b(48900),G=(b(3248),b(40707),b(5922),b(76576));const H=c=>{let r=class extends c{initialize(){this.addHandles((0,O.on)(()=>this.layer,"refresh",o=>{this.doRefresh(o.dataChanged).catch(d=>{(0,Q.zf)(d)||j.A.getLogger(this).error(d)})}),"RefreshableLayerView")}};return r=(0,K._)([(0,G.$)("esri.views.layers.RefreshableLayerView")],r),r}}}]);