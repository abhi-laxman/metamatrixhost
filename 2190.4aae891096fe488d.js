"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[2190],{69809:(T,A,i)=>{i.r(A),i.d(A,{createConnection:()=>o});var g=i(10467),m=i(8189),v=i(89563),f=i(5922),u=i(35150),S=i(56492),F=i(45272),R=(i(3248),i(40707),i(76576)),k=i(32034),W=i(61320),w=i(85211),P=i(23743),I=i(42425);let x=class extends I.A.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new f.A("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,m._)([(0,w.MZ)({readOnly:!0})],x.prototype,"connectionError",null),x=(0,m._)([(0,R.$)("esri.layers.support.StreamConnection")],x);const M=x;var O,e;(e=O||(O={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let C=class extends M{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:n,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,P.N)(t,r,n),this._open()}normalizeCtorArgs(){return{}}_open(){var e=this;return(0,g.A)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case O.CONNECTING:case O.OPEN:return"connected";case O.CLOSING:case O.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}_tryCreateWebSocket(e=this._config.source.path,t=1e3,n=0){var r=this;return(0,g.A)(function*(){try{if(r.destroyed)return;const c=(0,F.a6)(e,r._config.customParameters??{});r._websocket=yield r._createWebSocket(c),r.notifyChange("connectionStatus")}catch(c){const l=t/1e3;return r._config.maxReconnectionAttempts&&n>=r._config.maxReconnectionAttempts?(u.A.getLogger(r).error(new f.A("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void r.destroy()):(u.A.getLogger(r).error(new f.A("websocket-connection",`Failed to connect. Attempting to reconnect in ${l}s`,c)),yield(0,S.Pl)(t),r._tryCreateWebSocket(e,Math.min(1.5*t,1e3*r._config.maxReconnectionInterval),n+1))}})()}_setWebSocketJSONParseHandler(e){e.onmessage=t=>{try{const n=JSON.parse(t.data);this._onMessage(n)}catch(n){return void u.A.getLogger(this).error(new f.A("websocket-connection","Failed to parse message, invalid JSON",{error:n}))}}}_createWebSocket(e){return new Promise((t,n)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=c=>this._onClose(c),r.onerror=c=>this._onError(c),this._setWebSocketJSONParseHandler(r),t(r)},r.onclose=c=>{r.onopen=r.onclose=null,n(c)}})}_handshake(e=1e4){var t=this;return(0,g.A)(function*(){const n=t._websocket;if(null==n)return;const r=(0,S.Tw)(),c=n.onmessage,{filter:l,outFields:y,spatialReference:E}=t._config;return r.timeout(e),n.onmessage=_=>{let p=null;try{p=JSON.parse(_.data)}catch{}p&&"object"==typeof p||(u.A.getLogger(t).error(new f.A("websocket-connection","Protocol violation. Handshake failed - malformed message",_.data)),r.reject(),t.destroy()),p.spatialReference?.wkid!==E?.wkid&&(u.A.getLogger(t).error(new f.A("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${E.wkid}`,_.data)),r.reject(),t.destroy()),"json"!==p.format&&(u.A.getLogger(t).error(new f.A("websocket-connection","Protocol violation. Handshake failed - format is not set",_.data)),r.reject(),t.destroy()),l&&p.filter!==l&&u.A.getLogger(t).error(new f.A("websocket-connection","Tried to set filter, but server doesn't support it")),y&&p.outFields!==y&&u.A.getLogger(t).error(new f.A("websocket-connection","Tried to set outFields, but server doesn't support it")),n.onmessage=c;for(const h of t._outstandingMessages)n.send(JSON.stringify(h));t._outstandingMessages=[],r.resolve()},n.send(JSON.stringify({filter:l,outFields:y,format:"json",spatialReference:{wkid:E.wkid}})),r.promise})()}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),u.A.getLogger(this).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&u.A.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,m._)([(0,w.MZ)()],C.prototype,"connectionStatus",null),(0,m._)([(0,w.MZ)()],C.prototype,"errorString",void 0),C=(0,m._)([(0,R.$)("esri.layers.graphics.sources.connections.WebSocketConnection")],C);var D=i(1277),j=i(87086);const N={maxQueryDepth:5,maxRecordCountFactor:3};let L=class extends C{constructor(e){super({...N,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}_open(){var e=this;return(0,g.A)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||u.A.getLogger(e).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const n=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(n);const{filter:r,outFields:c}=e._config;e.destroyed||e._setFilter(r,c)})()}_onMessage(e){if("attributes"in e){let t;try{t=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(t.geometry)}catch(n){return void u.A.getLogger(this).error(new f.A("geoevent-connection","Failed to parse message",n))}this.onFeature(t)}else this.onMessage(e)}_fetchServiceDefinition(e){var t=this;return(0,g.A)(function*(){const n={f:"json",...t._config.customParameters},r=(0,v.A)(e.path,{query:n,responseType:"json"}),c=(yield r).data;return t._serviceDefinition=c,c})()}_fetchWebSocketUrl(e,t){const n=e[0],{urls:r,token:c}=n,l=this._inferWebSocketBaseUrl(r);return(0,F.a6)(`${l}/subscribe`,{outSR:""+t.wkid,token:c})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return u.A.getLogger(this).error(new f.A("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var n=this;return(0,g.A)(function*(){const r=n._websocket;if(null==r||null==e&&null==t)return;const c=JSON.stringify({filter:n._serializeFilter(e,t)});let l=!1;const y=(0,S.Tw)();return r.onmessage=p=>{const h=JSON.parse(p.data);h.filter&&(h.error&&(u.A.getLogger(n).error(new f.A("geoevent-connection","Failed to set service filter",h.error)),n._set("errorString",`Could not set service filter - ${h.error}`),y.reject(h.error)),n._setWebSocketJSONParseHandler(r),l=!0,y.resolve())},r.send(c),setTimeout(()=>{l||(n.destroyed||n._websocket!==r||u.A.getLogger(n).error(new f.A("geoevent-connection","Server timed out when setting filter")),y.reject())},1e4),y.promise})()}_serializeFilter(e,t){const n={};if(null==e&&null==t)return n;if(e?.geometry)try{const r=(0,W.rS)(e.geometry);if("extent"!==r.type)throw new f.A(`Expected extent but found type ${r.type}`);n.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){u.A.getLogger(this).error(new f.A("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return e?.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(n.where=e.where),null!=t&&(n.outFields=t.join(",")),n}_enrich(e){if(!this._relatedFeatures)return e;const r=this._relatedFeatures.get(e.attributes[this._serviceDefinition.relatedFeatures.joinField]);if(!r)return u.A.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:c,geometry:l}=r;for(const y in c)e.attributes[y]=c[y];return l&&(e.geometry=l),e.geometry||e.centroid||u.A.getLogger(this).error(new f.A("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,g.A)(function*(){try{const{relatedFeatures:t,keepLatestArchive:n}=e._serviceDefinition,r=e._queryRelatedFeatures(t),c=e._queryArchive(n);yield r;const l=yield c;if(!l)return;for(const y of l.features)e.onFeature(e._enrich(y))}catch(t){u.A.getLogger(e).error(new f.A("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,g.A)(function*(){if(!e)return;const n=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(n)})()}_queryArchive(e){var t=this;return(0,g.A)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,g.A)(function*(){const n=new((yield Promise.all([i.e(9845),i.e(3325),i.e(2253),i.e(3318),i.e(1595),i.e(1196),i.e(9750),i.e(4792),i.e(4057),i.e(680),i.e(5940),i.e(9728)]).then(i.bind(i,35940))).default)({url:e}),{capabilities:r}=yield n.load(),c=r.query.supportsMaxRecordCountFactor,l=r.query.supportsPagination,y=r.query.supportsCentroid,E=t._config.maxRecordCountFactor,_=n.capabilities.query.maxRecordCount,p=c?_*E:_,h=new j.A;if(h.outFields=t._config.outFields??["*"],h.where=t._config.filter?.where??"1=1",h.returnGeometry=!0,h.returnExceededLimitFeatures=!0,h.outSpatialReference=k.A.fromJSON(t._config.spatialReference),y&&(h.returnCentroid=!0),c&&(h.maxRecordCountFactor=E),l)return h.num=p,n.destroy(),t._queryPages(e,h);const B=yield(0,D.eW)(e,h,t._config.sourceSpatialReference);return n.destroy(),B.data})()}_queryPages(e,t,n=[],r=0){var c=this;return(0,g.A)(function*(){t.start=null!=t.num?r*t.num:null;const{data:l}=yield(0,D.eW)(e,t,c._config.sourceSpatialReference);return l.exceededTransferLimit&&r<(c._config.maxQueryDepth??0)?(l.features.forEach(y=>n.push(y)),c._queryPages(e,t,n,r+1)):(n.forEach(y=>l.features.push(y)),l)})()}_addRelatedFeatures(e){const t=new Map,n=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const c of n)t.set(c.attributes[r],c);this._relatedFeatures=t}};L=(0,m._)([(0,R.$)("esri.layers.graphics.sources.connections.GeoEventConnection")],L);const a=L;let s=class extends M{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:n,sourceSpatialReference:r}=e;this._featureZScaler=(0,P.N)(t,r,n)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function d(e,t){if(null==e&&null==t)return null;const n={};return null!=t&&(n.geometry=t),null!=e&&(n.where=e),n}function o(e,t,n,r,c,l,y,E,_){const p={source:e,sourceSpatialReference:t,spatialReference:n,geometryType:r,filter:d(c,l),maxReconnectionAttempts:y,maxReconnectionInterval:E,customParameters:_};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new C(p):new a(p):new s(p)}(0,m._)([(0,w.MZ)()],s.prototype,"connectionStatus",void 0),(0,m._)([(0,w.MZ)()],s.prototype,"errorString",void 0),s=(0,m._)([(0,R.$)("esri.layers.support.ClientSideConnection")],s)},1832:(T,A,i)=>{function g(m){const v={};for(const f in m){if("declaredClass"===f)continue;const u=m[f];if(null!=u&&"function"!=typeof u)if(Array.isArray(u)){v[f]=[];for(let S=0;S<u.length;S++)v[f][S]=g(u[S])}else"object"==typeof u?u.toJSON&&(v[f]=JSON.stringify(u)):v[f]=u}return v}i.d(A,{z:()=>g})},1277:(T,A,i)=>{i.d(A,{IJ:()=>I,Jf:()=>D,Pk:()=>O,eW:()=>w,gW:()=>C,kS:()=>M});var g=i(10467),m=i(89563),v=i(45272),f=i(61320),u=i(77098),S=i(58701),F=i(1832),U=i(78304),J=i(98789);const R="Layer does not support extent calculation.";function W(a,s){const d=a.geometry,o=a.toJSON();delete o.compactGeometryEnabled,delete o.defaultSpatialReferenceEnabled;const e=o;let t,n,r;if(null!=d&&(n=d.spatialReference,r=(0,S.YX)(n),e.geometryType=(0,f.$B)(d),e.geometry=function k(a,s){if(s&&"extent"===a.type)return`${a.xmin},${a.ymin},${a.xmax},${a.ymax}`;if(s&&"point"===a.type)return`${a.x},${a.y}`;const d=a.toJSON();return delete d.spatialReference,JSON.stringify(d)}(d,a.compactGeometryEnabled),e.inSR=r),o.groupByFieldsForStatistics&&(e.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),o.objectIds&&(e.objectIds=o.objectIds.join(",")),o.orderByFields&&(e.orderByFields=o.orderByFields.join(",")),!o.outFields||!o.returnDistinctValues&&(s?.returnCountOnly||s?.returnExtentOnly||s?.returnIdsOnly)?delete e.outFields:e.outFields=o.outFields.includes("*")?"*":o.outFields.join(","),o.outSR?(e.outSR=(0,S.YX)(o.outSR),t=a.outSpatialReference):d&&(o.returnGeometry||o.returnCentroid)&&(e.outSR=e.inSR,t=n),o.returnGeometry&&delete o.returnGeometry,o.outStatistics&&(e.outStatistics=JSON.stringify(o.outStatistics)),o.fullText&&(e.fullText=JSON.stringify(o.fullText)),o.pixelSize&&(e.pixelSize=JSON.stringify(o.pixelSize)),o.quantizationParameters&&(a.defaultSpatialReferenceEnabled&&null!=n&&null!=a.quantizationParameters?.extent&&n.equals(a.quantizationParameters.extent.spatialReference)&&delete o.quantizationParameters.extent.spatialReference,e.quantizationParameters=JSON.stringify(o.quantizationParameters)),o.parameterValues&&(e.parameterValues=JSON.stringify(o.parameterValues)),o.rangeValues&&(e.rangeValues=JSON.stringify(o.rangeValues)),o.dynamicDataSource&&(e.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o.timeExtent){const c=o.timeExtent,{start:l,end:y}=c;null==l&&null==y||(e.time=l===y?l:`${l??"null"},${y??"null"}`),delete o.timeExtent}return a.defaultSpatialReferenceEnabled&&null!=n&&null!=t&&n.equals(t)&&(e.defaultSR=e.inSR,delete e.inSR,delete e.outSR),e}function w(a,s,d,o){return P.apply(this,arguments)}function P(){return(P=(0,g.A)(function*(a,s,d,o){const e=null!=s.timeExtent&&s.timeExtent.isEmpty?{data:{features:[]}}:yield b(a,s,"json",o);return(0,J.q)(s,d,e.data),e})).apply(this,arguments)}function I(a,s,d,o){return x.apply(this,arguments)}function x(){return(x=(0,g.A)(function*(a,s,d,o){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:d.createFeatureResult()};const e=yield M(a,s,o),t=e;return t.data=(0,U.m)(e.data,d),t})).apply(this,arguments)}function M(a,s,d){return b(a,s,"pbf",d)}function O(a,s,d){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):b(a,s,"json",d,{returnIdsOnly:!0})}function C(a,s,d){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):b(a,s,"json",d,{returnIdsOnly:!0,returnCountOnly:!0})}function D(a,s,d){return j.apply(this,arguments)}function j(){return(j=(0,g.A)(function*(a,s,d){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:{count:0,extent:null}};const o=yield b(a,s,"json",d,{returnExtentOnly:!0,returnCountOnly:!0}),e=o.data;if(e.hasOwnProperty("extent"))return o;if(e.features)throw new Error(R);if(e.hasOwnProperty("count"))throw new Error(R);return o})).apply(this,arguments)}function b(a,s,d){return N.apply(this,arguments)}function N(){return(N=(0,g.A)(function*(a,s,d,o={},e={}){const t="string"==typeof a?(0,v.An)(a):a,n=s.geometry?[s.geometry]:[],r=yield(0,u.el)(n,null,{signal:o.signal}),c=r?.[0];null!=c&&((s=s.clone()).geometry=c);const l=(0,F.z)({...t.query,f:d,...e,...W(s,e)});return(0,m.A)((0,v.fj)(t.path,function L(a,s){return null!=a.formatOf3DObjects&&!(s.returnCountOnly||s.returnExtentOnly||s.returnIdsOnly)}(s,e)?"query3d":"query"),{...o,responseType:"pbf"===d?"array-buffer":"json",query:{...l,...o.query}})})).apply(this,arguments)}},98789:(T,A,i)=>{i.d(A,{q:()=>m});var g=i(23743);function m(v,f,u){if(!u?.features||!u.hasZ)return;const S=(0,g.N)(u.geometryType,f,v.outSpatialReference);if(null!=S)for(const F of u.features)S(F.geometry)}}}]);