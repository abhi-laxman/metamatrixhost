"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[4909],{91725:(_e,ee,_)=>{_.d(ee,{L:()=>D,b:()=>B});var T=_(83953),b=_(45475),M=_(89141),I=_(29359),F=_(66978),E=_(49132),Z=_(10064),N=_(61646),de=_(30475),te=_(94804),ae=_(99286),ie=_(21130),J=_(18356),Y=_(65840),w=_(24493),W=_(40972),z=_(43713);function B(U){const P=new z.N5,{vertex:A,fragment:G}=P,{terrainDepthTest:R}=U;return A.include(F.K),P.include(E.Q,U),P.vertex.include(I.rA,U),P.attributes.add(W.r.UV0,"vec2"),A.uniforms.add(new ie.I("viewport",H=>H.camera.fullViewport),new Y.m("lineSize",(H,se)=>H.size>0?Math.max(1,H.size)*se.camera.pixelRatio:0),new te.E("pixelToNDC",H=>(0,T.hZ)(C,2/H.camera.fullViewport[2],2/H.camera.fullViewport[3])),new Y.m("borderSize",(H,se)=>H.borderColor?se.camera.pixelRatio:0),new ae.G("screenOffset",(H,se)=>(0,T.hZ)(C,H.horizontalScreenOffset*se.camera.pixelRatio,0))),P.varyings.add("coverageSampling","vec4"),P.varyings.add("lineSizes","vec2"),R&&P.varyings.add("depth","float"),U.occlusionTestEnabled&&P.include(Z.y),U.hasScreenSizePerspective&&(0,de.OH)(A),A.main.add(w.H`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${(0,w.If)(U.occlusionTestEnabled,w.H`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${U.hasScreenSizePerspective?w.H`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${(0,w.If)(R,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${(0,w.If)(U.hudDepth,U.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${U.hasScreenSizePerspective?w.H`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:w.H`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),G.uniforms.add(new J.E("uColor",H=>H.color??M.uY),new J.E("borderColor",H=>H.borderColor??M.uY)),R&&(G.include(N.H,U),G.uniforms.add(new te.E("inverseViewport",H=>H.inverseViewport))),G.main.add(w.H`
    ${(0,w.If)(R,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${(0,w.If)(!U.hudDepth,w.H`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),P}const C=(0,b.vt)(),D=Object.freeze(Object.defineProperty({__proto__:null,build:B},Symbol.toStringTag,{value:"Module"}))},50690:(_e,ee,_)=>{_.d(ee,{T:()=>b});var T=_(42086);const b={getObjectId:M=>M.objectId,getAttributes:M=>M.attributes,getAttribute:(M,I)=>M.attributes[I],cloneWithGeometry:(M,I)=>new T.Om(I,M.attributes,null,M.objectId),getGeometry:M=>M.geometry,getCentroid:(M,I)=>M.ensureCentroid(I)}},48473:(_e,ee,_)=>{_.d(ee,{$:()=>T});class T{constructor(M,I){this.renderer=M,this.symbol=I}}},33360:(_e,ee,_)=>{_.d(ee,{LO:()=>de,kg:()=>ae,or:()=>ie,vl:()=>E});var T=_(10467),b=_(68677),M=_(48473),I=_(77522);function E(J,Y){const w=function F(J,Y){if(null!=J.symbol)return J.symbol;const w=Y?.renderer;return null!=w&&"dot-density"!==w.type?w.getSymbol(J,Y):null}(J,Y);if(null==w)return null;const W=Y?.renderer,z=new M.$(W,w);if(null==W||!("visualVariables"in W)||!W.visualVariables)return z;const B=(0,I.getVisualVariableValues)(W,J,Y)??[],C=["proportional","proportional","proportional"];for(const{variable:D,value:U}of B)switch(D.type){case"color":z.color=U.toRgba();break;case"size":if("outline"===D.target)z.outlineSize=U;else{const A=D.useSymbolValue?"symbol-value":U;switch(D.axis){case"width":C[0]=A;break;case"depth":C[1]=A;break;case"height":C[2]=A;break;case"width-and-depth":C[0]=C[1]=A;break;default:C[0]=C[1]=C[2]=A}}break;case"opacity":z.opacity=U;break;case"rotation":switch(D.axis){case"tilt":z.tilt=U;break;case"roll":z.roll=U;break;default:z.heading=U}}return"proportional"===C[0]&&"proportional"===C[1]&&"proportional"===C[2]||(z.size=C),z}function N(){return(N=(0,T.A)(function*(J,Y){return null!=J.symbol?J.symbol:Y?.renderer?.getSymbolAsync(J,Y)??null})).apply(this,arguments)}function de(J,Y){return te.apply(this,arguments)}function te(){return te=(0,T.A)(function*(J,Y){const w=yield function Z(J,Y){return N.apply(this,arguments)}(J,Y);if(!w)return null;const W=Y?.renderer,z=new M.$(W,w);if(!W||!("visualVariables"in W)||!W.visualVariables)return z;const B=(0,I.getVisualVariableValues)(W,J,Y)??[],C=["proportional","proportional","proportional"];for(const{variable:D,value:U}of B)if("color"===D.type)z.color=b.A.toUnitRGBA(U);else if("size"===D.type)if("outline"===D.target)z.outlineSize=U;else{const P=D.axis,A=D.useSymbolValue?"symbol-value":U;"width"===P?C[0]=A:"depth"===P?C[1]=A:"height"===P?C[2]=A:C[0]=C[1]="width-and-depth"===P?A:C[2]=A}else"opacity"===D.type?z.opacity=U:"rotation"===D.type&&"tilt"===D.axis?z.tilt=U:"rotation"===D.type&&"roll"===D.axis?z.roll=U:"rotation"===D.type&&(z.heading=U);return(isFinite(C[0])||isFinite(C[1])||isFinite(C[2]))&&(z.size=C),z}),te.apply(this,arguments)}function ae(J,Y=0){const w=J[Y];return"number"==typeof w&&isFinite(w)?w:null}function ie(J){for(let Y=0;Y<3;Y++){const w=J[Y];if("number"==typeof w)return isFinite(w)?w:0}return 0}},34909:(_e,ee,_)=>{_.r(ee),_.d(ee,{default:()=>Ls});var T=_(10467),b=_(8189),M=_(5922),I=_(11432),F=_(48900),E=_(85211),Z=_(3248),N=_(35150),te=(_(40707),_(76576)),ae=_(17715),ie=_(56492),J=_(3846);const Y=u=>{let h=class extends u{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,J.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var y=this;return(0,T.A)(function*(){const g=new AbortController,f=g.signal;y.addHandles((0,ae.hA)(()=>g.abort())),yield(0,F.C_)(()=>y.view.defaultsFromMap?.heightModelInfoReady,f),(0,ie.Te)(f);const v=(0,J.Hu)(y.layer,y.view.heightModelInfo,y.supportsHeightUnitConversion);if(v)throw v})()}};return(0,b._)([(0,E.MZ)()],h.prototype,"view",void 0),(0,b._)([(0,E.MZ)()],h.prototype,"slicePlaneEnabled",void 0),h=(0,b._)([(0,te.$)("esri.views.3d.layers.LayerView3D")],h),h};var w=_(25866),W=_(32034),z=_(16590),B=_(8675),C=_(73812),D=_(69307),U=_(89082),P=_(23393);function G(){return(G=(0,T.A)(function*(u,h,y,g,f){const{elevationProvider:v,renderCoordsHelper:S}=u,{elevationInfo:O}=h,{pointsInFeatures:L,spatialReference:K}=g,V=W.A.fromJSON(K),$=(0,P.MF)(O,!0),ce=yield(0,P.q6)($,V,f);(0,ie.Te)(f);const $e=[],Re=new Set,Ye=new Set,We=new U.F,Me=(0,B.T)(0,0,0,W.A.WGS84),dt=new D.Uk,gt=(0,w.vt)();Me.spatialReference=V;const Is=u.elevationProvider.spatialReference??u.spatialReference;for(const{objectId:Jt,points:Ti}of L){const Dt=y(Jt);if(null!=Dt){Dt.isDraped&&Ye.add(Jt),We.setFromElevationInfo((0,C.ze)(Dt.graphic.geometry,O)),We.updateFeatureExpressionInfoContext(ce,Dt.graphic,h);for(const{x:kt,y:Rs,z:Ms}of Ti)Me.x=kt,Me.y=Rs,Me.z=Ms??0,yield(0,z.W)(Me,gt,Is,0,{signal:f}),(0,D.sE)(gt,v,We,S,dt),$e.push(dt.z)}else{for(const kt of Ti)$e.push(kt.z??0);Re.add(Jt)}}return{elevations:$e,drapedObjectIds:Ye,failedObjectIds:Re}})).apply(this,arguments)}var R=_(81098),H=_(98877),se=_(48237),ye=_(56985),oe=_(95478),re=_(97669),ue=_(33360),Ce=_(87086),ve=_(88372),k=_(3223),le=_(89952),pe=_(60797),Ee=_(60611),he=_(12438),Qe=_(3804),ne=_(28714),it=_(28067),mt=_(1749),ft=_(13970),et=_(23234),ut=_(44929),j=_(29695),q=_(2296),Q=_(51995),De=_(58701),ge=_(3782),Ue=_(1257),_t=_(13318),Te=_(48298);function vt(u){return null==u||"simple"===u.type||"unique-value"===u.type||"class-breaks"===u.type||"dictionary"===u.type||"heatmap"===u.type}function pt(u,h){if(!h)return null;if(Array.isArray(h)||(h=[h]),h.length>0){const y=h.map(f=>f.details.symbol.type||f.details.symbol.declaredClass).filter(f=>!!f);y.sort();const g=new Array;return y.forEach((f,v)=>{0!==v&&f===y[v-1]||g.push(f)}),new M.A("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${g.join(", ")}) which are not supported in 3D`,{renderer:u,symbolErrors:h})}return null}var qt=_(48473),ei=_(48218),ji=_(71470),ti=_(6241),Vi=_(47705),Bi=_(75549),zi=_(27572),bt=_(42363);class Wi{constructor(h,y,g){this.maximumTotalNumberOfVertices=h,this.maximumNumberOfFeatures=y,this.averageSymbolComplexity=g}}_(21870);var Oe,xe,u,Ne=_(34150);class Ni{constructor(h,y){this.spatialReference=h,this._view=y}getElevation(h,y,g){return this._view.elevationProvider.getElevation(h,y,0,this.spatialReference,g)}queryElevation(h,y,g,f,v){var S=this;return(0,T.A)(function*(){return S._view.elevationProvider.queryElevation(h,y,0,S.spatialReference,v,g,f)})()}}(u=Oe||(Oe={}))[u.USER=1]="USER",u[u.SCALE_RANGE=2]="SCALE_RANGE",u[u.FILTER=4]="FILTER",u[u.DECONFLICTION=8]="DECONFLICTION",u[u.ALL_GRAPHIC=15]="ALL_GRAPHIC",u[u.ALL_LABEL=255]="ALL_LABEL",function(u){u[u.GRAPHIC=1]="GRAPHIC",u[u.LABEL=16]="LABEL"}(xe||(xe={}));var Gt=_(42425),Hi=_(42086),Zi=_(13682),nt=_(50690);const ii=(0,q.vt)();let He=class extends H.A{constructor(u){super(u),this.events=new Gt.A,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(h,y)=>"graphic"in h?h.graphic.attributes[y]:nt.T.getAttribute(h,y),getAttributes:h=>"graphic"in h?h.graphic.attributes:nt.T.getAttributes(h),getObjectId:h=>"graphic"in h?(0,ge.RW)(h.graphic,this.objectIdField)??void 0:nt.T.getObjectId(h),getGeometry:h=>"graphic"in h?h.getAsOptimizedGeometry(this.hasZ,this.hasM):nt.T.getGeometry(h),getCentroid:(h,y)=>{if("graphic"in h){let g=null;null!=h.centroid?g=h.centroid:"point"===h.graphic.geometry.type&&(0,ft.projectPoint)(h.graphic.geometry,ri,this.viewSpatialReference)&&(g=ri);const f=new Array(2+(y.hasZ?1:0)+(y.hasM?1:0));return null==g?(f[0]=0,f[1]=0,f[2]=0,f[3]=0):(f[0]=g.x,f[1]=g.y,y.hasZ&&(f[2]=g.hasZ?g.z:0),y.hasM&&(f[y.hasZ?3:2]=g.hasM?g.m:0)),new Zi.A([],f)}return nt.T.getCentroid(h,y)},cloneWithGeometry:(h,y)=>"graphic"in h?new Hi.Om(y,this.featureAdapter.getAttributes(h),null,this.featureAdapter.getObjectId(h)):nt.T.cloneWithGeometry(h,y)}}forEachInBounds(u,h){this.getSpatialIndex().forEachInBounds(u,h)}forEachBounds(u,h){const y=this.getSpatialIndex();for(const g of u){const f=this.featureAdapter.getObjectId(g);null!=y.getBounds(f,ii)&&h(ii)}}};(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"getSpatialIndex",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"forEach",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"hasZ",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"hasM",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"objectIdField",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"viewSpatialReference",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],He.prototype,"featureSpatialReference",void 0),He=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],He);const ri={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};class Ki{constructor(h,y,g){this.graphic=h,this.renderingInfo=y,this.layer=g}}var St=_(23191);class $i{constructor(h,y){this.scheduler=h,this.schedule=y,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===St.RT.Global}get doublePrecisionRequiresObfuscation(){return this.stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result}}var Rt=_(89447),si=_(34619),ni=_(68677),ai=_(67685),Mt=_(89141),Qi=_(35326),oi=_(42051),Xi=_(42132),Ji=_(81605),wt=_(90673),li=_(42975),ki=_(13688),Ut=_(83346),qi=_(98176),er=_(36884),we=_(40972),tr=_(1119),at=_(88532),ir=_(48499),ci=_(74567),rr=_(91074),hi=_(50957),Tt=_(55128),Ft=_(38499),sr=_(11556),nr=_(18110),ar=_(91725),ot=_(50915),Ct=_(41396);class or extends nr.w{constructor(h,y){super(h,y,new sr.$(ar.L,()=>_.e(4635).then(_.bind(_,34635))))}initializePipeline(h){const{hudDepth:y,terrainDepthTest:g}=h,f={func:g?ot.MT.ALWAYS:ot.MT.LESS};return(0,Ct.Ey)(y?{depthTest:f,depthWrite:Ct.Uy}:{blending:(0,Ct.p3)(ot.dn.ONE,ot.dn.SRC_ALPHA,ot.dn.ONE_MINUS_SRC_ALPHA,ot.dn.ONE_MINUS_SRC_ALPHA),depthTest:f,colorWrite:Ct.kn})}}var rt=_(55062),lr=_(35094);class tt extends lr.E{constructor(h){super(),this.spherical=h,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}}(0,b._)([(0,rt.W)()],tt.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,b._)([(0,rt.W)()],tt.prototype,"occlusionTestEnabled",void 0),(0,b._)([(0,rt.W)()],tt.prototype,"hasVerticalOffset",void 0),(0,b._)([(0,rt.W)()],tt.prototype,"hasScreenSizePerspective",void 0),(0,b._)([(0,rt.W)()],tt.prototype,"hudDepth",void 0),(0,b._)([(0,rt.W)()],tt.prototype,"hudDepthAlignStart",void 0),(0,b._)([(0,rt.W)()],tt.prototype,"terrainDepthTest",void 0);var jt=_(28700);class Vt extends hi.im{constructor(h,y){super(h,di),this.produces=new Map([[Tt.N.LINE_CALLOUTS,g=>(0,ci.RN)(g)],[Tt.N.LINE_CALLOUTS_HUD_DEPTH,g=>(0,ci.RN)(g)]]),this._configuration=new tt(y),this._uniqueMaterialIdentifier=Bt(this.parameters)}passParameters(){return this.parameters}getConfiguration(h,y){const g=y.slot===Tt.N.LINE_CALLOUTS_HUD_DEPTH;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=g,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=y.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=jt.Q||(this.parameters.borderColor?.[3]??0)>=jt.Q}intersect(){}createGLMaterial(h){return new cr(h)}createBufferWriter(){return new dr}validateParameters(h){this._uniqueMaterialIdentifier=Bt(h)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function Bt({renderOccluded:u,isDecoration:h,horizontalScreenOffset:y,color:g,size:f,occlusionTest:v,shaderPolygonOffset:S,hudDepthAlignStart:O,centerOffsetUnits:L,hasSlicePlane:K,screenSizePerspective:V,verticalOffset:$,borderColor:ce}){return tr.ML`${u}:${h}:${y}:[${g}]:${f}:${v}:${S}:${O}:${L}:${K}:${null!=V}:{${$.screenLength}:${$.minWorldLength}:${$.maxWorldLength}}:[${ce}]`}class cr extends rr.A{beginSlot(h){return this.getTechnique(or,h)}}class di extends hi.qA{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=(0,Mt.fA)(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const hr=(0,ir.BP)().vec3f(we.r.POSITION).vec3f(we.r.NORMAL).vec2f(we.r.UV0).vec4f(we.r.CENTEROFFSETANDDISTANCE),ui=[(0,at.fA)(0,0),(0,at.fA)(1,0),(0,at.fA)(0,1),(0,at.fA)(1,0),(0,at.fA)(1,1),(0,at.fA)(0,1)];class dr{constructor(){this.vertexBufferLayout=hr}elementCount(h){return 6*h.get(we.r.POSITION).indices.length}write(h,y,g,f,v,S){(0,Ft.Hk)(g.get(we.r.POSITION),h,v.position,S,6),(0,Ft.p1)(g.get(we.r.NORMAL),y,v.normal,S,6),(0,Ft.Ut)(g.get(we.r.CENTEROFFSETANDDISTANCE),v.centerOffsetAndDistance,S,6);for(let O=0;O<ui.length;++O)v.uv0.setVec(S+O,ui[O])}}class Et extends Ji.U{constructor(h,y){super(h,null,y,yr),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}doLoad(){var h=this;return(0,T.A)(function*(){h._materials[0]=new Vt(h._materialParameters,h._context.spherical),h._context.stage.add(h._materials[0])})()}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(h){const y=this._materialParameters;return y.horizontalScreenOffset=h.horizontalScreenOffset??0,y.centerOffsetUnits=h.centerOffsetUnits||"world",y}get _materialParameters(){const h=new di,y=this.symbol,g=y.callout;if(g.color){const S=ni.A.toUnitRGBA(g.color);S[3]*=this._getLayerOpacity(),h.color=S}else h.color=Mt.uY;if(h.size=(0,ai.Lz)(g.size||0),y.verticalOffset){const{screenLength:S,minWorldLength:O,maxWorldLength:L}=y.verticalOffset;h.verticalOffset={screenLength:(0,ai.Lz)(S),minWorldLength:O||0,maxWorldLength:L??1/0}}h.borderColor=null!=g.border?.color?ni.A.toUnitRGBA(g.border.color):null;const f="object"===y.symbolLayers.at(0).type,v="label-3d"===y.type;return h.occlusionTest=!f&&!(0,Z.A)("enable-feature:non-occluded-hud"),f&&(h.shaderPolygonOffset=0),h.hudDepthAlignStart=v,h.hasSlicePlane=this._context.slicePlaneEnabled,h.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,h}_defaultElevationInfoNoZ(){return pr}createGraphics3DGraphic(h){const y=h.renderingInfo,g=h.graphic,f=this.setGraphicElevationContext(g,new U.F,y.elevationOffset||0),v=y.symbol,S="on-the-ground"===this._elevationContext.mode&&("cim"===v.type||!v.symbolLayers.some(L=>"object"===L.type||"text"===L.type));if("label-3d"!==v.type&&S||"point-3d"===v.type&&v.symbolLayers.every(L=>"text"===L.type&&!(0,si.Ie)(L)))return null;const O=(0,wt.W$)(g.geometry);return null==O?null:this._createAs3DShape(O,f,y,g.uid)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(h,y,g){const v=(0,D.I2)(Et.elevationModeChangeTypes,g,this._elevationContext.mode);return v!==D.uw.UPDATE||h.forEach(S=>{const O=y(S);null!=O&&this.updateGraphicElevationContext(S.graphic,O)}),v}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(h,y,g=0){return super.setGraphicElevationContext(h,y),y.addOffsetRenderUnits(g),y}updateGraphicElevationContext(h,y){const{elevationContext:g,metadata:f}=y;this.setGraphicElevationContext(h,g,f?.elevationOffset??0),y.needsElevationUpdates=(0,D.nu)(g.mode)}computeComplexity(){return new ki.rz({verticesPerFeature:6})}_getOrCreateMaterial(h){const y=this._perInstanceMaterialParameters(h),g=Bt(y);if(g===this._materials[0]?.uniqueMaterialIdentifier)return{material:this._materials[0],isUnique:!1};if(null!=h.materialCollection){let f=h.materialCollection.get(g);return null==f&&(f=new Vt(y,this._context.spherical),h.materialCollection.add(g,f)),{material:f,isUnique:!1}}return{material:new Vt(y,this._context.spherical),isUnique:!0}}_createAs3DShape(h,y,g,f){const S=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerUid:this._context.layer.uid}),O=this._getOrCreateMaterial(g),L=new er.V(O.material,function ur(u){const{translation:h,centerOffset:y}=u,g=new Ut.n(h?[h[0],h[1],h[2]]:[0,0,0],zt,3,!0),f=new Ut.n(y?[y[0],y[1],y[2],y[3]]:[0,0,0,1],zt,4,!0);return[[we.r.POSITION,g],[we.r.NORMAL,new Ut.n([0,0,1],zt,3,!0)],[we.r.CENTEROFFSETANDDISTANCE,f]]}(g),null,qi.X.Point,S),K=(0,li.SZ)(this._context,h,L,y,f);if(null==K)return null;const V=new oi.Y(this,K.object,[L],O.isUnique?[O.material]:null,null,Qi.G8,y);return V.metadata=new Xi.Z(g.elevationOffset),V.alignedSampledElevation=K.sampledElevation,V.needsElevationUpdates=(0,D.nu)(y.mode),(0,li.d2)(V,h,this._context.elevationProvider),V}}Et.elevationModeChangeTypes={definedChanged:D.uw.UPDATE,staysOnTheGround:D.uw.UPDATE,onTheGroundChanged:D.uw.RECREATE};const zt=[0],pr={mode:"relative-to-ground",offset:0},yr={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class gr extends qt.${constructor(h,y,g=(0,w.vt)(),f=(0,Mt.vt)(),v=0,S="world",O=0,L=null){super(h,y),this.translation=g,this.centerOffset=f,this.horizontalScreenOffset=v,this.centerOffsetUnits=S,this.elevationOffset=O,this.materialCollection=L}}const pi=()=>N.A.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory"),fr={line:Et};var _r=_(11445),vr=_(61591),br=_(83953),yi=_(45475),Sr=_(55861);function xt(u,h,y,g){return!(null==u||((0,De.aI)(h,g)?((0,Q.C)(y,u),0):(Ie[0]=u[0],Ie[1]=u[1],Ie[2]=0,!(0,et.projectBuffer)(Ie,h,0,Ie,g,0)||(y[0]=Ie[0],y[1]=Ie[1],Ie[0]=u[2],Ie[1]=u[3],Ie[2]=0,!(0,et.projectBuffer)(Ie,h,0,Ie,g,0)||(y[2]=Ie[0],y[3]=Ie[1],0)))))}const Ie=(0,w.vt)();var Cr=_(31732);const gi=new vr.A(Array,u=>(0,q.hZ)(u,q.v_),null,10,5),Er=(0,Q.vt)();class xr{get labelLayers(){return this._labelLayers||le.tR}get extent(){return this._extent}get isElevationSource(){return this.layers.some(h=>h?.isElevationSource)}constructor(h,y,g,f,v){this.graphic=h,this.graphics3DSymbol=y,this.layers=g,this._visibleFlags=Oe.ALL_LABEL,this.deconflictionPriority=0,++y.referenced,this._featureExpressionFeature=v?(0,P.VG)(v,h,f):null}initialize(h){this._layer=h,this._forEachSymbolLayerGraphic(y=>{y.initialize(h),y.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(h=>h.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic(h=>h.destroy()),this._labelLayers=null}addLabelGraphic(h,y){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(h),h.initialize(y),h.setVisibility(this.isVisible(xe.LABEL))}setCalloutGraphic(h){this._calloutLayer=h,this._layer&&(h.initialize(this._layer),h.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let h=!1;return this._forEachSymbolLayerGraphic(y=>{"draped"===y.type&&(h=!0)}),h}isVisible(h=xe.GRAPHIC,y){const g=y?this._visibleFlags|y|xe.LABEL*y:this._visibleFlags;return h===xe.GRAPHIC?(g&Oe.ALL_GRAPHIC)===Oe.ALL_GRAPHIC:(g&Oe.ALL_LABEL)===Oe.ALL_LABEL}setVisibilityFlag(h,y,g){const f=this.isVisible(h);g?this._visibleFlags|=h*y:this._visibleFlags&=~(h*y);const v=this.isVisible(h);if(f===v)return!1;if(h===xe.LABEL)this._forEachLabelGraphic(S=>S.setVisibility(v));else{this._forEachSymbolLayerGraphic(O=>O.setVisibility(v));const S=this.isVisible(xe.LABEL);this._forEachLabelGraphic(O=>O.setVisibility(S))}return!0}getVisibilityFlag(h,y){return!!(this._visibleFlags&h*y)}computeExtent(h){if(!this._extent){const y=this.graphic.geometry;if(null==y)return!1;this._extent=(0,Q.vt)(),(0,ge.iQ)(y,this._extent);const g=y.spatialReference;if(!(0,De.aI)(g,h)&&!xt(this._extent,g,this._extent,h))return this._extent=null,!1}return!0}getAsOptimizedGeometry(h,y){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,h,y)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(h,y,g){let f=h.geometry;return"mesh"!==f.type&&"extent"!==f.type||(f=Sr.A.fromExtent("mesh"===f.type?f.extent:f)),(0,Cr.Ux)(f,y,g)}get usedMemory(){let h=(0,_r.lM)(this.graphic.attributes);return this._forEachSymbolLayerGraphic(y=>h+=y.graphics3DSymbolLayer.usedMemory),h}computeAttachmentOrigin(){const h={render:{origin:(0,w.vt)(),num:0},draped:{origin:(0,yi.vt)(),num:0}};for(const y of this.layers)y?.computeAttachmentOrigin(h);return h.render.num>1&&(0,ne.h)(h.render.origin,h.render.origin,1/h.render.num),h.draped.num>1&&(0,br.hs)(h.draped.origin,h.draped.origin,1/h.draped.num),h}getProjectedBoundingBox(h,y,g,f,v){var S=this;return(0,T.A)(function*(){return v||(v={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),v.boundingBox?(0,q.Ie)(v.boundingBox):v.boundingBox=(0,q.Ie)(),v.requiresDrapedElevation=!1,yield(0,Rt.jJ)(S.layers,function(){var O=(0,T.A)(function*(L){if(null==L)return;const K="draped"===L.type?y:h,V=gi.acquire(),$=yield L.getProjectedBoundingBox(K,g,v.screenSpaceObjects,f,V);isFinite($[2])&&isFinite($[5])||(v.requiresDrapedElevation=!0),$&&(0,q.RF)(v.boundingBox,V),gi.release(V)});return function(L){return O.apply(this,arguments)}}()),(0,q.vQ)(v.boundingBox)||(0,Q.vQ)((0,q.ES)(v.boundingBox,Er))?v:null})()}needsElevationUpdates(){for(const h of this.layers)if(null!=h&&("object3d"===h.type||"lod-instance"===h.type)&&h.needsElevationUpdates)return!0;return this._labelLayers?.some(h=>h?.needsElevationUpdates??!1)??!1}alignWithElevation(h,y,g){this._forEachRenderedGraphic(f=>{"object3d"!==f.type&&"lod-instance"!==f.type||f.alignWithElevation(h,y,this._featureExpressionFeature,g)})}alignWithAbsoluteElevation(h,y,g){this._forEachRenderedGraphic(f=>{"object3d"===f.type&&f.alignWithAbsoluteElevation(h,y,g)})}addObjectStateSet(h){this._forEachSymbolLayerGraphic(y=>y.addObjectState(h))}removeObjectState(h){this._forEachSymbolLayerGraphic(y=>y.removeObjectState(h))}updateHighlights(h){this._forEachSymbolLayerGraphic(y=>y.updateHighlights(h))}_forEachGraphicList(h,y){h?.forEach(g=>g&&y(g))}_forEachSymbolLayerGraphic(h){this._forEachGraphicList(this.layers,h),this._calloutLayer&&h(this._calloutLayer)}_forEachLabelGraphic(h){this._forEachGraphicList(this.labelLayers,h)}_forEachRenderedGraphic(h){this._forEachSymbolLayerGraphic(h),this._forEachLabelGraphic(h)}get test(){}}var Pe=_(47804),lt=_(69760);function mi(u){return 2216+4096*u.symbolLayers.length+u.complexity.memory.resourceBytes}class fi extends lt.x{set symbol(h){this._symbol=h,h.symbolLayers.forEach((y,g)=>{const f=this.symbolLayers[g];null!=f&&(f.symbol=h,f.symbolLayer=y)})}get symbol(){return this._symbol}constructor(h,y,g){super(y.schedule),this._symbol=h,this._context=y,this._backgroundLayers=g,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}doLoad(h){var y=this;return(0,T.A)(function*(){let g=y._symbol.symbolLayers;y._extentPadding=0,y._backgroundLayers&&(g=y._backgroundLayers.concat(g));const f=g.length;for(;y.symbolLayers.length<g.length;)y.symbolLayers.push(null);y.symbolLayers.length=g.length;const v=[],{make:S}=yield Promise.all([_.e(6456),_.e(8023),_.e(6141),_.e(2814),_.e(4093),_.e(179),_.e(2076),_.e(7052)]).then(_.bind(_,5895));for(let O=0;O<f;O++){const L=g.at(O);if(!1===L.enabled)continue;Pt.renderPriority=1-(1+O)/f,Pt.renderPriorityStep=1/f,Pt.ignoreDrivers=L.ignoreDrivers;const K=S(y.symbol,L,y._context,Pt),V=(0,ie.NY)(h,()=>{y.symbolLayers[O]=null,K.destroy()});V&&v.push(V),y.symbolLayers[O]=K}if(yield(0,Rt.jJ)(y.symbolLayers,function(){var O=(0,T.A)(function*(L,K){if(null!=L)try{yield L.load(),y._extentPadding+=Math.max(y._extentPadding,L.extentPadding)}catch{y.symbolLayers[K]=null}});return function(L,K){return O.apply(this,arguments)}}()),v.forEach(O=>O.remove()),(0,ie.Te)(h),y.symbolLayers.length&&!y.symbolLayers.some(O=>!!O))throw new Error})()}getSymbolLayerSize(h){const y=this.symbolLayers[h];return null!=y?y.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(h=>h?.queryForSnapping)}updateFocus(h,y){this.symbolLayers.forEach(g=>g?.updateFocus(h,y))}createGraphics3DGraphic(h,y){const g=h.graphic,f=this.symbolLayers.map(S=>S?.createGraphics3DGraphic(h)??null);return new xr(g,y||this,f,h.layer,this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null)}get complexity(){return(0,bt.Tf)(this.symbolLayers.map(h=>null!=h?h.complexity:null))}globalPropertyChanged(h,y){const g=this.symbolLayers.length;for(let f=0;f<g;f++){const v=this.symbolLayers[f];if(null!=v&&!v.globalPropertyChanged(h,y,O=>{const L=O.layers[f];return L instanceof oi.Y?L:null}))return!1}return!0}applyRendererDiff(h,y){return this.loadStatus!==lt.P.LOADED?Pe.w.RecreateSymbol:this.symbolLayers.reduce((g,f)=>g!==Pe.w.RecreateSymbol&&null!=f?Math.min(g,f.applyRendererDiff(h,y)):g,Pe.w.FastUpdate)}prepareSymbolPatch(h){if(this.loadStatus===lt.P.FAILED||"partial"!==h.diff.type)return;const y=h.diff.diff;if(!y.symbolLayers||"partial"!==y.symbolLayers.type)return;const g=y.symbolLayers.diff;this.symbolLayers.forEach((f,v)=>{if(null==f)return;const S=g[v];if(S){const O={diff:S,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};f.prepareSymbolLayerPatch(O),h.symbolStatePatches.push(...O.symbolLayerStatePatches),O.graphics3DGraphicPatches.length&&h.graphics3DGraphicPatches.push((L,K)=>{const V=L.layers[v];null!=V&&O.graphics3DGraphicPatches.forEach($=>$(V,K))})}})}updateGeometry(h,y){return this._updateGeometryOrTransform(h,(g,f)=>g.updateGeometry(f,y))}updateTransform(h,y,g,f){return this._updateGeometryOrTransform(h,(v,S)=>v.updateTransform(S,y,g,f))}_updateGeometryOrTransform(h,y){for(let g=0;g<this.symbolLayers.length;g++){const f=this.symbolLayers[g];if(null==f)continue;const v=h.layers[g];if(!v||!y(f,v))return!1}return!0}onRemoveGraphic(h){for(let y=0;y<this.symbolLayers.length;y++){const g=this.symbolLayers[y];if(null==g)continue;const f=h.layers[y];null!=f&&g.onRemoveGraphic(f)}}getFastUpdateStatus(){let h=!1,y=!1;for(const g of this.symbolLayers)if(null!=g){if(g.loadStatus===lt.P.LOADING)return Pe.G.Loading;g.isFastUpdatesEnabled()?y=!0:h=!0}return y?h?Pe.G.Mixed:Pe.G.Fast:h?Pe.G.Slow:Pe.G.Undefined}queryForSnapping(h,y,g,f){var v=this;return(0,T.A)(function*(){const S=v.symbolLayers.filter(le.Ru).filter(L=>null!=L.queryForSnapping).map(L=>L.queryForSnapping(h,y,g,f)),O=yield Promise.all(S);return(0,ie.Te)(f),O.flat()})()}destroy(){if(!this.destroyed){super.destroy();for(const h of this.symbolLayers)h?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return mi(this)}}const Pt=new class Yi{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class Ar extends fi{constructor(h,y,g){super(h,y,g),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=function mr(u,h){if(!(0,si.YX)(u))return pi().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${u.type}' does not support callouts`),null;if(!u.callout)return null;const y=fr[u.callout.type];return y?new y(u,h):(pi().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${u.callout.type}`),null)}(this.symbol,y))}doLoad(h){var y=()=>super.doLoad,g=this;return(0,T.A)(function*(){const f=g._calloutSymbolLayer?(0,Rt.Ke)(g._calloutSymbolLayer.load()):null;try{yield y().call(g,h),(0,ie.Te)(h)}catch(v){throw g._calloutSymbolLayer?.abortLoad(),v}f&&(yield f)})()}destroy(){super.destroy(),this._calloutSymbolLayer=(0,I.pR)(this._calloutSymbolLayer)}createGraphics3DGraphic(h,y){const g=super.createGraphics3DGraphic(h,y);if(null!=this._calloutSymbolLayer&&null!=g){const f=this._createCalloutGraphic(h);f&&g.setCalloutGraphic(f)}return g}globalPropertyChanged(h,y){return!!super.globalPropertyChanged(h,y)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(h,y,g=>g.calloutLayer))}updateGeometry(h,y){const g=super.updateGeometry(h,y);if(g&&this._calloutSymbolLayer){const f=h.calloutLayer;if(f)return this._calloutSymbolLayer.updateGeometry(f,y)}return g}_createCalloutGraphic(h){const y=h.renderingInfo;return h.renderingInfo=new gr(y.renderer,y.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(h)}}var Lr=_(77926);class Ir extends lt.x{constructor(h,y,g){super(y),this.symbol=h,this._convert=g,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(h){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(h):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}doLoad(h){var y=this;return(0,T.A)(function*(){const g=yield y.symbol.fetchSymbol({signal:h,acceptedFormats:Lr.t});g.id=y.symbol.id,y.graphics3DSymbol=y._convert(g),null!=y.graphics3DSymbol&&(yield y.graphics3DSymbol.load())})()}createGraphics3DGraphic(h){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(h,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:bt.uD}globalPropertyChanged(h,y){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(h,y)}applyRendererDiff(h,y){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(h,y):Pe.w.RecreateSymbol}prepareSymbolPatch(h){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(h)}updateGeometry(h,y){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(h,y)}updateTransform(h,y,g,f){return this.graphics3DSymbol?.updateTransform(h,y,g,f)??!1}onRemoveGraphic(){}updateFocus(h,y){}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??Pe.G.Loading}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}get cachedMemory(){return mi(this)}}class Gr{constructor(h,y,g){this.visible=h,this.missing=y,this.pending=g}}class Rr{constructor(h){this._graphicsCore=h,this._idToState=new Map,this._states=new Set;const y=h.owner.layer?.objectIdField;y?(this._getGraphicId=g=>(0,ge.RW)(g,y),this._getGraphics3DGraphicById=g=>this._graphicsCore.getGraphics3DGraphicByObjectId(g)):(this._getGraphicId=g=>g.uid,this._getGraphics3DGraphicById=g=>this._graphicsCore.getGraphics3DGraphicById(g))}destroy(){this._idToState.clear(),this._states.forEach((h,y)=>this.remove(y))}add(h){const y=(0,ae.hA)(()=>this.remove(h));if(this._states.has(h))return y;const g=this._getGraphicId(h.graphic),f=this._getGraphics3DGraphicById(g);return this._states.has(h)||this._states.add(h),this._ensureStateList(g).push(h),h.displaying=null!=f&&f.isVisible(),h.isDraped=null!=f&&f.isDraped,h.tracking=!0,null!=f&&h.emit("changed"),y}remove(h){if(this._states.has(h)){if(this._idToState.size){const y=this._getGraphicId(h.graphic),g=this._idToState.get(y);g&&((0,le.TF)(g,h),0===g.length&&this._idToState.delete(y))}this._states.delete(h),h.tracking=!1,h.displaying=!1}}addGraphic(h){this._forEachState(h.graphic,y=>{y.displaying=h.isVisible(),y.isDraped=h.isDraped,y.emit("changed")})}removeGraphic(h){this._forEachState(h.graphic,y=>{y.displaying=!1,y.isDraped=!1})}updateGraphicGeometry(h){this._forEachState(h.graphic,y=>y.emit("changed"))}updateGraphicVisibility(h){this._forEachState(h.graphic,y=>y.displaying=h.isVisible())}updateGraphicError(h,y){this._forEachState(h,g=>g.error=y)}allGraphicsDeleted(){this._states.forEach(h=>h.displaying=!1)}_ensureStateList(h){const y=this._idToState.get(h);if(y)return y;const g=new Array;return this._idToState.set(h,g),g}_forEachState(h,y){if(0===this._states.size||0===this._idToState.size)return;const g=this._getGraphicId(h),f=this._idToState.get(g);f?.forEach(y)}}var Mr=_(3567);let Xe=class extends H.A{constructor(u){super(u),this._index=new Mr.w(9,(0,Z.A)("esri-csp-restrictions")?h=>({minX:h.extent[0],minY:h.extent[1],maxX:h.extent[2],maxY:h.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(u){this._addMany(u)}destroy(){this._missing.clear(),this._index=(0,I.pR)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(u,h,y){null!=h&&h.equals(this.spatialReference)&&(Ze.minX=u[0],Ze.minY=u[1],Ze.maxX=u[2],Ze.maxY=u[3],this.update(),this._index.search(Ze,g=>y(g.graphic.uid)))}add(u){this._missing.add(u),this.updating=!0}remove(u){if(this._missing.delete(u))return void(this.updating=this._missing.size>0);if(!u.extent)return;this._index.remove(u);const h=(0,ge.RW)(u.graphic,this._get("objectIdField"));null!=h&&this._boundsByFeature.delete(h)}_addMany(u){if(0===u.length)return;const h=this._get("objectIdField");for(const y of u){y.computeExtent(this.spatialReference);const g=(0,ge.RW)(y.graphic,h);null!=g&&this._boundsByFeature.set(g,y.extent)}this._index.load(u)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(u,h){Ze.minX=u[0],Ze.minY=u[1],Ze.maxX=u[2],Ze.maxY=u[3],this.update(),this._index.search(Ze,y=>{h(y)})}getBounds(u,h){this.update();const y=this._boundsByFeature.get(u);return y?(0,q.Jt)(h,y):null}};(0,b._)([(0,E.MZ)({constructOnly:!0})],Xe.prototype,"spatialReference",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],Xe.prototype,"hasZ",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],Xe.prototype,"hasM",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],Xe.prototype,"objectIdField",void 0),(0,b._)([(0,E.MZ)()],Xe.prototype,"updating",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],Xe.prototype,"updatingRemaining",null),Xe=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.SpatialIndex2D")],Xe);const Ze={minX:0,minY:0,maxX:0,maxY:0};var wr=_(82663),Ur=_(82575),Fr=_(16126),jr=_(8978);const _i=Symbol("layerHandles");let st=class extends(Gt.A.EventedMixin(H.A)){get spatialReference(){return this.view?.spatialReference}constructor(u){super(u),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=(0,Fr.hz)(this.view.state.viewingMode),this._intersector.options.store=jr.oH.MIN;const u=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=u[2],this._zmax=u[5];const h=this.stageLayer.events;this.addHandles([h.on(["layerObjectAdded","layerObjectRemoved","geometryAdded","geometryRemoved"],({object:y})=>this._objectChanged(y)),h.on("attributesChanged",({attribute:y,object:g})=>(0,we.b)(y)&&this._objectChanged(g)),h.on(["transformationChanged","shaderTransformationChanged"],y=>this._objectChanged(y))],_i)}dispose(){this.removeHandles(_i)}elevationInfoChanged(){const u=null!=this.layer?this.layer.elevationInfo:null;if(null!=u&&"on-the-ground"!==u.mode){const h=(0,wr.G9)(this.layer.spatialReference),y=(0,Ur.Ao)(u.unit??"meters");this._elevationOffset=(u.offset??0)*y/h}else this._elevationOffset=0}getElevation(u,h,y,g){if(Le[0]=u,Le[1]=h,Le[2]=y,!this._renderCoordsHelper.toRenderCoords(Le,g,Le))return N.A.getLogger(this).error("could not project point for elevation alignment"),null;const f=this._elevationOffset,v=this._zmin+f;return this._renderCoordsHelper.setAltitude(vi,this._zmax+f,Le),this._renderCoordsHelper.setAltitude(bi,v,Le),this._intersector.reset(vi,bi,null),this._intersector.intersect(this._intersectLayers,null,1,null,L=>!!L.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(Le)?this._renderCoordsHelper.getAltitude(Le):null}_objectChanged(u){const h=this.spatialReference;if(!u.lastValidElevationBB||!h)return;(0,q.Ie)(Je);const y=u.lastValidElevationBB;y.isEmpty()||this._expandExtent(h,y.min,y.max,Je);const{min:g,max:f}=u.boundingVolumeWorldSpace;this._expandExtent(h,g,f,Je),(0,q.ES)(Je,Wt.extent),this._zmin=Math.min(this._zmin,Je[2]),this._zmax=Math.max(this._zmax,Je[5]),Wt.spatialReference=h,this.emit("elevation-change",Wt),(0,ne.c)(y.min,g),(0,ne.c)(y.max,f)}_computeLayerExtent(u,h){return(0,q.Ie)(Je),null!=u&&h.objects.forAll(y=>this._expandExtent(u,y.boundingVolumeWorldSpace.min,y.boundingVolumeWorldSpace.max,Je)),Je}_expandExtent(u,h,y,g){for(let f=0;f<8;++f)Le[0]=1&f?h[0]:y[0],Le[1]=2&f?h[1]:y[1],Le[2]=4&f?h[2]:y[2],this._renderCoordsHelper.fromRenderCoords(Le,Le,u),(0,q.iT)(g,Le);return g}};(0,b._)([(0,E.MZ)({constructOnly:!0})],st.prototype,"layer",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],st.prototype,"stageLayer",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],st.prototype,"view",void 0),(0,b._)([(0,E.MZ)()],st.prototype,"spatialReference",null),st=(0,b._)([(0,te.$)("esri.views.3d.layers.support.StageLayerElevationProvider")],st);const Je=(0,q.Ie)(),Wt=new class Tr{constructor(h="scene"){this.context=h,this.extent=(0,Q.Ie)()}},Le=(0,w.vt)(),vi=(0,w.vt)(),bi=(0,w.vt)(),fe=(0,w.vt)();var Ht,zr=_(43745),Ae=_(19451),Wr=_(44323),Nr=_(64935),Hr=_(44168),Nt=_(5714);const Zt=(0,w.vt)(),Zr=(0,q.vt)();let X=Ht=class extends H.A{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new Xe({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?Ae.q.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||this._loadingSymbols>0)}get running(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const u=this.owner&&this.owner.view&&this.owner.view.qualitySettings,h=u?.graphics3D.minTotalNumberOfFeatures??0,y=u?.graphics3D.maxTotalNumberOfFeatures??0,g=u?.graphics3D.maxNumberOfDrawCalls??0,f=u?.graphics3D.maxTotalNumberOfVertices??0,v=this.averageSymbolComplexity,S=Math.max(1,v?.verticesPerFeature??1),O=v&&v.drawCallsPerFeature>0&&g>0?g/v.drawCallsPerFeature:y,L=Math.ceil(f/S),K=Math.max(h,Math.min(y,L,O)),V=this._get("displayFeatureLimit");return V&&V.maximumTotalNumberOfVertices===f&&V.averageSymbolComplexity===v&&V.maximumNumberOfFeatures===K?V:new Wi(f,K,v)}get averageSymbolComplexity(){const u=(0,bt.k9)(this._symbolComplexities),h=this._get("averageSymbolComplexity");return 0===u.numComplexities||null!=h&&(u.estimated&&(h.verticesPerFeature>=u.verticesPerFeature||h.verticesPerCoordinate>=u.verticesPerCoordinate||h.drawCallsPerFeature>=u.drawCallsPerFeature)||h.verticesPerFeature===u.verticesPerFeature&&h.verticesPerCoordinate===u.verticesPerCoordinate&&h.drawCallsPerFeature===u.drawCallsPerFeature)?h:u}get usedMemory(){const u=this.labelsEnabled?(this.averageSymbolComplexity?.memory.bytesPerFeatureLabel??0)*this._numberOfGraphics:0,h=this._getSymbolComplexitiesUsed().reduce((v,S)=>v+S.memory.resourceBytes,0);if(null==this._symbolMaterials){this._symbolMaterials=[];for(const v of this._symbols.values())if(null!=v)for(const S of v.symbolLayers)if(S)for(const O of S.materials)O&&this._symbolMaterials.push(O)}const y=this.owner.view._stage.renderer,g=this.owner.view.basemapTerrain.overlayManager.renderer,f=this._symbolMaterials.reduce((v,S)=>v+((y.getMaterialRenderer(S)||g.getMaterialRenderer(S))?.usedMemory??0),0);return this._usedMemory+u+h+f}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const u=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*u}return null!=this.averageSymbolComplexity?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(u){const h=u;if("web-style"===h.type)return h.clone();const y=this._symbolConversionCache.get(h.id);if(null!=y)return y;const g=(0,Te.t)(h,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(h),cimFallbackEnabled:!0}),f=g.symbol||null;return null==f&&g.error&&N.A.getLogger(this).error(g.error.message),this._symbolConversionCache.set(h.id,f),f}_getSymbolComplexitiesUsedOrRenderer(u){if(null==u)return[];const h=u.symbols,y="backgroundFillSymbol"in u?u.backgroundFillSymbol:null;if(!y&&!h.length)return[];const g=[],f=this._getSymbolComplexityUsedOrRenderer(y);null!=f&&g.push(f);for(const v of h){const S=this._getSymbolComplexityUsedOrRenderer(v);null!=S&&g.push(S)}return g}_getSymbolComplexityUsedOrRenderer(u){if(null==u)return null;const h=this._symbols.get(u.id);if(null!=h)return h.complexity;const y=this._getConvertedSymbol(u);return null!=y?(0,bt.Eg)(y):null}_getSymbolComplexitiesUsed(){const u=[];return this._symbols.forEach(h=>{null!=h&&u.push(h.complexity)}),u}get _objectIdField(){return this.layer.objectIdField}constructor(u){super(u),this._propertiesPool=new Hr.M({computedExtent:it.A},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=Ne.nu,this._dataUpdateQueue=new Ue.T,this._updateQueue=new Ue.T,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new he.A({allocator:h=>h||new Kr,deallocator:h=>(h.clear(),h)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new he.A,this.preferredUpdatePolicy=Ae.q.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=u.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",h=>h.destroy()),this.symbolCreationContext=new $i(u.owner.view.resourceController.scheduler,(h,y)=>this._updateQueue.push(h,y))}initialize(){this._featureStore=new He({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:y=>this.graphics3DGraphics.forEach(y)});const u=(y,g,f)=>this.spatialIndex.queryGraphicUIDsInExtent(y,g,f),{componentFactories:h}=this;this._elevationAlignment=h.elevationAlignment?.(this,u),this._scaleVisibility=h.scaleVisibility?.(this,u),this._filterVisibility=h.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:y=>this.modifyGraphics3DGraphicVisibilities(g=>g.setVisibilityFlag(xe.GRAPHIC,Oe.FILTER,y((0,ge.RW)(g.graphic,this._objectIdField)))),setAllFeaturesVisibility:y=>this.modifyGraphics3DGraphicVisibilities(g=>g.setVisibilityFlag(xe.GRAPHIC,Oe.FILTER,y)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(y=>y.setVisibilityFlag(xe.GRAPHIC,Oe.FILTER,!0))}),this._deconflictor=h.deconflictor?.(this),this._labeler=h.labeler?.(this,this._scaleVisibility),this._objectStates=h.objectStates?.(this),this._initializeAbortController=new AbortController,this.addHandles((0,F.z7)(()=>this.owner.view.state.highlights,()=>{const{highlightOrderMap:y}=this.owner.view.state;this.graphics3DGraphics.forEach(g=>g.updateHighlights(y))})),this._initializePromise=this._initializeAsync()}_initializeAsync(){var u=this;return(0,T.A)(function*(){const h=u._initializeAbortController?.signal,y=u.owner.view;u._viewElevationProvider=new Ni(u._viewSpatialReference,y),u._initializeStage(y,u.layer.uid);const g=y.sharedSymbolResources;u.symbolCreationContext.sharedResources=g,u._sharedSymbolResourcesOwnerHandle=g.addGraphicsOwner(u.owner),null!=u.currentRenderer&&(u.symbolCreationContext.renderer=u.currentRenderer),u.symbolCreationContext.stage=u.stage,u.symbolCreationContext.streamDataRequester=g.streamDataRequester,u.symbolCreationContext.renderCoordsHelper=y.renderCoordsHelper,u.symbolCreationContext.layer=u.layer,u.symbolCreationContext.graphicsCoreOwner=u.owner,u.symbolCreationContext.localOriginFactory=new zr.g(y.renderSpatialReference),u.symbolCreationContext.elevationProvider=y.elevationProvider,u.symbolCreationContext.notifyGraphicGeometryChanged=v=>u.notifyGraphicGeometryChanged(v),u.symbolCreationContext.notifyGraphicVisibilityChanged=v=>u.notifyGraphicVisibilityChanged(v);const f=(0,P.MF)(u.layer.elevationInfo,u.elevationFeatureExpressionEnabled);if(u.symbolCreationContext.featureExpressionInfoContext=yield(0,P.q6)(f,u._viewSpatialReference,h,N.A.getLogger(u)),(0,ie.Te)(h),u.symbolCreationContext.screenSizePerspectiveEnabled=y.screenSizePerspectiveEnabled&&!!u.layer.screenSizePerspectiveEnabled,u.symbolCreationContext.slicePlaneEnabled=!!u.owner.slicePlaneEnabled,u.symbolCreationContext.physicalBasedRenderingEnabled=!!u.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,u.symbolCreationContext.skipHighSymbolLods=!!u.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in u.owner){const{owner:v}=u;u.symbolCreationContext.drapeSourceRenderer=y.basemapTerrain.overlayManager.registerGeometryDrapeSource(v),u.addHandles((0,ae.hA)(()=>y.basemapTerrain.overlayManager.unregisterDrapeSource(v)))}u.addHandles([(0,F.wB)(()=>u.suspendedOrOutsideOfView,()=>u._updateQueue.unshift(()=>u._updateLayerVisibility(),null).catch(ie.QZ)),(0,F.wB)(()=>[u.layer?.screenSizePerspectiveEnabled,u.owner.view?.screenSizePerspectiveEnabled],()=>{const v=y.screenSizePerspectiveEnabled&&!!u.layer.screenSizePerspectiveEnabled;v!==u.symbolCreationContext.screenSizePerspectiveEnabled&&(u.symbolCreationContext.screenSizePerspectiveEnabled=v,u._labeler?.reset(),u.recreateAllGraphicsAndSymbols())}),(0,F.wB)(()=>u.owner.slicePlaneEnabled,v=>u._slicePlaneEnabledChange(!!v)),(0,F.wB)(()=>u.owner.view.state?.rasterPixelRatio,()=>u._pixelRatioChange()),(0,F.wB)(()=>!!u.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,v=>u._physicalBasedRenderingChange(v)),(0,F.wB)(()=>!!u.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,v=>u._skipHighSymbolLoDsChange(v)),(0,F.wB)(()=>u.owner.view.focusAreas.activePolygons,()=>u._updateFocusedLabels()),(0,F.wB)(()=>u.owner.view.focusAreas.style,()=>u.recreateAllGraphicsAndSymbols()),(0,F.z7)(()=>y.basemapTerrain?.tilingScheme,v=>{v.spatialReference.equals(u.symbolCreationContext.overlaySR)||null==y.basemapTerrain.spatialReference||(u.symbolCreationContext.overlaySR=y.basemapTerrain.spatialReference),u.hasHandles("loaded-graphics")?u.recreateAllGraphics():u.addHandles([(0,F.on)(()=>u.owner?.loadedGraphics,"change",O=>{u._graphicsCollectionChanged(O),u._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{u.recreateAllGraphics(),u._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),(0,F.wB)(()=>u.effectiveUpdatePolicy,v=>{null!=u.stageLayer&&(u.stageLayer.updatePolicy=v),u.symbolCreationContext.isAsync=u.effectiveUpdatePolicy===Ae.q.ASYNC,v===Ae.q.SYNC&&u.runTask(Ne.Bb)},F.pc)]),u._frameTaskHandle=y.resourceController.scheduler.registerTask(Ne.W6.GRAPHICS_CORE,u),u.layer&&"featureReduction"in u.layer&&u.addHandles((0,F.wB)(()=>u.layer.featureReduction,()=>u._deconflictor?.featureReductionChange())),u.notifyChange("averageSymbolComplexity"),u.rendererChange(u.owner.renderer).catch(()=>{}),u._initializeAbortController=null})()}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}_updateFocusedLabels(){this.forEachGraphics3DSymbol((u,h)=>{u.updateFocus(y=>{this.recreateGraphics([y.graphic])},h)})}destroy(){this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=(0,I.DC)(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=Ne.nu,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=(0,I.xt)(this._deconflictor),this._labeler=(0,I.xt)(this._labeler),this._elevationAlignment=(0,I.pR)(this._elevationAlignment),this._scaleVisibility=(0,I.pR)(this._scaleVisibility),this._filterVisibility=(0,I.pR)(this._filterVisibility),this._objectStates=(0,I.pR)(this._objectStates),this.clear(),this._featureStore=(0,I.pR)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,I.xt)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,I.pR)(this._graphicStateTracking),this.stage&&(this.stageLayer=(0,I.pR)(this.stageLayer),this.stage=null),this._set("owner",null);for(const u in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[u].reject(new M.A("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,I.xt)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,I.pR)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,I.pR)(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(u=>u.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(I.pR),this._symbols.clear(),this._symbolMaterials=null,this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(u,h){this.stage=u._stage,this.stageLayer=new Wr.x(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},h);const y=this.stageLayer.events;y.on("transformationChanged",g=>this.notifyGraphicGeometryChanged(g.graphicUid)),y.on("shaderTransformationChanged",g=>this.notifyGraphicGeometryChanged(g.graphicUid)),y.on("visibilityChanged",g=>this.notifyGraphicVisibilityChanged(g.graphicUid)),y.on("geometryAdded",g=>this.notifyGraphicGeometryChanged(g.object.graphicUid)),y.on("geometryRemoved",g=>this.notifyGraphicGeometryChanged(g.object.graphicUid)),y.on("attributesChanged",g=>(0,we.b)(g.attribute)&&this.notifyGraphicGeometryChanged(g.object.graphicUid))}notifyGraphicGeometryChanged(u){if(null==this._graphicStateTracking||null==u)return;const h=this.graphics3DGraphics.get(u);h&&this._graphicStateTracking.updateGraphicGeometry(h)}notifyGraphicVisibilityChanged(u){if(null==this._graphicStateTracking||null==u)return;const h=this.graphics3DGraphics.get(u);h&&this._graphicStateTracking.updateGraphicVisibility(h)}_updateLayerVisibility(){const y=!(this.suspendedOrOutsideOfView||this._numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*$r);y!==this._visible&&(this._visible=y,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){const u=this._visible&&(null==this.layer.opacity||this.layer.opacity>=jt.Q);this.stageLayer.visible!==u&&(this.stageLayer.visible=u,u?this.updateGraphicsVisibilities():this._hideAllGraphics())}getGraphics3DGraphicById(u){return null!=u?this.graphics3DGraphics.get(u):void 0}getGraphics3DGraphicByObjectId(u){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(u):null}_getGraphicObjectID(u,h=this.owner.layer?.objectIdField){return(0,ge.RW)(u,h)}get graphics3DGraphicsByObjectID(){const u=this.owner.layer?.objectIdField;if(!u)return;const h=new Map;return this.graphics3DGraphics.forEach(y=>{if(!y)return;const f=this._getGraphicObjectID(y.graphic,u);null!=f&&h.set(f,y)}),h}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}updateLabelingInfo(u){var h=this;return(0,T.A)(function*(){const y=h._deconflictor?.labelingInfoChange(u),g=h._labeler?.labelingInfoChange(u);yield Promise.allSettled([y,g])})()}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let u=!1,h=!1;for(const[y,g]of this._symbols)if(null!=g)switch(g.getFastUpdateStatus()){case Pe.G.Loading:return"unknown";case Pe.G.Fast:this._graphicsBySymbol.has(y)&&(h=!0);break;case Pe.G.Slow:this._graphicsBySymbol.has(y)&&(u=!0);break;case Pe.G.Mixed:this._graphicsBySymbol.has(y)&&(h=u=!0)}return h?u?"mixed":"fast":u?"slow":"mixed"}runTask(u){if(this._dataUpdateQueue.runTask(u),this._updateQueue.runTask(u),this._applyPendingUpdates(u),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!u.hasProgressed)return Nt.G}setObjectIdVisibility(u,h){h?this._objectIdInvisibleSet.delete(u):this._objectIdInvisibleSet.add(u);const y=this._findGraphics3DGraphicByObjectId(u);null!=y&&this._updateUserVisibility(y)}_findGraphics3DGraphicByObjectId(u){return(0,pe.$n)(this.graphics3DGraphics,h=>this._getGraphicObjectID(h.graphic)===u)}_updateUserVisibility(u){if(null==u)return!1;const h=u.graphic,y=this._getGraphicObjectID(h),g=h.visible&&!this.owner.suspended&&this.stageLayer.visible&&(null==y||!this._objectIdInvisibleSet.has(y));return u.setVisibilityFlag(xe.GRAPHIC,Oe.USER,g)}_whenGraphics3DGraphic(u){const h=this.graphics3DGraphics.get(u.uid);if(h)return Promise.resolve(h);const y=this._whenGraphics3DGraphicRequests[u.uid];if(y)return y.promise;const g=(0,ie.Tw)();return this._whenGraphics3DGraphicRequests[u.uid]=g,g.promise}_boundsForGraphics3DGraphic(u,h){var y=this;return(0,T.A)(function*(){const g=y._viewSpatialReference,f=y.owner.view.renderSpatialReference,v=y.owner.view.basemapTerrain.spatialReference,L=y._viewElevationProvider?{service:y._viewElevationProvider,useViewElevation:null!=h&&!!h.useViewElevation,minDemResolution:null!=h?h.minDemResolution:null,minDemResolutionForPoints:y.owner.view.resolution}:null,K=yield u.getProjectedBoundingBox(($,ce,$e)=>(0,et.projectBuffer)($,f,ce,$,g,ce,$e),($,ce,$e)=>(0,et.projectBuffer)($,v,ce,$,g,ce,$e),L,h?.signal);if(!K)return null;const V=K.boundingBox;if(K.requiresDrapedElevation){const $=y.symbolCreationContext.elevationProvider;if($){(0,q.gX)(V,Zt);const ce=$.getElevation(Zt[0],Zt[1],0,g,"ground")??0;V[2]=Math.min(V[2],ce),V[5]=Math.max(V[5],ce)}}return{boundingBox:V,screenSpaceObjects:K.screenSpaceObjects}})()}whenGraphicBounds(u,h){var y=this;return(0,T.A)(function*(){yield(0,F.C_)(()=>y.owner?.loadedGraphics);const g=y.owner.layer?.objectIdField,f=y.owner.loadedGraphics.find(S=>S===u||null!=g&&null!=S.attributes&&u.attributes&&S.attributes[g]===u.attributes[g]);if(!f)throw new M.A("internal:graphic-not-part-of-view","Graphic is not part of this view");const v=yield y._whenGraphics3DGraphic(f);return y._boundsForGraphics3DGraphic(v,h)})()}computeAttachmentOrigin(u,h){const y=this.graphics3DGraphics.get(u.uid);if(!y)return null;const g=y.computeAttachmentOrigin();if(0===g.render.num&&0===g.draped.num)return null;(0,ne.i)(Ke,0,0,0);let f=0;if(g.render.num>0){if(!(0,ut.F)(g.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ct,h))return null;(0,ne.g)(Ke,Ke,ct),f++}if(g.draped.num>0){const[v,S]=g.draped.origin,O=this._viewElevationProvider.getElevation(v,S,"ground")??0;if((0,ne.i)(ct,v,S,O),!(0,ut.F)(ct,this._viewElevationProvider.spatialReference,ct,h))return null;(0,ne.g)(Ke,Ke,ct),f++}return f>1&&(0,ne.h)(Ke,Ke,1/f),new mt.A({x:Ke[0],y:Ke[1],z:Ke[2],spatialReference:h})}getSymbolLayerSize(u,h){const y=this._symbols.get(u.id);if(null==y)throw new M.A("internal:symbol-not-part-of-view","Symbol is not part of this view");const g=u.symbolLayers.indexOf(h);if(-1===g)throw new M.A("internal:missing-symbol-layer","Symbol layer is not in symbol");const f=y.getSymbolLayerSize(g);if(null==f)throw new M.A("internal:missing-size","Symbol layer has no valid size");return f}_graphicsCollectionChanged(u){this._startCreateGraphics&&(this.add(u.added),this.remove(u.removed))}graphicUpdateHandler(u){const h=u.graphic.uid,y=this.graphics3DGraphics.get(h);if(null!=y||null!=this._graphicsWithoutSymbol.get(h))switch(u.property){case"visible":this._graphicUpdateVisibleHandler(y);break;case"geometry":this._graphicUpdateGeometryHandler(y,u);break;case"symbol":this._graphicUpdateSymbolHandler(y,u);break;case"attributes":break;case"origin-transform":this._graphicUpdateTransformHandler(y,u)}}_graphicUpdateGeometryHandler(u,h){this._graphicUpdateGeometryOrTransformHandler(u,h,()=>!(null==h.newValue||null==u||!u.graphics3DSymbol.updateGeometry(u,h.newValue)||!(this._labeler?.updateGraphicGeometry(u)??1)||(this._labeler?.setDirty(),0)));const y=h.graphic.geometry;null!=y&&this._expandComputedExtent(y)}_graphicUpdateTransformHandler(u,h){const y=h.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(u,h,()=>null!=h.newValue&&null!=u&&null!=y&&u.graphics3DSymbol.updateTransform(u,y.spatialReference,h.newValue,h.action))}_graphicUpdateGeometryOrTransformHandler(u,h,y){if(null!=h.graphic.geometry)if(null!=u)y()||this._recreateGraphic(u.graphic);else{const g=h.graphic.symbol?.id;if(g){const f=this._symbols.get(g);if(null!=f&&f.loadStatus===lt.P.LOADING)return}this._recreateGraphic(h.graphic)}else this._recreateGraphic(h.graphic)}_graphicUpdateSymbolHandler(u,h){const y=h.graphic,g=null!=u?u.graphics3DSymbol:null!=h.oldValue?this._symbols.get(h.oldValue.id):null;if(null==g||null==h.newValue)return void this._recreateGraphic(y);const f=g.symbol,v=this._getConvertedSymbol(h.newValue);if(null!=v&&(v.type!==f.type||"web-style"===v.type)||"web-style"===f.type)return void this._recreateGraphic(y);const S=this._graphicsBySymbol.get(f.id);if(S&&1!==S.size)return void this._recreateGraphic(y);const O=(0,se.Ui)(f,v);if(null==O)return void this._updateSymbolMapping(f.id,v);const L={diff:O,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(g.prepareSymbolPatch(L),!(0,se.Im)(L.diff))return void this._recreateGraphic(y);const K=this._getRenderingInfo(y);if(null==K)return void this._recreateGraphic(y);const V=g.extentPadding;for(const $ of L.symbolStatePatches)$();if(V!==g.extentPadding&&this._recomputeExtentPadding(),null!=u)for(const $ of L.graphics3DGraphicPatches)$(u,K);this._updateSymbolMapping(f.id,v)}_graphicUpdateVisibleHandler(u){this._updateUserVisibility(u)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(u){this._suspendSymbolCleanup=!0,this.remove(u),this.add(u),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===Ae.q.SYNC&&this._cleanupSymbols()}_recreateGraphic(u){this.recreateGraphics([u])}_beginGraphicUpdate(u){const h=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(u.uid,h),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),h}_endGraphicUpdate(u,h){u&&(h&&this._graphicStateTracking?.updateGraphicError(u,h),this._graphicsWaitingForSymbol.delete(u.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let u=0;this._symbols.forEach(h=>{null!=h&&(u=Math.max(u,h.extentPadding))}),this._set("extentPadding",u)}_expandComputedExtent(u){const h=Zr,y=u.spatialReference;(0,ge.w9)(u,h);const g=this._viewSpatialReference,f=Ht.tmpVec;if((0,De.aI)(y,g)||(0,j.L)(h[0],h[1],0,y,f,g)&&(h[0]=f[0],h[1]=f[1],(0,j.L)(h[3],h[4],0,y,f,g),h[3]=f[0],h[4]=f[1]),!(isFinite(h[0])&&isFinite(h[3])&&isFinite(h[1])&&isFinite(h[4])))return;const v=this.computedExtent;let S=null;const O=isFinite(h[2])&&isFinite(h[5]),L=O&&(null==v?.zmin||h[2]<v.zmin),K=O&&(null==v?.zmax||h[5]>v.zmax);v?(h[0]<v.xmin||h[1]<v.ymin||h[3]>v.xmax||h[4]>v.ymax||L||K)&&(S=this._propertiesPool.get("computedExtent"),S.xmin=Math.min(h[0],v.xmin),S.ymin=Math.min(h[1],v.ymin),S.xmax=Math.max(h[3],v.xmax),S.ymax=Math.max(h[4],v.ymax),S.spatialReference=g):(S=this._propertiesPool.get("computedExtent"),S.xmin=h[0],S.ymin=h[1],S.xmax=h[3],S.ymax=h[4],S.spatialReference=g),S&&(L&&(S.zmin=h[2]),K&&(S.zmax=h[5]),this._set("computedExtent",S))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}elevationInfoChange(){var u=this;return(0,T.A)(function*(){u._abortElevationInfoChange();const h=new AbortController;u._elevationInfoChangeAbortController=h;const y=(0,P.MF)(u.layer.elevationInfo,u.elevationFeatureExpressionEnabled);u.symbolCreationContext.featureExpressionInfoContext=yield(0,P.q6)(y,u._viewSpatialReference,h.signal,N.A.getLogger(u)),(0,ie.Te)(h.signal),u._elevationInfoChangeAbortController=null,u._labeler?.elevationInfoChange(),u.forEachGraphics3DSymbol((g,f,v)=>{g.globalPropertyChanged("elevationInfo",f)?f.forEach(S=>{const O=S.graphic,L=S.labelLayers;for(const K of L)K.graphics3DSymbolLayer.updateGraphicElevationContext(O,K)}):u._recreateSymbol(v)}),u.updateStageLayerElevationProvider(),u._elevationAlignment?.elevationInfoChange()})()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,I.WD)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new st({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,I.WD)(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(u=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:h,view:y}=this.owner,g=y.basemapTerrain.tilingScheme&&h?.length?h.toArray():null;!u&&g||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),g&&(u?this.add(g):this.recreateGraphics(g))}_recreateSymbol(u){const h=this._graphicsBySymbol.get(u),y=[];h&&(h.forEach((f,v)=>{const S=f.usedMemory;this._conditionalRemove(f,v),this._spatialIndex?.remove(f),y.push(f.graphic),f.destroy(),this._removeGraphics3DGraphic(v,S),this._updateLayerVisibility(),this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(u,new Map));const g=this._symbols.get(u);(0,I.pR)(g),this._symbols.delete(u),this._symbolMaterials=null,this.add(y)}_recreateGraphicsForSymbol(u){const h=this._graphicsBySymbol.get(u);if(h){const y=[];h.forEach(g=>y.push(g.graphic)),this.recreateGraphics(y)}}_conditionalRemove(u,h){this._graphicsDrapedUids.delete(h),this._objectStates?.removeGraphic(u),this._labeler?.removeGraphic(u),this._deconflictor?.removeGraphic(u),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(u)}add(u){u&&0!==u.length&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(u)===Ae.q.ASYNC?this._addDelayed(u):this._addImmediate(u),this.notifyChange("dataUpdating")):N.A.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(u){if(this.effectiveUpdatePolicy===Ae.q.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const h of u)if(null!=h.geometry&&"mesh"===h.geometry.type&&!h.geometry.loaded)return Ae.q.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(u){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const h of u)this._addGraphic(h,this._getRenderingInfo(h,N.A.getLogger(this)),Ae.q.SYNC);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(u){for(const h of u){const y=h.uid;let g=this._pendingUpdates.get(y);g?g.add?g.state!==be.NEW&&g.abortController?.abort():this._pendingAdds++:(g=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(y,g)),g.add=h}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(u){this.effectiveUpdatePolicy===Ae.q.ASYNC?this._removeDelayed(u):this._removeImmediate(u),this.notifyChange("dataUpdating")}_removeImmediate(u){for(const h of u)this._removeGraphic(h);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(u){for(const h of u){const y=h.uid,g=this._pendingUpdates.get(y);if(g)g.add&&(g.remove?g.add=null:this._pendingUpdates.delete(y),g.state===be.LOADING&&g.abortController?.abort(),this._pendingAdds--);else{const f=this._pendingUpdatesPool.pushNew();f.remove=h,this._pendingUpdates.set(y,f),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&N.A.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(u){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)return this._spatialIndex.update(),void u.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[h,y]of this._pendingUpdates){if(u.done){this._applyPendingRemovesFirst=!0;break}if(y.remove&&!y.add&&(this._pendingRemoves--,u.madeProgress(),this._removeGraphic(y.remove),y.remove=null,this._pendingUpdates.delete(h),0===this._pendingRemoves))break}}for(const[h,y]of this._pendingUpdates){if(u.done)break;y.add&&y.state===be.NEW&&this._processPendingUpdateNew(y);let g=this.effectiveUpdatePolicy;if(!y.remove||y.add&&y.state!==be.READY||(this._pendingRemoves--,u.madeProgress(),this._removeGraphic(y.remove),y.remove=null,g=Ae.q.SYNC),y.add)switch(y.state){case be.READY:this._addGraphic(y.add,y.renderingInfo,g),y.add=null,this._pendingAdds--,u.madeProgress();break;case be.REJECTED:y.add=null,this._pendingAdds--}null==y.remove&&null==y.add&&this._pendingUpdates.delete(h)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(u){if(!u.add)return void(u.state=be.READY);const h=u.add.geometry;null==h||"mesh"!==h.type||h.loaded?this._processPendingUpdateNewRenderingInfo(u):this._processPendingUpdateNewMesh(u,h)}_processPendingUpdateNewMesh(u,h){var y=this;return(0,T.A)(function*(){u.state=be.LOADING,u.abortController=new AbortController;const g=u.abortController.signal;try{yield h.load({signal:g})}catch(f){return y._processPendingUpdateNewError(u,f)}u.abortController=null,y._processPendingUpdateNewRenderingInfo(u)})()}_processPendingUpdateNewError(u,h){u.abortController=null,u.state=(0,ie.zf)(h)?be.NEW:be.REJECTED}_processPendingUpdateNewRenderingInfo(u){var h=this;return(0,T.A)(function*(){if(null==h.layer.renderer||"dictionary"!==h.layer.renderer.type)return u.renderingInfo=h._getRenderingInfo(u.add,N.A.getLogger(h)),void(u.state=be.READY);u.state=be.LOADING,u.abortController=new AbortController;let y=null;try{y=yield h._getRenderingInfoAsync(u.add,{signal:u.abortController.signal})}catch(g){return u.abortController=null,void(u.state=(0,ie.zf)(g)?be.NEW:be.REJECTED)}null==y?.symbol?(h._symbolWarningLogged||(h._symbolWarningLogged=!0,N.A.getLogger(h).warn(`Graphic in layer ${h.layer.id} has no symbol and will not render`)),u.renderingInfo=null):u.renderingInfo=y,u.state=be.READY})()}_addGraphic(u,h,y){if(this._graphicsWithoutSymbol.set(u.uid,u),null==h?.symbol||!(0,ge.N3)(u))return;const g=this.stage.renderView.olidRenderHelper;if(g&&this.setUidToIdOnAdd){const ce=(0,ji.ns)(this.owner.view.map,this.layer.uid);g.setUidToObjectAndLayerId(u.objectId,u.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!ce&&(0,Nr.d0)(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}const v=this.getOrCreateGraphics3DSymbol(h.symbol,h.renderer);if(null==v)return;this._expandComputedExtent(u.geometry);const S=this._beginGraphicUpdate(u),O=new Ki(u,h,this.layer);let L=!1;const K=ce=>{ce===v.symbol.id&&(L=!0)};this._whenSymbolRemoved.push(K);const V=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(K),this._graphicsWaitingForSymbol.get(u.uid)!==S||L||v.destroyed||this.graphicSymbolSupported&&u.symbol&&u.symbol.id!==v.symbol.id)--v.referenced,this._cleanupSymbols();else{const ce=this._createGraphics3DGraphic(v,O);this._spatialIndex&&null!=ce&&this._spatialIndex.add(ce),--v.referenced,this._endGraphicUpdate(u)}this._featureStore.events.emit("changed"),this._labeler?.setDirty()}},$=ce=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(K),L||((0,ie.zf)(ce)?this.add([u]):v.destroyed||this._endGraphicUpdate(u,ce)))};++this._loadingSymbols,y===Ae.q.ASYNC?v.load(()=>this._dataUpdateQueue.push(V,null).catch(ie.QZ),ce=>this._dataUpdateQueue.push(()=>$(ce),null).catch(ie.QZ)):v.load(V,$)}_removeGraphic(u){const h=u.uid,y=this.graphics3DGraphics.get(h);if(y){y.graphics3DSymbol.onRemoveGraphic(y);const g=y.usedMemory,f=y.isElevationSource;this._conditionalRemove(y,h),this._spatialIndex?.remove(y);const v=y.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(v)?.delete(h),this._graphicsWithoutSymbol.delete(h),this._removeGraphics3DGraphic(h,g,f),y.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(h),this._graphicsWaitingForSymbol.delete(h),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(u){if(u instanceof ti.A||u instanceof Vi.A){const h=this.symbolCreationContext.layer;return!!h.labelingInfo&&h.labelingInfo.some(y=>y.symbol===u)}return!1}_hasValidSymbolCreationContext(u){return!(u instanceof ti.A&&!this._hasLabelingContext(u)&&(N.A.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(u,h){const y=u.geometry;if(null==y)return h&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,h.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!(0,ft.canProjectWithoutEngine)(y.spatialReference,this._viewSpatialReference))return h&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,h.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=u.symbol)return h&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,h.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const g=this.rendererHasGeometryOperations?(0,re.wP)(u,this.layer):u;let f;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer))f=this.owner.getRenderingInfo(g,this.currentRenderer,this._arcadeOnDemand);else{const v=g.symbol||(0,zi.dX)(g.geometry);f=new qt.$(null,v)}return null==f?.symbol?(h&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,h.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):f}_getRenderingInfoAsync(u,h){if(null==u.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,N.A.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=u.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,N.A.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const y=this.rendererHasGeometryOperations?(0,re.wP)(u,this.layer):u;return this.owner.getRenderingInfoAsync(y,this.currentRenderer,this._arcadeOnDemand,h)}_createGraphics3DSymbol(u,h){if(!this._hasValidSymbolCreationContext(u))return null;const y=this._getConvertedSymbol(u);if(!y)return null;let g;if(null!=h&&"backgroundFillSymbol"in h&&h.backgroundFillSymbol){const v=(0,Te.t)(h.backgroundFillSymbol,{ignoreDrivers:!0});null!=v.symbol&&(g=v.symbol.symbolLayers)}const f=function Dr(u,h,y){return"point-3d"===u.type?new Ar(u,h,y):new fi(u,h,y)}(y,this.symbolCreationContext,g);return f.load(()=>{const v=f.extentPadding;v>this.extentPadding&&this._set("extentPadding",v),this.notifyChange("averageSymbolComplexity")},()=>{}),f}getOrCreateGraphics3DSymbol(u,h){let y=this._symbols.get(u.id);return void 0===y&&(y=this._unusedSymbolsCache.pop(u.id)??(u instanceof Bi.A?new Ir(u,f=>this._dataUpdateQueue.push(f,null),f=>this._createGraphics3DSymbol(f,h)):this._createGraphics3DSymbol(u,h)),this._symbols.set(u.id,y),this._symbolMaterials=null),null!=y&&++y.referenced,y}trackGraphicState(u){return null==this._graphicStateTracking&&(this._graphicStateTracking=new Rr(this)),this._graphicStateTracking.add(u)}_addGraphics3DGraphic(u){this._usedMemory+=u.usedMemory,this.graphics3DGraphics.set(u.graphic.uid,u),this._numberOfGraphics++,u.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(u,h,y=!1){this._usedMemory-=h,this.graphics3DGraphics.delete(u),this._numberOfGraphics--,y&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(u,h){const y=h.graphic;if(this._graphicsWithoutSymbol.delete(y.uid),!this._symbols.has(u.symbol.id))return this.add([y]),null;if(this.graphics3DGraphics.has(y.uid))return null;const g=u.createGraphics3DGraphic(h);if(null==g)return null;this._addGraphics3DGraphic(g);const f=u.symbol.id;if(this._graphicsBySymbol.has(f)||this._graphicsBySymbol.set(f,new Map),this._graphicsBySymbol.get(f).set(y.uid,g),g.isDraped&&this._graphicsDrapedUids.add(y.uid),g.centroid=null,null!=y.geometry&&"point"!==y.geometry.type&&(g.centroid=(0,wt.W$)(y.geometry,this._viewSpatialReference)),this._updateUserVisibility(g),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(g),null!=this._filterVisibility){const{defaultVisibility:S}=this._filterVisibility;g.setVisibilityFlag(xe.GRAPHIC,Oe.FILTER,S),S||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(g),this._labeler?.addGraphic(g),this._objectStates?.addGraphic(g),g.initialize(this.stageLayer),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(g);const v=this._whenGraphics3DGraphicRequests[y.uid];return v&&(delete this._whenGraphics3DGraphicRequests[y.uid],v.resolve(g)),this._symbolMaterials=null,g}rendererChange(u){var h=this;return(0,T.A)(function*(){if(h._rendererChangeAbortController=(0,I.DC)(h._rendererChangeAbortController),u!==h.currentRenderer)if(h._validateRenderer(u),null==u&&h._currentRendererChange(null,!1),vt(u))if(u?.arcadeRequired){const y=new AbortController;h._rendererChangeAbortController=y;const{arcadeUtils:g}=yield h._ensureArcade();(0,ie.Te)(y);const f=g.hasGeometryOperations(u);f&&(yield g.enableGeometryOperations(),(0,ie.Te)(y)),h.effectiveUpdatePolicy===Ae.q.ASYNC?yield h._updateQueue.push(()=>h._currentRendererChange(u,f),y.signal):h._currentRendererChange(u,f),h._rendererChangeAbortController=null}else if(h.effectiveUpdatePolicy===Ae.q.ASYNC){const y=new AbortController;h._rendererChangeAbortController=y,yield h._updateQueue.push(()=>h._currentRendererChange(u,!1),y.signal),h._rendererChangeAbortController=null}else h._currentRendererChange(u,!1);else h._currentRendererChange(u,!1)})()}_ensureArcade(){var u=this;return(0,T.A)(function*(){return null==u._arcadeOnDemand&&(u._arcadeOnDemand=yield(0,ei.lw)()),u._arcadeOnDemand})()}_currentRendererChange(u,h){this.currentRenderer=u,this.rendererHasGeometryOperations=h,this.symbolCreationContext.arcade=this._arcadeOnDemand;const y=this.symbolCreationContext.renderer;if(u===y)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==u)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const g=(0,se.Ui)(y,u);this._updateUnchangedSymbolMappings(g,u,y),this.symbolCreationContext.renderer=u,null!=g&&("complete"===g.type?this.recreateAllGraphicsAndSymbols():"partial"===g.type&&(this._applyRendererDiff(g,u,y)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(u){for(const h in u.diff)switch(h){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete u.diff[h];break;default:return!0}return!1}_applySymbolSetDiff(u,h,y){u=u||[],h=h||[];const g=[];for(const f of h){const v=this._graphicsBySymbol.get(f.id);v&&v.forEach((S,O)=>{const L=S.graphic,V=this._arcadeOnDemand;if(f===y.defaultSymbol&&y.getSymbol((0,re.wP)(L,this.layer instanceof oe.A?this.layer:null),{arcade:V})===y.defaultSymbol)return;const $=S.usedMemory;u.length||y.defaultSymbol?g.push(L):this._graphicsWithoutSymbol.set(O,L);const ce=this.graphics3DGraphics.get(O);this._conditionalRemove(ce,O),S.destroy(),v.delete(O),this._removeGraphics3DGraphic(O,$),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(S=>S(f.id))}(u.length||g.length)&&(this._graphicsWithoutSymbol.forEach(f=>g.push(f)),this._graphicsWithoutSymbol.clear(),this.add(g)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(u,h,y){const g=u.diff.defaultSymbol,f=u.diff.uniqueValueInfos;if(g||f){const v=f?f.added.map(O=>O.symbol).filter(le.Ru):[],S=f?f.removed.map(O=>O.symbol).filter(le.Ru):[];if(f)for(let O=0;O<f.changed.length;O++)v.push(f.changed[O].newValue.symbol),S.push(f.changed[O].oldValue.symbol);return g?(y.defaultSymbol&&S.push(y.defaultSymbol),h.defaultSymbol&&v.push(h.defaultSymbol)):y.defaultSymbol&&v.length&&S.push(h.defaultSymbol),this._applySymbolSetDiff(v,S,h),delete u.diff.defaultSymbol,delete u.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(u,h,y){if("unique-value"!==h?.type||"unique-value"!==y?.type||null!=u&&"partial"!==u.type)return[];const g=L=>null!=L?L.id:null,f=u&&u.diff,v=f?.defaultSymbol,S=f&&f.uniqueValueInfos;let O;if(S)O=S.unchanged.map(L=>({oldId:g(L.oldValue.symbol),newId:g(L.newValue.symbol)}));else{O=[];for(const L of y.uniqueValueInfos??[]){const K=g(L.symbol),V=h.uniqueValueInfos?.find($=>$.value===L.value);V&&K!==g(V.symbol)&&O.push({oldId:K,newId:g(V.symbol)})}}return!v&&y.defaultSymbol&&O.push({oldId:g(y.defaultSymbol),newId:g(h.defaultSymbol)}),O}_updateSymbolMapping(u,h){const y=null!=h&&h?"string"==typeof h?h:h.id:null;if(null==u||u===y)return;const g=this._graphicsBySymbol.get(u);this._graphicsBySymbol.delete(u),void 0!==g&&this._graphicsBySymbol.set(y,g);const f=this._symbols.get(u);if(void 0!==f&&(this._symbols.delete(u),this._symbols.set(y,f),this._symbolMaterials=null,null!=f)){const v="string"==typeof h?null:h;null!=v?f.symbol=v:f.symbol.id=y}}_updateUnchangedSymbolMappings(u,h,y){const g=this._calculateUnchangedSymbolMapping(u,h,y);for(const{oldId:f,newId:v}of g)this._updateSymbolMapping(f,v)}_applyRendererDiff(u,h,y){if(this._diffHasSymbolChange(u))return!1;if(h instanceof _t.A&&y instanceof _t.A&&this._applyUniqueValueRendererDiff(u,h,y)&&0===Object.keys(u.diff).length)return!0;for(const g of this._graphicsBySymbol.keys()){const f=this._symbols.get(g);if(null!=f)switch(f.applyRendererDiff(u,h)){case Pe.w.RecreateSymbol:this._recreateSymbol(g);break;case Pe.w.RecreateGraphics:this._recreateGraphicsForSymbol(g)}}return!0}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol((u,h)=>u.globalPropertyChanged("opacity",h))}_slicePlaneEnabledChange(u){u!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=u,this.stageLayer.sliceable=u,this.forEachGraphics3DSymbol((h,y)=>h.globalPropertyChanged("slicePlaneEnabled",y)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(u){this.symbolCreationContext.physicalBasedRenderingEnabled=u,this.forEachGraphics3DSymbol((h,y,g)=>{h.globalPropertyChanged("physicalBasedRenderingEnabled",y)||this._recreateSymbol(g)})}_skipHighSymbolLoDsChange(u){this.symbolCreationContext.skipHighSymbolLods=u,this.forEachGraphics3DSymbol((h,y,g)=>{h.globalPropertyChanged("skipHighSymbolLods",y)||this._recreateSymbol(g)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((u,h,y)=>{u.globalPropertyChanged("pixelRatio",h)||this._recreateSymbol(y)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,Qe._)(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(u,h){const y=this.symbolCreationContext.clippingExtent,g=(0,Q.vt)();return this.symbolCreationContext.clippingExtent=function Br(u,h,y){if(null==u||null==y)return!1;let g=!0;return fe[0]=null!=u.xmin?u.xmin:0,fe[1]=null!=u.ymin?u.ymin:0,fe[2]=null!=u.zmin?u.zmin:0,g=g&&(0,et.projectBuffer)(fe,u.spatialReference,0,fe,y,0),h[0]=fe[0],h[1]=fe[1],fe[0]=null!=u.xmax?u.xmax:0,fe[1]=null!=u.ymax?u.ymax:0,fe[2]=null!=u.zmax?u.zmax:0,g=g&&(0,et.projectBuffer)(fe,u.spatialReference,0,fe,y,0),h[2]=fe[0],h[3]=fe[1],null==u.xmin&&(h[0]=-1/0),null==u.ymin&&(h[1]=-1/0),null==u.xmax&&(h[2]=1/0),null==u.ymax&&(h[3]=1/0),g}(u,g,h)?(0,q.Jt)((0,q.vt)(),g):null,!(0,q.aI)(this.symbolCreationContext.clippingExtent,y)}modifyGraphics3DGraphicVisibilities(u){if(this.destroyed)return;let h=!1;this.graphics3DGraphics.forEach(y=>{u(y)&&(h=!0)}),h&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(u){for(const[h,y]of this._symbols){if(null==y)return;u(y,this._graphicsBySymbol.get(h)||Yr,h)}}updateGraphicsVisibilities(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(u=>{const h=this._updateUserVisibility(u),y=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(u);return h||y})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(u=>u.setVisibilityFlag(xe.GRAPHIC,Oe.USER,!1))}_validateRenderer(u){const h=()=>`'${this.layer.title?`${this.layer.title}, `:""}id:${this.layer.id}'`,y=function Lt(u,h){if(null==u)return null;if(!vt(u))return new M.A("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${u.type||u.declaredClass}'`,{renderer:u});switch(u.type){case"simple":return function It(u,h){const y={...Te.c,...h,cimFallbackEnabled:!0};return pt(u,(0,Te.t)(u.symbol,y).error)}(u,h);case"unique-value":return function Se(u,h){const y={...Te.c,...h,cimFallbackEnabled:!0},g=u.uniqueValueInfos?.map(v=>(0,Te.t)(v.symbol,y).error).filter(le.Ru),f=(0,Te.t)(u.defaultSymbol,y);return f.error&&g?.unshift(f.error),pt(u,g)}(u,h);case"class-breaks":return function Fi(u,h){const y={...Te.c,...h,cimFallbackEnabled:!0},g=u.classBreakInfos.map(v=>(0,Te.t)(v.symbol,y).error).filter(le.Ru),f=(0,Te.t)(u.defaultSymbol,y);return f.error&&g.unshift(f.error),pt(u,g)}(u,h);case"dictionary":case"heatmap":return null}return null}(u,{geometryType:this.layer?.geometryType,logWarning:(g,f)=>N.A.getLogger(this).warn(g,`Symbology conversion for layer ${h()}: ${f}`)});if(y){const g=`Renderer for layer ${h} is not supported in a SceneView`;N.A.getLogger(this).warn(g,y.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let u=!1;this._symbols.forEach((h,y)=>{if(null==h||h.referenced>0)return;const g=this._graphicsBySymbol.get(y);g&&0!==g.size||(this._graphicsBySymbol.delete(y),this._symbols.delete(y),this._symbolMaterials=null,this._unusedSymbolsCache.put(y,h,Ee.Ti),u=!0)}),u&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){}get performanceInfo(){return new Gr(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};var be;X.tmpVec=(0,w.vt)(),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"computedExtent",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"currentRenderer",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"rendererHasGeometryOperations",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_frameTaskHandle",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_dataUpdateQueue",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_updateQueue",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"_viewSpatialReference",null),(0,b._)([(0,E.MZ)()],X.prototype,"_rendererChangeAbortController",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_elevationInfoChangeAbortController",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_initializeAbortController",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_elevationAlignment",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_scaleVisibility",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_filterVisibility",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_initializePromise",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_spatialIndex",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"extentPadding",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_featureStore",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_objectStates",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_loadingSymbols",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"preferredUpdatePolicy",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_forcedUpdatePolicy",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"effectiveUpdatePolicy",null),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"elevationFeatureExpressionEnabled",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"owner",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"layer",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"graphicSymbolSupported",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"componentFactories",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"setUidToIdOnAdd",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"featureStore",null),(0,b._)([(0,E.MZ)()],X.prototype,"initializePromise",null),(0,b._)([(0,E.MZ)()],X.prototype,"scaleVisibility",null),(0,b._)([(0,E.MZ)()],X.prototype,"elevationAlignment",null),(0,b._)([(0,E.MZ)()],X.prototype,"objectStates",null),(0,b._)([(0,E.MZ)()],X.prototype,"filterVisibility",null),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"updating",null),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"dataUpdating",null),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"running",null),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"suspendedOrOutsideOfView",null),(0,b._)([(0,E.MZ)({readOnly:!0,dependsOn:[]})],X.prototype,"updatingRemaining",null),(0,b._)([(0,E.MZ)({readOnly:!0})],X.prototype,"displayFeatureLimit",null),(0,b._)([(0,E.MZ)({readOnly:!0,dependsOn:[]})],X.prototype,"averageSymbolComplexity",null),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"hasZ",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],X.prototype,"hasM",void 0),(0,b._)([(0,E.MZ)()],X.prototype,"_objectIdField",null),X=Ht=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.Graphics3DCore")],X),function(u){u[u.NEW=0]="NEW",u[u.LOADING=1]="LOADING",u[u.READY=2]="READY",u[u.REJECTED=3]="REJECTED"}(be||(be={}));class Kr{constructor(){this.add=null,this.renderingInfo=null,this.state=be.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=be.NEW,this.abortController=null,this.remove=null}}const $r=10,Ke=(0,w.vt)(),ct=(0,w.vt)(),Yr=new Map;class Xr{constructor(){this._extents=new he.A({allocator:h=>h||(0,Q.vt)()}),this._tmpExtent=(0,Q.vt)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(h){this._contains(h)||(this._removeContained(h),(0,Q.C)(this._extents.pushNew(),h),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(h){return this._mergeTight(h),h.hasProgressed}_mergeTight(h=Ne.Bb){const y=this._extents,g=new Set;let f=0;for(;f!==y.length;){y.sort((v,S)=>v[0]-S[0]),f=y.length,g.clear();for(let v=0;v<y.length;++v){if(h.done)return;const S=y.at(v);if(S){for(let O=v+1;O<y.length;++O){const L=y.at(O);if(null==L||L[0]>=S[2])break;g.add(L)}g.forEach(O=>{if(S===O)return;if(O[2]<=S[0])return void g.delete(O);const L=(0,Q.Wc)(S),K=(0,Q.Wc)(O),V=this._tmpExtent;(0,Q.fT)(S,O,V);const $=L+K;((0,Q.Wc)(V)-$)/$<.05&&((0,Q.C)(S,V),g.delete(O),y.remove(O),h.madeProgress())}),g.add(S)}}}this._dirty=!1}_contains(h){return this._extents.some(y=>(0,Q.gR)(y,h))}_removeContained(h){this._extents.filterInPlace(y=>!(0,Q.gR)(h,y))}get test(){}}let ke=class extends H.A{constructor(u){super(u),this._dirtyExtents=new Xr,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new Gt.A}initialize(){const u=this.elevationProvider;this._task=this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(Si(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([u.on("elevation-change",y=>this._elevationChanged(y)),(0,F.wB)(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,(0,F.wB)(()=>Si(this.graphicsCore.layer.elevationInfo?.mode),y=>this._task.priority=y)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(u){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,u.madeProgress()),u.run(()=>this._dirtyExtents.merge(u));this.running&&!u.done;)this._updateDirtyGraphics(u),this._updateDirtyExtents(u);this.notifyChange("updating")}_updateDirtyGraphics(u){const h=this.graphicsCoreOwner.view.renderCoordsHelper,y=this.graphicsCore.effectiveUpdatePolicy===Ae.q.ASYNC;for(const g of this._dirtyGraphicsSet.keys()){const f=this.graphicsCore.getGraphics3DGraphicById(g);if(this._dirtyGraphicsSet.delete(g),null!=f&&(f.alignWithElevation(this.elevationProvider,h,y),this.graphicsCore.deconflictor?.setDirty(),u.madeProgress()),u.done)return}}_updateDirtyExtents(u){for(;!this._dirtyExtents.empty&&!u.done;){const h=this._dirtyExtents.pop(),y=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:h,spatialReference:y});const g=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(h,y,f=>{const v=this.graphicsCore.getGraphics3DGraphicById(f);null!=v&&v.needsElevationUpdates()&&this._dirtyGraphicsSet.add(f)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-g)+.9*this._averageExtentUpdateSize,u.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((u,h)=>this._dirtyGraphicsSet.add(h))}_elevationChanged(u){if("scene"===u.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const h=u.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const y=this.graphicsCore.computedExtent;y&&h[2]>y.xmin&&h[0]<y.xmax&&h[3]>y.ymin&&h[1]<y.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",u)}else h[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(h),this.notifyChange("updating")}};function Si(u){return null==u?Ne.W6.ELEVATION_ALIGNMENT:"relative-to-scene"===u?Ne.W6.ELEVATION_ALIGNMENT_SCENE:Ne.W6.ELEVATION_ALIGNMENT}(0,b._)([(0,E.MZ)()],ke.prototype,"graphicsCoreOwner",void 0),(0,b._)([(0,E.MZ)()],ke.prototype,"graphicsCore",void 0),(0,b._)([(0,E.MZ)()],ke.prototype,"queryGraphicUIDsInExtent",void 0),(0,b._)([(0,E.MZ)()],ke.prototype,"elevationProvider",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],ke.prototype,"updating",null),(0,b._)([(0,E.MZ)({readOnly:!0})],ke.prototype,"updatingRemaining",null),ke=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],ke);var Kt=_(87477),Jr=_(69690),Ci=_(69287),kr=_(92771),Ei=_(62789),qr=_(83675),Ve=_(91421),xi=_(71548),Fe=_(93617),Pi=_(55703);function es(u,h,y,g){return function Ai(u,h,y,g){g.clip[0]=0,g.clip[1]=y?g.len:Number.MAX_VALUE;for(let f=0;f<u.length;f++)if(!is(u[f],h,g))return!1;return!0}(u,h,y,function Oi(u,h,y,g){const f=ts;return u?(y&&g&&(f.len=(0,ne.j)(h,y)),(0,ne.c)(f.dir,u)):g?(f.len=(0,ne.j)(h,y),(0,ne.d)(f.dir,y,h),(0,ne.h)(f.dir,f.dir,1/f.len)):((0,ne.d)(f.dir,y,h),(0,ne.n)(f.dir,f.dir)),f}(g,h,y,!0))}const ts={dir:(0,w.vt)(),len:0,clip:(0,yi.vt)()};function is(u,h,y){const g=(0,ne.f)((0,Fe.Qj)(u),y.dir),f=-(0,Fe.mN)(u,h);if(f<0&&g>=0)return!1;if(g>-1e-6&&g<1e-6)return f>0;if((f<0||g<0)&&!(f<0&&g<0))return!0;const v=f/g;return g>0?v<y.clip[1]&&(y.clip[1]=v):v>y.clip[0]&&(y.clip[0]=v),y.clip[0]<=y.clip[1]}const Di=.5*Math.PI,rs=Di/Math.PI*180;class ss{constructor(h){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,w.vt)(),direction:(0,w.vt)()},this._renderCoordsHelper=h.renderCoordsHelper;for(let y=0;y<4;y++)this._extent[y]={origin:(0,w.vt)(),direction:(0,w.vt)(),cap:{next:null,direction:(0,w.vt)()}},this._planes[y]=(0,Fe.vt)();this._planes[Ve.FB.NEAR]=(0,Fe.vt)(),this._planes[Ve.FB.FAR]=(0,Fe.vt)(),this._planesWithoutFar=this._planes.slice(0,5)}update(h,y,g,f=!0){const v=this._extent;this._toRenderBoundingExtent(h,y,g),(0,ne.g)(this._center.origin,v[0].origin,v[2].origin),(0,ne.h)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),f||(0,ne.h)(this._center.direction,this._center.direction,-1);for(let S=0;S<4;S++){const O=v[S];this._renderCoordsHelper.worldUpAtPosition(O.origin,O.direction);const L=v[3===S?0:S+1];O.cap.next=L.origin,(0,ne.o)(O.cap.direction,O.origin,L.origin),(0,Fe.mR)(O.direction,O.cap.direction,O.origin,this._planes[S]),f||(0,ne.h)(O.direction,O.direction,-1)}(0,Fe.mR)(v[0].cap.direction,v[1].cap.direction,v[0].origin,this._planes[Ve.FB.NEAR]),f?(0,Fe.ze)(this._planes[Ve.FB.NEAR],this._planes[Ve.FB.FAR]):((0,Fe.C)(this._planes[Ve.FB.FAR],this._planes[Ve.FB.NEAR]),(0,Fe.ze)(this._planes[Ve.FB.NEAR],this._planes[Ve.FB.NEAR])),this._maxSpan=Math.max(Math.abs(h[0]-h[2]),Math.abs(h[1]-h[3])),this._maxSpanSpatialReference=y,this._minGlobalAltitude=.9*(0,Kt.tO)(this._maxSpanSpatialReference).radius}isVisibleInFrustum(h,y,g=!1){if(null==h)return!1;if(this._renderCoordsHelper.viewingMode===St.RT.Global){if(this._maxSpan>(this._maxSpanSpatialReference.isGeographic?rs:Di*y))return!0;if(null!=h.altitude&&h.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(h)}if(0===this._maxSpan){const v=this._extent[0];return!(g||!h.intersectsRay((0,Pi.LV)(v.origin,v.direction)))}for(let v=0;v<this._extent.length;v++){const S=this._extent[v];if(!g&&h.intersectsRay((0,Pi.LV)(S.origin,S.direction))||h.intersectsLineSegment((0,xi.Cr)(S.origin,S.cap.next,as),S.cap.direction))return!0}const f=g?this._planes:this._planesWithoutFar;for(let v=0;v<h.lines.length;v++){const S=h.lines[v];if(es(f,S.origin,S.endpoint,S.direction))return!0}return!1}_toRenderBoundingExtentGlobal(h,y,g){(0,Q.gX)(h,Be),Be[2]=g,(0,qr.l)(y,Be,$t,this._renderCoordsHelper.spatialReference),(0,kr.B8)(Li,$t),(0,q.Ie)(Ge);for(const{x0:v,x1:S,y0:O,y1:L}of ns)for(let K=0;K<5;K++){const V=K/4;Be[0]=(0,Ci.Cc)(h[v],h[S],V),Be[1]=(0,Ci.Cc)(h[O],h[L],V),Be[2]=g,(0,ut.F)(Be,y,Be,this._renderCoordsHelper.spatialReference),(0,ne.t)(Be,Be,Li),(0,q.iT)(Ge,Be)}(0,ne.i)(this._extent[0].origin,Ge[0],Ge[1],Ge[2]),(0,ne.i)(this._extent[1].origin,Ge[3],Ge[1],Ge[2]),(0,ne.i)(this._extent[2].origin,Ge[3],Ge[4],Ge[2]),(0,ne.i)(this._extent[3].origin,Ge[0],Ge[4],Ge[2]);for(let v=0;v<4;++v)(0,ne.t)(this._extent[v].origin,this._extent[v].origin,$t)}_toRenderBoundingExtentLocal(h,y,g){xt(h,y,qe,this._renderCoordsHelper.spatialReference),(0,ne.i)(this._extent[0].origin,qe[0],qe[1],g),(0,ne.i)(this._extent[1].origin,qe[2],qe[1],g),(0,ne.i)(this._extent[2].origin,qe[2],qe[3],g),(0,ne.i)(this._extent[3].origin,qe[0],qe[3],g)}_toRenderBoundingExtent(h,y,g){switch(this._renderCoordsHelper.viewingMode){case St.RT.Global:this._toRenderBoundingExtentGlobal(h,y,g);break;case St.RT.Local:this._toRenderBoundingExtentLocal(h,y,g);break;default:(0,Jr.Xb)(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(h){if((0,Fe.mN)(h.planes[Ve.FB.NEAR],this._center.origin)<0&&(0,ne.f)(this._center.direction,h.direction)<0)return!0;for(let y=0;y<4;y++){const g=this._extent[y];if((0,Fe.mN)(h.planes[Ve.FB.NEAR],g.origin)<0&&(0,ne.f)(g.direction,h.direction)<0)return!0}return!1}}const ns=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Be=(0,w.vt)(),$t=(0,Ei.vt)(),Li=(0,Ei.vt)(),Ge=(0,q.vt)(),qe=(0,Q.vt)(),as=(0,xi.vt)();let ht=class extends H.A{constructor(u){super(u),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:u}=this;this._extentIntersection=new ss({renderCoordsHelper:u.view.renderCoordsHelper});const h=u.view,y=h.basemapTerrain,g=h.resourceController.scheduler;this.addHandles([h.on("resize",()=>this._viewChange()),(0,F.wB)(()=>h.state.camera,()=>this._viewChange(),F.OH),g.registerTask(Ne.W6.FRUSTUM_VISIBILITY,this),(0,F.wB)(()=>y.visibleElevationBounds,()=>this._elevationBoundsChange())]),"local"===h.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([(0,F.wB)(()=>[y.baseOpacity,y.wireframe,h.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),F.Vh)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(u){this._extent=u,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(u){this._isVisibleBelowSurfaceInternal=u,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const u=this.graphicsCoreOwner.view;this._isVisibleBelowSurface="local"===u.viewingMode||!u.basemapTerrain.opaque||"none"===u.map.ground?.navigationConstraint?.type}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const u=this.graphicsCoreOwner.view;let h;if(this._isVisibleBelowSurfaceInternal)h=-.3*(0,Kt.tO)(u.spatialReference).radius;else{const{min:y,max:g}=u.basemapTerrain.visibleElevationBounds;h=y-Math.max(1,(g-y)*(1.2-1))}this._extentIntersection.update(this._extent,u.spatialReference,h)}get running(){return this.updating}runTask(u){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),Nt.G;this._updateExtentIntersection();const h=this.graphicsCoreOwner.view.frustum,y=(0,Kt.tO)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(h,y)),u.madeProgress()}};(0,b._)([(0,E.MZ)({readOnly:!0})],ht.prototype,"suspended",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],ht.prototype,"graphicsCoreOwner",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],ht.prototype,"updating",void 0),ht=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],ht);var Ot=_(67496);class Yt{}class ls extends Yt{constructor(h,y){super(),this.objectStateId=h,this.object=y}remove(){this.object.removeStateID(this.objectStateId)}}class cs extends Yt{constructor(h,y,g){super(),this.objectStateId=h,this.object=y,this.owner=g}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}}class hs extends Yt{constructor(h,y){super(),this.objectStateId=h,this._removeCallback=y,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class Ii{constructor(){this._items=[]}addObject(h,y){this._items.push(new ls(y,h))}addRenderGeometry(h,y,g){this._items.push(new cs(y,h,g))}addExternal(h,y){this._items.push(new hs(y,h))}remove(h){this._remove(y=>y.objectStateId===h)}removeByObject(h){this._remove(y=>y.object===h)}removeAll(){this._items.forEach(h=>h.remove()),this._items=[]}_remove(h){const{_items:y}=this;for(let g=y.length-1;g>=0;--g){const f=y[g];h(f)&&(f.remove(),y.splice(g,1))}}}class ds extends Ii{constructor(){super(...arguments),this.stateType=Ot.Mg.MaskOccludee}}class us extends Ii{constructor(h){super(),this.highlightName=h,this.stateType=Ot.Mg.Highlight}}class Gi{constructor(h){this.objectIdField=h,this.ids=new Set,this.paused=!1}hasGraphic(h){return this.ids.has(this.objectIdField?h.graphic.attributes[this.objectIdField]:h.graphic.uid)}}class ps extends Gi{constructor(h){super(h),this.stateType=Ot.Mg.MaskOccludee,this.objectStateSet=new ds}}class ys extends Gi{constructor(h,y){super(y),this.highlightName=h,this.stateType=Ot.Mg.Highlight,this.objectStateSet=new us(h)}}class gs{constructor(h){this._graphicsCore=h,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(h=>h.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(h){const y=new ps(h);this._stateSets.push(y);const g=(0,ae.hA)(()=>this.releaseSet(y));return{set:y,handle:g}}acquireHighlightSet(h,y){const g=new ys(h,y);this._stateSets.push(g);const f=(0,ae.hA)(()=>this.releaseSet(g));return{set:g,handle:f}}releaseSet(h){h.objectStateSet.removeAll();const y=this._stateSets?this._stateSets.indexOf(h):-1;-1!==y&&this._stateSets.splice(y,1)}setUid(h,y){h.ids.add(y);const g=this._graphicsCore.graphics3DGraphics.get(y);g&&g.addObjectStateSet(h.objectStateSet)}setUids(h,y){y.forEach(g=>this.setUid(h,g))}setObjectIds(h,y){y.forEach(g=>h.ids.add(g)),this._initializeSet(h)}addGraphic(h){this._stateSets.forEach(y=>{!y.paused&&y.hasGraphic(h)&&h.addObjectStateSet(y.objectStateSet)})}removeGraphic(h){this._stateSets.forEach(y=>{y.hasGraphic(h)&&h.removeObjectState(y.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(h=>h.objectStateSet.removeAll())}_initializeSet(h){const y=this._graphicsCore.graphics3DGraphics;h.objectIdField?y.forEach(g=>{g&&h.hasGraphic(g)&&g.addObjectStateSet(h.objectStateSet)}):h.ids.forEach(g=>{const f=y.get(g);f&&f.addObjectStateSet(h.objectStateSet)})}get test(){}}var Ri=_(6558);let je=class extends H.A{constructor(u){super(u),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new ye.U,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive(),this.addHandles(this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(Ne.W6.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(u){const h=this.graphicsCoreOwner.view.spatialReference,y=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(h===y)this._extent=u??null;else{const g=(0,Q.vt)();this._extent=xt(u,h,g,y)?g:null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const u=this.layer,h=u.effectiveScaleRange;let y=this.layerScaleEnabled&&null!=h&&Mi(h.minScale,h.maxScale);u.labelingInfo&&!y&&(y=u.labelingInfo.some(f=>f&&Mi(f.minScale??0,f.maxScale??0)));const g=this._scaleRangeActive!==y;return this._scaleRangeActive=y,y&&!this.hasHandles(yt)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",f=>this._scaleUpdateHandler(f)),yt),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),yt)):!y&&this.hasHandles(yt)&&this.removeHandles(yt),g}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(u){const h=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&h&&h.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return Nt.G;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:y,maxScale:g}=this.layer.effectiveScaleRange;h.queryVisibleScaleRange(this._extent,y,g,f=>this._finishUpdate(f))}}else this._finishUpdate(!0);u.madeProgress()}_finishUpdate(u){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!u),this._dirty=!1}_visibleAtLayerScale(u){const h=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,Ri.JU)(u,h.minScale||0,h.maxScale||0)}_visibleAtLabelScale(u,h){return(0,Ri.JU)(u,h.minScale||0,h.maxScale||0)}_graphicScale(u){let h;return null!=u.centroid?h=u.centroid:null!=u.graphic.geometry&&"point"===u.graphic.geometry.type&&(h=u.graphic.geometry),h?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(h):1:null}_graphicVisible(u){if(!this.layerScaleEnabled)return!0;const h=this._graphicScale(u);return this._visibleAtLayerScale(h)}updateVisibility(u){if(this._scaleRangeActive){const h=this._graphicVisible(u);return u.setVisibilityFlag(xe.GRAPHIC,Oe.SCALE_RANGE,h)}return!1}updateGraphicLabelScaleVisibility(u){if(!this._scaleRangeActive||!u.labelLayers||0===u.labelLayers.length)return!1;const h=this._graphicScale(u),y=this._updateLabelScaleVisibility(u,h);return y&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),y}_updateLabelScaleVisibility(u,h){if(!u.labelLayers||0===u.labelLayers.length)return!1;const y=u.labelLayers[0]._labelClass;if(null!=y?.minScale&&null!=y.maxScale){const g=this._visibleAtLabelScale(h,y);if(u.setVisibilityFlag(xe.LABEL,Oe.SCALE_RANGE,g))return!0}return!1}_scaleUpdateHandler(u){if(this._setDirty(),!this.graphicsCore.visible)return;const h=u.extent,y=u.scale,g=this._visibleAtLayerScale(y);let f=!1;const v=this.graphicsCoreOwner.view.spatialReference,S=u.spatialReference;if(null==S)return void N.A.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const O=!S.equals(v);!O||xt(h,S,wi,v)?(this.queryGraphicUIDsInExtent(O?wi:h,v,K=>{const V=this.graphicsCore.getGraphics3DGraphicById(K);if(null==V)return;const $=V.centroid;null!=$&&(h[0]>$.x||h[1]>$.y||h[2]<$.x||h[3]<$.y)||(V.setVisibilityFlag(xe.GRAPHIC,Oe.SCALE_RANGE,g)&&(f=!0),this._updateLabelScaleVisibility(V,y)&&(f=!0))}),f&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())):N.A.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+S+" to wkid "+v)}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(u=>u.setVisibilityFlag(xe.GRAPHIC,Oe.SCALE_RANGE,!0)):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}};function Mi(u,h){return u>0||h>0}(0,b._)([(0,E.MZ)()],je.prototype,"graphicsCoreOwner",void 0),(0,b._)([(0,E.MZ)()],je.prototype,"layer",void 0),(0,b._)([(0,E.MZ)()],je.prototype,"queryGraphicUIDsInExtent",void 0),(0,b._)([(0,E.MZ)()],je.prototype,"graphicsCore",void 0),(0,b._)([(0,E.MZ)()],je.prototype,"basemapTerrain",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],je.prototype,"layerScaleEnabled",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],je.prototype,"suspended",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],je.prototype,"updating",null),(0,b._)([(0,E.MZ)()],je.prototype,"_dirty",void 0),je=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],je);const yt="terrain-events",wi=(0,Q.vt)();var ms=_(31178),fs=_(68778);const bs=[];(0,ae.hA)();let me=class extends H.A{constructor(u){super(u),this.type="graphics-3d",this.graphicsCore=null,this.drapeSourceType=ve.Om.Features,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null,this._updatingHandles=new ye.U}initialize(){const{layer:u}=this,h="effectiveScaleRange"in u?u:null,g=new X({owner:this,layer:this.owner.layer,preferredUpdatePolicy:Ae.q.SYNC,graphicSymbolSupported:!0,componentFactories:{elevationAlignment:(f,v)=>new ke({graphicsCoreOwner:this,graphicsCore:f,queryGraphicUIDsInExtent:v,elevationProvider:this.view.elevationProvider}),scaleVisibility:this.scaleVisibilityEnabled&&null!=h?(f,v)=>new je({graphicsCoreOwner:this,layer:h,queryGraphicUIDsInExtent:v,graphicsCore:f,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:f=>new gs(f)}});if(this._set("graphicsCore",g),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new ht({graphicsCoreOwner:this})),"fullOpacity"in this.owner){const f=this.owner;this._updatingHandles.add(()=>f.fullOpacity,()=>this.graphicsCore.opacityChange())}if("elevationInfo"in u){const f=u;this._updatingHandles.add(()=>f.elevationInfo,(v,S)=>{(0,se.Ui)(v,S)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set("initializePromise",this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}_initializeAsync(){var u=this;return(0,T.A)(function*(){try{yield u.graphicsCore.initializePromise}catch(h){if((0,ie.zf)(h))return;throw h}u.destroyed||(u.addHandles((0,F.wB)(()=>u.view.clippingArea,()=>u._updateClippingExtent(),F.OH)),u._updateClippingExtent(),u._setupSuspendResumeExtent(),u.graphicsCore.startCreateGraphics())})()}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",(0,I.pR)(this.frustumVisibility)),this._set("graphicsCore",(0,I.pR)(this.graphicsCore))}get layer(){return this.owner.layer}get view(){return this.owner.view}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get scaleVisibilitySuspended(){return!(null==this.scaleVisibility||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return null!=this.frustumVisibility&&this.frustumVisibility.suspended}get suspended(){return this.owner.suspended??!1}get updating(){return!!(this.graphicsCore?.updating||null!=this.scaleVisibility&&this.scaleVisibility.updating||null!=this.frustumVisibility&&this.frustumVisibility.updating||this._updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(u){this.graphicsCore.notifyGraphicGeometryChanged(u)}notifyGraphicVisibilityChanged(u){this.graphicsCore.notifyGraphicVisibilityChanged(u)}getRenderingInfo(u,h,y){const g=(0,ue.vl)(u,{renderer:h,arcade:y});if(g?.color){const f=g.color;f[0]=f[0]/255,f[1]=f[1]/255,f[2]=f[2]/255}return g}getRenderingInfoAsync(u,h,y,g){return(0,ue.LO)(u,{renderer:h,arcade:y,...g})}getHit(u){if(this.owner.loadedGraphics){const h=this.owner.loadedGraphics.find(y=>y.uid===u);if(h){const g=(0,re.wP)(h,this.layer instanceof oe.A?this.layer:null);return{type:"graphic",graphic:g,layer:g.layer}}}return null}whenGraphicBounds(u,h){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(u,h):Promise.reject()}computeAttachmentOrigin(u,h){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(u,h):null}getSymbolLayerSize(u,h){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(u,h):null}maskOccludee(u){const h=this.graphicsCore?.objectStates;if(!h)return(0,ae.hA)();const{set:y,handle:g}=h.acquireOccludeeSet(null);return h.setUid(y,u.uid),g}highlight(u,h){const y=this.graphicsCore?.objectStates;if(!y||u instanceof Ce.A)return At;const g=function _s(u){return ms.A.isCollection(u)?u.toArray():Array.isArray(u)?u:function vs(u){return"number"==typeof u||"string"==typeof u}(u)||(0,fs.DU)(u)||function Ss(u){return"esri.views.3d.layers.i3s.PointCloudGraphic"===u.declaredClass}(u)?[u]:bs}(u);if(0===g.length)return At;if(g[0]instanceof R.A){const f=g.map(O=>O.uid),{set:v,handle:S}=y.acquireHighlightSet(h,null);return y.setUids(v,f),S}if("number"==typeof g[0]){const f=g,{set:v,handle:S}=y.acquireHighlightSet(h,null);return y.setObjectIds(v,f),S}return At}_setupSuspendResumeExtent(){const{scaleVisibility:u,frustumVisibility:h}=this;if(null==u&&null==h)return;const y=({computedExtent:g,extentPadding:f})=>{this._suspendResumeExtent=(0,wt.t8)(g,this._suspendResumeExtent,k.qD,f),u?.setExtent(this._suspendResumeExtent),h?.setExtent(this._suspendResumeExtent)};this.addHandles((0,F.wB)(()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding}),g=>y(g),F.pc))}_updateClippingExtent(){this.graphicsCore.setClippingExtent(this.view.clippingArea,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};(0,b._)([(0,E.MZ)()],me.prototype,"type",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],me.prototype,"owner",void 0),(0,b._)([(0,E.MZ)()],me.prototype,"layer",null),(0,b._)([(0,E.MZ)()],me.prototype,"view",null),(0,b._)([(0,E.MZ)({constructOnly:!0})],me.prototype,"graphicsCore",void 0),(0,b._)([(0,E.MZ)()],me.prototype,"scaleVisibility",null),(0,b._)([(0,E.MZ)({constructOnly:!0})],me.prototype,"frustumVisibility",void 0),(0,b._)([(0,E.MZ)()],me.prototype,"elevationAlignment",null),(0,b._)([(0,E.MZ)()],me.prototype,"scaleVisibilitySuspended",null),(0,b._)([(0,E.MZ)({readOnly:!0})],me.prototype,"frustumVisibilitySuspended",null),(0,b._)([(0,E.MZ)()],me.prototype,"suspended",null),(0,b._)([(0,E.MZ)({readOnly:!0})],me.prototype,"updating",null),(0,b._)([(0,E.MZ)()],me.prototype,"loadedGraphics",null),(0,b._)([(0,E.MZ)()],me.prototype,"fullOpacity",null),(0,b._)([(0,E.MZ)()],me.prototype,"slicePlaneEnabled",null),(0,b._)([(0,E.MZ)()],me.prototype,"drapeSourceType",void 0),(0,b._)([(0,E.MZ)()],me.prototype,"updatePolicy",null),(0,b._)([(0,E.MZ)({constructOnly:!0})],me.prototype,"scaleVisibilityEnabled",void 0),(0,b._)([(0,E.MZ)({constructOnly:!0})],me.prototype,"frustumVisibilityEnabled",void 0),(0,b._)([(0,E.MZ)()],me.prototype,"initializePromise",void 0),me=(0,b._)([(0,te.$)("esri.views.3d.layers.graphics.GraphicsProcessor")],me);const At=(0,ae.hA)();function Qt(){return Qt=(0,T.A)(function*(u,h,y){if(null==u||0===h.candidates.length)return Ui;const g=u.graphics3DGraphicsByObjectID??u.graphics3DGraphics,f=[],v=[],{renderer:S}=u,O=null!=S&&"arcadeRequired"in S&&S.arcadeRequired?(0,ei.lw)():null,L=function(){var Re=(0,T.A)(function*(Ye,{graphic:We,graphics3DSymbol:Me}){const dt=yield O,gt=yield u.getRenderingInfoAsync(We,S,dt,{signal:y});return null==gt?[]:Me.queryForSnapping(Ye,V,gt,y)});return function(We,Me){return Re.apply(this,arguments)}}(),{candidates:K,spatialReference:V}=h;for(let Re=0;Re<K.length;++Re){const Ye=K[Re],{objectId:We}=Ye,Me="number"==typeof We?g?.get(We):void 0;if(null==Me)continue;const{graphics3DSymbol:dt}=Me;dt.symbologySnappingSupported&&(f.push(L(Ye,Me)),v.push(Re))}if(0===f.length)return Ui;const $=yield Promise.all(f);(0,ie.Te)(y);const ce=[],$e=[];for(let Re=0;Re<$.length;++Re){const Ye=$[Re],We=v[Re];for(const Me of Ye)ce.push(Me),$e.push(We)}return{candidates:ce,sourceCandidateIndices:$e}}),Qt.apply(this,arguments)}const Ui={candidates:[],sourceCandidateIndices:[]};class Es{constructor(h,y=0,g=0,f=0,v=0,S=null){this.usedMemory=h,this.displayedFeatures=y,this.totalFeatures=g,this.maximumFeatures=f,this.nodes=v,this.core=S}}var xs=_(55039),Ps=_(65385);function Xt(){return Xt=(0,T.A)(function*(u){const h=u.view.spatialReference,y=u.layer.fullExtent,g=null!=y&&y.spatialReference;if(null==y||!g)return null;if(g.equals(h))return y.clone();const f=(0,xs.Cv)(y,h);if(null!=f)return f;if(u.view.state.isLocal)try{const v=yield(0,Ps.projectGeometry)(y,h,u.layer.portalItem);return u.destroyed||null==v?null:v}catch{return null}return null}),Xt.apply(this,arguments)}var As=_(41474),Ds=_(56253);let ze=class extends(Y(As.A)){constructor(){super(...arguments),this.type="graphics-3d",this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.ignoresMemoryFactor=!0}get highlightOptions(){return null}initialize(){this._set("processor",new me({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.addHandles(this.layer.on("graphic-update",u=>this.processor.graphicsCore.graphicUpdateHandler(u))),this.layer.internal?this.notifyChange("updating"):(this.addResolvingPromise(function Os(u){return Xt.apply(this,arguments)}(this).then(u=>this.fullExtentInLocalViewSpatialReference=u)),this.addHandles((0,F.z7)(()=>this.view?.basemapTerrain?.ready,()=>()=>this.notifyChange("updating"),{once:!0})))}destroy(){this._updatingHandles.removeAll(),this._set("processor",(0,I.pR)(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get visibleAtCurrentScale(){return!this.processor?.scaleVisibilitySuspended}get slicePlaneEnabled(){return this._slicePlaneEnabled&&!this.layer.internal}set slicePlaneEnabled(u){this._slicePlaneEnabled=u}getSuspendInfo(){const u=super.getSuspendInfo();return u.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,u}getHit(u){return this.processor.getHit(u)}whenGraphicBounds(u,h){return this.processor.whenGraphicBounds(u,h)}computeAttachmentOrigin(u,h){return this.processor?.computeAttachmentOrigin(u,h)}getSymbolLayerSize(u,h){return this.processor.getSymbolLayerSize(u,h)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(u){return this.processor.maskOccludee(u)}highlight(u,h){return this.processor.highlight(u,h?.name??Ds.Tv)}elevationAlignPointsInFeatures(u,h){var y=this;return(0,T.A)(function*(){const{processor:g}=y;if(null==g?.graphics3DGraphics)throw new M.A("graphicslayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");const{graphics3DGraphics:f}=g;return function A(u,h,y,g,f){return G.apply(this,arguments)}(y.view,y.layer,S=>"number"==typeof S?f.get(S):void 0,u,h)})()}queryForSymbologySnapping(u,h){var y=this;return(0,T.A)(function*(){return function Cs(u,h,y){return Qt.apply(this,arguments)}(y.processor,u,h)})()}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||Ae.q.SYNC}isUpdating(){return this.view&&this.layer&&!(!this.processor?.updating&&(this.layer.internal||this.view.basemapTerrain?.ready))}get performanceInfo(){return new Es(this.usedMemory,this.loadedGraphics.length,-1,-1)}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return this.processor?.graphicsCore?.unprocessedMemoryEstimate}get test(){return{graphics3DProcessor:this.processor,loadedGraphics:this.loadedGraphics}}};(0,b._)([(0,E.MZ)()],ze.prototype,"highlightOptions",null),(0,b._)([(0,E.MZ)()],ze.prototype,"loadedGraphics",null),(0,b._)([(0,E.MZ)({readOnly:!0})],ze.prototype,"legendEnabled",null),(0,b._)([(0,E.MZ)()],ze.prototype,"layer",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],ze.prototype,"processor",void 0),(0,b._)([(0,E.MZ)({readOnly:!0})],ze.prototype,"visibleAtCurrentScale",null),(0,b._)([(0,E.MZ)()],ze.prototype,"_slicePlaneEnabled",void 0),(0,b._)([(0,E.MZ)({type:Boolean})],ze.prototype,"slicePlaneEnabled",null),ze=(0,b._)([(0,te.$)("esri.views.3d.layers.GraphicsLayerView3D")],ze);const Ls=ze},35326:(_e,ee,_)=>{_.d(ee,{B6:()=>ie,G8:()=>J,Jf:()=>w,Zd:()=>W});var T=_(92771),b=_(62789),M=_(28714),I=_(25866),F=_(83675),E=_(23234),Z=_(69307),N=_(45321),de=_(28377),te=_(95162),ae=_(40972);function ie(R,H,se,ye,oe){const re=R.stageObject,ue=re.geometries;let Ce=0;for(const ve of ue){if(!(0,te.p)(ve))continue;const{update:k,averageGeometrySampledElevation:le}=G(ve,H,se,ye,oe);Ce+=le,k&&re.geometryVertexAttributeUpdated(ve,ae.r.POSITION)}return Ce/ue.length}function J(R,H,se,ye,oe,re){const ue=R.stageObject,Ce=H.centerPointInElevationSR;let ve=0;ue.usesVerticalDistanceToGround?(ye(Ce,A),(0,Z.ai)(ue,A.verticalDistanceToGround),ve=A.sampledElevation):(ye(Ce,A),"absolute-height"!==H.mode&&(ve=A.sampledElevation));const k=(0,T.C)(Y,re??ue.transformation),le=(0,M.i)(P,k[12],k[13],k[14]);N.b.TESTS_DISABLE_OPTIMIZATIONS?(B[0]=Ce.x,B[1]=Ce.y,B[2]=A.z,(0,F.l)(Ce.spatialReference,B,k,oe.spatialReference)&&(re?(0,T.C)(re,k):ue.transformation=k)):oe.setAltitudeOfTransformation(A.z,k);const pe=z/oe.unitInMeters;return(Math.abs(k[12]-le[0])>=pe||Math.abs(k[13]-le[1])>=pe||Math.abs(k[14]-le[2])>=pe)&&(re?(0,T.C)(re,k):ue.transformation=k),ve}const Y=(0,b.vt)();function w(R,H,se,ye,oe){const re=R.graphics3DSymbolLayer.lodRenderer;if(null==re)return 0;const ue=H.centerPointInElevationSR;ye(ue,A);const Ce="absolute-height"!==H.mode?A.sampledElevation:0,ve=re.instanceData,k=R.instanceIndex,le=U;ve.getGlobalTransform(k,le);const pe=(0,M.i)(P,le[12],le[13],le[14]);N.b.TESTS_DISABLE_OPTIMIZATIONS?(B[0]=ue.x,B[1]=ue.y,B[2]=A.z,(0,F.l)(ue.spatialReference,B,le,oe.spatialReference)&&ve.setGlobalTransform(k,le)):oe.setAltitudeOfTransformation(A.z,le);const Ee=z/oe.unitInMeters;return(N.b.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(le[12]-pe[0])>=Ee||Math.abs(le[13]-pe[1])>=Ee||Math.abs(le[14]-pe[2])>=Ee)&&ve.setGlobalTransform(k,le),Ce}function W(R,H,se,ye,oe){const re=R.stageObject,ue=re.geometries;if(0===ue.length)return 0;let Ce=0,ve=null,k=0,le=!1;for(const pe of ue){if(!(0,te.p)(pe))continue;const Ee=pe.attributes.get(ae.r.POSITION);if(Ee!==ve){const{update:he,averageGeometrySampledElevation:Qe}=G(pe,H,se,ye,oe);k=Qe,ve=Ee,le=he}le&&re.geometryVertexAttributeUpdated(pe,ae.r.POSITION),Ce+=k}return Ce/ue.length}const z=.01,B=(0,I.vt)(),C=(0,I.vt)(),D=(0,I.vt)(),U=(0,b.vt)(),P=(0,I.vt)(),A=new Z.Uk;function G(R,H,se,ye,oe){let re=!1;const ue=R.transformation,Ce=H.requiresSampledElevationInfo;C[0]=ue[12],C[1]=ue[13],C[2]=ue[14],R.invalidateBoundingInfo();const ve=R.getMutableAttribute(ae.r.POSITION),k=ve.data,le=ve.size,pe=k.length/le,Ee=new de.aY(R.mapPositions,se);let he=0,Qe=0;for(let ne=0;ne<pe;ne++){if(D[0]=k[he],D[1]=k[he+1],D[2]=k[he+2],ye(Ee,A),Ce&&(Qe+=A.sampledElevation),N.b.TESTS_DISABLE_OPTIMIZATIONS)k[he]=Ee.array[Ee.offset],k[he+1]=Ee.array[Ee.offset+1],k[he+2]=A.z,(0,E.projectBuffer)(k,se,he,k,oe.spatialReference,he,1),k[he]-=C[0],k[he+1]-=C[1],k[he+2]-=C[2],re=!0;else{B[0]=k[he]+C[0],B[1]=k[he+1]+C[1],B[2]=k[he+2]+C[2],oe.setAltitude(B,A.z),k[he]=B[0]-C[0],k[he+1]=B[1]-C[1],k[he+2]=B[2]-C[2];const it=z/oe.unitInMeters;(Math.abs(D[0]-k[he])>=it||Math.abs(D[1]-k[he+1])>=it||Math.abs(D[2]-k[he+2])>=it)&&(re=!0)}he+=le,Ee.offset+=3}return Qe/=pe,{update:re,averageGeometrySampledElevation:Qe}}},42051:(_e,ee,_)=>{_.d(ee,{H:()=>ae,Y:()=>ie});var T=_(10467),b=_(28714),M=_(25866),I=_(2296),F=_(83989),E=_(69307),Z=_(23393),N=_(90673),de=_(67496),te=_(67400);class ae{constructor(C,D,U){this.baseMaterial=C,this.edgeMaterial=D,this.hasSlicePlane=U}}class ie{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(C,D,U,P,A,G,R,H=null){this.graphics3DSymbolLayer=C,this.stageObject=D,this._uniqueGeometries=U,this._uniqueMaterials=P,this._sharedResource=A,this.elevationAligner=G,this.elevationContext=R,this._edgeState=H,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(C){this._stageLayer=C;const D=C.stage;D.addMany(this._uniqueMaterials),D.addMany(this._uniqueGeometries),D.add(this.stageObject)}destroy(){if(!this._stageLayer)return;const C=this._stageLayer.stage;C.removeMany(this._uniqueMaterials),C.removeMany(this._uniqueGeometries),C.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),C.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(C,D){const{stageObject:U,_edgeState:P,_stageLayer:A}=this;if(null==P)return;const G=J(P.baseMaterial);P.edgeMaterial.objectTransparency!==G&&(P.edgeMaterial.objectTransparency=G,this.resetEdgeObject(D)),A.stage.renderer.withEdgeView(R=>R.updateAllComponentOpacities(U,[C]))}updateHighlights(C){}slicePlaneEnabledChanged(C,D){const{stageObject:U,_edgeState:P,_stageLayer:A}=this;null!=P&&A.stage.renderer.withEdgeView(G=>{G.updateAllComponentMaterials(U,P.edgeMaterial,C,!D),P.hasSlicePlane=C})}setVisibility(C){const{_edgeState:D,stageObject:U,_stageLayer:P}=this;null!=P&&this.visible!==C&&(this._visible=C,U.visible=C,C&&!this._addedToStage&&(P.add(U),this._addedToStage=!0),null!=D&&P.stage.renderer.withEdgeView(A=>{A.hasObject(U)?A.updateObjectVisibility(U,C):C&&this._addOrUpdateEdgeObject(D,A,!1)}))}get visible(){return this._visible}alignWithElevation(C,D,U,P){null!=this.elevationAligner&&(null!=U&&(0,Z.gf)(this.elevationContext.featureExpressionInfoContext,U),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,C.spatialReference,(G,R)=>(0,E.sE)(G,C,this.elevationContext,D,R),D),this.resetEdgeObject(P))}alignWithAbsoluteElevation(C,D,U){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(A,G)=>{G.sampledElevation=C,G.verticalDistanceToGround=0,G.z=C},D),this.resetEdgeObject(U)}getCenterObjectSpace(C=(0,M.vt)()){return(0,b.c)(C,(0,F.a)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(C=(0,I.vt)()){const D=this.stageObject.boundingVolumeObjectSpace;return(0,I.Ne)(C,D.min),(0,I.vI)(C,D.max),C}computeAttachmentOrigin(C){const D=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)C.render.origin[0]+=D[12],C.render.origin[1]+=D[13],C.render.origin[2]+=D[14],C.render.num++;else for(const U of this.stageObject.geometries)U.computeAttachmentOrigin(W)&&((0,b.t)(W,W,D),(0,b.g)(C.render.origin,C.render.origin,W),C.render.num++)}getProjectedBoundingBox(C,D,U,P,A){var G=this;return(0,T.A)(function*(){const R=G.getBoundingBoxObjectSpace(A),H=z,se=(0,I.fT)(R)?1:H.length;for(let oe=0;oe<se;oe++){const re=H[oe];w[0]=R[re[0]],w[1]=R[re[1]],w[2]=R[re[2]],(0,b.t)(w,w,G.stageObject.transformation),Y[3*oe]=w[0],Y[3*oe+1]=w[1],Y[3*oe+2]=w[2]}if(!C(Y,0,se))return null;(0,I.Ie)(R);let ye=null;G.calculateRelativeScreenBounds&&(ye=G.calculateRelativeScreenBounds());for(let oe=0;oe<3*se;oe+=3){for(let re=0;re<3;re++)R[re]=Math.min(R[re],Y[oe+re]),R[re+3]=Math.max(R[re+3],Y[oe+re]);ye&&U.push({location:Y.slice(oe,oe+3),screenSpaceBoundingRect:ye})}if(D?.service&&"absolute-height"!==G.elevationContext.mode){(0,I.gX)(R,W);const oe="relative-to-scene"===G.elevationContext.mode?"scene":"ground";let re=0;if(D.useViewElevation)re=D.service.getElevation(W[0],W[1],oe)??0;else try{const ue=(0,N.vY)(R,D.service.spatialReference,D);re=(yield D.service.queryElevation(W[0],W[1],P,ue,oe))??0}catch{}(0,I.cY)(R,0,0,-G.alignedSampledElevation+re)}return R})()}addObjectState(C){C.stateType===de.Mg.Highlight&&C.addObject(this.stageObject,this.stageObject.highlight(C.highlightName)),C.stateType===de.Mg.MaskOccludee&&C.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(C){C.removeByObject(this.stageObject)}resetEdgeObject(C){const{_edgeState:D,stageObject:U,_stageLayer:P,_visible:A}=this;null!=D&&P.stage.renderer.withEdgeView(G=>{A?this._addOrUpdateEdgeObject(D,G,C):G.removeObject(U)})}_addOrUpdateEdgeObject(C,D,U){const P=J(C.baseMaterial);C.edgeMaterial.objectTransparency=P,D.addOrUpdateObject3D(this.stageObject,C.edgeMaterial,C.hasSlicePlane,!U).then(()=>this._stageLayer?.sync())}}function J(B){return B.parameters.transparent?te.x.TRANSPARENT:te.x.OPAQUE}const Y=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],w=(0,M.vt)(),W=(0,M.vt)(),z=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]]},42132:(_e,ee,_)=>{_.d(ee,{Z:()=>T});class T{constructor(M,I=null){this.labelText=I,this.elevationOffset=M??0}}},32451:(_e,ee,_)=>{_.d(ee,{RL:()=>b,ZC:()=>M,kf:()=>T});const T=3,b=3,M=10},81605:(_e,ee,_)=>{_.d(ee,{U:()=>W});var T=_(68677),M=(_(3248),_(35150)),I=_(25866),F=_(89141),E=_(15268),Z=_(42363),N=_(69307),de=_(89082),te=_(23393),ae=_(90673),ie=_(47804),J=_(69760),Y=_(85222);const w=()=>M.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class W extends J.x{constructor(P,A,G,R){super(G.schedule),this.symbol=P,this.symbolLayer=A,this._context=G,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=w(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=R.renderPriority,this._renderPriorityStep=R.renderPriorityStep,this._elevationContext=new de.F,this.complexity=this.computeComplexity(),this.ignoreDrivers=R.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=z(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get usedMemory(){const P=this.complexity;return null==P?0:(this.draped?P.memory.draped:P.memory).bytesPerFeature}_drivenPropertiesChanged(P){if(this.ignoreDrivers)return!1;const A=this._drivenProperties,G=z(P);return G.color!==A.color||G.opacity!==A.opacity||G.opacityAlwaysOpaque!==A.opacityAlwaysOpaque||G.size!==A.size||G.rotation!==A.rotation}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(P,A,G,R){const se="polygons"in P?P.polygons:null,ye=`${R} geometry failed to be created`;P.projectionSuccess?!this._logGeometryValidationWarnings(A,G,R)&&se&&0===se.length&&"rings"===G&&A.length>0&&A[0].length>2&&w().warnOncePerTick(`${ye} (filled rings should use clockwise winding - try reversing the order of vertices)`):w().warnOncePerTick(`${ye} (failed to project geometry to view spatial reference)`)}updateFocus(P,A){}_logGeometryValidationWarnings(P,A,G){const R=`${G} geometry failed to be created`;return!P.length||1===P.length&&!P[0].length?(w().warnOncePerTick(`${R} (no ${A} were defined)`),!0):!(Array.isArray(P)&&Array.isArray(P[0])||(w().warnOncePerTick(`${R} (${A} should be defined as a 2D array)`),0))}_validateGeometry(P,A=null,G=null){if(null!=A&&!A.includes(P.type))return this.logger.warn("unsupported geometry type for "+G+` symbol: ${P.type}`),!1;switch(P.type){case"point":{const R=P;if(!isFinite(R.x)||!isFinite(R.y))return w().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":(0,E.m3)(P)&&w().warnOnce("Fixed a non-closed polygon ring.")}return!0}_defaultElevationInfoNoZ(){return B}_defaultElevationInfoZ(){return C}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(P){return P.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(P,A=this.getDefaultElevationInfo(P)){return this._elevationContext.mode||A.mode}setElevationInfoOverride(P){this._elevationInfoOverride=P,this._updateElevationContext()}setGraphicElevationContext(P,A=new de.F){const G=P.geometry,R=this.getDefaultElevationInfo(G);A.unit=null!=this._elevationContext.unit?this._elevationContext.unit:R.unit,A.mode=this.getGeometryElevationMode(G,R),A.offsetMeters=this._elevationContext.meterUnitOffset??R.offset??0;const H=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===A.mode;return H&&(A.mode="relative-to-ground",A.offsetMeters=0),A.updateFeatureExpressionInfoContext(H?te.KF:this._elevationContext.featureExpressionInfoContext,P,this._context.layer),A}prepareSymbolLayerPatch(P){}updateGeometry(P,A){return!1}updateTransform(P,A,G,R){return!1}onRemoveGraphic(P){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(P,A=D){const G=this.draped?1:this._getLayerOpacity();return this._drivenProperties.opacity?G:P?G*P.a:A.hasIntrinsicColor?G:0}_getCombinedOpacityAndColor(P,A=D){const G=this._getCombinedOpacity(P,A);if(this._drivenProperties.color)return(0,ae.$C)(null,G);const R=null!=P?T.A.toUnitRGB(P):I.Un;return(0,ae.$C)(R,G)}_getVertexOpacityAndColor(P,A=null){const H=(0,ae.$C)(this._drivenProperties.color?P.color:null,this._drivenProperties.opacity?P.opacity:null);return A&&(H[0]*=A,H[1]*=A,H[2]*=A,H[3]*=A),H}isFastUpdatesEnabled(){return null!=this._fastUpdates}computeComplexity(){return(0,Z.JV)(this.symbol,this.symbolLayer)}globalPropertyChanged(P,A,G){switch(P){case"opacity":return this.layerOpacityChanged(A,G),!0;case"elevationInfo":{const R=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(A,G,R)!==N.uw.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(A,G);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(P,A,G){let R=N.uw.UPDATE;return P.forEach(H=>{const se=A(H);null!=se?(this.setGraphicElevationContext(H.graphic,se.elevationContext),se.needsElevationUpdates=G(se.elevationContext.mode)):R=N.uw.RECREATE}),R}applyRendererDiff(P,A){return ie.w.RecreateSymbol}getFastUpdateAttrValues(P){if(!this._fastUpdates)return null;const A=this._fastUpdates.visualVariables,G=A.size?(0,Y.ul)(A.size.field,P):0,R=A.color?(0,Y.ul)(A.color.field,P):0,H=A.opacity?(0,Y.ul)(A.opacity.field,P):0;return(0,F.fA)(G,R,H,0)}get draped(){return this._draped}ensureDrapedStatus(P){return null==this._draped?(this._draped=P,!0):(P!==this.draped&&w().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function z(U){const P={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1};return U&&"visualVariables"in U&&U.visualVariables&&U.visualVariables.forEach(A=>{switch(A.type){case"color":if(P.color=!0,A.stops)for(let G=0;G<A.stops.length;G++){const R=A.stops[G].color;R&&(P.opacity=!0,R.a<1&&(P.opacityAlwaysOpaque=!1))}break;case"opacity":P.opacity=!0,P.opacityAlwaysOpaque=!1;break;case"size":P.size=!0;break;case"rotation":P.rotation=!0}}),P}const B={mode:"on-the-ground",offset:0,unit:"meters"},C={mode:"absolute-height",offset:0,unit:"meters"},D={hasIntrinsicColor:!1}},69760:(_e,ee,_)=>{_.d(ee,{P:()=>I,x:()=>M});var I,F,T=_(11432),b=_(56492);class M{constructor(E){this.schedule=E,this._abortController=null,this._loadStatus=I.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(E,Z){return this._loadStatus===I.LOADED?(E&&E(),this._loader??Promise.resolve()):this._loadStatus===I.FAILED?(Z&&Z(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=I.LOADED},N=>{throw this._loadError=N,this._abortController=null,this._loadStatus=I.FAILED,!(0,b.zf)(N)&&this.logger&&N.message&&this.logger.warn(N.message),N})),this._loader.then(E,Z).catch(()=>{}),this._loader)}abortLoad(){null!=this._abortController?this._abortController=(0,T.DC)(this._abortController):this._loadStatus===I.LOADING&&(this._loadStatus=I.FAILED),this._loader=null}}(F=I||(I={}))[F.LOADING=0]="LOADING",F[F.LOADED=1]="LOADED",F[F.FAILED=2]="FAILED"},13688:(_e,ee,_)=>{_.d(ee,{MT:()=>M,a8:()=>I,hk:()=>b,i3:()=>F,rz:()=>T});class T{constructor(Z){this.estimated=!1,this.verticesPerFeature=Z.verticesPerFeature??0,this.verticesPerCoordinate=Z.verticesPerCoordinate??0,this.drawCallsPerFeature=Z.drawCallsPerFeature??0,this.memory=Z.memory??new F}}class b extends T{constructor(Z){super(Z),this.estimated=!0}}class M extends T{constructor(Z,N){super(N),this.numComplexities=Z}}class I extends b{constructor(Z,N){super(N),this.numComplexities=Z}}class F{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}},3223:(_e,ee,_)=>{_.d(ee,{qD:()=>b,r4:()=>M});var T=_(89141);const b=1.2,M=T.uY},42363:(_e,ee,_)=>{_.d(ee,{Eg:()=>de,GI:()=>Y,JV:()=>J,Tf:()=>te,k9:()=>ae,pg:()=>W,uD:()=>N});var T=_(69690),b=_(15225),M=_(32451),I=_(29851),F=_(13688),E=_(96522),Z=_(3781);const N=new F.hk({});function de(B){return"web-style"===B.type?N:te(B.symbolLayers.toArray().map(C=>J(B,C)))}function te(B){let C=0,D=0,U=0,P=!1,A=0;const G=new F.i3;for(const R of B)null!=R&&(C+=R.verticesPerFeature,D+=R.verticesPerCoordinate,U+=R.drawCallsPerFeature,G.bytesPerFeature+=R.memory.bytesPerFeature,G.bytesPerFeatureLabel+=R.memory.bytesPerFeatureLabel,G.resourceBytes+=R.memory.resourceBytes,G.draped.bytesPerFeature+=R.memory.bytesPerFeature,G.draped.bytesPerFeatureLabel+=R.memory.bytesPerFeatureLabel,P=P||R.estimated,++A);return P?new F.a8(A,{verticesPerFeature:C,verticesPerCoordinate:D,drawCallsPerFeature:U,memory:G}):new F.MT(A,{verticesPerFeature:C,verticesPerCoordinate:D,drawCallsPerFeature:U,memory:G})}function ae(B){const C=te(B);return C.numComplexities>0&&(C.verticesPerFeature/=C.numComplexities,C.verticesPerCoordinate/=C.numComplexities,C.drawCallsPerFeature/=C.numComplexities,C.memory.bytesPerFeature/=C.numComplexities,C.memory.bytesPerFeatureLabel/=C.numComplexities,C.memory.resourceBytes/=C.numComplexities,C.memory.draped.bytesPerFeature/=C.numComplexities,C.memory.draped.bytesPerFeatureLabel/=C.numComplexities),C}const ie={};function J(B,C){const D=Y(B,C),U=(0,E.RF)(C)?2:0;switch(C.type){case"extrude":return new F.rz({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:U,memory:D});case"fill":if("mesh-3d"===B.type)return new F.rz({drawCallsPerFeature:U,memory:D});if(null!=C.outline&&C.outline.size>0)return new F.rz({verticesPerFeature:-12,verticesPerCoordinate:9,memory:D});case"water":return new F.rz({verticesPerFeature:-6,verticesPerCoordinate:3,memory:D});case"line":return new F.rz({verticesPerFeature:-6,verticesPerCoordinate:6,memory:D});case"object":return C.resource?.href?new F.hk({verticesPerFeature:100,memory:D}):{...w(C.resource?.primitive??b.r),memory:D};case"path":{let P=0,A=0;switch(C.profile){case"circle":P=M.ZC;break;case"quad":P=4;break;default:return void(0,T.Xb)(C.profile)}switch(C.join){case"round":A=M.kf;break;case"miter":case"bevel":A=1;break;default:return}const G=2*P,R=P*A*2,H=R+G;let se=-2*R-G;switch(C.cap){case"none":break;case"butt":case"square":se+=2*(P-1);break;case"round":se+=2*(P*(M.RL-1)*2+P);break;default:return}return new F.rz({verticesPerFeature:se,verticesPerCoordinate:H,memory:D})}case"text":case"icon":return new F.rz({verticesPerFeature:6,memory:D});default:return}}function Y(B,C){const D="point-3d"===B.type;switch(C.type){case"extrude":return C.edges&&C.edges.size>0?z.EXTRUDE_EDGES:z.EXTRUDE;case"fill":return null!=C.outline&&C.outline.size>0?z.FILL_OUTLINE:z.FILL;case"water":return z.FILL;case"line":return"round"===C.join?z.LINE_ROUND:z.LINE_MITER;case"path":switch(C.join){case"round":switch(C.profile){case"circle":return z.PATH_ROUND_CIRCLE;case"quad":return z.PATH_ROUND_QUAD;default:return void(0,T.Xb)(C.profile)}case"miter":case"bevel":switch(C.profile){case"circle":return z.PATH_MITER_CIRCLE;case"quad":return z.PATH_MITER_QUAD;default:return void(0,T.Xb)(C.profile)}default:return}case"object":return D?z.OBJECT_POINT:z.OBJECT_POLYGON;case"icon":case"text":return D?z.ICON_POINT:z.ICON_POLYGON;default:return}}function w(B){const C=ie[B];if(C)return C;const D=W((0,I._)(B,new Z.$U({},{spherical:!0,doublePrecisionRequiresObfuscation:!0})).levels);return ie[B]=new F.rz({verticesPerFeature:D}),ie[B]}function W(B){return B.reduce((C,D,U)=>C+D.numVertices*(1/10**U),0)/B.reduce((C,D,U)=>C+1/10**U,0)}const z={ICON_POINT:{bytesPerFeature:2346.460896195398,bytesPerFeatureLabel:3484.7516349999996,resourceBytes:0,draped:{bytesPerFeature:2007.3528529826217,bytesPerFeatureLabel:3522.702025}},ICON_POLYGON:{bytesPerFeature:3677.214053765355,bytesPerFeatureLabel:3502.5355950000003,resourceBytes:0,draped:{bytesPerFeature:3030.3700096053935,bytesPerFeatureLabel:3550.247175}},OBJECT_POINT:{bytesPerFeature:569.2092700798497,bytesPerFeatureLabel:3183.0256999999992,resourceBytes:0,draped:{bytesPerFeature:569.2092700798497,bytesPerFeatureLabel:3183.0256999999992}},OBJECT_POLYGON:{bytesPerFeature:1252.202280530861,bytesPerFeatureLabel:3125.853350000001,resourceBytes:0,draped:{bytesPerFeature:1252.202280530861,bytesPerFeatureLabel:3125.853350000001}},LINE_MITER:{bytesPerFeature:3252.89170349711,bytesPerFeatureLabel:3554.3931949999997,resourceBytes:0,draped:{bytesPerFeature:2843.5793737736867,bytesPerFeatureLabel:3538.2547083333334}},LINE_ROUND:{bytesPerFeature:3384.080501909172,bytesPerFeatureLabel:3522.6055950000004,resourceBytes:0,draped:{bytesPerFeature:2833.1897218657587,bytesPerFeatureLabel:3532.0680950000005}},PATH_MITER_CIRCLE:{bytesPerFeature:38490.63544346431,bytesPerFeatureLabel:3660.7835999999998,resourceBytes:0,draped:{bytesPerFeature:38490.63544346431,bytesPerFeatureLabel:3660.7835999999998}},PATH_ROUND_CIRCLE:{bytesPerFeature:42934.88589895749,bytesPerFeatureLabel:3729.49955,resourceBytes:0,draped:{bytesPerFeature:42934.88589895749,bytesPerFeatureLabel:3729.49955}},PATH_MITER_QUAD:{bytesPerFeature:25392.923576583788,bytesPerFeatureLabel:3647.05925,resourceBytes:0,draped:{bytesPerFeature:25392.923576583788,bytesPerFeatureLabel:3647.05925}},PATH_ROUND_QUAD:{bytesPerFeature:40448.297252606244,bytesPerFeatureLabel:3646.8303499999997,resourceBytes:0,draped:{bytesPerFeature:40448.297252606244,bytesPerFeatureLabel:3646.8303499999997}},FILL:{bytesPerFeature:3419.9079008788176,bytesPerFeatureLabel:3564.2132483333335,resourceBytes:0,draped:{bytesPerFeature:2910.096178654882,bytesPerFeatureLabel:3554.8655816666665}},FILL_OUTLINE:{bytesPerFeature:5018.088812445781,bytesPerFeatureLabel:3524.8219616666665,resourceBytes:0,draped:{bytesPerFeature:4278.49006198517,bytesPerFeatureLabel:3532.068368333334}},EXTRUDE:{bytesPerFeature:7963.8889768932695,bytesPerFeatureLabel:3628.5106350000005,resourceBytes:0,draped:{bytesPerFeature:7963.8889768932695,bytesPerFeatureLabel:3628.5106350000005}},EXTRUDE_EDGES:{bytesPerFeature:3111.7648563053044,bytesPerFeatureLabel:2658.4350683333337,resourceBytes:0,draped:{bytesPerFeature:3111.7648563053044,bytesPerFeatureLabel:2658.4350683333337}}}},47804:(_e,ee,_)=>{var T,b,M;_.d(ee,{G:()=>b,w:()=>T}),(M=T||(T={}))[M.RecreateSymbol=0]="RecreateSymbol",M[M.RecreateGraphics=1]="RecreateGraphics",M[M.FastUpdate=2]="FastUpdate",function(M){M[M.Slow=0]="Slow",M[M.Fast=1]="Fast",M[M.Mixed=2]="Mixed",M[M.Loading=3]="Loading",M[M.Undefined=4]="Undefined"}(b||(b={}))},42975:(_e,ee,_)=>{_.d(ee,{R$:()=>Y,SZ:()=>de,ZX:()=>J,d2:()=>ie,hS:()=>te});var T=_(25866),b=_(16590),M=_(2296),I=_(15268),F=_(8675),E=_(69307),Z=_(90673),N=_(47756);function de(W,z,B,C,D){if(ae(W,z))return null;B.localOrigin=Y(W,z);const U=new N.B({geometries:[B],castShadow:!1,layerUid:W.layer.uid,graphicUid:D,usesVerticalDistanceToGround:!0});return{object:U,sampledElevation:(0,E.fe)(U,z,W.elevationProvider,W.renderCoordsHelper,C)}}function te(W,z,B,C){return ae(z,B)?null:(0,E.fe)(W,B,z.elevationProvider,z.renderCoordsHelper,C)}function ae(W,z){const B=W.clippingExtent;return!!B&&((0,b.g)(z,w,W.elevationProvider.spatialReference),!(0,M.Uc)(B,w))}function ie(W,z,B){const C=W.elevationContext,D=B.spatialReference;(0,b.g)(z,w,D),C.centerPointInElevationSR=(0,F.T)(w[0],w[1],z.hasZ?w[2]:0,D??null)}function J(W){switch(W.type){case"point":return W;case"polygon":case"extent":return(0,Z.W$)(W);case"polyline":{const z=W.paths[0];if(!z||0===z.length)return null;const B=(0,I.$H)(z,(0,I.Yl)(z)/2);return(0,F.T)(B[0],B[1],B[2],W.spatialReference)}case"mesh":return W.extent.center}return null}function Y(W,z){return(0,b.g)(z,w,W.renderCoordsHelper.spatialReference),W.localOriginFactory.getOrigin(w)}const w=(0,T.vt)()},29851:(_e,ee,_)=>{_.d(ee,{_:()=>F,k:()=>I}),_(3248);var b=_(36947),M=_(35404);function I(Z){switch(Z){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function F(Z,N){const de=(te,ae,ie=!1)=>new M.Fe(te.map(J=>{const Y=ae(J.tesselation);return ie&&(0,b.zC)(Y),new M.hr([new M.iC(new M.dI(Y))],J.minScreenSpaceRadius)}));switch(Z){case"sphere":return de([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],te=>(0,b.uX)(N,.5,te,!0));case"cube":return de([{tesselation:0,minScreenSpaceRadius:0}],()=>(0,b.C1)(N,1));case"cone":return de(E,te=>(0,b.EE)(N,1,.5,te,!1),!0);case"inverted-cone":return de(E,te=>(0,b.EE)(N,1,.5,te,!0),!0);case"cylinder":return de(E,te=>(0,b.nW)(N,1,.5,te,[0,0,1],[0,0,.5]));case"tetrahedron":return de([{tesselation:0,minScreenSpaceRadius:0}],()=>(0,b.Ho)(N,1),!0);case"diamond":return de([{tesselation:0,minScreenSpaceRadius:0}],()=>(0,b.td)(N,1),!0);default:return}}const E=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}]},96522:(_e,ee,_)=>{_.d(ee,{Cc:()=>ne,CC:()=>mt,RF:()=>he});var U,j,pe,Ee,T=_(68677),M=(_(3248),_(67685)),I=_(89141),Z=_(67400);function he(j){return j&&j.enabled&&(function E(j){return"extrude"===j.type}(j)||function F(j){return"fill"===j.type}(j))&&null!=j.edges}function ne(j,q){return function it(j,q){if(null==j)return null;const Q=null!=j.color?(0,I.ci)(T.A.toUnitRGBA(j.color)):(0,I.fA)(0,0,0,0),De=(0,M.Lz)(j.size),ge=(0,M.Lz)(j.extensionLength);switch(j.type){case"solid":return mt({color:Q,size:De,extensionLength:ge,...q});case"sketch":return function ft(j){return{...ut,...j,type:pe.Sketch}}({color:Q,size:De,extensionLength:ge,...q});default:return}}(function Qe(j){return j&&j.enabled&&j.edges||null}(j),q)}function mt(j){return{...et,...j,type:pe.Solid}}_(69690),_(86468),_(61079),_(74567),_(35955),_(80585),_(24493),_(2006),_(64157),_(91784),_(12335),_(40972),(j=U||(U={}))[j.Uniform=0]="Uniform",j[j.Varying=1]="Varying",j[j.COUNT=2]="COUNT",_(34416),_(28825),_(41030),_(88791),_(14705),_(33724),_(50765),function(j){j[j.Solid=0]="Solid",j[j.Sketch=1]="Sketch",j[j.Mixed=2]="Mixed",j[j.COUNT=3]="COUNT"}(pe||(pe={})),function(j){j[j.REGULAR=0]="REGULAR",j[j.SILHOUETTE=1]="SILHOUETTE"}(Ee||(Ee={}));const et={color:(0,I.fA)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:Z.x.OPAQUE,hasSlicePlane:!1},ut={color:(0,I.fA)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:Z.x.OPAQUE,hasSlicePlane:!1}},61646:(_e,ee,_)=>{_.d(ee,{H:()=>I});var T=_(85340),b=_(24493),M=_(18679);function I(F){F.include(T.E),F.uniforms.add(new M.x("geometryDepthTexture",E=>E.geometryDepth?.attachment)),F.code.add(b.H`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}},95162:(_e,ee,_)=>{function M(I){return null!=I.mapPositions}_.d(ee,{p:()=>M}),_(36884)},67400:(_e,ee,_)=>{var T,b;_.d(ee,{x:()=>T}),(b=T||(T={}))[b.TRANSPARENT=0]="TRANSPARENT",b[b.OPAQUE=1]="OPAQUE"},64935:(_e,ee,_)=>{_.d(ee,{D8:()=>F,TO:()=>M,d0:()=>E});var T=_(10467),b=_(86300);function M(Z){return I.apply(this,arguments)}function I(){return(I=(0,T.A)(function*(Z,N=Z.popupTemplate){if(null==N)return[];const de=yield N.getRequiredFields(Z.fieldsIndex),{lastEditInfoEnabled:te}=N,{objectIdField:ae,typeIdField:ie,globalIdField:J,relationships:Y}=Z;if(de.includes("*"))return["*"];const w=te?(0,b.eX)(Z):[],W=(0,b.DB)(Z.fieldsIndex,[...de,...w]);return ie&&W.push(ie),W&&ae&&Z.fieldsIndex?.has(ae)&&!W.includes(ae)&&W.push(ae),W&&J&&Z.fieldsIndex?.has(J)&&!W.includes(J)&&W.push(J),Y&&Y.forEach(z=>{const{keyField:B}=z;W&&B&&Z.fieldsIndex?.has(B)&&!W.includes(B)&&W.push(B)}),W})).apply(this,arguments)}function F(Z,N){return Z.popupTemplate?Z.popupTemplate:null!=N&&N.defaultPopupTemplateEnabled&&null!=Z.defaultPopupTemplate?Z.defaultPopupTemplate:null}function E(Z,N){return null!=F(Z,{defaultPopupTemplateEnabled:N})}}}]);