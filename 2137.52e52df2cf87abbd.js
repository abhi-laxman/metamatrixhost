"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[2137],{52137:(F,p,d)=>{d.r(p),d.d(p,{default:()=>T});var g=d(8189),M=d(89563),C=d(98877),D=d(35150),E=d(56492),I=d(48900),b=d(3804),j=d(85211),V=(d(3248),d(40707),d(76576)),v=d(48600),U=d(94542);class J extends U.B{constructor(r){super("Lyr3DWorker","process",{process:i=>i.inputs},r,{hasInitialize:!0})}destroyWasm(){return this.broadcast({},"destroyWasm")}}var c,u,e,P=d(62200),x=d(73812);(e=c||(c={}))[e.Lifetime=0]="Lifetime",e[e.Jobs=1]="Jobs",e[e.Renderables=2]="Renderables",function(e){e[e.Critical=0]="Critical",e[e.Error=1]="Error",e[e.Warning=2]="Warning",e[e.Info=3]="Info"}(u||(u={}));let R=class extends C.A{constructor(e){super(e),this._lyr3DMainPromise=null,this._lyr3DMain=null,this._layers=new Map,this._debugFlags=new Set,this._debugLevel=u.Critical,this._wasmNotLoaded="method requiring WASM was called when WASM isn't loaded",this._pulseTaskHandle=null,this._session=null,this._debugFlags.add(c.Lifetime),this._debugFlags.add(c.Jobs),this._debugFlags.add(c.Renderables)}_debugLog(e,r,i,o=!0){if(this._debugFlags.has(e)&&this._debugLevel>=r){const a=o?`[js] ${i}`:`${i}`;r===u.Critical||r===u.Error?D.A.getLogger(this).error(a):r===u.Warning&&D.A.getLogger(this).warn(a),D.A.getLogger(this).info(a)}}initialize(){this._debugLevel>u.Warning&&(D.A.getLogger(this).level="info"),this._debugLog(c.Lifetime,u.Info,"Lyr3DWasmPerSceneView.initialize()"),this.addHandles([(0,I.wB)(()=>this.view.state?.contentCamera,()=>this._updateWasmCamera())]),this._pulseTaskHandle=(0,b.mg)({preRender:()=>this._pulseTask()})}destroy(){this._debugLog(c.Lifetime,u.Info,"Lyr3DWasmPerSceneView.destroy()"),this._lyr3DMain&&(this._layers.forEach(r=>{r.abortController.abort()}),this._lyr3DMain.uninitialize_lyr3d_wasm(),this._lyr3DMain=null);const e=this._worker;e&&e.destroyWasm().then(()=>{this._worker?.destroy(),this._worker=null}),this._pulseTaskHandle?.remove(),this._pulseTaskHandle=null}add3DTilesLayerView(e){return this._lyr3DMain?this._add3DTilesLayerView(e):(this._debugLog(c.Lifetime,u.Error,"Lyr3DWasmPerSceneView.add3DTilesLayerView() called when WASM wasn't initialized"),v.vE)}remove3DTilesLayerView(e){if(!this._lyr3DMain)return this._debugLog(c.Lifetime,u.Error,this._wasmNotLoaded),0;this._doRemoveLayerView(e);const r=this._layers.size;return 0===r&&(this._debugLog(c.Lifetime,u.Info,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() no Lyr3D layers left after removing a layer, destroying"),this.destroy()),r}setEnabled(e,r){if(!this._lyr3DMain)return void this._debugLog(c.Lifetime,u.Error,this._wasmNotLoaded);const i=this._layers.get(e.wasmLayerId);i&&(this._lyr3DMain.set_enabled(e.wasmLayerId,r),i.needMemoryUsageUpdate=!0,i.needFrame=!0,i.layerView.updatingFlagChanged())}setLayerOffset(e,r){this._lyr3DMain?this._layers.get(e.wasmLayerId)&&this._lyr3DMain.set_carto_offset_z(e.wasmLayerId,r):this._debugLog(c.Lifetime,u.Error,this._wasmNotLoaded)}getAttributionText(){return this._lyr3DMain?this._lyr3DMain.get_current_attribution_text().split("|"):(this._debugLog(c.Lifetime,u.Error,this._wasmNotLoaded),[])}onRenderableEvicted(e,r,i){this._lyr3DMain?this._layers.get(e.wasmLayerId)&&this._lyr3DMain.on_renderable_evicted(e.wasmLayerId,r,i):this._debugLog(c.Lifetime,u.Error,this._wasmNotLoaded)}isUpdating(e){if(!this._lyr3DMain&&this._lyr3DMainPromise)return!0;const r=this._layers.get(e);return!!r&&(r.outstandingJobCount>0||r.outstandingRenderableCount>0||r.needFrame)}initializeWasm(e,r){return this._lyr3DMain?Promise.resolve():(this._debugLog(c.Lifetime,u.Info,"Lyr3DWasmPerSceneView.initializeWasm()"),this._lyr3DMainPromise||(this._lyr3DMainPromise=(0,P.a)().then(i=>{this._lyr3DMain=i,this._lyr3DMainPromise=null;const o=this._lyr3DMain.addFunction(this._onNewJob.bind(this),"v"),a=this._lyr3DMain.addFunction(this._onNewRenderable.bind(this),"v"),m=this._lyr3DMain.addFunction(this._freeRenderables.bind(this),"viii"),y=this._lyr3DMain.addFunction(this._setRenderableVisibility.bind(this),"viiii"),l=this._lyr3DMain.addFunction(this._onWasmError.bind(this),"viiii"),t="global"===this.view.viewingMode,n=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1,s=this.view.heightModelInfo?.heightModel;return this._lyr3DMain.initialize_lyr3d_wasm(l,o,a,m,y,e,r,t,!s||"gravity-related-height"===s,n,this._debugLevel)?(this._worker=new J(function S(e){return r=>{if(e.immediate)return e.immediate.schedule(r);const i="No immediate scheduler";throw console.error(i),new Error(i)}}(this.view.resourceController)),this._worker.promise?this._worker.promise:void 0):(this._lyr3DMain=null,void this._debugLog(c.Lifetime,u.Critical,"Lyr3d Main WASM failed to initialize",!1))}).catch(i=>{this._debugLog(c.Lifetime,u.Critical,`Lyr3d WASM failed to download error = ${i}`,!1)})),this._lyr3DMainPromise)}_pulseTask(){if(this._lyr3DMain){let e=0,r=0;this._layers.forEach(a=>{e+=a.layerView.usedMemory,r+=a.layerView.cachedMemory}),e/=1048576,r/=1048576;const i=this.view.resourceController.memoryController;this._lyr3DMain.frame_pulse(i.memoryFactor,e,r,i.usedMemory*i.maxMemory-e,i.maxMemory),this._layers.forEach(a=>{!0===a.needFrame&&(a.needFrame=!1,a.layerView.updatingFlagChanged())})}}_incrementJobCount(e){e.outstandingJobCount+=1,1===e.outstandingJobCount&&e.outstandingRenderableCount<1&&e.layerView.updatingFlagChanged()}_decrementJobCount(e){e.outstandingJobCount-=1,0===e.outstandingJobCount&&e.outstandingRenderableCount<1&&e.layerView.updatingFlagChanged()}_incrementRenderableCount(e){e.outstandingRenderableCount+=1,e.outstandingJobCount<1&&1===e.outstandingRenderableCount&&e.layerView.updatingFlagChanged()}_decrementRenderableCount(e){e.outstandingRenderableCount-=1,e.outstandingJobCount<1&&0===e.outstandingRenderableCount&&e.layerView.updatingFlagChanged()}_onJobFailed(e,r,i){r.error.length&&this._debugLog(c.Jobs,u.Error,r.error,!1),this._lyr3DMain&&this._lyr3DMain.on_job_failed(i.jobId,i.desc),this._decrementJobCount(e)}_onJobSucceeded(e,r,i){if(this._lyr3DMain){const o=r.data.byteLength,a=this._lyr3DMain._malloc(o);new Uint8Array(this._lyr3DMain.HEAPU8.buffer,a,o).set(r.data),this._lyr3DMain.on_job_completed(i.jobId,r.jobDescJson,a,o),this._lyr3DMain._free(a)}this._decrementJobCount(e)}_getRequestPromises(e,r,i){const o=[];for(const a of e){const m=new URL(a),y=m.searchParams.get("session");y?this._session=y:!this._session||m.origin===i.origin&&m.pathname===i.pathname||m.searchParams.append("session",this._session),o.push((0,M.A)(m.toString(),r).then(l=>l.data))}return o}_onNewJob(){const e=this._lyr3DMain.get_next_job(),r=this._layers.get(e.layerId);if(!r)return;this._incrementJobCount(r);const i=r.abortController.signal,o={responseType:"array-buffer",signal:i,query:{...r.customParameters,token:r.apiKey}},a={inputs:[],jobDescJson:e.desc,isMissingResourceCase:!1},m=new URL(r.layerView.layer.url),y=this._getRequestPromises(e.urls,o,m);Promise.all(y).then(l=>(a.inputs=l,this._worker.invoke(a,i))).then(l=>l).catch(l=>((0,E.zf)(l)?this._debugLog(c.Jobs,u.Warning,`job ${e.jobId} was cancelled.`):this._debugLog(c.Jobs,u.Error,`job ${e.jobId} failed with error ${l}.`),{status:v.Qg.Failed,error:"",jobDescJson:"",data:new Uint8Array(0),missingInputUrls:[],inputs:[]})).then(l=>{if(l.status===v.Qg.Failed)this._onJobFailed(r,l,e);else if(l.status===v.Qg.Succeeded)this._onJobSucceeded(r,l,e);else if(l.status===v.Qg.MissingInputs){const t=this._getRequestPromises(l.missingInputUrls,o,m);Promise.all(t).then(n=>{a.jobDescJson=l.jobDescJson,a.inputs=l.originalInputs?l.originalInputs:[],a.isMissingResourceCase=!0;for(const s of n)a.inputs.push(s);return this._worker.invoke(a,i)}).then(n=>{n.status===v.Qg.Failed?this._onJobFailed(r,n,e):n.status===v.Qg.Succeeded&&this._onJobSucceeded(r,n,e)}).catch(n=>{this._decrementJobCount(r),(0,E.zf)(n)?this._debugLog(c.Jobs,u.Warning,`job ${e.jobId} was cancelled.`):this._debugLog(c.Jobs,u.Error,`job ${e.jobId} failed with error2 ${n}.`),this._lyr3DMain&&this._lyr3DMain.on_job_failed(e.jobId,e.desc)})}})}_onNewRenderable(){const e=this._lyr3DMain.get_next_renderable(),r=e.meshData;if(r.data&&r.data.byteLength>0){const o=r.data.slice();r.data=o}const i=this._layers.get(e.layerId);i&&(this._incrementRenderableCount(i),i.layerView.createRenderable(e).then(o=>{this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!0,e.layerId,e.handle,o.memUsageBytes),this._decrementRenderableCount(i)}).catch(o=>{(0,E.zf)(o)||this._debugLog(c.Renderables,u.Error,`createRenderable failed with error ${o}.`),this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!1,e.layerId,e.handle,0),this._decrementRenderableCount(i)}))}_freeRenderables(e,r,i){if(i<1)return;const o=this._layers.get(e);if(!o)return;const a=o.layerView,m=[],y=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,r,i);for(let l=0;l<i;++l)m.push(y[l]);for(let l=0;l<i;++l)a.freeRenderable(m[l])}_setRenderableVisibility(e,r,i,o){if(o<1)return;const a=this._layers.get(e);if(!a)return;const m=a.layerView,y=[],l=[],t=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,r,o),n=new Uint8Array(this._lyr3DMain.HEAPU8.buffer,i,o);for(let s=0;s<o;++s)y.push(t[s]),l.push(1===n[s]);m.setRenderableVisibility(y,l,o)}_onWasmError(e,r,i,o){this._lyr3DMain&&this._debugLog(i,o,this._lyr3DMain.UTF8ToString(e,r),!1)}_doRemoveLayerView(e){const r=this._layers.get(e.wasmLayerId);return!!r&&(r.abortController.abort(),this._lyr3DMain.remove_layer(e.wasmLayerId),this._layers.delete(e.wasmLayerId),!0)}_add3DTilesLayerView(e){const r=e.layer;if(!r.url)return v.Pl;const i=this._lyr3DMain.get_next_layer_id(),o=new AbortController;this._layers.set(i,{layerView:e,abortController:o,needMemoryUsageUpdate:!1,outstandingJobCount:0,outstandingRenderableCount:0,customParameters:r.customParameters,apiKey:r.apiKey,needFrame:!1});const a=(0,x.M7)(r.elevationInfo);return this._lyr3DMain.add_layer(r.url,i,a)?(this._updateWasmCamera(),i):(this._layers.delete(i),v.Pl)}_updateWasmCamera(){const e=this.view.state?.contentCamera;if(!e||!this._lyr3DMain)return;const{eye:r,center:i,up:o,near:a,far:m,fovY:y}=e;this._lyr3DMain.set_camera_parameters({eye:r,center:i,up:o,near:a,far:m,fov:y,aspectRatio:e.width/e.height,viewport:[e.viewport[2],e.viewport[3]]})}};(0,g._)([(0,j.MZ)({constructOnly:!0})],R.prototype,"view",void 0),R=(0,g._)([(0,V.$)("esri.layers.Lyr3DWasmPerSceneView")],R);const T=R},48716:(F,p,d)=>{d.d(p,{j:()=>C});var g=d(82663),M=d(47258);const C={unknown:1,inches:(0,g.oU)(1,"meters","inches"),feet:(0,g.oU)(1,"meters","feet"),"us-feet":(0,g.oU)(1,"meters","us-feet"),yards:(0,g.oU)(1,"meters","yards"),miles:(0,g.oU)(1,"meters","miles"),"nautical-miles":(0,g.oU)(1,"meters","nautical-miles"),millimeters:(0,g.oU)(1,"meters","millimeters"),centimeters:(0,g.oU)(1,"meters","centimeters"),decimeters:(0,g.oU)(1,"meters","decimeters"),meters:(0,g.oU)(1,"meters","meters"),kilometers:(0,g.oU)(1,"meters","kilometers"),"decimal-degrees":1/(0,g.vl)(1,"meters",M.$O.radius)}},73812:(F,p,d)=>{d.d(p,{$7:()=>i,B:()=>r,Fo:()=>u,M7:()=>m,NN:()=>z,Q5:()=>R,Tq:()=>l,Up:()=>e,XF:()=>a,Ze:()=>P,bK:()=>E,bh:()=>A,id:()=>x,ky:()=>j,qt:()=>y,tW:()=>o,v9:()=>V,w7:()=>I,wF:()=>D,wS:()=>S,wz:()=>U,x:()=>v,xS:()=>c,ze:()=>b});var g=d(82663),M=d(82575);function C(t){return t?y:l}function D(t,n){return n?.mode?n.mode:C(t).mode}function E(t,n){return n??C(t)}function I(t,n){return D(null==t||(t.hasZ??!1),n)}function b(t,n){return E(null==t||(t.hasZ??!1),n)}function j(t){const n=J(t);return I(t.geometry,n)}function A(t){const n=J(t),s=I(t.geometry,n),h=null!=n&&"on-the-ground"!==s?m(n):0,_=n?.featureExpressionInfo;return{mode:s,offset:h,featureExpressionInfo:_}}function z(t){return U(A(t))}function V(t){return U(t)||v(t)}function v(t){return"0"===t?.featureExpressionInfo?.expression}function U(t){if(!t||"on-the-ground"===t.mode)return!1;const n=t?.featureExpressionInfo?t.featureExpressionInfo.expression:null;return!(!n||"0"===n)}function J(t){return t.layer&&"elevationInfo"in t.layer?t.layer.elevationInfo:null}function P(t,n){if(!t?.offset)return 0;const{offset:s,unit:h}=t;if("decimal-degrees"===h)return 0;const _="unknown"!==h&&h?h:"meters",w=(0,g.mq)(n);return w?(0,g.oU)(s,_,w):0}function x(t,n,s){if(!s?.mode)return;const h=t.hasZ?t.z:0,_=P(s,t.spatialReference);switch(s.mode){case"absolute-height":return h-_;case"on-the-ground":return 0;case"relative-to-ground":return h-((n.elevationProvider.getElevation(t.x,t.y,h,t.spatialReference,"ground")??0)+_);case"relative-to-scene":return h-((n.elevationProvider.getElevation(t.x,t.y,h,t.spatialReference,"scene")??0)+_)}}function S(t,n,s,h=null){return u(t,n.x,n.y,n.hasZ?n.z:0,n.spatialReference,s,h)}function c(t,n,s,h,_=null){return u(t,n[0],n[1],n.length>2?n[2]:0,s,h,_)}function u(t,n,s,h,_,w,L=null){if(null==w)return;const f=null!=L?L.mode:"absolute-height";if("on-the-ground"===f)return 0;const{absoluteZ:W}=R(n,s,h,_,t,w);return function T(t,n,s,h,_,w,L,f){const W=P(L,_);switch(f){case"absolute-height":return t-W;case"relative-to-ground":return t-((w.elevationProvider.getElevation(n,s,h,_,"ground")??0)+W);case"relative-to-scene":return t-((w.elevationProvider.getElevation(n,s,h,_,"scene")??0)+W)}}(W,n,s,h,_,t,L,f)}function R(t,n,s,h,_,w){const L=P(w,h);switch(w.mode){case"absolute-height":return{absoluteZ:s+L,elevation:0};case"on-the-ground":{const f=_.elevationProvider.getElevation(t,n,0,h,"ground")??0;return{absoluteZ:f,elevation:f}}case"relative-to-ground":{const f=_.elevationProvider.getElevation(t,n,s,h,"ground")??0;return{absoluteZ:s+f+L,elevation:f}}case"relative-to-scene":{const f=_.elevationProvider.getElevation(t,n,s,h,"scene")??0;return{absoluteZ:s+f+L,elevation:f}}}}function e(t,n){if(null==n)return!1;const{mode:s}=n;return null!=s&&("scene"===t&&"relative-to-scene"===s||"ground"===t&&"absolute-height"!==s)}function r(t,n,s){return s&&s.mode!==n?`${t} only support ${n} elevation mode`:null}function i(t,n,s){return s?.mode===n?`${t} do not support ${n} elevation mode`:null}function o(t,n){return null!=n?.featureExpressionInfo&&"0"!==n.featureExpressionInfo.expression?`${t} do not support featureExpressionInfo`:null}function a(t,n){n&&t.warn(".elevationInfo=",n)}function m(t){return(t?.offset??0)*(0,M.Ao)(t?.unit)}const y={mode:"absolute-height",offset:0},l={mode:"on-the-ground",offset:null}},82575:(F,p,d)=>{d.d(p,{Ao:()=>D,KQ:()=>I,Tg:()=>C});var g=d(89952),M=d(48716);function C(b){return!!b&&null!=M.j[b]}function D(b){return 1/(M.j[b]||1)}const I=function E(){const b=Object.keys(M.j);return(0,g.TF)(b,"decimal-degrees"),b.sort(),b}()}}]);