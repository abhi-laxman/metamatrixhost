"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[3876],{79283:(rt,Te,y)=>{y.d(Te,{TT:()=>le,Xn:()=>X,Zj:()=>I,_3:()=>U,l1:()=>_,qy:()=>w,vN:()=>G});var W=y(5922),ye=y(82663),pe=y(55739),ve=(y(1749),y(55861)),k=y(93615),Oe=y(32034),C=y(2947),Y=y(58701);function me(P){if(!P)return null;const A=P.wkid;if(A)return C.uw[A];const z=P.wkt2??P.wkt;return z?function be(P){const A=C._f.exec(P);if(!A||2!==A.length)return null;const z=A[1].split(",");if(!z||z.length<3)return null;const $=parseFloat(z[1]),F=parseFloat(z[2]);return isNaN($)||isNaN(F)?null:{a:$,f:0===F?0:1/F}}(z):null}function Me(P){const A=me(P);if(function ae(P){return null!=P&&"b"in P&&"eSq"in P&&"radius"in P}(A))return A;const z=A.a*(1-A.f);return Object.assign(A,{b:z,eSq:1-(z/A.a)**2,radius:(2*A.a+z)/3,densificationRatio:1e4/((2*A.a+z)/3)})}function re(P,A,z){const{a:$,eSq:F}=Me(z),K=Math.sqrt(F),Q=Math.sin(A[1]*C.eh),te=$*A[0]*C.eh;let ie;return ie=F>0?$*((1-F)*(Q/(1-F*(Q*Q))-1/(2*K)*Math.log((1-K*Q)/(1+K*Q))))*.5:$*Q,P[0]=te,P[1]=ie,P}function le(P){return(0,Y.EA)(P)&&!!me(P)}function w(P,A="square-meters"){if(P.some(Q=>!le(Q.spatialReference)))throw new W.A("geodesic-areas:invalid-spatial-reference","the input geometries spatial reference is not supported");const z=[];for(let Q=0;Q<P.length;Q++){const te=P[Q],ie=te.spatialReference,{radius:q,densificationRatio:ce}=Me(ie);z.push(B(te,q*ce))}const $=[],F=[0,0],K=[0,0];for(let Q=0;Q<z.length;Q++){const{rings:te,spatialReference:ie}=z[Q];let q=0;for(let ce=0;ce<te.length;ce++){const Z=te[ce];re(F,Z[0],ie),re(K,Z[Z.length-1],ie);let ne=K[0]*F[1]-F[0]*K[1];for(let he=0;he<Z.length-1;he++)re(F,Z[he+1],ie),re(K,Z[he],ie),ne+=K[0]*F[1]-F[0]*K[1];q+=ne}q=(0,ye.oU)(q,"square-meters",A),$.push(q/-2)}return $}function _(P,A="meters"){if(!P)throw new W.A("geodesic-lengths:invalid-geometries","the input geometries type is not supported");if(P.some($=>!le($.spatialReference)))throw new W.A("geodesic-lengths:invalid-spatial-reference","the input geometries spatial reference is not supported");const z=[];for(let $=0;$<P.length;$++){const F=P[$],{spatialReference:K}=F,Q="polyline"===F.type?F.paths:F.rings;let te=0;for(let ie=0;ie<Q.length;ie++){const q=Q[ie];let ce=0;for(let Z=1;Z<q.length;Z++){const ne=q[Z-1][0],he=q[Z][0],de=q[Z-1][1],V=q[Z][1];if(de!==V||ne!==he){const ue=new I;U(ue,[ne,de],[he,V],K),ce+=ue.distance}}te+=ce}te=(0,ye.oU)(te,"meters",A),z.push(te)}return z}function B(P,A){if("polyline"!==P.type&&"polygon"!==P.type)throw new W.A("geodesic-densify:invalid-geometry","the input geometry is neither polyline nor polygon");const{spatialReference:z}=P;if(!le(z))throw new W.A("geodesic-densify:invalid-spatial-reference","the input geometry spatial reference is not supported");const $="polyline"===P.type?P.paths:P.rings,F=[],K=[0,0],Q=new I;for(const ie of $){const q=[];F.push(q),q.push([ie[0][0],ie[0][1]]);let ce,Z,ne=ie[0][0],he=ie[0][1];for(let de=0;de<ie.length-1;de++){if(ce=ie[de+1][0],Z=ie[de+1][1],ne===ce&&he===Z)continue;const V=[ne,he];U(Q,[ne,he],[ce,Z],z);const{azimuth:ue,distance:_e}=Q,fe=_e/A;if(fe>1){for(let Pe=1;Pe<=fe-1;Pe++)G(K,V,ue,Pe*A,z),q.push(K.slice());G(K,V,ue,(_e+Math.floor(fe-1)*A)/2,z),q.push(K.slice())}G(K,V,ue,_e,z),q.push(K.slice()),ne=K[0],he=K[1]}}const te=(0,pe.PZ)(Oe.A,z);return"polyline"===P.type?new k.A({paths:F,spatialReference:te}):new ve.A({rings:F,spatialReference:te})}class I{constructor(A=0,z=void 0,$=void 0){this.distance=A,this.azimuth=z,this.reverseAzimuth=$}}function G(P,A,z,$,F){const te=A[0]*C.eh,ie=A[1]*C.eh,q=(z??0)*C.eh,{a:ce,b:Z,f:ne}=Me(F),he=Math.sin(q),de=Math.cos(q),V=(1-ne)*Math.tan(ie),ue=1/Math.sqrt(1+V*V),_e=V*ue,fe=Math.atan2(V,de),Pe=ue*he,ze=Pe*Pe,we=1-ze,D=we*(ce*ce-Z*Z)/(Z*Z),Ye=1+D/16384*(4096+D*(D*(320-175*D)-768)),qe=D/1024*(256+D*(D*(74-47*D)-128));let Fe,Ge,Re,We=$/(Z*Ye),lt=2*Math.PI;for(;Math.abs(We-lt)>1e-12;)Re=Math.cos(2*fe+We),Fe=Math.sin(We),Ge=Math.cos(We),lt=We,We=$/(Z*Ye)+qe*Fe*(Re+qe/4*(Ge*(2*Re*Re-1)-qe/6*Re*(4*Fe*Fe-3)*(4*Re*Re-3)));const Le=_e*Fe-ue*Ge*de,je=Math.atan2(_e*Ge+ue*Fe*de,(1-ne)*Math.sqrt(ze+Le*Le)),Ze=ne/16*we*(4+ne*(4-3*we)),ht=Math.atan2(Fe*he,ue*Ge-_e*Fe*de)-(1-Ze)*ne*Pe*(We+Ze*Fe*(Re+Ze*Ge*(2*Re*Re-1)));return P[0]=(te+ht)/C.eh,P[1]=je/C.eh,P}function U(P,A,z,$){const F=A[0]*C.eh,K=A[1]*C.eh,Q=z[0]*C.eh,te=z[1]*C.eh,{a:ie,b:q,f:ce,radius:Z}=Me($),ne=Q-F,he=Math.atan((1-ce)*Math.tan(K)),de=Math.atan((1-ce)*Math.tan(te)),V=Math.sin(he),ue=Math.cos(he),_e=Math.sin(de),fe=Math.cos(de);let Pe,ze,we,D,Ye,qe,Fe,Ge,Re,We,lt=1e3,Le=ne;do{if(Fe=Math.sin(Le),Ge=Math.cos(Le),we=Math.sqrt(fe*Fe*(fe*Fe)+(ue*_e-V*fe*Ge)*(ue*_e-V*fe*Ge)),0===we)return P.distance=0,P.azimuth=void 0,P.reverseAzimuth=void 0,P;Ye=V*_e+ue*fe*Ge,qe=Math.atan2(we,Ye),Re=ue*fe*Fe/we,ze=1-Re*Re,D=Ye-2*V*_e/ze,isNaN(D)&&(D=0),We=ce/16*ze*(4+ce*(4-3*ze)),Pe=Le,Le=ne+(1-We)*ce*Re*(qe+We*we*(D+We*Ye*(2*D*D-1)))}while(Math.abs(Le-Pe)>1e-12&&--lt>0);if(0===lt){const Rt=Z,Et=Math.acos(Math.sin(K)*Math.sin(te)+Math.cos(K)*Math.cos(te)*Math.cos(Q-F))*Rt,st=Q-F,dt=Math.sin(st)*Math.cos(te),At=Math.cos(K)*Math.sin(te)-Math.sin(K)*Math.cos(te)*Math.cos(st),It=Math.atan2(dt,At);return P.azimuth=It/C.eh,P.distance=Et,P.reverseAzimuth=void 0,P}const je=ze*(ie*ie-q*q)/(q*q),Ze=je/1024*(256+je*(je*(74-47*je)-128)),ht=q*(1+je/16384*(4096+je*(je*(320-175*je)-768)))*(qe-Ze*we*(D+Ze/4*(Ye*(2*D*D-1)-Ze/6*D*(4*we*we-3)*(4*D*D-3)))),Ct=Math.atan2(fe*Math.sin(Le),ue*_e-V*fe*Math.cos(Le)),Tt=Math.atan2(ue*Math.sin(Le),ue*_e*Math.cos(Le)-V*fe);return P.azimuth=Ct/C.eh,P.distance=ht,P.reverseAzimuth=Tt/C.eh,P}function X(P){return le(P)?P:(0,Y.K8)(P)?Oe.A.WGS84:null}},40856:(rt,Te,y)=>{y.d(Te,{X_:()=>j,i1:()=>ve,oW:()=>Me,zx:()=>Y});var W=y(69287),ye=y(82663);const pe=96;function j(ae,oe){const re=oe||ae.extent,le=ae.width,w=(0,ye.GA)(re?.spatialReference);return re&&le?re.width/le*w*ye.dy*pe:0}function ve(ae,oe){return ae/((0,ye.GA)(oe)*ye.dy*pe)}function Y(ae,oe,re){return function me(ae,oe){return 0===oe||(0,W.Sp)(ae,oe)||ae<oe}(ae,oe)&&function be(ae,oe){return 0===oe||(0,W.Sp)(ae,oe)||ae>oe}(ae,re)}function Me(ae,oe){return(0,W.Sp)(ae,oe)?0:(ae||Number.POSITIVE_INFINITY)>(oe||Number.POSITIVE_INFINITY)?1:-1}},40702:(rt,Te,y)=>{y.d(Te,{$B:()=>be});var W=y(8189),ye=y(98877),pe=y(3248),j=y(77806),ve=y(35150),k=y(85211),Oe=y(76576),C=y(79845),Y=y(26073);let be=class extends ye.A{constructor(w){super(w),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=(0,pe.A)("mapview-transitions-duration"),this.effects=[]}set effect(w){if(this._get("effect")!==(w=w||"")){this._set("effect",w);try{this._transitionTo(Me(w))}catch(_){this._transitionTo([]),ve.A.getLogger(this).warn("Invalid Effect",{effect:w,error:_})}}}get final(){return this._final}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(w){this._updateForScale(w)}get transitioning(){return null!==this._to}canTransitionTo(w){try{return this.scale>0&&ae(this._current,Me(w),this.scale)}catch{return!1}}transitionStep(w,_){this._applyTimeTransition(w),this._updateForScale(_)}endTransition(){this._applyTimeTransition(this.duration)}_transitionTo(w){this.scale>0&&ae(this._current,w,this.scale)?(this._final=w,this._to=(0,j.o8)(w),function oe(w,_,B){const I=w.length>_.length?w:_,G=w.length>_.length?_:w,U=G[G.length-1],N=U?.scale??B,se=U?.effects??[];for(let X=G.length;X<I.length;X++)G.push({scale:N,effects:[...se]});for(let X=0;X<I.length;X++)G[X].scale=-1===G[X].scale?B:G[X].scale,I[X].scale=-1===I[X].scale?B:I[X].scale,(0,Y.O9)(G[X].effects,I[X].effects)}(this._current,this._to,this.scale),this._from=(0,j.o8)(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=w),this._set("effects",this._current[0]?(0,j.o8)(this._current[0].effects):[])}_applyTimeTransition(w){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=w;const _=Math.min(1,this._time/this.duration);for(let B=0;B<this._current.length;B++){const I=this._current[B],G=this._from[B],U=this._to[B];I.scale=re(G.scale,U.scale,_);for(let N=0;N<I.effects.length;N++)I.effects[N].interpolate(G.effects[N],U.effects[N],_)}1===_&&(this._current=this._final,this._set("effects",this._current[0]?(0,j.o8)(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(w){if(this._set("scale",w),0===this._current.length)return;const _=this._current,B=this._current.length-1;let I,G,U=1;if(1===_.length||w>=_[0].scale)G=I=_[0].effects;else if(w<=_[B].scale)G=I=_[B].effects;else for(let N=0;N<B;N++){const se=_[N],X=_[N+1];if(se.scale>=w&&X.scale<=w){U=(w-se.scale)/(X.scale-se.scale),I=se.effects,G=X.effects;break}}for(let N=0;N<this.effects.length;N++)this.effects[N].interpolate(I[N],G[N],U)}};function Me(w){const _=(0,C.q)(w)||[];return function le(w){const _=w[0];return!!_&&"type"in _}(_)?[{scale:-1,effects:_}]:_}function ae(w,_,B){return!w[0]?.effects||!_[0]?.effects||!((-1===w[0]?.scale||-1===_[0]?.scale)&&(w.length>1||_.length>1)&&B<=0)&&(0,Y.mj)(w[0].effects,_[0].effects)}function re(w,_,B){return w+(_-w)*B}(0,W._)([(0,k.MZ)()],be.prototype,"_to",void 0),(0,W._)([(0,k.MZ)()],be.prototype,"duration",void 0),(0,W._)([(0,k.MZ)({value:""})],be.prototype,"effect",null),(0,W._)([(0,k.MZ)({readOnly:!0})],be.prototype,"effects",void 0),(0,W._)([(0,k.MZ)({readOnly:!0})],be.prototype,"final",null),(0,W._)([(0,k.MZ)({readOnly:!0})],be.prototype,"hasEffects",null),(0,W._)([(0,k.MZ)({value:0})],be.prototype,"scale",null),(0,W._)([(0,k.MZ)({readOnly:!0})],be.prototype,"transitioning",null),be=(0,W._)([(0,Oe.$)("esri.layers.effects.EffectView")],be)},96797:(rt,Te,y)=>{y.d(Te,{D:()=>pe});var W=y(10467),ye=y(89563);function pe(ve,k){return j.apply(this,arguments)}function j(){return(j=(0,W.A)(function*(ve,k){const{data:Oe}=yield(0,ye.A)(ve,{responseType:"image",...k});return Oe})).apply(this,arguments)}},54935:(rt,Te,y)=>{y.d(Te,{Fj:()=>Me,Z7:()=>me,ce:()=>ae,eR:()=>k,xt:()=>be});var W=y(86468),ye=y(61320),pe=y(9792),j=y(47669);const ve=.45;function k(w,_=.5){switch(w.type){case"CIMPointSymbol":{const B=w.symbolLayers;if(!B||1!==B.length)return null;const I=B[0];return"CIMVectorMarker"!==I.type?null:k(I)}case"CIMVectorMarker":{const B=w.markerGraphics;if(!B||1!==B.length)return null;const I=B[0];if(!I)return null;const G=I.geometry;if(!G)return null;const U=I.symbol;return!U||"CIMPolygonSymbol"!==U.type&&"CIMLineSymbol"!==U.type||U.symbolLayers?.some(N=>!!N.effects)?null:{type:"sdf",geom:G,sdfPaddingRatio:_,asFill:"CIMPolygonSymbol"===U.type}}}}function Y(w){let _=1/0,B=-1/0,I=1/0,G=-1/0;for(const U of w)for(const N of U)N[0]<_&&(_=N[0]),N[0]>B&&(B=N[0]),N[1]<I&&(I=N[1]),N[1]>G&&(G=N[1]);return[_,I,B,G]}function me(w){return w?w.rings?Y(w.rings):w.paths?Y(w.paths):(0,ye.ZC)(w)?[w.xmin,w.ymin,w.xmax,w.ymax]:null:null}function be(w,_){const[B,I,G,U]=me(w),N=G-B,se=U-I,X=j.p,P=j.hM,A=Math.floor(.5*(X*_-P)),z=(X-2*(A+P))/Math.max(N,se),$=Math.round(N*z),F=Math.round(se*z);return{pixelDimensions:[N,se],texelDimensions:[Math.round(($+2*A)/z),Math.round((F+2*A)/z)]}}function Me(w,_,B,I,G,U,N){const[se,X,P,A]=w;if(P<se||A<X)return{frameSizeRatio:0,anchorX:0,anchorY:0,widthRatio:1,sdfPaddingRatio:.5};const z=P-se,$=A-X,F=Math.max(z,$);let K=.5;if(null!=U&&null!=B){!N&&null!=_&&(U*=(_.ymax-_.ymin)/B);const fe=U/(U+F);fe>ve&&fe<1&&(K=Math.min(fe+.1,.99))}const Q=j.p,te=j.hM,ie=Math.floor(.5*(Q*K-te)),q=(Q-2*(ie+te))/F,ce=Math.round(z*q)+2*ie,Z=Math.round($*q)+2*ie;let ne=1;_&&(ne=Z*(1-K)/((_.ymax-_.ymin)*q));let he=0,de=0,V=1;I&&(G?_&&B&&_.ymax-_.ymin>0&&(V=(_.xmax-_.xmin)/(_.ymax-_.ymin),he=I.x/(B*V),de=I.y/B):(he=I.x,de=I.y)),_&&(he=.5*(_.xmax+_.xmin)+he*(_.xmax-_.xmin),de=.5*(_.ymax+_.ymin)+de*(_.ymax-_.ymin)),he-=se,de-=X,he*=q,de*=q,he+=ie,de+=ie;let ue=he/ce-.5,_e=de/Z-.5;return G&&B&&(ue*=B*V,_e*=B),{frameSizeRatio:ne,anchorX:ue,anchorY:_e,widthRatio:V,sdfPaddingRatio:K}}function ae(w){const _=function Oe(w){return w?w.rings?w.rings:w.paths?w.paths:void 0!==w.xmin&&void 0!==w.ymin&&void 0!==w.xmax&&void 0!==w.ymax?[[[w.xmin,w.ymin],[w.xmin,w.ymax],[w.xmax,w.ymax],[w.xmax,w.ymin],[w.xmin,w.ymin]]]:null:null}(w.geom),B=function C(w){let _=1/0,B=-1/0,I=1/0,G=-1/0;for(const U of w)for(const N of U)N[0]<_&&(_=N[0]),N[0]>B&&(B=N[0]),N[1]<I&&(I=N[1]),N[1]>G&&(G=N[1]);return new pe.A(_,I,B-_,G-I)}(_),I=j.p,G=j.hM,U=Math.floor(.5*(I*w.sdfPaddingRatio-G)),N=I-2*(U+G),se=N/Math.max(B.width,B.height),X=Math.round(B.width*se)+2*U,P=Math.round(B.height*se)+2*U,A=[];for(const $ of _)if($&&$.length>1){const F=[];for(const K of $){let[Q,te]=K;Q-=B.x,te-=B.y,Q*=se,te*=se,Q+=U-.5,te+=U-.5,F.push(w.asFill?[Q,te]:[Math.round(Q),Math.round(te)])}if(w.asFill){const K=F.length-1;F[0][0]===F[K][0]&&F[0][1]===F[K][1]||F.push(F[0])}A.push(F)}const z=function oe(w,_,B,I){const G=_*B,U=new Array(G),N=I*I+1;for(let se=0;se<G;++se)U[se]=N;for(const se of w){const X=se.length;for(let P=1;P<X;++P){const A=se[P-1],z=se[P];let $,F,K,Q;A[0]<z[0]?($=A[0],F=z[0]):($=z[0],F=A[0]),A[1]<z[1]?(K=A[1],Q=z[1]):(K=z[1],Q=A[1]);let te=Math.floor($)-I,ie=Math.floor(F)+I,q=Math.floor(K)-I,ce=Math.floor(Q)+I;te<0&&(te=0),ie>_&&(ie=_),q<0&&(q=0),ce>B&&(ce=B);const Z=z[0]-A[0],ne=z[1]-A[1],he=Z*Z+ne*ne;for(let de=te;de<ie;de++)for(let V=q;V<ce;V++){const ue=de+.5,_e=V+.5;let fe,Pe,ze=(ue-A[0])*Z+(_e-A[1])*ne;ze<0?(fe=A[0],Pe=A[1]):ze>he?(fe=z[0],Pe=z[1]):(ze/=he,fe=A[0]+ze*Z,Pe=A[1]+ze*ne);const we=(ue-fe)*(ue-fe)+(_e-Pe)*(_e-Pe),D=(B-V-1)*_+de;we<U[D]&&(U[D]=we)}}}for(let se=0;se<G;++se)U[se]=Math.sqrt(U[se]);return U}(A,X,P,U);return w.asFill&&function re(w,_,B,I,G){for(const U of w){const N=U.length;for(let se=1;se<N;++se){const X=U[se-1],P=U[se];let A,z,$,F;X[0]<P[0]?(A=X[0],z=P[0]):(A=P[0],z=X[0]),X[1]<P[1]?($=X[1],F=P[1]):($=P[1],F=X[1]);let K=Math.floor(A),Q=Math.floor(z)+1,te=Math.floor($),ie=Math.floor(F)+1;K<I&&(K=I),Q>_-I&&(Q=_-I),te<I&&(te=I),ie>B-I&&(ie=B-I);for(let q=te;q<ie;++q){if(X[1]>q==P[1]>q)continue;const ce=q+.5,Z=(B-q-1)*_;for(let ne=K;ne<Q;++ne)ne+.5<(P[0]-X[0])*(ce-X[1])/(P[1]-X[1])+X[0]&&(G[Z+ne]=-G[Z+ne]);for(let ne=I;ne<K;++ne)G[Z+ne]=-G[Z+ne]}}}}(A,X,P,U,z),{data:le(z,U),width:X,height:P,sdfPaddingRatio:w.sdfPaddingRatio,sdfDecodeCoeff:2*U/N}}function le(w,_){const B=2*_,I=w.length,G=new Uint8Array(4*I);for(let U=0;U<I;++U)(0,W.U)(.5-w[U]/B,G,4*U);return G}},88766:(rt,Te,y)=>{y.d(Te,{m:()=>k});var W=y(9700),ye=y(4032),pe=y(12273),j=y(40702),ve=y(63888);class k extends ve.q{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this._children=[],this._childrenObservable=new ye.I,this._effectView=null,this._highlightGradient=null}get blendMode(){return this._blendMode}set blendMode(C){this._blendMode=C,this.requestRender()}get children(){return(0,W.gc)(this._childrenObservable),this._children}get clips(){return this._clips}set clips(C){this._clips=C,this.children.forEach(Y=>Y.clips=C)}get computedEffects(){return this._effectView?.effects??null}get effect(){return this._effectView?.effect??""}set effect(C){(this._effectView||C)&&(this._effectView||(this._effectView=new j.$B,this.addTransitionable(this._effectView)),this._effectView.effect=C,this.requestRender())}get highlightGradient(){return this._highlightGradient}set highlightGradient(C){this._highlightGradient=C,this.requestRender()}get hasBlending(){return!!this.blendMode}get hasHighlight(){return this.children.some(C=>C.hasHighlight)}get hasLabels(){return this.children.some(C=>C.hasLabels)}get requiresDedicatedFBO(){return this.children.some(C=>"blendMode"in C&&C.blendMode&&"normal"!==C.blendMode)}get isReady(){return this.children.every(C=>C.isReady)}get sortFunction(){return this._sortFunction}set sortFunction(C){this._sortFunction=C,C&&(this._needsSort=!0)}doRender(C){const Y=this.createRenderParams(C),{painter:me}=Y;me.beforeRenderLayer(Y,this._clips?.length?255:0,this.computedOpacity),this.renderChildren(Y),me.afterRenderLayer(Y,this.computedOpacity)}addChild(C){return this.addChildAt(C,this.children.length)}addChildAt(C,Y=this.children.length){if(!C||this.contains(C))return C;this._needsSort=!0;const me=C.parent;return me&&me!==this&&me.removeChild(C),Y>=this.children.length?this.children.push(C):this.children.splice(Y,0,C),this._childrenSet.add(C),C.parent=this,C.stage=this.stage,this!==this.stage&&(C.clips=this.clips),this.requestRender(),this._childrenObservable.notify(),C}contains(C){return(0,W.gc)(this._childrenObservable),this._childrenSet.has(C)}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const C of this.children)this!==this.stage&&(C.clips=null),C.stage=null,C.parent=null;this.children.length=0,this._childrenObservable.notify()}removeChild(C){return this.contains(C)?this.removeChildAt(this.children.indexOf(C)):C}removeChildAt(C){if(C<0||C>=this.children.length)return null;this._needsSort=!0;const Y=this.children.splice(C,1)[0];return this._childrenSet.delete(Y),this!==this.stage&&(Y.clips=null),Y.stage=null,Y.parent=null,this._childrenObservable.notify(),Y}beforeRender(C){super.beforeRender(C),this.sortFunction&&this._needsSort&&(this.children.sort(this.sortFunction),this._needsSort=!1,this._childrenObservable.notify());for(const Y of this.children)Y.beforeRender(C)}afterRender(C){super.afterRender(C);for(const Y of this.children)Y.afterRender(C)}_createTransforms(){return{displayViewScreenMat3:(0,pe.vt)()}}onAttach(){super.onAttach();const C=this.stage;for(const Y of this.children)Y.stage=C}onDetach(){super.onDetach();for(const C of this.children)C.stage=null}renderChildren(C){for(const Y of this.children)Y.processRender(C)}createRenderParams(C){return{...C,requireFBO:this.requiresDedicatedFBO,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:C.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition,highlightGradient:this._highlightGradient||C.highlightGradient}}isTransitioning(){return super.isTransitioning()||this.children.some(C=>C.transitioning)}}},63888:(rt,Te,y)=>{y.d(Te,{q:()=>j});var W=y(89952),ye=y(42425),pe=y(77273);class j extends ye.A{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(k){this._clips=k,this.requestRender()}get fadeTransitionEnabled(){return null!==this._fadeTransition}set fadeTransitionEnabled(k){!this._fadeTransition&&k?(this._fadeTransition=new pe.A({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!k&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(k){this._opacity!==k&&(this._opacity=Math.min(1,Math.max(k,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(k){if(this._stage===k)return;const Oe=this._stage;this._stage=k,k?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):Oe?.trashDisplayObject(this)}get transforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get visible(){return this._visible}set visible(k){this._visible!==k&&(this._visible=k,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(k){this._transitionables??=[],this._transitionables.push(k),this.requestRender()}removeTransitionable(k){k.endTransition(),this._transitionables&&(0,W.TF)(this._transitionables,k),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const k=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),k}fadeOut(){this.fadeTransitionEnabled=!0;const k=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),k}endTransitions(){if(this._transitionables){for(const k of this._transitionables)k.endTransition();this.requestRender()}}beforeRender(k){this.transitionStep(k.deltaTime,k.state.scale),this.setTransform(k.state)}afterRender(k){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(k){}processRender(k){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(k)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some(k=>k.transitioning)??!1}transitionStep(k,Oe){if(this._transitionables)for(const C of this._transitionables)C.transitionStep(k,Oe)}onAttach(){}onDetach(){}doRender(k){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},77273:(rt,Te,y)=>{y.d(Te,{A:()=>Y});var W=y(8189),ye=y(98877),pe=y(3248),j=y(56492),ve=y(85211),C=(y(35150),y(40707),y(76576));let Y=class extends ye.A{constructor(me){super(me),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=(0,j.Tw)()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=(0,j.Tw)()),this._fadeOutResolver.promise}transitionStep(me,be){const Me=(0,pe.A)("mapview-transitions-duration"),ae=Me?1/Me:0;if(0===ae)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const oe=this._fadeOutResolver||!this.visible?0:this.opacity,re=this.computedOpacity;if(re===oe)this.computedVisible=this.visible;else{const le=me*ae;this.computedOpacity=re>oe?Math.max(oe,re-le):Math.min(oe,re+le),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}};(0,W._)([(0,ve.MZ)()],Y.prototype,"computedOpacity",void 0),(0,W._)([(0,ve.MZ)()],Y.prototype,"computedVisible",void 0),(0,W._)([(0,ve.MZ)()],Y.prototype,"opacity",void 0),(0,W._)([(0,ve.MZ)()],Y.prototype,"visible",void 0),(0,W._)([(0,ve.MZ)()],Y.prototype,"transitioning",null),(0,W._)([(0,ve.MZ)()],Y.prototype,"_fadeOutResolver",void 0),(0,W._)([(0,ve.MZ)()],Y.prototype,"_fadeInResolver",void 0),Y=(0,W._)([(0,C.$)("esri.views.2d.engine.transitions.FadeTransition")],Y)},89906:(rt,Te,y)=>{y.r(Te),y.d(Te,{GraphicContainer:()=>fs.A,GraphicsView2D:()=>ps.A,GridView2D:()=>Rs,LabelManager:()=>us.C,MagnifierView2D:()=>xs,MapViewNavigation:()=>ms.A,Stage:()=>ds});var W=y(10467),ye=y(5922),pe=y(3248),j=y(11432),ve=y(3804),k=y(54029),Oe=y(12273),C=y(29430),Y=y(98894),me=y(77806),be=y(35150),Me=y(67685),ae=y(1119),oe=y(8548),re=y(46988),le=y(65374),w=y(54935),_=y(32117),B=y(80862);function I(d,i,n){return{transform:K(d,i,n.transform),fromColor:Q(d,i,n.fromColor),toColor:te(d,i,n.toColor),colorMix:ie(d,i,n.colorMix),toOpacity:q(d,i,n.toOpacity),opacityMix:ce(d,i,n.opacityMix),hasAnimations:n.hasAnimations||!!i.animations&&i.animations.length>0}}function G(d){return!oe.H.forceStaticPath&&(oe.H.forceAnimatedPath||d.hasAnimations)}function N(d,i){let n=0,a=0;const o="Absolute"!==d.anchorPointUnits;return d.anchorPoint&&(n=-d.anchorPoint.x,a=-d.anchorPoint.y),{...i,transform:{type:"AnimatedTransform",relativeTranslation:o,absoluteScale:!1,translation:V([n,a]),rotation:V(0),scale:V(1),parent:i.transform}}}function P(d,i,n){return{...d,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:V([i,n]),rotation:V(0),scale:V(1),parent:d.transform}}}function A(d,i){const n=i?.5*-(i.xmin+i.xmax):0,a=i?.5*-(i.ymin+i.ymax):0;let o=0,l=0;if("x"in d&&"y"in d)o=d.x+n,l=d.y+a;else{const h=(0,w.Z7)(d);h&&(o=(h[0]+h[2])/2+n,l=(h[1]+h[3])/2+a)}return[o,l]}function z(d,i){switch(i.type){case"CIMPictureMarker":case"CIMVectorMarker":return(0,_.dI)(d,i,"Rotation")}return 0}function F(d,i){switch(i.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return(0,_.dI)(d,i,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return(0,_.dI)(d,i,"TintColor")}return[1,1,1,1]}function K(d,i,n){return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:he(d,i),rotation:de(d,i),scale:ne(d,i),parent:n}}function Q(d,i,n){return{type:"AnimatedColor",color:V(F(d,i)),opacity:V(1),parent:n}}function te(d,i,n){const{animations:a}=i;let o=F(d,i);const l=a?.filter(h=>"CIMSymbolAnimationColor"===h.type)[0];return l&&(o=(0,_.dI)(d,l,"ToColor")),{type:"AnimatedColor",color:V(o),opacity:V(1),parent:n}}function ie(d,i,n){const{animations:a}=i,o=a?.filter(l=>"CIMSymbolAnimationColor"===l.type)[0];return o?{type:"AnimatedColor",color:V([1,1,1,1]),opacity:{from:0,to:1,timing:Z(d,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:n}function q(d,i,n){const{animations:a}=i;let o=V(1);const l=a?.filter(h=>"CIMSymbolAnimationTransparency"===h.type)[0];return l&&(o=V({type:"Process",op:"Transparency",value:(0,_.dI)(d,l,"ToTransparency")})),{type:"AnimatedColor",color:V([1,1,1,1]),opacity:o,parent:n}}function ce(d,i,n){const{animations:a}=i,o=a?.filter(l=>"CIMSymbolAnimationTransparency"===l.type)[0];return o?{type:"AnimatedColor",color:V([1,1,1,1]),opacity:{from:0,to:1,timing:Z(d,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:n}function Z(d,i){if(!i)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:B.mv.Local,repeatType:le.fu.Loop,easing:le.Hz.Linear,playAnimation:1,reverseAnimation:0};const n=(0,_.dI)(d,i,"Duration");let a;a=(0,_.dI)(d,i,"RandomizeStartTime")?{type:"Process",op:"Random",min:0,max:n,seed:(0,_.dI)(d,i,"RandomizeStartSeed")}:(0,_.dI)(d,i,"StartTimeOffset");const o=(0,_.dI)(d,i,"RepeatDelay"),l=(0,_.dI)(d,i,"PlayAnimation"),h=(0,_.dI)(d,i,"ReverseAnimation"),c=(0,_._W)(i.repeatType,re.D.CIMAnimatedSymbolProperties.repeattype);return{duration:n,startTimeOffset:a,repeatDelay:o,timeOriginSelector:c===le.fu.None?B.mv.Local:B.mv.Global,repeatType:c,easing:(0,_._W)(i.easing,re.D.CIMAnimatedSymbolProperties.easing),playAnimation:l,reverseAnimation:h}}function ne(d,i){const{animations:n}=i;if("CIMPictureMarker"!==i.type&&"CIMVectorMarker"!==i.type&&"CIMPointSymbol"!==i.type)return V(1);let a;a="CIMPictureMarker"===i.type||"CIMVectorMarker"===i.type?(0,_.dI)(d,i,"Size"):(0,_.YC)(i)||10;const o=n?.filter(l=>"CIMSymbolAnimationScale"===l.type)[0];if(!o){const l=n?.filter(h=>"CIMSymbolAnimationSize"===h.type)[0];return l?{from:1,to:{type:"Process",op:"Divide",left:(0,_.dI)(d,l,"ToSize"),right:a},timing:Z(d,l.animatedSymbolProperties)}:V(1)}return{from:1,to:(0,_.dI)(d,o,"ScaleFactor"),timing:Z(d,o.animatedSymbolProperties)}}function he(d,i){const{animations:n}=i,a=n?.filter(o=>"CIMSymbolAnimationOffset"===o.type)[0];return a?{from:[0,0],to:[(0,_.dI)(d,a,"OffsetX"),(0,_.dI)(d,a,"OffsetY")],timing:Z(d,a.animatedSymbolProperties)}:V([0,0])}function de(d,i){const{animations:n}=i,a=function $(d,i){switch(i.type){case"CIMPictureMarker":case"CIMVectorMarker":return(0,_.dI)(d,i,"RotateClockwise")}return 0}(d,i),o={type:"Process",op:"Divide",left:z(d,i),right:{type:"Process",op:"Cond",condition:a,ifTrue:-1,ifFalse:1}},l=n?.filter(c=>"CIMSymbolAnimationRotation"===c.type)[0];if(!l)return V(o);const h={type:"Process",op:"Add",left:(0,_.dI)(d,l,"ToRotation"),right:{type:"Process",op:"Divide",left:o,right:-1}};return{from:o,to:{type:"Process",op:"Add",left:o,right:{type:"Process",op:"Cond",condition:(0,_.dI)(d,l,"RotateClockwise"),ifTrue:{type:"Process",op:"MatchWinding",sign:-1,angle:h},ifFalse:{type:"Process",op:"MatchWinding",sign:1,angle:h}}},timing:Z(d,l.animatedSymbolProperties)}}function V(d){return{from:d,to:d,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:B.mv.Local,repeatType:le.fu.Loop,easing:le.Hz.Linear,playAnimation:1,reverseAnimation:0}}}function ue(d){if(null==d||"object"!=typeof d)return!1;if(d.animations&&Array.isArray(d.animations)&&d.animations.length>0)return!0;for(const i in d)if(ue(d[i]))return!0;return!1}var _e=y(26747),fe=y(10223);function ze(d,i){if(!d.frame)return d;const{markerGraphics:n}=d;if(!n||0===n.length)return d;let a=0,o=0,l=0,h=0;for(const H of n){const{geometry:ee,symbol:L}=H;if(!ee||!L||!("symbolLayers"in L))continue;const{symbolLayers:ge}=L;if(ge)for(const xe of ge){const{effects:De}=xe,Se=fe.V.applyEffects(De,ee,i),Ce=(0,w.Z7)(Se);Ce&&(a=Math.min(a,Ce[0]),o=Math.min(o,Ce[1]),l=Math.max(l,Ce[2]),h=Math.max(h,Ce[3]))}}const{xmin:c,ymin:f,xmax:u,ymax:m}=d.frame,g=(u-c)/2,b=(m-f)/2,v=(u+c)/2,S=(m+f)/2;if(g<=0||b<=0)return d;const E=(S-o)/b,T=(h-S)/b,J=Math.max(Math.max((v-a)/g,(l-v)/g),Math.max(E,T));return J<=1.01||(d=(0,me.o8)(d)).frame&&(d.frame.xmin=(d.frame.xmin-v)*J+v,d.frame.ymin=(d.frame.ymin-S)*J+S,d.frame.xmax=(d.frame.xmax-v)*J+v,d.frame.ymax=(d.frame.ymax-S)*J+S,!1!==d.respectFrame&&(d.size*=J)),d}var we=y(51298),D=y(47669);const Ye=()=>be.A.getLogger("esri.symbols.cim.cimAnalyzer");function qe(d){const i=d.markerPlacement;return i&&i.angleToLine?le.C1.MAP:le.C1.SCREEN}class Fe{constructor(i){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],i&&(this._resourceManager=i)}analyzeSymbolReference(i,n,a){if(this._cimLayers=a??[],!i)return this._cimLayers;if(this._reset(),i.primitiveOverrides){this._primitiveOverrides=i.primitiveOverrides;for(const o of this._primitiveOverrides){const l=o.valueExpressionInfo;if(l)this._setPoMap(o.primitiveName,o.propertyName,l);else if(null!=o.value){let h=o.value;o.propertyName.includes("Color")&&((0,C.IB)(h)&&(h=(0,_.G9)(h)),h=(0,_.e6)(h)),this._setPoMap(o.primitiveName,o.propertyName,h)}}}return this._analyzeSymbol(i.symbol,n),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(i,n){switch(i?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(i,n)}}_analyzeMultiLayerSymbol(i,n){const a=i?.symbolLayers;if(!a)return;for(let m=0;m<a.length;m++){const g=a[m];"CIMVectorMarker"===g.type&&(a[m]=ze(g,this._resourceManager.geometryEngine))}const o=i.effects;let l=le.C1.SCREEN;const h=(0,_.YC)(i)??0;"CIMPointSymbol"===i.type&&"Map"===i.angleAlignment&&(l=le.C1.MAP);let c={transform:[0,0,0,1],fromColor:[1,1,1,1],toColor:[1,1,1,1],colorMix:[0,0,0,0],toOpacity:[1,1,1,1],opacityMix:[0,0,0,0],hasAnimations:ue(i)};c=I(this._poMap,i,c);const f="CIMPolygonSymbol"===i.type;let u=a.length;for(;u--;){const m=a[u];if(!m||!1===m.enable)continue;let g;o?.length&&(g=[...o]);const b=m.effects;b?.length&&(o?g.push(...b):g=[...b]);let v=null;if(g){v=[];for(const O of g){const R=we.OverrideHelper.findEffectOverrides(O,this._primitiveOverrides);R&&v.push(R)}}switch(we.OverrideHelper.findApplicableOverrides(m,this._primitiveOverrides,[]),m.type){case"CIMSolidFill":this._analyzeSolidFill(m,v);break;case"CIMPictureFill":this._analyzePictureFill(m,v);break;case"CIMHatchFill":this._analyzeHatchFill(m,v);break;case"CIMGradientFill":this._analyzeGradientFill(m,v);break;case"CIMSolidStroke":this._analyzeSolidStroke(m,v,f,h);break;case"CIMPictureStroke":this._analyzePictureStroke(m,v,f,h);break;case"CIMGradientStroke":this._analyzeGradientStroke(m,v,f,h);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==i.type&&"CIMPolygonSymbol"!==i.type||(l=qe(m));const O=[],R=m.primitiveName;R&&O.push(R);const E=f&&(0,_.zr)(m.markerPlacement);this._analyzeMarker(m,v,null,O,l,h,n,[],c,!1,E);break}default:Ye().error("Cannot analyze CIM layer",m.type)}}}_analyzeSolidFill(i,n){const{primitiveName:a,type:o}=i,l=(0,_.e6)(i.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!i.colorLocked,color:this._getValueOrOverrideExpression(o,a,"Color",l),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:n,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(i,n){const{primitiveName:a,type:o}=i,l=(0,_.Ny)(i),h=(0,_.$w)(i.height,re.D.CIMPictureFill.height);let c=(0,_.$w)(i.scaleX,1);if("width"in i&&"number"==typeof i.width){const u=i.width;let m=1;const g=this._resourceManager.getResource(i.url);null!=g&&(m=g.width/g.height),c/=m*(h/u)}const f={type:"sprite-rasterization-param",resource:i,overrides:this._getPrimitiveMaterialOverrides(a,o)};this._cimLayers.push({type:"fill",spriteRasterizationParam:f,colorLocked:!!i.colorLocked,effects:n,color:this._getValueOrOverrideExpression(o,a,"TintColor",l),height:this._getValueOrOverrideExpression(o,a,"Height",h),scaleX:this._getValueOrOverrideExpression(o,a,"ScaleX",c),angle:this._getValueOrOverrideExpression(o,a,"Rotation",(0,_.$w)(i.rotation)),offsetX:this._getValueOrOverrideExpression(o,a,"OffsetX",(0,_.$w)(i.offsetX)),offsetY:this._getValueOrOverrideExpression(o,a,"OffsetY",(0,_.$w)(i.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(i,n){const{primitiveName:a,type:o}=i,l=this._analyzeMaterialOverrides(a,["Rotation","OffsetX","OffsetY"]),h=(0,_.pk)(l);let c=[255,255,255,1],f=!1;if(i.lineSymbol?.symbolLayers)for(const m of i.lineSymbol.symbolLayers){if("CIMSolidStroke"!==m.type)continue;const g=m.primitiveName??a;f||!g||m.colorLocked||null==this._poMap[g]?.Color&&null==this._poMap[g]?.StrokeColor||(c=(0,_.e6)(m.color),c=this._maybeGetValueOrOverrideExpression(g,"StrokeColor")??this._getValueOrOverrideExpression(o,g,"Color",c),f=!0);const b=this._maybeGetValueOrOverrideExpression(g,"StrokeWidth");if(b){let v=null,S=null;"number"==typeof b?v=b:S=b.valueExpressionInfo;let O=h.find(R=>"strokeWidth"===R.propertyName);O?O.propertyName="width":(O={type:"CIMPrimitiveOverride",primitiveName:g,propertyName:"width",valueExpressionInfo:S,value:v,defaultValue:(0,_.iA)(o,"width")},h.push(O))}}this._cimLayers.push({type:"fill",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:i,overrides:h},colorLocked:!!i.colorLocked,effects:n,color:c,height:this._getValueOrOverrideExpression(o,a,"Separation",(0,_.$w)(i.separation,re.D.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(o,a,"Rotation",(0,_.$w)(i.rotation)),offsetX:this._getValueOrOverrideExpression(o,a,"OffsetX",(0,_.$w)(i.offsetX)),offsetY:this._getValueOrOverrideExpression(o,a,"OffsetY",(0,_.$w)(i.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!f})}_analyzeGradientFill(i,n){const{angle:a,gradientMethod:o,gradientSize:l,gradientSizeUnits:h,gradientType:c,interval:f,primitiveName:u,type:m}=i,g=re.D.CIMGradientFill,b=i.colorRamp;this._cimLayers.push({type:"gradientFill",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:i,overrides:this._getPrimitiveMaterialOverrides(u,m)},colorLocked:!1,effects:n,color:[255,255,255,1],gradientMethod:this._getValueOrOverrideExpression(m,u,"GradientMethod",o??"Linear"),angle:this._getValueOrOverrideExpression(m,u,"Angle",(0,_.$w)(a,g.angle)),gradientType:this._getValueOrOverrideExpression(m,u,"GradientType",c??g.gradientType),interval:this._getValueOrOverrideExpression(m,u,"Interval",(0,_.$w)(f,"CIMFixedColorRamp"===b.type?b.colors.length:g.interval)),gradientSize:this._getValueOrOverrideExpression(m,u,"GradientSize",(0,_.$w)(l,g.gradientSize)),gradientSizeUnits:"Absolute"===h?le.OW.Absolute:"Relative"===h?le.OW.Relative:g.gradientSizeUnits})}_analyzeSolidStroke(i,n,a,o){const{primitiveName:l,type:h}=i,c=(0,_.e6)(i.color),f=(0,_.$w)(i.width,re.D.CIMSolidStroke.width),u=(0,_.GV)(i.capStyle,re.D.CIMSolidStroke.capstyle),m=(0,_.GV)(i.joinStyle,re.D.CIMSolidStroke.joinstyle),g=i.miterLimit;let b,v,S,O,R=[];if(this._analyzePrimitiveOverrides(l,n,null,null)&&(R=this._getPrimitiveMaterialOverrides(l,h)),n&&Array.isArray(n)&&n.length>0){const T=n[n.length-1].effect;T&&"CIMGeometricEffectDashes"===T.type&&"NoConstraint"===T.lineDashEnding&&(b=T.dashTemplate,v=T.scaleDash,S=T.offsetAlongLine,O=T.primitiveName,(n=[...n]).pop())}null!=O&&R.push(...this._getPrimitiveMaterialOverrides(O,h).filter(T=>"dashTemplate"===T.propertyName)),this._cimLayers.push({type:"line",spriteRasterizationParam:void 0!==b?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:b,primitiveName:O},overrides:R}:null,isOutline:a,colorLocked:!!i.colorLocked,effects:n,color:this._getValueOrOverrideExpression(h,l,"Color",c),width:this._getValueOrOverrideExpression(h,l,"Width",f),cap:this._getValueOrOverrideExpression(h,l,"CapStyle",u),join:this._getValueOrOverrideExpression(h,l,"JoinStyle",m),miterLimit:g&&this._getValueOrOverrideExpression(h,l,"MiterLimit",g),referenceWidth:o,zOrder:Re(i.name),dashTemplate:this._maybeGetValueOrOverrideExpression(O,"DashTemplate")??b,offsetAlongLine:this._getValueOrOverrideExpression(h,O,"OffsetAlongLine",S??0),scaleDash:v,sampleAlphaOnly:!0})}_analyzePictureStroke(i,n,a,o){const{primitiveName:l,type:h}=i,c=(0,_.Ny)(i),f=(0,_.$w)(i.width,re.D.CIMPictureStroke.width),u=(0,_.GV)(i.capStyle,re.D.CIMPictureStroke.capstyle),m=(0,_.GV)(i.joinStyle,re.D.CIMPictureStroke.joinstyle),g=i.miterLimit,b={type:"sprite-rasterization-param",resource:i,overrides:this._getPrimitiveMaterialOverrides(l,h)};this._cimLayers.push({type:"line",spriteRasterizationParam:b,isOutline:a,colorLocked:!!i.colorLocked,effects:n,color:this._getValueOrOverrideExpression(h,l,"TintColor",c),width:this._getValueOrOverrideExpression(h,l,"Width",f),cap:this._getValueOrOverrideExpression(h,l,"CapStyle",u),join:this._getValueOrOverrideExpression(h,l,"JoinStyle",m),miterLimit:g&&this._getValueOrOverrideExpression(h,l,"MiterLimit",g),referenceWidth:o,zOrder:Re(i.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(i,n,a,o){const{gradientMethod:l,gradientSize:h,gradientSizeUnits:c,gradientType:f,interval:u,primitiveName:m,type:g}=i,b=re.D.CIMGradientStroke,v=(0,_.$w)(i.width,b.width),S=(0,_.GV)(i.capStyle,b.capstyle),O=(0,_.GV)(i.joinStyle,b.joinstyle),R=i.miterLimit,E=i.colorRamp;this._cimLayers.push({type:"gradientStroke",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:i,overrides:this._getPrimitiveMaterialOverrides(m,g)},colorLocked:!!i.colorLocked,effects:n,color:[255,255,255,1],width:this._getValueOrOverrideExpression(g,m,"Width",v),cap:this._getValueOrOverrideExpression(g,m,"CapStyle",S),join:this._getValueOrOverrideExpression(g,m,"JoinStyle",O),miterLimit:R&&this._getValueOrOverrideExpression(g,m,"MiterLimit",R),referenceWidth:o,isOutline:a,gradientMethod:this._getValueOrOverrideExpression(g,m,"GradientMethod",l??b.gradientMethod),gradientType:this._getValueOrOverrideExpression(g,m,"GradientType",f??b.gradientType),interval:this._getValueOrOverrideExpression(g,m,"Interval",(0,_.$w)(u,"CIMFixedColorRamp"===E.type?E.colors.length:b.interval)),gradientSize:this._getValueOrOverrideExpression(g,m,"GradientSize",(0,_.$w)(h,b.gradientSize)),gradientSizeUnits:"Absolute"===c?le.OW.Absolute:"Relative"===c?le.OW.Relative:b.gradientSizeUnits})}_analyzeMarker(i,n,a,o,l,h,c,f,u,m=!1,g=!1){if(m||=!!i.colorLocked,this._analyzeMarkerInsidePolygon(i,n,m))return;const b=(0,_.$w)(i.size,re.D.CIMVectorMarker.size),v=(0,_.$w)(i.rotation),S=(0,_.$w)(i.offsetX),O=(0,_.$w)(i.offsetY),{primitiveName:R,type:E}=i,T=this._getValueOrOverrideExpression(E,R,"Size",b),J=this._getValueOrOverrideExpression(E,R,"Rotation",v),H=this._getValueOrOverrideExpression(E,R,"OffsetX",S),ee=this._getValueOrOverrideExpression(E,R,"OffsetY",O);let L=u;switch(L=I(this._poMap,i,L),L=function X(d,i){return"Absolute"!==d.anchorPointUnits?i:N(d,i)}(i,L),L=function U(d,i,n){if("CIMCharacterMarker"===i.type)return be.A.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),n;const a=(0,_.dI)(d,i,"OffsetX"),o=(0,_.dI)(d,i,"OffsetY");if("CIMPictureMarker"===i.type)return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:V([a,o]),rotation:V(0),scale:V((0,_.dI)(d,i,"Size")),parent:n.transform}};const l=i.frame,h=l.ymax-l.ymin;return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:V([a,o]),rotation:V(0),scale:V({type:"Process",op:"Divide",left:(0,_.dI)(d,i,"Size"),right:h}),parent:n.transform}}}(this._poMap,i,L),L=function se(d,i){return"Absolute"===d.anchorPointUnits?i:N(d,i)}(i,L),i.type){case"CIMPictureMarker":this._analyzePictureMarker(i,n,a,o,l,h,T,J,H,ee,f,L,m,g);break;case"CIMVectorMarker":this._analyzeVectorMarker(i,n,a,o,l,h,T,J,H,ee,f,L,c,m,g)}}_analyzeMarkerInsidePolygon(i,n,a){const{markerPlacement:o,type:l}=i;if(!o||"CIMMarkerPlacementInsidePolygon"!==o.type)return!1;if("CIMVectorMarker"===l||"CIMPictureMarker"===l){const b=i.primitiveName;if(b&&this._analyzePrimitiveOverrides([b],n,null,null))return!1;const v=o.primitiveName;if(v&&this._analyzePrimitiveOverrides([v],n,null,null))return!1;if("CIMVectorMarker"===l){const{markerGraphics:S}=i;if(S)for(const O of S){const{symbol:R}=O;if("CIMPolygonSymbol"===R?.type&&R.symbolLayers){const{symbolLayers:E}=R;for(const T of E)if("CIMSolidStroke"===T.type)return!1}}}else{const{animatedSymbolProperties:S}=i;if(S)return!1}}const h=Math.abs(o.stepX),c=Math.abs(o.stepY);if(0===h||0===c)return!0;let f,u;if("Random"===o.gridType){const b=(0,Me.PN)(D.yv),v=Math.max(Math.floor(b/h),1);f=c*Math.max(Math.floor(b/c),1),u=v*h/f}else o.shiftOddRows?(f=2*c,u=h/c*.5):(f=c,u=h/c);const m=(0,_.Ny)(i);return this._cimLayers.push({type:"fill",spriteRasterizationParam:"CIMCharacterMarker"===i.type?null:{type:"sprite-rasterization-param",resource:i,overrides:[]},colorLocked:a,effects:n,color:m,height:f,scaleX:u,angle:o.gridAngle,offsetX:(0,_.$w)(o.offsetX),offsetY:(0,_.$w)(o.offsetY),applyRandomOffset:"Random"===o.gridType,sampleAlphaOnly:"CIMPictureMarker"!==i.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(i,n,a,o,l,h,c,f,u,m,g,b,v,S){const{animatedSymbolProperties:O,primitiveName:R,type:E}=i;let T=(0,_.$w)(i.scaleX,1);const J=(0,_.Ny)(i);a||(a=this._createMarkerPlacementOverrideExpression(i.markerPlacement));const H=this._createGIFAnimatedSymbolPropertiesOverrideExpression(O),ee=i.anchorPoint??{x:0,y:0};if("width"in i&&"number"==typeof i.width){const Se=i.width;let Ce=1;const Be=this._resourceManager.getResource(i.url);null!=Be&&(Ce=Be.width/Be.height),T/=Ce*((0,_.$w)(i.size)/Se)}const L=[...o];let ge;i.primitiveName&&L.push(i.primitiveName),O||H?ge={type:"animated",url:i.url,urlHash:"H"+(0,ae.Wm)(i.url),playAnimation:i.animatedSymbolProperties?.playAnimation,reverseAnimation:i.animatedSymbolProperties?.reverseAnimation,randomizeStartTime:i.animatedSymbolProperties?.randomizeStartTime,randomizeStartSeed:i.animatedSymbolProperties?.randomizeStartSeed,startTimeOffset:i.animatedSymbolProperties?.startTimeOffset,duration:i.animatedSymbolProperties?.duration,repeatType:i.animatedSymbolProperties?.repeatType,repeatDelay:i.animatedSymbolProperties?.repeatDelay}:(ge=(0,me.o8)(i),ge.markerPlacement=null);const xe={type:"sprite-rasterization-param",resource:ge,overrides:this._getMaterialOverrides(L,E)};H&&xe.overrides.push(...H.overrides);const De=c;this._cimLayers.push({type:"marker",spriteRasterizationParam:xe,colorLocked:v,effects:n,scaleSymbolsProportionally:!1,alignment:l,size:c,scaleX:this._getValueOrOverrideExpression(E,R,"ScaleX",T),rotation:f,offsetX:u,offsetY:m,transform:{type:"cim-marker-transform-param",params:g},color:this._getValueOrOverrideExpression(E,R,"TintColor",J),anchorPoint:{x:ee.x,y:ee.y},isAbsoluteAnchorPoint:"Relative"!==i.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!i.rotateClockwise,referenceSize:h,sizeRatio:1,isOutline:S,markerPlacement:a,animationParams:ht(b),baseSize:De})}_analyzeVectorMarker(i,n,a,o,l,h,c,f,u,m,g,b,v,S,O){const R=i.markerGraphics;if(!R)return;const E=i.frame;let T=0;T=E?E.ymax-E.ymin:h;const J=!!i.scaleSymbolsProportionally;if(T){const H={offsetX:u,offsetY:m,rotation:f,size:c,frameHeight:T,rotateClockWise:!!i.rotateClockwise,absoluteAnchorPoint:!1,scaleSymbolsProportionally:J};g=[...g,H]}a||(a=this._createMarkerPlacementOverrideExpression(i.markerPlacement));for(const H of R)if(H){const ee=H.symbol;if(!ee)continue;const L=H.primitiveName;L&&o.push(L);let ge,xe=b;if(("CIMPointSymbol"===ee.type||"CIMTextSymbol"===ee.type)&&E){let Be=0,Ae=0;const Xe=H.geometry;"x"in Xe&&"y"in Xe&&(Be+=Xe.x-.5*(E.xmin+E.xmax),Ae+=Xe.y-.5*(E.ymin+E.ymax));const Ne=i.anchorPoint;let ot=!1;Ne&&("Absolute"===i.anchorPointUnits?(Be-=Ne.x,Ae-=Ne.y,ot=!0):E&&(Be-=(E.xmax-E.xmin)*Ne.x,Ae-=(E.ymax-E.ymin)*Ne.y));const pt={offsetX:Be,offsetY:Ae,rotation:0,size:0,frameHeight:0,rotateClockWise:!1,absoluteAnchorPoint:ot,scaleSymbolsProportionally:J};ge=[...g,pt]}const De=H.geometry,[Se,Ce]=A(De,E);switch(0===Se&&0===Ce||(xe=P(xe,Se,Ce)),"CIMPointSymbol"===ee.type&&(xe=I(this._poMap,ee,xe)),ee.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":v||Le(ee)?(xe={...xe,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:V([0,0]),rotation:V(0),scale:V(T),parent:b.transform}},this._analyzeMultiLayerGraphicNonSDF(i,n,a,H,o,l,h,ge??g,xe,T,S,O)):this._analyzeMultiLayerGraphic(i,n,a,H,o,l,h,ge??g,xe,T,S,O);break;case"CIMTextSymbol":this._analyzeTextGraphic(n,a,H,o,l,h,ge??g,S)}L&&o.pop()}}_analyzeMultiLayerGraphic(i,n,a,o,l,h,c,f,u,m,g,b){const v=o.symbol.symbolLayers;v&&(!lt(v)||G(u)?function je(d){return d.some(i=>"CIMSolidFill"!==i.type&&"CIMSolidStroke"!==i.type&&("CIMVectorMarker"!==i.type&&"CIMPictureMarker"!==i.type||null!=i.markerPlacement))}(v)?this._analyzeMultiLayerGraphicNonSDF(i,n,a,o,l,h,c,f,u,m,!!g,b):this._analyzeMarkerGraphicSymbolLayers(i,n,a,o,l,h,c,f,u,m,g,b):this._analyzeCompositeMarkerGraphic(i,n,a,o,v,h,c,f,m,g,b))}_analyzeMarkerGraphicSymbolLayers(i,n,a,o,l,h,c,f,u,m,g,b){const v=o.symbol,S=v.symbolLayers;if(!S)return;const O=this._resourceManager.geometryEngine,R=fe.V.applyEffects(v.effects,o.geometry,O);if(!R)return;let E=S.length;for(;E--;){const T=S[E];if(!T||!1===T.enable)continue;const J=T.primitiveName;switch(J&&l.push(J),T.type){case"CIMSolidFill":case"CIMSolidStroke":{const H=fe.V.applyEffects(T.effects,R,O),ee=(0,w.Z7)(H);if(!ee)continue;const L="Relative"!==i.anchorPointUnits,ge=(0,_.xo)(T)??0,{frameSizeRatio:xe,anchorX:De,anchorY:Se,widthRatio:Ce,sdfPaddingRatio:Be}=(0,w.Fj)(ee,i.frame,i.size,i.anchorPoint,L,ge,i.scaleSymbolsProportionally),Ae="CIMSolidFill"===T.type,Xe={type:"sdf",geom:H,sdfPaddingRatio:Be,asFill:Ae},{path:Ne}=T,ot=Ae?(0,_.e6)((0,_.pM)(T)):null==Ne?(0,_.e6)((0,_._1)(T)):[0,0,0,0],pt=Ae?[0,0,0,0]:(0,_.e6)((0,_._1)(T));if(!Ae&&!ge)break;const ft=o.primitiveName;let gt=null;Ae&&!T.colorLocked&&(gt=this._maybeGetValueOrOverrideExpression(ft,"FillColor"));let yt=null;Ae||T.colorLocked||(yt=this._maybeGetValueOrOverrideExpression(ft,"StrokeColor"));const Pt=gt??this._getValueOrOverrideExpression(T.type,J,"Color",ot),Zt=yt??this._getValueOrOverrideExpression(T.type,J,"Color",pt),St=this._maybeGetValueOrOverrideExpression(ft,"StrokeWidth")??this._getValueOrOverrideExpression(T.type,J,"Width",ge),Jt=Ne?{type:"sprite-rasterization-param",resource:{type:"path",path:Ne,asFill:Ae},overrides:[]}:{type:"sprite-rasterization-param",resource:Xe,overrides:[]},Ve=I(this._poMap,T,u),Ke=(0,_.$w)(i.size,re.D.CIMVectorMarker.size),it=this._getValueOrOverrideExpression(i.type,i.primitiveName,"Size",Ke);this._cimLayers.push({type:"marker",spriteRasterizationParam:Jt,colorLocked:!!T.colorLocked||!!g,effects:n,scaleSymbolsProportionally:!!i.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:De,y:Se},isAbsoluteAnchorPoint:L,size:m,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:f},frameHeight:m,widthRatio:Ce,rotateClockwise:!1,referenceSize:c,sizeRatio:xe,color:Pt,outlineColor:Zt,outlineWidth:St,isOutline:b,markerPlacement:a,animationParams:ht(Ve),isStroke:"CIMSolidFill"!==T.type,baseSize:it,...(0,w.xt)(H,Be)});break}case"CIMPictureMarker":case"CIMVectorMarker":if(T.markerPlacement){Ye().error("Error analyzing CIM, got unexpected marker placement");break}this._analyzeMarker(T,n,a,l,h,c,!1,f,u,g,b)}J&&l.pop()}}_analyzeTextGraphic(i,n,a,o,l,h,c,f){we.OverrideHelper.findApplicableOverrides(a,this._primitiveOverrides,[]);const m=a.geometry;if(!("x"in m)||!("y"in m))return;const g=a.symbol,b=(0,_.DW)(g),v=(0,_._d)(g.fontStyleName),S=(0,Y.af)(g.fontFamilyName);g.font={family:S,decoration:b,...v};const O=(0,_.$w)(g.height,re.D.CIMTextSymbol.height),R=(0,_.$w)(g.angle),E=(0,_.$w)(g.offsetX),T=(0,_.$w)(g.offsetY),{haloSymbol:J}=g,H=(0,_.$w)(g.haloSize,0);let ee=[0,0,0,0];if(J?.symbolLayers?.length){const Ve=J.symbolLayers;for(const Ke of Ve)if(Ke.color){ee=this._getValueOrOverrideExpression(g?.haloSymbol?.type??"CIMPolygonSymbol",Ke.primitiveName,"Color",(0,_.e6)(Ke.color));break}}const L=a.primitiveName;let ge=[0,0,0,1],xe=[0,0,0,0],De=0,Se=!1;if(g.symbol?.symbolLayers)for(const Ve of g.symbol.symbolLayers){const Ke=Ve.primitiveName;if("CIMSolidStroke"===Ve.type)xe=this._getValueOrOverrideExpression("CIMSolidStroke",Ke,"Color",(0,_.e6)(Ve.color)),De=this._getValueOrOverrideExpression("CIMSolidStroke",Ke,"Width",(0,_.xo)(Ve)??0);else if("CIMSolidFill"===Ve.type){const it=(0,_.e6)(Ve.color);Se=Se??!!Ve.colorLocked,ge=this._getValueOrOverrideExpression("CIMSolidFill",Ke??L,"Color",it)}}let Ce=null,Be=null,Ae=null,Xe=null,Ne=null;L&&(Ce=this._maybeGetValueOrOverrideExpression(L,"TextSize"),Be=this._maybeGetValueOrOverrideExpression(L,"TextAngle"),Ae=this._maybeGetValueOrOverrideExpression(L,"TextOffsetX"),Xe=this._maybeGetValueOrOverrideExpression(L,"TextOffsetY"),Se||(Ne=this._maybeGetValueOrOverrideExpression(L,"FillColor")));const ot=Ne??ge;let pt=null,ft=null,gt=0;if(g.callout&&"CIMBackgroundCallout"===g.callout.type){const Ve=g.callout;if(Ve.backgroundSymbol){const Ke=Ve.backgroundSymbol.symbolLayers;if(Ke)for(const it of Ke)"CIMSolidFill"===it.type?pt=(0,_.e6)(it.color):"CIMSolidStroke"===it.type&&(ft=(0,_.e6)(it.color),gt=(0,_.$w)(it.width,re.D.CIMSolidStroke.width))}}const yt=this._getValueOrOverrideExpression(g.type,a.primitiveName,"TextString",a.textString??"");if(null==yt)return;const{fontStyleName:Pt}=g,Zt=S+(Pt?"-"+Pt.toLowerCase():"-regular"),St=this._getMaterialOverrides(o,g.type);St.push(...this._getPrimitiveMaterialOverrides(a.primitiveName,g.type)),this._cimLayers.push({type:"text",lineWidth:g.lineWidth,textRasterizationParam:{type:"text-rasterization-param",resource:{type:"text",textString:a.textString??"",font:g.font,symbol:g,primitiveName:a.primitiveName},overrides:St},colorLocked:!!f||!!Se,effects:i,alignment:l,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:Zt,decoration:b,haloSize:H,haloColor:ee,weight:v.weight,style:v.style,size:Ce??O,angle:Be??R,offsetX:Ae??E,offsetY:Xe??T,transform:{type:"cim-marker-transform-param",params:c},horizontalAlignment:(0,_.Bu)(g.horizontalAlignment),verticalAlignment:(0,_.Nl)(g.verticalAlignment),text:yt,color:ot,outlineColor:xe,outlineSize:De,backgroundColor:pt,borderLineColor:ft,borderLineWidth:gt,referenceSize:h,sizeRatio:1,markerPlacement:n})}_analyzeMultiLayerGraphicNonSDF(i,n,a,o,l,h,c,f,u,m,g,b){const v=function Ge(d,i){return{type:d.type,enable:!0,name:d.name,colorLocked:d.colorLocked,primitiveName:d.primitiveName,anchorPoint:d.anchorPoint,anchorPointUnits:d.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:d.rotateClockwise,rotation:0,size:d.size,billboardMode3D:d.billboardMode3D,depth3D:d.depth3D,frame:d.frame,markerGraphics:[i],scaleSymbolsProportionally:d.scaleSymbolsProportionally,respectFrame:d.respectFrame,clippingPath:d.clippingPath}}(i,o),S=i.primitiveName,O=this._analyzeMaterialOverrides(S,["Rotation","OffsetX","OffsetY"]),R=(0,_.pk)(O),[E,T,J]=_e.wp.getTextureAnchor(v,this._resourceManager,D.oj),H=this._getMaterialOverrides(l,i.type);H.push(...R);const ee={type:"sprite-rasterization-param",resource:{...v,avoidSDFRasterization:!0},overrides:H},L=(0,_.$w)(i.size,re.D.CIMVectorMarker.size),ge=this._getValueOrOverrideExpression(i.type,S,"Size",L);this._cimLayers.push({type:"marker",spriteRasterizationParam:ee,colorLocked:g,effects:n,scaleSymbolsProportionally:!!i.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:E,y:T},isAbsoluteAnchorPoint:!1,size:m,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:f},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:m,widthRatio:1,rotateClockwise:!!i.rotateClockwise,referenceSize:c,sizeRatio:J/(0,Me.Lz)(i.size),isOutline:b,markerPlacement:a,animationParams:ht(u),baseSize:ge})}_createMarkerPlacementOverrideExpression(i){if(!i)return null;const n=[];return we.OverrideHelper.findApplicableOverrides(i,this._primitiveOverrides,n),{type:"cim-marker-placement-param",placement:i,overrides:Ze(n)}}_createGIFAnimatedSymbolPropertiesOverrideExpression(i){if(!i)return null;const n=[];return we.OverrideHelper.findApplicableOverrides(i,this._primitiveOverrides,n),{type:"cim-gif-animation-params",animation:i,overrides:Ze(n)}}_analyzeCompositeMarkerGraphic(i,n,a,o,l,h,c,f,u,m,g){const b=o.geometry,v=l[0],S=l[1],O=(0,w.Z7)(b);if(!O)return;const R="Relative"!==i.anchorPointUnits,E=(0,_.$w)(v.width,re.D.CIMSolidStroke.width),{frameSizeRatio:T,anchorX:J,anchorY:H,widthRatio:ee,sdfPaddingRatio:L}=(0,w.Fj)(O,i.frame,i.size,i.anchorPoint,R,E,i.scaleSymbolsProportionally),{path:ge}=S,xe=S.primitiveName,De=v.primitiveName,Se=o.primitiveName;let Ce=null;S.colorLocked||m||(Ce=this._maybeGetValueOrOverrideExpression(Se,"FillColor"));const Be=Ce??this._getValueOrOverrideExpression(S.type,xe,"Color",(0,_.e6)(S.color));let Ae=null;v.colorLocked||m||(Ae=this._maybeGetValueOrOverrideExpression(Se,"StrokeColor"));const Xe=Ae??this._getValueOrOverrideExpression(v.type,De,"Color",(0,_.e6)(v.color)),Ne=this._maybeGetValueOrOverrideExpression(Se,"StrokeWidth")??this._getValueOrOverrideExpression(v.type,De,"Width",E);this._cimLayers.push({type:"marker",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:ge?{type:"path",path:ge,asFill:!0}:{type:"sdf",geom:b,sdfPaddingRatio:L,asFill:!0},overrides:[]},colorLocked:m,effects:n,scaleSymbolsProportionally:!!i.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:J,y:H},isAbsoluteAnchorPoint:R,size:u,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:f},frameHeight:u,widthRatio:ee,rotateClockwise:!1,referenceSize:c,sizeRatio:T,color:Be,outlineColor:Xe,outlineWidth:Ne,isOutline:g,markerPlacement:a})}_setPoMap(i,n,a){let o;this._poMap[i]?o=this._poMap[i]:(o={},this._poMap[i]=o),o[n]=a}_maybeGetValueOrOverrideExpression(i,n,a){return this._getValueOrOverrideExpression("",i,n,a,!1)}_getValueOrOverrideExpression(i,n,a,o,l=!0){if(l&&!(0,_.ZO)(o)&&(o=(0,_.iA)(i,a.toLowerCase())),null==n)return o;const h=this._poMap[n];if(null==h)return o;const c=h[a];return"string"==typeof c||"number"==typeof c||Array.isArray(c)?c:c?{valueExpressionInfo:c,defaultValue:o}:o}_analyzePrimitiveOverrides(i,n,a,o){if(null==i)return!1;"string"==typeof i&&(i=[i]);for(const l of this._primitiveOverrides)if(i.includes(l.primitiveName)&&l.valueExpressionInfo)return!0;if(null!=n)for(const l of n)if(l?.overrides.length>0)return!0;if(null!=a)for(const l of a)if(l?.overrides.length>0)return!0;if(null!=o)for(const l of o)if(l?.overrides.length>0)return!0;return!1}_getMaterialOverrides(i,n){if(!i)return[];const a=[];for(const o of i)a.push(...this._getPrimitiveMaterialOverrides(o,n));return a}_getPrimitiveMaterialOverrides(i,n){if(!i)return[];const a=(0,_.pk)(this._primitiveOverrides.filter(o=>o.primitiveName===i));return a.forEach(o=>o.defaultValue=(0,_.iA)(n,o.propertyName.toLowerCase())),a}_analyzeMaterialOverrides(i,n){return this._primitiveOverrides.filter(a=>a.primitiveName!==i||!n.includes(a.propertyName))}}function Re(d){if(d&&0===d.indexOf("Level_")){const i=parseInt(d.slice(6),10);if(!isNaN(i))return i}return 0}const lt=d=>d&&2===d.length&&d[0].enable&&d[1].enable&&"CIMSolidStroke"===d[0].type&&"CIMSolidFill"===d[1].type&&null==d[0].path&&null==d[1].path&&!d[0].effects&&!d[1].effects&&!d[0].animations&&!d[1].animations;function Le(d){const i=d.symbolLayers;if(!i)return!1;const n=i.find(o=>o.effects?.find(l=>"CIMGeometricEffectDashes"===l.type&&null!=l.dashTemplate)),a=i.find(o=>o.effects?.find(l=>"CIMGeometricEffectAddControlPoints"===l.type));return!!n||!!a}function Ze(d){return(0,me.o8)(d).map(i=>({...i,propertyName:(0,_.YF)(i.propertyName)}))}function ht(d){return G(d)?{type:"animation-params",params:d}:null}var Ct=y(88766),Tt=y(42425),Rt=y(40611),Et=y(17715),st=y(69287),dt=y(76329),At=y(44999);class It{constructor(i){this.events=new Tt.A,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const n={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0,powerPreference:"high-performance"};i.appendChild(this._canvas);let a=this._canvas.getContext("webgl2",n);a||(a=this._canvas.getContext("webgl2",{...n,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=a,this._handles=(0,Et.vE)([(0,Rt.on)(this._canvas,"webglcontextlost",o=>this.events.emit("webgl-context-lost",o))])}destroy(){this._canvas.parentNode?.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(i,n){if(this._hasMajorPerformanceCaveat||(0,pe.A)("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=(0,pe.A)("esri-performance-mode-frames-between-render")&&(n(),this._lastRenderViewState=i.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[a,o,l,h,c,f]=this._computeViewTransform(this._lastRenderViewState,i.state);this._canvas.style.transform=`matrix(${a}, ${o}, ${l}, ${h}, ${c}, ${f})`}}else n()}resize(i){const n=this._canvas,a=n.style,{state:{size:o},pixelRatio:l}=i,h=o[0],c=o[1],f=Math.round(h*l),u=Math.round(c*l);n.width===f&&n.height===u||(n.width=f,n.height=u),a.width=h+"px",a.height=c+"px"}_computeViewTransform(i,n){const[a,o]=i.center,[l,h]=n.center,[c,f]=i.toScreen([0,0],l,h),[u,m]=i.toScreen([0,0],a,o),g=u-c,b=m-f,v=i.scale/n.scale,S=n.rotation-i.rotation,O=(0,At.vt)();return(0,dt.D_)(O),(0,dt.hs)(O,O,[v,v]),(0,dt.e$)(O,O,(0,st.kU)(S)),(0,dt.Tl)(O,O,[g,b]),O}}var Ie=y(69473),Qt=y(46707),ke=y(20904);const Ai={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}},Fi=new(y(87805).Z)(function zi(d){let i=Ai;return d.split("/").forEach(n=>{i&&(i=i[n])}),i});function Ue(d){return Fi.resolveIncludes(d)}var vt=y(37488);const qt=d=>(0,vt.I)({PATTERN:d.pattern}),Bi={shaders:d=>({vertexShader:qt(d)+Ue("background/background.vert"),fragmentShader:qt(d)+Ue("background/background.frag")})},Di={shaders:d=>({vertexShader:Ue("circle/circle.vert"),fragmentShader:Ue("circle/circle.frag")})},ei=d=>(0,vt.I)({PATTERN:d.pattern}),Li={shaders:d=>({vertexShader:ei(d)+Ue("fill/fill.vert"),fragmentShader:ei(d)+Ue("fill/fill.frag")})},ki={shaders:d=>({vertexShader:Ue("outline/outline.vert"),fragmentShader:Ue("outline/outline.frag")})},ti=d=>(0,vt.I)({SDF:d.sdf}),Ui={shaders:d=>({vertexShader:ti(d)+Ue("icon/icon.vert"),fragmentShader:ti(d)+Ue("icon/icon.frag")})},ii=d=>(0,vt.I)({PATTERN:d.pattern,SDF:d.sdf}),Ni={shaders:d=>({vertexShader:ii(d)+Ue("line/line.vert"),fragmentShader:ii(d)+Ue("line/line.frag")})},Vi={shaders:d=>({vertexShader:Ue("text/text.vert"),fragmentShader:Ue("text/text.frag")})};class Gi{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(i=>i.dispose()),this._programByKey.clear()}getMaterialProgram(i,n,a){const o=n.key<<3|this._getMaterialOptionsValue(n.type,a);if(this._programByKey.has(o))return this._programByKey.get(o);const l=this._getProgramTemplate(n.type),{shaders:h}=l,{vertexShader:c,fragmentShader:f}=h(a),u=n.getShaderHeader(),m=n.getShaderMain(),g=c.replace("#pragma header",u).replace("#pragma main",m),b=i.programCache.acquire(g,f,n.getAttributeLocations());return this._programByKey.set(o,b),b}_getMaterialOptionsValue(i,n){switch(i){case ke.kh.BACKGROUND:case ke.kh.FILL:return(n.pattern?1:0)<<1;case ke.kh.OUTLINE:return 0;case ke.kh.LINE:return(n.sdf?1:0)<<2|(n.pattern?1:0)<<1;case ke.kh.ICON:return(n.sdf?1:0)<<1;default:return 0}}_getProgramTemplate(i){switch(i){case ke.kh.BACKGROUND:return Bi;case ke.kh.CIRCLE:return Di;case ke.kh.FILL:return Li;case ke.kh.ICON:return Ui;case ke.kh.LINE:return Ni;case ke.kh.OUTLINE:return ki;case ke.kh.TEXT:return Vi;default:return null}}}var Wi=y(9599),ri=y(6115),si=y(32788),x=y(50915),Mt=y(80831),ni=y(45513);class ai{constructor(){this._initialized=!1}dispose(){this._program=(0,j.WD)(this._program),this._vertexArrayObject=(0,j.WD)(this._vertexArrayObject)}render(i,n,a,o){i&&(this._initialized||this._initialize(i),i.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),i.bindVAO(this._vertexArrayObject),i.useProgram(this._program),n.setSamplingMode(a),i.bindTexture(n,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",o),i.drawArrays(x.WR.TRIANGLE_STRIP,0,4),i.bindTexture(null,0),i.bindVAO())}_initialize(i){if(this._initialized)return!0;const n=(0,Mt.r)(i,ri.J);if(!n)return!1;const a=new Int8Array(16);a[0]=-1,a[1]=-1,a[2]=0,a[3]=0,a[4]=1,a[5]=-1,a[6]=1,a[7]=0,a[8]=-1,a[9]=1,a[10]=0,a[11]=1,a[12]=1,a[13]=1,a[14]=1,a[15]=1;const l=new ni.Z(i,ri.J.attributes,Wi.oI,new Map([["geometry",si.g.createVertex(i,x._U.STATIC_DRAW,a)]]));return this._program=n,this._vertexArrayObject=l,this._initialized=!0,!0}}var Hi=y(3276);class ji{constructor(i){this._rctx=i,this._programByKey=new Map}dispose(){this._programByKey.forEach(i=>i.dispose()),this._programByKey.clear()}getProgram(i,n=[]){const a=i.vsPath+"."+i.fsPath+JSON.stringify(n);if(this._programByKey.has(a))return this._programByKey.get(a);const o={...n.map(m=>"string"==typeof m?{name:m,value:!0}:m).reduce((m,g)=>({...m,[g.name]:g.value}),{})},{vsPath:l,fsPath:h,attributes:c}=i,f=(0,Hi.p)(l,h,c,o),u=this._rctx.programCache.acquire(f.shaders.vertexShader,f.shaders.fragmentShader,f.attributes);if(!u)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(a,u),u}}var $i=y(23098),mt=y(89563),Ki=y(47139),Je=y(56492),Yi=y(71635),Xi=y(96128),zt=y(28685),Zi=y(9792);class Qi{constructor(i){this._resourceManager=i,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(i){switch(i.type){case"dash":{const n=(0,_.K3)(i.dashTemplate),[a,o,l]=(0,zt.f0)(n);return{size:[o,l],image:new Uint32Array(a.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[n,a,o,l]=(0,zt.c5)(this._canvas,i,D.nW);return{size:[a,o],image:new Uint32Array(n.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:l}}case"sdf":return oi(i);case"CIMGradientFill":case"CIMGradientStroke":case"CIMHatchFill":case"CIMPictureMarker":case"CIMVectorMarker":return this._rasterizeCIMJSONResource(i)}}_rasterizeCIMJSONResource(i){switch(i.type){case"CIMGradientFill":case"CIMGradientStroke":{const[n,a,o]=(0,zt.Kj)(this._canvas,i);return{size:[a,o],image:new Uint32Array(n.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0,samplingMode:"Discrete"===i.gradientType||"CIMFixedColorRamp"===i.colorRamp.type?"Nearest":"Linear"}}case"CIMHatchFill":{const n=_e.wp.fromCIMHatchFill(i,D.nW);return this._rasterizeCIMVectorMarker(n)}case"CIMPictureMarker":{const n=_e.wp.fromCIMInsidePolygon(i);return this._rasterizeCIMVectorMarker(n)}case"CIMVectorMarker":{if("CIMMarkerPlacementInsidePolygon"===i.markerPlacement?.type){const a=_e.wp.fromCIMInsidePolygon(i);return this._rasterizeCIMVectorMarker(a)}const n=(0,w.eR)(i);return n&&!i.avoidSDFRasterization?oi(n):this._rasterizeCIMVectorMarker(i,!1,D.oj)}}}_rasterizeCIMVectorMarker(i,n=!0,a){const o=n?Zi.A.fromExtent(i.frame):null,[l,h,c,f,u]=_e.wp.rasterize(this._canvas,i,o,this._resourceManager,!0,a);return l?{size:[h,c],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:f,anchorY:u}:null}rasterizeImageResource(i,n,a,o){this._canvas.width=i,this._canvas.height=n;const l=this._canvas.getContext("2d",{willReadFrequently:!0});a instanceof ImageData?l.putImageData(a,0,0):(a.setAttribute("width",`${i}px`),a.setAttribute("height",`${n}px`),l.drawImage(a,0,0,i,n));const h=l.getImageData(0,0,i,n),c=new Uint8Array(h.data);if(o)for(const v of o)if(v&&v.oldColor&&4===v.oldColor.length&&v.newColor&&4===v.newColor.length){const[S,O,R,E]=v.oldColor,[T,J,H,ee]=v.newColor;if(S===T&&O===J&&R===H&&E===ee)continue;for(let L=0;L<c.length;L+=4)S===c[L]&&O===c[L+1]&&R===c[L+2]&&E===c[L+3]&&(c[L]=T,c[L+1]=J,c[L+2]=H,c[L+3]=ee)}let f;for(let v=0;v<c.length;v+=4)f=c[v+3]/255,c[v]=c[v]*f,c[v+1]=c[v+1]*f,c[v+2]=c[v+2]*f;let u=c,m=i,g=n;const b=512;if(m>=b||g>=b){const v=m/g;v>1?(m=b,g=Math.round(b/v)):(g=b,m=Math.round(b*v)),u=new Uint8Array(4*m*g);const S=new Uint8ClampedArray(u.buffer);(0,_.Go)(c,i,n,S,m,g,!1)}return{size:[m,g],image:new Uint32Array(u.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}function oi(d){if(!d)return null;const{data:i,width:n,height:a,sdfPaddingRatio:o,sdfDecodeCoeff:l}=(0,w.ce)(d);return i?{size:[n,a],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,sdfPaddingRatio:o,sdfDecodeCoeff:l,anchorX:0,anchorY:0}:null}var He=y(68973);class bt{constructor(i,n){this._width=0,this._height=0,this._free=[],this._width=i,this._height=n,this._free.push(new He.A(0,0,i,n))}get width(){return this._width}get height(){return this._height}allocate(i,n){if(i>this._width||n>this._height)return new He.A;let a=null,o=-1;for(let l=0;l<this._free.length;++l){const h=this._free[l];i<=h.width&&n<=h.height&&(null===a||h.y<=a.y&&h.x<=a.x)&&(a=h,o=l)}return null===a?new He.A:(this._free.splice(o,1),a.width<a.height?(a.width>i&&this._free.push(new He.A(a.x+i,a.y,a.width-i,n)),a.height>n&&this._free.push(new He.A(a.x,a.y+n,a.width,a.height-n))):(a.width>i&&this._free.push(new He.A(a.x+i,a.y,a.width-i,a.height)),a.height>n&&this._free.push(new He.A(a.x,a.y+n,i,a.height-n))),new He.A(a.x,a.y,i,n))}release(i){for(let n=0;n<this._free.length;++n){const a=this._free[n];if(a.y===i.y&&a.height===i.height&&a.x+a.width===i.x)a.width+=i.width;else if(a.x===i.x&&a.width===i.width&&a.y+a.height===i.y)a.height+=i.height;else if(i.y===a.y&&i.height===a.height&&i.x+i.width===a.x)a.x=i.x,a.width+=i.width;else{if(i.x!==a.x||i.width!==a.width||i.y+i.height!==a.y)continue;a.y=i.y,a.height+=i.height}this._free.splice(n,1),this.release(i)}this._free.push(i)}}var Qe=y(76169),Ee=y(4931);const er=d=>Math.floor(d/256);class sr{constructor(i,n,a){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=i,this.height=n,this._glyphSource=a,this._binPack=new bt(i-4,n-4),this._glyphData.push(new Uint8Array(i*n)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const i of this._textures)i&&i.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const i=[117,149,181,207,207,181,149,117],n=[],a=[];for(let h=0;h<i.length;h++){const c=i[h];for(let f=0;f<11;f++){const u=h>=3&&h<5&&f>=3&&f<8?255:0;n.push(c),a.push(u)}}const o={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(n)},l={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(a)};this._recordGlyph(o),this._recordGlyph(l)}getTexture(i,n){if(!this._textures[n]){const a=new Ee.R;a.pixelFormat=x.Ab.ALPHA,a.wrapMode=x.pF.CLAMP_TO_EDGE,a.width=this.width,a.height=this.height,this._textures[n]=new Qe.g(i,a,new Uint8Array(this.width*this.height))}return this._dirties[n]&&(this._textures[n].setData(this._glyphData[n]),this._dirties[n]=!1),this._textures[n]}getGlyphItems(i,n,a){var o=this;return(0,W.A)(function*(){const l=o._getGlyphCache(i);return yield o._fetchRanges(i,n,a),n.map(h=>o._getMosaicItem(l,i,h))})()}bind(i,n,a,o){const l=this.getTexture(i,a);l.setSamplingMode(n),i.bindTexture(l,o)}preloadASCIIGlyphCache(i){const n=this._preloadCache[i];if(null!=n)return n;const a=this._glyphSource.preloadASCIIRange(i).then(()=>{const o=this._getGlyphCache(i);for(let l=0;l<256;l++)this._getMosaicItem(o,i,l)});return this._preloadCache[i]=a,a}_getGlyphCache(i){return this._glyphCache[i]||(this._glyphCache[i]={}),this._glyphCache[i]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(i,n,a){var o=this;return(0,W.A)(function*(){const l=function tr(d){const i=new Set;for(const n of d)i.add(er(n));return i}(n),h=[];l.forEach(c=>{h.push(o._fetchRange(i,c,a))}),yield Promise.all(h)})()}_fetchRange(i,n,a){var o=this;return(0,W.A)(function*(){if(!(n>256))return function ir(d,i,n){return d.has(i)||d.set(i,n().then(()=>{d.delete(i)}).catch(a=>{d.delete(i),(0,Je.jH)(a)})),d.get(i)}(o._rangePromises,i+n,()=>o._glyphSource.getRange(i,n,a))})()}_getMosaicItem(i,n,a){if(!i[a]){const o=this._glyphSource.getGlyph(n,a);if(!o?.metrics)return d=a,{rect:new He.A(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:d,sdf:!0};const l=this._recordGlyph(o);i[a]={rect:l,page:this._currentPage,metrics:o.metrics,code:a,sdf:!0},this._invalidate()}var d;return i[a]}_recordGlyph(i){const n=i.metrics;let a;if(0===n.width)a=new He.A(0,0,0,0);else{const l=n.width+6,h=n.height+6;a=this._binPack.allocate(l,h),a.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new bt(this.width-4,this.height-4),a=this._binPack.allocate(l,h));const c=this._glyphData[this._currentPage],f=i.bitmap;let u,m;if(f)for(let g=0;g<h;g++){u=l*g,m=this.width*(a.y+g)+a.x;for(let b=0;b<l;b++)c[m+b]=f[u+b]}(0,pe.A)("esri-glyph-debug")&&this._showDebugPage(c)}return a}_showDebugPage(i){const n=document.createElement("canvas"),a=n.getContext("2d"),o=new ImageData(this.width,this.height),l=o.data;n.width=this.width,n.height=this.height,n.style.border="1px solid black";for(let h=0;h<i.length;++h)l[4*h]=i[h],l[4*h+1]=0,l[4*h+2]=0,l[4*h+3]=255;a.putImageData(o,0,0),document.body.appendChild(n)}}var li=y(55912);class hi{constructor(i){for(this._metrics=[],this._bitmaps=[];i.next();)switch(i.tag()){case 1:{const n=i.getMessage();for(;n.next();)switch(n.tag()){case 3:{const a=n.getMessage();let o,l,h,c,f,u,m;for(;a.next();)switch(a.tag()){case 1:o=a.getUInt32();break;case 2:l=a.getBytes();break;case 3:h=a.getUInt32();break;case 4:c=a.getUInt32();break;case 5:f=a.getSInt32();break;case 6:u=a.getSInt32();break;case 7:m=a.getUInt32();break;default:a.skip()}a.release(),o&&(this._metrics[o]={width:h,height:c,left:f,top:u,advance:m},this._bitmaps[o]=l);break}default:n.skip()}n.release();break}default:i.skip()}}getMetrics(i){return this._metrics[i]}getBitmap(i){return this._bitmaps[i]}}class nr{constructor(){this._ranges=[]}getRange(i){return this._ranges[i]}addRange(i,n){this._ranges[i]=n}}class ar{constructor(i){this._glyphInfo={},this._baseURL=i}getRange(i,n,a){const o=this._getFontStack(i);if(o.getRange(n))return Promise.resolve();const l=256*n,h=l+255,c=this._baseURL.replace("{fontstack}",i).replace("{range}",l+"-"+h);return(0,mt.A)(c,{responseType:"array-buffer",...a}).then(f=>{o.addRange(n,new hi(new li.A(new Uint8Array(f.data),new DataView(f.data))))})}preloadASCIIRange(i){var n=this;return(0,W.A)(function*(){const a=n._getFontStack(i),h=n._baseURL.replace("{fontstack}",i).replace("{range}","0-255"),c=yield(0,mt.A)(h,{responseType:"array-buffer"}),f=new hi(new li.A(new Uint8Array(c.data),new DataView(c.data)));for(let u=0;u<=255;u++)a.getRange(u)||a.addRange(u,f)})()}getGlyph(i,n){const a=this._getFontStack(i);if(!a)return;const o=Math.floor(n/256),l=a.getRange(o);return l?{metrics:l.getMetrics(n),bitmap:l.getBitmap(n)}:void 0}_getFontStack(i){let n=this._glyphInfo[i];return n||(n=this._glyphInfo[i]=new nr),n}}var or=y(86468),Ft=y(40794);const ci=1e20;class lr{constructor(i,n=2){this._textureSize=i,this._rasterizationScale=n,this._canvasSize=this._textureSize*this._rasterizationScale,this._svg=null;const{_canvasSize:a}=this,o=document.createElement("canvas");o.width=o.height=a,this._context=o.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(a*a),this._gridInner=new Float64Array(a*a),this._f=new Float64Array(a),this._d=new Float64Array(a),this._z=new Float64Array(a+1),this._v=new Int16Array(a)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg=(0,Ft.pK)(this._svg)}draw(i,n,a){const{_canvasSize:o,_textureSize:l,_rasterizationScale:h}=this,c=l/4;this._initSVG();const f=this.createSVGString(i,n);return new Promise((u,m)=>{const g=new Image;g.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(f),g.onload=()=>{g.onload=null,this._context.clearRect(0,0,o,o),this._context.drawImage(g,0,0,o,o);const v=this._context.getImageData(0,0,o,o),S=new Uint8Array(l*l*4);for(let O=0;O<o*o;O++){const R=v.data[4*O+3]/255;this._gridOuter[O]=1===R?0:0===R?ci:Math.max(0,.5-R)**2,this._gridInner[O]=1===R?ci:0===R?0:Math.max(0,R-.5)**2}this._edt(this._gridOuter,o,o),this._edt(this._gridInner,o,o);for(let O=0;O<l*l;O++){let R=0;for(let E=0;E<h;E++){const T=Math.floor(O/l)*h+E;for(let J=0;J<h;J++){const H=T*o+(O%l*h+J);R+=this._gridOuter[H]-this._gridInner[H]}}R/=h*h,R/=h,(0,or.U)(.5-R/(2*c),S,4*O)}u(S)};const b=a?.signal;b&&(0,Je.u7)(b,()=>m((0,Je.NK)()))})}_initSVG(){return this._svg||(this._svg=(0,Ft.p)()),this._svg}createSVGString(i,n){const a=this._initSVG(),o=(0,Ft.FJ)("path");o.setAttribute("d",i),a.appendChild(o);const l=o.getBBox(),h=l.width/l.height,c=this._canvasSize/2;let f,u,m;h>1?(f=c/l.width,u=this._canvasSize/4,m=c-c*(1/h)/2):(f=c/l.height,u=c-c*h/2,m=this._canvasSize/4),o.setAttribute("style",`transform: matrix(${f}, 0, 0, ${f}, ${-l.x*f+u}, ${-l.y*f+m})`),o.setAttribute("stroke-width",""+.5/f);const v=`<svg style="fill:${n?"red":"none"}; stroke:${n?"none":"red"}" height="${this._canvasSize}" width="${this._canvasSize}" xmlns="http://www.w3.org/2000/svg">${a.innerHTML}</svg>`;return a.removeChild(o),v}_edt(i,n,a){const o=this._f,l=this._d,h=this._v,c=this._z;for(let f=0;f<n;f++){for(let u=0;u<a;u++)o[u]=i[u*n+f];this._edt1d(o,l,h,c,a);for(let u=0;u<a;u++)i[u*n+f]=l[u]}for(let f=0;f<a;f++){for(let u=0;u<n;u++)o[u]=i[f*n+u];this._edt1d(o,l,h,c,n);for(let u=0;u<n;u++)i[f*n+u]=Math.sqrt(l[u])}}_edt1d(i,n,a,o,l){a[0]=0,o[0]=-1e20,o[1]=1e20;for(let h=1,c=0;h<l;h++){let f=(i[h]+h*h-(i[a[c]]+a[c]*a[c]))/(2*h-2*a[c]);for(;f<=o[c];)c--,f=(i[h]+h*h-(i[a[c]]+a[c]*a[c]))/(2*h-2*a[c]);c++,a[c]=h,o[c]=f,o[c+1]=1e20}for(let h=0,c=0;h<l;h++){for(;o[c+1]<h;)c++;n[h]=(h-a[c])*(h-a[c])+i[a[c]]}}}var di=y(31250);function nt(d){return d&&"static"===d.type}class Bt{constructor(i,n,a=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,this._pageWidth=i,this._pageHeight=n,a>0&&(this._maxItemSize=a),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new bt(this._pageWidth,this._pageHeight);const o=Math.floor(this._pageWidth),l=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(o*l)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(i){return i>=this._mosaicPages.length?-1:this._mosaicPages[i].size[0]}getHeight(i){return i>=this._mosaicPages.length?-1:this._mosaicPages[i].size[1]}getPageTexture(i){return i<this._mosaicPages.length?this._mosaicPages[i].texture:null}has(i){return this._mosaicRects.has(i)}get itemCount(){return this._mosaicRects.size}getSpriteItem(i){return this._mosaicRects.get(i)}addSpriteItem(i,n,a,o,l,h,c=1,f="Linear",u=.5,m=1){if(this._mosaicRects.has(i))return this._mosaicRects.get(i);let g,b,v;if(nt(a)?[g,b,v]=this._allocateImage(n[0],n[1]):(g=new He.A(0,0,n[0],n[1]),b=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:a,size:[n[0]+2*D.hM,n[1]+2*D.hM],dirty:!0,texture:void 0})),g.width<=0||g.height<=0)return null;const S={type:"sprite",rect:g,width:n[0],height:n[1],sdf:l,simplePattern:h,rasterizationScale:c,samplingMode:f,sdfPaddingRatio:u,sdfDecodeCoeff:m,page:b};return this._mosaicRects.set(i,S),nt(a)&&((0,pe.A)("esri-mosaic-debug")&&this._showDebugSprite(n,a.data),this._copy({rect:g,spriteSize:n,spriteData:a.data,page:b,pageSize:v,repeat:o,sdf:l})),S}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const i=this._spriteCopyQueue.pop();i&&this._copy(i)}getMosaicItemPosition(i){const n=this.getSpriteItem(i),a=n?.rect;if(!a)return null;a.width=n.width,a.height=n.height;const h=D.hM,c=this._mosaicPages[n.page].size;return{size:[n.width,n.height],tl:[(a.x+h)/c[0],(a.y+h)/c[1]],br:[(a.x+h+n.width)/c[0],(a.y+h+n.height)/c[1]],page:n.page}}bind(i,n,a=0,o=0){const l=this._mosaicPages[a],h=l.mosaicsData;let c=l.texture;c||(c=ui(i,l.size),l.texture=c),c.setSamplingMode(n),nt(h)?(i.bindTexture(c,o),l.dirty&&(c.setData(new Uint8Array(h.data.buffer)),c.generateMipmap(),(0,pe.A)("esri-mosaic-debug")&&this._showDebugPage(a))):(h.data.loadFrame(c),i.bindTexture(c,o),c.generateMipmap()),l.dirty=!1}getTexture(i,n=0){const a=this._mosaicPages[n],o=a.mosaicsData;let l=a.texture;return l||(l=ui(i,a.size),a.texture=l),nt(o)?a.dirty&&(l.setData(new Uint8Array(o.data.buffer)),l.generateMipmap(),(0,pe.A)("esri-mosaic-debug")&&this._showDebugPage(n)):(o.data.loadFrame(l),l.generateMipmap()),a.dirty=!1,l}dispose(){this._binPack=null;for(const i of this._mosaicPages){const n=i.texture;n&&n.dispose();const a=i.mosaicsData;nt(a)||a.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(i,n,a,o,l,h,c,f,u,m,g){let b=o*n+a,v=f*h+c;if(g){v-=h;for(let S=-1;S<=m;S++,b=((S+m)%m+o)*n+a,v+=h)for(let O=-1;O<=u;O++)l[v+O]=i[b+(O+u)%u]}else for(let S=0;S<m;S++){for(let O=0;O<u;O++)l[v+O]=i[b+O];b+=n,v+=h}}_copy(i){if(i.page>=this._mosaicPages.length)return;const n=this._mosaicPages[i.page],a=n.mosaicsData;if(!nt(n.mosaicsData))throw new ye.A("mapview-invalid-resource","unsuitable data type!");Bt._copyBits(i.spriteData,i.spriteSize[0],0,0,a.data,i.pageSize[0],i.rect.x+D.hM,i.rect.y+D.hM,i.spriteSize[0],i.spriteSize[1],i.repeat),n.dirty=!0}_allocateImage(i,n){i+=2*D.hM,n+=2*D.hM;const a=Math.max(i,n);if(this._maxItemSize&&this._maxItemSize<a){const l=2**Math.ceil((0,di.p6)(i)),h=2**Math.ceil((0,di.p6)(n)),c=new He.A(0,0,i,n);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(l*h)},size:[l,h],dirty:!0,texture:void 0}),[c,this._mosaicPages.length-1,[l,h]]}const o=this._binPack.allocate(i,n);if(o.width<=0){const l=this._mosaicPages[this._currentPage];return!l.dirty&&nt(l.mosaicsData)&&(l.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new bt(this._pageWidth,this._pageHeight),this._allocateImage(i,n)}return[o,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([i,n],a){const o=document.createElement("canvas");o.width=i,o.height=n,o.setAttribute("style",`position: absolute; top: ${4+204*hr++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const l=o.getContext("2d"),h=new ImageData(i,n);h.data.set(new Uint8Array(a.buffer)),l.putImageData(h,0,0),document.body.appendChild(o)}_showDebugPage(i){const n=this._mosaicPages[i],{size:[a,o],mosaicsData:l}=n;if(!nt(l))return;const h=`mosaicDebugPage${i}`,c=document.getElementById(h)??document.createElement("canvas");c.id=h,c.width=a,c.height=o,c.setAttribute("style",`position: absolute; top: ${4+204*i}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const f=c.getContext("2d"),u=new ImageData(a,o);u.data.set(new Uint8Array(l.data.buffer)),f.putImageData(u,0,0),document.body.appendChild(c)}}let hr=0;function ui(d,i){const n=new Ee.R;return n.width=i[0],n.height=i[1],n.wrapMode=x.pF.CLAMP_TO_EDGE,new Qe.g(d,n,null)}var cr=y(39473),Dt=y(24370),dr=y(70418);class ur{constructor(i,n,a,o){this._animation=i,this._frameData=null,this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=(0,dr.ZH)(this._animation,a,o,h=>{this._frameData=h,n.requestRender()})}destroy(){this._playHandle.remove()}loadFrame(i){const n=this._frameData;null!=n&&(i.updateData(0,D.hM,D.hM,"width"in n?n.width:n.codedWidth,"height"in n?n.height:n.codedHeight,n),this._frameData=null)}}var pr=y(13561);class fr{constructor(){this._entries=new mr,this._nodes=new Map,this._book=new _r}add(i){let n=this._entries.get(i);if(!n){const a=this._book.add(i),o=new Object;n={location:a,references:0,handle:o};const l=this._entries.set(i,n);this._nodes.set(o,l)}return n.references++,n}remove(i){const n=this._nodes.get(i.handle);n&&n.payload&&(n.payload.references--,0===n.payload.references&&(this._book.remove(n.payload.location),this._entries.delete(n),this._nodes.delete(i.handle)))}getTexture(i,n){return this._book.getTexture(i,n)}destroy(){this._book.destroy()}}class Lt{constructor(i,n){this.parent=i,this.key=n,this.payload=null,this._children=new Map}get(i){return this._children.get(i)}ensure(i){let n=this._children.get(i);return n||(n=new Lt(this,i),this._children.set(i,n)),n}delete(i){this._children.delete(i)}}class mr{constructor(){this._root=new Lt(null,NaN)}set(i,n){let a=this._root;for(const o of i)for(const l of o)a=a.ensure(l);return a.payload=n,a}delete(i){i.parent?.delete(i.key)}get(i){let n=this._root;for(const a of i)for(const o of a){const l=n.get(o);if(!l)return;n=l}return n.payload||void 0}}class _r{constructor(){this._pages=[]}add(i){0===this._pages.length&&this._pages.push(new pi);let n=this._pages.length-1,a=this._pages[n].add(i);if(a||(this._pages.push(new pi),n=this._pages.length-1,a=this._pages[n].add(i)),!a)throw new Error("Data allocation failed.");return{...a,page:n}}remove(i){this._pages[i.page].remove(i)}getTexture(i,n){return this._pages[n].getTexture(i)}destroy(){}}class pi{constructor(){this._cursor={row:0,column:0},this._columns=1024,this._rows=1024,this._data=new Float32Array(this._columns*this._rows*4),this._texture=null,this._textureCursor={row:0,column:0}}add(i){if(i.length>this._columns)throw new Error(`The maximum allocation size is ${this._columns} texels.`);const n={...this._cursor};if(n.column+=i.length,n.column>=this._columns&&(n.column=i.length,n.row++),n.row>=this._rows)return null;this._cursor=n;const a={...this._cursor};a.column-=i.length;let o=4*(a.row*this._columns+a.column);for(let l=0;l<i.length;l++)this._data[o++]=i[l][0],this._data[o++]=i[l][1],this._data[o++]=i[l][2],this._data[o++]=i[l][3];return a}remove(i){}getTexture(i){if(!this._texture){const o=new Ee.R(this._columns,this._rows);o.pixelFormat=x.Ab.RGBA,o.dataType=x.ld.FLOAT,o.wrapMode=x.pF.CLAMP_TO_EDGE,o.samplingMode=x.Cj.NEAREST,o.hasMipmap=!1;const l=new pr.z(i,o);this._texture=new Qe.g(i,l)}if(this._cursor.row===this._textureCursor.row&&this._cursor.column===this._textureCursor.column)return this._texture;const n=this._textureCursor.row;return this._texture.updateData(0,0,n,this._columns,this._cursor.row-n+1,this._data,n),this._textureCursor.row=this._cursor.row,this._textureCursor.column=this._cursor.column,this._texture}destroy(){this._texture?.dispose()}}const fi="arial-unicode-ms-regular",mi=()=>be.A.getLogger("esri.views.MapView"),ut=(d,i,n)=>mi().error(new ye.A(d,i,n));class kt{static fromMosaic(i,n){return new kt(i,n.page,n.sdf,n.samplingMode)}constructor(i,n,a,o){this.mosaicType=i,this.page=n,this.sdf=a,this.samplingMode=o}}class yr{constructor(i){var n;this._requestRender=i,this._resourceManager=new Xi.A,this._invalidFontsMap=new Map,this._sdfConverter=new lr(D.yA),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Yi.QueueProcessor({concurrency:10,process:(n=(0,W.A)(function*(a,o){(0,Je.Te)(o);try{return yield(0,mt.A)(a,{responseType:"image",signal:o})}catch(l){throw(0,Je.zf)(l)?l:new ye.A("mapview-invalid-resource",`Could not fetch requested resource at ${a}`,l)}}),function(o,l){return n.apply(this,arguments)})}),this.animationStore=new fr,this._spriteMosaic=new Bt(2048,2048,500),this._glyphSource=new ar(`${$i.A.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new sr(1024,1024,this._glyphSource),this._rasterizer=new Qi(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy(),this.animationStore.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}rasterizeItem(i,n){var a=this;return(0,W.A)(function*(){if(null==i)return ut("mapview-null-resource","Unable to rasterize null resource"),null;if("animation-info"===i.type){const{resource:h}=i,c=a.animationStore.add(h),{location:f}=c;return{rect:new He.A(f.column,f.row,h.length,1),page:f.page,type:"sprite",width:h.length,height:1,rasterizationScale:1,sdfPaddingRatio:.5,samplingMode:"Linear",sdfDecodeCoeff:1,simplePattern:!1}}if("cim-rasterization-info"!==i.type)return ut("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:o}=i;if("text"===o.type){const h=yield a._rasterizeText(o,n);for(const c of h.glyphs)a._setTextureBinding(Ie.Be.GLYPH,c);return h}const l=yield a._rasterizeSprite(o,n);return l&&a._setTextureBinding(Ie.Be.SPRITE,l),l})()}getMosaicInfo(i,n,a=!1){const o=this._getTextureBindingInfo(i,n,a);return o?{size:o.size,texture:{texture:o.texture,unit:"sprite"===o.type?D.Pq:D.ue}}:(ut("mapview-invalid-resource",`Unable to find resource for ${n}`),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(i,n,a){const o=this._bindingInfos[n-1],l=o.page,h="Nearest"===o.samplingMode?x.Cj.NEAREST:a?x.Cj.LINEAR_MIPMAP_LINEAR:x.Cj.LINEAR;switch(o.mosaicType){case Ie.Be.SPRITE:{const c=[this.sprites.getWidth(l),this.sprites.getHeight(l)],f=this._spriteMosaic.getTexture(i,l);return f.setSamplingMode(h),{type:"sprite",texture:f,size:c}}case Ie.Be.GLYPH:{const c=[this.glyphs.width,this.glyphs.height],f=this._glyphMosaic.getTexture(i,l);return this._glyphMosaic.bind(i,h,l,D.ue),f.setSamplingMode(h),{type:"glyph",texture:f,size:c}}default:return ut("mapview-texture-manager",`Cannot handle unknown type ${o.mosaicType}`),null}}_hashMosaic(i,n){return 1|i<<1|(n.sdf?1:0)<<2|("Nearest"===n.samplingMode?1:0)<<3|n.page<<4}_setTextureBinding(i,n){const a=this._hashMosaic(i,n);if(!this._hashToBindingIndex.has(a)){const o=kt.fromMosaic(i,n);this._hashToBindingIndex.set(a,this._bindingInfos.length+1),this._bindingInfos.push(o)}n.textureBinding=this._hashToBindingIndex.get(a)}_rasterizeText(i,n){var a=this;return(0,W.A)(function*(){const{font:o,textString:l}=i,h=(0,Y.rK)(o),c=a._invalidFontsMap.has(h),[f,u]=(0,Ki.y)(l),m=(0,Dt.bX)(f);try{const g=c?fi:h;return(0,pe.A)("esri-2d-stabilize-glyphs")&&(yield a._glyphMosaic.preloadASCIIGlyphCache(g)),{type:"glyphs",glyphs:yield a._glyphMosaic.getGlyphItems(g,m,n),isRightToLeft:u}}catch{return((d,i="")=>{mi().warnOnce(d,i)})(`Font ${h} is not available on the web, using "Arial Unicode MS Regular"`),a._invalidFontsMap.set(h,!0),{type:"glyphs",glyphs:yield a._glyphMosaic.getGlyphItems(fi,m,n),isRightToLeft:u}}})()}_hashSpriteResource(i){switch(i.type){case"path":return`path:${i.path}.${i.asFill?1:0}`;case"CIMPictureMarker":return`${i.type}:${i.url}:${i.size}:${(0,Dt.$Y)(i.markerPlacement)}`;case"CIMPictureFill":return`${i.type}:${i.url}:${i.height}`;case"CIMPictureStroke":return`${i.type}:${i.url}:${i.width}`;case"dash":return`dash:${i.capStyle}.${(0,_.K3)(i.dashTemplate).join("")}`;case"sdf":return`sdf:${JSON.stringify(i.geom)}.${i.asFill?1:0}`;case"fill-style":return`fill_style:${i.style}`;case"animated":return JSON.stringify((0,cr.I)(i));case"CIMGradientFill":case"CIMGradientStroke":return`gradient:${JSON.stringify(i.colorRamp)}.${i.gradientType}.${i.interval}`;case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(i)}}_rasterizeSprite(i,n){var a=this;return(0,W.A)(function*(){if(!i)return null;const o=(0,ae.Wm)(a._hashSpriteResource(i));if(a._spriteMosaic.has(o))return a._spriteMosaic.getSpriteItem(o);if("url"in i&&i.url||"CIMPictureFill"===i.type||"CIMPictureStroke"===i.type||"CIMPictureMarker"===i.type||"CIMVectorMarker"===i.type){const l=[];_e.wp.fetchResources({type:"CIMPointSymbol",symbolLayers:[i]},a._resourceManager,l),l.length>0&&(yield Promise.all(l))}switch(i.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===i.markerPlacement?.type?a._rasterizeJSONResource(o,i):a._handleAsyncResource(o,i,n);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return a._handleAsyncResource(o,i,n);case"CIMGradientFill":case"CIMGradientStroke":case"CIMHatchFill":case"CIMVectorMarker":case"dash":case"fill-style":case"sdf":return a._rasterizeJSONResource(o,i)}})()}_rasterizeJSONResource(i,n){const a=this._rasterizer.rasterizeJSONResource(n);if(a){const{size:o,image:l,sdf:h,simplePattern:c,rasterizationScale:f,samplingMode:u,sdfPaddingRatio:m,sdfDecodeCoeff:g}=a;return this._addItemToMosaic(i,o,{type:"static",data:l},xt(n),h,c,f,u,m,g)}return null}_handleAsyncResource(i,n,a){var o=this;return(0,W.A)(function*(){if(o._ongoingRasterizations.has(i))return o._ongoingRasterizations.get(i);let l;return l="path"===n.type?o._handleSVG(n,i,a):o._handleImage(n,i,a),o._ongoingRasterizations.set(i,l),l.finally(()=>o._ongoingRasterizations.delete(i)),l})()}_handleSVG(i,n,a){var o=this;return(0,W.A)(function*(){const l=[D.yA,D.yA],{asFill:h}=i,c=yield o._sdfConverter.draw(i.path,h,a);return o._addItemToMosaic(n,l,{type:"static",data:new Uint32Array(c.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(i,n,a){var o=this;return(0,W.A)(function*(){const h=o.resourceManager.getResource(i.url);if(null==h)return null;const{width:c,height:f}=h;if(h instanceof HTMLImageElement){if("animated"===i.type)return ut("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const v="colorSubstitutions"in i?i.colorSubstitutions:void 0,{size:S,sdf:O,image:R}=o._rasterizer.rasterizeImageResource(c,f,h,v);return o._addItemToMosaic(n,S,{type:"static",data:R},xt(i),O,!1)}let u,m,g;"animated"===i.type?(u=!1,m={type:"CIMAnimatedSymbolProperties",playAnimation:i.playAnimation,reverseAnimation:i.reverseAnimation,randomizeStartTime:i.randomizeStartTime,randomizeStartSeed:i.randomizeStartSeed,startTimeOffset:i.startTimeOffset,duration:i.duration,repeatType:i.repeatType,repeatDelay:i.repeatDelay},g=i.startGroup||0):(u=xt(i),m={type:"CIMAnimatedSymbolProperties"},g=0);const b=new ur(h,o._requestRender,m,g);return o._addItemToMosaic(n,[b.width,b.height],{type:"animated",data:b},u,!1,!1)})()}_handleImage(i,n,a){var o=this;return(0,W.A)(function*(){const l=i.url;if(Mr(l)||xr(l))return o._handleGIFOrPNG(i,n,a);if("animated"===i.type)return ut("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let h;const c=o.resourceManager.getResource(l);if(null!=c&&c instanceof HTMLImageElement)h=c;else{const{data:S}=yield o._imageRequestQueue.push(l,{...a});h=S}if((0,Dt.UE)(l))if("width"in i&&"height"in i)h.width=(0,Me.Lz)(i.width),h.height=(0,Me.Lz)(i.height);else if("cim"in i){const S=i;h.width=(0,Me.Lz)(S.width??S.scaleX*S.size),h.height=(0,Me.Lz)(S.size)}if(!h.width||!h.height)return null;const f=h.width,u=h.height,m="colorSubstitutions"in i?i.colorSubstitutions:void 0,{size:g,sdf:b,image:v}=o._rasterizer.rasterizeImageResource(f,u,h,m);return o._addItemToMosaic(n,g,{type:"static",data:v},xt(i),b,!1)}catch(h){throw(0,Je.zf)(h)?h:new ye.A("mapview-invalid-resource",`Could not fetch requested resource at ${l}. ${h.message}`)}})()}_addItemToMosaic(i,n,a,o,l,h,c,f,u,m){return this._spriteMosaic.addSpriteItem(i,n,a,o,l,h,c,f,u,m)}}function xt(d){switch(d.type){case"CIMVectorMarker":case"CIMPictureMarker":return wr(d);default:return!0}}const Mr=d=>d&&(d.includes(".gif")||(d=>null!=d&&d.startsWith("data:image/gif"))(d)),xr=d=>d&&(d.includes(".png")||(d=>null!=d&&d.startsWith("data:image/png"))(d)),wr=d=>d&&"markerPlacement"in d&&d.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===d.markerPlacement.type;class Or{constructor(i){this._queue=[],this._refreshable=i}destroy(){this._queue=[]}enqueueTextureUpdate(i,n){const a=(0,Je.Tw)(),o=i,l=D.Qb,h=Math.ceil(o.height/l);(0,Je.Te)(n);for(let c=0;c<h;c++){const u=c===h-1;this._queue.push({type:"chunk",request:i,resolver:a,chunk:c,chunkOffset:c*l,destHeight:u?o.height-l*c:l,chunkIsLast:u,options:n})}return(0,Je.NY)(n,c=>a.reject(c)),a.promise}upload(){const i=performance.now();let n=0;for(;this._queue.length;){const a=this._queue.shift();if(a){if(null!=a.options.signal&&a.options.signal.aborted)continue;switch(a.type){case"chunk":this._uploadChunk(a);break;case"no-chunk":this._uploadNoChunk(a)}++n;const o=performance.now()-i;if(o+o/n>=D.r1)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(i){const{request:n,resolver:a,chunkOffset:o,chunkIsLast:l,destHeight:h}=i,{data:c,texture:f,width:u}=n;null!=c&&(f.updateData(0,0,o,u,h,c,o),l&&a.resolve())}_uploadNoChunk(i){const{request:n,resolver:a}=i,{data:o,texture:l}=n;l.setData(o),a.resolve()}}var Pr=y(85952),et=y(31610),_i=y(45475),Ut=y(28714),Nt=y(25866),_t=y(91837),Sr=y(64559);const Cr=(0,_i.fA)(-.5,-.5);class Tr{constructor(){this._centerNdc=(0,Nt.vt)(),this._pxToNdc=(0,Nt.vt)(),this._worldDimensionsPx=(0,Nt.vt)(),this._mat3=(0,Oe.vt)(),this._initialized=!1}dispose(){this._program=(0,j.WD)(this._program),this._quad=(0,j.WD)(this._quad)}render(i,n,a){const{context:o}=i,l=this._updateGeometry(i,a);if(null!=n){const{r:h,g:c,b:f,a:u}=n;o.setClearColor(u*h/255,u*c/255,u*f/255,u)}else o.setClearColor(0,0,0,0);if(o.setStencilFunction(x.MT.ALWAYS,0,255),o.setStencilWriteMask(255),!l)return o.setClearStencil(D.Qs),void o.clear(o.gl.STENCIL_BUFFER_BIT|o.gl.COLOR_BUFFER_BIT);o.setClearStencil(D.tP),o.clear(o.gl.STENCIL_BUFFER_BIT|o.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(o),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),o.setColorMask(!1,!1,!1,!1),o.setBlendingEnabled(!1),o.setStencilOp(x.eA.KEEP,x.eA.KEEP,x.eA.REPLACE),o.setStencilFunction(x.MT.ALWAYS,D.Qs,255),o.setStencilTestEnabled(!0),o.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.bind(),this._quad.draw(),this._quad.unbind()}_initialize(i){if(this._initialized)return;const n=(0,Mt.r)(i,Sr.P);n&&(this._program=n,this._quad=new _t.A(i,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(i,n){const{state:a,pixelRatio:o}=i,{size:l,rotation:h}=a,c=Math.round(l[0]*o),f=Math.round(l[1]*o);if(!a.spatialReference.isWrappable)return!1;const u=(0,Pr.DF)(h),m=Math.abs(Math.cos(u)),g=Math.abs(Math.sin(u)),b=Math.round(c*m+f*g),v=Math.round(o*a.worldScreenWidth);if(b<=v)return!1;const O=(n.left-n.right)*o/c,R=(n.bottom-n.top)*o/f;(0,Ut.i)(this._worldDimensionsPx,v,c*g+f*m,1),(0,Ut.i)(this._pxToNdc,2/c,-2/f,1),(0,Ut.i)(this._centerNdc,O,R,1);const E=this._mat3;return(0,et.kN)(E,this._centerNdc),(0,et.hs)(E,E,this._pxToNdc),0!==h&&(0,et.e$)(E,E,u),(0,et.hs)(E,E,this._worldDimensionsPx),(0,et.Tl)(E,E,Cr),!0}}var Vt=y(95678),Gt=y(14089),Wt=y(8137),Rr=y(62416),Er=y(88690);class Ar extends Gt.j{constructor(){super(...arguments),this.type=Wt.N.Blend,this._backBufferTexture=null,this.shaders={blend:new Rr.L,opacity:new Er.x}}shutdown(){super.shutdown(),null!==this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null)}render(i,n){const{context:a,state:o,pixelRatio:l,inFadeTransition:h,painter:c}=i,{size:f}=o,u=a.getBoundFramebufferObject();let m,g;null!=u?(m=u.width,g=u.height):(m=Math.round(l*f[0]),g=Math.round(l*f[1]));const{blendMode:b}=n;if("normal"===b){const E={shader:this.shaders.opacity,uniforms:{config:{layerTexture:{texture:n.colorTexture,unit:0},opacity:n.config.opacity}},defines:null,optionalAttributes:null,useComputeBuffer:!1};return c.setPipelineState(Vt.i),void c.submitDrawMesh(a,E,c.quadMesh)}const v=this._createOrResizeTexture(i,m,g);u.copyToTexture(0,0,m,g,0,0,v),c.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:x.dn.ONE,dstRGB:x.dn.ZERO,srcAlpha:x.dn.ONE,dstAlpha:x.dn.ZERO}},depth:!1,stencil:!1});const O={backbufferTexture:{texture:v,unit:0},layerTexture:{texture:n.colorTexture,unit:1},inFadeOpacity:h?1:0,...n.config};c.submitDrawMesh(a,{shader:this.shaders.blend,uniforms:{config:O},defines:{blendMode:b},optionalAttributes:null,useComputeBuffer:!1},c.quadMesh)}_createOrResizeTexture(i,n,a){const{context:o}=i;if(null!==this._backBufferTexture&&this._backBufferTexture.descriptor?.width===n&&this._backBufferTexture.descriptor?.height===a)return this._backBufferTexture;if(null===this._backBufferTexture){const l=new Ee.R;l.internalFormat=x.Ab.RGBA,l.wrapMode=x.pF.CLAMP_TO_EDGE,l.width=n,l.height=a,this._backBufferTexture=new Qe.g(o,l)}else this._backBufferTexture.resize(n,a);return this._backBufferTexture}}class Ir{constructor(){this._blendTechnique=new Ar}dispose(i){this._blendTechnique?.shutdown()}draw(i,n,a,o,l){this._blendTechnique.render(i,{colorTexture:n,config:{opacity:l,samplingMode:a},blendMode:o})}}class Ht{constructor(){this.name=this.constructor.name}createOptions(i,n){return null}}class gi extends Ht{constructor(i){super(),this.name=this.constructor.name,this.defines=[i]}dispose(){}bind({context:i,painter:n}){this._prev=i.getBoundFramebufferObject();const a=n.getFbos().effect0;i.bindFramebuffer(a),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT)}unbind(){}draw(i,n){const{context:a,painter:o}=i,l=o.getPostProcessingEffects(n),h=a.getBoundFramebufferObject();for(const{postProcessingEffect:c,effect:f}of l)c.draw(i,h,f);a.bindFramebuffer(this._prev),a.setStencilTestEnabled(!1),o.blitTexture(a,h.colorTexture,x.Cj.NEAREST),a.setStencilTestEnabled(!0)}}var wt=y(22049),yi=y(63367),vi=y(30454);class zr{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(i,n){i.bindTexture(n,D.vd),i.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",wt.HQ),i.bindVAO(this._resources.quadVAO),i.drawArrays(x.WR.TRIANGLE_STRIP,0,4),i.bindVAO()}finalBlur(i,n){i.bindTexture(n,D.vd),i.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",wt.XK),i.bindVAO(this._resources.quadVAO),i.drawArrays(x.WR.TRIANGLE_STRIP,0,4),i.bindVAO()}renderHighlight(i,n,a){i.bindTexture(n,D.vd),i.useProgram(this._resources.highlightProgram),a.applyHighlightOptions(i,this._resources.highlightProgram),i.bindVAO(this._resources.quadVAO),i.setBlendingEnabled(!0),i.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),i.drawArrays(x.WR.TRIANGLE_STRIP,0,4),i.bindVAO()}_initialize(i,n,a){this._width=n,this._height=a;const o=si.g.createVertex(i,x._U.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),l=new ni.Z(i,new Map([["a_position",0],["a_texcoord",1]]),new Map([["geometry",[new vi._("a_position",2,x.pe.BYTE,0,4),new vi._("a_texcoord",2,x.pe.UNSIGNED_BYTE,2,4)]]]),new Map([["geometry",o]])),h=(0,Mt.r)(i,yi.Z),c=(0,Mt.r)(i,yi.G);i.useProgram(h),h.setUniform1i("u_texture",D.vd),h.setUniform1i("u_shade",D.CR),h.setUniform1f("u_sigma",wt.aY),i.useProgram(c),c.setUniform1i("u_texture",D.vd),c.setUniform1f("u_sigma",wt.aY),this._resources={quadGeometry:o,quadVAO:l,highlightProgram:h,blurProgram:c}}setup(i,n,a){this._resources?(this._width=n,this._height=a):this._initialize(i,n,a)}}var $e=y(79061),jt=y(49950);function Mi(d,i,n){const a=new Ee.R(i,n);return a.wrapMode=x.pF.CLAMP_TO_EDGE,new $e.H(d,a,new jt.q(x.yQ.STENCIL_INDEX8,i,n))}class Fr{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(i,n,a){this._width=n,this._height=a;const o=Mi(i,n,a),l=Mi(i,n,a);this._resources={sharedBlur1Fbo:o,sharedBlur2Fbo:l}}setup(i,n,a){!this._resources||this._width===n&&this._height===a||this.dispose(),this._resources||this._initialize(i,n,a)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class Br extends Ht{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new zr,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new Fr,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new ai}dispose(){this._hlSurfaces?.dispose(),this._hlRenderer?.dispose(),this._boundFBO=null}bind(i){const{context:n,painter:a}=i,{width:o,height:l}=n.getViewport(),h=a.getFbos().effect0;this.setup(i,o,l),n.bindFramebuffer(h),n.setColorMask(!0,!0,!0,!0),n.setClearColor(0,0,0,0),n.clear(n.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:i},n,a){this._width=n,this._height=a;const o=n%4,l=a%4;a+=l<2?-l:4-l,this._adjustedWidth=n+=o<2?-o:4-o,this._adjustedHeight=a,this._boundFBO=i.getBoundFramebufferObject();const h=Math.round(1*n),c=Math.round(1*a);this._hlRenderer.setup(i,h,c),this._hlSurfaces.setup(i,h,c)}draw(i){const{context:n,passOptions:a}=i,o=a.activeGradient,l=n.getBoundFramebufferObject();n.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),n.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),n.setStencilTestEnabled(!1),n.setClearColor(0,0,0,0),n.clear(n.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(n,l.colorTexture,x.Cj.NEAREST,1),n.setStencilTestEnabled(!1),n.setBlendingEnabled(!1),n.setColorMask(!1,!1,!1,!0),n.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),n.setClearColor(0,0,0,0),n.clear(n.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(n,this._hlSurfaces.sharedBlur1Tex),n.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),n.setClearColor(0,0,0,0),n.clear(n.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(n,this._hlSurfaces.sharedBlur2Tex),n.bindFramebuffer(this._boundFBO),n.setBlendingEnabled(!0),n.setColorMask(!0,!0,!0,!0),n.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(n,this._hlSurfaces.sharedBlur1Tex,o),this._boundFBO=null}}class Dr extends Ht{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:i},n){if(!n.length)return null;const a=n.shift(),o=a.x,l=a.y;this._outstanding=a;const h=(0,pe.A)("esri-mobile");return{type:"hittest",distance:(h?D.fy:D.V3)*i,smallSymbolDistance:(h?D.fy:D._M)*i,smallSymbolSizeThreshold:D.ie,position:[o,l]}}bind(i){const{context:n,attributeView:a}=i;if(!a.size)return;const o=a.getBlock(D.dV.GPGPU);if(null==o)return;const l=o.getFBO(n);n.setViewport(0,0,a.size,a.size),n.bindFramebuffer(l),n.setColorMask(!0,!0,!0,!0),n.setClearColor(0,0,0,0),n.clear(n.gl.COLOR_BUFFER_BIT|n.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(i){if(null==this._outstanding)return;const n=this._outstanding;this._outstanding=null,this._resolve(i,n.resolvers)}_resolve(i,n){return(0,W.A)(function*(){const{context:a,attributeView:o}=i,l=o.getBlock(D.dV.GPGPU);if(null==l)return void n.forEach(u=>u.resolve([]));const h=l.getFBO(a),c=new Uint8Array(h.width*h.height*4);try{yield h.readPixelsAsync(0,0,h.width,h.height,x.Ab.RGBA,x.ld.UNSIGNED_BYTE,c)}catch{return void n.forEach(m=>m.resolve([]))}const f=[];for(let u=0;u<c.length;u+=4)c[u]&&f.push(u/4);n.forEach(u=>u.resolve(f))})()}}const Lr=[1,0],kr=[0,1],Ur=[1,.8,.6,.4,.2],Nr=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class Vr{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=(0,j.WD)(this._quad),this._intensityFBO=(0,j.WD)(this._intensityFBO),this._compositeFBO=(0,j.WD)(this._compositeFBO),this._mipsFBOs){for(let i=0;i<this._nMips;i++)this._mipsFBOs[i]&&(this._mipsFBOs[i].horizontal.dispose(),this._mipsFBOs[i].vertical.dispose());this._mipsFBOs=null}}draw(i,n,a){const{width:o,height:l}=n,{context:h,painter:c}=i,{materialManager:f}=c,u=h.gl,m=this._programDesc,{strength:g,radius:b,threshold:v}=a;this._quad||(this._quad=new _t.A(h,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(i,o,l),h.setStencilTestEnabled(!1),h.setBlendingEnabled(!0),h.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),h.setStencilWriteMask(0);const S=this._quad;S.bind(),h.bindFramebuffer(this._intensityFBO);const O=f.getProgram(m.luminosityHighPass);h.useProgram(O),h.bindTexture(n.colorTexture,0),O.setUniform1i("u_texture",0),O.setUniform3fv("u_defaultColor",[0,0,0]),O.setUniform1f("u_defaultOpacity",0),O.setUniform1f("u_luminosityThreshold",v),O.setUniform1f("u_smoothWidth",.01);const R=[Math.round(o/2),Math.round(l/2)];h.setViewport(0,0,R[0],R[1]),h.setClearColor(0,0,0,0),h.clear(u.COLOR_BUFFER_BIT),S.draw(),h.setBlendingEnabled(!1);let E=this._intensityFBO.colorTexture;for(let H=0;H<this._nMips;H++){const ee=f.getProgram(m.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[H]}]);h.useProgram(ee),h.bindTexture(E,H+1),ee.setUniform1i("u_colorTexture",H+1),ee.setUniform2fv("u_texSize",R),ee.setUniform2fv("u_direction",Lr),h.setViewport(0,0,R[0],R[1]);const L=this._mipsFBOs[H];h.bindFramebuffer(L.horizontal),S.draw(),E=L.horizontal.colorTexture,h.bindFramebuffer(L.vertical),h.bindTexture(E,H+1),ee.setUniform2fv("u_direction",kr),S.draw(),E=L.vertical.colorTexture,R[0]=Math.round(R[0]/2),R[1]=Math.round(R[1]/2)}h.setViewport(0,0,o,l);const T=f.getProgram(m.composite,[{name:"nummips",value:5}]);h.bindFramebuffer(this._compositeFBO),h.useProgram(T),T.setUniform1f("u_bloomStrength",g),T.setUniform1f("u_bloomRadius",b),T.setUniform1fv("u_bloomFactors",Ur),T.setUniform3fv("u_bloomTintColors",Nr),h.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),T.setUniform1i("u_blurTexture1",1),h.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),T.setUniform1i("u_blurTexture2",2),h.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),T.setUniform1i("u_blurTexture3",3),h.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),T.setUniform1i("u_blurTexture4",4),h.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),T.setUniform1i("u_blurTexture5",5),S.draw(),h.bindFramebuffer(n),h.setBlendingEnabled(!0);const J=f.getProgram(m.blit);h.useProgram(J),h.bindTexture(this._compositeFBO.colorTexture,6),J.setUniform1i("u_texture",6),h.setBlendFunction(x.dn.ONE,x.dn.ONE),S.draw(),S.unbind(),h.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),h.setStencilTestEnabled(!0)}_createOrResizeResources(i,n,a){const{context:o}=i;if(this._compositeFBO&&this._size[0]===n&&this._size[1]===a)return;this._size[0]=n,this._size[1]=a;const l=[Math.round(n/2),Math.round(a/2)];if(this._compositeFBO)this._compositeFBO.resize(n,a);else{const h=new Ee.R(n,a);h.internalFormat=x.Ab.RGBA,h.wrapMode=x.pF.CLAMP_TO_EDGE,this._compositeFBO=new $e.H(o,h)}if(this._intensityFBO)this._intensityFBO.resize(l[0],l[1]);else{const h=new Ee.R(l[0],l[1]);h.internalFormat=x.Ab.RGBA,h.wrapMode=x.pF.CLAMP_TO_EDGE,this._intensityFBO=new $e.H(o,h)}for(let h=0;h<this._nMips;h++){if(this._mipsFBOs[h])this._mipsFBOs[h].horizontal.resize(l[0],l[1]),this._mipsFBOs[h].vertical.resize(l[0],l[1]);else{const c=new Ee.R(l[0],l[1]);c.internalFormat=x.Ab.RGBA,c.wrapMode=x.pF.CLAMP_TO_EDGE,this._mipsFBOs[h]={horizontal:new $e.H(o,c),vertical:new $e.H(o,c)}}l[0]=Math.round(l[0]/2),l[1]=Math.round(l[1]/2)}}}const Gr=[1,0],Wr=[0,1];class Hr{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(i,n,a){const{context:o}=i,{type:l,radius:h}=a;if(0===h)return;this._createOrResizeResources(i),this._quad||(this._quad=new _t.A(o,[-1,-1,1,-1,-1,1,1,1]));const c=this._quad;c.bind(),"blur"===l?this._gaussianBlur(i,n,h):this._radialBlur(i,n),c.unbind()}_gaussianBlur(i,n,a){const{context:o,state:l,painter:h,pixelRatio:c}=i,{size:f}=l,{materialManager:u}=h,m=this._programDesc,g=this._quad,b=[Math.round(c*f[0]),Math.round(c*f[1])],v=this._blurFBO,S=u.getProgram(m.gaussianBlur,[{name:"radius",value:Math.ceil(a)}]);o.useProgram(S),o.setBlendingEnabled(!1),o.bindFramebuffer(v),o.bindTexture(n.colorTexture,4),S.setUniform1i("u_colorTexture",4),S.setUniform2fv("u_texSize",b),S.setUniform2fv("u_direction",Gr),S.setUniform1f("u_sigma",a),g.draw(),o.bindFramebuffer(n),o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),o.bindTexture(v?.colorTexture,5),S.setUniform1i("u_colorTexture",5),S.setUniform2fv("u_direction",Wr),g.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0)}_radialBlur(i,n){const{context:a,painter:o}=i,{materialManager:l}=o,h=this._programDesc,c=this._quad,f=this._blurFBO;a.bindFramebuffer(f);const u=l.getProgram(h.radialBlur);a.useProgram(u),a.setBlendingEnabled(!1),a.bindTexture(n.colorTexture,4),u.setUniform1i("u_colorTexture",4),c.draw(),a.bindFramebuffer(n),a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setBlendingEnabled(!0);const m=l.getProgram(h.blit);a.useProgram(m),a.bindTexture(f?.colorTexture,5),m.setUniform1i("u_texture",5),a.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),c.draw()}_createOrResizeResources(i){const{context:n,state:a,pixelRatio:o}=i,{size:l}=a,h=Math.round(o*l[0]),c=Math.round(o*l[1]);if(!this._blurFBO||this._size[0]!==h||this._size[1]!==c)if(this._size[0]=h,this._size[1]=c,this._blurFBO)this._blurFBO.resize(h,c);else{const f=new Ee.R(h,c);f.internalFormat=x.Ab.RGBA,f.wrapMode=x.pF.CLAMP_TO_EDGE,this._blurFBO=new $e.H(n,f)}}}class jr{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=(0,j.WD)(this._layerFBOTexture)}draw(i,n,a){const{width:o,height:l}=n;this._createOrResizeResources(i,o,l);const{context:h,painter:c}=i,{materialManager:f}=c,u=this._programDesc,m=this._quad,g=a.colorMatrix;m.bind();const b=this._layerFBOTexture;h.bindFramebuffer(n),n.copyToTexture(0,0,o,l,0,0,b),h.setBlendingEnabled(!1),h.setStencilTestEnabled(!1);const v=f.getProgram(u);h.useProgram(v),h.bindTexture(b,2),v.setUniformMatrix4fv("u_coefficients",g),v.setUniform1i("u_colorTexture",2),m.draw(),h.setBlendingEnabled(!0),h.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),h.setStencilTestEnabled(!0),m.unbind()}_createOrResizeResources(i,n,a){const{context:o}=i;if(!this._layerFBOTexture||this._size[0]!==n||this._size[1]!==a){if(this._size[0]=n,this._size[1]=a,this._layerFBOTexture)this._layerFBOTexture.resize(n,a);else{const l=new Ee.R;l.internalFormat=x.Ab.RGBA,l.wrapMode=x.pF.CLAMP_TO_EDGE,l.width=n,l.height=a,this._layerFBOTexture=new Qe.g(o,l)}this._quad||(this._quad=new _t.A(o,[-1,-1,1,-1,-1,1,1,1]))}}}const $r=[1,0],Kr=[0,1];class Yr{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=(0,j.WD)(this._layerFBOTexture),this._horizontalBlurFBO=(0,j.WD)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,j.WD)(this._verticalBlurFBO)}draw(i,n,a){const{context:o,state:l,painter:h}=i,{materialManager:c}=h,f=this._programDesc,u=n.width,m=n.height,g=[Math.round(u),Math.round(m)],{blurRadius:b,offsetX:v,offsetY:S,color:O}=a,R=[(0,Me.Lz)(v),(0,Me.Lz)(S)];this._createOrResizeResources(i,u,m,g);const E=this._horizontalBlurFBO,T=this._verticalBlurFBO;o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1);const J=this._layerFBOTexture;n.copyToTexture(0,0,u,m,0,0,J),this._quad||(this._quad=new _t.A(o,[-1,-1,1,-1,-1,1,1,1])),o.setViewport(0,0,g[0],g[1]);const H=this._quad;H.bind(),o.setBlendingEnabled(!1);const ee=c.getProgram(f.blur,[{name:"radius",value:Math.ceil(b)}]);o.useProgram(ee),o.bindFramebuffer(E),o.bindTexture(n.colorTexture,4),ee.setUniform1i("u_colorTexture",4),ee.setUniform2fv("u_texSize",g),ee.setUniform2fv("u_direction",$r),ee.setUniform1f("u_sigma",b),H.draw(),o.bindFramebuffer(T),o.bindTexture(E?.colorTexture,5),ee.setUniform1i("u_colorTexture",5),ee.setUniform2fv("u_direction",Kr),H.draw(),o.bindFramebuffer(n),o.setViewport(0,0,u,m);const L=c.getProgram(f.composite);o.useProgram(L),o.bindTexture(T?.colorTexture,2),L.setUniform1i("u_blurTexture",2),o.bindTexture(J,3),L.setUniform1i("u_layerFBOTexture",3),L.setUniform4fv("u_shadowColor",[O[3]*(O[0]/255),O[3]*(O[1]/255),O[3]*(O[2]/255),O[3]]),L.setUniformMatrix3fv("u_displayViewMat3",l.displayMat3),L.setUniform2fv("u_shadowOffset",R),H.draw(),o.setBlendingEnabled(!0),o.setStencilTestEnabled(!0),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),H.unbind()}_createOrResizeResources(i,n,a,o){const{context:l}=i;if(!this._horizontalBlurFBO||this._size[0]!==n||this._size[1]!==a){if(this._size[0]=n,this._size[1]=a,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(o[0],o[1]);else{const h=new Ee.R(o[0],o[1]);h.internalFormat=x.Ab.RGBA,h.wrapMode=x.pF.CLAMP_TO_EDGE,this._horizontalBlurFBO=new $e.H(l,h)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(o[0],o[1]);else{const h=new Ee.R(o[0],o[1]);h.internalFormat=x.Ab.RGBA,h.wrapMode=x.pF.CLAMP_TO_EDGE,this._verticalBlurFBO=new $e.H(l,h)}if(this._layerFBOTexture)this._layerFBOTexture.resize(n,a);else{const h=new Ee.R;h.internalFormat=x.Ab.RGBA,h.wrapMode=x.pF.CLAMP_TO_EDGE,h.width=n,h.height=a,this._layerFBOTexture=new Qe.g(l,h)}}}}class Xr{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=(0,j.WD)(this._layerFBOTexture)}draw(i,n,a){const{width:o,height:l}=n;this._createOrResizeResources(i,o,l);const{context:h,painter:c}=i,{amount:f}=a,u=h.gl,m=this._layerFBOTexture;h.bindFramebuffer(n),n.copyToTexture(0,0,o,l,0,0,m),h.setBlendingEnabled(!0),h.setStencilTestEnabled(!1),h.setDepthTestEnabled(!1),h.setClearColor(0,0,0,0),h.clear(u.COLOR_BUFFER_BIT),c.blitTexture(h,m,x.Cj.NEAREST,f)}_createOrResizeResources(i,n,a){const{context:o}=i;if(!this._layerFBOTexture||this._size[0]!==n||this._size[1]!==a)if(this._size[0]=n,this._size[1]=a,this._layerFBOTexture)this._layerFBOTexture.resize(n,a);else{const l=new Ee.R;l.internalFormat=x.Ab.RGBA,l.wrapMode=x.pF.CLAMP_TO_EDGE,l.samplingMode=x.Cj.NEAREST,l.width=n,l.height=a,this._layerFBOTexture=new Qe.g(o,l)}}}function Zr(d){switch(d){case"bloom":case"blur":case"opacity":case"drop-shadow":return d;default:return"colorize"}}const Jr={colorize:()=>new jr,blur:()=>new Hr,bloom:()=>new Vr,opacity:()=>new Xr,"drop-shadow":()=>new Yr};class Qr{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach(i=>i.dispose()),this._effectMap.clear()}getPostProcessingEffects(i){if(!i||0===i.length)return[];const n=[];for(const a of i){const o=Zr(a.type);let l=this._effectMap.get(o);l||(l=Jr[o](),this._effectMap.set(o,l)),n.push({postProcessingEffect:l,effect:a})}return n}}var qr=y(39784),es=y(89952);class ts{constructor(i,n){this.brushes=i,this.name=n.name,this.drawPhase=n.drawPhase||Ie.S5.MAP,this._targetFn=n.target,this.effects=n.effects||[],this.enableDefaultDraw=n.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!n.forceDrawByDisplayOrder}render(i){const{context:n,profiler:a}=i,o=this._targetFn(),l=this.drawPhase&i.drawPhase;if(a.recordPassStart(this.name),l){this.enableDefaultDraw()&&this._doRender(i,o),a.recordPassEnd();for(const h of this.effects){if(!h.enable())continue;const c=h.apply,f=h.args?.(),u=n.getViewport(),m=n.getBoundFramebufferObject(),g=i.passOptions;this._bindEffect(i,c,f),this._doRender(i,o,c.defines),this._drawAndUnbindEffect(i,c,u,m,g,f)}}}_doRender(i,n,a){if(null==n)return;const{profiler:o,context:l}=i;for(const h of this.brushes){if(o.recordBrushStart(h.name),null!=h.brushEffect){const c=l.getViewport(),f=l.getBoundFramebufferObject(),u=i.passOptions;this._bindEffect(i,h.brushEffect),this._drawWithBrush(h,i,n,a),this._drawAndUnbindEffect(i,h.brushEffect,c,f,u)}else this._drawWithBrush(h,i,n,a);o.recordBrushEnd()}}_drawWithBrush(i,n,a,o){(0,es.Xj)(a)?(i.prepareState(n,o),i.drawMany(n,a,o)):a.visible&&(i.prepareState(n,o),i.draw(n,a,o))}_bindEffect(i,n,a){const{profiler:o}=i;o.recordPassStart(this.name+"."+n.name),n.bind(i,a);const l=n.createOptions(i,a);i.passOptions=l}_drawAndUnbindEffect(i,n,a,o,l,h){const{profiler:c,context:f}=i;i.passOptions=l,c.recordBrushStart(n.name),n.draw(i,h),n.unbind(i,h),f.bindFramebuffer(o);const{x:u,y:m,width:g,height:b}=a;f.setViewport(u,m,g,b),c.recordBrushEnd(),c.recordPassEnd()}}class bi{constructor(){this._programCache=new Map}destroy(){for(const i of this._programCache.values())i.destroy();this._programCache.clear()}getProgram(i,n,a,o,l){const h=i.getShaderKey(n,a,o,l);let c=this._programCache.get(h);return c||(c=i.getProgram(n,a,o,l),this._programCache.set(h,c)),c}}var is=y(17107);class rs{constructor(i,n){this.context=i,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new ai,this._worldExtentRenderer=new Tr,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new Gi,this._blendEffect=new Ir,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new Br,hittest:new Dr,insideEffect:new gi("inside"),outsideEffect:new gi("outside")},this._programCache=new bi,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new ji(i),this.textureManager=new yr(n),this.textureUploadManager=new Or(n),this._effectsManager=new Qr,this._quadMesh=qr.g.fromVertexStream(i,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,j.WD)(this._blitRenderer),this._worldExtentRenderer=(0,j.WD)(this._worldExtentRenderer),this._quadMesh=(0,j.pR)(this._quadMesh),this._brushCache&&(this._brushCache.forEach(i=>i.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos){let i;for(i in this._fbos)this._fbos[i]&&this._fbos[i].dispose()}for(const i of this._fboPool)i.dispose();if(this._fboPool.length=0,this.effects){let i;for(i in this.effects)this.effects[i]&&this.effects[i].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=(0,j.WD)(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new bi}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}get quadMesh(){return this._quadMesh}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(i,n){let a;if(this._fboPool.length>0)a=this._fboPool.pop();else{const o=new Ee.R(i,n);o.samplingMode=x.Cj.NEAREST,o.wrapMode=x.pF.CLAMP_TO_EDGE,a=new $e.H(this.context,o,this._stencilBuf)}return a.width===i&&a.height===n||a.resize(i,n),a}releaseFbo(i){this._fboPool.push(i)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(i,n,a){const{context:o}=i;this._worldExtentRenderer.render(i,n,a);const{width:l,height:h}=o.getViewport();if(this.updateFBOs(l,h),this._prevFBO=o.getBoundFramebufferObject(),o.bindFramebuffer(this.getFbos().output),o.setColorMask(!0,!0,!0,!0),null!=n){const{r:c,g:f,b:u,a:m}=n;o.setClearColor(m*c/255,m*f/255,m*u/255,m)}else o.setClearColor(0,0,0,0);o.setDepthWriteEnabled(!0),o.setClearDepth(1),o.clear(o.gl.COLOR_BUFFER_BIT|o.gl.DEPTH_BUFFER_BIT),o.setDepthWriteEnabled(!1)}afterRenderPhases(i){const{context:n}=i;n.bindFramebuffer(this._prevFBO),n.setStencilFunction(x.MT.EQUAL,D.Qs,255),n.setStencilTestEnabled(!0),n.setDepthTestEnabled(!1),this.blitTexture(n,this.getFbos().output.colorTexture,x.Cj.NEAREST)}beforeRenderLayer(i,n,a){const{context:o,blendMode:l,effects:h,drawPhase:c,requireFBO:f}=i;if(f||xi(c,l,h,a)){const u=o.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(u);const{width:m,height:g}=o.getViewport(),b=this.acquireFbo(m,g);o.bindFramebuffer(b),o.setColorMask(!0,!0,!0,!0),o.setClearColor(0,0,0,0),o.setDepthWriteEnabled(!0),o.setClearDepth(1),o.clear(o.gl.COLOR_BUFFER_BIT|o.gl.DEPTH_BUFFER_BIT),o.setDepthWriteEnabled(!1)}o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),o.setStencilTestEnabled(!0),o.setClearStencil(n),o.setStencilWriteMask(255),o.clear(o.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(i,n){const{context:a,blendMode:o,effects:l,requireFBO:h,drawPhase:c}=i;if(h||xi(c,o,l,n)){const f=a.getBoundFramebufferObject();null!=l&&l.length>0&&c===Ie.S5.MAP&&(a.setColorMask(!0,!0,!0,!0),this._applyEffects(i,l,f)),a.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),a.setColorMask(!0,!0,!0,!0),this._blendEffect.draw(i,f.colorTexture,x.Cj.NEAREST,null==o||c===Ie.S5.HIGHLIGHT||c===Ie.S5.LABEL?"normal":o,n),this.releaseFbo(f)}}renderObject(i,n,a,o){const l=Qt.d[a];if(!l)return;let h=this._brushCache.get(l);void 0===h&&(h=new l,this._brushCache.set(l,h)),h.prepareState(i),h.draw(i,n,o)}renderObjects(i,n,a,o){const l=Qt.d[a];if(!l)return;let h=this._brushCache.get(l);void 0===h&&(h=new l,this._brushCache.set(l,h)),h.drawMany(i,n,o)}registerRenderPass(i){const n=i.brushes.map(a=>(this._brushCache.has(a)||this._brushCache.set(a,new a),this._brushCache.get(a)));return new ts(n,i)}blitTexture(i,n,a,o=1){i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(i,n,a,o),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(i){return this._effectsManager.getPostProcessingEffects(i)}updateFBOs(i,n){if(i!==this._lastWidth||n!==this._lastHeight){if(this._lastWidth=i,this._lastHeight=n,this._fbos){let l;for(l in this._fbos)this._fbos[l].resize(i,n);return}const a=new Ee.R(i,n);a.samplingMode=x.Cj.NEAREST,a.wrapMode=x.pF.CLAMP_TO_EDGE;const o=new jt.q(x.yQ.DEPTH_STENCIL,i,n);this._stencilBuf=new is.l(this.context,o),this._fbos={output:new $e.H(this.context,a,this._stencilBuf),effect0:new $e.H(this.context,a,this._stencilBuf)}}}_applyEffects(i,n,a){const{context:o}=i,l=this._effectsManager.getPostProcessingEffects(n);for(const{postProcessingEffect:h,effect:c}of l)o.bindFramebuffer(a),h.draw(i,a,c);this._currentPipelineStateNeedsUpdate=!0}setShader(i){this._shaderState.shader=i.shader,this._shaderState.uniforms=i.uniforms,this._shaderState.defines=i.defines,this._shaderState.optionalAttributes=i.optionalAttributes,this._shaderState.useComputeBuffer=i.useComputeBuffer??!1}setPipelineState(i){i!==this._currentPipelineState&&(this._currentPipelineState=i,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(i,n){const{shader:a,uniforms:o,defines:l,optionalAttributes:h}=this._shaderState,c=i.context,f=n.getAttributePrecisionPackFactors(),u=this._programCache.getProgram(a,f,o,l??{},h??{});return u.setUniforms(o),u.bind(c),this.updatePipelineState(c),this.setStencilRef(c,n),n.draw(i,a.locationInfo),u.cleanupTemporaryTextures(),{vertexShader:u.vertexShader,fragmentShader:u.fragmentShader}}submitDrawMesh(i,n,a,o){this.submitDrawMeshUntyped(i,n,a,o)}submitDrawMeshUntyped(i,n,a,o){this.setShader(n);const{shader:l,uniforms:h,defines:c,optionalAttributes:f}=this._shaderState,u=this._programCache.getProgram(l,{},h,c??{},f??{});if(u.setUniforms(h),u.bind(i),this.updatePipelineState(i),o)for(const m of o)a.bind(i,n.shader.locationInfo,m),a.draw(i);else for(let m=0;m<a.parts.length;m++)a.bind(i,n.shader.locationInfo,m),a.draw(i);a.unbind(i),u.cleanupTemporaryTextures()}updatePipelineState(i){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(i))}_updatePipelineState(i){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:n,depth:a,stencil:o}=this._currentPipelineState;if(n){const{blendMode:l,write:h}=n;switch(i.setColorMask(...h),i.setBlendingEnabled(!0),i.setBlendEquation(x.Tb.ADD),l){case"composite":i.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA);break;case"additive":i.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE,x.dn.ONE,x.dn.ONE);break;case"custom":{const{blendParameters:c}=n,{dstAlpha:f,dstRGB:u,srcAlpha:m,srcRGB:g}=c;i.setBlendFunctionSeparate(g,u,m,f);break}case"delete":i.setBlendEquation(x.Tb.REVERSE_SUBTRACT),i.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA)}}else i.setColorMask(!1,!1,!1,!1);if(a){const{test:l,write:h}=a;h?(i.setDepthWriteEnabled(!0),i.setDepthRange(h.zNear,h.zFar)):i.setDepthWriteEnabled(!1),l?(i.setDepthTestEnabled(!0),i.setDepthFunction(l)):i.setDepthTestEnabled(!1)}else i.setDepthTestEnabled(!1),i.setDepthWriteEnabled(!1);if(o){const{test:l,write:h}=o;if(l){const{compare:c,mask:f,op:u,ref:m}=l;i.setStencilTestEnabled(!0),"function"!=typeof m&&i.setStencilFunctionSeparate(x.Y7.FRONT_AND_BACK,c,m,f),i.setStencilOpSeparate(x.Y7.FRONT_AND_BACK,u.fail,u.zFail,u.zPass)}else i.setStencilTestEnabled(!1);if(h){const{mask:c}=h;i.setStencilWriteMask(c)}else i.setStencilWriteMask(0)}else i.setStencilTestEnabled(!1),i.setStencilWriteMask(0)}setStencilRef(i,n){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:a}=this._currentPipelineState;if(a){const{test:o}=a;if(o){const{compare:l,mask:h,ref:c}=o;if("function"==typeof c){const f=n.getStencilReference();if(null===f)throw new Error("InternalError: Stencil reference expected for target but not defined");i.setStencilFunctionSeparate(x.Y7.FRONT_AND_BACK,l,f,h)}}}}}function xi(d,i,n,a){return d!==Ie.S5.LABEL_ALPHA&&d!==Ie.S5.LABEL&&d!==Ie.S5.HIGHLIGHT&&(1!==a||null!=i&&"normal"!==i||null!=n&&n.length>0)}var ss=y(55900),ns=y(38730);class as{constructor(){this._candidateTiles=[]}schedule(i){this._candidateTiles.includes(i)||this._candidateTiles.push(i)}reshuffle(i){const n=[];for(const a of this._candidateTiles)i>0?(a.reshuffle(),i--):n.push(a);this._candidateTiles=n}}var wi=y(12598),os=y(80788),ls=y(56551),hs=y(48458);class ds extends Ct.m{constructor(i,n){super(),this.meshWriterRegistry=new os.o,this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=(0,k.v)(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new as,this._canvas=new It(i),this.context=new hs.e(this._canvas.gl,n.contextOptions??{}),this.painter=new rs(this.context,this),this._cimAnalyzer=new Fe(this.painter.textureManager.resourceManager),(0,pe.A)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),i.appendChild(this._debugOutput));const a=()=>this.highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:n.timeline||new ls.K,renderingOptions:n.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new ns.U(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return a()},reshuffleManager:this._reshuffleManager,backgroundColor:n.backgroundColor},this._taskHandle=(0,ve.mg)({render:o=>this.renderFrame(o)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",o=>this.emit("webgl-error",{error:new ye.A("webgl-context-lost",o.statusMessage)})),this._bufferPool=new ss.o,(0,wi.Wn)()}destroy(){(0,wi.n_)(this.context),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,j.xt)(this._taskHandle),this._lostWebGLContextHandle=(0,j.xt)(this._lostWebGLContextHandle),this._canvas.destroy(),this._debugOutput?.parentNode?.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(i){this._renderParameters.backgroundColor=i,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(i){this._renderingOptions=i,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(i){this._state=i,this.requestRender()}get stationary(){return this._stationary}set stationary(i){this._stationary!==i&&(this._stationary=i,this.requestRender())}trashDisplayObject(i){this._trash.add(i),this.requestRender()}untrashDisplayObject(i){return this._trash.delete(i)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(i){this._renderRemainingTime-=this._lastFrameRenderTime?i.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=i.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=i.time,this._renderParameters.deltaTime=i.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:(0,Oe.vt)()}}renderChildren(i){for(const n of this.children)n.beforeRender(i);this._reshuffleManager.reshuffle(D.O5),this._canvas.render(i,()=>this._renderChildren(this.children,i));for(const n of this.children)n.afterRender(i)}_renderChildren(i,n){const a=this.context;this.painter.textureUploadManager.upload(),a.resetInfo(),n.profiler.recordStart("drawLayers"),n.dataUploadCounter=0,this.painter.beforeRenderPhases(n,n.backgroundColor,this.state.padding),n.drawPhase=Ie.S5.MAP;for(const o of i)o.processRender(n);if(this.children.some(o=>o.hasHighlight)){n.drawPhase=Ie.S5.HIGHLIGHT;for(const o of i)o.processRender(n)}if(this.children.some(o=>o.hasLabels)){n.drawPhase=Ie.S5.LABEL;for(const o of i)o.processRender(n)}if((0,pe.A)("esri-tiles-debug")){n.drawPhase=Ie.S5.DEBUG;for(const o of i)o.processRender(n)}this.painter.afterRenderPhases(n),n.profiler.recordEnd("drawLayers"),a.logInfo()}doRender(i){const n=this.context,{state:a,pixelRatio:o}=i;this._canvas.resize(i),n.setViewport(0,0,o*a.size[0],o*a.size[1]),n.setDepthWriteEnabled(!0),n.setStencilWriteMask(255),this.renderChildren(i)}takeScreenshot(i,n,a,o){var l=this;return(0,W.A)(function*(){const h=Math.round(l.state.size[0]*i.resolutionScale),c=Math.round(l.state.size[1]*i.resolutionScale),f=i.resolutionScale,u=l.context,m=l._state.clone();if(null!=o){const J=m.viewpoint;m.viewpoint.rotation=o,m.viewpoint=J}const g={...l._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:m,pixelRatio:f,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:a},b=new Ee.R(h,c);b.wrapMode=x.pF.CLAMP_TO_EDGE,b.internalFormat=x.H0.RGBA8,b.isImmutable=!0;const v=new $e.H(u,b,new jt.q(x.yQ.DEPTH_STENCIL,h,c)),S=u.getBoundFramebufferObject(),O=u.getViewport();u.bindFramebuffer(v),u.setViewport(0,0,h,c),l._renderChildren(n??l.children,g);const R=l._readbackScreenshot(v,{...i.cropArea,y:c-(i.cropArea.y+i.cropArea.height)});u.bindFramebuffer(S),u.setViewport(O.x,O.y,O.width,O.height),l.requestRender();const E=yield R;let T;return 1===i.outputScale?T=E:(T=new ImageData(Math.round(E.width*i.outputScale),Math.round(E.height*i.outputScale)),(yield Promise.resolve().then(y.bind(y,14989))).resampleHermite(E,T,!0)),v.dispose(),T})()}_readbackScreenshot(i,n){return(0,W.A)(function*(){const a=(yield Promise.resolve().then(y.bind(y,14989))).createEmptyImageData(n.width,n.height,document.createElement("canvas"));return yield i.readPixelsAsync(n.x,n.y,n.width,n.height,x.Ab.RGBA,x.ld.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),a})()}_emptyTrash(){for(;this._trash.size>0;){const i=Array.from(this._trash);this._trash.clear();for(const n of i)n.processDetach()}}}var us=y(67399),ps=y(57141),fs=y(57052),ms=y(18800),_s=y(89447),Oi=y(86807),at=y(48900),gs=y(56985),Pi=y(63888),ys=y(45272),vs=y(48875);class Ms extends Gt.j{constructor(){super(...arguments),this.type=Wt.N.Magnifier,this._resourcePixelRatio=1,this._position=[0,0,0,0],this.shaders={magnifier:new vs.u}}updateResources(i,n,a,o){i.pixelRatio!==this._resourcePixelRatio&&this._destroyResources(),this._readbackTexture||this._initializeResources(i,n,a,o);const{context:l,pixelRatio:h}=i,{factor:c,offset:f,position:u}=o,{size:m}=i.state,g=o.size*h,v=Math.ceil(1/c*g);this._readbackTexture.resize(v,v);const S=h*m[0],O=h*m[1],R=.5*v,E=.5*v,T=(0,st.qE)(h*u.x,R,S-R-1),J=(0,st.qE)(O-h*u.y,E,O-E-1),H=T-R,ee=J-E,L=this._readbackTexture;l.bindTexture(L,0),l.gl.copyTexImage2D(L.descriptor.target,0,L.descriptor.pixelFormat,H,ee,v,v,0);const xe=(J-f.y*h)/O*2-1,De=g/S*2,Se=g/O*2;this._position[0]=(T+f.x*h)/S*2-1,this._position[1]=xe,this._position[2]=De,this._position[3]=Se}render(i,n){const{context:a,painter:o}=i;o.setPipelineState(Vt.i);const l={readbackTexture:{texture:this._readbackTexture,unit:0},maskTexture:{texture:this._maskTexture,unit:7},overlayTexture:{texture:this._overlayTexture,unit:6},drawPos:this._position,...n};o.submitDrawMesh(a,{shader:this.shaders.magnifier,uniforms:{config:l},defines:null,optionalAttributes:null,useComputeBuffer:!1},o.quadMesh)}shutdown(){this._destroyResources()}_initializeResources(i,n,a,o){const l=i.context;this._resourcePixelRatio=i.pixelRatio;const h=Math.ceil(o.size*i.pixelRatio);a.width=h,a.height=h;const c=new Ee.R;c.internalFormat=x.Ab.RGBA,c.wrapMode=x.pF.CLAMP_TO_EDGE,c.samplingMode=x.Cj.NEAREST,c.flipped=!0,c.preMultiplyAlpha=!(0,ys.XJ)(a.src)||!i.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new Qe.g(l,c,a),n.width=h,n.height=h,c.pixelFormat=c.internalFormat=x.Ab.ALPHA,this._maskTexture=new Qe.g(l,c,n);const f=1/o.factor;c.pixelFormat=c.internalFormat=x.Ab.RGBA,c.width=c.height=Math.ceil(f*h),c.samplingMode=x.Cj.LINEAR,c.flipped=!1,this._readbackTexture=new Qe.g(l,c)}_destroyResources(){(0,j.WD)(this._maskTexture),(0,j.WD)(this._overlayTexture),(0,j.WD)(this._readbackTexture)}}var Si=y(96797);function Kt(){return(Kt=(0,W.A)(function*(d){const i=y.e(4586).then(y.bind(y,32205)),n=y.e(1655).then(y.bind(y,94036)),a=(0,Si.D)((yield i).default,{signal:d}),o=(0,Si.D)((yield n).default,{signal:d}),l={mask:yield a,overlay:yield o};return(0,Je.Te)(d),l})).apply(this,arguments)}class xs extends Pi.q{constructor(){super(),this._handles=new Oi.A,this._magnifierTechnique=new Ms,this.updatingHandles=new gs.U,this.visible=!1}destroy(){this._handles=(0,j.pR)(this._handles),this._magnifierTechnique.shutdown(),this._resourcesTask=(0,j.DC)(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(i){this._backgroundColor=i,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(i){this._magnifier=i,this._handles.removeAll(),this._handles.add([(0,at.wB)(()=>i.version,()=>{this.visible=i.visible&&null!=i.position&&i.size>0,this.requestRender()},at.Vh),(0,at.wB)(()=>[i.maskUrl,i.overlayUrl],()=>this._reloadResources()),(0,at.wB)(()=>i.size,()=>{this._magnifierTechnique.shutdown(),this.requestRender()})])}_createTransforms(){return{displayViewScreenMat3:(0,Oe.vt)()}}doRender(i){if(!this._resourcesTask)return void this._reloadResources();if(i.drawPhase!==Ie.S5.MAP||!this._canRender())return;const n=this._magnifier;if(null==n.position)return;this._magnifierTechnique.updateResources(i,this._mask,this._overlay,n);const a=this.backgroundColor;this._magnifierTechnique.render(i,{background:a?[a.a*a.r/255,a.a*a.g/255,a.a*a.b/255,a.a]:[1,1,1,1],maskEnabled:n.maskEnabled?1:0,overlayEnabled:n.overlayEnabled?1:0})}_canRender(){return this._mask&&this._overlay&&null!=this._magnifier}_reloadResources(){var i=this;this._resourcesTask&&this._resourcesTask.abort();const n=null!=this._magnifier?this._magnifier.maskUrl:null,a=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,_s.UT)(function(){var o=(0,W.A)(function*(l){const h=null==n||null==a?function bs(d){return Kt.apply(this,arguments)}(l):null,c=null!=n?(0,mt.A)(n,{responseType:"image",signal:l}).then(g=>g.data):h.then(g=>g.mask),f=null!=a?(0,mt.A)(a,{responseType:"image",signal:l}).then(g=>g.data):h.then(g=>g.overlay),[u,m]=yield Promise.all([c,f]);i._mask=u,i._overlay=m,i._magnifierTechnique.shutdown(),i.requestRender()});return function(l){return o.apply(this,arguments)}}()),this.updatingHandles.addPromise(this._resourcesTask.promise)}}var ws=y(82663),tt=y(83953),Yt=y(88532),Ci=y(13970),Os=y(77098),Ps=y(40856),Ti=y(58701),Ss=y(9661);class Cs extends Gt.j{constructor(){super(...arguments),this.type=Wt.N.Grid,this.shaders={grid:new Ss.K}}render(i,n){const{context:a,painter:o}=i;o.setPipelineState(Vt.i),o.submitDrawMesh(a,{shader:this.shaders.grid,uniforms:n,defines:null,optionalAttributes:null,useComputeBuffer:!1},o.quadMesh)}}var Ts=y(83278),Ri=y(34390);const Xt=(0,_i.vt)();class Rs extends Pi.q{constructor(){super(),this._handles=new Oi.A,this._projectedCenter=null,this._metersPerSRUnit=null,this._technique=new Cs,this._grid=null,this.visible=!0}destroy(){this._handles=(0,j.pR)(this._handles),this._technique.shutdown()}get grid(){return this._grid}set grid(i){this._grid=i,this._handles.removeAll(),this._handles.add([(0,at.wB)(()=>i?.center,()=>{this._projectedCenter=null},at.Vh),(0,at.wB)(()=>[i?.center,i?.dynamicScaling,i?.majorLineColor,i?.majorLineInterval,i?.minorLineColor,i?.rotateWithMap,i?.rotation,i?.spacing,i?.units],()=>this.requestRender(),at.Vh)])}_createTransforms(){return{displayViewScreenMat3:(0,Oe.vt)()}}doRender(i){if(i.drawPhase!==Ie.S5.MAP||null==this.grid||!this.visible)return;const{spacing:n,units:a,majorLineInterval:o,dynamicScaling:l,majorLineColor:h,minorLineColor:c}=this.grid;if(0===n||(this._updateDerivedValues(i),null==this._projectedCenter||null==this._metersPerSRUnit))return;const{scale:f,spatialReference:u}=i.state,m=(0,ws.oU)(n,a,"meters"),g=this._metersPerSRUnit*(0,Ps.i1)(f,u),b=m/g;if(!l&&b<Ts.b)return;const v=m*(0,Ri.Ge)(o,b,l);this._updateTransform(i,g,v),this._technique.render(i,{transform:{dvs:this.transforms.displayViewScreenMat3},config:{pxPerCell:v/g,minorLineColor:Ei(c),majorLineColor:Ei(h),majorLineInterval:o,halfWidth:.25,aaWidth:.5}})}_updateDerivedValues(i){if(!this.grid)return;const{center:n}=this.grid,{spatialReference:a}=i.state;this._projectedCenter&&(0,Ti.aI)(this._projectedCenter.spatialReference,a)||(this._metersPerSRUnit=null,(0,Ti.aI)(n.spatialReference,a)?this._projectedCenter=n:(0,Ci.isLoadedOrLoadFor)(n.spatialReference,a)?this._projectedCenter=(0,Ci.project)(n,a):this.requestRender()),null==this._metersPerSRUnit&&null!=this._projectedCenter&&(this._metersPerSRUnit=(0,Ri.WT)(this._projectedCenter))}_updateTransform(i,n,a){const{grid:o}=this,{center:l,rotation:h,size:c,spatialReference:f}=i.state;if(null==o||null==this._projectedCenter||null==this._metersPerSRUnit)return;const u=n*(c[0]/2),m=n*(c[1]/2),g=this._metersPerSRUnit/a,b=this._projectedCenter,v=(0,st.kU)(o.rotation),S=(0,st.kU)(h),O=this.transforms.displayViewScreenMat3;(0,et.$0)(O,-v);const R=f.isWrappable?(0,Os.O7)(b.x,l[0],f):b.x,E=(0,tt.hZ)(Xt,R,b.y),T=(0,tt.jb)(Xt,l,E);(0,tt.hs)(T,T,g),o.rotateWithMap||(0,tt.e$)(T,T,Yt.uY,-S),(0,tt.e$)(T,T,Yt.uY,-v),(0,tt.hs)(T,T,1/o.majorLineInterval),function Es(d,i){d[0]=i[0]-Math.trunc(i[0]),d[1]=i[1]-Math.trunc(i[1])}(T,T),(0,tt.hs)(T,T,o.majorLineInterval),(0,tt.e$)(T,T,Yt.uY,v),(0,et.Tl)(O,O,T),o.rotateWithMap&&(0,et.e$)(O,O,S);const J=(0,tt.hZ)(Xt,u/a,m/a);(0,et.Oe)(O,O,J)}}function Ei(d){const[i,n,a,o]=d.toArray().map(l=>l/255);return[i*o,n*o,a*o,o]}}}]);