"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[2907],{92907:(Nt,we,y)=>{y.r(we),y.d(we,{default:()=>Pt});var C=y(10467),T=y(8189),Be=y(92165),De=y(90660),P=y(5922),de=y(35150),Je=y(39693),_=y(56492),ke=y(48900),N=y(85211),Ue=y(55739),ze=y(3248),V=(y(40707),y(76576)),Ge=y(95478),je=y(25936),He=y(93410),Ve=y(23e3),We=y(4695),Ze=y(17049),$e=y(85551),Xe=y(29252),Ye=y(1151),Ke=y(33036),Qe=y(84311),qe=y(22329),be=y(29141),G=y(95373),Me=y(49343),_e=y(48457),Y=y(78240),et=y(68677),j=y(28067),k=y(32034),tt=y(88996),ne=y(21980),rt=y(96115);function Ce(t){return["x","e","east","long","longitude"].includes(t.toLowerCase())}function Fe(t){return["y","n","west","lat","latitude"].includes(t.toLowerCase())}function pe(t){const e=(0,tt.Z0)();return e?t[e]??Object.values(t)[0]:Object.values(t)[0]}function me(){return Math.round(255*Math.random())}function at(t){let e=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<t.length;n++){const s=t[n];null!=s&&(s<e&&(e=s),s>r&&(r=s))}return(0,rt.X1)(e,r)}function it(t,e,r){const n=t.map((l,c)=>({name:l,count:e[c]})).sort((l,c)=>l.name>c.name?-1:1),s=(i=1,l=>i*=l.count);var i;const a=[...n.slice(1),{name:"",count:1}].reverse().map(s).reverse();let o=0;for(let l=t.length-1;l>=0;l--)o+=a[n.findIndex(({name:c})=>c===t[l])]*(r%e[l]),r=Math.floor(r/e[l]);return o}var lt=y(52593),se=y(83179),ut=y(20053),he=y(40275),K=y(48104);let Q=class extends Y.A{constructor(){super(...arguments),this.datasetFormat="MEMORY",this.source=null}get url(){return""}fetchRawTile(t,e,r,n={}){if(!this._pixelBlockTiles){const{rasterInfo:i}=this,[a,o]=i.storageInfo.tileInfo.size,{sliceId:l}=n,{pixelBlocks:c}=this.source,f={pixelBlock:null==l?c[0]:c[l],useBilinear:"thematic"!==i.dataType,tileSize:{width:a,height:o},level:t,row:e,col:r},d=this.rasterJobHandler?this.rasterJobHandler.clipTile(f,n):(0,he.J$)(f);return Promise.resolve(d)}const s=this._pixelBlockTiles.get(`${t}/${e}/${r}`);return Promise.resolve(s)}_open(t){var e=this;return(0,C.A)(function*(){const r=e.source,{pixelBlocks:n,attributeTable:s,statistics:i,histograms:a,name:o,nativeExtent:l,transform:c}=r,f=n[0],{width:d,height:u,pixelType:p}=f,g=r.extent??new j.A({xmin:-.5,ymin:.5,xmax:d-.5,ymax:u-.5,spatialReference:new k.A({wkid:3857})}),v=r.isPseudoSpatialReference??!r.extent,A={x:g.width/d,y:g.height/u},m={...r.keyProperties};s&&(m.DataType="Thematic");const h=new se.A({width:d,height:u,pixelType:p,extent:g,nativeExtent:l,attributeTable:s,transform:c,pixelSize:A,spatialReference:g.spatialReference,bandCount:f.pixels.length,keyProperties:m,multidimensionalInfo:r.multidimensionalInfo,statistics:i,isPseudoSpatialReference:v,histograms:a});e.ioConfig.skipMapInfo&&e.updateImageSpaceRasterInfo(h),e.createRemoteDatasetStorageInfo(h,512,512),e._set("rasterInfo",h),e.updateTileInfo(),h.multidimensionalInfo?yield e._buildMDimStats(r.pixelBlocks,h.multidimensionalInfo):yield e._buildInMemoryRaster(f,{width:512,height:512},t),h.multidimensionalInfo||(e.source=null),e.datasetName=o})()}_buildInMemoryRaster(t,e,r){var n=this;return(0,C.A)(function*(){const{rasterInfo:s}=n,i=s.storageInfo.maximumPyramidLevel??0,a="thematic"!==s.dataType,o=n.rasterJobHandler?n.rasterJobHandler.split({pixelBlock:t,tileSize:e,maximumPyramidLevel:i,useBilinear:a},r):Promise.resolve((0,he.lD)(t,e,i,a)),l=null!=s.statistics,c=null!=s.histograms,f=n.ioConfig.skipStatistics||l?Promise.resolve({statistics:null,histograms:null}):n.rasterJobHandler?n.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},r):Promise.resolve((0,K.f4)(t)),d=yield(0,_.Lx)([o,f]);if(!d[0].value&&d[1].value)throw new P.A("inmemory-raster:open","failed to build in memory raster");n._pixelBlockTiles=d[0].value,l||(s.statistics=d[1].value?.statistics),c||(s.histograms=d[1].value?.histograms)})()}_buildMDimStats(t,e,r){var n=this;return(0,C.A)(function*(){for(let s=0;s<e.variables.length;s++){const i=e.variables[s];if(i.statistics)continue;const a=i.dimensions.map(f=>new lt.A({variableName:i.name,dimensionName:f.name,values:[f.values?.[0]??f.extent?.[0]],isSlice:!0})),o=(0,ut.NG)(a,e),l=null==o?null:t[o];if(null==l)continue;const c=n.rasterJobHandler?yield n.rasterJobHandler.computeStatisticsHistograms({pixelBlock:l},r):(0,K.eH)(l);i.statistics=c.statistics,i.histograms||(i.histograms=c.histograms)}})()}};(0,T._)([(0,N.MZ)({type:String,json:{write:!0}})],Q.prototype,"datasetFormat",void 0),(0,T._)([(0,N.MZ)()],Q.prototype,"source",void 0),(0,T._)([(0,N.MZ)()],Q.prototype,"url",null),Q=(0,T._)([(0,V.$)("esri.layers.support.rasterDatasets.InMemoryRaster")],Q);const ye=Q;var Oe=y(93327);let ee=class extends Y.A{constructor(){super(...arguments),this.datasetFormat="CovJSON"}fetchRawTile(t,e,r,n={}){return this._inMemoryRaster.fetchRawTile(t,e,r,n)}_open(t){var e=this;return(0,C.A)(function*(){const{extent:r,pixelBlocks:n,multidimensionalInfo:s,attributeTable:i,bandNames:a}=yield e._fetchData(t),{statistics:o,histograms:l}=(0,K.eH)(n[0]),c=a?.map(p=>({BandName:p})),f={DataType:i?"Thematic":s?"Scientific":"Generic",BandProperties:c},d=new ye({source:{extent:r,pixelBlocks:n,attributeTable:i?Oe.A.fromJSON(i):null,multidimensionalInfo:s,statistics:o,histograms:l,keyProperties:f,isPseudoSpatialReference:!1}});yield d.open(),e._inMemoryRaster=d;const u=e.source?"":e.url.slice(e.url.lastIndexOf("/")+1);e._set("datasetName",u.slice(0,u.indexOf("."))),e._set("rasterInfo",d.rasterInfo)})()}_fetchData(t){var e=this;return(0,C.A)(function*(){const r=e.source??(yield e.request(e.url,{signal:t?.signal})).data,n="imagery-tile-layer:open-coverage-json";if("coverage"!==r.type?.toLowerCase()||"grid"!==r.domain?.domainType?.toLowerCase())throw new P.A(n,"Only coverage with Grid domain type is supported");if(!r.ranges)throw new P.A(n,"Missing ranges in the grid coverage data");if(!r.domain.referencing?.length)throw new P.A(n,"Missing domain referencing in the grid coverage data");const s=Object.values(r.ranges);for(let i=0;i<s.length;i++){const{axisNames:a,shape:o,type:l,values:c}=s[i];if(!("ndarray"===l.toLowerCase()&&c?.length&&a?.length&&o?.length))throw new P.A(n,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!Ce(a[a.length-1])||!Fe(a[a.length-2]))throw new P.A(n,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return function ot(t){const{width:e,height:r,extent:n,dimensions:s}=function nt(t){const{axes:e}=t.domain,r=Object.keys(e),n=[],s=[];let i=-1,a=-1,o=[];for(let h=0;h<r.length;h++){const b=r[h];Ce(b)?i=h:Fe(b)&&(a=h);const S=e[b],x=[];if("values"in S){S.values.forEach(w=>x.push("string"==typeof w?new Date(w).getTime():w));const R=x[1]-x[0];n.push([x[0]-.5*R,x[x.length-1]+.5*R]),s.push(R)}else{const{start:R,stop:w,num:I}=S,M=(w-R)/(I-1);n.push([R-.5*M,w+.5*M]),s.push(M);for(let O=0;O<I;O++)x.push(R+M*O)}o.push({name:b,values:x,extent:[x[0],x[x.length-1]]})}i>-1&&-1===a?a=0===i?1:0:a>-1&&-1===i?i=0===a?1:0:-1===a&&-1===i&&(i=0,a=1),o=o.filter((h,b)=>!(b===i||b===a));const{referencing:l}=t.domain,c=l.find(h=>h.coordinates.includes(r[i])).system.id,f=c?.slice(c.lastIndexOf("/")+1),d=null==f||"CRS84"===f?4326:Number(f),u=new k.A({wkid:d}),[p,g]=n[i],[v,A]=n[a],m=new j.A({xmin:p,xmax:g,ymin:v,ymax:A,spatialReference:u});return{width:Math.round(m.width/s[i]),height:Math.round(m.height/s[a]),extent:m,dimensions:o}}(t),{ranges:i}=t,a=Object.keys(i).sort((u,p)=>u<p?-1:1),o=[];for(let u=0;u<a.length;u++){const p=a[u];s?.length&&o.push({name:p,dimensions:s})}const l=function st(t){const e={},{parameters:r}=t;if(!r)return e;for(const[n,s]of Object.entries(r)){const{type:i,description:a,unit:o,categoryEncoding:l,observedProperty:c}=s;if("Parameter"===i&&(e[n]={},a&&(e[n].description=pe(a)),o&&(e[n].unit=o.label?pe(o.label):null,e[n].symbol=o.symbol?.value),l)){const f=Object.entries(l).map((p,g)=>({OID:g,Value:Number(p[1]),ClassName:p[0].slice(p[0].lastIndexOf("/")+1),Count:1}));let d=!1;c?.categories?.length&&(c.categories.forEach(p=>{if(!p.id)return;const g=p.id.slice(p.id.lastIndexOf("/")+1),v=f.find(m=>m.ClassName===g);if(!v)return;const A=p.label?pe(p.label):null;if(v.Label=A,p.preferredColor){const m=et.A.fromHex(p.preferredColor);m&&(d=!0,v.Red=m.r,v.Green=m.g,v.Blue=m.b)}}),d&&f.forEach(p=>{null==p.Red&&(p.Red=me(),p.Green=me(),p.Blue=me())}));const u={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:f.map(p=>({attributes:p}))};d&&u.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),e[n].attributeTable=u}}return e}(t);o.forEach(u=>l[u.name]&&Object.assign(u,l[u.name]));const c=o.length?{variables:o}:void 0,f=[];for(let u=0;u<a.length;u++){const p=a[u],{values:g,dataType:v,axisNames:A,shape:m}=i[p],h=m.length>2?u*m.slice(0,-2).reduce((I,M)=>I*M):0,b=A.slice(0,-2),S=m.slice(0,-2),x="float"===v?"f32":at(g),R=e*r,w=g.length/R;for(let I=0;I<w;I++){const M=ne.A.createEmptyBand(x,R),O=new Uint8Array(R).fill(255);let B=!1;const E=I*R;for(let L=0;L<R;L++){const U=g[E+L];null==U?(O[L]=0,B=!0):M[L]=U}if(0===u||s?.length){const L=new ne.A({width:e,height:r,mask:B?O:null,pixels:[M],pixelType:x});L.updateStatistics(),s?.length?f[it(b,S,I)+h]=L:f.push(L)}else{const L=f[I];L.pixels.push(M),B?L.mask&&(L.mask=ne.A.combineBandMasks([L.mask,O])):L.mask=B?O:null}}}const d=Object.values(l).find(u=>u.attributeTable)?.attributeTable;return{extent:n,pixelBlocks:f,multidimensionalInfo:c,attributeTable:d,bandNames:c?void 0:a}}(r)})()}};(0,T._)([(0,N.MZ)({type:String,json:{write:!0}})],ee.prototype,"datasetFormat",void 0),(0,T._)([(0,N.MZ)({constructOnly:!0})],ee.prototype,"source",void 0),ee=(0,T._)([(0,V.$)("esri.layers.support.rasterDatasets.CovJSONRaster")],ee);const ct=ee;var ge=y(89952),ft=y(58701),F=y(19639),ve=y(47168);function Pe(t,e){if(!t||!e)return null;const r=[];for(let n=0;n<t.length;n++)r.push(t[n]),r.push(e[n]);return r}function ae(t){if(!t)return null;let e=Number(t);if(!isNaN(e)&&0!==e)return new k.A({wkid:e});if(t=String(t).trim(),(0,ft.jp)(t))return new k.A({wkt2:t});const r=t.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;const n=r.indexOf("VERTCS"),s=r.indexOf("PROJCS"),i=s>-1?s:r.indexOf("GEOGCS");if(-1===i)return null;const a=t.slice(i,t.lastIndexOf("]",n)+1).trim(),o=t.slice(n,t.lastIndexOf("]")).trim();e=xe(a);const l=new k.A(e?{wkid:e}:{wkt:a}),c=xe(o);return c&&(l.vcsWkid=c),l}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(e=xe(t),new k.A(0!==e?{wkid:e}:{wkt:t})):null}function xe(t){const e=t.replaceAll("]","[").replaceAll('"',"").split("[").map(s=>s.trim()).filter(s=>""!==s),r=e[e.length-1].split(","),n=r[0]?.toLowerCase();if(("epsg"===n||"esri"===n)&&t.endsWith('"]]')){const s=Number(r[1]);if(!isNaN(s)&&0!==s)return s}return 0}function Ie(t){if("pamdataset"!==t?.documentElement.tagName?.toLowerCase())return{};const e={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};t.documentElement.childNodes.forEach(n=>{if(1===n.nodeType)if((0,F.g7)(n,"SRS")){if(!e.spatialReference){const s=(0,F.mX)(n);e.spatialReference=ae(s)}}else if((0,F.g7)(n,"Metadata"))if("xml:ESRI"===n.getAttribute("domain")){const{spatialReference:s,transform:i}=function dt(t){const e=(0,F.V6)(t,"GeodataXform"),r=ae((0,F.v7)(e,"SpatialReference/WKID")||(0,F.mX)(e,"SpatialReference/WKT"));if("typens:PolynomialXform"!==e.getAttribute("xsi:type"))return{spatialReference:r,transform:null};const n=(0,F.v7)(e,"PolynomialOrder")??1,s=(0,F.Ui)(e,"CoeffX/Double"),i=(0,F.Ui)(e,"CoeffY/Double"),a=(0,F.Ui)(e,"InverseCoeffX/Double"),o=(0,F.Ui)(e,"InverseCoeffY/Double"),l=Pe(s,i),c=Pe(a,o);return{spatialReference:r,transform:l&&c&&l.length&&c.length?new ve.A({spatialReference:r,polynomialOrder:n,forwardCoefficients:l,inverseCoefficients:c}):null}}(n);e.transform=i,e.spatialReference||(e.spatialReference=s)}else(0,F.IC)(n,"MDI").forEach(s=>e.metadata[s.getAttribute("key")]=(0,F.mX)(s));else if((0,F.g7)(n,"PAMRasterBand")){const s=function pt(t){const e=(0,F.v7)(t,"NoDataValue"),r=(0,F.V6)(t,"Histograms/HistItem"),n=(0,F.v7)(r,"HistMin"),s=(0,F.v7)(r,"HistMax"),i=(0,F.v7)(r,"BucketCount"),a=(0,F.mX)(r,"HistCounts")?.split("|").map(u=>Number(u));let o,l,c,f;(0,F.IC)(t,"Metadata/MDI").forEach(u=>{const p=Number(u.textContent??u.nodeValue);switch(u.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":o=p;break;case"STATISTICS_MAXIMUM":l=p;break;case"STATISTICS_MEAN":c=p;break;case"STATISTICS_STDDEV":f=p}});const d=(0,F.v7)(t,"Metadata/SourceBandIndex");return{noDataValue:e,histogram:a?.length&&null!=n&&null!=s?{min:n,max:s,size:i||a.length,counts:a}:null,sourceBandIndex:d,statistics:null!=o&&null!=l?{min:o,max:l,avg:c,stddev:f}:null}}(n);null!=s.sourceBandIndex&&null==e.rasterBands[s.sourceBandIndex]?e.rasterBands[s.sourceBandIndex]=s:e.rasterBands.push(s)}});const r=e.rasterBands;return r.length&&(e.statistics=r[0].statistics?r.map(i=>i.statistics).filter(ge.Ru):null,e.histograms=r[0].histogram?r.map(i=>i.histogram).filter(ge.Ru):null),e}var mt=y(99263);let ie=class extends Y.A{fetchRawTile(t,e,r,n={}){return this._inMemoryRaster.fetchRawTile(t,e,r,n)}_open(t){var e=this;return(0,C.A)(function*(){const r=yield e._fetchData(t);let{spatialReference:n,statistics:s,histograms:i,transform:a}=yield e._fetchAuxiliaryData(t);const o=!n;o&&(n=new k.A({wkid:3857})),i?.length&&null==s&&(s=(0,K.Pg)(i));const{width:l,height:c}=r;let f=new j.A({xmin:-.5,ymin:.5-c,xmax:l-.5,ymax:.5,spatialReference:n});const d=a?a.forwardTransform(f):f;let u=!0;if(a){const g=a.forwardCoefficients;u=g&&0===g[1]&&0===g[2],u&&(a=null,f=d)}const p=new ye({source:{extent:d,nativeExtent:f,transform:a,pixelBlocks:[r],statistics:s,histograms:i,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:o},ioConfig:{sampling:"closest",skipStatistics:!0}});e.ioConfig.skipMapInfo&&(p.ioConfig.skipMapInfo=!0),yield p.open(),p.source=null,e._set("rasterInfo",p.rasterInfo),e._inMemoryRaster=p})()}_fetchData(t){var e=this;return(0,C.A)(function*(){const{data:r}=yield e.request(e.url,{responseType:"array-buffer",signal:t?.signal}),n=(0,mt.g)(r).toUpperCase();if("JPG"!==n&&"PNG"!==n&&"GIF"!==n&&"BMP"!==n)throw new P.A("image-aux-raster:open","the data is not a supported format");e._set("datasetFormat",n);const s=n.toLowerCase(),i="gif"===s||"bmp"===s||!(0,ze.A)("ios"),a=yield e.decodePixelBlock(r,{format:s,useCanvas:i,hasNoZlibMask:!0});if(null==a)throw new P.A("image-aux-raster:open","the data cannot be decoded");return a})()}_fetchAuxiliaryData(t){var e=this;return(0,C.A)(function*(){const r=t?.signal,{skipExtensions:n=[],skipMapInfo:s}=e.ioConfig,i=s||n.includes("aux.xml")?null:e.request(e.url+".aux.xml",{responseType:"xml",signal:r}),a=e.datasetFormat,o="JPG"===a?"jgw":"PNG"===a?"pgw":"BMP"===a?"bpw":null,l=o&&n.includes(o)?null:e.request(e.url.slice(0,e.url.lastIndexOf("."))+"."+o,{responseType:"text",signal:r}),c=yield(0,_.Lx)([i,l]);if(r?.aborted)throw(0,_.NK)();const f=Ie(c[0].value?.data);if(!f.transform){const d=c[1].value?c[1].value.data.split("\n").slice(0,6).map(u=>Number(u)):null;f.transform=6===d?.length?new ve.A({forwardCoefficients:[d[4],d[5],d[0],-d[1],d[2],-d[3]]}):null}return f})()}};(0,T._)([(0,N.MZ)({type:String,json:{write:!0}})],ie.prototype,"datasetFormat",void 0),ie=(0,T._)([(0,V.$)("esri.layers.support.rasterDatasets.ImageAuxRaster")],ie);const oe=ie;var ht=y(11432),yt=y(45272),W=y(1749),Se=y(61599),le=y(11333),gt=y(77677),vt=y(39181),Ne=y(93091);let te=class extends Y.A{constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat="RasterTileServer",this.tileType=null}fetchRawTile(t,e,r,n={}){var s=this;return(0,C.A)(function*(){const{storageInfo:i,extent:a}=s.rasterInfo,{transposeInfo:o}=i,l=null!=o&&!!n.transposedVariableName;if(s._slices&&!l&&null==n.sliceId)return null;const f=`${s.url}/tile/${l?0:i.maximumPyramidLevel-t+s._levelOffset}/${e}/${r}`,d=s._slices?l?{variable:n.transposedVariableName}:{sliceId:n.sliceId||0}:null,{data:u}=yield s.request(f,{query:d,responseType:"array-buffer",signal:n.signal});if(!u)return null;const p=l?o.tileSize:i.tileInfo.size,g=yield s.decodePixelBlock(u,{width:p[0],height:p[1],planes:null,pixelType:null,isPoint:"Elevation"===s.tileType,returnInterleaved:l,noDataValue:s.rasterInfo.noDataValue});if(null==g)return null;const v=i.blockBoundary[t];if("jpg"!==i.compression||r>v.minCol&&r<v.maxCol&&e>v.minRow&&e<v.maxRow)return g;const{origin:A,blockWidth:m,blockHeight:h}=i,{x:b,y:S}=s.getPyramidPixelSize(t),x=Math.round((a.xmin-A.x)/b)%m,R=Math.round((a.xmax-A.x)/b)%m||m,w=Math.round((A.y-a.ymax)/S)%h,I=Math.round((A.y-a.ymin)/S)%h||h,M=r===v.minCol?x:0,O=e===v.minRow?w:0;return(0,he.z$)(g,{x:M,y:O},{width:(r===v.maxCol?R:m)-M,height:(e===v.maxRow?I:h)-O}),g})()}getSliceIndex(t){if(!this._slices||null==t||0===t.length)return null;const e=t;for(let r=0;r<this._slices.length;r++){const n=this._slices[r].multidimensionalDefinition;if(n.length===e.length&&!n.some(s=>{const i=e.find(a=>s.variableName===a.variableName&&a.dimensionName===s.dimensionName);return!i||(Array.isArray(s.values[0])?`${s.values[0][0]}-${s.values[0][1]}`:s.values[0])!==(Array.isArray(i.values[0])?`${i.values[0][0]}-${i.values[0][1]}`:i.values[0])}))return r}return null}fetchVariableStatisticsHistograms(t,e){var r=this;return(0,C.A)(function*(){const n=r.request(r.url+"/statistics",{query:{variable:t,f:"json"},signal:e}).then(a=>a.data?.statistics),s=r.request(r.url+"/histograms",{query:{variable:t,f:"json"},signal:e}).then(a=>a.data?.histograms),i=yield Promise.all([n,s]);return i[0]&&i[0].forEach(a=>{a.avg=a.mean,a.stddev=a.standardDeviation}),i[1]?.[0]?.counts?.length||(i[1]=null),{statistics:i[0]||null,histograms:i[1]||null}})()}computeBestPyramidLevelForLocation(t,e={}){var r=this;return(0,C.A)(function*(){if(!r._tilemapCache)return 0;let n=r.identifyPixelLocation(t,0,e.datumTransformation);if(null===n)return null;let s=0;const{maximumPyramidLevel:i}=r.rasterInfo.storageInfo;let a=i-s+r._levelOffset;const o=n.srcLocation;for(;a>=0;){try{if("available"===(yield r._tilemapCache.fetchAvailability(a,n.row,n.col,e)))break}catch{}if(a--,s++,n=r.identifyPixelLocation(o,s,e.datumTransformation),null===n)return null}return-1===a||null==n?null:s})()}_open(t){var e=this;return(0,C.A)(function*(){const r=t?.signal,n=e.sourceJSON?{data:e.sourceJSON}:yield e.request(e.url,{query:{f:"json"},signal:r});n.ssl&&(e.url=e.url.replace(/^http:/i,"https:"));const s=n.data;if(e.sourceJSON=s,!s)throw new P.A("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!s.tileInfo)throw new P.A("imageserverraster:open","use ImageryLayer to open non-tiled image services");e._fixScaleInServiceInfo(),e.tileType=s.cacheType,null==e.tileType&&(e.tileType=["jpg","jpeg","png","png8","png24","png32","mixed"].includes(s.tileInfo.format.toLowerCase())?"Map":"lerc"===s.tileInfo.format.toLowerCase()?"Elevation":"Raster"),e.datasetName=s.name?.slice(s.name.indexOf("/")+1)??"";const a=yield e._fetchRasterInfo({signal:r});if(null==a)throw new P.A("image-server-raster:open","cannot initialize image service");(0,Ne.E9)(a,s);const o="Map"===e.tileType?function xt(t,e){if(!t)return null;const{minScale:r,maxScale:n,minLOD:s,maxLOD:i}=e;if(null!=s&&null!=i)return le.A.fromJSON({...t,lods:t.lods.filter(({level:a})=>null!=a&&a>=s&&a<=i)});if(0!==r&&0!==n){const a=c=>Math.round(1e4*c)/1e4,o=r?a(r):1/0,l=n?a(n):-1/0;return le.A.fromJSON({...t,lods:t.lods.filter(c=>{const f=a(c.scale);return f<=o&&f>=l})})}return le.A.fromJSON(t)}(s.tileInfo,s):le.A.fromJSON(s.tileInfo);(0,ht.Lw)(o);const[l,c]=e._computeMinMaxLOD(a,o),{extent:f,pixelSize:d}=a,u=.5/a.width*d.x,p=Math.max(d.x,d.y),{lods:g}=o;("Map"!==e.tileType&&0!==s.maxScale||Math.abs(d.x-d.y)>u||!g.some(I=>Math.abs(I.resolution-p)<u))&&(d.x=d.y=l.resolution,a.width=Math.ceil((f.xmax-f.xmin)/d.x-.1),a.height=Math.ceil((f.ymax-f.ymin)/d.y-.1));const v=l.level-c.level,[A,m]=o.size,h=[],b=[];g.forEach((I,M)=>{I.level>=c.level&&I.level<=l.level&&h.push({x:I.resolution,y:I.resolution}),M<g.length-1&&b.push(Math.round(10*I.resolution/g[M+1].resolution)/10)}),h.sort((I,M)=>I.x-M.x);const S=e.computeBlockBoundary(f,A,m,o.origin,h,v),x=h.length>1?h.slice(1):null;let R;s.transposeInfo&&(R={tileSize:[s.transposeInfo.rows,s.transposeInfo.cols],packetSize:a.keyProperties?._yxs.PacketSize??0});const w=b.length<=1||b.length>=3&&b.slice(0,-1).every(I=>I===b[0])?b[0]??2:Math.round(10/(c.resolution/l.resolution)**(-1/v))/10;if(a.storageInfo=new Se.A({blockWidth:o.size[0],blockHeight:o.size[1],pyramidBlockWidth:o.size[0],pyramidBlockHeight:o.size[1],pyramidResolutions:x,pyramidScalingFactor:w,compression:o.format,origin:o.origin,firstPyramidLevel:1,maximumPyramidLevel:v,tileInfo:o,transposeInfo:R,blockBoundary:S}),function It(t){const{extent:e,spatialReference:r}=t;e.xmin>-1&&e.xmax>181&&r?.wkid&&r.isGeographic&&(t.nativeExtent=t.extent,t.transform=new vt.A,t.extent=t.transform.forwardTransform(e))}(a),e._set("rasterInfo",a),s.capabilities.toLowerCase().includes("tilemap")){const I={tileInfo:a.storageInfo.tileInfo,parsedUrl:(0,yt.An)(e.url),url:e.url,tileServers:[]};e._tilemapCache=new gt.d({layer:I})}})()}_fetchRasterInfo(t){var e=this;return(0,C.A)(function*(){const r=e.sourceJSON;if("Map"===e.tileType){const o=r.fullExtent||r.extent,l=Math.ceil((o.xmax-o.xmin)/r.pixelSizeX-.1),c=Math.ceil((o.ymax-o.ymin)/r.pixelSizeY-.1),f=k.A.fromJSON(r.spatialReference||o.spatialReference),d=new W.A({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:f});return new se.A({width:l,height:c,bandCount:3,extent:j.A.fromJSON(o),spatialReference:f,pixelSize:d,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})}const{signal:n}=t,s=(0,Ne.Tw)(e.url,e.sourceJSON,{signal:n,query:e.ioConfig.customFetchParameters}),i=r.hasMultidimensions?e.request(`${e.url}/slices`,{query:{f:"json"},signal:n}).then(o=>o.data?.slices).catch(()=>null):null,a=yield Promise.all([s,i]);return e._slices=a[1],a[0]})()}_fixScaleInServiceInfo(){const{sourceJSON:t}=this;t.minScale&&t.minScale<0&&(t.minScale=0),t.maxScale&&t.maxScale<0&&(t.maxScale=0)}_computeMinMaxLOD(t,e){const{pixelSize:r}=t,n=.5/t.width*r.x,{lods:s}=e,i=e.lodAt(Math.max.apply(null,s.map(u=>u.level))),a=e.lodAt(Math.min.apply(null,s.map(u=>u.level))),{tileType:o}=this;if("Map"===o)return this._levelOffset=s[0].level,[i,a];if("Raster"===o)return[s.find(u=>u.resolution===r.x)??i,a];const{minScale:l,maxScale:c}=this.sourceJSON;let f=i;c>0&&(f=s.find(u=>Math.abs(u.scale-c)<n),f||(f=s.filter(u=>u.scale>c).sort((u,p)=>u.scale>p.scale?1:-1)[0]??i));let d=a;return l>0&&(d=s.find(u=>Math.abs(u.scale-l)<n)??a,this._levelOffset=d.level-a.level),[f,d]}};(0,T._)([(0,N.MZ)({type:String,json:{write:!0}})],te.prototype,"datasetFormat",void 0),(0,T._)([(0,N.MZ)()],te.prototype,"tileType",void 0),te=(0,T._)([(0,V.$)("esri.layers.support.rasterDatasets.ImageServerRaster")],te);const St=te;var At=y(79892);const z=new Map;z.set("Int8","s8"),z.set("UInt8","u8"),z.set("Int16","s16"),z.set("UInt16","u16"),z.set("Int32","s32"),z.set("UInt32","u32"),z.set("Float32","f32"),z.set("Float64","f32"),z.set("Double64","f32");const H=new Map;H.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),H.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),H.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),H.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});let q=class extends Y.A{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}fetchRawTile(t,e,r,n={}){var s=this;return(0,C.A)(function*(){const{blockWidth:i,blockHeight:a,blockBoundary:o}=s.rasterInfo.storageInfo,l=o[t];if(!l||l.maxRow<e||l.maxCol<r||l.minRow>e||l.minCol>r)return null;const{bandCount:c,pixelType:f}=s.rasterInfo,{ranges:d,actualTileWidth:u,actualTileHeight:p}=s._getTileLocation(t,e,r);if(!d||0===d.length)return null;if(0===d[0].from&&0===d[0].to){const E=new Uint8Array(i*a);return new ne.A({width:i,height:a,pixels:void 0,mask:E,validPixelCount:0})}const{bandIds:g}=s.ioConfig,v=s._getBandSegmentCount(),A=[];let m=0;for(m=0;m<v;m++)g&&!g.includes(m)||A.push(s.request(s._files.data,{range:{from:d[m].from,to:d[m].to},responseType:"array-buffer",signal:n.signal}));const h=yield Promise.all(A),b=h.map(E=>E.data.byteLength).reduce((E,L)=>E+L),S=new Uint8Array(b),x=[];let R=0;for(m=0;m<v;m++)x.push(R),S.set(new Uint8Array(h[m].data),R),R+=h[m].data.byteLength;const w=H.get(s.rasterInfo.storageInfo.compression).decoderFormat,I=yield s.decodePixelBlock(S.buffer,{width:i,height:a,format:w,planes:g?.length||c,offsets:x,pixelType:f});if(null==I)return null;let{noDataValue:M}=s.rasterInfo;if(null!=M&&"lerc"!==w&&!I.mask&&(M=M[0],null!=M)){const E=I.width*I.height,L=new Uint8Array(E);if(Math.abs(M)>1e24)for(m=0;m<E;m++)Math.abs((I.pixels[0][m]-M)/M)>1e-6&&(L[m]=1);else for(m=0;m<E;m++)I.pixels[0][m]!==M&&(L[m]=1);I.mask=L}let O=0,B=0;if(u!==i||p!==a){let E=I.mask;if(E)for(m=0;m<a;m++)if(B=m*i,m<p)for(O=u;O<i;O++)E[B+O]=0;else for(O=0;O<i;O++)E[B+O]=0;else for(E=new Uint8Array(i*a),I.mask=E,m=0;m<p;m++)for(B=m*i,O=0;O<u;O++)E[B+O]=1}return I})()}_open(t){var e=this;return(0,C.A)(function*(){e.datasetName=e.url.slice(e.url.lastIndexOf("/")+1);const r=t?t.signal:null,n=yield e.request(e.url,{responseType:"xml",signal:r}),{rasterInfo:s,files:i}=e._parseHeader(n.data),{skipMapInfo:a,skipExtensions:o=[]}=e.ioConfig;if(!o.includes("aux.xml")&&!a){const h=yield e._fetchAuxiliaryData(t);null!=h&&(s.statistics=h.statistics??s.statistics,s.histograms=h.histograms,h.histograms&&null==s.statistics&&(s.statistics=(0,K.Pg)(h.histograms)))}a&&e.updateImageSpaceRasterInfo(s),e._set("rasterInfo",s),e._files=i;const l=yield e.request(i.index,{responseType:"array-buffer",signal:r});e._storageIndex=function Rt(t){if(t.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");let e,r,n,s,i,a;if(At.Z){for(r=new Uint8Array(t),s=new ArrayBuffer(t.byteLength),n=new Uint8Array(s),i=0;i<t.byteLength/4;i++)for(a=0;a<4;a++)n[4*i+a]=r[4*i+3-a];e=new Uint32Array(s)}else e=new Uint32Array(t);return e}(l.data);const{blockWidth:c,blockHeight:f}=e.rasterInfo.storageInfo,d=e.rasterInfo.storageInfo.pyramidScalingFactor,{width:u,height:p}=e.rasterInfo,g=[],v=e._getBandSegmentCount();let A=0,m=-1;for(;A<e._storageIndex.length;){m++;const h=Math.ceil(u/c/d**m)-1,b=Math.ceil(p/f/d**m)-1;A+=(h+1)*(b+1)*v*4,g.push({maxRow:b,maxCol:h,minCol:0,minRow:0})}e.rasterInfo.storageInfo.blockBoundary=g,m>0&&(e.rasterInfo.storageInfo.firstPyramidLevel=1,e.rasterInfo.storageInfo.maximumPyramidLevel=m),e.updateTileInfo()})()}_getBandSegmentCount(){return H.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(t,e,r){const{blockWidth:n,blockHeight:s,pyramidScalingFactor:i}=this.rasterInfo.storageInfo,{width:a,height:o}=this.rasterInfo,l=this._getBandSegmentCount();let c,f,d,u=0,p=0;for(d=0;d<t;d++)p=i**d,c=Math.ceil(a/n/p),f=Math.ceil(o/s/p),u+=c*f;p=i**t,c=Math.ceil(a/n/p),f=Math.ceil(o/s/p),u+=e*c+r,u*=4*l;const g=this._storageIndex.subarray(u,u+4*l);let v=0,A=0;const m=[];for(let h=0;h<l;h++)v=g[4*h]*2**32+g[4*h+1],A=v+g[4*h+2]*2**32+g[4*h+3],m.push({from:v,to:A});return{ranges:m,actualTileWidth:r<c-1?n:Math.ceil(a/p)-n*(c-1),actualTileHeight:e<f-1?s:Math.ceil(o/p)-s*(f-1)}}_parseHeader(t){const e=(0,F.V6)(t,"MRF_META/Raster");if(!e)throw new P.A("mrf:open","not a valid MRF format");const r=(0,F.V6)(e,"Size"),n=parseInt(r.getAttribute("x"),10),s=parseInt(r.getAttribute("y"),10),i=parseInt(r.getAttribute("c"),10),a=((0,F.mX)(e,"Compression")||"none").toLowerCase();if(!H.has(a))throw new P.A("mrf:open","currently does not support compression "+a);const o=(0,F.mX)(e,"DataType")||"UInt8",l=z.get(o);if(null==l)throw new P.A("mrf:open","currently does not support pixel type "+o);const c=(0,F.V6)(e,"PageSize"),f=parseInt(c.getAttribute("x"),10),d=parseInt(c.getAttribute("y"),10),u=(0,F.V6)(e,"DataValues");let p,g;if(u&&(g=u.getAttribute("NoData"),null!=g&&(p=g.trim().split(" ").map(B=>parseFloat(B)))),(0,F.V6)(t,"MRF_META/CachedSource"))throw new P.A("mrf:open","currently does not support MRF referencing other data files");const v=(0,F.V6)(t,"MRF_META/GeoTags"),A=(0,F.V6)(v,"BoundingBox");let m,h=!1;if(null!=A){const B=parseFloat(A.getAttribute("minx")),E=parseFloat(A.getAttribute("miny")),L=parseFloat(A.getAttribute("maxx")),U=parseFloat(A.getAttribute("maxy")),X=(0,F.mX)(v,"Projection")||"";let fe=k.A.WGS84;if("LOCAL_CS[]"!==X)if(X.toLowerCase().startsWith("epsg:")){const Te=Number(X.slice(5));isNaN(Te)||0===Te||(fe=new k.A({wkid:Te}))}else fe=ae(X)??k.A.WGS84;else h=!0,fe=new k.A({wkid:3857});m=new j.A(B,E,L,U),m.spatialReference=fe}else h=!0,m=new j.A({xmin:-.5,ymin:.5-s,xmax:n-.5,ymax:.5,spatialReference:new k.A({wkid:3857})});const b=(0,F.V6)(t,"MRF_META/Rsets"),S=parseInt(b?.getAttribute("scale")||"2",10),x=m.spatialReference,R=new Se.A({origin:new W.A({x:m.xmin,y:m.ymax,spatialReference:x}),blockWidth:f,blockHeight:d,pyramidBlockWidth:f,pyramidBlockHeight:d,compression:a,pyramidScalingFactor:S}),w=new W.A({x:m.width/n,y:m.height/s,spatialReference:x}),I=new se.A({width:n,height:s,extent:m,isPseudoSpatialReference:h,spatialReference:x,bandCount:i,pixelType:l,pixelSize:w,noDataValue:p,storageInfo:R}),M=(0,F.mX)(t,"datafile"),O=(0,F.mX)(t,"IndexFile");return{rasterInfo:I,files:{mrf:this.url,index:O||this.url.replace(".mrf",".idx"),data:M||this.url.replace(".mrf",H.get(a).blobExtension)}}}_fetchAuxiliaryData(t){var e=this;return(0,C.A)(function*(){try{const{data:r}=yield e.request(e.url+".aux.xml",{responseType:"xml",signal:t?.signal});return Ie(r)}catch{return null}})()}};(0,T._)([(0,N.MZ)()],q.prototype,"_files",void 0),(0,T._)([(0,N.MZ)()],q.prototype,"_storageIndex",void 0),(0,T._)([(0,N.MZ)({type:String,json:{write:!0}})],q.prototype,"datasetFormat",void 0),q=(0,T._)([(0,V.$)("esri.layers.support.rasterDatasets.MRFRaster")],q);const Tt=q;var Ee=y(38497);function wt(t){const e=t.fields,r=t.records,n=e.some(c=>"oid"===c.name.toLowerCase())?"OBJECTID":"OID",s=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(e.map(c=>({name:c.name,type:"esriFieldType"+c.typeName,alias:c.name}))),i=s.map(c=>c.name),a=[];let o=0,l=0;return r.forEach(c=>{const f={};for(f[n]=o++,l=1;l<i.length;l++)f[i[l]]=c[l-1];a.push({attributes:f})}),{displayFieldName:"",fields:s,features:a}}class bt{static get supportedVersions(){return[5]}static parse(e){const r=new DataView(e),n=3&r.getUint8(0);if(3!==n)return{header:{version:n},recordSet:null};const s=r.getUint32(4,!0),i=r.getUint16(8,!0),a=r.getUint16(10,!0),o={version:n,recordCount:s,headerByteCount:i,recordByteCount:a};let l=32;const c=[],f=[];let d;if(3===n){for(;13!==r.getUint8(l);)d=String.fromCharCode(r.getUint8(l+11)).trim(),c.push({name:(0,Ee.w)(new Uint8Array(e,l,11)),type:d,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(d)],length:r.getUint8(l+16)}),l+=32;if(l+=1,c.length>0)for(;f.length<s&&e.byteLength-l>a;){const u=[];32===r.getUint8(l)?(l+=1,c.forEach(p=>{if("C"===p.type)u.push((0,Ee.w)(new Uint8Array(e,l,p.length)).trim());else if("N"===p.type)u.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,p.length)).trim(),10));else if("F"===p.type)u.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,p.length)).trim()));else if("D"===p.type){const g=String.fromCharCode.apply(null,new Uint8Array(e,l,p.length)).trim();u.push(new Date(parseInt(g.slice(0,4),10),parseInt(g.slice(4,6),10)-1,parseInt(g.slice(6,8),10)))}l+=p.length}),f.push(u)):l+=a}}return{header:o,fields:c,records:f,recordSet:wt({fields:c,records:f})}}}var Z=y(59520),ue=y(77835);const Ae=(t,e)=>t.get(e)?.values,re=(t,e)=>t.get(e)?.values?.[0];let $=class extends Y.A{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}fetchRawTile(t,e,r,n={}){var s=this;return(0,C.A)(function*(){if(!s._headerInfo?.isSupported||s.isBlockOutside(t,e,r))return null;const i=yield s._fetchRawTiffTile(t,e,r,!1,n);if(null!=i&&s._headerInfo.hasMaskBand){const a=yield s._fetchRawTiffTile(t,e,r,!0,n);null!=a&&a.pixels[0]instanceof Uint8Array&&(i.mask=a.pixels[0])}return i})()}_open(t){var e=this;return(0,C.A)(function*(){const r=t?t.signal:null,{data:n}=yield e.request(e.url,{range:{from:0,to:e._bufferSize},responseType:"array-buffer",signal:r});if(!n)throw new P.A("tiffraster:open","failed to open url "+e.url);e.datasetName=e.url.slice(e.url.lastIndexOf("/")+1,e.url.lastIndexOf("."));const{littleEndian:s,firstIFDPos:i,isBigTiff:a}=(0,Z.uT)(n),o=[];yield e._readIFDs(o,n,s,i,0,a?8:4,r);const{imageInfo:l,rasterInfo:c}=function Mt(t){const e=(0,Z.uc)(t),{width:r,height:n,tileWidth:s,tileHeight:i,planes:a,pixelType:o,compression:l,firstPyramidLevel:c,maximumPyramidLevel:f,pyramidBlockWidth:d,pyramidBlockHeight:u,pyramidResolutions:p,tileBoundary:g,affine:v,metadata:A}=e;let h=ae(e.extent.spatialReference?.wkt||e.extent.spatialReference?.wkid),b=!!e.isPseudoGeographic;null==h&&(b=!0,h=new k.A({wkid:3857}));const S=new j.A({...e.extent,spatialReference:h}),x=new W.A(S?{x:S.xmin,y:S.ymax,spatialReference:h}:{x:0,y:0}),R=new Se.A({blockWidth:s,blockHeight:i,pyramidBlockWidth:d,pyramidBlockHeight:u,compression:l,origin:x,firstPyramidLevel:c,maximumPyramidLevel:f,pyramidResolutions:p,blockBoundary:g}),w=new W.A({x:(S.xmax-S.xmin)/r,y:(S.ymax-S.ymin)/n,spatialReference:h}),I=A?{BandProperties:A.bandProperties,DataType:A.dataType}:{};let M=null;const O=re(t[0],"PHOTOMETRICINTERPRETATION"),B=Ae(t[0],"COLORMAP");if(O<=3&&B?.length>3&&B.length%3==0){M=[];const L=B.length/3;for(let U=0;U<L;U++)M.push([U,B[U]>>>8,B[U+L]>>>8,B[U+2*L]>>>8])}const E=new se.A({width:r,height:n,bandCount:a,pixelType:o,pixelSize:w,storageInfo:R,spatialReference:h,isPseudoSpatialReference:b,keyProperties:I,extent:S,colormap:M,statistics:A?A.statistics:null});if(v?.length&&(E.nativeExtent=new j.A({xmin:-.5,ymin:.5-n,xmax:r-.5,ymax:.5,spatialReference:h}),E.transform=new ve.A({polynomialOrder:1,forwardCoefficients:[v[2]+v[0]/2,v[5]-v[3]/2,v[0],v[3],-v[1],-v[4]]}),E.extent=E.transform.forwardTransform(E.nativeExtent),E.pixelSize=new W.A({x:(S.xmax-S.xmin)/r,y:(S.ymax-S.ymin)/n,spatialReference:h}),R.origin.x=-.5,R.origin.y=.5),p){const{x:L,y:U}=E.pixelSize;p.forEach(X=>{X.x*=L,X.y*=U})}return{imageInfo:e,rasterInfo:E}}(o),f=(0,Z.zS)(o),d=(0,Z.r9)(o);if(e._headerInfo={littleEndian:s,isBigTiff:a,ifds:o,pyramidIFDs:f,maskIFDs:d,...l},e._set("rasterInfo",c),!l.isSupported)throw new P.A("tiffraster:open","this tiff is not supported: "+l.message);if(!l.tileWidth)throw new P.A("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");c.isPseudoSpatialReference&&de.A.getLogger(e).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.");const u=o[0].get("PREDICTOR")?.values?.[0];if(3===o[0].get("SAMPLEFORMAT")?.values?.[0]&&2===u)throw new P.A("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floating point data");const{skipMapInfo:g,skipExtensions:v=[]}=e.ioConfig;if(!v.includes("aux.xml")&&!g){const A=yield e._fetchAuxiliaryMetaData(t);null!=A&&function Ct(t,e){if(e.statistics=t.statistics??e.statistics,e.histograms=t.histograms,t.histograms&&null==e.statistics&&(e.statistics=(0,K.Pg)(t.histograms)),t.transform&&null==e.transform){e.transform=t.transform,e.nativeExtent=e.extent;const r=e.transform.forwardTransform(e.nativeExtent);e.pixelSize=new W.A({x:(r.xmax-r.xmin)/e.width,y:(r.ymax-r.ymin)/e.height,spatialReference:e.spatialReference}),e.extent=r}e.isPseudoSpatialReference&&t.spatialReference&&(e.spatialReference=t.spatialReference,e.extent.spatialReference=e.nativeExtent.spatialReference=e.storageInfo.origin.spatialReference=e.spatialReference)}(A,c)}v.includes("vat.dbf")||1!==c.bandCount||"u8"!==c.pixelType||g||(c.attributeTable=yield e._fetchAuxiliaryTable(t),null!=c.attributeTable&&(c.keyProperties.DataType="thematic")),g&&e.updateImageSpaceRasterInfo(c),e.updateTileInfo()})()}_readIFDs(t,e,r,n,s,i=4,a){var o=this;return(0,C.A)(function*(){if(!n)return null;(n>=e.byteLength||n<0)&&(e=(yield o.request(o.url,{range:{from:n+s,to:n+s+o._bufferSize},responseType:"array-buffer",signal:a})).data,s=n+s,n=0);const l=yield o._readIFD(e,r,n,s,ue.A.tiffTags,i,a);if(t.push(l.ifd),!l.nextIFD)return null;yield o._readIFDs(t,e,r,l.nextIFD-s,s,i,a)})()}_readIFD(t,e,r,n,s=ue.A.tiffTags,i=4,a){var o=this;return(0,C.A)(function*(){if(!t)return null;const l=(0,Z.JM)(t,e,r,n,s,i);if(l.success){const c=[];if(l.ifd?.forEach(f=>{f.values||c.push(f)}),c.length>0){const f=c.map(u=>u.offlineOffsetSize).filter(ge.Ru),d=Math.min.apply(null,f.map(u=>u[0]));if(Math.min.apply(null,f.map(u=>u[0]+u[1]))-d<=o._bufferSize){const{data:u}=yield o.request(o.url,{range:{from:d,to:d+o._bufferSize},responseType:"array-buffer",signal:a});t=u,n=d,c.forEach(p=>(0,Z.Cr)(t,e,p,n))}}if(l.ifd?.has("GEOKEYDIRECTORY")){const f=l.ifd.get("GEOKEYDIRECTORY"),d=f?.values;if(d&&d.length>4){const u=d[0]+"."+d[1]+"."+d[2],p=yield o._readIFD(t,e,f.valueOffset+6-n,n,ue.A.geoKeys,2,a);f.data=p.ifd,f.data&&f.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[u]})}}return l}return l.requiredBufferSize&&l.requiredBufferSize!==t.byteLength?(t=(yield o.request(o.url,{range:{from:n,to:n+l.requiredBufferSize+4},responseType:"array-buffer",signal:a})).data).byteLength<l.requiredBufferSize?null:o._readIFD(t,e,0,n,ue.A.tiffTags,4,a):void 0})()}_fetchRawTiffTile(t,e,r,n,s={}){var i=this;return(0,C.A)(function*(){const a=i._getTileLocation(t,e,r,n);if(!a)return null;const{ranges:o,actualTileWidth:l,actualTileHeight:c,ifd:f}=a,d=o.map(w=>i.request(i.url,{range:w,responseType:"array-buffer",signal:s.signal})),u=yield Promise.all(d),p=u.map(w=>w.data.byteLength).reduce((w,I)=>w+I),g=1===u.length?u[0].data:new ArrayBuffer(p),v=[0],A=[0];if(u.length>1){const w=new Uint8Array(g);for(let I=0,M=0;I<u.length;I++){const O=u[I].data;w.set(new Uint8Array(O),M),v[I]=M,M+=O.byteLength,A[I]=O.byteLength}}const{blockWidth:m,blockHeight:h}=i.getBlockWidthHeight(t),b=yield i.decodePixelBlock(g,{format:"tiff",customOptions:{headerInfo:i._headerInfo,ifd:f,offsets:v,sizes:A},width:m,height:h,planes:null,pixelType:null});if(null==b)return null;let S,x,R;if(l!==m||c!==h){let w=b.mask;if(w)for(S=0;S<h;S++)if(R=S*m,S<c)for(x=l;x<m;x++)w[R+x]=0;else for(x=0;x<m;x++)w[R+x]=0;else for(w=new Uint8Array(m*h),b.mask=w,S=0;S<c;S++)for(R=S*m,x=0;x<l;x++)w[R+x]=1}return b})()}_getTileLocation(t,e,r,n=!1){const{firstPyramidLevel:s,blockBoundary:i}=this.rasterInfo.storageInfo,a=0===t?0:t-(s-1),{_headerInfo:o}=this;if(!o)return null;const l=n?o.maskIFDs[a]:0===a?o?.ifds[0]:o?.pyramidIFDs[a-1];if(!l)return null;const c=(0,Z.XO)(l,o),f=Ae(l,"TILEOFFSETS");if(void 0===f)return null;const d=Ae(l,"TILEBYTECOUNTS"),{minRow:u,minCol:p,maxRow:g,maxCol:v}=i[a];if(e>g||r>v||e<u||r<p)return null;const A=re(l,"IMAGEWIDTH"),m=re(l,"IMAGELENGTH"),h=re(l,"TILEWIDTH"),b=re(l,"TILELENGTH"),S=[];if(c){const{bandCount:x}=this.rasterInfo;for(let R=0;R<x;R++){const w=R*(g+1)*(v+1)+e*(v+1)+r;S[R]={from:f[w],to:f[w]+d[w]-1}}}else{const x=e*(v+1)+r;S.push({from:f[x],to:f[x]+d[x]-1})}for(let x=0;x<S.length;x++)if(null==S[x].from||!S[x].to||S[x].to<0)return null;return{ranges:S,ifd:l,actualTileWidth:r===v&&A%h||h,actualTileHeight:e===g&&m%b||b}}_fetchAuxiliaryMetaData(t){var e=this;return(0,C.A)(function*(){try{const{data:r}=yield e.request(e.url+".aux.xml",{responseType:"xml",signal:t?.signal});return Ie(r)}catch{return null}})()}_fetchAuxiliaryTable(t){var e=this;return(0,C.A)(function*(){try{const{data:r}=yield e.request(e.url+".vat.dbf",{responseType:"array-buffer",signal:t?.signal}),n=bt.parse(r);return n?.recordSet?Oe.A.fromJSON(n.recordSet):null}catch{return null}})()}};(0,T._)([(0,N.MZ)()],$.prototype,"_files",void 0),(0,T._)([(0,N.MZ)()],$.prototype,"_headerInfo",void 0),(0,T._)([(0,N.MZ)()],$.prototype,"_bufferSize",void 0),(0,T._)([(0,N.MZ)({type:String,json:{write:!0}})],$.prototype,"datasetFormat",void 0),$=(0,T._)([(0,V.$)("esri.layers.support.rasterDatasets.TIFFRaster")],$);const Ft=$,J=new Map;J.set("MRF",{desc:"Meta Raster Format",constructor:Tt}),J.set("TIFF",{desc:"GeoTIFF",constructor:Ft}),J.set("RasterTileServer",{desc:"Raster Tile Server",constructor:St}),J.set("JPG",{desc:"JPG Raster Format",constructor:oe}),J.set("PNG",{desc:"PNG Raster Format",constructor:oe}),J.set("GIF",{desc:"GIF Raster Format",constructor:oe}),J.set("BMP",{desc:"BMP Raster Format",constructor:oe}),J.set("CovJSON",{desc:"COVJSON Raster Format",constructor:ct}),J.set("MEMORY",{desc:"In Memory Raster Format",constructor:ye});class Re{static get supportedFormats(){const e=new Set;return J.forEach((r,n)=>e.add(n)),e}static open(e){var r=this;return(0,C.A)(function*(){const{url:n,ioConfig:s,source:i,sourceJSON:a}=e;let o=e.datasetFormat??s?.datasetFormat;null==o&&(n.includes(".")?o=n.slice(n.lastIndexOf(".")+1).toUpperCase():"coverage"===i?.type?.toLowerCase()?o="CovJSON":i?.extent&&i.pixelblocks&&(o="MEMORY")),"OVR"===o||"TIF"===o?o="TIFF":"JPG"===o||"JPEG"===o||"JFIF"===o?o="JPG":"COVJSON"===o&&(o="CovJSON"),n.toLowerCase().includes("/imageserver")&&!n.toLowerCase().includes("/wcsserver")&&(o="RasterTileServer");const l={url:n,source:i,sourceJSON:a,datasetFormat:o,ioConfig:s??{bandIds:null,sampling:null}};if(Object.keys(l).forEach(u=>{null==l[u]&&delete l[u]}),o){if(!r.supportedFormats.has(o))throw new P.A("rasterfactory:open","not a supported format "+o);if("CRF"===o)throw new P.A("rasterfactory:open",`cannot open raster: ${n}`);const u=new(J.get(o).constructor)(l);return yield u.open({signal:e.signal}),u}const c=Array.from(J.keys()).filter(u=>"CovJSON"!==u&&"Memory"!==u);let f=0;const d=()=>{if(o=c[f++],!o||"CRF"===o)return null;const u=new(J.get(o).constructor)(l);return u.open({signal:e.signal}).then(()=>u).catch(()=>d())};return d()})()}static register(e,r,n){J.has(e.toUpperCase())||J.set(e.toUpperCase(),{desc:r,constructor:n})}}var Le=y(90126),Ot=y(41843),ce=y(71655);let D=class extends((0,He.dM)((0,Ke.j)((0,Ze.q)((0,$e.A)((0,Xe.H)((0,Ve.d)((0,We.o)((0,Qe.e)((0,je.b)((0,Ye.J)((0,Je.P)(De.A.ClonableMixin(Ge.A))))))))))))){constructor(...t){var e;super(...t),e=this,this._primaryRasters=[],this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this.source=void 0,this._debouncedSaveOperations=(0,_.sg)(function(){var r=(0,C.A)(function*(n,s,i){const{save:a,saveAs:o}=yield y.e(3518).then(y.bind(y,23518));switch(n){case ce.X.SAVE:return a(e,s);case ce.X.SAVE_AS:return o(e,i,s)}});return function(n,s,i){return r.apply(this,arguments)}}())}normalizeCtorArgs(t,e){return"string"==typeof t?{url:t,...e}:t}load(t){const e=null!=t?t.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},t).catch(_.QP).then(()=>this._openRaster(e))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){const t=[(0,G.rZ)("Pixel Value"),(0,G.dy)("Raw Pixel Value")],e=this.raster?.rasterInfo??this.serviceRasterInfo,r=e?.attributeTable;if(r){const i=(0,G.jC)(r);t.push(...i)}const n=e?.dataType,s=e?.multidimensionalInfo;if(("vector-magdir"===n||"vector-uv"===n)&&null!=s){const i=s.variables[0].unit?.trim(),a=(0,G.DV)(i),o=(0,G.y6)();t.push(a,o)}if(s){const i=(0,G.AL)(s);t.push(...i)}return t}createPopupTemplate(t){const{rasterFields:e}=this,r=t?.visibleFieldNames??new Set(e.map(({name:i})=>i).filter(i=>i!==G.F_.rawServicePixelValue)),n=(0,Ot.tn)({fields:e,title:this.title},{...t,visibleFieldNames:r}),{rasterInfo:s}=this.raster;return n?.fieldInfos&&s&&(0,G.h4)(n.fieldInfos,s),n}generateRasterInfo(t,e){var r=this;return(0,C.A)(function*(){if(t=(0,Ue.PZ)(Me.A,t),yield r.load(),!t||"none"===t.functionName?.toLowerCase())return r.serviceRasterInfo;try{const{rasterInfo:n}=yield r._openFunctionRaster(t,e);return n}catch(n){throw n instanceof P.A?n:new P.A("imagery-tile-layer","the given raster function is not supported")}})()}save(t){var e=this;return(0,C.A)(function*(){return e._debouncedSaveOperations(ce.X.SAVE,t)})()}saveAs(t,e){var r=this;return(0,C.A)(function*(){return r._debouncedSaveOperations(ce.X.SAVE_AS,e,t)})()}write(t,e){const r=this._primaryRasters[0]??this.raster;return(this.loaded?"RasterTileServer"===r.datasetFormat&&("Raster"===r.tileType||"Map"===r.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))?super.write(t,e):(e?.messages&&e.messages.push(new P.A("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e.origin}/${e.layerContainerType||"operational-layers"}'`,{layer:this})),null)}_openRaster(t){var e=this;return(0,C.A)(function*(){let r=!1;if(e.raster)yield e._openFromRaster(e.raster,t),r="Function"===e.raster.datasetFormat,!r&&e.rasterFunction&&(e._primaryRasters=[e.raster],yield e._initializeWithFunctionRaster(e.rasterFunction));else{const{url:s,rasterFunction:i,source:a}=e;if(!s&&!a)throw new P.A("imagery-tile-layer:open","missing url or source parameter");a?yield e._openFromSource(a,t):i?yield e._openFromUrlWithRasterFunction(s,i,t):yield e._openFromUrl(s,t)}const n=e.raster.rasterInfo;if(!n)throw new P.A("imagery-tile-layer:load","cannot load resources on "+e.url);if(e._set("serviceRasterInfo",r?n:e._primaryRasters[0].rasterInfo),e._set("spatialReference",n.spatialReference),e.sourceJSON=e.sourceJSON||e.raster.sourceJSON,null!=e.sourceJSON){const s="Map"===e.raster.tileType&&null!=e.sourceJSON.minLOD&&null!=e.sourceJSON.maxLOD?e.sourceJSON:{...e.sourceJSON,minScale:0,maxScale:0};e.read(s,{origin:"service"})}else e.read({tileInfo:e.serviceRasterInfo?.storageInfo.tileInfo.toJSON()},{origin:"service"});e.title||(e.title=e.raster.datasetName),"Map"===e.raster.tileType&&(e.popupEnabled=!1),e._configDefaultSettings(),e.addHandles((0,ke.wB)(()=>e.customParameters,s=>{e.raster&&(e.raster.ioConfig.customFetchParameters=s)}))})()}_openFromRaster(t,e){var r=this;return(0,C.A)(function*(){t.rasterInfo||(yield t.open({signal:e})),r._primaryRasters="Function"===t.datasetFormat?t.primaryRasters.rasters:[t],r.url||(r.url=r._primaryRasters[0].url)})()}_openFromUrlWithRasterFunction(t,e,r){var n=this;return(0,C.A)(function*(){const s=[t];e&&(0,Le.UD)(e.toJSON(),s);const i=yield Promise.all(s.map(o=>Re.open({url:o,sourceJSON:n.sourceJSON,ioConfig:{sampling:"closest",...n.ioConfig,customFetchParameters:n.customParameters},signal:r}))),a=i.findIndex(o=>null==o);if(a>-1)throw new P.A("imagery-tile-layer:open",`cannot open raster: ${s[a]}`);return n._primaryRasters=i,n._initializeWithFunctionRaster(e)})()}_openFromUrl(t,e){var r=this;return(0,C.A)(function*(){const n=yield Re.open({url:t,sourceJSON:r.sourceJSON,ioConfig:{sampling:"closest",...r.ioConfig,customFetchParameters:r.customParameters},signal:e});if(null==n)throw new P.A("imagery-tile-layer:open",`cannot open raster: ${t}`);r._primaryRasters=[n],r.raster=n})()}_openFromSource(t,e){var r=this;return(0,C.A)(function*(){const n="the tiled imagery data source is not supported",s="coverage"===t.type?.toLowerCase()?"CovJSON":t.extent&&t.pixelBlock?"MEMORY":null;if(!s)throw new P.A("imagery-tile-layer:open",n);"MEMORY"===s&&(t={...t,pixelBlock:void 0,pixelBlocks:[t.pixelBlock]});const i=yield Re.open({url:"",source:t,datasetFormat:s,ioConfig:{sampling:"closest",...r.ioConfig,customFetchParameters:r.customParameters},signal:e});if(null==i)throw new P.A("imagery-tile-layer:open",n);r._primaryRasters=[i],r.rasterFunction?yield r._initializeWithFunctionRaster(r.rasterFunction):r.raster=i})()}_openFunctionRaster(t,e){var r=this;return(0,C.A)(function*(){const n={raster:r._primaryRasters[0]};r._primaryRasters.length>1&&r._primaryRasters.forEach(a=>n[a.url]=a);const s=(0,Le.vt)(t.functionDefinition?.toJSON()??t.toJSON(),n),i=new _e.A({rasterFunction:s});return yield i.open(e),i})()}_initializeWithFunctionRaster(t,e){var r=this;return(0,C.A)(function*(){try{r.raster=yield r._openFunctionRaster(t,e)}catch(n){n instanceof P.A&&de.A.getLogger(r).error("imagery-tile-layer:open",n.message),de.A.getLogger(r).warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),r._set("rasterFunction",null),r.raster=r._primaryRasters[0]}})()}};(0,T._)([(0,N.MZ)({clonable:!1})],D.prototype,"_primaryRasters",void 0),(0,T._)([(0,N.MZ)(qe.fV)],D.prototype,"legendEnabled",void 0),(0,T._)([(0,N.MZ)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],D.prototype,"isReference",void 0),(0,T._)([(0,N.MZ)({type:["show","hide"]})],D.prototype,"listMode",void 0),(0,T._)([(0,N.MZ)({json:{read:!0,write:!0}})],D.prototype,"blendMode",void 0),(0,T._)([(0,N.MZ)({type:Me.A,json:{name:"renderingRule",write:!0}})],D.prototype,"rasterFunction",void 0),(0,T._)([(0,N.MZ)()],D.prototype,"sourceJSON",void 0),(0,T._)([(0,N.MZ)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],D.prototype,"version",void 0),(0,T._)([(0,N.MZ)({readOnly:!0,json:{read:!1}})],D.prototype,"type",void 0),(0,T._)([(0,N.MZ)({type:["ArcGISTiledImageServiceLayer"]})],D.prototype,"operationalLayerType",void 0),(0,T._)([(0,N.MZ)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(t,e)=>!e.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer(t,e,r){e[r]=!t}}}})],D.prototype,"popupEnabled",void 0),(0,T._)([(0,N.MZ)({type:Be.A,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],D.prototype,"popupTemplate",void 0),(0,T._)([(0,N.MZ)({readOnly:!0})],D.prototype,"defaultPopupTemplate",null),(0,T._)([(0,N.MZ)({readOnly:!0,type:[be.A]})],D.prototype,"fields",void 0),(0,T._)([(0,N.MZ)({readOnly:!0,type:[be.A]})],D.prototype,"rasterFields",null),(0,T._)([(0,N.MZ)({constructOnly:!0})],D.prototype,"source",void 0),D=(0,T._)([(0,V.$)("esri.layers.ImageryTileLayer")],D);const Pt=D}}]);