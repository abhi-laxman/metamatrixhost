"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[7052],{91255:(Ke,xe,v)=>{v.d(xe,{F:()=>re,a:()=>me,b:()=>_e});var ne=v(65152),B=v(24493),ce=v(41204),oe=v(35089),pe=v(70938),ve=v(43713);class re extends pe.Y{}function _e(){const J=new ve.N5;return J.include(ne.c),J.outputs.add("fragColor","vec4",0),J.fragment.uniforms.add(new oe.N("colorTexture",Z=>Z.color),new oe.N("focusArea",Z=>Z.focusArea),new ce.c("focusAreaEffectMode",Z=>Z.effect??1)).main.add(B.H`float mask = texture( focusArea, uv, 0.0 ).r;
vec4 color = texture( colorTexture, uv, 0.0 );
vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
if (focusAreaEffectMode == 1) {
fragColor = mask > 0.0 ? color : 0.55 * colorDeSaturate + 0.45;
} else {
fragColor = mask > 0.0 ? color : 0.33 * mix(color, colorDeSaturate, 0.);
}`),J}const me=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:re,build:_e},Symbol.toStringTag,{value:"Module"}))},32220:(Ke,xe,v)=>{v.d(xe,{F:()=>J,a:()=>S,b:()=>Z});var ne=v(92771),B=v(62789),ce=v(25866),oe=v(24493),pe=v(50765),ve=v(17806),re=v(40972),_e=v(70938),me=v(43713);class J extends _e.Y{constructor(){super(...arguments),this.origin=ce.uY}}function Z(){const W=new me.N5;return W.attributes.add(re.r.POSITION,"vec3"),W.outputs.add("fragColor","vec4",0),W.vertex.uniforms.add(new pe.F("proj",R=>R.camera.projectionMatrix),new ve.S("view",(R,U)=>(0,ne.Tl)(x,U.camera.viewMatrix,R.origin))).main.add(oe.H`gl_Position = proj * view * vec4(position, 1.0);`),W.fragment.main.add(oe.H`fragColor = vec4(1., 0., 0., 1.);`),W}const x=(0,B.vt)(),S=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:J,build:Z},Symbol.toStringTag,{value:"Module"}))},12895:(Ke,xe,v)=>{v.d(xe,{L:()=>L,b:()=>j});var ne=v(68681),B=v(29359),ce=v(33836),oe=v(14051),pe=v(1012),ve=v(51734),re=v(71781),_e=v(35955),me=v(7741),J=v(94804),Z=v(21130),x=v(18356),S=v(82374),W=v(24493),R=v(50765),U=v(35089),Y=v(40972),M=v(65207),T=v(18597),X=v(43713);function j(Q){const he=new X.N5,{space:k,anchor:G,hasTip:V}=Q,F=k===M.lM.World;he.include(ce.s,Q),he.include(pe.r,Q),he.include(ve.Z,Q);const{vertex:$,fragment:ue}=he;ue.include(_e.W),(0,me.NB)($,Q),he.attributes.add(Y.r.POSITION,"vec3"),he.attributes.add(Y.r.PREVPOSITION,"vec3"),he.attributes.add(Y.r.UV0,"vec2"),he.varyings.add("vColor","vec4"),he.varyings.add("vpos","vec3"),he.varyings.add("vUV","vec2"),he.varyings.add("vSize","float"),V&&he.varyings.add("vLineWidth","float"),$.uniforms.add(new J.E("nearFar",({camera:fe})=>fe.nearFar),new Z.I("viewport",({camera:fe})=>fe.fullViewport)),$.code.add(W.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),$.code.add(W.H`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),F?(he.attributes.add(Y.r.NORMAL,"vec3"),(0,me.S7)($),$.constants.add("tiltThreshold","float",.7),$.code.add(W.H`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):$.code.add(W.H`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`);const te=F?"vec3":"vec2";return $.code.add(W.H`
      ${te} normalizedSegment(${te} pos, ${te} prev) {
        ${te} segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${F?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      ${te} displace(${te} pos, ${te} prev, float displacementLen) {
        ${te} segment = normalizedSegment(pos, prev);

        ${te} displacementDirU = perpendicular(segment);
        ${te} displacementDirV = segment;

        ${G===M.kJ.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),k===M.lM.Screen&&($.uniforms.add(new R.F("inverseProjectionMatrix",({camera:fe})=>fe.inverseProjectionMatrix)),$.code.add(W.H`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),$.code.add(W.H`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),$.uniforms.add(new S.U("perScreenPixelRatio",({camera:fe})=>fe.perScreenPixelRatio)),$.code.add(W.H`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${(0,W.If)(Q.hasCap,"if(prev.z > posLeft.z) {\n                vec2 diff = posLeft.xy - posRight.xy;\n                planeOrigin.xy += perpendicular(diff) / 2.0;\n             }")};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),(0,me.Nz)($),$.main.add(W.H`
    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      float lineWidth = getLineWidth();
      float screenMarkerSize = getScreenMarkerSize();

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      clip(pos, prev);

      ${F?W.H`${(0,W.If)(Q.hideOnShortSegments,W.H`
                if (areWorldMarkersHidden(pos, prev)) {
                  // Project out of clip space
                  gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
                  return;
                }`)}
            pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
            vec4 displacedPosScreen = projectAndScale(pos);`:W.H`
            vec4 posScreen = projectAndScale(pos);
            vec4 prevScreen = projectAndScale(prev);
            vec4 displacedPosScreen = posScreen;

            displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);
            ${(0,W.If)(k===M.lM.Screen,W.H`
                vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));

                // We need three points of the ribbon line in camera space to calculate the plane it lies in
                // Note that we approximate the third point, since we have no information about the join around prev
                vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
                vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);

                pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
                displacedPosScreen = projectAndScale(pos);`)}`}
      forwardViewPosDepth(pos.xyz);
      // Convert back into NDC
      displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

      // Convert texture coordinate into [0,1]
      vUV = (uv0 + 1.0) / 2.0;
      ${(0,W.If)(!F,"vUV *= displacedPosScreen.w;")}
      ${(0,W.If)(V,"vLineWidth = lineWidth;")}

      vSize = screenMarkerSize;
      vColor = getColor();

      // Use camera space for slicing
      vpos = pos.xyz;

      gl_Position = displacedPosScreen;
    }`),he.fragment.include(B.HQ,Q),he.include(T.z,Q),ue.uniforms.add(new x.E("intrinsicColor",fe=>fe.color),new U.N("tex",fe=>fe.markerTexture)),ue.include(re.a),ue.constants.add("texelSize","float",1/ne.vO),ue.code.add(W.H`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgbaTofloat(texture(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),V&&ue.constants.add("relativeMarkerSize","float",ne.Cz/ne.vO).constants.add("relativeTipLineWidth","float",ne.DZ).code.add(W.H`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${(0,W.If)(F,"halfTipLineWidth *= fwidth(samplePos.y);")}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `),he.include(oe.Q,Q),ue.main.add(W.H`
    discardBySlice(vpos);
    discardByTerrainDepth();

    vec4 finalColor = intrinsicColor * vColor;

    // Cancel out perspective correct interpolation if in screen space or draped
    vec2 samplePos = vUV ${(0,W.If)(!F,"* gl_FragCoord.w")};
    finalColor.a *= ${V?"max(markerAlpha(samplePos), tipAlpha(samplePos))":"markerAlpha(samplePos)"};
    outputColorHighlightOID(finalColor, vpos);`),he}const L=Object.freeze(Object.defineProperty({__proto__:null,build:j},Symbol.toStringTag,{value:"Module"}))},94236:(Ke,xe,v)=>{v.d(xe,{N:()=>W,b:()=>S});var ne=v(74567),B=v(29359),ce=v(93877),oe=v(23388),pe=v(14051),ve=v(7741),re=v(18356),_e=v(65840),me=v(24493),J=v(40972),Z=v(43713),x=v(28700);function S(R){const U=new Z.N5,{vertex:Y,fragment:M}=U;return U.include(ce.d,R),U.include(oe.c,R),(0,ve.NB)(Y,R),U.attributes.add(J.r.POSITION,"vec3"),U.varyings.add("vpos","vec3"),Y.main.add(me.H`vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),U.include(pe.Q,R),U.fragment.include(B.HQ,R),M.uniforms.add(new _e.m("alphaCoverage",(T,X)=>Math.min(1,T.width*X.camera.pixelRatio))),R.hasVertexColors||M.uniforms.add(new re.E("constantColor",T=>T.color)),M.main.add(me.H`
    discardBySlice(vpos);

    vec4 color = ${R.hasVertexColors?"vColor":"constantColor"};

    ${R.output===ne.V.ObjectAndLayerIdColor?"color.a = 1.0;":""}

    if (color.a < ${me.H.float(x.Q)}) {
      discard;
    }

    ${(0,ne.RN)(R.output)?me.H`fragColor = applySlice(color, vpos);`:""}
    calculateOcclusionAndOutputHighlight();
  `),U}const W=Object.freeze(Object.defineProperty({__proto__:null,build:S},Symbol.toStringTag,{value:"Module"}))},20482:(Ke,xe,v)=>{v.d(xe,{P:()=>k,b:()=>he});var ne=v(18238),B=v(74567),ce=v(29359),oe=v(93877),pe=v(70094),ve=v(62393),re=v(78689),_e=v(14051),me=v(96537),J=v(6413),Z=v(44987),x=v(6698),S=v(26742),W=v(9933),R=v(55189),U=v(51734),Y=v(71781),M=v(7741),T=v(88791),X=v(65840),j=v(24493),L=v(18597),Q=v(43713);function he(G){const V=new Q.N5,{vertex:F,fragment:$}=V;(0,M.NB)(F,G),V.varyings.add("vpos","vec3"),V.include(ve.H,G);const{output:ue,spherical:te,pbrMode:fe,receiveShadows:Re}=G,D=(0,B.RN)(ue);switch((D||ue===B.V.ObjectAndLayerIdColor)&&(V.include(oe.d,G),V.include(R.Bz,G),V.include(ne.oD,G),V.include(pe.g,G),V.include(U.Z,G),V.varyings.add("vnormal","vec3"),V.varyings.add("vcolor","vec4"),F.main.add(j.H`
      vpos = calculateVPos();
      vnormal = normalize(localNormal());
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);

      gl_Position = transformPosition(proj, view, vpos);

      ${D?"forwardLinearDepth();":""}
      forwardObjectAndLayerIdColor();

      vcolor = getColor();`)),ue){case B.V.ColorEmission:case B.V.Color:V.include(W._Z,G),V.include(J.kA,G),V.include(me.n,G),V.include(R.Bz,G),V.include(x.r,G),V.fragment.include(ce.HQ,G),V.include(L.z,G),(0,M.yu)($,G),(0,J.a8)($),(0,J.eU)($),$.uniforms.add(F.uniforms.get("localOrigin"),new T.t("ambient",gt=>gt.ambient),new T.t("diffuse",gt=>gt.diffuse),new T.t("specular",gt=>gt.specular),new X.m("opacity",gt=>gt.opacity)),$.include(Y.a),(0,Z.O4)($),$.main.add(j.H`
        discardBySlice(vpos);
        discardByTerrainDepth();

        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        vec3 posWorld = vpos + localOrigin;
        vec3 normalGround = ${te?"normalize(posWorld);":"vec3(0.0, 0.0, 1.0);"}

        float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        float shadow = ${Re?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth));":te?"lightingGlobalFactor * (1.0 - additionalAmbientScale);":"0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        ${(0,j.If)(fe===W.A9.Schematic,"float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];\n           vec4 emission = getEmissions();")}

        vec3 shadedColor = ${fe===W.A9.Schematic?"evaluateSceneLightingPBR(normal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);":"evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);"}
        vec4 finalColor = vec4(shadedColor, combinedOpacity);
        outputColorHighlightOID(finalColor, vpos);`);break;case B.V.Depth:V.include(oe.d,G),F.main.add(j.H`vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);`),V.fragment.include(ce.HQ,G),$.main.add(j.H`discardBySlice(vpos);`);break;case B.V.Shadow:case B.V.ShadowHighlight:case B.V.ShadowExcludeHighlight:case B.V.ViewshedShadow:V.include(oe.d,G),(0,ne.xJ)(V),V.varyings.add("depth","float"),F.main.add(j.H`vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);`),V.fragment.include(ce.HQ,G),V.include(re.L,G),$.main.add(j.H`discardBySlice(vpos);
outputDepth(depth);`);break;case B.V.ObjectAndLayerIdColor:V.fragment.include(ce.HQ,G),$.main.add(j.H`discardBySlice(vpos);
outputObjectAndLayerIdColor();`);break;case B.V.Normal:V.include(oe.d,G),V.include(S.n,G),(0,M.S7)(F),V.varyings.add("vnormal","vec3"),F.main.add(j.H`vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);`),V.fragment.include(ce.HQ,G),$.main.add(j.H`discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case B.V.Highlight:V.include(oe.d,G),V.include(S.n,G),V.varyings.add("vnormal","vec3"),F.main.add(j.H`vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);`),V.fragment.include(ce.HQ,G),V.include(_e.Q,G),$.main.add(j.H`discardBySlice(vpos);
calculateOcclusionAndOutputHighlight();`)}return V}const k=Object.freeze(Object.defineProperty({__proto__:null,build:he},Symbol.toStringTag,{value:"Module"}))},97665:(Ke,xe,v)=>{v.d(xe,{P:()=>he,b:()=>L});var ne=v(74567),B=v(29359),ce=v(93877),oe=v(70094),pe=v(23388),ve=v(51734),re=v(33605),_e=v(71781),me=v(7741),J=v(18356),Z=v(82374),x=v(24493),S=v(40972),W=v(81671),R=v(18597),U=v(43713);const Y=.70710678118,M=Y,T=.08715574274,X=10,j=1;function L(k){const G=new U.N5,{vertex:V,fragment:F,attributes:$,varyings:ue}=G,te=k.output===ne.V.Highlight;(0,me.NB)(V,k),G.include(ce.d,k),G.include(pe.c,k),G.include(re.A,k),G.include(oe.g,k),G.fragment.include(B.HQ,k),G.include(R.z,k),G.include(ve.Z,k),k.draped?V.uniforms.add(new Z.U("worldToScreenRatio",Re=>1/Re.screenToPCSRatio)):$.add(S.r.BOUNDINGRECT,"mat3"),$.add(S.r.POSITION,"vec3"),$.add(S.r.UVMAPSPACE,"vec4"),k.vvColor&&$.add(S.r.COLORFEATUREATTRIBUTE,"float"),k.hasVertexColors||ue.add("vColor","vec4"),ue.add("vpos","vec3"),ue.add("vuv","vec2"),V.uniforms.add(new J.E("uColor",Re=>Re.color));const fe=k.style===W.O.ForwardDiagonal||k.style===W.O.BackwardDiagonal||k.style===W.O.DiagonalCross;return fe&&V.code.add(x.H`
      const mat2 rotate45 = mat2(${x.H.float(Y)}, ${x.H.float(-.70710678118)},
                                 ${x.H.float(M)}, ${x.H.float(Y)});
    `),k.draped||((0,me.yu)(V,k),V.uniforms.add(new Z.U("worldToScreenPerDistanceRatio",Re=>1/Re.camera.perScreenPixelRatio)),V.code.add(x.H`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),V.code.add(x.H`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),V.code.add(x.H`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${x.H.float(T)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),V.code.add(x.H`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${fe?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${fe?" * rotate45":""};

      ${k.draped?"":x.H`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${x.H.float(X)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),V.main.add(x.H`
    vuv = scaledUV();
    vpos = position;
    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    forwardNormalizedVertexColor();
    forwardObjectAndLayerIdColor();
    ${k.hasVertexColors?"vColor *= uColor;":k.vvColor?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
    gl_Position = transformPosition(proj, view, vpos);
  `),F.include(_e.a),k.draped&&F.uniforms.add(new Z.U("texelSize",Re=>1/Re.camera.pixelRatio)),te||(F.code.add(x.H`
      const float lineWidth = ${x.H.float(j)};
      const float spacing = ${x.H.float(X)};
      const float spacingINV = ${x.H.float(1/X)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),k.draped||F.code.add(x.H`const int maxSamples = 5;
float sampleAA(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),F.main.add(x.H`
    discardBySlice(vpos);
    discardByTerrainDepth();
    vec4 color = vColor;
    ${te?"":x.H`color.a *= ${function Q(k){function G(V){return k.draped?x.H`coverage(vuv.${V}, texelSize)`:x.H`sampleAA(vuv.${V})`}switch(k.style){case W.O.ForwardDiagonal:case W.O.Horizontal:return G("y");case W.O.BackwardDiagonal:case W.O.Vertical:return G("x");case W.O.DiagonalCross:case W.O.Cross:return x.H`1.0 - (1.0 - ${G("x")}) * (1.0 - ${G("y")})`;default:return"0.0"}}(k)};`}
    outputColorHighlightOID(color, vpos);
  `),G}const he=Object.freeze(Object.defineProperty({__proto__:null,build:L},Symbol.toStringTag,{value:"Module"}))},18853:(Ke,xe,v)=>{v.d(xe,{W:()=>k,b:()=>he});var ne=v(18238),B=v(74567),ce=v(29359),oe=v(93877),pe=v(70094),ve=v(14051),re=v(74077),_e=v(44987),me=v(26742),J=v(9933),Z=v(55189),x=v(51734),S=v(18693),W=v(4194),R=v(71781),U=v(7741),Y=v(18356),M=v(65840),T=v(24493),X=v(40972),j=v(18597),L=v(43713),Q=v(28700);function he(G){const V=new L.N5,{vertex:F,fragment:$}=V,{output:ue,draped:te,receiveShadows:fe}=G;(0,U.NB)(F,G),V.include(oe.d,G),V.attributes.add(X.r.POSITION,"vec3"),V.attributes.add(X.r.UV0,"vec2");const Re=new Y.E("waterColor",D=>D.color);if((0,B.RN)(ue)&&te)return V.varyings.add("vpos","vec3"),F.uniforms.add(Re),F.main.add(T.H`
      if (waterColor.a < ${T.H.float(Q.Q)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      vpos = position;
      gl_Position = transformPosition(proj, view, vpos);`),$.uniforms.add(Re),$.main.add(T.H`fragColor = waterColor;`),V;switch((0,B.RN)(ue)&&(V.include(me.n,G),V.include(ne.oD,G),V.varyings.add("vuv","vec2"),V.varyings.add("vpos","vec3"),V.varyings.add("vnormal","vec3"),V.varyings.add("vtbnMatrix","mat3"),F.uniforms.add(Re),F.main.add(T.H`
      if (waterColor.a < ${T.H.float(Q.Q)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      vuv = uv0;
      vpos = position;

      vnormal = getLocalUp(vpos, localOrigin);
      vtbnMatrix = getTBNMatrix(vnormal);
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);

      gl_Position = transformPosition(proj, view, vpos);
      forwardLinearDepth();`)),V.include(x.Z,G),G.output){case B.V.Color:case B.V.ColorEmission:V.include(re.W,{pbrMode:J.A9.Disabled,lightingSphericalHarmonicsOrder:2}),V.include(W.V),V.include(Z.Bz,G),V.include(S.E,G),V.fragment.include(ce.HQ,G),V.include(j.z,G),$.include(R.a),(0,U.yu)($,G),(0,_e.Gc)($),(0,_e.O4)($),$.uniforms.add(Re,new M.m("timeElapsed",({timeElapsed:D})=>D),F.uniforms.get("view"),F.uniforms.get("localOrigin")).main.add(T.H`
        discardBySlice(vpos);
        discardByTerrainDepth();
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${fe?T.H`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        fragColor = delinearizeGamma(final);
        outputColorHighlightOID(fragColor, vpos);`);break;case B.V.Normal:V.include(me.n,G),V.include(W.V,G),V.fragment.include(ce.HQ,G),V.varyings.add("vpos","vec3"),V.varyings.add("vuv","vec2"),F.uniforms.add(Re),F.main.add(T.H`
        if (waterColor.a < ${T.H.float(Q.Q)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        gl_Position = transformPosition(proj, view, vpos);`),$.uniforms.add(new M.m("timeElapsed",({timeElapsed:D})=>D)).main.add(T.H`discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
fragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);`);break;case B.V.Highlight:V.include(ve.Q,G),V.varyings.add("vpos","vec3"),F.uniforms.add(Re),F.main.add(T.H`
        if (waterColor.a < ${T.H.float(Q.Q)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);`),V.fragment.include(ce.HQ,G),$.main.add(T.H`discardBySlice(vpos);
calculateOcclusionAndOutputHighlight();`);break;case B.V.ObjectAndLayerIdColor:V.include(pe.g,G),V.varyings.add("vpos","vec3"),F.uniforms.add(Re),F.main.add(T.H`
        if (waterColor.a < ${T.H.float(Q.Q)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
        forwardObjectAndLayerIdColor();`),V.fragment.include(ce.HQ,G),$.main.add(T.H`discardBySlice(vpos);
outputObjectAndLayerIdColor();`)}return V}const k=Object.freeze(Object.defineProperty({__proto__:null,build:he},Symbol.toStringTag,{value:"Module"}))},63842:(Ke,xe,v)=>{v.d(xe,{$I:()=>T,AU:()=>U,Cr:()=>S,g7:()=>M,i4:()=>x,ui:()=>W,up:()=>j,vt:()=>re,yo:()=>Y});var ne=v(69287),B=v(92771),ce=v(19890),oe=v(14214),pe=v(28714),ve=v(25866);function re(F=j){return[F[0],F[1],F[2],F[3]]}function x(F,$,ue=re()){return(0,pe.c)(ue,F),ue[3]=$,ue}function S(F,$,ue){return(0,pe.e)(ue,F,$),(0,pe.n)(ue,ue),ue[3]=-(0,pe.r)(F,$),ue}function W(F,$=re()){const ue=(0,B.l)(L,F);return X($,(0,ne.KJ)((0,ce.Xd)($,ue))),$}function R(F,$,ue=re()){return(0,ce.x8)(L,F,T(F)),(0,ce.x8)(Q,$,T($)),(0,ce.lw)(L,Q,L),X(ue,(0,ne.KJ)((0,ce.Xd)(ue,L)))}function U(F,$,ue,te=re()){return x(ve.Cw,F,k),x(ve.JP,$,G),x(ve.Cb,ue,V),R(k,G,k),R(k,V,te),te}function Y(F){return F}function M(F){return F[3]}function T(F){return(0,ne.kU)(F[3])}function X(F,$){return F[3]=$,F}const j=[0,0,1,0],L=(0,oe.vt)(),Q=(0,oe.vt)(),k=(re(),re()),G=re(),V=re()},28693:(Ke,xe,v)=>{function ne(ce,oe,pe){return{objectId:ce,target:oe,distance:pe,type:"vertex"}}function B(ce,oe,pe,ve,re,_e=!1){return{objectId:ce,target:oe,distance:pe,type:"edge",start:ve,end:re,draped:_e}}v.d(xe,{P:()=>B,k:()=>ne})},76926:(Ke,xe,v)=>{v.d(xe,{Fe:()=>S,Km:()=>ve,Nk:()=>J});var ne=v(68677),B=v(32117);function ve(M,T,X,j){if(M)if("CIMTextSymbol"!==M.type){if(X&&M.effects)for(const L of M.effects)me(L,T);if(M.symbolLayers)for(const L of M.symbolLayers){switch(L.type){case"CIMPictureMarker":case"CIMVectorMarker":re(L,T,j);break;case"CIMPictureStroke":case"CIMSolidStroke":case"CIMGradientStroke":!j?.preserveOutlineWidth&&L.width&&(L.width*=T);break;case"CIMPictureFill":L.height&&(L.height*=T),L.offsetX&&(L.offsetX*=T),L.offsetY&&(L.offsetY*=T);break;case"CIMHatchFill":ve(L.lineSymbol,T,!0,{...j,preserveOutlineWidth:!1}),L.offsetX&&(L.offsetX*=T),L.offsetY&&(L.offsetY*=T),L.separation&&(L.separation*=T)}if(L.effects)for(const Q of L.effects)me(Q,T)}}else null!=M.height&&(M.height*=T)}function re(M,T,X){if(M&&(M.markerPlacement&&function _e(M,T){switch((0,B.zr)(M)&&M.offset&&(M.offset*=T),M.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(M.customEndingOffset&&(M.customEndingOffset*=T),M.offsetAlongLine&&(M.offsetAlongLine*=T),M.placementTemplate&&M.placementTemplate.length){const X=M.placementTemplate.map(j=>j*T);M.placementTemplate=X}break;case"CIMMarkerPlacementAlongLineVariableSize":if(M.maxRandomOffset&&(M.maxRandomOffset*=T),M.placementTemplate&&M.placementTemplate.length){const X=M.placementTemplate.map(j=>j*T);M.placementTemplate=X}break;case"CIMMarkerPlacementOnLine":M.startPointOffset&&(M.startPointOffset*=T);break;case"CIMMarkerPlacementAtExtremities":M.offsetAlongLine&&(M.offsetAlongLine*=T);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":M.beginPosition&&(M.beginPosition*=T),M.endPosition&&(M.endPosition*=T);break;case"CIMMarkerPlacementPolygonCenter":M.offsetX&&(M.offsetX*=T),M.offsetY&&(M.offsetY*=T);break;case"CIMMarkerPlacementInsidePolygon":M.offsetX&&(M.offsetX*=T),M.offsetY&&(M.offsetY*=T),M.stepX&&(M.stepX*=T),M.stepY&&(M.stepY*=T)}}(M.markerPlacement,T),M.offsetX&&(M.offsetX*=T),M.offsetY&&(M.offsetY*=T),M.anchorPoint&&"Absolute"===M.anchorPointUnits&&(M.anchorPoint={x:M.anchorPoint.x*T,y:M.anchorPoint.y*T}),M.size=null!=M.size?M.size*T:0,"CIMVectorMarker"===M.type&&M.markerGraphics))for(const j of M.markerGraphics)M.scaleSymbolsProportionally||ve(j.symbol,T,!0,X)}function me(M,T){switch(M.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":M.width&&(M.width*=T);break;case"CIMGeometricEffectBuffer":M.size&&(M.size*=T);break;case"CIMGeometricEffectCut":M.beginCut&&(M.beginCut*=T),M.endCut&&(M.endCut*=T),M.middleCut&&(M.middleCut*=T);break;case"CIMGeometricEffectDashes":if(M.customEndingOffset&&(M.customEndingOffset*=T),M.offsetAlongLine&&(M.offsetAlongLine*=T),M.dashTemplate&&M.dashTemplate.length){const X=M.dashTemplate.map(j=>j*T);M.dashTemplate=X}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":M.length&&(M.length*=T);break;case"CIMGeometricEffectMove":M.offsetX&&(M.offsetX*=T),M.offsetY&&(M.offsetY*=T);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":M.offset&&(M.offset*=T);break;case"CIMGeometricEffectRegularPolygon":M.radius&&(M.radius*=T);break;case"CIMGeometricEffectTaperedPolygon":M.fromWidth&&(M.fromWidth*=T),M.length&&(M.length*=T),M.toWidth&&(M.toWidth*=T);break;case"CIMGeometricEffectWave":M.amplitude&&(M.amplitude*=T),M.period&&(M.period*=T)}}function J(M){const T=[];return Z((0,B.lW)(M),T),T.length?new ne.A((0,B.e6)(T[0])):null}function Z(M,T){if(!M)return;let X;X="CIMTextSymbol"===M.type?M.symbol:M;const j="CIMPolygonSymbol"===M.type;if(X?.symbolLayers)for(const L of X.symbolLayers)if(!(L.colorLocked||j&&((0,B.mA)(L)||(0,B.MM)(L)&&L.markerPlacement&&(0,B.zr)(L.markerPlacement))))switch(L.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":L.tintColor&&x(T,L.tintColor);break;case"CIMVectorMarker":L.markerGraphics?.forEach(Q=>{Z(Q.symbol,T)});break;case"CIMSolidStroke":case"CIMSolidFill":x(T,L.color);break;case"CIMHatchFill":Z(L.lineSymbol,T)}}function x(M,T){for(const X of M)if(X.join(".")===T.join("."))return;M.push(T)}function S(M,T,X){T instanceof ne.A||(T=new ne.A(T));const j=(0,B.lW)(M);j&&W(j,T,X)}function W(M,T,X){if(!M)return;let j;j="CIMTextSymbol"===M.type?M.symbol:M;const L="CIMPolygonSymbol"===j?.type;if(j?.symbolLayers)for(const Q of j.symbolLayers){if(Q.colorLocked)continue;if(L)if(X){const{layersToColor:k}=X;if(((0,B.mA)(Q)||(0,B.MM)(Q)&&Q.markerPlacement&&(0,B.zr)(Q.markerPlacement))&&"fill"===k||(0,B.jn)(Q)&&"outline"===k)continue}else if((0,B.mA)(Q)||(0,B.MM)(Q)&&Q.markerPlacement&&(0,B.zr)(Q.markerPlacement))continue;const he=T.toArray();switch(Q.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":Q.tintColor=he;break;case"CIMVectorMarker":Q.markerGraphics?.forEach(k=>{W(k.symbol,T,X)});break;case"CIMSolidStroke":case"CIMSolidFill":Q.color=he;break;case"CIMHatchFill":W(Q.lineSymbol,T,X)}}}},5895:(Ke,xe,v)=>{v.r(xe),v.d(xe,{make:()=>ch,setSymbolClass:()=>hh});var ne=v(35150),B=v(10467),ce=v(3248),oe=v(5922),pe=v(77806),ve=v(82663),re=v(92405),_e=v(31610),me=v(32954),J=v(92771),Z=v(62789),x=v(28714),S=v(25866),W=v(83675),R=v(2296),U=v(23653),Y=v(83034),M=v(10442),T=v(28693),X=v(33360),j=v(23191),L=v(69307),Q=v(42051),he=v(81605),k=v(90673),G=v(47804),V=v(28067),F=v(55861),$=v(41510),ue=v(56548),te=v(83346),fe=v(98176),Re=v(36884),D=v(40972);function gt(d,i,l){const h=(0,ue.S)(d,(i.length>0?i[0]:d.length/3)-1,l);if(h!==$._.Z){d=d.slice();for(let u=0;u<d.length;u+=3)d[u+h]=d[u+2]}return(0,re.e)(d,i,3)}function li(d){const i=[[D.r.POSITION,new te.n(d.attributeData.position,d.indices,3,!0)]],l=(0,Y.EH)(d.indices.length);return null!=d.attributeData.colorFeature?i.push([D.r.COLORFEATUREATTRIBUTE,new te.n([d.attributeData.colorFeature],l,1,!0)]):d.attributeData.color&&i.push([D.r.COLOR,new te.n(d.attributeData.color,l,4,!0)]),d.attributeData.uvMapSpace&&i.push([D.r.UVMAPSPACE,new te.n(d.attributeData.uvMapSpace,d.indices,4,!0)]),d.attributeData.boundingRect&&i.push([D.r.BOUNDINGRECT,new te.n(d.attributeData.boundingRect,d.indices,9,!0)]),new Re.V(d.material,i,d.mapPositions,fe.X.Mesh,d.attributeData.objectAndLayerIdColor)}function ci(d,i=null){const l=[[D.r.POSITION,new te.n(d.attributeData.position,d.indices,3,!0)],[D.r.UV0,new te.n(d.attributeData.uv0,d.indices,2,!0)]];return new Re.V(d.material,l,d.mapPositions,fe.X.Mesh,i)}function ur(d){switch(d.type){case"extent":if(d instanceof V.A)return F.A.fromExtent(d);break;case"polygon":return d}return null}class Ur{constructor(i,l,c){this.renderData=i,this.layerUid=l,this.graphicUid=c,this.outGeometries=new Array}}var hi=v(96522),Xt=v(45321),di=v(28377),Nr=v(23234),Br=v(37723),ui=v(24425);function Vr(d,i,l,c){const h=(0,Br.oR)(d.rings,!!d.hasZ&&"on-the-ground"!==c.mode,Br.Wq.CCW_IS_HOLE,d.spatialReference),u=(0,U.jh)(h.position.length),p=(0,L.au)(h.position,d.spatialReference,0,u,0,h.position,0,h.position.length/3,i,l,c),f=null!=p;return new dn(h.position,u,fi(h.polygons,h.position,u),mi(h.outlines,h.position,u),f,p)}function pi(d,i){const l=(0,Br.oR)(d.rings,!1,Br.Wq.CCW_IS_HOLE),c=(0,Nr.projectBuffer)(l.position,d.spatialReference,0,l.position,i,0);for(let h=2;h<l.position.length;h+=3)l.position[h]=ui.bi;return{position:l.position,polygons:fi(l.polygons,l.position),outlines:mi(l.outlines,l.position),projectionSuccess:c}}function mi(d,i,l=null){return d.filter(({count:c})=>c>1).map(({index:c,count:h})=>{const u=3*c,p=3*h;return null!=l?new gi(c,h,(0,U.l5)(i,u,p),(0,U.l5)(l,u,p)):new Os(c,h,(0,U.l5)(i,u,p))})}function fi(d,i,l=null){const c=new Array;for(const{index:h,count:u,holeIndices:p,pathLengths:f}of d){if(u<=1)continue;const g=3*h,_=3*u,y=p.map(P=>P-h),b=null!=l?new cn(h,u,(0,U.l5)(i,3*h,3*u),(0,U.l5)(l,g,_),y,f):new hn(h,u,(0,U.l5)(i,3*h,3*u),y,f);c.push(b)}return c}class Os{constructor(i,l,c){this.index=i,this.count=l,this.position=c}}class gi extends Os{constructor(i,l,c,h){super(i,l,c),this.mapPositions=h}}class cn extends gi{constructor(i,l,c,h,u,p){super(i,l,c,h),this.holeIndices=u,this.pathLengths=p}}class hn extends Os{constructor(i,l,c,h,u){super(i,l,c),this.holeIndices=h,this.pathLengths=u}}class dn{constructor(i,l,c,h,u,p){this.position=i,this.mapPositions=l,this.polygons=c,this.outlines=h,this.projectionSuccess=u,this.sampledElevation=p}}var vi=v(34416),De=v(67496),un=v(95162),Cs=v(58390),Qt=v(47756),Jt=v(3781);const pn=["polygon","extent"];function _i(d,i,l,c,h,u){const p=(0,Y.EH)(i.length),f=[[D.r.POSITION,new te.n(c.positions,i,3,!0)],[D.r.NORMALCOMPRESSED,new te.n(c.normals,i,2,!0)],[D.r.COLOR,new te.n(h,p,4,!0)]];return new Re.V(d,f,c.elevation,fe.X.Mesh,u,l)}function yi(d,i,l,c,h,u,p,f,g,_,y,b,P){!function fn(d,i,l,c,h,u,p,f,g,_,y,b,P,E,O,C,A){(0,x.c)(qe,C);{const w=O>0?1:-1;let N=3*l,K=0,z=3*K,H=c,I=3*H;for(let q=0;q<c;++q){const ie=d[N],ee=d[N+1],ae=d[N+2];A&&(qe[0]=ie,qe[1]=ee,qe[2]=ae,(0,x.n)(qe,qe)),f[z+0]=ie,f[z+1]=ee,f[z+2]=ae;const Ue=i[N+0],ye=i[N+1],Ne=i[N+2];g[z+0]=Ue,g[z+1]=ye,g[z+2]=Ne,_[z+0]=-w*qe[0],_[z+1]=-w*qe[1],_[z+2]=-w*qe[2],y[K]=0,f[I+0]=ie+O*qe[0],f[I+1]=ee+O*qe[1],f[I+2]=ae+O*qe[2],g[I+0]=Ue,g[I+1]=ye,g[I+2]=Ne,y[H]=O,z+=3,I+=3,N+=3,K+=1,H+=1}}{let w=3*u,N=0,K=3*E;const z=O<0?Si:Ci,H=O<0?Ci:Si;for(let I=0;I<p;++I)P[N]=h[w+z[0]],P[N+1]=h[w+z[1]],P[N+2]=h[w+z[2]],b[K]=h[w+H[0]]+c,b[K+1]=h[w+H[1]]+c,b[K+2]=h[w+H[2]]+c,N+=3,K+=3,w+=3}}(d,i,c.index,c.count,l,0,l.length/3,h,u,p,f,g,_,2*c.count,y,b,P);{let E=0,O=2*c.count,C=0;const A=c.pathLengths[0];xi(h,u,f,p,E,A,c.count,O,g,C,y),O+=4*A,C+=2*A,E+=A;for(let w=1;w<c.pathLengths.length;++w){const N=c.pathLengths[w];xi(h,u,f,p,E,N,c.count,O,g,C,y),O+=4*N,C+=2*N,E+=N}}}function Gr(d,i,l,c,h,u,p){c[u]=c[p],d[u*=3]=d[p*=3],d[u+1]=d[p+1],d[u+2]=d[p+2],i[u]=i[p],i[u+1]=i[p+1],i[u+2]=i[p+2],l[u]=h[0],l[u+1]=h[1],l[u+2]=h[2]}const pr=(0,S.vt)();function xi(d,i,l,c,h,u,p,f,g,_,y){let b=h,P=h+1,E=h+p,O=h+p+1,C=f,A=f+1,w=f+2*u,N=f+2*u+1;y<0&&(b=h+p+1,O=h);let K=3*_;for(let z=0;z<u;++z)z===u-1&&(P=h,y>0?O=h+p:b=h+p),gn(d,b,P,E,pr),Gr(d,i,c,l,pr,C,b),Gr(d,i,c,l,pr,A,P),Gr(d,i,c,l,pr,w,E),Gr(d,i,c,l,pr,N,O),g[K]=C,g[K+1]=w,g[K+2]=N,g[K+3]=C,g[K+4]=N,g[K+5]=A,K+=6,b++,P++,E++,O++,C+=2,A+=2,w+=2,N+=2}const Ss=(0,S.vt)(),Pi=(0,S.vt)(),bi=(0,S.vt)(),Ei=(0,S.vt)(),Mi=(0,S.vt)();function gn(d,i,l,c,h){i*=3,l*=3,c*=3,(0,x.i)(Ss,d[i++],d[i++],d[i++]),(0,x.i)(Pi,d[l++],d[l++],d[l++]),(0,x.i)(bi,d[c++],d[c++],d[c++]),(0,x.d)(Ei,Pi,Ss),(0,x.d)(Mi,bi,Ss),(0,x.e)(h,Mi,Ei),(0,x.n)(h,h)}const kt=(0,S.vt)();function Oi(d,i,l){const c=d.getMutableAttribute(D.r.POSITION),h=d.getMutableAttribute(D.r.NORMALCOMPRESSED).data,{topVertexStart:u,topVertexCount:p,topFaceStart:f,topFaceCount:g}=i,_=c.data,y=p,b=d.attributes.get(D.r.POSITION).indices,P=f+g,E=u+p,O=(0,U.jh)(3*y);for(let z=0;z<y;++z){const H=3*z;O[H+0]=0,O[H+1]=0,O[H+2]=0}const C=yn,A=xn,w=Pn,N=bn,K=qe;for(let z=f;z<P;++z){const H=3*z;for(let I=0;I<3;++I){const q=b[H+I];N[I]=q;const ie=3*q;(0,x.i)(He,_[ie+0],_[ie+1],_[ie+2]),(0,x.t)(C[I],He,l)}(0,x.a)(A,C[1],C[0]),(0,x.a)(w,C[2],C[0]),(0,x.e)(K,A,w),(0,x.n)(K,K);for(let I=0;I<3;++I){const q=3*(N[I]-u);O[q+0]+=K[0],O[q+1]+=K[1],O[q+2]+=K[2]}}for(let z=u;z<E;++z){const H=3*(z-u),I=O[H+0],q=O[H+1],ie=O[H+2],ee=Math.sqrt(I*I+q*q+ie*ie);(0,Cs.aT)(h,z,I/ee,q/ee,ie/ee)}}const He=(0,S.vt)(),qe=(0,S.vt)(),zr=new L.Uk,Ci=[0,2,1],Si=[0,1,2],yn=[(0,S.vt)(),(0,S.vt)(),(0,S.vt)()],xn=(0,S.vt)(),Pn=(0,S.vt)(),bn=[0,0,0];var et,d;(d=et||(et={}))[d.Main=0]="Main",d[d.Bottom=1]="Bottom";class En{constructor(i,l,c,h){this.positions=i,this.elevation=l,this.normals=c,this.heights=h}}class Mn{constructor(i,l,c,h){this.topVertexStart=i,this.topVertexCount=l,this.topFaceStart=c,this.topFaceCount=h}}var Xe=v(68677),Ts=v(89447),st=v(11432),vt=v(56492),Le=v(67685),On=v(1119),Cn=v(45272),le=v(45475),we=v(89141),Ti=v(16590),Sn=v(48218),As=v(26747),Tn=v(32117),An=v(76926),Rn=v(28831),Dn=v(68021),wn=v(83393),se=v(8189),Ai=v(98877),Ri=v(31178),Wr=v(48900),tt=v(85211),jr=(v(40707),v(76576)),Ln=v(1749),Rs=v(89082),lt=v(10294),Di=v(22057),wt=v(11556),Lt=v(18110),wi=v(91255),Ee=v(41396);class Li extends Lt.w{constructor(i,l){super(i,l,new wt.$(wi.a,()=>v.e(8785).then(v.bind(v,88785))))}initializePipeline(){return(0,Ee.Ey)({colorWrite:Ee.kn})}}let qt=class extends Di.A{constructor(d){super({...d,view:d.focusAreas.view}),this.consumes={required:[lt.hM.COMPOSITE,lt.OG.FOCUSAREA]},this.produces=lt.hM.COMPOSITE,this._passParameters=new wi.F}precompile(){this.techniques.precompile(Li)}render(d){const i=this.techniques.get(Li),l=d.find(({name:y})=>y===lt.hM.COMPOSITE);if(!i.compiled)return this.requestRender(),l;const c=this.bindParameters,h=c.camera,u=h.fullViewport[2],p=h.fullViewport[3],f=d.find(({name:y})=>y===lt.OG.FOCUSAREA),g=this.fboCache.acquire(u,p,this.produces),_=this.renderingContext;return _.gl.clear(_.gl.STENCIL_BUFFER_BIT),_.bindFramebuffer(g.fbo),this._passParameters.color=l.getTexture(),this._passParameters.focusArea=f.getTexture(),this._passParameters.effect=In[this.focusAreas.style],_.bindTechnique(i,c,this._passParameters),_.screen.draw(),g.attachDepth(l.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),g}};var mr;(0,se._)([(0,tt.MZ)()],qt.prototype,"consumes",void 0),(0,se._)([(0,tt.MZ)()],qt.prototype,"produces",void 0),(0,se._)([(0,tt.MZ)({constructOnly:!0})],qt.prototype,"focusAreas",void 0),qt=(0,se._)([(0,jr.$)("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],qt),function(d){d[d.NONE=0]="NONE",d[d.BRIGHT=1]="BRIGHT",d[d.DARK=2]="DARK"}(mr||(mr={}));const In={none:mr.NONE,bright:mr.BRIGHT,dark:mr.DARK};var Un=v(5077),Ii=v(32220),Oe=v(50915);class Ui extends Lt.w{constructor(i,l){super(i,l,new wt.$(Ii.a,()=>v.e(738).then(v.bind(v,40738))))}initializePipeline(){return(0,Ee.Ey)({colorWrite:Ee.kn,depthTest:{func:Oe.MT.LEQUAL}})}}var Nn=v(14253),Bn=v(4728),Vn=v(30614),Gn=v(32788),zn=v(70938);let er=class extends Di.A{constructor(d){super({...d,view:d.focusAreas.view}),this.consumes={required:[lt.OG.FOCUSAREA,lt.hM.TRANSPARENT]},this.produces=lt.OG.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new Ii.F}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(d=>d.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(Ui)}render(d){const i=this.techniques.get(Ui),l=this.bindParameters,c=l.camera,h=c.fullViewport[2],u=c.fullViewport[3],p=this.fboCache.acquire(h,u,lt.OG.FOCUSAREA,Un.N.RGBA);if(!i.compiled||!this._vaos)return this.requestRender(),p;const f=d.find(({name:y})=>y===lt.hM.TRANSPARENT),g=this.renderingContext;p.attachDepth(f.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),g.bindFramebuffer(p.fbo),g.clear(Oe.NV.COLOR|Oe.NV.STENCIL),g.setViewport(0,0,h,u),g.gl.clearStencil(0),g.gl.clear(g.gl.STENCIL_BUFFER_BIT),g.setClearStencil(0);const _=g.bindTechnique(i,l);g.setFaceCullingEnabled(!1),g.setStencilTestEnabled(!0),g.setStencilOpSeparate(Oe.Y7.FRONT,Oe.eA.KEEP,Oe.eA.INCR_WRAP,Oe.eA.KEEP),g.setStencilOpSeparate(Oe.Y7.BACK,Oe.eA.KEEP,Oe.eA.DECR_WRAP,Oe.eA.KEEP),g.setDepthWriteEnabled(!1);for(let y=0;y<this._vaos.length;y++){const b=this._vaos[y],P=this._counts[y];this._maskParameters.origin=this._origins[y],_.bindDraw(l,zn.m,this._maskParameters),g.bindVAO(b),g.setStencilWriteMask(255),g.setStencilFunction(Oe.MT.ALWAYS,0,255),g.setColorMask(!1,!1,!1,!1),g.drawArrays(Oe.WR.TRIANGLES,0,P),g.setStencilWriteMask(0),g.setStencilFunction(Oe.MT.NOTEQUAL,0,255),g.setColorMask(!0,!0,!0,!0),g.drawArrays(Oe.WR.TRIANGLES,0,P)}return p}updateGeometries(){if(!this.view._stage)return;this._vaos.forEach(i=>i.dispose()),this._vaos.length=this._counts.length=this._origins.length=0;const d=this.focusAreas.geometries;for(const i of d){const l=new Array,c=i.indicesBottom;for(let f=0;f<c.length;f++)l.push(i.positions[3*(c[f]-1)]),l.push(i.positions[3*(c[f]-1)+1]),l.push(i.positions[3*(c[f]-1)+2]);const h=i.indicesExtruded;for(let f=0;f<h.length;f++)l.push(i.positions[3*h[f]]),l.push(i.positions[3*h[f]+1]),l.push(i.positions[3*h[f]+2]);const u=new Float32Array(l),p=new Vn.Z(this.renderingContext,Nn.D,new Map([["geometry",Bn.SL]]),new Map([["geometry",Gn.g.createVertex(this.renderingContext,Oe._U.STATIC_DRAW,u)]]));this._vaos.push(p),this._counts.push(c.length+h.length),this._origins.push(i.origin)}this.requestRender()}};(0,se._)([(0,tt.MZ)()],er.prototype,"consumes",void 0),(0,se._)([(0,tt.MZ)()],er.prototype,"produces",void 0),(0,se._)([(0,tt.MZ)({constructOnly:!0})],er.prototype,"focusAreas",void 0),er=(0,se._)([(0,jr.$)("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],er);class Wn{constructor(i,l,c,h,u,p){this.positions=i,this.indicesBottom=l,this.indicesExtruded=c,this.height=h,this.origin=u,this.color=p}}var Ni;!function(d){d[d.NONE=0]="NONE",d[d.BRIGHT=1]="BRIGHT",d[d.DARK=2]="DARK"}(Ni||(Ni={}));const Ut=.32;function Hr(d,i){if(d){if("bright"===i){const l=(d[0]+d[1]+d[2])/3;return[l*Ut+(1-Ut),l*Ut+(1-Ut),l*Ut+(1-Ut),d[3]*Ut]}return"dark"===i?[.42*d[0],.42*d[1],.42*d[2],.42*d[3]]:d}}let Nt=class extends Ai.A{constructor(d){super(d),this.style="dark",this.geometries=new Array,this._areas=new Ri.A,this._elevationContext=new Rs.F}initialize(){this.addHandles([(0,Wr.wB)(()=>this.style,()=>this._updateRenderNodes(),Wr.pc)]),this.addHandles([(0,Wr.wB)(()=>this.activePolygons,()=>this._updateFocusAreaGeometries(),Wr.pc)])}get activePolygons(){const d=new Ri.A;for(const i of this.areas)if(i.enabled)for(const l of i.geometries)d.push(l);return d}add(d){this.areas.add(d),this._updateFocusAreaGeometries()}addMany(d){this.areas.addMany(d),this._updateFocusAreaGeometries()}remove(d){this.areas.remove(d),this._updateFocusAreaGeometries()}removeMany(d){this.areas.removeMany(d),this._updateFocusAreaGeometries()}removeAll(){this.areas.removeAll(),this._updateFocusAreaGeometries()}containsGeometry(d){let i=!0;const l=new Ln.A(d);return i=this.areas.some(c=>!!c.enabled&&!!c?.geometries.length&&c.geometries.some(h=>h.contains(l))),i}get areas(){return this._areas}_updateFocusAreaGeometries(){this._extrudePolygons(),this._updateRenderNodes()}_extrudePolygons(){if(!this.view.renderCoordsHelper)return;this.geometries.length=0;const d=5e6,i=(0,S.vt)(),l=this.view.renderCoordsHelper.viewingMode===j.RT.Global,c=(0,Z.vt)(),h=(0,Z.vt)();l||this.view.renderCoordsHelper.worldUpAtPosition([0,0,0],i);for(const u of this.areas)if(u.enabled)for(const p of u.geometries){const f=(0,k.W$)(p);if(null==f)continue;(0,W.l)(p.spatialReference,[f.x,f.y,0],c,this.view.renderCoordsHelper.spatialReference);const g=(0,x.n)(Fn,[c[12]-0*i[0],c[13]-0*i[1],c[14]-0*i[2]]);h[12]=-c[12],h[13]=-c[13],h[14]=-c[14];const _=Vr(p,this.view.elevationProvider,this.view.renderCoordsHelper,this._elevationContext),{polygons:y,mapPositions:b,position:P}=_;for(const E of y){const O=E.count,C=(0,re.e)(E.mapPositions,E.holeIndices,3);if(0===C.length)continue;const A=C.length,w=6*O,N=(0,Y.my)(w+A),K=(0,Y.my)(A),z=(0,U.jh)(3*w),H=(0,U.jh)(3*w);yi(P,b,C,E,z,(0,U.jh)(3*w),H,(0,U.jh)(w),N,K,d,i,l),(0,M.t)(z,z,h);const ie=new Wn(z,K,N,d,[c[12]+0*g[0],c[13]+0*g[1],c[14]+0*g[2]],u.outline?.color);this.geometries.push(ie)}}this._maskRenderNode?.updateGeometries()}_updateRenderNodes(){this.view._stage&&("none"===this.style||0===this.geometries.length?(this._maskRenderNode=(0,st.pR)(this._maskRenderNode),this._colorRenderNode=(0,st.pR)(this._colorRenderNode)):(this._maskRenderNode??=new er({focusAreas:this}),this._colorRenderNode??=new qt({focusAreas:this})))}};(0,se._)([(0,tt.MZ)()],Nt.prototype,"activePolygons",null),(0,se._)([(0,tt.MZ)()],Nt.prototype,"style",void 0),(0,se._)([(0,tt.MZ)()],Nt.prototype,"geometries",void 0),(0,se._)([(0,tt.MZ)({constructOnly:!0})],Nt.prototype,"view",void 0),(0,se._)([(0,tt.MZ)()],Nt.prototype,"_areas",void 0),Nt=(0,se._)([(0,jr.$)("esri.views.FocusAreas")],Nt);const Fn=(0,S.vt)();var Hn=v(3223),ct=v(35326),Kr=v(51995),fr=v(35386);class $r{constructor(i,l,c,h){this.graphics3DSymbolLayer=i,this.renderGeometries=l,this.boundingBox=c,this._drapeSourceRenderer=h,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(i){this.stage=i.stage}setVisibility(i){if(null!=this.stage&&this._visible!==i){if(this._visible=i,i&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,fr.q.ADD);if(i||this._addedToStage){for(const l of this.renderGeometries)l.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,fr.k.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,fr.q.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(i=(0,S.vt)()){return(0,x.i)(i,0,0,0)}getBoundingBoxObjectSpace(i=(0,R.vt)()){return(0,R.Ie)(i)}addObjectState(i){i.stateType===De.Mg.Highlight&&(this.renderGeometries.forEach(l=>{const c=l.geometry.allocateIdAndHighlight(i.highlightName);i.addRenderGeometry(l,c,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,fr.k.HIGHLIGHT))}removeObjectState(i){this.renderGeometries.forEach(l=>i.removeByObject(l))}updateHighlights(i){}removeRenderGeometryObjectState(i,l){l.channel===De.Mg.Highlight&&(i.geometry.removeHighlight(l),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([i],fr.k.HIGHLIGHT))}computeAttachmentOrigin(i){for(const l of this.renderGeometries)l.geometry.computeAttachmentOrigin(tr)&&(i.draped.origin[0]+=tr[0],i.draped.origin[1]+=tr[1],i.draped.num++)}getProjectedBoundingBox(i,l,c,h,u){var p=this;return(0,B.A)(function*(){(0,R.Ie)(u);for(let f=0;f<p.renderGeometries.length;f++)p._getRenderGeometryProjectedBoundingRect(p.renderGeometries[f],i,Bi,c),(0,R.DC)(u,Bi);if(l){let f;(0,R.gX)(u,tr);const g=(0,k.vY)(u,l.service.spatialReference,l);try{f=yield l.service.queryElevation(tr[0],tr[1],h,g,"ground")}catch{}null!=f&&(u[2]=Math.min(u[2],f),u[5]=Math.max(u[5],f))}return u})()}_getRenderGeometryProjectedBoundingRect(i,l,c,h){if(this.boundingBox)(0,R.hZ)(ht,this.boundingBox);else{const u=i.boundingSphere,p=u[3];ht[0]=u[0]-p,ht[1]=u[1]-p,ht[2]=u[2]-p,ht[3]=u[0]+p,ht[4]=u[1]+p,ht[5]=u[2]+p}return l(ht,0,2),this.calculateRelativeScreenBounds&&h.push({location:(0,R.gX)(ht),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,R.ES)(ht,c)}}const Bi=(0,Kr.vt)(),ht=(0,R.vt)(),tr=(0,S.vt)();var _t=v(21128),We=v(42975),Me=v(85222),Ot=v(94302),gr=v(36947),vr=v(25612),Yr=v(20706),Zr=v(14064);const Vi=(0,S.fA)(0,0,1),Yn=[Ot.Q_*Ot.CN,Ot.Q_*Ot.CN];class _r extends he.U{getCachedSize(){return{size:this._getIconSize()}}constructor(i,l,c,h){super(i,l,c,h),this._cimData=null,this._overrideHelperClass=null,this._arcadeInfo=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._textureHandle=null,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}doLoad(i){var l=this;return(0,B.A)(function*(){l._validateOrThrow();const c=l._prepareMaterialParameters(),h=l._getPrimitive();if(null!=h)l._prepareResourcesPrimitive(c,h);else{const u=(0,wn.N7)(l.symbolLayer),p=Gi(u);null!=p?yield l._prepareResourcesCIM(c,JSON.parse(p),i):yield l._prepareResourcesHref(c,u,i)}})()}_validateOrThrow(){if(this._drivenProperties.size)return;const i=(0,k.Hj)(this._getIconSize());if(i)throw new oe.A("graphics3diconsymbollayer:invalid-size",i)}_getIconSize(){const i=this.symbolLayer,l=Math.round(null!=i.size?(0,Le.Lz)(i.size):16);return this._drivenProperties.size?Math.max(l,64):l}_generateTextureCIM(i){const l=this._overrideHelperClass;let c=this._cimData;if(l&&c&&c.symbol||this.logger.error("Can't create texture, CIM data is undefined"),c.primitiveOverrides){c=(0,pe.o8)(c);const y=c.primitiveOverrides;l.evaluateOverrides(y,i,this._arcadeInfo.geometryType,null,null),l.applyOverrides(c.symbol,y)}const h=(0,On.Wm)(JSON.stringify(c));let u=this._cimSymbolTextures.get(h);if(u)return u;const p=this._context.sharedResources.cimSymbolRasterizer,f=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;f&&l.applyDictionaryTextOverrides(c.symbol,i,f,null);const g=null!=this._cimScaleFactorOrFunction?(0,Tn.s4)(this._cimScaleFactorOrFunction,i):1;1!==g&&c.symbol&&(0,An.Km)(c.symbol,g,!0);const _=As.wp.getEnvelope(c,null,p.resourceManager);if(_?.width&&_.height){const P=p.rasterize({type:"cim",data:c},_.width,_.height,_.x+_.width/2,_.y+_.height/2,1,"esriGeometryPoint",0,null,this._context.graphicsCoreOwner.view.state.rasterPixelRatio),E=new Dn.Q({x:-_.x/_.width-.5,y:(_.height+_.y)/_.height-.5});this._cimMaterialParametersInfo.anchorPosition=zi("relative",E),u=new Yr.g(P,{width:P?.width??1,height:P?.height??1,reloadable:!0})}else u=new Yr.g(new ImageData(1,1),{width:1,height:1,reloadable:!0});return this._cimSymbolTextures.set(h,u),this._context.stage.add(u),u}_prepareMaterialParameters(){const i={anchorPosition:zi(this.symbolLayer.anchor,this.symbolLayer.anchorPosition),rotation:this.symbolLayer.angle},l=this.symbol;if(function Zn(d){return d&&"point-3d"===d.type&&d.hasVisibleVerticalOffset()}(l)){const{screenLength:h,minWorldLength:u,maxWorldLength:p}=l.verticalOffset;i.verticalOffset={screenLength:(0,Le.Lz)(h),minWorldLength:u||0,maxWorldLength:p??1/0}}this._context.screenSizePerspectiveEnabled&&(i.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),(0!==i.rotation||this._drivenProperties.rotation)&&(i.hasRotation=!0);const c=!!(0,ce.A)("enable-feature:non-occluded-hud");return i.occlusionTest=!c,i.occludedFragmentFade=c,i.horizonCullingEnabled=c&&this._context.spherical,i.hasSlicePlane=this._context.slicePlaneEnabled,i}_prepareResourcesPrimitive(i,l){const c=this._getOutlineSize();if(Ds(l)&&0===c)throw new Error("Nothing to render");if(this._outlineSize=c,i.color=this._getFillColor(),i.outlineColor=this._getOutlineColor(),i.outlineSize=this._outlineSize,null!=this._context.sharedResources.textures){const u=this._context.sharedResources.textures.fromData(`${l}-icon`,()=>(0,Ot.sZ)(l));this._textureHandle=u,i.textureId=u.texture.id}i.textureIsSignedDistanceField=!0,i.sampleSignedDistanceFieldTexelCenter=(0,Ot.ny)(l),i.distanceFieldBoundingBox=Ot.PY;const h=this._getIconSize();this._size=[h,h],this._symbolTextureRatio=1/Ot.CN,this._createMaterialAndAddToStage(i,this._context.stage)}_prepareResourcesHref(i,l,c){var h=this;return(0,B.A)(function*(){h._outlineSize=h._getOutlineSize(),i.color=h._getFillColor(),i.outlineColor=h._getOutlineColor(),i.outlineSize=h._outlineSize,i.textureIsSignedDistanceField=!1;const u=h._getIconSize(),p=u*h._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=h._context.sharedResources.textures){const f=yield(0,Ts.Ke)(h._context.sharedResources.textures.fromUrl(l,p,{signal:c}));if(!1===f.ok)throw(0,vt.QP)(f.error),new oe.A("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${l})`);h._textureHandle=f.value;const g=f.value.texture;h._size=Wi(g,u),i.textureId=g.id}h._createMaterialAndAddToStage(i,h._context.stage)})()}_prepareResourcesCIM(i,l,c){var h=this;return(0,B.A)(function*(){const{OverrideHelper:u}=yield Promise.resolve().then(v.bind(v,51298));if(h._overrideHelperClass=u,h._cimData=l,!h._context.sharedResources.cimSymbolRasterizer){const P=(yield v.e(2076).then(v.bind(v,14506))).CIMSymbolRasterizer;(0,vt.Te)(c),h._context.sharedResources.cimSymbolRasterizer||(h._context.sharedResources.cimSymbolRasterizer=new P(h._context.renderCoordsHelper.spatialReference))}const p=h._context.sharedResources.cimSymbolRasterizer,f=[],g=l,_=g?.symbol;As.wp.fetchResources(_,p.resourceManager,f,c),As.wp.fetchFonts(_,p.resourceManager,f);const y=h._context.layer.fields?h._context.layer.fields.map(P=>P.toJSON()):[];if(h._arcadeInfo={spatialReference:h._context.renderCoordsHelper.spatialReference,fields:y,geometryType:"esriGeometryPoint"},g?.primitiveOverrides&&f.push(u.createRenderExpressions(g.primitiveOverrides,h._arcadeInfo)),f.length>0&&(yield Promise.all(f),(0,vt.Te)(c)),h._context.renderer&&"dictionary"===h._context.renderer.type&&h._context.renderer.scaleExpression){const P=h._context.renderer;if(P.scaleExpression){const E=P.scaleExpression,O=yield(0,Sn.Ad)(E,h._context.layer.spatialReference,y),{default:C}=yield Promise.resolve().then(v.bind(v,46191));h._cimScaleFactorOrFunction=(A,w,N)=>{const K=C(O,A,{$view:N},"esriGeometryPoint",w);return null!==K?K:1}}}(0,vt.Te)(c),h._cimMaterialParametersInfo=i,h._cimMaterialParametersInfo.color=h._getFillColor(),h._cimMaterialParametersInfo.outlineColor=[0,0,0,0],h._cimMaterialParametersInfo.outlineSize=0,h._cimMaterialParametersInfo.textureIsSignedDistanceField=!1})()}_getPrimitive(){return this.symbolLayer.resource?.href?null:this.symbolLayer.resource?.primitive??Rn.r}_getOutlineSize(){let i=0;const l=this.symbolLayer;return null!=l.outline?.size?Math.max((0,Le.Lz)(l.outline.size),0):(i=Ds(this._getPrimitive())?1.5:0,Math.max(i,0))}_getOutlineColor(){const i=this._getLayerOpacity(),l=this.symbolLayer,c=l?.outline?.color;if(null!=c){const h=Xe.A.toUnitRGB(c);return[h[0],h[1],h[2],c.a*i]}return[0,0,0,0]}_getFillColor(){if(Ds(this._getPrimitive()))return Hn.r4;const i=null==this._getPrimitive(),l=this.symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(l,{hasIntrinsicColor:i})}_createMaterialAndAddToStage(i,l){const c=this._context.spherical;if(this._cimData){this._fastUpdates=null;let h=i.textureId?this._cimSymbolMaterials.get(i.textureId):null;return h||(h=new Zr.R(i,c),this._cimSymbolMaterials.set(i.textureId??0,h),l.add(h)),h}if(this._fastUpdates=(0,Me.s_)(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(i={...i,...this._fastUpdates.materialParameters}),this._materials[0]=new Zr.R(i,c),l.add(this._materials[0]),this._context.graphicsCoreOwner.view.focusAreas.activePolygons.length>0){i.isFocused=!1;const h=this._context.stage.view.focusAreas.style;i.color=Hr(i.color,h),i.outlineColor=Hr(i.outlineColor,h),this._materials[1]=new Zr.R(i,c),l.add(this._materials[1])}return this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(i=>{i.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=(0,st.DC)(this._patchTask),this._forEachMaterial(i=>this._context.stage.remove(i)),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(i=>this._context.stage.remove(i)),this._cimSymbolTextures.clear(),this._textureHandle=(0,st.Gz)(this._textureHandle)}_getScaleFactor(i,l){if(this._drivenProperties.size&&i.size){const c=Array.from(i.size);for(let h=0;h<3;h++){const u=c[h];u&&"symbol-value"!==u&&"proportional"!==u&&(c[h]=(0,Le.Lz)(u))}if("symbol-value"===c[0])return 1;if(isFinite(+c[0]))return+c[0]/l;if(isFinite(+c[2]))return+c[2]/l}return 1}_getDrivenRotation(i){return this._drivenProperties.rotation?i.heading??0:0}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry))return null;let c,h=[0,0];const u=(0,We.ZX)(l.geometry);if(null==u)return this.logger.warn(`unsupported geometry type for text symbol: ${l.geometry.type}`),null;const p=this._context.stage.view.focusAreas.containsGeometry(u);if(this._cimData){if(!this._cimData.symbol)return null;const E=this._generateTextureCIM(l),O={textureId:E.id,isFocused:p,...this._cimMaterialParametersInfo};c=this._createMaterialAndAddToStage(O,this._context.stage);const C=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;h=[E.parameters.width/C,E.parameters.height/C]}else h=this._size,c=p||1===this._materials.length?this._materials[0]:this._materials[1];if(null==u)return this.logger.warn(`unsupported geometry type for icon symbol: ${l.geometry.type}`),null;const f=i.renderingInfo,g=this._getVertexOpacityAndColor(f),_=this._getDrivenRotation(f);let y=1;this._fastUpdates?.visualVariables.size||(y=this._getScaleFactor(f,h[0]>h[1]?h[0]:h[1])),y*=this._symbolTextureRatio;const b=(0,le.fA)(h[0]*y,h[1]*y),P=this.setGraphicElevationContext(l);return this.ensureDrapedStatus("on-the-ground"===P.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(l,u,c,g,_,b,i.layer.uid):this._createAs3DShape(l,u,c,g,_,b,P,l.uid)}layerOpacityChanged(){const i=this._getFillColor(),l=this._getOutlineColor();this._forEachMaterial(c=>{c.setParameters({color:i}),c.setParameters({outlineColor:l})})}updateGeometry(i,l){if(this.draped||!this._validateGeometry(l))return!1;const{elevationContext:c,stageObject:h}=i;if(c.mode!==this.getGeometryElevationMode(l))return!1;const u=(0,We.ZX)(l);if(!u)return!1;const p=(0,We.hS)(h,this._context,u,c);if(null==p)return!1;const f=(0,We.R$)(this._context,u);return h.geometries[0].localOrigin===f&&(i.alignedSampledElevation=p,(0,We.d2)(i,u,this._context.elevationProvider),!0)}layerElevationInfoChanged(i,l,c){const h=this._elevationContext.mode,u=(0,L.I2)(_r.elevationModeChangeTypes,c,h);if(u!==L.uw.UPDATE)return u;const p=(0,L.nu)(h)||"absolute-height"===h;return this.updateGraphics3DGraphicElevationInfo(i,l,()=>p)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(i=>{i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(i,l){for(const c in i.diff){if("visualVariables"!==c||!(0,Me.J_)(this._fastUpdates,l,this._fastVisualVariableConvertOptions()))return G.w.RecreateSymbol;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return G.w.FastUpdate}updateFocus(i,l){l.forEach(c=>{const h=this._context.stage.view.focusAreas.containsGeometry(c.graphic.geometry);c.layers.forEach(u=>{u?.graphics3DSymbolLayer===this&&u.stageObject.geometries.some(p=>p.material.parameters.isFocused!==h)&&i(c)})})}prepareSymbolLayerPatch(i){if(this._patchTask?.abort(),"partial"!==i.diff.type)return;const l=i.diff.diff;this._preparePatchResource(i,l),this._preparePatchRotation(i,l)}_preparePatchResource(i,l){var c=this;if(!l.resource||"partial"!==l.resource.type)return;const h=l.resource.diff;if("complete"!==h?.href?.type)return;const u=h.href.newValue,{textures:p}=this._context.sharedResources;if(null==u||null==p||null!=Gi(u))return;const f=this._getIconSize(),g=f*this._context.graphicsCoreOwner.view.state.pixelRatio;i.symbolLayerStatePatches.push(()=>{this._patchTask=(0,st.DC)(this._patchTask),this._patchTask=(0,Ts.UT)(_=>this._context.schedule(function(){var y=(0,B.A)(function*(b,P){const E=yield(0,Ts.Ke)(p.fromUrl(u,g,{signal:P}));(0,vt.Te)(P);const O=!E.ok;if(O&&(0,vt.QP)(E.error),c._textureHandle=(0,st.Gz)(c._textureHandle),c._patchTask=null,O)return c._forEachMaterial(w=>{w.visible=!1,w.setParameters({textureId:null})}),void c.logger.error(new oe.A("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${u})`));c._textureHandle=E.value;const C=E.value.texture;c._size=Wi(C,f),c._forEachMaterial(A=>{A.setParameters({textureId:C.id}),A.visible=!0})});return function(b,P){return y.apply(this,arguments)}}(),_))}),delete h.href}_preparePatchRotation(i,l){if(!l.angle||"complete"!==l.angle.type)return;const c=l.angle.newValue??0,h=0!==c||this._drivenProperties.rotation;i.symbolLayerStatePatches.push(()=>{this._forEachMaterial(u=>u.setParameters({rotation:c,hasRotation:h}))}),delete l.angle}_defaultElevationInfoNoZ(){return Xn}_createAs3DShape(i,l,c,h,u,p,f,g){const _=this.getFastUpdateAttrValues(i),b=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,layerUid:this._context.layer.uid}),P=(0,gr.DJ)(c,{normal:Vi,color:h,rotation:u,size:p,centerOffsetAndDistance:Qn,featureAttribute:_,objectAndLayerIdColor:b}),E=(0,We.SZ)(this._context,l,P,f,g);if(null==E)return null;const O=new Q.Y(this,E.object,[P],null,null,ct.G8,f);return O.alignedSampledElevation=E.sampledElevation,O.needsElevationUpdates=(0,L.nu)(f.mode)||"absolute-height"===f.mode,O.getScreenSize=this._createScreenSizeGetter(p,_),O.calculateRelativeScreenBounds=C=>c.calculateRelativeScreenBounds(O.getScreenSize(),1,C),(0,We.d2)(O,l,this._context.elevationProvider),O}_createAsOverlay(i,l,c,h,u,p,f){c.renderPriority=this._renderPriority;const g=(0,S.vt)();(0,Ti.g)(l,g,this._context.overlaySR),g[2]=ui.bi;const _=this._context.clippingExtent;if(null!=_&&!(0,R.Uc)(_,g))return null;const y=this.getFastUpdateAttrValues(i),b=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i.uid,layerUid:this._context.layer.uid}),P=(0,gr.DJ)(c,{normal:Vi,position:g,color:h,rotation:u,size:p,featureAttribute:y,objectAndLayerIdColor:b}),E=new vr.$(P,{layerUid:f,graphicUid:i.uid}),O=new $r(this,[E],null,this._context.drapeSourceRenderer);return O.getScreenSize=this._createScreenSizeGetter(p,y),O.calculateRelativeScreenBounds=C=>c.calculateRelativeScreenBounds(O.getScreenSize(),1,C),O}_createScreenSizeGetter(i,l){const c=this._outlineSize+2;if(this._fastUpdates&&l){const p=i[0]/this._symbolTextureRatio,f=i[1]/this._symbolTextureRatio;return(g=(0,le.vt)())=>{const[_,y]=(0,Me.VC)(Jn,this._fastUpdates.materialParameters,l);return g[0]=_*p+c,g[1]=y*f+c,g}}const h=i[0]/this._symbolTextureRatio+c,u=i[1]/this._symbolTextureRatio+c;return(p=(0,le.vt)())=>(p[0]=h,p[1]=u,p)}_fastVisualVariableConvertOptions(){const i=Math.max(this._size[0],this._size[1]),l=(0,S.fA)(i,i,i),c=(0,Le.PN)(1),h=i*c,u=(0,S.fA)(h,h,h);return new Me.wI({size:!0,color:!0,rotation:!0,opacity:!1},l,u,c)}_forEachMaterial(i){this._materials.forEach(i),this._cimSymbolMaterials.forEach(i)}test(){return{...super.test(),material:this._materials[0]}}}function Ds(d){return null!=d&&("cross"===d||"x"===d)}function Gi(d){const i=(0,Cn.r$)(d);return"application/json"===i?.mediaType?i.data:void 0}function zi(d,i){return"relative"===d?(0,le.fA)((i.x||0)+.5,.5-(i.y||0)):d in _t.Zd?_t.Zd[d]:_t.Zd.center}function Wi({parameters:d},i){const l=(d.width??1)/(d.height??1);return l>1?[i,Math.round(i/l)]:[Math.round(i*l),i]}_r.PRIMITIVE_SIZE=Yn,_r.elevationModeChangeTypes={definedChanged:L.uw.UPDATE,staysOnTheGround:L.uw.NONE,onTheGroundChanged:L.uw.RECREATE};const Xn={mode:"relative-to-ground",offset:0},Qn=(0,we.fA)(0,0,0,1),Jn=(0,S.vt)();var yr=v(18501);function ws(d){switch(d){case"butt":return yr.x.BUTT;case"square":return yr.x.SQUARE;case"round":return yr.x.ROUND;default:return null}}function ji(d){return"diamond"===d?"kite":d}var Ls=v(81897),Fi=v(21031),Is=v(48499),de=v(74567),kn=v(19589),yt=v(50957),Ve=v(55128),Hi=v(59642),Ge=v(14356),ze=v(54501),qn=v(12895),rr=v(65207);class eo extends Lt.w{constructor(i,l){super(i,l,new wt.$(qn.L,()=>v.e(5293).then(v.bind(v,55293))),Ki)}_makePipelineState(i,l){const{output:c,oitPass:h,space:u,hasOccludees:p}=i;return(0,Ee.Ey)({blending:(0,de.RN)(c)?(0,Ge.Yf)(h):null,depthTest:u===rr.lM.Draped?null:{func:(0,Ge.K_)(h)},depthWrite:(0,Ge.z5)(i),drawBuffers:c===de.V.Depth?{buffers:[Oe.Hr.NONE]}:(0,Ge.m6)(h,c),colorWrite:Ee.kn,stencilWrite:p?ze.v0:null,stencilTest:p?l?ze.a9:ze.qh:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(i){return i.occluder?(this._occluderPipelineTransparent=(0,Ee.Ey)({blending:Ee.Ky,depthTest:ze.sf,depthWrite:null,colorWrite:Ee.kn,stencilWrite:null,stencilTest:ze.mK}),this._occluderPipelineOpaque=(0,Ee.Ey)({blending:Ee.Ky,depthTest:ze.sf,depthWrite:null,colorWrite:Ee.kn,stencilWrite:ze.r8,stencilTest:ze.I$}),this._occluderPipelineMaskWrite=(0,Ee.Ey)({blending:null,depthTest:ze.m,depthWrite:null,colorWrite:null,stencilWrite:ze.v0,stencilTest:ze.a9})):this._occluderPipelineTransparent=this._occluderPipelineOpaque=this._occluderPipelineMaskWrite=null,this._occludeePipelineState=this._makePipelineState(i,!0),this._makePipelineState(i,!1)}getPipeline(i,l){return i?this._occludeePipelineState:l===Ve.N.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent??super.getPipeline():l===Ve.N.OCCLUDER_MATERIAL?this._occluderPipelineOpaque??super.getPipeline():this._occluderPipelineMaskWrite??super.getPipeline()}}const Ki=new Map([[D.r.POSITION,0],[D.r.PREVPOSITION,1],[D.r.UV0,2],[D.r.NORMAL,3],[D.r.COLOR,4],[D.r.COLORFEATUREATTRIBUTE,4],[D.r.SIZE,5],[D.r.SIZEFEATUREATTRIBUTE,5],[D.r.OPACITYFEATUREATTRIBUTE,6]]);var Xr=v(28700);class to extends yt.im{constructor(i){super(i,so),this._configuration=new rr.Dt,this.vertexAttributeLocations=Ki,this.produces=new Map([[Ve.N.OPAQUE_MATERIAL,l=>l===de.V.Highlight||(0,de._o)(l)&&this.parameters.renderOccluded===yt.m$.OccludeAndTransparentStencil],[Ve.N.OPAQUE_MATERIAL_WITHOUT_NORMALS,l=>(0,de.eh)(l)],[Ve.N.OCCLUDER_MATERIAL,l=>(0,de.aD)(l)&&this.parameters.renderOccluded===yt.m$.OccludeAndTransparentStencil],[Ve.N.TRANSPARENT_OCCLUDER_MATERIAL,l=>(0,de.aD)(l)&&this.parameters.renderOccluded===yt.m$.OccludeAndTransparentStencil],[Ve.N.TRANSPARENT_MATERIAL,l=>(0,de._o)(l)&&this.parameters.writeDepth],[Ve.N.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,l=>(0,de._o)(l)&&!this.parameters.writeDepth],[Ve.N.DRAPED_MATERIAL,l=>(0,de.RN)(l)||l===de.V.Highlight]]),this._layout=this.createLayout()}getConfiguration(i,l){return this._configuration.output=i,this._configuration.space=l.slot===Ve.N.DRAPED_MATERIAL?rr.lM.Draped:this.parameters.worldSpace?rr.lM.World:rr.lM.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==yr.x.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=l.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===yt.m$.OccludeAndTransparentStencil,this._configuration.oitPass=l.oitPass,this._configuration.terrainDepthTest=l.terrainDepthTest&&(0,de.RN)(i),this._configuration.cullAboveTerrain=l.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=Xr.Q}intersect(){}createLayout(){const i=(0,Is.BP)().vec3f(D.r.POSITION).vec3f(D.r.PREVPOSITION).vec2f(D.r.UV0);return this.parameters.worldSpace&&i.vec3f(D.r.NORMAL),i.f32(this.parameters.vvSize?D.r.SIZEFEATUREATTRIBUTE:D.r.SIZE),this.parameters.vvColor?i.f32(D.r.COLORFEATUREATTRIBUTE):i.vec4f(D.r.COLOR),this.parameters.vvOpacity&&i.f32(D.r.OPACITYFEATUREATTRIBUTE),i}createBufferWriter(){return new io(this._layout,this.parameters)}createGLMaterial(i){return new ro(i)}}class ro extends kn.m8{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextures.release(this._markerPrimitive),this._markerPrimitive=null}beginSlot(i){const l=this._material.parameters.markerPrimitive;return l!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(l,this._markerPrimitive)}),this._markerPrimitive=l),this._material.setParameters(this.textureBindParameters),this.getTechnique(eo,i)}}class so extends Hi.S{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=yr.x.BUTT,this.anchor=rr.kJ.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.markerTexture=null}}class io{constructor(i,l){this.vertexBufferLayout=i,this._parameters=l}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(i,l,c,h,u,p){const f=c.get(D.r.POSITION).data,g=f.length/3;let _=[1,0,0];const y=c.get(D.r.NORMAL);this._parameters.worldSpace&&null!=y&&(_=y.data);let b=1,P=0;this._parameters.vvSize?P=c.get(D.r.SIZEFEATUREATTRIBUTE).data[0]:c.has(D.r.SIZE)&&(b=c.get(D.r.SIZE).data[0]);let E=[1,1,1,1],O=0;this._parameters.vvColor?O=c.get(D.r.COLORFEATUREATTRIBUTE).data[0]:c.has(D.r.COLOR)&&(E=c.get(D.r.COLOR).data);let C=0;this._parameters.vvOpacity&&(C=c.get(D.r.OPACITYFEATUREATTRIBUTE).data[0]);const A=new Float32Array(u.buffer);let w=p*(this.vertexBufferLayout.stride/4);const N=(I,q,ie,ee)=>{if(A[w++]=I[0],A[w++]=I[1],A[w++]=I[2],A[w++]=q[0],A[w++]=q[1],A[w++]=q[2],A[w++]=ie[0],A[w++]=ie[1],this._parameters.worldSpace&&(A[w++]=_[0],A[w++]=_[1],A[w++]=_[2]),A[w++]=this._parameters.vvSize?P:b,this._parameters.vvColor)A[w++]=O;else{const ae=Math.min(4*ee,E.length-4);A[w++]=E[ae],A[w++]=E[ae+1],A[w++]=E[ae+2],A[w++]=E[ae+3]}this._parameters.vvOpacity&&(A[w++]=C)};let K;var I;(I=K||(K={}))[I.ASCENDING=1]="ASCENDING",I[I.DESCENDING=-1]="DESCENDING";const z=(I,q)=>{const ie=(0,x.i)(ao,f[3*I],f[3*I+1],f[3*I+2]),ee=no;let ae=I+q;do{(0,x.i)(ee,f[3*ae],f[3*ae+1],f[3*ae+2]),ae+=q}while((0,x.I)(ie,ee)&&ae>=0&&ae<g);i&&((0,x.t)(ie,ie,i),(0,x.t)(ee,ee,i)),N(ie,ee,[-1,-1],I),N(ie,ee,[1,-1],I),N(ie,ee,[1,1],I),N(ie,ee,[-1,-1],I),N(ie,ee,[1,1],I),N(ie,ee,[-1,1],I)},H=this._parameters.placement;"begin"!==H&&"begin-end"!==H||z(0,K.ASCENDING),"end"!==H&&"begin-end"!==H||z(g-1,K.DESCENDING)}}const ao=(0,S.vt)(),no=(0,S.vt)();var $i=v(24639),xr=v(51612);const oo=["polyline","polygon","extent"],Yi=new Me.wI({size:!0,color:!0,rotation:!1,opacity:!0});class Qr extends he.U{constructor(i,l,c,h){super(i,l,c,h)}doLoad(){var i=this;return(0,B.A)(function*(){if(i._fastUpdates=(0,Me.s_)(i._context.renderer,Yi),!i._drivenProperties.size&&(null!=i.symbolLayer.size?i.symbolLayer.size:(0,Le.PN)(1))<0)throw new oe.A("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")})()}_getMaterialParameters(i,l=!1){const c=this._getCombinedOpacityAndColor(l&&this._markerColor||this._materialColor);this._patternHidesLine&&!l&&(c[3]=0);const h={width:this._computeMaterialWidth(this.symbolLayer?.size),color:c,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:ws(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:i,stipplePattern:(0,$i.Xq)(this.symbolLayer.pattern)};return this._fastUpdates?.visualVariables?{...h,...this._fastUpdates.materialParameters}:h}get _materialColor(){return this.symbolLayer.material?.color}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return null==this._materials[Ce.Line]&&(this._materials[Ce.Line]=new xr.W(this._getMaterialParameters(!1)),this._context.stage.add(this._materials[Ce.Line])),this._materials[Ce.Line]}get _ringMaterial(){return null==this._materials[Ce.Ring]&&(this._materials[Ce.Ring]=new xr.W(this._getMaterialParameters(!0)),this._context.stage.add(this._materials[Ce.Ring])),this._materials[Ce.Ring]}get _wireframeLineMaterial(){return null==this._materials[Ce.LineWireframe]&&(this._materials[Ce.LineWireframe]=new xr.W({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._materials[Ce.LineWireframe])),this._materials[Ce.LineWireframe]}get _wireframeRingMaterial(){return null==this._materials[Ce.RingWireframe]&&(this._materials[Ce.RingWireframe]=new xr.W({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._materials[Ce.RingWireframe])),this._materials[Ce.RingWireframe]}get _markerMaterial(){return null==this._materials[Ce.Marker]&&null!=this.symbolLayer.marker&&(this._materials[Ce.Marker]=new to({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:ji(this.symbolLayer.marker.style)}),this._context.stage.add(this._materials[Ce.Marker])),this._materials[Ce.Marker]}destroy(){super.destroy(),this._forEachMaterial(i=>this._context.stage.remove(i)),this._materials.length=0}_getDrivenSize(i){return this._drivenProperties.size&&i.size?(0,Le.Lz)((0,X.or)(i.size)):1}_getDrivenColor(i){const l=(0,we.fA)(1,1,1,1);return this._drivenProperties.color&&i.color&&(l[0]=i.color[0],l[1]=i.color[1],l[2]=i.color[2],i.color.length>0&&(l[3]=i.color[3])),this._drivenProperties.opacity&&i.opacity&&(l[3]=i.opacity),l}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry,oo,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(l);return this.ensureDrapedStatus("on-the-ground"===c.mode),this.draped?this._createAsOverlay(i,this._context.layer.uid):this._createAs3DShape(i,c,l.uid)}applyRendererDiff(i,l){for(const c in i.diff){if("visualVariables"!==c)return G.w.RecreateSymbol;{const h=this._fastUpdates;if(!(0,Me.J_)(h,l,Yi))return G.w.RecreateSymbol;this._forEachMaterial(u=>u?.setParameters(h.materialParameters))}}return G.w.FastUpdate}prepareSymbolLayerPatch(i){if("partial"!==i.diff.type)return;const l=i.diff.diff,c={};"complete"===l.size?.type&&(c.width=this._computeMaterialWidth(l.size.newValue),delete l.size),"complete"===l.cap?.type&&(c.cap=ws(l.cap.newValue??"butt"),delete l.cap);const h=this._prepareMarkerPatch(i,l);this._prepareMaterialPatch(i,l,h),i.symbolLayerStatePatches.push(()=>this._forEachMaterial(u=>u?.setParameters(c)))}layerOpacityChanged(){this._forEachMaterial((i,l)=>this._updateMaterialLayerOpacity(i,l===Ce.Marker))}_forEachMaterial(i){this._materials.forEach(i)}_updateMaterialLayerOpacity(i,l=!1){if(null==i)return;const c=i.parameters.color,h=this.symbolLayer?.material?.color,u=this._patternHidesLine&&!l?0:this._getCombinedOpacity(h),p=(0,we.fA)(c[0],c[1],c[2],u);i.setParameters({color:p})}layerElevationInfoChanged(i,l,c){const h=this._elevationContext.mode,u=(0,L.I2)(Qr.elevationModeChangeTypes,c,h);if(u!==L.uw.UPDATE)return u;const p=(0,L.nu)(h);return this.updateGraphics3DGraphicElevationInfo(i,l,()=>p)}slicePlaneEnabledChanged(){const i={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(l=>l?.setParameters(i)),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(i,l,c){const h=Zi(i.graphic.geometry),u="polygon"===h.type?h.rings:h.paths,p=new Array,f=(0,R.vt)(),g=(0,Fi.C)(h,this._context.elevationProvider,this._context.renderCoordsHelper,l);this._logGeometryCreationWarnings(g,u,"polygon"===h.type?"rings":"paths","LineSymbol3DLayer");for(let P=0;P<g.lines.length;P++){const E=g.lines[P],O=E.position,C=E.mapPositions;if(null!=this._context.clippingExtent&&((0,R.vY)(C,f),!(0,R.KG)(f,this._context.clippingExtent)))continue;const A=this._createGeometry("polygon"===h.type?this._ringMaterial:this._lineMaterial,i,O,C,h.type,Pr.ELEVATED,c);p.push(A),Xt.b.LINE_WIREFRAMES&&p.push(A.instantiate({material:"polygon"===h.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial&&p.push(A.instantiate({material:this._markerMaterial}))}if(0===p.length)return null;const y=new Qt.B({geometries:p,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:c}),b=new Q.Y(this,y,p,null,null,ct.Zd,l);return b.alignedSampledElevation=g.sampledElevation,b.needsElevationUpdates=(0,L.nu)(l.mode),b}_createGeometry(i,l,c,h,u,p,f){const g=p===Pr.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,_="polygon"===u,y=this._fastUpdates?.visualVariables.color,b=this._fastUpdates?.visualVariables.size,P=this._fastUpdates?.visualVariables.opacity,E=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerUid:this._context.layer.uid}),O={position:c,size:b?null:this._getDrivenSize(l.renderingInfo),color:y?null:this._getDrivenColor(l.renderingInfo),sizeFeature:b?(0,Me.ul)(b.field,l.graphic):null,colorFeature:y?(0,Me.ul)(y.field,l.graphic):null,opacityFeature:P?(0,Me.ul)(P.field,l.graphic):null};return(0,Ls.t)(i,{overlayInfo:g,removeDuplicateStartEnd:_,mapPositions:h,attributeData:O},E)}_createAsOverlay(i,l){const c=i.graphic,h=Zi(c.geometry),u="polygon"===h.type?h.rings:h.paths,p="polygon"===h.type?this._ringMaterial:this._lineMaterial;p.renderPriority=this._renderPriority;const f=Xt.b.LINE_WIREFRAMES?"polygon"===h.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,g=this._markerMaterial;null!=f&&(f.renderPriority=this._renderPriority-.001),null!=g&&(g.renderPriority=this._renderPriority-.002);const _=new Array,y=(0,R.vt)(),b=(0,R.Ie)(),P=(0,Fi.A)(h,this._context.overlaySR);this._logGeometryCreationWarnings(P,u,"polygon"===h.type?"rings":"paths","LineSymbol3DLayer");for(const O of P.lines){if((0,R.vY)(O.position,y),!(0,R.KG)(y,this._context.clippingExtent))continue;(0,R.RF)(b,y);const C=A=>{const w=this._createGeometry(A,i,O.position,void 0,h.type,Pr.DRAPED,c.uid),N=new vr.$(w,{layerUid:l,graphicUid:c.uid});_.push(N)};if(null!=g){C(g);const A=this.symbolLayer.marker.placement;"begin"!==A&&"begin-end"!==A||(0,R.Hq)(y,O.position,0,1),"end"!==A&&"begin-end"!==A||(0,R.Hq)(y,O.position,O.position.length-3,1)}C(p),Xt.b.LINE_WIREFRAMES&&C(f)}return new $r(this,_,b,this._context.drapeSourceRenderer)}get _patternHidesLine(){const i=this.symbolLayer.pattern;return null!=i&&"style"===i.type&&"none"===i.style}_computeMaterialWidth(i){return i=i??(0,Le.PN)(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?(0,Le.Lz)(1):1:(0,Le.Lz)(i)}_prepareMaterialPatch(i,l,c){const h=l.material;if(null==h)return void(c.changed&&c.useMaterialColor&&Jr(this._getCombinedOpacityAndColor(this._materialColor),this._materials[Ce.Marker],i));if("collection"===h.type)return;const p=this._getCombinedOpacityAndColor("complete"===h.type?h.newValue?.color:"complete"===h.diff.color?.type?h.diff.color.newValue:null);c.useMaterialColor&&Jr((0,we.o8)(p),this._materials[Ce.Marker],i),this._patternHidesLine&&(p[3]=0),Jr(p,this._materials[Ce.Line],i),delete l.material}_prepareMarkerPatch(i,l){const c=l.marker,h=this._markerMaterial;if(null==c||"partial"!==c.type||null==c.diff||null!=c.diff.placement||null!=c.diff.style&&"complete"!==c.diff.style.type||null!=c.diff.color&&"complete"!==c.diff.color.type||null==h)return{changed:!1,useMaterialColor:null==this._markerColor};const u=c.diff.color,p=null!=u,f=p?u.newValue:null,g=null==f&&null==this._markerColor;f&&Jr(this._getCombinedOpacityAndColor(f),h,i);const _=c.diff.style?.newValue;return _&&i.symbolLayerStatePatches.push(()=>h.setParameters({markerPrimitive:ji(_)})),delete l.marker,{changed:p,useMaterialColor:g}}}function Zi(d){switch(d.type){case"extent":if(d instanceof V.A)return F.A.fromExtent(d);break;case"polygon":case"polyline":return d}return null}function Jr(d,i,l){null!=i&&l.symbolLayerStatePatches.push(()=>i.setParameters({color:d}))}var Pr,Ce;Qr.elevationModeChangeTypes={definedChanged:L.uw.RECREATE,staysOnTheGround:L.uw.NONE,onTheGroundChanged:L.uw.RECREATE},function(d){d[d.DRAPED=0]="DRAPED",d[d.ELEVATED=1]="ELEVATED"}(Pr||(Pr={})),function(d){d[d.Line=0]="Line",d[d.Ring=1]="Ring",d[d.LineWireframe=2]="LineWireframe",d[d.RingWireframe=3]="RingWireframe",d[d.Marker=4]="Marker"}(Ce||(Ce={}));var xt=v(69287),lo=v(13970),co=v(93318),Qe=v(81596),ho=v(86507),uo=v(73490),po=v(59723),Xi=v(78559),kr=v(58701),Je=v(30429),mo=v(22178),fo=v(8675),Ct=v(14624),go=v(39690),br=v(68641),Qi=v(23393);class _o extends Q.Y{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(i,l){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;const{stageObject:c}=this,h=c.geometries.slice();c.removeAllGeometries();const u=(0,J.sC)(Us,c.transformation),p=l.getOrigin(u);for(const f of h){const g=i(f.material),_=f.instantiate({material:g});_.localOrigin=p,c.addGeometry(_)}this._originalGeometries=h}autoDisableFastTransformUpdates(i){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,i()},2e3)}updateAutoDisableFastTransformUpdates(i){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(i)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(i){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;const{stageObject:l}=this,c=l.geometries.map(h=>i(h.material));l.removeAllGeometries();for(let h=0;h<this._originalGeometries.length;h++){const u=this._originalGeometries[h],p=c[h];p.setParameters({modelTransformation:null}),l.addGeometry(p===u.material?u:u.instantiate({material:p}))}this._originalGeometries.length=0}updateFastLocalOrigin(i,l,c){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:h}=this;if(0===h.geometries.length)return;const u=h.geometries[0].localOrigin,p=(0,J.sC)(Us,i),f=c.getOrigin(p);if(f===u)return;const g=l?.localMatrix??Z.zK;h.shaderTransformation=null,h.transformation=i,h.geometries.forEach(_=>{_.transformation=g,_.localOrigin=f})}updateTransform(i,l,c){const{stageObject:h}=this,u=l?.localMatrix??Z.zK;if(!this._fastTransformUpdatesEnabled)return h.shaderTransformation=null,h.transformation=i,h.geometries.forEach(E=>E.transformation=u),void this._updateEdgeTransform(c);const f=h.geometries[0].transformation,g=i,_=u,y=(0,J.lw)(Ji,h.transformation,f),b=(0,J.lw)(ki,g,_),P=(0,J.lw)(qi,b,(0,J.B8)(qi,f));h.shaderTransformation=P,this._setFastMaterialTransformation({matA:y,matB:b}),this._updateEdgeTransform(c)}alignWithElevation(i,l,c,h){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(i,l,c,h);null!=c&&(0,Qi.gf)(this.elevationContext.featureExpressionInfoContext,c);const{stageObject:p}=this;if(!p.geometries[0].material.parameters.modelTransformation)return;const _=(0,J.lw)(Ji,p.transformation,p.geometries[0].transformation),b=(0,J.C)(yo,p.effectiveTransformation);this.alignedSampledElevation=(0,ct.G8)(this,this.elevationContext,i.spatialReference,(O,C)=>(0,L.sE)(O,i,this.elevationContext,l,C),l,b),p.shaderTransformation=b;const E=(0,J.lw)(ki,b,p.geometries[0].transformation);this._setFastMaterialTransformation({matA:_,matB:E}),this._updateEdgeTransform(h)}_setFastMaterialTransformation({matA:i,matB:l}){const{stageObject:c}=this;if(0===c.geometries.length)return;const u=(0,J.kN)(xo,(0,x.h)(Us,c.geometries[0].localOrigin.vec3,-1)),p=(0,J.lw)(ea,u,i),f=(0,J.lw)(ta,u,l),g=(0,J.B8)(ea,p),_=(0,J.lw)(ta,f,g);for(const y of c.geometries)y.material.setParameters({modelTransformation:_})}_updateEdgeTransform(i){const{stageObject:l,_stageLayer:c}=this;c.stage.renderer.withEdgeView(h=>{h.fastUpdateObject3DEdgesTransform(l)||this.resetEdgeObject(i)})}}const Us=(0,S.vt)(),Ji=(0,Z.vt)(),ki=(0,Z.vt)(),yo=(0,Z.vt)(),qi=(0,Z.vt)(),ea=(0,Z.vt)(),ta=(0,Z.vt)(),xo=(0,Z.vt)();class Po{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(i,l,c){i.enableFastTransformUpdates(h=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(h))return h;const p=l.byMaterial(h);return this._fastTransformOriginalMaterials.set(h,p),l.delete(h),h}const u=new Jt.$U(h.parameters,c);return c.stage.add(u),this._fastTransformClonedMaterials.set(u,h),u},c.localOriginFactory)}disable(i,l,c){const h=new Set,u=new Set;i.disableFastTransformUpdates(p=>{if(!this._fastTransformClonedMaterials.has(p)){const _=p,y=this._fastTransformOriginalMaterials.get(_);return l.has(y.uid)?(h.add(_),l.byUid(y.uid).material):(u.add(_),y.material)}const f=p,g=this._fastTransformClonedMaterials.get(f);return this._fastTransformClonedMaterials.delete(f),c.stage.remove(f),g});for(const p of h)this._fastTransformOriginalMaterials.delete(p),c.stage.remove(p);for(const p of u){const f=this._fastTransformOriginalMaterials.get(p);this._fastTransformOriginalMaterials.delete(p),l.set(f.uid,f)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(i,l,c){this._graphicReferenceCount--,this.disable(i,l,c)}forEachMaterialInfo(i){this._fastTransformOriginalMaterials.forEach(i)}forEachClonedMaterial(i){this._fastTransformClonedMaterials.forEach(i)}destroy(i){i.removeMany(Array.from(this._fastTransformClonedMaterials.keys())),i.removeMany(Array.from(this._fastTransformOriginalMaterials.values(),({material:l})=>l)),this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}}class bo{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),i=>i.material)}byUid(i){return this._byUid.get(i)}byMaterial(i){return this._byMaterial.get(i)}set(i,l){this._byUid.set(i,l),this._byMaterial.set(l.material,l)}delete(i){const l=this._byMaterial.get(i)?.uid;l&&(this._byUid.delete(l),this._byMaterial.delete(i))}has(i){return this._byUid.has(i)}forEachMaterialInfo(i){this._byUid.forEach(i)}clear(){this._byUid.clear(),this._byMaterial.clear()}}var ra=v(10136),Pe=v(83953),qr=v(91421),Bt=v(71548),Se=v(93617),es=v(91074),Ns=v(65388),ts=v(61427),rs=v(6771),Eo=v(94236);class Mo extends Lt.w{constructor(i,l){super(i,l,new wt.$(Eo.N,()=>v.e(4678).then(v.bind(v,34678)))),this.primitiveType=Oe.WR.LINES}initializePipeline(i){const{hasOccludees:l,output:c,transparent:h}=i,u=(p,f=null,g=null)=>(0,Ee.Ey)({blending:f,depthTest:ze.m,depthWrite:g,colorWrite:Ee.kn,stencilWrite:l?ze.v0:null,stencilTest:l?p?ze.a9:ze.qh:null});return(0,de.RN)(c)?(this._occludeePipeline=u(!0,h?Ee.Ky:null,Ee.Uy),u(!1,h?Ee.Ky:null,Ee.Uy)):u(!1)}getPipeline(i){return i?this._occludeePipeline:super.getPipeline()}}var ge=v(55062),ss=v(35094);class is extends ss.E{constructor(){super(...arguments),this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1}}(0,se._)([(0,ge.W)()],is.prototype,"hasVertexColors",void 0),(0,se._)([(0,ge.W)()],is.prototype,"transparent",void 0),(0,se._)([(0,ge.W)()],is.prototype,"hasOccludees",void 0);class Bs extends yt.im{constructor(i){super(i,Co),this._configuration=new is,this.produces=new Map([[Ve.N.OPAQUE_MATERIAL,l=>(0,de.dX)(l)]])}getConfiguration(i,l){return this._configuration.output=i,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=l.hasOccludees,this._configuration}get visible(){return this.parameters.color[3]>=Xr.Q}intersect(i,l,c,h,u,p){if(!c.options.selectionMode||!i.visible)return;if(!(0,Ns.zH)(l))return void ne.A.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const f=i.attributes.get(D.r.POSITION).data,g=c.camera,_=To;(0,Pe.C)(_,c.point),(0,x.i)(Er[0],_[0]-2,_[1]+2,0),(0,x.i)(Er[1],_[0]+2,_[1]+2,0),(0,x.i)(Er[2],_[0]+2,_[1]-2,0),(0,x.i)(Er[3],_[0]-2,_[1]-2,0);for(let C=0;C<4;C++)if(!g.unprojectFromRenderScreen(Er[C],Pt[C]))return;(0,Se.Cr)(g.eye,Pt[0],Pt[1],Vs),(0,Se.Cr)(g.eye,Pt[1],Pt[2],Gs),(0,Se.Cr)(g.eye,Pt[2],Pt[3],zs),(0,Se.Cr)(g.eye,Pt[3],Pt[0],Ws);let b=Number.MAX_VALUE,P=0;for(let C=0;C<f.length-5;C+=3){if($e[0]=f[C]+l[12],$e[1]=f[C+1]+l[13],$e[2]=f[C+2]+l[14],Ye[0]=f[C+3]+l[12],Ye[1]=f[C+4]+l[13],Ye[2]=f[C+5]+l[14],(0,Se.mN)(Vs,$e)<0&&(0,Se.mN)(Vs,Ye)<0||(0,Se.mN)(Gs,$e)<0&&(0,Se.mN)(Gs,Ye)<0||(0,Se.mN)(zs,$e)<0&&(0,Se.mN)(zs,Ye)<0||(0,Se.mN)(Ws,$e)<0&&(0,Se.mN)(Ws,Ye)<0)continue;if(g.projectToRenderScreen($e,Gt),g.projectToRenderScreen(Ye,zt),Gt[2]<0&&zt[2]>0){(0,x.d)(dt,$e,Ye);const w=g.frustum,N=-(0,Se.mN)(w[qr.FB.NEAR],$e)/(0,x.f)(dt,(0,Se.Qj)(w[qr.FB.NEAR]));(0,x.h)(dt,dt,N),(0,x.g)($e,$e,dt),g.projectToRenderScreen($e,Gt)}else if(Gt[2]>0&&zt[2]<0){(0,x.d)(dt,Ye,$e);const w=g.frustum,N=-(0,Se.mN)(w[qr.FB.NEAR],Ye)/(0,x.f)(dt,(0,Se.Qj)(w[qr.FB.NEAR]));(0,x.h)(dt,dt,N),(0,x.g)(Ye,Ye,dt),g.projectToRenderScreen(Ye,zt)}else if(Gt[2]<0&&zt[2]<0)continue;Gt[2]=0,zt[2]=0;const A=(0,Bt.kb)((0,Bt.Cr)(Gt,zt,aa),_);A<b&&(b=A,(0,x.c)(sa,$e),(0,x.c)(ia,Ye),P=C/3)}const E=c.rayBegin,O=c.rayEnd;if(b<4){let C=Number.MAX_VALUE;if((0,Bt.ld)((0,Bt.Cr)(sa,ia,aa),(0,Bt.Cr)(E,O,So),Vt)){(0,x.d)(Vt,Vt,E);const A=(0,x.l)(Vt);(0,x.h)(Vt,Vt,1/A),C=A/(0,x.j)(E,O)}p(C,Vt,P,!1)}}intersectDraped(i,l,c,h,u,p){if(!c.options.selectionMode)return;const f=i.attributes.get(D.r.POSITION).data,g=i.attributes.get(D.r.SIZE),y=h[0],b=h[1],P=(((g?g.data[0]:0)+1)/2+4)*i.screenToWorldRatio;let E=Number.MAX_VALUE,O=0;for(let C=0;C<f.length-5;C+=3){const A=f[C],w=f[C+1],N=y-A,K=b-w,z=f[C+3]-A,H=f[C+4]-w,I=(0,xt.qE)((z*N+H*K)/(z*z+H*H),0,1),q=z*I-N,ie=H*I-K,ee=q*q+ie*ie;ee<E&&(E=ee,O=C/3)}E<P*P&&u(p.dist,p.normal,O,!1)}createGLMaterial(i){return new Oo(i)}createBufferWriter(){return new ts.Z(this.parameters.hasVertexColors?rs.dB:rs.Ci)}}class Oo extends es.A{beginSlot(i){return this.getTechnique(Mo,i)}}class Co extends yt.qA{constructor(){super(...arguments),this.color=we.Un,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1}}const $e=(0,S.vt)(),Ye=(0,S.vt)(),dt=(0,S.vt)(),Vt=(0,S.vt)(),Gt=(0,Le.r_)(),zt=(0,Le.r_)(),sa=(0,S.vt)(),ia=(0,S.vt)(),aa=(0,Bt.vt)(),So=(0,Bt.vt)(),To=(0,S.vt)(),Er=[(0,Le.r_)(),(0,Le.r_)(),(0,Le.r_)(),(0,Le.r_)()],Pt=[(0,S.vt)(),(0,S.vt)(),(0,S.vt)(),(0,S.vt)()],Vs=(0,Se.vt)(),Gs=(0,Se.vt)(),zs=(0,Se.vt)(),Ws=(0,Se.vt)();var Mr=v(30906);const Ao=["mesh"];class js{constructor(i,l,c){this.normals=i,this.indices=l,this.didFlipNormals=c}}function Do(d,i){return i.faces??(0,Y.tM)(d.vertexAttributes.position.length/3)}function wo(d,i,l,c){switch(l.shading||"flat"){default:case"source":return function Lo(d,i,l,c){if(null==i)return na(d,c);let h=!1;if(!l.trustSourceNormals)for(let u=0;u<c.length;u+=3){as(d,c,u,ut);for(let p=0;p<3;p++){const f=3*c[u+p];be[0]=i[f],be[1]=i[f+1],be[2]=i[f+2],(0,x.f)(ut,be)<0&&(i[f]=-i[f],i[f+1]=-i[f+1],i[f+2]=-i[f+2],h=!0)}}return new js(i,c,h)}(d,i,l,c);case"flat":return na(d,c);case"smooth":return function Io(d,i){const l={};for(let u=0;u<i.length;u+=3){const p=as(d,i,u,ut);for(let f=0;f<3;f++){const g=i[u+f];let _=l[g];_||(_={normal:(0,S.vt)(),count:0},l[g]=_),(0,x.g)(_.normal,_.normal,p),_.count++}}const c=(0,Qe.oe)(3*i.length),h=new Array(3*i.length);for(let u=0;u<i.length;u++){const p=l[i[u]];1!==p.count&&((0,x.n)(p.normal,p.normal),p.count=1);for(let f=0;f<3;f++)c[3*u+f]=p.normal[f];h[u]=u}return new js(c,h,!1)}(d,c)}}function na(d,i){const l=(0,Qe.oe)(i.length),c=new Array(3*i.length);for(let h=0;h<i.length;h+=3){const u=as(d,i,h,ut);for(let p=0;p<3;p++)l[h+p]=u[p],c[h+p]=h/3}return new js(l,c,!1)}function oa(d,i,l,c,h,u){const p=3*i[l],f=3*i[l+1],g=3*i[l+2];c[0]=d[p],c[1]=d[p+1],c[2]=d[p+2],h[0]=d[f],h[1]=d[f+1],h[2]=d[f+2],u[0]=d[g],u[1]=d[g+1],u[2]=d[g+2]}function as(d,i,l,c){return oa(d,i,l,be,it,sr),(0,x.d)(it,it,be),(0,x.d)(sr,sr,be),(0,x.e)(be,it,sr),(0,x.n)(c,be),c}function Or(d){if(!d)return null;const{scale:i,offset:l,rotation:c}=d;return{scale:i,offset:l,rotation:(0,xt.kU)(c)}}function Uo(d="repeat"){if("string"==typeof d){const i=Fs(d);return{s:i,t:i}}return{s:Fs(d.horizontal),t:Fs(d.vertical)}}function Fs(d){switch(d){case"clamp":return Oe.pF.CLAMP_TO_EDGE;case"mirror":return Oe.pF.MIRRORED_REPEAT;default:return Oe.pF.REPEAT}}function Wt(d){return null==d?"-":d instanceof Xe.A?d.toHex():d.contentHash}function Cr(d){const{offset:i,scale:l,rotation:c}=d??zo;return`${i[0]},${i[1]},${c},${l[0]},${l[1]}`}const zo=new po.A,ns=(0,S.vt)(),be=(0,S.vt)(),it=(0,S.vt)(),sr=(0,S.vt)(),ut=(0,S.vt)(),os=(0,Z.vt)(),Wo=(0,Z.vt)(),la=(0,R.vt)(),jo=[new ho.A];var ke;!function(d){d[d.NONE=0]="NONE",d[d.RENDER=1]="RENDER"}(ke||(ke={}));var Fo=v(15225),ls=v(64439),ca=v(42363),Ho=v(79622);class Ko{constructor(i,l,c,h,u){this.graphics3DSymbolLayer=i,this.instanceIndex=l,this.elevationAligner=c,this.elevationContext=h,this._highlightOrderMap=u,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1,this._highlightName=null}initialize(){}setVisibility(i){const{instanceData:l}=this;i!==l.getVisible(this.instanceIndex)&&l.setVisible(this.instanceIndex,i)}destroy(){null!=this.instanceIndex&&(this.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(i,l,c){if(this.elevationAligner){(0,Qi.gf)(this.elevationContext.featureExpressionInfoContext,c);const u=this.elevationAligner(this,this.elevationContext,i.spatialReference,(p,f)=>(0,L.sE)(p,i,this.elevationContext,l,f),l);null!=u&&(this.alignedSampledElevation=u)}}getCenterObjectSpace(i=(0,S.vt)()){return this.instanceData.getCombinedLocalTransform(this.instanceIndex,pt),(0,x.t)(i,this._lodRenderer.baseBoundingSphere.center,pt)}getBoundingBoxObjectSpace(i=(0,R.vt)()){this.instanceData.getCombinedLocalTransform(this.instanceIndex,pt);const l=this._lodRenderer.baseBoundingBox;(0,R.Ie)(i);for(let c=0;c<8;++c)(0,x.i)(at,1&c?l[3]:l[0],2&c?l[4]:l[1],4&c?l[5]:l[2]),(0,x.t)(at,at,pt),(0,R.iT)(i,at);return i}computeAttachmentOrigin(i){this.instanceData.getGlobalTransform(this.instanceIndex,pt),i.render.origin[0]+=pt[12],i.render.origin[1]+=pt[13],i.render.origin[2]+=pt[14],i.render.num++}getProjectedBoundingBox(i,l,c,h,u){var p=this;return(0,B.A)(function*(){const f=p.getBoundingBoxObjectSpace(u),g=$o,_=(0,R.fT)(f)?1:g.length;p.instanceData.getGlobalTransform(p.instanceIndex,pt);for(let b=0;b<_;b++){const P=g[b];at[0]=f[P[0]],at[1]=f[P[1]],at[2]=f[P[2]],(0,x.t)(at,at,pt),jt[3*b]=at[0],jt[3*b+1]=at[1],jt[3*b+2]=at[2]}if(!i(jt,0,_))return null;(0,R.Ie)(f);let y=null;p.calculateRelativeScreenBounds&&(y=p.calculateRelativeScreenBounds());for(let b=0;b<3*_;b+=3){for(let P=0;P<3;P++)f[P]=Math.min(f[P],jt[b+P]),f[P+3]=Math.max(f[P+3],jt[b+P]);y&&c.push({location:jt.slice(b,b+3),screenSpaceBoundingRect:y})}if(l&&((0,R.gX)(f,Hs),"absolute-height"!==p.elevationContext.mode)){let b;const P=(0,k.vY)(f,l.service.spatialReference,l);try{b=yield l.service.queryElevation(Hs[0],Hs[1],h,P,"ground")}catch{}null!=b&&(0,R.cY)(f,0,0,-p.alignedSampledElevation+b)}return f})()}addObjectState(i){i.stateType===De.Mg.Highlight&&this.addObjectHighlightState(i)}addObjectHighlightState(i){const l=new Ho.h(i.highlightName);this._addHighlightId(l),i.addExternal(c=>{this._removeHighlightId(c)},l)}removeObjectState(i){this._highlights.forEach(l=>i.remove(l))}updateHighlights(i){this._highlightOrderMap=i,this._updateHighlightOptions()}_calculateHighlightOptions(){let i=-1,l=null;return this._highlights.forEach(({highlightName:c})=>{const h=this._highlightOrderMap.get(c);void 0!==h&&h>i&&(i=h,l=c)}),l}_addHighlightId(i){this._highlights.add(i),this._updateHighlightOptions()}_removeHighlightId(i){this._highlights.delete(i),this._updateHighlightOptions()}_updateHighlightOptions(){const i=this._calculateHighlightOptions();i!==this._highlightName&&(this._highlightName=i,this.instanceData.setHighlight(this.instanceIndex,i))}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}get instanceData(){return this._lodRenderer.instanceData}}const jt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],at=(0,S.vt)(),Hs=(0,S.vt)(),$o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],pt=(0,Z.vt)();var Yo=v(69760),cs=v(35404);const Jo=20;var ko=v(50179),ha=v(29851),qo=v(13688),da=v(62153),ua=v(58964);function Ks(){return Ks=(0,B.A)(function*(d){if(null==d||null==d.styleName&&null==d.styleUrl)return null;const i=d.name;if(null==i)throw new oe.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");const l={portal:d.portal},c=yield(0,da.cF)(d,l).catch(()=>null);if(null===c)return null;const h=(0,ua.getStyleItemFromStyle)(i,c.data);if(h&&!h.formatInfos?.some(f=>"gltf_basisu"===f.type))return null;const u=yield(0,ua.fetchSymbolFromStyle)(c,i,l,da.o5,{acceptedFormats:["web-gltf-basisu","web-gltf","web"]}).catch(()=>null);if(null===u||"point-3d"!==u.type)return null;const p=u.symbolLayers.items[0];return"object"===p.type?p.resource:null}),Ks.apply(this,arguments)}var Ft=v(12335),tl=v(93758);class pa{constructor(i,l,c,h,u,p,f,g,_,y,b,P){this.lodResources=i,this.lodRenderer=l,this.stageResources=c,this.originalMaterialParameters=h,this.resourceSize=u,this.isEsriSymbolResource=p,this.isWosr=f,this.resourceBoundingBox=g,this.symbolSize=_,this.extentPadding=y,this.physicalBasedRenderingEnabled=b,this.pivotOffset=P}}function ma(d,i,l){const c=(0,S.vt)();switch(l.anchor){case"center":(0,x.c)(c,(0,R.gX)(d)),(0,x.v)(c,c);break;case"top":{const h=(0,R.gX)(d);(0,x.i)(c,-h[0],-h[1],-d[5]);break}case"bottom":{const h=(0,R.gX)(d);(0,x.i)(c,-h[0],-h[1],-d[2]);break}case"relative":{const h=(0,R.gX)(d),u=(0,R.Ej)(d),p=l.anchorPosition,f=p?(0,S.fA)(p.x,p.y,p.z):S.uY;(0,x.C)(c,u,f),(0,x.g)(c,c,h),(0,x.v)(c,c);break}default:null!=i?(0,x.v)(c,i):(0,x.c)(c,S.uY)}return c}function fa(d){return"absolute-height"!==d.mode}const ir=(0,S.vt)(),ga=(0,Z.vt)(),$s=(0,Z.vt)(),hs=(0,we.vt)(),ds=new L.Uk;var us=v(32451),ps=v(11445);class sl{constructor(i,l,c,h){this.vertices=i,this.positionsES=l,this.offset=h;const u=i.length,p=Math.floor(u/2),f=this.offset+3*p,g=c[f],_=c[f+1],y=c[f+2];this.origin=(0,S.fA)(g,_,y),this.positions=(0,Qe.oe)(3*u);const b=this.offset+3*u;for(let P=this.offset;P<b;P+=3)this.positions[P]=c[P]-g,this.positions[P+1]=c[P+1]-_,this.positions[P+2]=c[P+2]-y;this.updatePathVertexInformation()}get usedMemory(){return(0,ps.Qf)(this.positions)}updatePathVertexInformation(){const i=this.vertices.length,l=this.vertices[0];let c=this.offset;const h=this.positions;l.vRight[0]=h[c+3]-h[c],l.vRight[1]=h[c+4]-h[c+1],l.vRight[2]=h[c+5]-h[c+2],c+=3;let u=(0,x.l)(l.vRight);l.vMinSiblingLength=u,(0,x.n)(l.vRight,l.vRight);let p=l;for(let f=1;f<i;++f){const g=this.vertices[f];if(g.vLeft=p.vRight,f<i-1){g.vRight[0]=h[c+3]-h[c],g.vRight[1]=h[c+4]-h[c+1],g.vRight[2]=h[c+5]-h[c+2];const _=(0,x.l)(g.vRight);g.vMinSiblingLength=Math.min(u,_),u=_,(0,x.n)(g.vRight,g.vRight)}else(0,x.c)(g.vRight,g.vLeft),g.vMinSiblingLength=u;p=g,c+=3}}}class il{constructor(i,l,c,h,u,p={}){this.path=i,this.profile=l,this.extruder=c,this.startCap=h,this.endCap=u,this.options=p,this._extrusionVertexCount=0;const f=this.path.vertices.length-2;this.numExtrusionProfiles=c.numProfilesPerJoin()*f+2,this.numVerticesTotal=l.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal,this.numVerticesTotal+=this.startCap.numVertices,this.endCap.vertexBufferStart=this.numVerticesTotal,this.numVerticesTotal+=this.endCap.numVertices,this.pathVertexData=(0,Y.JH)(1*this.numVerticesTotal),this.profileRightAxes=(0,Qe.oe)(4*this.numVerticesTotal),this.profileUpAxes=(0,Qe.oe)(4*this.numVerticesTotal),this.profileVertexAndNormals=(0,Qe.oe)(4*this.numVerticesTotal),this.positions=(0,Qe.AK)(i.positions,i.offset,3*i.vertices.length),this._rebuildGeometry(),this.buildTopology()}get usedMemory(){return(0,ps.Qf)(this.pathVertexData,this.profileRightAxes,this.profileUpAxes,this.profileVertexAndNormals)+this.path.usedMemory+this.profile.usedMemory}emitVertex(i,l,c,h,u){const p=4*this._extrusionVertexCount;if(this.profileRightAxes[p]=l.right[0],this.profileRightAxes[p+1]=l.right[1],this.profileRightAxes[p+2]=l.right[2],this.profileUpAxes[p]=l.up[0],this.profileUpAxes[p+1]=l.up[1],this.profileUpAxes[p+2]=l.up[2],this.profileVertexAndNormals[p]=c[0],this.profileVertexAndNormals[p+1]=c[1],this.profileVertexAndNormals[p+2]=h[0],this.profileVertexAndNormals[p+3]=h[1],this.pathVertexData[this._extrusionVertexCount]=i,u){const f=this.path.vertices[i],g=f.maxStretchDistance;this.profileRightAxes[p+3]=f.rotationRight[0]*g,this.profileUpAxes[p+3]=f.rotationRight[1]*g}else this.profileRightAxes[p+3]=0,this.profileUpAxes[p+3]=0;++this._extrusionVertexCount}emitCapVertex(i,l,c,h,u,p){const f=4*this._extrusionVertexCount;this.profileRightAxes[f]=l.right[0],this.profileRightAxes[f+1]=l.right[1],this.profileRightAxes[f+2]=l.right[2],this.profileRightAxes[f+3]=u,this.profileUpAxes[f]=l.up[0],this.profileUpAxes[f+1]=l.up[1],this.profileUpAxes[f+2]=l.up[2],this.profileUpAxes[f+3]=p,this.profileVertexAndNormals[f]=c[0],this.profileVertexAndNormals[f+1]=c[1],this.profileVertexAndNormals[f+2]=h[0],this.profileVertexAndNormals[f+3]=h[1],this.pathVertexData[this._extrusionVertexCount]=i,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;const{positions:i,offset:l,vertices:c}=this.path;this.positions=(0,Qe.AK)(i,l,3*c.length);let h=0;const u=(f,g,_,y,b)=>this.emitCapVertex(h,f,g,_,y,b),p=(f,g,_,y)=>this.emitVertex(h,f,g,_,y);for(this.startCap.rebuildConnectingProfileGeometry(c[h],this.profile,u),h=1;h<c.length-1;++h)this.extruder.extrude(c[h],this.profile,p);this.endCap.rebuildConnectingProfileGeometry(c[h],this.profile,u),h=0,this.startCap.rebuildCapGeometry(c[h],u),h=c.length-1,this.endCap.rebuildCapGeometry(c[h],u)}buildTopology(){const i=this.profile.vertices.length,l=this.profile.numSegments,c=this.numExtrusionProfiles-1;let h=l*c*2*3;this.startCap.indexBufferStart=h,this.startCap.firstProfileVertexIndex=0,h+=this.startCap.numIndices,this.endCap.indexBufferStart=h,this.endCap.firstProfileVertexIndex=i*(this.numExtrusionProfiles-1);const u=new Array,p=new Array,f=new Array,g=(_,y,b)=>{u.push(_),u.push(y),u.push(b),p.push(_),p.push(y),p.push(b),f.push(this.pathVertexData[_]),f.push(this.pathVertexData[y]),f.push(this.pathVertexData[b])};for(let _=0;_<l;++_){const y=this.profile.indices[2*_],b=this.profile.indices[2*_+1];for(let P=0;P<c;++P){const E=P*i+y,O=(P+1)*i+b,C=P*i+b;g(E,(P+1)*i+y,O),g(E,O,C)}}this.startCap.buildTopology(this.path.vertices[0],g),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],g),this.vertexIndices=(0,Y.Dg)(u),this.normalIndices=(0,Y.Dg)(p),this.pathVertexIndices=(0,Y.Dg)(f)}onPathChanged(){this._rebuildGeometry()}}class Ys{rebuildConnectingProfileGeometry(i,l,c){for(let h=0;h<l.vertices.length;++h)c(i.frame,l.vertices[h],l.normals[h],0,0)}}class va extends Ys{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}}class ms extends Ys{constructor(i,l=0,c=!1){super(),this.profile=i,this.profilePlaneOffset=l,this.flip=c}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(i,l,c){const h=this.profilePlaneOffset;for(let u=0;u<l.vertices.length;++u)c(i.frame,l.vertices[u],l.normals[u],h,0)}rebuildCapGeometry(i,l){const c=this.profile,h=this.flip?1:-1,u=this.profilePlaneOffset,p=ya;(0,Pe.hZ)(p,0,0);for(let f=0;f<c.vertices.length;++f)l(i.frame,c.vertices[f],p,u,h)}buildTopology(i,l){const c=this.profile,h=this.vertexBufferStart+c.indices[0];for(let u=1;u<c.numSegments;++u){const g=this.vertexBufferStart+c.indices[2*u],_=this.vertexBufferStart+c.indices[2*u+1];this.flip?l(_,g,h):l(h,g,_)}}}class _a extends Ys{constructor(i){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=i.profile,this.flip=i.flip,this.sign=this.flip?1:-1,this.breakNormals=i.breakNormals,this.numSegments=i.subdivisions}get numVertices(){let i=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(i+=this.profile.vertices.length),i}get numIndices(){let i=0;const l=this.profile;i+=2*l.numSegments*(this.numSegments-1);for(let c=0;c<l.numSegments;++c)i+=l.poleIndices[l.indices[2*c]]===l.poleIndices[l.indices[2*c+1]]?1:2;return 3*i}rebuildCapGeometry(i,l){const c=this.profile,h=i.frame,u=.5*this.sign,p=al,f=ya;(0,Pe.hZ)(f,0,0);for(const g of c.poles)g.normal?l(h,g.position,g.normal,u,0):l(h,g.position,f,u,this.sign);if(this.breakNormals)for(let g=0;g<c.vertices.length;++g)l(h,c.vertices[g],c.normals[g],0,0);for(let g=0;g<this.numSegments-1;++g){const _=(1-(g+1)/this.numSegments)*Math.PI*.5,y=Math.sin(_),b=Math.cos(_);for(let P=0;P<c.vertices.length;++P){const E=c.poles[c.poleIndices[P]];(0,Pe.Re)(p,c.vertices[P],E.position),(0,Pe.hs)(p,p,y),E.normal?((0,Pe.WQ)(p,p,E.position),l(h,p,E.normal,u*b,0)):((0,Pe.S8)(f,p),(0,Pe.hs)(f,f,y),(0,Pe.WQ)(p,p,E.position),l(h,p,f,u*b,this.sign*b))}}}buildTopology(i,l){const c=this.profile,h=this.breakNormals?this.vertexBufferStart+c.poles.length:this.firstProfileVertexIndex,u=this.breakNormals?this.vertexBufferStart+c.poles.length+c.vertices.length:this.vertexBufferStart+c.poles.length;for(let p=0;p<c.numSegments;++p){const f=c.indices[2*p],g=c.indices[2*p+1],_=this.vertexBufferStart+c.poleIndices[f],y=this.vertexBufferStart+c.poleIndices[g];let b=h+f,P=h+g;for(let E=0;E<this.numSegments-1;++E){const O=u+E*c.vertices.length+f,C=u+E*c.vertices.length+g;this.flip?(l(O,P,b),l(P,O,C)):(l(b,P,O),l(C,O,P)),b=O,P=C}this.flip?(l(_,P,b),_!==y&&l(_,y,P)):(l(b,P,_),_!==y&&l(P,y,_))}}}const al=(0,le.vt)(),ya=(0,le.vt)();class nl{numProfilesPerJoin(){return 1}extrude(i,l,c){for(let h=0;h<l.vertices.length;++h)c(i.frame,l.vertices[h],l.normals[h],!1)}}class Zs{constructor(i,l){this.cutoffAngle=i,this.numBendSubdivisions=l}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(i,l,c){const h=ll,{rotationAngle:u,rotationRight:p,frame:f}=i;if(Math.abs(u)>=this.cutoffAngle){const g=i.rotationFrameUp;for(let _=0;_<this.numBendSubdivisions+1;++_){(0,J.$0)(ba,.5*-u+_*u/this.numBendSubdivisions,g),ol(h,f,ba);for(let y=0;y<l.vertices.length;++y)(0,Pe.Om)(l.vertices[y],p)*u>=0?c(h,l.vertices[y],l.normals[y],!1):c(f,i.applyMiterStretch(Pa,l.vertices[y]),l.normals[y],!0)}}else for(let g=0;g<this.numBendSubdivisions+1;++g)for(let _=0;_<l.vertices.length;++_){const y=(0,Pe.Om)(l.vertices[_],p)*u>=0;c(f,i.applyMiterStretch(Pa,l.vertices[_]),l.normals[_],!y)}}}class xa{constructor(){this.up=(0,S.vt)(),this.right=(0,S.vt)()}}function ol(d,i,l){(0,x.t)(d.up,i.up,l),(0,x.t)(d.right,i.right,l)}const Pa=(0,le.vt)(),ba=(0,Z.vt)(),ll=new xa;class cl extends Re.V{constructor(i,l,c,h,u,p){super(i,l,null,fe.X.Mesh,p),this.path=c,this.geometrySR=h,this.stencilWidth=u}}var mt;function Ea(d){return"path"in d}!function(d){d[d.World=0]="World",d[d.Path=1]="Path"}(mt||(mt={}));var Xs=v(49178);class Ma{constructor(i){this.builder=i}onPathChanged(i){this.builder.onPathChanged()}}class Oa extends Ma{constructor(i){super(i),this.vertexAttributeColor=(0,we.fA)(255,255,255,255),this.size=new Array,this.vertexAttributePosition=(0,Qe.oe)(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(i){this.vertexAttributeColor[0]=255*i[0],this.vertexAttributeColor[1]=255*i[1],this.vertexAttributeColor[2]=255*i[2],this.vertexAttributeColor[3]=255*(i.length>3?i[3]:1)}bake(i){this.size=i;const{numVerticesTotal:l,pathVertexData:c,path:h,positions:u,profileRightAxes:p,profileUpAxes:f,profileVertexAndNormals:g}=this.builder;for(let _=0;_<l;++_){let y=c[_];const b=0===y||y===h.vertices.length-1;y*=3;const P=ml;let E=0,O=0;const C=4*_,A=(0,x.i)(fl,p[C],p[C+1],p[C+2]),w=(0,x.i)(gl,f[C],f[C+1],f[C+2]),N=(0,Pe.hZ)(Ca,g[C]*i[0],g[C+1]*i[1]);if(b)(0,x.e)(P,w,A),E=p[C+3]*i[0],O=f[C+3];else{const I=dl,q=ul;(0,Pe.hZ)(I,p[C+3],f[C+3]);const ie=(0,Pe.Bw)(I);(0,Pe.S8)(I,I);const ee=(0,Pe.Om)(N,I);if(Math.abs(ee)>ie){(0,Pe.hZ)(q,-I[1],I[0]);const ae=(0,Pe.Om)(N,q);(0,Pe.hs)(I,I,ie*Math.sign(ee)),(0,Pe.hs)(q,q,ae),(0,Pe.WQ)(N,I,q)}(0,x.i)(P,0,0,0)}const K=(0,x.i)(pl,A[0]*N[0]+w[0]*N[1],A[1]*N[0]+w[1]*N[1],A[2]*N[0]+w[2]*N[1]),z=3*_;this.vertexAttributePosition[z]=u[y]+K[0]+P[0]*E,this.vertexAttributePosition[z+1]=u[y+1]+K[1]+P[1]*E,this.vertexAttributePosition[z+2]=u[y+2]+K[2]+P[2]*E;const H=(0,Pe.hZ)(Ca,g[C+2],g[C+3]);(0,Cs.aT)(this.vertexAttributeNormal,_,A[0]*H[0]+w[0]*H[1]+P[0]*O,A[1]*H[0]+w[1]*H[1]+P[1]*O,A[2]*H[0]+w[2]*H[1]+P[2]*O)}}createGeometryData(){const i=this.builder.vertexIndices.length,{normalIndices:l,vertexIndices:c}=this.builder;return[[D.r.POSITION,new te.n(this.vertexAttributePosition,c,3,!0)],[D.r.NORMALCOMPRESSED,new te.n(this.vertexAttributeNormal,l,2,!0)],[D.r.COLOR,new te.n(this.vertexAttributeColor,(0,Y.EH)(i),4)]]}onPathChanged(i){super.onPathChanged(i),this.bake(this.size)}intersect(i,l,c,h){const u=this.builder.vertexIndices,p=new te.K(this.vertexAttributePosition,3);(0,Xs.Z$)(i,l,0,u.length/3,u,p,void 0,c,(g,_,y)=>h(g,y,_,!1))}}class hl extends Ma{constructor(i,l,c,h){super(i),this.sizeAttributeValue=l,this.colorAttributeValue=c,this.opacityAttributeValue=h,this.vvData=null,this.baked=new Oa(i),this.vvData=(0,Qe.oe)(4*this.builder.path.vertices.length);for(let u=0;u<this.builder.path.vertices.length;++u)this.vvData[4*u]=l,this.vvData[4*u+1]=c,this.vvData[4*u+2]=h,this.vvData[4*u+3]=0===u||u===this.builder.path.vertices.length-1?1:0}createGeometryData(){const{positions:i,profileRightAxes:l,profileUpAxes:c,profileVertexAndNormals:h,pathVertexIndices:u,vertexIndices:p}=this.builder;return[[D.r.POSITION,new te.n(i,u,3,!0)],[D.r.PROFILERIGHT,new te.n(l,p,4,!0)],[D.r.PROFILEUP,new te.n(c,p,4,!0)],[D.r.PROFILEVERTEXANDNORMAL,new te.n(h,p,4,!0)],[D.r.FEATUREVALUE,new te.n(this.vvData,u,4,!0)]]}onPathChanged(i){super.onPathChanged(i);const l=i.getMutableAttribute(D.r.POSITION);l&&(l.data=this.builder.positions)}}const Ca=(0,le.vt)(),dl=(0,le.vt)(),ul=(0,le.vt)(),pl=(0,S.vt)(),ml=(0,S.vt)(),fl=(0,S.vt)(),gl=(0,S.vt)();var vl=v(55703);const yl=(0,S.vt)();class Sa{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(i,l){return this.vertices.push((0,le.o8)(i)),this.normals.push((0,le.o8)(l)),this.vertices.length-1}addPole(i,l=null){return this.poles.push({position:(0,le.o8)(i),normal:l?(0,le.o8)(l):null}),this.poles.length-1}addSegment(i,l=null){this.indices.push(i.v0),this.indices.push(i.v1),l&&(this.poleIndices.push(l.v0),this.poleIndices.push(l.v1))}get numSegments(){return this.indices.length/2}translate(i,l){for(const c of this.vertices)c[0]+=i,c[1]+=l;for(const c of this.poles)c.position[0]+=i,c.position[1]+=l}get usedMemory(){return this.vertices.length*(0,ps.Qf)(this.vertices[0])*2+(0,ps.Qf)(this.indices)}}const Ta={top:[0,-.5],bottom:[0,.5]};function Qs(d){const l=us.ZC,c=new Sa,h={v0:0,v1:0};c.addPole((0,le.fA)(0,0));for(let p=0;p<l;++p){const f=2*p*Math.PI/l,g=Math.cos(f),_=Math.sin(f),y=(0,le.fA)(.5*g,.5*_),b=(0,le.fA)(g,_);c.addVertex(y,b)}for(let p=0;p<l-1;++p)c.addSegment({v0:p,v1:p+1},h);if(c.addSegment({v0:l-1,v1:0},h),"center"!==d){const p=Ta[d];c.translate(p[0],p[1])}return c}const xl={center:Qs("center"),top:Qs("top"),bottom:Qs("bottom")},Pl={center:Js("center"),top:Js("top"),bottom:Js("bottom")};function Js(d){const c=new Sa,h=(0,le.fA)(-.5,-.5),u=(0,le.fA)(.5,-.5),p=(0,le.fA)(.5,.5),f=(0,le.fA)(-.5,.5),g=(0,le.fA)(0,-1),_=(0,le.fA)(1,0),y=(0,le.fA)(0,1),b=(0,le.fA)(-1,0);if(c.addPole((0,le.fA)(0,.5),y),c.addPole((0,le.fA)(0,.5)),c.addPole((0,le.fA)(0,-.5)),c.addPole((0,le.fA)(0,-.5),g),c.addVertex(h,g),c.addVertex(u,g),c.addSegment({v0:0,v1:1},{v0:3,v1:3}),c.addVertex(u,_),c.addVertex(p,_),c.addSegment({v0:2,v1:3},{v0:2,v1:1}),c.addVertex(p,y),c.addVertex(f,y),c.addSegment({v0:4,v1:5},{v0:0,v1:0}),c.addVertex(f,b),c.addVertex(h,b),c.addSegment({v0:6,v1:7},{v0:1,v1:2}),"center"!==d){const P=Ta[d];c.translate(P[0],P[1])}return c}var Aa=v(85952);function Ra(d,i,l,c,h){return d[0]=i,d[1]=l,d[2]=c,d[3]=h,d}function Da(d,i,l){const c=i[0],h=i[1],u=i[2],p=i[3],f=l[0],g=l[1],_=l[2],y=l[3];return d[0]=c*f+u*g,d[1]=h*f+p*g,d[2]=c*_+u*y,d[3]=h*_+p*y,d}function wa(d,i,l){return d[0]=i[0]-l[0],d[1]=i[1]-l[1],d[2]=i[2]-l[2],d[3]=i[3]-l[3],d}Object.freeze(Object.defineProperty({__proto__:null,LDU:function Il(d,i,l,c){return d[2]=c[2]/c[0],l[0]=c[0],l[1]=c[1],l[3]=c[3]-d[2]*l[1],[d,i,l]},add:function Ul(d,i,l){return d[0]=i[0]+l[0],d[1]=i[1]+l[1],d[2]=i[2]+l[2],d[3]=i[3]+l[3],d},adjoint:function Cl(d,i){const l=i[0];return d[0]=i[3],d[1]=-i[1],d[2]=-i[2],d[3]=l,d},copy:function bl(d,i){return d[0]=i[0],d[1]=i[1],d[2]=i[2],d[3]=i[3],d},determinant:function Sl(d){return d[0]*d[3]-d[2]*d[1]},equals:function Bl(d,i){const l=d[0],c=d[1],h=d[2],u=d[3],p=i[0],f=i[1],g=i[2],_=i[3],y=(0,Aa.FD)();return Math.abs(l-p)<=y*Math.max(1,Math.abs(l),Math.abs(p))&&Math.abs(c-f)<=y*Math.max(1,Math.abs(c),Math.abs(f))&&Math.abs(h-g)<=y*Math.max(1,Math.abs(h),Math.abs(g))&&Math.abs(u-_)<=y*Math.max(1,Math.abs(u),Math.abs(_))},exactEquals:function Nl(d,i){return d[0]===i[0]&&d[1]===i[1]&&d[2]===i[2]&&d[3]===i[3]},frob:function Ll(d){return Math.sqrt(d[0]**2+d[1]**2+d[2]**2+d[3]**2)},fromRotation:function Rl(d,i){const l=Math.sin(i),c=Math.cos(i);return d[0]=c,d[1]=l,d[2]=-l,d[3]=c,d},fromScaling:function Dl(d,i){return d[0]=i[0],d[1]=0,d[2]=0,d[3]=i[1],d},identity:function El(d){return d[0]=1,d[1]=0,d[2]=0,d[3]=1,d},invert:function Ol(d,i){const l=i[0],c=i[1],h=i[2],u=i[3];let p=l*u-h*c;return p?(p=1/p,d[0]=u*p,d[1]=-c*p,d[2]=-h*p,d[3]=l*p,d):null},mul:Da,multiply:Da,multiplyScalar:function Vl(d,i,l){return d[0]=i[0]*l,d[1]=i[1]*l,d[2]=i[2]*l,d[3]=i[3]*l,d},multiplyScalarAndAdd:function Gl(d,i,l,c){return d[0]=i[0]+l[0]*c,d[1]=i[1]+l[1]*c,d[2]=i[2]+l[2]*c,d[3]=i[3]+l[3]*c,d},rotate:function Tl(d,i,l){const c=i[0],h=i[1],u=i[2],p=i[3],f=Math.sin(l),g=Math.cos(l);return d[0]=c*g+u*f,d[1]=h*g+p*f,d[2]=c*-f+u*g,d[3]=h*-f+p*g,d},scale:function Al(d,i,l){const h=i[1],u=i[2],p=i[3],f=l[0],g=l[1];return d[0]=i[0]*f,d[1]=h*f,d[2]=u*g,d[3]=p*g,d},set:Ra,str:function wl(d){return"mat2("+d[0]+", "+d[1]+", "+d[2]+", "+d[3]+")"},sub:wa,subtract:wa,transpose:function Ml(d,i){if(d===i){const l=i[1];d[1]=i[2],d[2]=l}else d[0]=i[0],d[1]=i[2],d[2]=i[1],d[3]=i[3];return d}},Symbol.toStringTag,{value:"Module"})),Object.freeze(Object.defineProperty({__proto__:null,clone:function jl(d){return[d[0],d[1],d[2],d[3]]},create:function La(){return[1,0,0,1]},createView:function Hl(d,i){return new Float64Array(d,i,4)},fromValues:function Fl(d,i,l,c){return[d,i,l,c]}},Symbol.toStringTag,{value:"Module"}));class Ia{constructor(){this.vLeft=(0,S.vt)(),this.vRight=(0,S.vt)(),this.vMinSiblingLength=0,this.frame=new xa}setFrameFromUpVector(i){(0,x.c)(this.frame.up,i),(0,x.g)(Tr,this.vLeft,this.vRight),(0,x.n)(Tr,Tr),(0,x.h)(Ba,this.frame.up,(0,x.f)(Tr,this.frame.up)),(0,x.d)(gs,Tr,Ba),(0,x.n)(gs,gs),(0,x.e)(this.frame.right,gs,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}}class Kl extends Ia{get rotationFrameUp(){return this.frame.up}get rotationRight(){return le.Cw}get rotationAngle(){return(0,x.h)(St,this.frame.up,(0,x.f)(this.frame.up,this.vLeft)),(0,x.d)(St,this.vLeft,St),(0,x.v)(St,St),(0,x.n)(St,St),(0,x.h)(nr,this.frame.up,(0,x.f)(this.frame.up,this.vRight)),(0,x.d)(nr,this.vRight,nr),(0,x.n)(nr,nr),(0,x.e)(fs,this.rotationFrameUp,this.vLeft),Math.sign((0,x.f)(fs,this.vRight))*(Math.PI-(0,xt.XM)((0,x.f)(St,nr)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(i,l){const c=this.rotationAngle;if(Math.abs(c)<=0)return l;const h=(0,xt.J_)(Math.cos(.5*c));return(0,Pe.hZ)(i,(h-1+1)*l[0],l[1])}}class $l extends Ia{get rotationFrameUp(){const i=Math.sign((0,x.f)(this.frame.right,this.vRight));return(0,x.e)(Sr,this.vRight,this.vLeft),(0,x.h)(Sr,Sr,i),(0,x.n)(Sr,Sr)}get rotationRight(){const i=this.rotationFrameUp,l=(0,x.f)(i,this.frame.up),c=(0,x.f)(i,this.frame.right);return(0,x.h)(ar,this.frame.up,-c),(0,x.h)(Na,this.frame.right,l),(0,x.g)(ar,ar,Na),(0,x.n)(ar,ar),function Yl(d,i,l){(0,Pe.hZ)(d,(0,x.f)(l,i.right),(0,x.f)(l,i.up))}(Ua,this.frame,ar),Ua}get rotationAngle(){const i=Math.sign((0,x.f)(this.frame.right,this.vRight));return(0,x.v)(fs,this.vLeft),-i*(Math.PI-(0,xt.XM)((0,x.f)(fs,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*(0,xt.J_)(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(i,l){const c=this.rotationAngle;if(0===Math.abs(c))return l;const h=(0,xt.J_)(Math.cos(.5*c)),u=this.rotationRight,p=Ra(Xl,1+(h-1)*u[0]*u[0],(h-1)*u[0]*u[1],(h-1)*u[0]*u[1],1+(h-1)*u[1]*u[1]);return(0,Pe.ZF)(i,l,p)}}function Zl(d){switch(d){case mt.World:return new Kl;case mt.Path:return new $l}}const Sr=(0,S.vt)(),Ua=(0,le.vt)(),ar=(0,S.vt)(),Na=(0,S.vt)(),fs=(0,S.vt)(),St=(0,S.vt)(),nr=(0,S.vt)(),Ba=(0,S.vt)(),Tr=(0,S.vt)(),gs=(0,S.vt)(),Xl=[1,0,0,1];var or=v(43167),lr=v(6698),Ar=v(9933),Ql=v(62393),cr=v(96443),Jl=v(20482);class kl extends Ql.W{constructor(){super(...arguments),this.ambient=(0,S.CN)(.2,.2,.2),this.diffuse=(0,S.CN)(.8,.8,.8),this.specular=(0,S.CN)(0,0,0),this.opacity=1,this.origin=(0,S.vt)(),this.modelTransformation=null,this.mrrFactors=Mr.mb,this.emissiveFactor=S.uY,this.texture=null,this.textureNormal=null,this.textureEmissive=null,this.textureOcclusion=null,this.textureMetallicRoughness=null}}class ql extends Lt.w{constructor(i,l){super(i,l,new wt.$(Jl.P,()=>v.e(3672).then(v.bind(v,43672))),Va)}initializePipeline(i){const{output:l,transparent:c,hasSlicePlane:h,doubleSidedMode:u,hasOccludees:p,oitPass:f}=i,g=f===cr.Y.NONE,_=f===cr.Y.FrontFace;return(0,Ee.Ey)({blending:(0,de.RN)(l)&&c?(0,Ge.Yf)(f):null,culling:h&&!c&&u!==lr.W.None?Ee.hG:null,depthTest:{func:(0,Ge.K_)(f)},depthWrite:g||_?Ee.Uy:null,drawBuffers:l===de.V.Depth?{buffers:[Oe.Hr.NONE]}:(0,Ge.m6)(f,l),colorWrite:Ee.kn,stencilWrite:p?ze.v0:null,stencilTest:p?ze.qh:null,polygonOffset:g||_?null:Ge.SE})}}const Va=new Map([[D.r.POSITION,0],[D.r.PROFILERIGHT,1],[D.r.PROFILEUP,2],[D.r.PROFILEVERTEXANDNORMAL,3],[D.r.FEATUREVALUE,4],[D.r.OBJECTANDLAYERIDCOLOR,5]]);var ks=v(66874);class rt extends ss.E{constructor(i,l){super(),this.spherical=i,this.doublePrecisionRequiresObfuscation=l,this.pbrMode=Ar.A9.Disabled,this.doubleSidedMode=lr.W.None,this.emissionSource=or.ZX.None,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.transparent=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=ks.I.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!1,this.objectAndLayerIdColorInstanced=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1}get discardInvisibleFragments(){return this.transparent}}(0,se._)([(0,ge.W)({count:Ar.A9.COUNT})],rt.prototype,"pbrMode",void 0),(0,se._)([(0,ge.W)({count:lr.W.COUNT})],rt.prototype,"doubleSidedMode",void 0),(0,se._)([(0,ge.W)({count:or.ZX.COUNT})],rt.prototype,"emissionSource",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"receiveShadows",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"receiveAmbientOcclusion",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"vvSize",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"vvColor",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"vvOpacity",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"transparent",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"hasOccludees",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"terrainDepthTest",void 0),(0,se._)([(0,ge.W)()],rt.prototype,"cullAboveTerrain",void 0);class ec extends yt.im{constructor(i,l){super(i,sc),this._vertexBufferLayout=function tc(){const d=(0,Is.BP)().vec3f(D.r.POSITION).vec4f(D.r.PROFILERIGHT).vec4f(D.r.PROFILEUP).vec4f(D.r.PROFILEVERTEXANDNORMAL).vec4f(D.r.FEATUREVALUE);return(0,Ft.E)()&&d.vec4u8(D.r.OBJECTANDLAYERIDCOLOR),d}(),this.vertexAttributeLocations=Va,this.supportsEdges=!0,this.produces=new Map([[Ve.N.OPAQUE_MATERIAL,c=>(this.parameters.castShadows&&(0,de.PJ)(c)||(0,de.iq)(c))&&!this.parameters.transparent],[Ve.N.TRANSPARENT_MATERIAL,c=>(this.parameters.castShadows&&(0,de.PJ)(c)||(0,de.iq)(c))&&this.parameters.transparent]]),this._configuration=new rt(l.spherical,l.doublePrecisionRequiresObfuscation)}get hasEmissions(){return!(0,x.p)(this.parameters.emissiveFactor,S.uY)}getConfiguration(i,l){return this._configuration.output=i,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=l.hasOccludees,(0,de.RN)(i)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?lr.W.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?lr.W.WindingOrder:lr.W.None,this._configuration.receiveShadows=l.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=null!=l.ssao):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?Ar.A9.Schematic:Ar.A9.Disabled,this._configuration.emissionSource=this.parameters.usePBR?or.ZX.Value:or.ZX.None,this._configuration.oitPass=l.oitPass,this._configuration.terrainDepthTest=l.terrainDepthTest,this._configuration.cullAboveTerrain=l.cullAboveTerrain,this._configuration}isVisibleForOutput(i){return i!==de.V.Shadow&&i!==de.V.ShadowExcludeHighlight&&i!==de.V.ShadowHighlight||this.parameters.castShadows}get visible(){return this.parameters.opacity>=Xr.Q}intersect(i,l,c,h,u,p){const f=i;if(!Ea(f))return;const g=f.path,_=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSize){const{offset:w,factor:N,minSize:K,maxSize:z}=this.parameters.vvSize,H=g.sizeAttributeValue;_[0]*=(0,xt.qE)(w[0]+H*N[0],K[0],z[0]),_[1]*=(0,xt.qE)(w[2]+H*N[2],K[2],z[2])}const y=new Xs.JG(!1,c.options.normalRequired),b=Math.max(_[0],_[1]),P=i.boundingInfo;if(null==P)return void Ga(g,_,h,u,y,p);const E=(0,R.fA)(P.bbMin[0]-b,P.bbMin[1]-b,P.bbMin[2]-b,P.bbMax[0]+b,P.bbMax[1]+b,P.bbMax[2]+b),O=[u[0]-h[0],u[1]-h[1],u[2]-h[2]],C=Math.sqrt(O[0]*O[0]+O[1]*O[1]+O[2]*O[2]);(0,Xs.Wb)(E,h,[C/O[0],C/O[1],C/O[2]],c.tolerance)&&Ga(g,_,h,u,y,p)}createBufferWriter(){return new ts.Z(this._vertexBufferLayout)}createGLMaterial(i){return new rc(i)}}class rc extends es.A{beginSlot(i){return this.getTechnique(ql,i)}}function Ga(d,i,l,c,h,u){d.baked.size&&d.baked.size[0]===i[0]&&d.baked.size[1]===i[1]||d.baked.bake(i),d.baked.intersect(l,c,h,u)}class sc extends kl{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.usePBR=!1}}const ic=["polyline"];function za(d,i,l){const{origin:c,positions:h}=d;let u=d.offset;switch(i){default:case mt.World:for(const p of d.vertices)Te[0]=h[u++]+c[0],Te[1]=h[u++]+c[1],Te[2]=h[u++]+c[2],l.worldUpAtPosition(Te,Te),p.setFrameFromUpVector(Te);break;case mt.Path:Te[0]=h[u]+c[0],Te[1]=h[u+1]+c[1],Te[2]=h[u+2]+c[2],l.worldUpAtPosition(Te,Te),function _l(d,i){let l=null;const c=d.vertices.length,h=.99619469809,u=(0,S.vt)(),p=(0,S.vt)(),f=(0,S.vt)(),g=(0,S.vt)(),_=(0,S.vt)(),y=(0,S.vt)(),b=(0,Se.vt)();let P=d.vertices[0];(0,x.c)(p,i),(0,x.i)(u,0,1,0),(0,gr.Xl)(P.vRight,p,u,u,f,p,h),(0,x.c)(P.frame.up,p),(0,x.c)(P.frame.right,f);const E=d.positions;let O=d.offset;l=P;for(let C=1;C<c;++C){P=d.vertices[C],(0,x.g)(_,P.vLeft,P.vRight);let A=(0,x.l)(_);A>0?(A=1/Math.sqrt(A),_[0]=_[0]*A,_[1]=_[1]*A,_[2]=_[2]*A):(_[0]=P.vRight[0],_[1]=P.vRight[1],_[2]=P.vRight[2]),y[0]=E[O]+l.frame.up[0],y[1]=E[O+1]+l.frame.up[1],y[2]=E[O+2]+l.frame.up[2],O+=3;const w=(0,x.i)(yl,E[O],E[O+1],E[O+2]);(0,Se.O_)(w,_,b),(0,Se.Ui)(b,(0,vl.LV)(y,P.vLeft),g)?(g[0]-=E[O],g[1]-=E[O+1],g[2]-=E[O+2],(0,x.n)(p,g),(0,x.e)(f,_,p),(0,x.n)(f,f)):(0,gr.Xl)(_,l.frame.up,l.frame.right,u,f,p,h),(0,x.c)(P.frame.up,p),(0,x.c)(P.frame.right,f),l=P}}(d,Te)}}function Wa(d,i,l){switch(d){case"symbol-value":return l;case"proportional":return i;default:return d}}function nc(d,i,l,c){let h=0;const{origin:u,vertices:p,positions:f,positionsES:g}=d,_=d.offset+3*p.length;for(let y=d.offset;y<_;y+=3)(0,x.i)(Te,g[y],g[y+1],g[y+2]),l(Te,qs),h+=qs.sampledElevation,Te[0]=f[y]+u[0],Te[1]=f[y+1]+u[1],Te[2]=f[y+2]+u[2],c.setAltitude(Te,qs.z),f[y]=Te[0]-u[0],f[y+1]=Te[1]-u[1],f[y+2]=Te[2]-u[2];return d.updatePathVertexInformation(),h/p.length}const Te=(0,S.vt)(),qs=new L.Uk;var lc=v(87477),cc=v(70744);function ja(d,i,l,c,h=1){(0,x.i)(Ht,1,0,0),(0,x.i)(Kt,0,1,0),(0,x.i)(dr,0,0,1),function uc(d,i){(0,x.i)(Rr,0,0,0);for(let l=0;l<i.length-3;l+=3)Rr[0]+=i[l],Rr[1]+=i[l+1],Rr[2]+=i[l+2];(0,x.h)(d,Rr,1/(i.length/3-1))}(ei,l),(0,Se.ci)(Fa,l)&&function dc(d,i,l,c,h,u){null!=h?(h.basisMatrixAtPosition(u,ft),(0,x.i)(vs,ft[0],ft[1],ft[2]),(0,x.i)(_s,ft[4],ft[5],ft[6]),(0,x.i)(ti,ft[8],ft[9],ft[10])):((0,x.i)(vs,1,0,0),(0,x.i)(_s,0,1,0),(0,x.i)(ti,0,0,1));const p=(0,Se.Qj)(d);(0,x.f)(p,ti)<0&&(0,x.h)(p,p,-1),(0,x.c)(c,p);const f=(0,x.f)(p,_s),g=(0,x.f)(p,vs);Math.abs(f)>Math.abs(g)?((0,x.b)(i,vs,p,-g),(0,x.n)(i,i),(0,x.e)(l,i,p),(0,x.n)(l,l),(0,x.h)(l,l,-1)):((0,x.b)(l,_s,p,-f),(0,x.n)(l,l),(0,x.e)(i,l,p),(0,x.n)(i,i))}(Fa,Ht,Kt,dr,c,ei),(0,Pe.hZ)(Ie,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,Pe.hZ)($t,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let y=0;y<l.length;y+=3){(0,x.i)(hr,l[y],l[y+1],l[y+2]);const b=(0,x.f)(Ht,hr),P=(0,x.f)(Kt,hr);Ie[0]=Math.min(Ie[0],b),Ie[1]=Math.min(Ie[1],P),$t[0]=Math.max($t[0],b),$t[1]=Math.max($t[1],P)}const u=(0,x.f)(dr,ei);ri(Tt,Ie[0],Ie[1],u,Ht,Kt,dr),ri(Yt,$t[0],Ie[1],u,Ht,Kt,dr),ri(Zt,Ie[0],$t[1],u,Ht,Kt,dr),(0,x.d)(Yt,Yt,Tt),(0,x.h)(Yt,Yt,.5),(0,x.d)(Zt,Zt,Tt),(0,x.h)(Zt,Zt,.5),(0,x.g)(Tt,Tt,Yt),(0,x.g)(Tt,Tt,Zt);const g=Ie[0]-Ie[0]%h,_=Ie[1]-Ie[1]%h;for(let y=0;y<l.length;y+=3){(0,x.i)(hr,l[y],l[y+1],l[y+2]);const b=y/3,P=4*b;d[P]=((0,x.f)(Ht,hr)-g)/h,d[P+1]=((0,x.f)(Kt,hr)-_)/h,d[P+2]=g/h,d[P+3]=_/h;const E=9*b;for(let O=0;O<3;O++)i[E+O]=Tt[O],i[E+O+3]=Yt[O],i[E+O+6]=Zt[O]}}const ei=(0,S.vt)(),hr=(0,S.vt)(),Fa=(0,Se.vt)(),Ht=(0,S.vt)(),Kt=(0,S.vt)(),dr=(0,S.vt)(),Ie=(0,le.vt)(),$t=(0,le.vt)(),Tt=(0,S.vt)(),Yt=(0,S.vt)(),Zt=(0,S.vt)(),ft=(0,Z.vt)(),vs=(0,S.vt)(),_s=(0,S.vt)(),ti=(0,S.vt)(),Rr=(0,S.vt)();function ri(d,i,l,c,h,u,p){(0,x.i)(d,i*h[0]+l*u[0]+c*p[0],i*h[1]+l*u[1]+c*p[1],i*h[2]+l*u[2]+c*p[2])}var Ha=v(25079),Ka=v(45434),bt=v(81671),$a=v(53670),Ya=v(38499),pc=v(97665);class mc extends Lt.w{constructor(i,l){super(i,l,new wt.$(pc.P,()=>v.e(6755).then(v.bind(v,36755))),(0,Ft.E)()?Xa:Za)}_setPipelineState(i,l){const{oitPass:c,output:h,cullFace:u,draped:p,hasOccludees:f,polygonOffset:g,enableOffset:_}=i,y=c===cr.Y.NONE,b=c===cr.Y.FrontFace;return(0,Ee.Ey)({blending:(0,de.RN)(h)?(0,Ge.Yf)(c):null,culling:(0,Ee.Xt)(u),depthTest:p?null:{func:(0,Ge.K_)(c)},depthWrite:(0,Ge.z5)(i),drawBuffers:h===de.V.Depth?{buffers:[Oe.Hr.NONE]}:(0,Ge.m6)(c,h),colorWrite:Ee.kn,stencilWrite:f?ze.v0:null,stencilTest:f?l?ze.a9:ze.qh:null,polygonOffset:y||b?g?fc:null:(0,Ge.aB)(_)})}initializePipeline(i){return this._occludeePipelineState=this._setPipelineState(i,!0),this._setPipelineState(i,!1)}getPipeline(i){return i?this._occludeePipelineState:super.getPipeline()}}const fc={factor:1,units:1},Za=new Map([[D.r.POSITION,0],[D.r.COLOR,3],[D.r.UVMAPSPACE,4],[D.r.COLORFEATUREATTRIBUTE,5],[D.r.BOUNDINGRECT,6]]),Xa=new Map([[D.r.POSITION,0],[D.r.COLOR,3],[D.r.UVMAPSPACE,4],[D.r.COLORFEATUREATTRIBUTE,5],[D.r.BOUNDINGRECT,6],[D.r.OBJECTANDLAYERIDCOLOR,9]]);class nt extends ss.E{constructor(){super(...arguments),this.cullFace=De.s2.None,this.style=bt.O.Horizontal,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=ks.I.None,this.emissionSource=or.ZX.None,this.discardInvisibleFragments=!0,this.writeDepth=!0,this.occlusionPass=!1,this.hasVvInstancing=!1,this.vvSize=!1,this.vvOpacity=!1,this.objectAndLayerIdColorInstanced=!1}}(0,se._)([(0,ge.W)({count:De.s2.COUNT})],nt.prototype,"cullFace",void 0),(0,se._)([(0,ge.W)({count:bt.O.COUNT})],nt.prototype,"style",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"hasVertexColors",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"polygonOffset",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"hasOccludees",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"enableOffset",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"terrainDepthTest",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"cullAboveTerrain",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"vvColor",void 0),(0,se._)([(0,ge.W)()],nt.prototype,"draped",void 0);class si extends $a.W{constructor(i){super(i,yc),this._configuration=new nt,this.vertexAttributeLocations=(0,Ft.E)()?Xa:Za,this.supportsEdges=!0,this.produces=new Map([[Ve.N.OPAQUE_MATERIAL,l=>(0,de.CL)(l)],[Ve.N.TRANSPARENT_MATERIAL,l=>(0,de.RN)(l)],[Ve.N.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,l=>(0,de.eh)(l)],[Ve.N.DRAPED_MATERIAL,l=>this.parameters.draped&&(0,de.Mb)(l)]])}getConfiguration(i,l){return this._configuration.output=i,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=l.oitPass,this._configuration.enableOffset=l.camera.relativeElevation<Ge.xt,this._configuration.terrainDepthTest=l.terrainDepthTest&&(0,de.RN)(i),this._configuration.cullAboveTerrain=l.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=Xr.Q}createGLMaterial(i){return new gc(i)}createBufferWriter(){const i=(0,Is.BP)().vec3f(D.r.POSITION).vec4f(D.r.UVMAPSPACE);return this.parameters.draped||i.mat3f(D.r.BOUNDINGRECT),this.parameters.vvColor?i.f32(D.r.COLORFEATUREATTRIBUTE):i.vec4u8(D.r.COLOR),(0,Ft.E)()&&i.vec4u8(D.r.OBJECTANDLAYERIDCOLOR),new vc(i)}}class gc extends es.A{beginSlot(i){return this.getTechnique(mc,i)}}class vc extends ts.Z{write(i,l,c,h,u,p){(0,Ya.SA)(c,h,this.vertexBufferLayout,i,l,u,p);for(const f of this.vertexBufferLayout.fields.keys()){const g=c.get(f),_=g?.indices;if(g&&_)switch(f){case D.r.UVMAPSPACE:{(0,Ns.vA)(4===g.size);const y=u.getField(f,Ka.Eq);y&&(0,Ya.Ut)(g,y,p);break}case D.r.BOUNDINGRECT:{(0,Ns.vA)(9===g.size);const y=u.getField(f,Ka.jZ);y&&_c(g,i,y,p);break}}}}}function _c(d,i,l,c){const{data:h,indices:u}=d,p=i,f=l.typedBuffer,g=l.typedBufferStride,_=u.length;c*=g;for(let y=0;y<_;++y){const b=9*u[y],P=h[b],E=h[b+1],O=h[b+2];f[c]=p[0]*P+p[4]*E+p[8]*O+p[12],f[c+1]=p[1]*P+p[5]*E+p[9]*O+p[13],f[c+2]=p[2]*P+p[6]*E+p[10]*O+p[14];for(let C=3;C<9;++C)f[c+C]=h[b+C];c+=g}}class yc extends Hi.S{constructor(){super(...arguments),this.color=(0,we.fA)(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=De.s2.None,this.hasOccludees=!1,this.style=bt.O.Cross,this.draped=!0}}function Ec(d,i){if(function bc(d){return d.material instanceof si&&!d.material.parameters.draped}(d)){const l=d.attributes.get(D.r.POSITION).data;ja(d.getMutableAttribute(D.r.UVMAPSPACE).data,d.getMutableAttribute(D.r.BOUNDINGRECT).data,l,i)}}function Mc(d,i,l,c,h){const u=(0,ct.B6)(d,i,l,c,h),p=d.stageObject.geometries;for(const f of p)Ec(f,h);return u}const Oc=["polyline","polygon","extent"],Qa=new Me.wI({size:!1,color:!0,rotation:!1,opacity:!1});class ys extends he.U{constructor(i,l,c,h){super(i,l,c,h),this._needsUV=!1}doLoad(){var i=this;return(0,B.A)(function*(){i._fastUpdates=(0,Me.s_)(i._context.renderer,Qa)})()}_createMaterials(){if(this._materials.length>0)return;const i=this.symbolLayer?.material?.color,l=this._getCombinedOpacityAndColor(i);this._materials[Ae.Fill]=function xc(d,i){const l=d?.pattern;return null==l?new Ha.v(i):"none"===l.style||"solid"===l.style?("none"===l.style&&(i.color=(0,we.fA)(0,0,0,0),i.forceTransparentMode=!0),new Ha.v(i)):(i.style=function Pc(d){switch(d){case"horizontal":return bt.O.Horizontal;case"vertical":return bt.O.Vertical;case"cross":return bt.O.Cross;case"forward-diagonal":return bt.O.ForwardDiagonal;case"backward-diagonal":return bt.O.BackwardDiagonal;case"diagonal-cross":return bt.O.DiagonalCross;default:return}}(l.style),new si(i))}(this.symbolLayer,{color:l,forceTransparentMode:this.needsDrivenTransparentPass,discardInvisibleFragments:!0,polygonOffset:!1,hasVertexColors:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[Ae.Fill]instanceof si;const c=this.symbolLayer.outline;if(function Tc(d){return null!=d?.size&&d.size>0&&null!=d.color&&(null==d.pattern||"style"!==d.pattern.type||"none"!==d.pattern.style)}(c)){const h=(0,$i.Xq)(c.pattern);this._materials[Ae.Outline]=new xr.W({width:(0,Le.Lz)(c.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:h,cap:ws(c.patternCap||"butt")})}this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry,Oc,this.symbolLayer.type))return null;const c=this._getVertexOpacityAndColor(i.renderingInfo,255),h=this.setGraphicElevationContext(l);return this.ensureDrapedStatus("on-the-ground"===h.mode),this._createMaterials(),this.draped?this._createAsOverlay(l,c):this._createAs3DShape(l,c,h)}applyRendererDiff(i,l){for(const c in i.diff){if("visualVariables"!==c||!(0,Me.J_)(this._fastUpdates,l,Qa))return G.w.RecreateSymbol;this._materials[Ae.Fill]?.setParameters(this._fastUpdates.materialParameters)}return G.w.FastUpdate}layerOpacityChanged(){if(null!=this._materials[Ae.Fill]){const i=this._materials[Ae.Fill].parameters.color,l=this.symbolLayer?.material?.color,c=this._getCombinedOpacity(l);this._materials[Ae.Fill].setParameters({color:[i[0],i[1],i[2],c],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[Ae.Outline]){const i=this._materials[Ae.Outline].parameters.color;this._materials[Ae.Outline].setParameters({color:[i[0],i[1],i[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(i,l,c){const h=this._elevationContext.mode,u=(0,L.I2)(ys.elevationModeChangeTypes,c,h);if(u!==L.uw.UPDATE)return u;const p=(0,L.nu)(h);return this.updateGraphics3DGraphicElevationInfo(i,l,()=>p)}slicePlaneEnabledChanged(){return this._materials[Ae.Fill]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[Ae.Outline]&&this._materials[Ae.Outline].setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(i,l,c){const h=ur(i.geometry);if(!h)return null;const u=Vr(h,this._context.elevationProvider,this._context.renderCoordsHelper,c),p=new Cc(u,l,this._context.layer.uid,i.uid),f=p.renderData.position.length/3;if(this._needsUV&&(p.uvMapSpace=(0,Qe.oe)(4*f,!0),p.boundingRect=(0,U.jh)(9*f,!0),ja(p.uvMapSpace,p.boundingRect,p.renderData.position,this._context.renderCoordsHelper)),p.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(p),this._createAs3DShapeFill(i,p),this._materials[Ae.Outline]&&this._createAs3DShapeOutline(p),this._logGeometryCreationWarnings(p.renderData,h.rings,"rings","FillSymbol3DLayer"),0===p.outGeometries.length)return null;const g=new Qt.B({geometries:p.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i.uid}),_=new Q.Y(this,g,p.outGeometries,null,null,Mc,c);return _.alignedSampledElevation=p.renderData.sampledElevation,_.needsElevationUpdates=(0,L.nu)(c.mode),_}_createAs3DShapeFill(i,l){const c=l.renderData.polygons;for(const{position:h,mapPositions:u,holeIndices:p,index:f,count:g}of c){if(null!=this._context.clippingExtent&&((0,R.vY)(u,At),!(0,R.KG)(At,this._context.clippingExtent)))continue;const _=gt(u,p,this._context.elevationProvider.spatialReference);if(0===_.length)continue;const y=this._fastUpdates?.visualVariables.color,b=li({material:this._materials[Ae.Fill],indices:_,mapPositions:u,attributeData:{position:h,color:y?null:l.color,colorFeature:y?(0,Me.ul)(y.field,i):null,uvMapSpace:this._needsUV?(0,Qe.AK)(l.uvMapSpace,4*f,4*g):null,boundingRect:this._needsUV?(0,U.l5)(l.boundingRect,9*f,9*g):null,objectAndLayerIdColor:l.objectAndLayerIdColor}});l.outGeometries.push(b)}}_createAs3DShapeOutline(i){if(null==this._materials[Ae.Outline])return;const l=i.renderData.outlines;for(const{mapPositions:c,position:h}of l){if(null!=this._context.clippingExtent&&((0,R.vY)(c,At),!(0,R.KG)(At,this._context.clippingExtent)))continue;const u=(0,Ls.t)(this._materials[Ae.Outline],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:c,attributeData:{position:h}},i.objectAndLayerIdColor);i.outGeometries.push(u)}}_createAsOverlay(i,l){const c=ur(i.geometry);if(null==c)return null;this._materials[Ae.Fill].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[Ae.Outline]&&(this._materials[Ae.Outline].renderPriority=this._renderPriority);const h=pi(c,this._context.overlaySR),u=new Sc(h,l,this._context.layer.uid,i.uid);return this._needsUV&&(u.uvMapSpace=(0,Qe.oe)(u.renderData.position.length/3*4,!0),function hc(d,i,l,c,h=1){if(l.isGeographic&&c===j.RT.Global){const _=(0,U.jh)(i.length),y=i.length,b=(0,lc.tO)(l);for(let P=0;P<y;P+=3)(0,cc.RC)(i,P,_,P,b);i=_}(0,Pe.hZ)(Ie,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let _=0;_<i.length;_+=3)Ie[0]=Math.min(Ie[0],i[_]),Ie[1]=Math.min(Ie[1],i[_+1]);const f=Ie[0]-Ie[0]%h,g=Ie[1]-Ie[1]%h;for(let _=0;_<i.length;_+=3){const y=_/3*4;d[y]=(i[_]-f)/h,d[y+1]=(i[_+1]-g)/h,d[y+2]=f/h,d[y+3]=g/h}}(u.uvMapSpace,u.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),u.outBoundingBox=(0,R.Ie)(),u.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(u),this._createAsOverlayFill(i,u),this._materials[Ae.Outline]&&this._createAsOverlayOutline(u),this._logGeometryCreationWarnings(u.renderData,c.rings,"rings","FillSymbol3DLayer"),0===u.outGeometries.length?null:new $r(this,u.outGeometries,u.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(i,l){const c=l.renderData.polygons;for(const{position:h,holeIndices:u,index:p,count:f}of c){const g=(0,R.vY)(h,At);if(!(0,R.KG)(g,this._context.clippingExtent))continue;const _=(0,re.e)(h,u,3);if(0===_.length)continue;(0,R.RF)(l.outBoundingBox,g);const y=this._fastUpdates?.visualVariables.color,b=li({material:this._materials[Ae.Fill],indices:_,attributeData:{position:h,color:y?null:l.color,colorFeature:y?(0,Me.ul)(y.field,i):null,uvMapSpace:this._needsUV?(0,Qe.AK)(l.uvMapSpace,4*p,4*f):null,objectAndLayerIdColor:l.objectAndLayerIdColor}});l.outGeometries.push(new vr.$(b,l))}}_createAsOverlayOutline(i){if(null==this._materials[Ae.Outline])return;const l=i.renderData.outlines;for(let c=0;c<l.length;++c){const{position:h}=l[c];if((0,R.vY)(h,At),!(0,R.KG)(At,this._context.clippingExtent))continue;(0,R.RF)(i.outBoundingBox,At);const u=(0,Ls.t)(this._materials[Ae.Outline],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:h}},i.objectAndLayerIdColor);i.outGeometries.push(new vr.$(u,i))}}_getOutlineOpacity(){const i=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(null!=i?i.a:0)}_getOutlineColor(){const i=this.symbolLayer?.outline?.color,l=this._getOutlineOpacity();return(0,k.$C)(null!=i?Xe.A.toUnitRGB(i):null,l)}test(){return{...super.test(),createAsOverlay:(i,l)=>this._createAsOverlay(i,l),createAs3DShape:(i,l,c)=>this._createAs3DShape(i,l,c)}}}ys.elevationModeChangeTypes={definedChanged:L.uw.RECREATE,staysOnTheGround:L.uw.NONE,onTheGroundChanged:L.uw.RECREATE};const At=(0,R.vt)();class Cc extends Ur{constructor(i,l,c,h){super(i,c,h),this.color=l}}class Sc extends Ur{constructor(i,l,c,h){super(i,c,h),this.color=l}}var Ae;!function(d){d[d.Fill=0]="Fill",d[d.Outline=1]="Outline"}(Ae||(Ae={}));var Ja=v(34619),Ac=v(42132);class Rc{constructor(i,l="center",c=!1,h=(0,le.vt)(),u=(0,we.fA)(0,0,0,-1),p="world",f=(0,S.vt)(),g=0){this.verticalOffset=i,this.anchor=l,this.hasLabelVerticalOffset=c,this.screenOffset=h,this.centerOffset=u,this.centerOffsetUnits=p,this.translation=f,this.elevationOffset=g}}class Dc{constructor(i,l="center",c="center",h=null,u=(0,le.vt)(),p=!0){this.placement=i,this.horizontalPlacement=l,this.verticalPlacement=c,this.text=h,this.displaySize=u,this.isFocused=p}}var wc=v(45716),ka=v(98894);class ii{constructor(i){this.definition=i,this.key=JSON.stringify(i),this.haloSize=Math.round(i.halo.size),this.textStyle=qa(i.color),this.haloStyle=function Lc(d){return`rgb(${d.slice(0,3).map(i=>Math.floor(255*i)).toString()})`}(i.halo.color),this.backgroundStyle=0!==i.background.color[3]?qa(i.background.color):null}fontString(i){const l=this.definition.font;return`${l.style} ${l.weight} ${i}px ${l.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(i,l){i.font=this.fontString(l),i.textAlign="left",i.textBaseline="alphabetic"}static fromSymbol(i,l){return(0,B.A)(function*(){const c=i?.material?.color,h=Xe.A.toUnitRGBA(c)??we.uY,u=null!=i.size?(0,Le.Lz)(i.size):12,p=i.lineHeight,f=null!=i.background?Xe.A.toUnitRGBA(i.background.color):we.uY,g={family:i.font?.family??"sans-serif",decoration:i.font?.decoration??"none",weight:i.font?.weight??"normal",style:i.font?.style??"normal"},_=i.halo,y=null!=_?.color&&_.size>0?{size:(0,Le.Lz)(_.size),color:Xe.A.toUnitRGBA(_.color)}:{size:0,color:we.uY},b=new ii({color:h,size:u,background:{color:f,padding:null!=i.background?[.65*u,.5*u]:[0,0],borderRadius:null!=i.background?u*(6/16):0},lineSpacingFactor:p,font:g,halo:y,pixelRatio:l});if(i.font){let P=!1;const E=b.fontString(u);try{P=(yield document.fonts.load(E)).some(O=>!(0,ka.NZ)(O))}catch{ne.A.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${E}'. Some text symbology may be rendered using the default browser font.`)}if(!P&&!Ic.has(i.font.family))try{yield(0,ka.Al)(i.font)}catch{}}return b})()}}function qa(d){return`rgba(${d.slice(0,3).map(i=>Math.floor(255*i)).toString()},${d[3]})`}const Ic=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);var Uc=v(72951),Nc=v(67864),Bc=v(42425),Vc=v(33894),ai=v(53781),Gc=v(42263),ni=v(7084),zc=v(34150),Wc=v(5714),jc=v(76169),Fc=v(4931);const Rt=4096;let Dr=class extends Ai.A{constructor(d){super(d),this.type=fe.X.Texture,this.id=(0,Vc.c)(),this.events=new Bc.A,this._glTexture=null,this._atlas=new Kc(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,st.WD)(this._glTexture),this._frameWorker=(0,st.xt)(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return wr=Gc.G.stableRendering?Et:0,[Rt-Et-wr,Rt-Et-wr-en]}load(d){if(this._glTexture)return this._glTexture;const i=new Fc.R;return i.wrapMode=Oe.pF.CLAMP_TO_EDGE,i.samplingMode=Oe.Cj.LINEAR_MIPMAP_LINEAR,i.hasMipmap=!0,i.preMultiplyAlpha=!0,i.maxAnisotropy=d.parameters.maxMaxAnisotropy,this._glTexture=new jc.g(d,i,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(zc.W6.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,st.xt)(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=(0,st.WD)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(d){this._canvas.width=d.width,this._canvas.height=d.height}_resizeAtlas(d,i){const{width:l,height:c}=this._atlas;l===d&&c===i||(this._atlas.width=d,this._atlas.height=i,this._glTexture?.resize(d,i),this._glTexture?.updateData(0,0,0,l,c,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(h=>this._uvCallbacks.get(h.textRenderer.key)?.forEach(u=>u(h.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(d,i,l,c){const h=this._atlas;if(h.width<l||h.height<c)return!1;let u=h.cursors.get(c);if(!u){if(h.height<h.nextY+c)return!1;u=[new tn(h.nextY)],h.cursors.set(c,u),h.nextY+=c}let p=u.find(f=>h.width>=f.x+l);if(null==p){if(h.height<h.nextY+c)return!1;p=new tn(h.nextY),h.nextY+=c,u.push(p)}return d.setNewPosition(p),this._elements.set(i,d),this._elementsToRender.set(i,d),p.x+=l,!0}_ensureCallbacks(d){const i=this._uvCallbacks.get(d);if(i)return i;const l=new Set;return this._uvCallbacks.set(d,l),l}_addCallback(d,i){this._ensureCallbacks(d).add(i)}_removeCallback(d,i){const l=this._uvCallbacks.get(d);return!(!l?.delete(i)||0!==l.size||(this._uvCallbacks.delete(d),0))}_processAddition(d){const i=d.textRenderer.key;if(this._needsRepack)return void this._elements.set(i,d);const l=this._atlas,u=d.textRenderer.renderedWidth+Et,p=d.textRenderer.renderedHeight+Et+en;if(!this._addAtlasElement(d,i,u,p)){if(this._canRepack)this._reset();else if(l.width<u){const f=Math.min((0,ni.Mv)(Math.max(u,1.5*l.width)),Rt);this._resizeAtlas(f,l.height)}else{const g=Math.min((0,ni.Mv)(Math.max(l.nextY+p,1.5*l.height)),Rt);if(g>l.height)this._resizeAtlas(l.width,g);else if(l.width<Rt){const _=Math.min((0,ni.Mv)(1.5*l.width),Rt);this._resizeAtlas(_,l.height)}}this._elements.set(i,d)}}_renderElement(d){const i=d.commitNewPosition(),l=d.textRenderer;this._ctx.clearRect(i[0]-Et,i[1]-Et,l.renderedWidth+2*Et,l.renderedHeight+2*Et),l.render(this._ctx,i[0],i[1]),this._uvCallbacks.get(l.key)?.forEach(c=>c(d.uv))}get running(){return this.updating}runTask(d){if(null==this._glTexture)return Wc.G;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Rt&&this._atlas.height<Rt);){this._canRepack=this._needsRepack=!1;const i=this._elements;this._elements=new Map,i.forEach(l=>this._processAddition(l)),d.madeProgress()}if(this._elementsToRender.size>0){for(const[i,l]of this._elementsToRender){if(d.done)break;this._renderElement(l),this._elementsToRender.delete(i),d.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(d,i){const l=d.key;this._addCallback(l,i);let c=this._elements.get(l);return c?(0,ai.a)(c.uv,we.uY)||i(c.uv):(c=new Hc(this._atlas,d),this._processAddition(c),this.setDirty()),{remove:()=>this._removeText(d,i)}}_removeText(d,i){const l=d.key;this._elements.get(l)&&this._removeCallback(l,i)&&(this._elements.delete(l),this._elementsToRender.delete(l),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};(0,se._)([(0,tt.MZ)({constructOnly:!0})],Dr.prototype,"view",void 0),(0,se._)([(0,tt.MZ)({type:Boolean})],Dr.prototype,"updating",void 0),Dr=(0,se._)([(0,jr.$)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Dr);const Et=2,en=2;class Hc{constructor(i,l){this._atlas=i,this.textRenderer=l,this._uv=(0,we.vt)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return we.uY;const{renderedWidth:i,renderedHeight:l}=this.textRenderer;return(0,ai.s)(this._uv,this._xOffset/this._atlas.width,(this._yOffset+l)/this._atlas.height,(this._xOffset+i)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(i){this._newPosition[0]=i.x,this._newPosition[1]=i.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class Kc{constructor(i,l){this.width=i,this.height=l,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=wr}}class tn{constructor(i){this.y=i,this.x=wr}}let wr=0;class $c{constructor(i,l,c){this._renderer=new Nc.Js(i,l,c,Dr.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const i=(0,Uc.y)(Yc,this._renderer.renderedWidth,this._renderer.renderedHeight),l=i.getContext("2d");return l.save(),this._renderer.render(l,0,0),l.restore(),new Yr.g(i,{wrap:{s:Oe.pF.CLAMP_TO_EDGE,t:Oe.pF.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}}const Yc={canvas:null},Zc=(0,S.CN)(0,0,1);function rn(d,i,l){d?.forEach(c=>{const h=i(c);null!=h&&l(h,c.graphic)})}const Jc={mode:"relative-to-ground",offset:0};var kc=v(82595),qc=(v(4194),v(18853));class eh extends Lt.w{constructor(i,l){super(i,l,new wt.$(qc.W,()=>v.e(1859).then(v.bind(v,41859))))}initializePipeline(i){const{oitPass:l,output:c,transparent:h,draped:u,enableOffset:p}=i,f=l===cr.Y.NONE,g=l===cr.Y.FrontFace;return(0,Ee.Ey)({blending:c!==de.V.Normal&&c!==de.V.Highlight&&c!==de.V.ObjectAndLayerIdColor&&h?(0,Ge.Yf)(l):null,depthTest:u?null:{func:(0,Ge.K_)(l)},depthWrite:(0,Ge.z5)(i),drawBuffers:(0,Ge.m6)(l,c),colorWrite:Ee.kn,polygonOffset:f||g?null:(0,Ge.aB)(p)})}}class th extends es.A{ensureResources(i){return this._techniques.context.waterTextures.ensureResources(i)}beginSlot(i){const l=this._techniques.context.waterTextures.passParameters;return this._material.setParameters({wavePerturbation:l.wavePerturbation,waveNormal:l.waveNormal}),this.getTechnique(eh,i)}}class ot extends ss.E{constructor(i,l){super(),this.spherical=i,this.doublePrecisionRequiresObfuscation=l,this.receiveShadows=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=ks.I.None,this.emissionSource=or.ZX.None,this.pbrMode=Ar.A9.Water,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!0,this.highStepCount=!0,this.useFillLights=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}}(0,se._)([(0,ge.W)()],ot.prototype,"receiveShadows",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"transparent",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"enableOffset",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"writeDepth",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"screenSpaceReflections",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"cloudReflections",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"objectAndLayerIdColorInstanced",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"draped",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"terrainDepthTest",void 0),(0,se._)([(0,ge.W)()],ot.prototype,"cullAboveTerrain",void 0);class rh extends $a.W{constructor(i,l){super(i,sn),this.produces=new Map([[Ve.N.OPAQUE_MATERIAL,c=>(0,de.RN)(c)&&!this.parameters.transparent||(0,de.CL)(c)],[Ve.N.TRANSPARENT_MATERIAL,c=>(0,de.RN)(c)&&this.parameters.transparent||(0,de.CL)(c)],[Ve.N.DRAPED_MATERIAL,c=>this.parameters.draped&&(0,de.RN)(c)||(0,de.CL)(c)],[Ve.N.DRAPED_WATER,c=>c===de.V.Normal]]),this._configuration=new ot(l.spherical,l.doublePrecisionRequiresObfuscation)}getConfiguration(i,l){return this._configuration.output=i,this._configuration.writeDepth=!0,this._configuration.receiveShadows=l.shadowMap.enabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.screenSpaceReflections=null!=l.ssr.lastFrameColor,this._configuration.cloudReflections=null!=l.clouds.data,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=l.oitPass,this._configuration.enableOffset=l.camera.relativeElevation<Ge.xt,this._configuration.terrainDepthTest=l.terrainDepthTest&&(0,de.RN)(i),this._configuration.cullAboveTerrain=l.cullAboveTerrain,this._configuration}get visible(){return!0}update(i){return this.setParameters({timeElapsed:(0,kc.y)(i.time)*this.parameters.animationSpeed},!1),this._animationEnabled(i.camera)&&i.dt>0}_animationEnabled(i){const l=Math.min(i.relativeElevation,i.distance);return Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*l<sh}createGLMaterial(i){return new th(i)}createBufferWriter(){return new ts.Z((0,Ft.E)()?rs.Dq:rs.zK)}get test(){}}class sn extends yt.qA{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=(0,le.fA)(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=(0,we.fA)(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.origin=(0,S.vt)(),this.modelTransformation=null}}const sh=35e3,ih={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},ah=["polyline","polygon","extent"];class Mt extends he.U{constructor(i,l,c,h){super(i,l,c,h)}doLoad(){return(0,B.A)(function*(){})()}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry,ah,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(l);return this.ensureDrapedStatus("on-the-ground"===c.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(l):this._createAs3DShape(l,c,l.uid)}ensureMaterial(){if(this._materials[0])return;const i=new sn,l=this.symbolLayer.color;null!=l&&(i.color=Xe.A.toUnitRGBA(l));const c=this._getCombinedOpacity(l,{hasIntrinsicColor:!0});i.color=[i.color[0],i.color[1],i.color[2],c],i.transparent=c<1||this.needsDrivenTransparentPass,i.waveDirection=null!=this.symbolLayer.waveDirection?function nh(d){const i=(0,le.vt)(),l=(0,Aa.DF)(d);return i[0]=Math.sin(l),i[1]=Math.cos(l),i}(this.symbolLayer.waveDirection):(0,le.fA)(0,0);const u=ih[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];i.waveStrength=u.waveStrength,i.waveTextureRepeat=u.textureRepeat,i.waveVelocity=u.waveVelocity,i.flowStrength=u.perturbationStrength,i.hasSlicePlane=this._context.slicePlaneEnabled,i.draped=this.draped,this._materials[0]=new rh(i,this._context),this._context.stage.add(this._materials[0])}layerOpacityChanged(){if(null==this._materials[0])return;const i=this._materials[0].parameters.color,l=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});this._materials[0].setParameters({color:[i[0],i[1],i[2],l],transparent:l<1||this.needsDrivenTransparentPass})}layerElevationInfoChanged(i,l,c){const h=this._elevationContext.mode,u=(0,L.I2)(Mt.elevationModeChangeTypes,c,h);if(u!==L.uw.UPDATE)return u;const p=(0,L.nu)(h);return this.updateGraphics3DGraphicElevationInfo(i,l,()=>p)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(i,l,c){const h=ur(i.geometry);if(null==h)return null;const u=Vr(h,this._context.elevationProvider,this._context.renderCoordsHelper,l),p=u.position.length/3,f=(0,U.jh)(2*p);an(f,u.mapPositions,p,this._context.elevationProvider.spatialReference);const g=new oh(u,f,this._context.layer.uid,i.uid);if(g.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(g),this._create3DShapeGeometries(g),this._logGeometryCreationWarnings(g.renderData,h.rings,"rings","WaterSymbol3DLayer"),0===g.outGeometries.length)return null;const _=new Qt.B({geometries:g.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:c}),y=new Q.Y(this,_,g.outGeometries,null,null,ct.B6,l);return y.alignedSampledElevation=g.renderData.sampledElevation,y.needsElevationUpdates=(0,L.nu)(l.mode),y}_create3DShapeGeometries(i){const l=i.renderData.polygons,c=i.uvCoords;for(const{count:h,index:u,position:p,mapPositions:f,holeIndices:g}of l){if(null!=this._context.clippingExtent&&((0,R.vY)(f,Lr),!(0,R.KG)(Lr,this._context.clippingExtent)))continue;const _=(0,re.e)(f,g,3);if(0===_.length)continue;const y=(0,U.l5)(c,2*u,2*h),b=ci({material:this._materials[0],indices:_,mapPositions:f,attributeData:{position:p,uv0:y}},i.objectAndLayerIdColor);i.outGeometries.push(b)}}_createAsOverlay(i){const l=ur(i.geometry);if(null==l)return null;this._materials[0].renderPriority=this._renderPriority;const c=pi(l,this._context.overlaySR),h=c.position.length/3,u=(0,U.jh)(2*h);an(u,c.position,h,this._context.overlaySR);const p=new lh(c,u,this._context.layer.uid,i.uid);return p.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(p),p.outBoundingBox=(0,R.Ie)(),this._createAsOverlayWater(p),this._logGeometryCreationWarnings(p.renderData,l.rings,"rings","WaterSymbol3DLayer"),0===p.outGeometries.length?null:new $r(this,p.outGeometries,p.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(i){const l=i.uvCoords,c=i.renderData.polygons;for(const{position:h,holeIndices:u,index:p,count:f}of c){if((0,R.vY)(h,Lr),!(0,R.KG)(Lr,this._context.clippingExtent))continue;(0,R.RF)(i.outBoundingBox,Lr);const g=(0,re.e)(h,u,3);if(0===g.length)continue;const _=(0,U.l5)(l,2*p,2*f),y=ci({material:this._materials[0],indices:g,attributeData:{position:h,uv0:_}},i.objectAndLayerIdColor);i.outGeometries.push(new vr.$(y,i))}}test(){return{...super.test(),create3DShape:i=>this._createAs3DShape(i.graphic,i.elevationContext,i.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}function an(d,i,l,c){const h=(0,ve.GA)(c);(0,Kr.Ie)(Dt);for(let f=0;f<l;f++)(0,Pe.hZ)(nn,i[3*f],i[3*f+1]),(0,Kr.tK)(Dt,nn);(0,ai.b)(Dt,Dt,h);const p=Dt[1]%Mt.unitSizeOfTexture;xs[0]=Dt[0]-Dt[0]%Mt.unitSizeOfTexture,xs[1]=Dt[1]-p;for(let f=0;f<l;f++)d[2*f]=(i[3*f]*h-xs[0])/Mt.unitSizeOfTexture,d[2*f+1]=(i[3*f+1]*h-xs[1])/Mt.unitSizeOfTexture}Mt.unitSizeOfTexture=100,Mt.elevationModeChangeTypes={definedChanged:L.uw.RECREATE,staysOnTheGround:L.uw.NONE,onTheGroundChanged:L.uw.RECREATE};const xs=(0,le.vt)(),Dt=(0,Kr.vt)(),nn=(0,le.vt)(),Lr=(0,R.vt)();class oh extends Ur{constructor(i,l,c,h){super(i,c,h),this.uvCoords=l}}class lh extends Ur{constructor(i,l,c,h){super(i,c,h),this.uvCoords=l}}function ch(d,i,l,c){const h=dh[d.type]?.[i.type]||on[i.type];return h?new h(d,i,l,c):(ne.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${i.type}`),null)}const on={icon:_r,object:class rl extends he.U{getCachedSize(){const[i,l,c]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:i,depth:l,height:c}}constructor(i,l,c,h){super(i,l,c,h),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=c.physicalBasedRenderingEnabled}doLoad(i){var l=this;return(0,B.A)(function*(){if(!l._drivenProperties.size){const c=(0,k.Hj)(l.symbolLayer);if(c)throw new Error(c)}if(l._isPrimitive){const c=l.symbolLayer.resource,h=c&&(0,ha.k)(c?.primitive)?c.primitive:Fo.r;l._resources=yield l._createResourcesForPrimitive(h,i)}else{const c=yield function el(d){return Ks.apply(this,arguments)}(l.symbol.styleOrigin),h=c?.href??l.symbolLayer.resource?.href;l._resources=yield l._createResourcesForUrl(h,i)}l.layerOpacityChanged(),l.slicePlaneEnabledChanged(),l.physicalBasedRenderingChanged(),l.complexity=l.computeComplexity()})()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){return!this.symbolLayer.resource?.href}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}_setMaterialTransparencyParameters(i,l=this.symbolLayer?.material?.color){const c=this._getCombinedOpacity(l),h=c<1||this.needsDrivenTransparentPass;return i.transparent=h,i.opacity=c,i.cullFace=h?De.s2.None:De.s2.Back,i}_createResourcesForPrimitive(i,l){var c=this;return(0,B.A)(function*(){const h=c.symbolLayer,u=(0,R.vt)((0,ls.Fq)(i)),p=(0,S.ci)((0,R.Ej)(u)),f=(0,S.ci)((0,ls.Bb)(p,h)),g=(0,x.l)(f),b=c.symbolLayer?.material?.emissiveFactor,P=b?(0,x.F)((0,S.o8)(b)):S.uY,E={usePBR:c._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:Mr.Bt,ambient:S.Un,diffuse:S.Un,hasSlicePlane:c._context.slicePlaneEnabled,castShadows:c.symbolLayer.castShadows,emissiveFactor:P,offsetTransparentBackfaces:!c.symbolLayer.isPrimitive},O=!!E.usePBR;c._setMaterialTransparencyParameters(E);const C=c.symbol;if("point-3d"===C.type&&C.verticalOffset){const{screenLength:H,minWorldLength:I,maxWorldLength:q}=C.verticalOffset;E.verticalOffset={screenLength:(0,Le.Lz)(H),minWorldLength:I||0,maxWorldLength:q??1/0},E.castShadows=!1}if(c._context.screenSizePerspectiveEnabled&&(E.screenSizePerspective=c._context.sharedResources.screenSizePerspectiveSettings),c._drivenProperties.color)E.externalColor=we.Un;else{const H=null!=h.material?h.material.color:null,I=null!=H?Xe.A.toUnitRGBA(H):we.Un;E.externalColor=I}c._fastUpdates=(0,Me.s_)(c._context.renderer,c._fastVisualVariableConvertOptions(u,f,p,null)),E.isInstanced=!0,c._fastUpdates?(Object.assign(E,c._fastUpdates.materialParameters),c._optionalFields.push(D.r.FEATUREATTRIBUTE)):c._hasPerInstanceColor()&&(E.hasInstancedColor=!0,c._optionalFields.push(D.r.COLOR)),(0,Ft.E)()&&c._optionalFields.push(D.r.OBJECTANDLAYERIDCOLOR);const A=new Jt.$U(E,c._context),w=(0,ha._)(i,A);if(!w)throw new Error(`Unknown object symbol primitive: ${i}`);const N=w.getMaterials().map(H=>({opacity:1,transparent:H.parameters.transparent})),K=yield c._createStageResources(w,O,l),z=yield c._createLodRenderer(w,l);return new pa(w,z,K,N,p,!1,!1,u,f,g,O,null)})()}_createResourcesForUrl(i,l){var c=this;return(0,B.A)(function*(){const u={spherical:c._context.spherical,doublePrecisionRequiresObfuscation:c._context.doublePrecisionRequiresObfuscation,materialParameters:{isInstanced:!0,hasSlicePlane:c._context.slicePlaneEnabled,castShadows:c.symbolLayer.castShadows},streamDataRequester:c._context.streamDataRequester,cache:c._context.sharedResources.objectResourceCache};c._fastUpdates=(0,Me.s_)(c._context.renderer,c._fastVisualVariableConvertOptions(null,null,null,null)),c._fastUpdates?(Object.assign(u.materialParameters,c._fastUpdates.materialParameters),c._optionalFields.push(D.r.FEATUREATTRIBUTE)):c._hasPerInstanceColor()&&(u.materialParameters.hasInstancedColor=!0,c._optionalFields.push(D.r.COLOR)),(0,Ft.E)()&&c._optionalFields.push(D.r.OBJECTANDLAYERIDCOLOR);const p=c.symbol;if("point-3d"===p.type&&p.verticalOffset){const{screenLength:ye,minWorldLength:Ne,maxWorldLength:Fe}=p.verticalOffset;u.materialParameters.verticalOffset={screenLength:(0,Le.Lz)(ye),minWorldLength:Ne||0,maxWorldLength:Fe??1/0},u.materialParameters.castShadows=!1}const f=c._context.physicalBasedRenderingEnabled;u.signal=l,u.usePBR=f,u.skipHighLods=c._context.skipHighSymbolLods;const g=yield(0,ko.fetch)(i,u),_=g.isEsriSymbolResource,y=g.isWosr,b=function Xo(d){return new cs.Fe(d.map((i,l)=>function Zo(d,i){const l=d.stageResources.geometries.map(h=>new cs.iC(new cs.dI(h),d.stageResources.textures)),c=null==d.lodThreshold||0===d.lodThreshold&&i>0?function Qo(d){const i=d.reduce((l,c)=>l+c.numTriangles,0);return Math.sqrt(i*Jo/Math.PI)}(l):d.lodThreshold;return new cs.hr(l,c,d.pivotOffset)}(i,l)))}(g.lods),P=c._context,O=c._getExternalColorParameters(c.symbolLayer.material),C=c.symbolLayer?.material?.color,A=c._getCombinedOpacity(C,{hasIntrinsicColor:!0}),w=c.needsDrivenTransparentPass,N=b.getMaterials(),K=b.getMaterials().map(ye=>({opacity:ye.parameters.opacity||1,transparent:ye.parameters.transparent}));N.forEach(ye=>{const Ne=ye.parameters;ye.setParameters(O);const Fe=Ne.opacity*A;ye.setParameters({opacity:Fe,transparent:Fe<1||w||Ne.transparent}),P.screenSizePerspectiveEnabled&&ye.setParameters({screenSizePerspective:P.sharedResources.screenSizePerspectiveSettings})});const z=g.referenceBoundingBox,H=(0,S.ci)((0,R.Ej)(z)),I=(0,S.ci)(b.levels[0].pivotOffset),q=(0,S.ci)((0,ls.Bb)(H,c.symbolLayer)),ie=(0,x.l)(q),ee=c._fastUpdates;(0,Me.J_)(ee,c._context.renderer,c._fastVisualVariableConvertOptions(z,q,H,I))&&N.forEach(ye=>ye.setParameters(ee.materialParameters));const ae=yield c._createStageResources(b,f,l),Ue=yield c._createLodRenderer(b,l);return new pa(b,Ue,ae,K,H,_,y,z,q,ie,f,I)})()}_addDisposeResource(i){this._disposeResourceHandles.push(i)}_createStageResources(i,l,c){var h=this;return(0,B.A)(function*(){const u=h._context.stage,p=i.getMaterials();l!==h._context.physicalBasedRenderingEnabled&&h.physicalBasedRenderingChanged(),u.addMany(p),h._addDisposeResource(()=>u.removeMany(p));const f=i.getTextures();u.addMany(f),h._addDisposeResource(()=>{f.forEach(_=>_.unload()),u.removeMany(f)}),yield Promise.all(f.map(_=>h._context.stage.schedule(()=>_.load(u.renderView.renderingContext),c))),(0,vt.Te)(c);const g=i.getEngineGeometries();return u.addMany(g),h._addDisposeResource(()=>u.removeMany(g)),{materials:p,textures:f,geometries:g}})()}_createLodRenderer(i,l){var c=this;return(0,B.A)(function*(){const h=c._context.stage,u={layerUid:c._context.layer.uid,graphicUid:_=>c._instanceIndexToGraphicUid.get(_),notifyGraphicGeometryChanged:_=>c._context.notifyGraphicGeometryChanged(c._instanceIndexToGraphicUid.get(_)),notifyGraphicVisibilityChanged:_=>c._context.notifyGraphicVisibilityChanged(c._instanceIndexToGraphicUid.get(_))},p=c._fastUpdates,g=new tl.L({symbol:i,optionalFields:c._optionalFields,metadata:u,shaderTransformation:p?{applyTransform:(_,y,b)=>{_.getFeatureAttribute(y,hs),(0,J.C)(b,(0,Me.b3)(p.materialParameters,hs,b))},scaleFactor:(_,y,b)=>{y.getFeatureAttribute(b,hs),(0,Me.VC)(_,p.materialParameters,hs)}}:null},c._context.scheduler);return g.slicePlaneEnabled=c._context.slicePlaneEnabled,c._addDisposeResource(()=>{h.removeRenderPlugin(g),g.destroy()}),yield h.addRenderPlugin(g,l),g})()}_getExternalColorParameters(i){const l={};return this._drivenProperties.color?l.externalColor=we.Un:null!=i?.color?l.externalColor=Xe.A.toUnitRGBA(i.color):(l.externalColor=we.Un,l.colorMixMode="ignore"),l}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(i=>i()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry))return null;const c=(0,We.ZX)(l.geometry);if(null==c)return this.logger.warn(`unsupported geometry type for object symbol: ${l.geometry.type}`),null;const h=this.setGraphicElevationContext(l);return this._createAs3DShape(l,c,i.renderingInfo,h,l.uid,i.layer.uid)}notifyDestroyGraphicLayer(i){this._instanceIndexToGraphicUid.delete(i.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null==this._resources)return;const i=this._drivenProperties.opacity,l=!this._isPrimitive,c=this._resources.stageResources.materials,h=this._resources.originalMaterialParameters;for(let u=0;u<c.length;u++){const p=c[u],f=this.symbolLayer?.material?.color,g=h[u],_=this._getCombinedOpacity(f,{hasIntrinsicColor:l})*g.opacity,y=_<1||i||g.transparent;p.setParameters({opacity:_,transparent:y}),this._isPrimitive&&p.setParameters({cullFace:y?De.s2.None:De.s2.Back})}}layerElevationInfoChanged(i,l){return this.updateGraphics3DGraphicElevationInfo(i,l,L.Kf)}slicePlaneEnabledChanged(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const i of this._resources.stageResources.materials)i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const{stageResources:i,isWosr:l}=this._resources;for(const c of i.materials)this._isPrimitive?c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):l||c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(i,l){if(null==this._resources)return G.w.RecreateSymbol;const{stageResources:{materials:c},lodRenderer:h,resourceBoundingBox:u,symbolSize:p,resourceSize:f,pivotOffset:g}=this._resources;for(const _ in i.diff){if("visualVariables"!==_||!(0,Me.J_)(this._fastUpdates,l,this._fastVisualVariableConvertOptions(u,p,f,g)))return G.w.RecreateSymbol;for(const y of c)y.setParameters(this._fastUpdates.materialParameters);h.notifyShaderTransformationChanged()}return G.w.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();const i=this._resources.lodResources,l=(0,ca.pg)(i.levels),c=i.computeUsedMemory(),h={...(0,ca.GI)(this.symbol,this.symbolLayer),resourceBytes:c};return new qo.rz({verticesPerFeature:l,memory:h})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(i,l,c,h,u,p){if(!this._hasLodRenderer()||null==this._resources)return null;const f=this.getFastUpdateAttrValues(i),g=this._context.clippingExtent;if((0,Ti.g)(l,ir,this._context.elevationProvider.spatialReference),null!=g&&!(0,R.Uc)(g,ir))return null;const _=fa(h),y=this._computeGlobalTransform(l,h,$s,ds),b=this._computeLocalTransform(this._resources,this.symbolLayer,c,ga),P=this._resources.lodRenderer.instanceData,E=P.addInstance();this._instanceIndexToGraphicUid.set(E,u),P.setLocalTransform(E,b,!1),P.setGlobalTransform(E,y),f&&P.setFeatureAttribute(E,f),null==this._fastUpdates&&this._hasPerInstanceColor()&&P.setColor(E,(0,k.$C)(c.color,c.opacity,255));const O=this._context.stage.renderView.olidRenderHelper;O&&P.setObjectAndLayerIdColor(E,O.getObjectAndLayerIdColor({graphicUid:u,layerUid:p}));const C=new Ko(this,E,ct.Jf,h,this._context.stage.view.state.highlightOrderMap);return _&&(C.alignedSampledElevation=ds.sampledElevation),C.needsElevationUpdates=(0,L.Kf)(h.mode),(0,We.d2)(C,l,this._context.elevationProvider),C}_computeGlobalTransform(i,l,c,h){return(0,L.sE)(i,this._context.elevationProvider,l,this._context.renderCoordsHelper,h),ir[0]=i.x,ir[1]=i.y,ir[2]=h.z,(0,W.l)(i.spatialReference,ir,c,this._context.renderCoordsHelper.spatialReference),c}_computeLocalTransform(i,l,c,h){return(0,J.D_)(h),this._applyObjectRotation(c,!1,h),this._applyObjectRotation(l,!0,h),this._applyObjectScale(i,c,h),this._applyAnchor(i,l,h),h}_applyObjectScale(i,l,c){if(this._fastUpdates?.requiresShaderTransformation)return;const u=(0,k.pW)(this._drivenProperties.size&&l.size?l.size:i.symbolSize,i.symbolSize,i.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===u[0]&&1===u[1]&&1===u[2]||(0,J.hs)(c,c,u)}prepareSymbolLayerPatch(i){if("partial"!==i.diff.type)return;const l=i.diff.diff;this._preparePatchTransform(i,l),this._preparePatchColor(i,l)}updateGeometry(i,l){if(null==this._resources)return!0;const c=l&&(0,We.ZX)(l);if(null==c)return!1;const h=this.getGeometryElevationMode(l);return i.elevationContext.mode===h&&(this._computeGlobalTransform(c,i.elevationContext,$s,ds),fa(i.elevationContext)&&(i.alignedSampledElevation=ds.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(i.instanceIndex,$s,!0),(0,We.d2)(i,c,this._context.elevationProvider),!0)}_preparePatchTransform(i,l){if(!(l.heading||l.tilt||l.roll||l.width||l.height||l.depth||l.anchor||l.anchorPosition)||null==this._resources)return;const c=(O,C,A)=>(null!=O&&"complete"===O.type?O.newValue:C)??A,h=c(l.heading,this.symbolLayer.heading,0),u=c(l.tilt,this.symbolLayer.tilt,0),p=c(l.roll,this.symbolLayer.roll,0),f=c(l.width,this.symbolLayer.width,void 0),g=c(l.height,this.symbolLayer.height,void 0),_=c(l.depth,this.symbolLayer.depth,void 0),y=c(l.anchor,this.symbolLayer.anchor,void 0),b=c(l.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete l.heading,delete l.tilt,delete l.roll,delete l.width,delete l.height,delete l.depth,delete l.anchor,delete l.anchorPosition;const P={heading:h,tilt:u,roll:p,anchor:y,anchorPosition:b},E=this._resources;this.loadStatus===Yo.P.LOADED&&i.symbolLayerStatePatches.push(()=>{E.symbolSize=(0,S.ci)((0,ls.Bb)(E.resourceSize,{width:f,height:g,depth:_,isPrimitive:this.symbolLayer.isPrimitive}))}),i.graphics3DGraphicPatches.push(({instanceIndex:O},C)=>{const A=this._computeLocalTransform(E,P,C,ga);E.lodRenderer.instanceData.setLocalTransform(O,A,!0)})}_preparePatchColor(i,l){if(!l.material||"partial"!==l.material.type)return;const c=l.material.diff;if(!c.color||"complete"!==c.color.type||null==c.color.newValue||null==c.color.oldValue)return;const h=c.color.newValue,u=null!=h?Xe.A.toUnitRGBA(h):we.Un;delete c.color;const p=this._resources;null!=p&&i.graphics3DGraphicPatches.push(({instanceIndex:f})=>{let g;this._hasPerInstanceColor()?(p.lodRenderer.instanceData.setColor(f,u),g=this._setMaterialTransparencyParameters({},h)):g=this._setMaterialTransparencyParameters({externalColor:u},h);for(const _ of p.stageResources.materials)_.setParameters(g)})}_applyObjectRotation(i,l,c){if(!this._fastUpdates?.requiresShaderTransformation||!l)return(0,k.$2)(i.heading,i.tilt,i.roll,c)}_applyAnchor(i,l,c){if(this._fastUpdates?.requiresShaderTransformation)return;const h=ma(i.resourceBoundingBox,i.pivotOffset,l);h&&(0,J.Tl)(c,c,h)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(i,l,c,h){const u=null!=i?(0,S.ci)((0,R.Ej)(i)):S.Un,p=null!=i?ma(i,h,this.symbolLayer):S.uY,f=this._context.renderCoordsHelper.unitInMeters,g=(0,k.pW)(l??void 0,l,c,f),_=(0,S.fA)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new Me.wI({size:!0,color:!0,rotation:!0,opacity:!1},u,l??S.Un,f,p,g,_)}},line:Qr,path:class ac extends he.U{get usedMemory(){return this._usedMemory+super.usedMemory}constructor(i,l,c,h){super(i,l,c,h),this._intrinsicSize=(0,le.fA)(1,1),this._upVectorAlignment=mt.Path,this._stencilWidth=.1,this._usedMemory=0,this.ensureDrapedStatus(!1)}doLoad(){var i=this;return(0,B.A)(function*(){const l=null!=i.symbolLayer.width?i.symbolLayer.width:i.symbolLayer.height,c=null!=i.symbolLayer.height?i.symbolLayer.height:l;i._vvConvertOptions=new Me.wI({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[l,1,c],i._context.renderCoordsHelper.unitInMeters);const h=i._context.renderer?.visualVariables;i._fastUpdates=h?.length?(0,Me.s_)(i._context.renderer,i._vvConvertOptions):null;const u=i.symbolLayer.anchor||"center";i._upVectorAlignment="heading"===i.symbolLayer.profileRotation?mt.World:mt.Path;const p=i.symbolLayer.profile||"circle";switch(p){default:case"circle":i._profile=xl[u];break;case"quad":i._profile=Pl[u]}switch(i.symbolLayer.join){case"round":i._extruder=new Zs(0,us.kf);break;case"bevel":i._extruder=new Zs(0,1);break;case"miter":i._extruder=new Zs(.8*Math.PI,1);break;default:i._extruder=new nl}const f=i.symbolLayer.cap||"butt";switch(f){case"none":i._startCap=new va,i._endCap=new va;break;case"butt":default:i._startCap=new ms(i._profile,0),i._endCap=new ms(i._profile,0,!0);break;case"square":i._startCap=new ms(i._profile,-.5),i._endCap=new ms(i._profile,.5,!0);break;case"round":{const A="quad"===p;i._startCap=new _a({profile:i._profile,flip:!1,breakNormals:A,subdivisions:us.RL}),i._endCap=new _a({profile:i._profile,flip:!0,breakNormals:A,subdivisions:us.RL});break}}const g=i.symbolLayer?.material?.emissiveFactor,_=g?(0,x.F)((0,S.o8)(g)):S.uY,y=i.symbolLayer?.material?.color,b=i._getCombinedOpacityAndColor(y),P=(0,S.ci)(b),E=b[3],O=E<1||i.needsDrivenTransparentPass,C={diffuse:P,ambient:P,emissiveFactor:_,opacity:E,transparent:O,hasVertexColors:!1,hasSlicePlane:i._context.slicePlaneEnabled,castShadows:i.symbolLayer.castShadows,cullFace:O||"none"===f?De.s2.None:De.s2.Back,offsetTransparentBackfaces:!0};if(!i._drivenProperties.size&&((0,Pe.hZ)(i._intrinsicSize,l,c),!(0,k.Mh)(i._intrinsicSize[0])||!(0,k.Mh)(i._intrinsicSize[1])))throw new oe.A("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(i._fastUpdates?.visualVariables.size||(0,Pe.hs)(i._intrinsicSize,i._intrinsicSize,1/i._context.renderCoordsHelper.unitInMeters),i._fastUpdates){const A={...C,...i._fastUpdates.materialParameters,size:(0,le.ci)(i._intrinsicSize)};i._materials[0]=new ec(A,i._context)}else C.hasVertexColors=i._drivenProperties.color||i._drivenProperties.opacity,C.normalType=vi.W.Compressed,i._materials[0]=new Jt.$U(C,i._context);i._materials[0].setParameters({usePBR:i._context.physicalBasedRenderingEnabled,isSchematic:!0}),i._context.stage.add(i._materials[0])})()}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry,ic,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(l);return this._createAs3DShape(l,i.renderingInfo,c,l.uid)}layerOpacityChanged(){const i=this.symbolLayer?.material?.color,l=this._getCombinedOpacity(i),c=l<1||this.needsDrivenTransparentPass;this._materials[0]?.setParameters({opacity:l,transparent:c})}layerElevationInfoChanged(i,l){return this.updateGraphics3DGraphicElevationInfo(i,l,L.Kf)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._materials[0]?.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(i,l){for(const c in i.diff){if("visualVariables"!==c||!(0,Me.J_)(this._fastUpdates,l,this._vvConvertOptions))return G.w.RecreateSymbol;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return G.w.FastUpdate}_getVertexData(i){let l=0;const c=i.paths,h=[],u=i.spatialReference,p=this._context.elevationProvider.spatialReference,f=this._context.renderCoordsHelper.spatialReference;for(const b of c)l+=b.length;const g=(0,U.jh)(3*l);let _,y=0;for(const b of c){h.push({offset:y,numVertices:b.length});for(const P of b)g[y++]=P[0],g[y++]=P[1],g[y++]=i.hasZ?P[2]:0}return null==p||u.equals(p)||(0,Nr.projectBuffer)(g,u,0,g,p,0,l)?(null==p||p.equals(f)?_=(0,U.xm)(g):(_=(0,U.jh)(3*l),(0,Nr.projectBuffer)(g,p,0,_,f,0,l)),{pathVertexDataInfos:h,vertexDataES:g,vertexDataRS:_}):null}_createAs3DShape(i,l,c,h){this._usedMemory=0;const u=i.geometry,p=this._getVertexData(u);if(null==p)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===p.pathVertexDataInfos.length)return 0!==u.paths.length&&u.paths.some(O=>O.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const f=new Array,g=u.spatialReference,_=(0,R.vt)(),y=this._context.renderCoordsHelper,b=new di.aY(p.vertexDataES);for(const O of p.pathVertexDataInfos){const C=O.numVertices;if(C<2)continue;const A=O.offset;if(null!=this._context.clippingExtent&&((0,R.Rz)(p.vertexDataES,A,C,_),!(0,R.KG)(_,this._context.clippingExtent)))continue;const w=new Array,N=A+3*C;for(let ee=A;ee<N;ee+=3){b.offset=ee;const ae=(0,L.nG)(b,this._context.elevationProvider,c,y);(0,x.i)(Te,p.vertexDataRS[ee],p.vertexDataRS[ee+1],p.vertexDataRS[ee+2]),y.setAltitude(Te,ae),p.vertexDataRS[ee]=Te[0],p.vertexDataRS[ee+1]=Te[1],p.vertexDataRS[ee+2]=Te[2],w.push(Zl(this._upVectorAlignment))}const K=new sl(w,p.vertexDataES,p.vertexDataRS,A);za(K,this._upVectorAlignment,this._context.renderCoordsHelper);const z=new il(K,this._profile,this._extruder,this._startCap,this._endCap);let H=null;if(this._fastUpdates){const ee=this._fastUpdates.visualVariables,ae=(0,Me.ul)(ee.size?.field,i)??0,Ue=(0,Me.ul)(ee.color?.field,i)??0,ye=(0,Me.ul)(ee.opacity?.field,i)??0;H=new hl(z,ae,Ue,ye)}else{const ee=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const ye=l.size;ee[0]*=Wa(ye[0],"symbol-value"===ye[2]?this.symbolLayer.height||0:ye[2],this.symbolLayer.width||0),ee[1]*=Wa(ye[2],"symbol-value"===ye[0]?this.symbolLayer.width||0:ye[0],this.symbolLayer.height||0)}let ae;this._drivenProperties.color&&(ae=l.color),this._drivenProperties.opacity&&null!=l.opacity&&(ae=ae?[ae[0],ae[1],ae[2],l.opacity]:[1,1,1,l.opacity]);const Ue=new Oa(z);Ue.bake(ee),ae&&Ue.bakeVertexColors(ae),H=Ue}const I=H.createGeometryData(),q=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:h,layerUid:this._context.layer.uid}),ie=new cl(this._materials[0],I,H,g,this._stencilWidth,q);ie.transformation=(0,J.Tl)((0,Z.vt)(),Z.zK,z.path.origin),f.push(ie),this._usedMemory+=z.usedMemory}if(0===f.length)return null;const P=new Qt.B({geometries:f,layerUid:this._context.layer.uid,graphicUid:h}),E=new Q.Y(this,P,f,null,null,(O,C,A,w,N)=>function oc(d,i,l,c,h){const u=d.stageObject,p=u.geometries;let f=0;for(const g of p){if(!Ea(g))continue;const _=g.path,y=_.builder.path;f+=nc(y,0,l,c),h!==mt.World&&za(y,h,c),_.onPathChanged(g),g.invalidateBoundingInfo(),u.geometryVertexAttributeUpdated(g,D.r.POSITION)}return f/p.length}(O,0,w,N,this._upVectorAlignment),c);return E.alignedSampledElevation=0,E.needsElevationUpdates=(0,L.Kf)(c.mode),E}},fill:ys,extrude:class mn extends he.U{constructor(i,l,c,h){super(i,l,c,h),this.ensureDrapedStatus(!1)}doLoad(){var i=this;return(0,B.A)(function*(){if(!i._drivenProperties.size){const y=(0,k.Hj)(i._getSymbolSize());if(y)throw new oe.A("graphics3dextrudesymbollayer:invalid-size",y)}const l=i.symbolLayer?.material?.color,c=i._getCombinedOpacityAndColor(l),h=(0,S.ci)(c),u=c[3],p=u<1||i.needsDrivenTransparentPass,f=i.symbolLayer?.material?.emissiveFactor,g=f?(0,x.F)((0,S.o8)(f)):S.uY,_={usePBR:i._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:h,ambient:h,opacity:u,transparent:p,cullFace:p?De.s2.None:De.s2.Back,hasVertexColors:!0,hasSlicePlane:i._context.slicePlaneEnabled,castShadows:i.symbolLayer.castShadows,emissiveFactor:g,offsetTransparentBackfaces:!0,normalType:vi.W.Compressed};i._materials[et.Main]=new Jt.$U(_,i._context),i._materials[et.Bottom]=new Jt.$U({..._,cullFace:De.s2.Back},i._context),i._context.stage.addMany(i._materials)})()}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry,pn,this.symbolLayer.type))return null;const c=this._getVertexOpacityAndColor(i.renderingInfo,255),h=this.setGraphicElevationContext(l);return this._createAs3DShape(l,i.renderingInfo,c,h,l.uid)}layerOpacityChanged(i,l){const c=this.symbolLayer?.material?.color,h=this._getCombinedOpacity(c),u=h<1||this.needsDrivenTransparentPass;this._materials[et.Main]?.setParameters({opacity:h,transparent:u}),this._materials[et.Bottom]?.setParameters({opacity:h,transparent:u});const p=this._getLayerOpacity();i.forEach(f=>l(f)?.layerOpacityChanged(p,this._context.isAsync))}layerElevationInfoChanged(i,l){return this.updateGraphics3DGraphicElevationInfo(i,l,L.Kf)}slicePlaneEnabledChanged(i,l){return this._materials[et.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[et.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),i.forEach(c=>{const h=l(c);h?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const i={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[et.Main]?.setParameters(i),this._materials[et.Bottom]?.setParameters(i),!0}_getExtrusionSize(i){let l;return l=i.size&&this._drivenProperties.size?(0,X.kg)(i.size,2)??0:this._getSymbolSize(),l/=this._context.renderCoordsHelper.unitInMeters,l}applyRendererDiff(i,l){return this._drivenPropertiesChanged(l)?G.w.RecreateSymbol:G.w.RecreateGraphics}queryForSnapping(i,l,c,h){var u=this;return(0,B.A)(function*(){const p=u._getExtrusionSize(c)*u._context.renderCoordsHelper.unitInMeters/(0,ve.G9)(l),{objectId:f,target:g}=i,_=(0,pe.o8)(g);switch(_.z=(_.z??0)+p,i.type){case"edge":{const{start:y,end:b}=i,P=(0,pe.o8)(y),E=(0,pe.o8)(b);return P.z=(P.z??0)+p,E.z=(E.z??0)+p,[(0,T.P)(f,_,1/0,P,E)]}case"vertex":return[(0,T.k)(f,_,1/0),(0,T.P)(f,g,1/0,g,_)];default:return[]}})()}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(i,l,c,h,u){const p=ur(i.geometry);if(null==p)return null;if(0===p.rings.length||!p.rings.some(ae=>ae.length>0))return this._logGeometryValidationWarnings(p.rings,"rings","ExtrudeSymbol3DLayer"),null;const f=Vr(p,this._context.elevationProvider,this._context.renderCoordsHelper,h);this._logGeometryCreationWarnings(f,p.rings,"rings","ExtrudeSymbol3DLayer");const g=(0,k.W$)(p);if(null==g)return null;const _=new Array,y=new Array,b=(0,R.vt)(),P=(0,Z.vt)(),E=(0,S.vt)(),O=this._context.renderCoordsHelper.viewingMode===j.RT.Global;O||this._context.renderCoordsHelper.worldUpAtPosition(null,E),(0,W.l)(p.spatialReference,[g.x,g.y,0],P,this._context.renderCoordsHelper.spatialReference);const C=(0,Z.vt)();(0,J.B8)(C,P);const A=(0,me.vt)();(0,_e.Ge)(A,C);const{polygons:w,mapPositions:N,position:K}=f,z=new Map,H=this._materials[et.Main];for(const ae of w){const Ue=ae.count;if(this._context.clippingExtent&&((0,R.vY)(ae.mapPositions,b),!(0,R.KG)(b,this._context.clippingExtent)))continue;const ye=(0,re.e)(ae.mapPositions,ae.holeIndices,3);if(0===ye.length)continue;const Ne=ye.length,Fe=6*Ue,Be=(0,Y.my)(Fe+Ne),Ze=(0,Y.my)(Ne),je=(0,U.jh)(3*Fe),Ps=(0,U.jh)(3*Fe),bs=(0,U.jh)(3*Fe),Es=(0,U.jh)(Fe);yi(K,N,ye,ae,je,bs,Ps,Es,Be,Ze,this._getExtrusionSize(l),E,O),(0,M.t)(je,je,C);const Ms=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:u,layerUid:this._context.layer.uid}),Ir=new En(je,bs,(0,Cs.fA)(Ps),Es),oi=_i(H,Be,Be.length-Ze.length,Ir,c,Ms),ln=new Mn(Ue,Ue,2*ae.count,Ne/3);Oi(oi,ln,P),z.set(oi,ln),_.push(oi,_i(this._materials[et.Bottom],Ze,0,Ir,c,Ms)),y.push(Ir.heights)}if(0===_.length)return null;const I=new Qt.B({geometries:_,layerUid:this._context.layer.uid,graphicUid:u,isElevationSource:!0});I.transformation=P;const q=(0,hi.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),ie=q?new Q.H(this._materials[et.Main],q,this._context.slicePlaneEnabled):null,ee=new Q.Y(this,I,_,null,null,(ae,Ue,ye,Ne,Fe)=>function vn(d,i,l,c,h,u,p){const f=d.stageObject,g=f.geometries,_=g.length,y="absolute-height"!==i.mode;let b=0;const P=f.transformation,E=(0,J.Qw)((0,Z.vt)(),P);for(let O=0;O<_;O+=2){const C=g[O];if(!(0,un.p)(C))continue;const A=C.getMutableAttribute(D.r.POSITION).data,w=u[O/2],N=new di.aY(C.mapPositions),K=A.length/3;let z=!1,H=0;{let I=0;for(let q=0;q<K;q++){kt[0]=A[I],kt[1]=A[I+1],kt[2]=A[I+2],c(N,zr),y&&(H+=zr.sampledElevation),Xt.b.TESTS_DISABLE_OPTIMIZATIONS?((0,x.i)(He,N.array[N.offset],N.array[N.offset+1],zr.z+w[I/3]),null!=l&&h.toRenderCoords(He,l,He),(0,x.t)(He,He,E)):((0,x.i)(He,A[I],A[I+1],A[I+2]),(0,x.t)(He,He,P),h.setAltitude(He,zr.z+w[I/3]),(0,x.t)(He,He,E)),A[I]=He[0],A[I+1]=He[1],A[I+2]=He[2];const ie=.01/h.unitInMeters;(Math.abs(kt[0]-A[I])>=ie||Math.abs(kt[1]-A[I+1])>=ie||Math.abs(kt[2]-A[I+2])>=ie)&&(z=!0),N.offset+=3,I+=3}}if(z){const I=p.get(C);I&&Oi(C,I,P),f.geometryVertexAttributeUpdated(g[O],D.r.NORMALCOMPRESSED),C.invalidateBoundingInfo(),f.geometryVertexAttributeUpdated(g[O],D.r.POSITION),g[O+1].invalidateBoundingInfo(),f.geometryVertexAttributeUpdated(g[O+1],D.r.POSITION)}b+=H/K}return b/_}(ae,Ue,ye,Ne,Fe,y,z),h,ie);return ee.alignedSampledElevation=f.sampledElevation,ee.needsElevationUpdates=(0,L.Kf)(h.mode),ee}},text:class Xc extends he.U{constructor(i,l,c,h){super(i,l,c,h),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}doLoad(){var i=this;return(0,B.A)(function*(){if(!i._drivenProperties.size){const l=(0,k.Hj)(i.symbolLayer.size);if(l)throw new oe.A("graphics3dtextsymbollayer:invalid-size",l)}yield i._createTextRenderParameters()})()}_createTextRenderParameters(){var i=this;return(0,B.A)(function*(){const l=i._context.graphicsCoreOwner.view.state.rasterPixelRatio;i._textRenderParameters=yield ii.fromSymbol(i.symbolLayer,l)})()}destroy(){super.destroy()}createGraphics3DGraphic(i){const l=i.graphic,c=(0,We.ZX)(l.geometry);if(null==c)return this.logger.warn(`unsupported geometry type for text symbol: ${l.geometry.type}`),null;const h=this._context.stage.view.focusAreas.containsGeometry(c),u=this.symbolLayer.text;if(null==u||""===u)return null;const p=(0,Ja.YX)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=p&&!(0,Ja.Ie)(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const{verticalAlignment:f}=this.symbolLayer,g=new Rc(p);(0,_t.xU)(f,g.screenOffset);const _=new Dc(g,this.symbolLayer.horizontalAlignment,(0,_t.RH)(f));return _.isFocused=h??_.isFocused,this._createAs3DShape(l,c,u,_)}updateFocus(i,l){l.forEach(c=>{const h=this._context.stage.view.focusAreas.containsGeometry(c.graphic.geometry);c.layers.forEach(u=>{u?.graphics3DSymbolLayer===this&&u.stageObject.geometries.some(p=>p.material.parameters.isFocused!==h)&&i(c)})})}createLabel(i,l,c,h,u){const p=i.graphic,f=(0,We.ZX)(p.geometry);if(null==f)return this.logger.warn(`unsupported geometry type for label: ${p.geometry.type}`),null;const g=this._context.stage.view.focusAreas.containsGeometry(f),_=l.text;return!_||/^\s+$/.test(_)?null:(l.isFocused=g??l.isFocused,this._createAs3DShape(p,f,_,l,c,h,u))}setGraphicElevationContext(i,l=new Rs.F,c=0){return super.setGraphicElevationContext(i,l),l.addOffsetRenderUnits(c),l}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(i,l){return rn(i,l,(c,h)=>{this.updateGraphicElevationContext(h,c)}),L.uw.UPDATE}slicePlaneEnabledChanged(i,l){return rn(i,l,c=>{for(const h of c.stageObject.geometries)h.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(i,l){const{elevationContext:c,metadata:h}=l;this.setGraphicElevationContext(i,c,h?.elevationOffset??0),l.needsElevationUpdates=(0,L.nu)(c.mode)||"absolute-height"===c.mode}updateGeometry(i,l){if(this.draped||!this._validateGeometry(l))return!1;const{elevationContext:c,stageObject:h}=i;if(c.mode!==this.getGeometryElevationMode(l))return!1;const u=(0,We.ZX)(l);if(!u)return!1;const p=(0,We.hS)(h,this._context,u,c);if(null==p)return!1;const f=(0,We.R$)(this._context,u);return h.geometries[0].localOrigin===f&&(i.alignedSampledElevation=p,(0,We.d2)(i,u,this._context.elevationProvider),!0)}_defaultElevationInfoNoZ(){return Jc}_createAs3DShape(i,l,c,h,u=null,p=null,f=(()=>h.placement.elevationOffset)){const g=this.setGraphicElevationContext(i,new Rs.F,h.placement.elevationOffset),_="polyline"===i.geometry?.type,y=i.uid;let b=null,P=null;if(null==p){const Be=(0,_t.QE)(h.horizontalPlacement);b=new $c(c,Be,this._textRenderParameters);let Ze=null;if(null!=this._context.sharedResources.textures){P=this._context.sharedResources.textures.fromData(b.key,()=>b.create()),P.texture.events.on("unloaded",()=>Ze=(0,st.Gz)(Ze));const je=this._context.stage.renderView.textures.acquire(P.texture.id);if(null==je||(0,vt.$X)(je))return P.release(),null;Ze=je}}const E=!!(0,ce.A)("enable-feature:non-occluded-hud"),O=function Qc(d,i){if("baseline"===i.verticalPlacement)return(0,le.fA)(_t.cN[i.horizontalPlacement],null!=d?d.baselineAnchorY:0);const l=(0,_t.Ir)(i.horizontalPlacement,i.verticalPlacement);return _t.Zd[l]}(b,h),C={occlusionTest:!E,occludedFragmentFade:E,horizonCullingEnabled:E&&this._context.spherical,screenOffset:h.placement.screenOffset,anchorPosition:O,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:h.placement.centerOffsetUnits,depthEnabled:!1,drawAsLabel:!0,isLabel:!0,isFocused:h.isFocused};if(_&&(C.shaderPolygonOffset=1e-4),p?C.textureId=p.id:P&&(C.textureId=P.texture.id),null!=h.placement.verticalOffset){const{screenLength:Be,minWorldLength:Ze,maxWorldLength:je}=h.placement.verticalOffset;C.verticalOffset={screenLength:(0,Le.Lz)(Be),minWorldLength:Ze||0,maxWorldLength:je??1/0}}const A=this._context.graphicsCoreOwner.view.focusAreas.activePolygons.length,w={screenOffset:C.screenOffset,anchorPosition:O,centerOffsetUnits:C.centerOffsetUnits,verticalOffset:C.verticalOffset,shaderPolygonOffset:C.shaderPolygonOffset,occlusionTest:C.occlusionTest,isFocused:h.isFocused,focusEffect:this._context.stage.view.focusAreas?.style};if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:Be,screenSizePerspectiveSettingsLabels:Ze}=this._context.sharedResources,je=(0,wc.z)(this._textRenderParameters);C.screenSizePerspective=Ze.overrideFontHeight(je.maxHeight),C.screenSizePerspectiveAlignment=Be,w.fontHeight=je.maxHeight}C.hasSlicePlane=this._context.slicePlaneEnabled;const N=this._context.spherical,K=u?JSON.stringify(w):"";let z=u?.get(K);if(null==z){if(!h.isFocused&&A>0){const Be=this._context.stage.view.focusAreas?.style;C.color=Hr(C.color,Be),C.outlineColor=Hr(C.outlineColor,Be)}z=new Zr.R(C,N),u?.add(K,z)}const H=h.placement.translation,I=b?(0,le.fA)(b.displayWidth,b.displayHeight):le.uY,q=h.placement.centerOffset,ie=Zc,ee=p?(0,we.fA)(0,0,0,0):null,ae=(0,gr.DJ)(z,{normal:ie,position:H,size:I,centerOffsetAndDistance:q,uvs:ee}),Ue=(0,We.SZ)(this._context,l,ae,g,y);if(null==Ue)return null;const Ne=new Q.Y(this,Ue.object,[ae],null==u?[z]:null,P,(Be,Ze,je,Ps,bs,Es)=>{const Ms=f()||h.placement.elevationOffset,Ir=this.setGraphicElevationContext(i,Ze,Ms);return(0,ct.G8)(Be,Ir,je,Ps,bs,Es)},g);Ne.alignedSampledElevation=Ue.sampledElevation,Ne.needsElevationUpdates=(0,L.nu)(g.mode)||"absolute-height"===g.mode,Ne.getScreenSize=(Be=(0,le.vt)())=>(Be[0]=b?b.displayWidth:h.displaySize[0],Be[1]=b?b.displayHeight:h.displaySize[1],Be);const Fe=new Ac.Z(h.placement.elevationOffset,c);return Ne.metadata=Fe,(0,We.d2)(Ne,l,this._context.elevationProvider),Ne}},water:Mt};function hh(d,i){on[d]=i}const dh={"mesh-3d":{fill:class Ro extends he.U{constructor(i,l,c,h){super(i,l,c,h),this._materialInfoCache=new bo,this._fastUpdateProcessor=new Po,this._textures=new Map,this.ensureDrapedStatus(!1)}doLoad(){var i=this;return(0,B.A)(function*(){Xt.b.DRAW_MESH_GEOMETRY_NORMALS&&(i._debugVertexNormalMaterial=new Bs({color:[1,0,1,1]}),i._debugTangentNormalMaterial=new Bs({color:[1,.5,0,1]}),i._debugFaceNormalMaterial=new Bs({color:[0,1,1,1]}))})()}destroy(){super.destroy(),this._textures.forEach(i=>i.unload()),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(i){const l=i.graphic;if(!this._validateGeometry(l.geometry,Ao,"fill on mesh-3d"))return null;const c=this.setGraphicElevationContext(l);return this._createAs3DShape(l,i.renderingInfo,c,l.uid)}onRemoveGraphic(i){this._fastUpdateProcessor.onRemoveGraphic(i,this._materialInfoCache,this._context)}layerOpacityChanged(i,l){const c=this._getLayerOpacity();this._updateMaterialParameters(h=>{h.material.setParameters({layerOpacity:c});const u=h.material.parameters;this._setMaterialTransparentParameter(u,h),h.material.setParameters({transparent:u.transparent})}),i.forEach(h=>l(h)?.layerOpacityChanged(c,this._context.isAsync))}layerElevationInfoChanged(i,l){return this.updateGraphics3DGraphicElevationInfo(i,l,L.Kf)}slicePlaneEnabledChanged(i,l){return this._updateMaterialParameters(({material:c})=>{c.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),i.forEach(c=>l(c)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)),!0}physicalBasedRenderingChanged(){const i=this._usePBR();return this._updateMaterialParameters(({material:l})=>l.setParameters({usePBR:i})),!0}updateTransform(i,l,c,h){if(!i.fastTransformUpdatesAllowed)return!1;const u=i.fastTransformUpdatesEnabled;switch(h){case Ct.$.EnableFastUpdates:if(u)return!0;break;case Ct.$.DisableFastUpdates:if(!u)return!0;break;default:if(!u)return!!this.updateTransform(i,l,c,Ct.$.EnableFastUpdates)&&(i.autoDisableFastTransformUpdates(()=>this.updateTransform(i,l,c,Ct.$.DisableFastUpdates)),!0)}const p=this._context.renderCoordsHelper.spatialReference,f=Wo,{origin:g,transform:_}=c;if(!(0,W.l)(l,(0,x.i)(be,g.x,g.y,g.z??0),f,p))return!1;switch(h){case Ct.$.EnableFastUpdates:this._fastUpdateProcessor.enable(i,this._materialInfoCache,this._context);break;case Ct.$.DisableFastUpdates:this._fastUpdateProcessor.disable(i,this._materialInfoCache,this._context);break;case Ct.$.UpdateFastLocalOrigin:i.updateFastLocalOrigin(f,_,this._context.localOriginFactory)}const{elevationContext:y}=i;y.centerPointInElevationSR=this._getCenterPointInElevationSR(f);const{elevationProvider:b,renderCoordsHelper:P}=this._context;return i.alignedSampledElevation=(0,ct.G8)(i,y,b.spatialReference,(O,C)=>(0,L.sE)(O,b,y,P,C),P,f),i.updateTransform(f,_,this._context.isAsync),i.updateAutoDisableFastTransformUpdates(()=>this.updateTransform(i,l,c,Ct.$.DisableFastUpdates)),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_materialPropertiesDefault(i,l){const c=this._requiresSymbolVertexColors(),h=!!i.vertexAttributes.color,u=!!i.vertexAttributes.tangent;return{hasSymbolVertexColors:c,hasVertexColors:h,hasVertexTangents:u,uid:`vc:${h},vt:${u},vct${l},svc:${c}`}}_materialProperties(i,l,c){const h=this._materialPropertiesDefault(i,c);if(!l.material)return h;const{color:u,colorTexture:p,colorTextureTransform:f,normalTexture:g,normalTextureTransform:_,doubleSided:y,alphaCutoff:b,alphaMode:P}=l.material,E=Wt(u),O=Wt(p),C=Cr(f),A=Wt(g),w=Cr(_);if(h.color=u,h.colorTexture=p,h.normalTexture=g,h.uid=`${h.uid},cmuid:${E},ctmuid:${O},cttuid:${C},ntmuid:${A},nttuid:${w},ds:${y},ac:${b},am:${P}`,l.material instanceof uo.A){const{metallic:N,roughness:K,metallicRoughnessTexture:z,metallicRoughnessTextureTransform:H,emissiveColor:I,emissiveTexture:q,emissiveTextureTransform:ie,occlusionTexture:ee,occlusionTextureTransform:ae}=l.material,Ue=Wt(z),ye=Cr(H),Ne=Wt(I),Fe=Wt(q),Be=Cr(ie),Ze=Wt(ee),je=Cr(ae);h.metallic=N,h.roughness=K,h.metallicRoughnessTexture=z,h.emissiveColor=I,h.emissiveTexture=q,h.occlusionTexture=ee,h.colorTextureTransform=Or(f),h.normalTextureTransform=Or(_),h.emissiveTextureTransform=Or(ie),h.occlusionTextureTransform=Or(ae),h.metallicRoughnessTextureTransform=Or(H),h.uid=`${h.uid},mrm:${N},mrr:${K},mrt:${Ue},mrtt:${ye},emuid:${Ne},etmuid:${Fe},ett:${Be},otmuid:${Ze},ott:${je}`}return h}_getInternalTexture(i,l=De.sf.Opaque){const c=function Vo(d){return d.data??d.url}(i);if(!c)return null;const h=`${i.contentHash}/${l}`;let u=this._textures.get(h);if(u){let y=null;const b=this._context.stage.renderView.textures.acquire(u.id);return null==b||(0,vt.$X)(b)||(u.events.on("unloaded",()=>y=(0,st.Gz)(y)),y=b),u}let p=null;const f=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,g={wrap:Uo(i.wrap),noUnpackFlip:!0,maxAnisotropy:f,mipmap:f>1};return(0,go.x3)(c)?(p=c.data,g.preMultiplyAlpha=!1,g.encoding=c.encoding):(p=c,g.preMultiplyAlpha=l!==De.sf.Opaque,g.downsampleUncompressed=this._context.graphicsCoreOwner.view.qualitySettings.graphics3D.uncompressedTextureDownsamplingEnabled),u=new Yr.g(p,g),this._textures.set(h,u),u.load(this._context.stage.renderView.renderingContext),this._context.stage.add(u),u.events.on("unloaded",()=>{this._textures.delete(h)}),u}_setInternalMaterialTextureParameters(i,l){if(null!=i.colorTexture){const c=this._getInternalTexture(i.colorTexture,l.textureAlphaMode);c?(l.textureId=c.id,l.textureAlphaPremultiplied=!!c.parameters.preMultiplyAlpha):l.textureId=void 0}i.normalTexture&&(l.normalTextureId=this._getInternalTexture(i.normalTexture)?.id),i.emissiveColor&&(l.emissiveFactor=Xe.A.toUnitRGB(i.emissiveColor)),i.emissiveTexture&&(l.emissiveTextureId=this._getInternalTexture(i.emissiveTexture)?.id),i.occlusionTexture&&(l.occlusionTextureId=this._getInternalTexture(i.occlusionTexture)?.id),i.metallicRoughnessTexture&&(l.metallicRoughnessTextureId=this._getInternalTexture(i.metallicRoughnessTexture)?.id)}_setInternalMaterialParameters(i,l){null!=i.color&&function Bo(d,i){i.diffuse=Xe.A.toUnitRGB(d),i.opacity=d.a}(i.color,l),this._setInternalMaterialTextureParameters(i,l),l.colorTextureTransformMatrix=(0,br.G)(i.colorTextureTransform),l.normalTextureTransformMatrix=(0,br.G)(i.normalTextureTransform);const c=null!=i.normalTextureTransform?.scale?i.normalTextureTransform?.scale:le.Un;l.scale=[c[0],c[1]],l.occlusionTextureTransformMatrix=(0,br.G)(i.occlusionTextureTransform),l.emissiveTextureTransformMatrix=(0,br.G)(i.emissiveTextureTransform),l.metallicRoughnessTextureTransformMatrix=(0,br.G)(i.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(i,l=this.symbolLayer?.material?.color){const c=this._drivenProperties.color;let h=this.symbolLayer.material?.colorMixMode??null;if(c)i.externalColor=we.Un;else{const u=l??null;u?i.externalColor=Xe.A.toUnitRGBA(u):(h=null,i.externalColor=we.Un)}h&&(i.colorMixMode=h),i.castShadows=!!this.symbolLayer.castShadows}_getOrCreateMaterial(i,l){const c=l.material?.color,h=l.material?.colorTexture,u=l.material?.alphaMode,p="blend"===u,f="opaque"!==u&&(function No(d){const i=d.vertexAttributes.color;if(null==i)return!1;for(let l=3;l<i.length;l+=4)if(255!==i[l])return!0;return!1}(i)||null!=c&&c.a<1||h?.transparent||p),g=this._materialProperties(i,l,f),_=this._materialInfoCache.byUid(g.uid);if(_)return this._setInternalMaterialTextureParameters(g,_.material.parameters),_.material;const y={uid:g.uid,material:null,isComponentTransparent:f,alphaMode:l.material?l.material.alphaMode:"opaque"},b=(0,Mr.Jr)({normalTexture:g.normalTexture,metallicRoughnessTexture:g.metallicRoughnessTexture,metallicFactor:g.metallic,roughnessFactor:g.roughness,emissiveTexture:g.emissiveTexture,emissiveFactor:Xe.A.toUnitRGB(g.emissiveColor),occlusionTexture:g.occlusionTexture}),P={usePBR:this._usePBR(),isSchematic:b,hasVertexColors:g.hasVertexColors,hasSymbolColors:g.hasSymbolVertexColors,hasVertexTangents:g.hasVertexTangents,ambient:S.uY,diffuse:S.Un,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:De.s2.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled};P.mrrFactors=b?Mr.Bt:[g.metallic,g.roughness,Mr.mb[2]],l.material&&(P.doubleSided=l.material.doubleSided,P.cullFace=l.material.doubleSided?De.s2.None:De.s2.Back,P.textureAlphaCutoff=l.material.alphaCutoff),this._setExternalMaterialParameters(P),this._setMaterialTransparentParameter(P,y),this._setInternalMaterialParameters(g,P);const E=new Jt.$U(P,this._context);return y.material=E,this._materialInfoCache.set(g.uid,y),this._context.stage.add(E),E}prepareSymbolLayerPatch(i){"partial"===i.diff.type&&this._preparePatchColor(i,i.diff.diff)}_preparePatchColor(i,l){if(!l.material||"partial"!==l.material.type)return;const c=l.material.diff;if(!c.color||"complete"!==c.color.type||null==c.color.newValue||null==c.color.oldValue)return;const h=c.color.newValue;delete c.color,i.symbolLayerStatePatches.push(()=>{this._updateMaterialParameters(u=>{const p=u.material.parameters;this._setExternalMaterialParameters(p,h),this._setMaterialTransparentParameter(p,u),u.material.setParameters({externalColor:p.externalColor,transparent:p.transparent})})})}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(i,l){i.transparent=this.needsDrivenTransparentPass||l.isComponentTransparent||i.layerOpacity<1||i.opacity<1||i.externalColor&&i.externalColor[3]<1,i.textureAlphaMode="auto"===l.alphaMode?i.transparent?De.sf.MaskBlend:De.sf.Opaque:"opaque"===l.alphaMode?De.sf.Opaque:"mask"===l.alphaMode?De.sf.Mask:De.sf.Blend}_createFaceDebugNormals(i,l){const c=l.length,h=i.spatialReference.isGeographic?20015077/180:1,u=.1*Math.max(i.extent.width*h,i.extent.height*h,i.extent.zmax-i.extent.zmin),p=[],f=[],g=l[0].transformation,_=(0,_e.Ge)((0,me.vt)(),g);for(let y=0;y<c;y++){const b=l[y].attributes.get(D.r.POSITION);if(!b)continue;const P=b.data,E=b.indices;for(let O=0;O<E.length;O+=3)as(P,E,O,ut),oa(P,E,O,be,it,sr),(0,x.g)(be,be,it),(0,x.g)(be,be,sr),(0,x.h)(be,be,1/3),(0,x.t)(be,be,g),p.push(...be),(0,x.q)(ut,ut,_),(0,x.n)(ut,ut),(0,x.b)(be,be,ut,u),p.push(...be),f.push(f.length),f.push(f.length)}return p.length?new Re.V(this._debugFaceNormalMaterial,[[D.r.POSITION,new te.n(p,f,3,!0)]],null,fe.X.Line):null}_createPerVertexDebugVectors(i,l,c,h,u){const p=l.length,f=i.spatialReference.isGeographic?20015077/180:1,g=.1*u*Math.max(i.extent.width*f,i.extent.height*f,i.extent.zmax-i.extent.zmin),_=[],y=[],b=l[0].transformation,P=(0,_e.Ge)((0,me.vt)(),b);c===D.r.TANGENT&&(0,_e.z0)(P,b);for(let E=0;E<p;E++){const O=l[E],C=O.attributes.get(D.r.POSITION),A=O.attributes.get(c);if(!C||!A)continue;const w=C.data,N=C.indices,K=A.data,z=A.indices;for(let H=0;H<N.length;H++){const I=3*N[H],q=z[H]*A.stride;(0,x.i)(be,w[I+0],w[I+1],w[I+2]),(0,x.t)(be,be,b),_.push(...be),(0,x.i)(it,K[q+0],K[q+1],K[q+2]),(0,x.q)(it,it,P),(0,x.n)(it,it),(0,x.b)(be,be,it,g),_.push(...be),y.push(y.length),y.push(y.length)}}return _.length?new Re.V(h,[[D.r.POSITION,new te.n(_,y,3,!0)]],null,fe.X.Line):null}_createAs3DShape(i,l,c,h){const u=i.geometry;if("mesh"!==u.type)return null;const p=this._createGeometryInfo(u,l,h);if(null==p)return null;const{geometries:f,objectTransformation:g}=p;if(Xt.b.DRAW_MESH_GEOMETRY_NORMALS){const A=this._createPerVertexDebugVectors(u,f,D.r.NORMAL,this._debugVertexNormalMaterial,1),w=this._createPerVertexDebugVectors(u,f,D.r.TANGENT,this._debugTangentNormalMaterial,.5),N=this._createFaceDebugNormals(u,f);A&&f.push(A),w&&f.push(w),N&&f.push(N)}const _=new Qt.B({geometries:f,layerUid:this._context.layer.uid,graphicUid:h,isElevationSource:!0});_.transformation=g;const y=(0,hi.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),b=y?new Q.H(f[0].material,y,this._context.slicePlaneEnabled):null,P=new _o(this,_,f,null,null,ct.G8,c,b);this._fastUpdateProcessor.onAddGraphic(),P.needsElevationUpdates=(0,L.Kf)(c.mode),P.useObjectOriginAsAttachmentOrigin=!0,P.fastTransformUpdatesAllowed=this._fastTransformUpdatesAllowed(u),c.centerPointInElevationSR=this._getCenterPointInElevationSR(_.transformation);const{elevationProvider:E,renderCoordsHelper:O}=this._context;return P.alignedSampledElevation=(0,ct.G8)(P,c,E.spatialReference,(A,w)=>(0,L.sE)(A,E,c,O,w),O),P}_fastTransformUpdatesAllowed(i){const{vertexSpace:l,spatialReference:c}=i;if(!(0,Xi.Hq)(l))return!1;const{type:h}=l,{view:u}=this._context.graphicsCoreOwner,{viewingMode:p}=u.state;return p===j.RT.Global&&"local"===h||p===j.RT.Local&&(0,kr.aI)(u.spatialReference,c)&&"georeferenced"===h&&!c.isGeographic}_getCenterPointInElevationSR(i){const l=(0,fo.T)(0,0,0,this._context.elevationProvider.spatialReference??null);return(0,co.E)([i[12],i[13],i[14]],this._context.renderCoordsHelper.spatialReference,l),l}_passthroughReprojectionInfo(i){return i.reprojection===ke.NONE&&!!i.objectTransformation}_createPositionBuffer(i,l){const c=i.vertexAttributes.position;let h,u=c;if(l.reprojection===ke.NONE)return{position:u,georeferencedPositionBuffer:h};const p=l.reprojection===ke.RENDER?l.transformBeforeProject:null;p&&(u=(0,M.t)(new Float64Array(u.length),u,p));const{normal:f,tangent:g}=i.vertexAttributes;this._passthroughReprojectionInfo(l)||!f&&!g||(h=u);const _=u===c||u===h?new Float64Array(u.length):u;return(0,Nr.projectBuffer)(u,i.spatialReference,0,_,this._context.renderCoordsHelper.spatialReference,0),{position:_,georeferencedPositionBuffer:h}}_createNormalBuffer(i,l,c,h){const u=i.vertexAttributes.normal;if(null==u)return null;let p=u;const f=h.reprojection===ke.RENDER?h.transformBeforeProject:null;if(f&&(p=(0,Je.qs)(p,new Float32Array(p.length),f)),h.reprojection===ke.NONE)return p;if("local"===this._context.graphicsCoreOwner.view.viewingMode){if(!(0,kr.r1)(this._context.renderCoordsHelper.spatialReference))return p;if(null==c)return null;if(i.spatialReference.isGeographic){const b=p===u?new Float32Array(p.length):p;return(0,Je.gZ)(p,Je.OD.NORMAL,c,b)}if(i.spatialReference.isWebMercator){const b=p===u?new Float32Array(p.length):p;return(0,Je.GN)(p,Je.OD.NORMAL,c,b)}return p}if(null==c)return null;const _=p===u?new Float32Array(p.length):p;return(0,Je.X4)(p,c,i.spatialReference,l,this._context.renderCoordsHelper.spatialReference,_)}_createTangentBuffer(i,l,c,h){const u=i.vertexAttributes.tangent;if(null==u)return null;let p=u;const f=h.reprojection===ke.RENDER?h.transformBeforeProject:null;if(f&&(p=(0,Je.KM)(p,new Float32Array(p.length),f)),h.reprojection===ke.NONE)return p;if("local"===this._context.graphicsCoreOwner.view.viewingMode){if(!(0,kr.r1)(this._context.renderCoordsHelper.spatialReference))return p;if(null==c)return null;if(i.spatialReference.isGeographic){const b=p===u?new Float32Array(p.length):p;return(0,Je.gZ)(p,Je.OD.TANGENT,c,b)}if(i.spatialReference.isWebMercator){const b=p===u?new Float32Array(p.length):p;return(0,Je.GN)(p,Je.OD.TANGENT,c,b)}return p}if(null==c)return null;const _=p===u?new Float32Array(p.length):p;return(0,Je.xA)(p,c,i.spatialReference,l,this._context.renderCoordsHelper.spatialReference,_)}_createSymbolColorBuffer(i){if(this._requiresSymbolVertexColors()){const l=this._getVertexOpacityAndColor(i),c=(0,ra.Eb)(this.symbolLayer?.material?.colorMixMode),h=new Uint8Array(4);return(0,ra._j)(l,c,h),h}return null}_createBuffers(i,l){const c=i.vertexAttributes&&i.vertexAttributes.position;if(!c)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const h=i.vertexAttributes.normal,u=i.vertexAttributes.uv,p=i.vertexAttributes.tangent;if(h&&h.length!==c.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(p&&p.length/4!=c.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(u&&u.length/2!=c.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const f=this._computeReprojectionInfo(i),{position:g,georeferencedPositionBuffer:_}=this._createPositionBuffer(i,f),y=function Go(d){return d.vertexAttributes.color}(i),b=this._createSymbolColorBuffer(l),P=this._createNormalBuffer(i,g,_,f),E=this._createTangentBuffer(i,g,_,f),O=u,{transformation:C,position:A,normal:w,tangent:N}=this._passthroughReprojectionInfo(f)?{transformation:f.objectTransformation,position:g,normal:P,tangent:E}:this._transformOriginLocal(i,g,P,E);return{positionBuffer:A,normalBuffer:w,tangentBuffer:N,uvBuffer:O,colorBuffer:y,symbolColorBuffer:b,objectTransformation:C,geometryTransformation:f.reprojection===ke.NONE&&f.geometryTransformation?f.geometryTransformation:(0,Z.vt)()}}_computeReprojectionInfo(i){const{vertexSpace:l}=i,c="georeferenced"===l.type?(0,kr.aI)(this._context.renderCoordsHelper.spatialReference,i.spatialReference)?ke.NONE:ke.RENDER:ke.NONE;if((0,Xi.E9)(l))return{reprojection:c};const h=l.origin,u=(0,Z.vt)(),p=i.transform?.localMatrix??Z.zK;if(c===ke.NONE)return(0,W.l)(i.spatialReference,h,u,this._context.renderCoordsHelper.spatialReference),{reprojection:c,objectTransformation:u,geometryTransformation:(0,Z.o8)(p)};const f=(0,J.kN)((0,Z.vt)(),h);return(0,J.lw)(f,f,p),{reprojection:c,transformBeforeProject:f}}_transformOriginLocal(i,l,c,h){const u=this._context.renderCoordsHelper.spatialReference,p=i.origin;ns[0]=p.x,ns[1]=p.y,ns[2]=p.z??0;const f=(0,Z.vt)();(0,W.l)(i.spatialReference,ns,f,u),(0,J.B8)(os,f);const{position:g,normal:_,tangent:y}=i.vertexAttributes,b=l===g?new Float64Array(l.length):l;(0,M.t)(b,l,os);const P=c?c===_?new Float32Array(c.length):c:null,E=h?h===y?new Float32Array(h.length):h:null;return c&&P&&(0,Je.qs)(c,P,os),h&&E&&(0,Je.KM)(h,E,os),{transformation:f,position:b,normal:P,tangent:E}}_validateFaces(i,l){const c=i.vertexAttributes.position.length/3,h=l.faces;if(h){let u=-1;for(let p=0;p<h.length;p++){const f=h[p];f>u&&(u=f)}if(c<=u)return this.logger.warn(`Vertex index ${u} is out of bounds of the mesh position buffer`),!1}else if(c%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_isOutsideClippingArea(i){if(!this._context.clippingExtent||!i.vertexAttributes?.position)return!1;const h=(0,mo.projectMeshVertexPositions)(i,this._context.elevationProvider.spatialReference??i.spatialReference);return!!h&&((0,R.vY)(h,la),!(0,R.KG)(la,this._context.clippingExtent))}_createGeometryInfo(i,l,c){if(!(0,lo.canProjectWithoutEngine)(i.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(i)||this._isOutsideClippingArea(i))return null;const h=this._createBuffers(i,l);if(null==h)return null;const{positionBuffer:u,uvBuffer:p,colorBuffer:f,symbolColorBuffer:g,normalBuffer:_,tangentBuffer:y,objectTransformation:b,geometryTransformation:P}=h,E=i.components??jo,O=new Array;let C=!1;const A=(0,J.sC)(be,b),w=this._context.localOriginFactory.getOrigin(A);for(const N of E){if(!this._validateFaces(i,N))return null;const K=Do(i,N);if(0===K.length)continue;const z=wo(u,_,N,K);z.didFlipNormals&&(C=!0);const H=[[D.r.POSITION,new te.n(u,K,3,!0)],[D.r.NORMAL,new te.n(z.normals,z.indices,3,!0)]];f&&H.push([D.r.COLOR,new te.n(f,K,4,!0)]),g&&H.push([D.r.SYMBOLCOLOR,new te.n(g,(0,Y.EH)(K.length),4,!0)]),p&&H.push([D.r.UV0,new te.n(p,K,2,!0)]),y&&H.push([D.r.TANGENT,new te.n(y,K,4,!0)]);const I=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:c,layerUid:this._context.layer.uid}),q=this._getOrCreateMaterial(i,N),ie=new Re.V(q,H,null,fe.X.Mesh,I);ie.transformation=P,ie.localOrigin=w,O.push(ie)}return C&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:O,objectTransformation:b}}_updateMaterialParameters(i){this._materialInfoCache.forEachMaterialInfo(i),this._fastUpdateProcessor.forEachMaterialInfo(i),this._fastUpdateProcessor.forEachClonedMaterial((l,c)=>{c.setParameters(l.parameters)})}_validateVertexSpace(i){const{_context:{graphicsCoreOwner:{view:{state:{viewingMode:l}}}}}=this,{vertexSpace:c}=i;return l!==j.RT.Local||"local"!==c.type||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}}}}},62393:(Ke,xe,v)=>{v.d(xe,{H:()=>Z,W:()=>x});var ne=v(45475),B=v(79052),ce=v(99286),oe=v(88791),pe=v(91187),ve=v(60631),re=v(24493),_e=v(40972),me=v(59642);const J=8;function Z(S,W){const R=_e.r.FEATUREVALUE;S.attributes.add(R,"vec4");const U=S.vertex;U.code.add(re.H`
  bool isCapVertex() {
    return ${R}.w == 1.0;
  }
  `),U.uniforms.add(new ce.G("size",Y=>Y.size)),W.vvSize?(U.uniforms.add(new oe.t("vvSizeMinSize",Y=>Y.vvSize.minSize),new oe.t("vvSizeMaxSize",Y=>Y.vvSize.maxSize),new oe.t("vvSizeOffset",Y=>Y.vvSize.offset),new oe.t("vvSizeFactor",Y=>Y.vvSize.factor)),U.code.add(re.H`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${R}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):U.code.add(re.H`vec2 getSize(){
return size;
}`),W.vvOpacity?(U.constants.add("vvOpacityNumber","int",J),U.uniforms.add(new ve.x("vvOpacityValues",Y=>Y.vvOpacity.values,J),new ve.x("vvOpacityOpacities",Y=>Y.vvOpacity.opacityValues,J)),U.code.add(re.H`
    vec4 applyOpacity(vec4 color) {
      float value = ${R}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):U.code.add(re.H`vec4 applyOpacity(vec4 color){
return color;
}`),W.vvColor?(U.constants.add("vvColorNumber","int",me.p),U.uniforms.add(new ve.x("vvColorValues",Y=>Y.vvColor.values,me.p),new pe.F("vvColorColors",Y=>Y.vvColor.colors,me.p)),U.code.add(re.H`
    vec4 getColor() {
      float value = ${R}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):U.code.add(re.H`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),S.include(B.I),S.attributes.add(_e.r.PROFILERIGHT,"vec4"),S.attributes.add(_e.r.PROFILEUP,"vec4"),S.attributes.add(_e.r.PROFILEVERTEXANDNORMAL,"vec4"),U.code.add(re.H`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),U.code.add(re.H`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),U.code.add(re.H`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),U.code.add(re.H`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}class x extends me.S{constructor(){super(...arguments),this.size=(0,ne.fA)(1,1)}}},26742:(Ke,xe,v)=>{v.d(xe,{n:()=>B});var ne=v(24493);function B(ce,oe){ce.vertex.code.add(oe.spherical?ne.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`:ne.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),ce.vertex.code.add(oe.spherical?ne.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`:ne.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},4194:(Ke,xe,v)=>{v.d(xe,{V:()=>Z});var ne=v(83953),B=v(45475),ce=v(53781),oe=v(89141),pe=v(68307),re=(v(55189),v(99286)),_e=v(18356),me=v(24493),J=v(35089);function Z(R){R.fragment.uniforms.add(new J.N("texWaveNormal",U=>U.waveNormal),new J.N("texWavePerturbation",U=>U.wavePerturbation),new _e.E("waveParams",U=>(0,ce.s)(S,U.waveStrength,U.waveTextureRepeat,U.flowStrength,U.flowOffset)),new re.G("waveDirection",U=>(0,ne.hZ)(W,U.waveDirection[0]*U.waveVelocity,U.waveDirection[1]*U.waveVelocity))),R.include(pe.z),R.fragment.code.add(me.H`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const S=(0,oe.vt)(),W=(0,B.vt)()},58390:(Ke,xe,v)=>{v.d(xe,{aT:()=>pe,fA:()=>ve});var ne=v(69287);function pe(x,S,W,R,U,Y=2){const M=1/(Math.abs(W)+Math.abs(R)+Math.abs(U)),T=W*M,X=R*M,j=U<=0?(T>=0?1:-1)*(1-Math.abs(X)):T,L=U<=0?(X>=0?1:-1)*(1-Math.abs(T)):X,Q=S*Y;x[Q]=J(j),x[Q+1]=J(L)}function ve(x){const S=x.length/3,W=new Int16Array(2*S);let R=0;for(let U=0;U<S;++U)pe(W,U,x[R++],x[R++],x[R++]);return W}function J(x){return(0,ne.qE)(Math.round(32767*x),-32767,32767)}v(28714),v(25866),v(81596)},81671:(Ke,xe,v)=>{var ne,B;v.d(xe,{O:()=>ne}),(B=ne||(ne={}))[B.Horizontal=0]="Horizontal",B[B.Vertical=1]="Vertical",B[B.Cross=2]="Cross",B[B.ForwardDiagonal=3]="ForwardDiagonal",B[B.BackwardDiagonal=4]="BackwardDiagonal",B[B.DiagonalCross=5]="DiagonalCross",B[B.COUNT=6]="COUNT"}}]);