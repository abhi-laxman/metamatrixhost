"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[4093],{21128:(tt,j,a)=>{a.d(j,{Ir:()=>K,QE:()=>V,RH:()=>Q,Zd:()=>U,cN:()=>D,xU:()=>W});var w=a(83953),_=a(45475),M=a(67864);const D=Object.freeze({left:0,center:.5,right:1}),U=Object.freeze({"bottom-left":(0,_.fA)(0,0),bottom:(0,_.fA)(.5,0),"bottom-right":(0,_.fA)(1,0),left:(0,_.fA)(0,.5),center:(0,_.fA)(.5,.5),right:(0,_.fA)(1,.5),"top-left":(0,_.fA)(0,1),top:(0,_.fA)(.5,1),"top-right":(0,_.fA)(1,1)});function V(A){switch(A){case"left":return M.lV.Left;case"right":return M.lV.Right;default:return M.lV.Center}}function K(A,H){switch(H){case"bottom":return"left"===A?"bottom-left":"right"===A?"bottom-right":"bottom";case"center":return A;case"top":return"left"===A?"top-left":"right"===A?"top-right":"top"}}function Q(A){return"middle"===A?"center":A}function W(A,H){switch(A){case"top":return(0,w.hZ)(H,0,M.Xd);case"bottom":return(0,w.hZ)(H,0,-1);default:return(0,w.C)(H,_.uY)}}},45716:(tt,j,a)=>{a.d(j,{z:()=>_});var w=a(72951);function _(F){const{size:v}=F.definition,K=F.fontString(v);let Q=M.get(K);if(!Q){const W=(0,w.y)(U,0,0).getContext("2d");F.setFontProperties(W,v);const A=W.measureText(V);Q=new D(A.actualBoundingBoxAscent,A.actualBoundingBoxDescent),M.set(K,Q)}return Q}const M=new Map;class D{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(v,K){this.maxAscent=v,this.maxDescent=K}}const U={canvas:null},V=(()=>{let F="";for(let v=32;v<127;v++)F+=String.fromCharCode(v);return F})()},88577:(tt,j,a)=>{a.d(j,{c:()=>_});var w=a(67496);class _{constructor(D,U){this._material=D,this._repository=U,this._map=new Map}dispose(){this._map.forEach((D,U)=>{null!=D&&this._repository.release(this._material,U)})}load(D,U,V){if(!this._material.produces.get(U)?.(V))return null;this._map.has(V)||this._map.set(V,this._repository.acquire(this._material,U,V));const v=this._map.get(V);if(null!=v){if(v.ensureResources(D)===w.Am.LOADED)return v;this._repository.requestRender()}return null}}},72951:(tt,j,a)=>{function w(_,M,D){return _.canvas||(_.canvas=document.createElement("canvas")),_.canvas.width=M,_.canvas.height=D,_.canvas}a.d(j,{y:()=>w})},67864:(tt,j,a)=>{a.d(j,{Js:()=>V,Xd:()=>U,lV:()=>v});var w=a(69287),_=a(45321),M=a(45716),D=a(72951);const U=1;class V{constructor(s,r,o,c){this.text=s,this._alignment=r,this._parameters=o,this._maxSize=c,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${s}--${this._parameters.key}-${this._alignment}`,this._lines=s.replaceAll(" ","\xa0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let s=this._metrics.firstLineAscent;for(let r=0;r<this._lines.length-1;r++)s+=this._lineSpacing;return s+=this._metrics.lastLineDescent,Math.ceil(s+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const s=(0,D.y)(K,W,W).getContext("2d"),r=this._parameters.definition.pixelRatio;this._parameters.setFontProperties(s,this._fontSize*r);let c=2*this._haloSize;const f=this._parameters.definition.font;"italic"!==f.style&&"oblique"!==f.style&&"bold"!==f.weight&&"bolder"!==f.weight||(c+=.3*s.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let p=0,E=0,T=0,m=0,S=0;this._lines.forEach((et,nt)=>{const k=s.measureText(et),L=k.width/r,it=L+c;this._textWidths.push(L),this._lineWidths.push(it),p=Math.max(p,it),m=Math.max(m,k.actualBoundingBoxAscent/r),S=Math.max(S,k.actualBoundingBoxDescent/r),0===nt&&(E=k.actualBoundingBoxAscent/r),nt===this._lines.length-1&&(T=k.actualBoundingBoxDescent/r)});const O=(0,M.z)(this._parameters),Y=Math.max(m,O.maxAscent),x=Math.max(S,O.maxDescent);this._metricsCached=new H(E,"underline"===this._parameters.definition.font.decoration?x:T,Y,x,p)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Q}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,U)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){return null==this._renderPixelRatio&&(this._renderPixelRatio=Math.min(this._parameters.definition.pixelRatio,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))),this._renderPixelRatio}_getLineXOffset(s){switch(this._alignment){case v.Left:return this._horizontalPadding;case v.Center:return(this.displayWidth-this._lineWidths[s])/2;case v.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[s]}}render(s,r,o){s.save();const c=r/=this.renderPixelRatio,f=o/=this.renderPixelRatio,p=this._haloSize,E=this._firstLineYOffset+this._metrics.firstLineAscent;r+=p,o+=E;const T=this._haloSize>0;T&&this._renderHalo(s,c,f,p,E),this._parameters.setFontProperties(s,this._renderedFontSize);for(let m=0;m<this._lines.length;++m){const S=this._lines[m],O=this._getLineXOffset(m);T&&(s.globalCompositeOperation="destination-out",s.fillStyle="rgb(0, 0, 0)",this._fillText(s,S,r+O,o),this._renderLineDecoration(s,r+O,o,this._textWidths[m])),s.globalCompositeOperation="source-over",s.fillStyle=this._parameters.textStyle,this._fillText(s,S,r+this._getLineXOffset(m),o),this._renderLineDecoration(s,r+O,o,this._textWidths[m]),o+=this._lineSpacing}if(_.b.TEXT_SHOW_BASELINE){s.strokeStyle=A,s.setLineDash([2,2]),s.lineWidth=1;let m=f+E;for(let S=0;S<this._lines.length;++S)this._drawLine(s,[c,m],[c+this.displayWidth,m]),m+=this._lineSpacing}_.b.TEXT_SHOW_BORDER&&(s.strokeStyle=A,s.setLineDash([]),s.lineWidth=1,this._drawBox(s,[c,f],[this.displayWidth,this.displayHeight])),this._hasBackground&&(this._roundedRect(s,c,f,this._parameters.definition.background.borderRadius*this.renderPixelRatio),s.globalCompositeOperation="destination-over",s.fillStyle=this._parameters.backgroundStyle,s.fill()),s.restore()}_renderLineDecoration(s,r,o,c,f=!1){if("none"===this._parameters.definition.font.decoration||0===c)return;const E=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":o+=2*E;break;case"line-through":o-=.33*this._midLineAscent}const T=f?this._haloSize:0;s.strokeStyle=f?this._parameters.haloStyle:this._parameters.textStyle,s.lineWidth=this._toRenderUnit(E+2*T),s.beginPath(),s.moveTo(this._toRenderUnit(r-T),this._toRenderUnit(o)),s.lineTo(this._toRenderUnit(r+c+T),this._toRenderUnit(o)),s.stroke()}_roundedRect(s,r,o,c){r=this._toRenderUnit(r),o=this._toRenderUnit(o);const f=this.renderedWidth,p=this.renderedHeight;0!==c?(c=(0,w.qE)(c,0,Math.floor(p/2)),s.beginPath(),s.moveTo(r,o+c),s.arcTo(r,o,r+c,o,c),s.lineTo(r+f-c,o),s.arcTo(r+f,o,r+f,o+c,c),s.lineTo(r+f,o+p-c),s.arcTo(r+f,o+p,r+f-c,o+p,c),s.lineTo(r+c,o+p),s.arcTo(r,o+p,r,o+p-c,c),s.closePath()):s.rect(r,o,f,p)}_renderHalo(s,r,o,c,f){const p=this.renderedWidth,E=this.renderedHeight,T=(0,D.y)(K,Math.max(p,W),Math.max(E,W)),m=T.getContext("2d");m.clearRect(0,0,p,E),this._parameters.setFontProperties(m,this._renderedFontSize),m.fillStyle=this._parameters.haloStyle,m.strokeStyle=this._parameters.haloStyle;const S=this._renderedHaloSize<3;m.lineJoin=S?"miter":"round",S?this._renderHaloEmulated(m,c,f):this._renderHaloNative(m,c,f);let O=f;for(let Y=0;Y<this._lines.length;++Y){const x=this._getLineXOffset(Y);this._renderLineDecoration(m,c+x,O,this._textWidths[Y],!0),O+=this._lineSpacing}s.globalAlpha=this._parameters.definition.halo.color[3],s.drawImage(T,0,0,p,E,this._toRenderUnit(r),this._toRenderUnit(o),p,E),s.globalAlpha=1}_renderHaloEmulated(s,r,o){for(let c=0;c<this._lines.length;++c){const f=this._lines[c],p=this._getLineXOffset(c);for(const[E,T]of F)this._fillText(s,f,r+p+this._haloSize*E,o+this._haloSize*T);o+=this._lineSpacing}}_renderHaloNative(s,r,o){const c=2*this._haloSize;for(let f=0;f<this._lines.length;++f){const p=this._lines[f],E=this._getLineXOffset(f),T=5,m=.1;for(let S=0;S<T;S++)s.lineWidth=this._toRenderUnit((1-(T-1)*m+S*m)*c),this._strokeText(s,p,r+E,o);o+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(s){return s*this.renderPixelRatio}_toRoundedRenderUnit(s){return Math.round(s*this.renderPixelRatio)}_fillText(s,r,o,c){s.fillText(r,this._toRenderUnit(o),this._toRenderUnit(c))}_strokeText(s,r,o,c){s.strokeText(r,this._toRenderUnit(o),this._toRenderUnit(c))}_drawLine(s,r,o){s.beginPath(),s.moveTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),s.lineTo(this._toRoundedRenderUnit(o[0])+.5,this._toRoundedRenderUnit(o[1])+.5),s.stroke()}_drawBox(s,r,o){const c=this._toRenderUnit(r[0]),f=this._toRenderUnit(r[1]),p=this._toRenderUnit(o[0]),E=this._toRenderUnit(o[1]),T=Math.floor(c)+.5,m=Math.ceil(c+p)-.5,S=Math.floor(f)+.5,O=Math.ceil(f+E)-.5;s.beginPath(),s.moveTo(T,S),s.lineTo(m,S),s.lineTo(m,O),s.lineTo(T,O),s.lineTo(T,S),s.stroke()}}const F=[];for(let s=0;s<360;s+=22.5)F.push([Math.cos(Math.PI*s/180),Math.sin(Math.PI*s/180)]);var v,B;(B=v||(v={}))[B.Left=0]="Left",B[B.Center=1]="Center",B[B.Right=2]="Right";const K={canvas:null},Q=.2,W=512,A="rgb(255, 0, 255, 0.5)";class H{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(s,r,o,c,f){this.firstLineAscent=s,this.lastLineDescent=r,this.maxLineAscent=o,this.maxLineDescent=c,this.displayWidth=f}}},93758:(tt,j,a)=>{a.d(j,{L:()=>G});var w=a(10467),_=a(8189),M=a(89952),D=a(5922),U=a(60797),V=a(11432),F=a(56492),v=a(85211),W=(a(3248),a(35150),a(76576)),A=a(62789),H=a(28714),B=a(25866),s=a(89141),r=a(45321),o=a(79439),c=a(48499),f=a(80009),p=a(74567),E=a(85732),T=a(14253);class m{constructor(t=1/0,i=-1/0){this.near=t,this.far=i}set(t,i){this.near=t,this.far=i}union(t){null!=t&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}}m.zero=new m(0,0);var S=a(8978),O=a(83926),Y=a(55128),x=a(65388),u=a(40972),rt=a(98877),ht=a(42425),et=a(31610),nt=a(32954),k=a(92771),L=a(45434),it=a(56632),ut=a(32788),gt=a(50915);class Lt{constructor(t,i,n){this._elementSize=i,this._buffer=ut.g.createVertex(t,gt._U.STATIC_DRAW),this.resize(n)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(t,i,n,l=0){const h=new Uint8Array(this.array,t*this.elementSize,(i-t)*this.elementSize);new Uint8Array(n.array,l*this.elementSize).set(h)}transferAll(){this._buffer.setData(this._array)}transferRange(t,i){const n=t*this._elementSize,l=i*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),n,n,l)}resize(t){const i=t*this._elementSize,n=new ArrayBuffer(i);this._array&&(t>=this._capacity?new Uint8Array(n).set(new Uint8Array(this._array)):new Uint8Array(n).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=n,this._buffer.setSize(i),this._capacity=t}}class xt{constructor(t){this.modelOriginHi=t.getField(u.r.INSTANCEMODELORIGINHI,L.xs),this.modelOriginLo=t.getField(u.r.INSTANCEMODELORIGINLO,L.xs),this.model=t.getField(u.r.INSTANCEMODEL,L.jZ),this.modelNormal=t.getField(u.r.INSTANCEMODELNORMAL,L.jZ),this.featureAttribute=t.getField(u.r.INSTANCEFEATUREATTRIBUTE,L.Eq),this.color=t.getField(u.r.INSTANCECOLOR,L.XP),this.objectAndLayerIdColor=t.getField(u.r.INSTANCEOBJECTANDLAYERIDCOLOR,L.XP)}}class Ct{constructor(t,i){this._rctx=t,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,x.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,x.vA)(this._updating,"not updating"),this.size<M.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,x.vA)(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),(0,x.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){(0,x.vA)(this._updating,"not updating"),(0,x.vA)(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(at,Math.floor(this._capacity*M.Ji));this._resize(t)}_shrink(){const t=Math.max(at,Math.floor(this._capacity*M.He));this._resize(t)}_resize(t){if((0,x.vA)(this._updating,"not updating"),t===this._capacity)return;const i=new Lt(this._rctx,this._instanceBufferLayout.stride,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const n=this.size,l=this._compactInstances(i);(0,x.vA)(l===n,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=l,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new xt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const i=this._headIndex,n=this._tailIndex;return n<i?(this._buffer.copyRange(n,i,t),i-n):n>i?(this._buffer.copyRange(n,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-n),i+(this._capacity-n)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const at=64;var I,e;(e=I||(I={}))[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE";class _t{constructor(t){this.localTransform=t.getField(u.r.LOCALTRANSFORM,L.E$),this.globalTransform=t.getField(u.r.GLOBALTRANSFORM,L.E$),this.modelOrigin=t.getField(u.r.MODELORIGIN,L.Xm),this.model=t.getField(u.r.INSTANCEMODEL,L.jZ),this.modelNormal=t.getField(u.r.INSTANCEMODELNORMAL,L.jZ),this.modelScaleFactors=t.getField(u.r.MODELSCALEFACTORS,L.gH),this.boundingSphere=t.getField(u.r.BOUNDINGSPHERE,L.Aj),this.featureAttribute=t.getField(u.r.FEATUREATTRIBUTE,L.Eq),this.color=t.getField(u.r.COLOR,L.XP),this.objectAndLayerIdColor=t.getField(u.r.OBJECTANDLAYERIDCOLOR,L.XP),this.state=t.getField(u.r.STATE,L.SL),this.lodLevel=t.getField(u.r.LODLEVEL,L.SL)}}let q=class extends rt.A{constructor(e,t){super(e),this.events=new ht.A,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=function Mt(e){let t=(0,c.BP)().mat4f64(u.r.LOCALTRANSFORM).mat4f64(u.r.GLOBALTRANSFORM).vec4f64(u.r.BOUNDINGSPHERE).vec3f64(u.r.MODELORIGIN).mat3f(u.r.INSTANCEMODEL).mat3f(u.r.INSTANCEMODELNORMAL).vec2f(u.r.MODELSCALEFACTORS);return e.includes(u.r.FEATUREATTRIBUTE)&&(t=t.vec4f(u.r.FEATUREATTRIBUTE)),e.includes(u.r.COLOR)&&(t=t.vec4u8(u.r.COLOR)),e.includes(u.r.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(u.r.OBJECTANDLAYERIDCOLOR)),t=t.u8(u.r.STATE).u8(u.r.LODLEVEL),t}(t),this._capacity=at,this._buffer=this._layout.createBuffer(this._capacity),this._view=new _t(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,I.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){(0,x.vA)(e>=0&&e<this._capacity&&!!(this._view.state.get(e)&I.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,I.ACTIVE)?this._setStateFlags(e,I.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;(0,x.vA)(e>=0&&e<this._capacity&&!!(t.get(e)&I.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=z,n=Z;t.localTransform.getMat(e,ft),t.globalTransform.getMat(e,ot);const l=(0,k.lw)(ot,ot,ft);(0,H.i)(i,l[12],l[13],l[14]),t.modelOrigin.setVec(e,i),(0,et.z0)(n,l),t.model.setMat(e,n);const h=(0,it.wp)(z,l);h.sort(),t.modelScaleFactors.set(e,0,h[1]),t.modelScaleFactors.set(e,1,h[2]),(0,et.B8)(n,n),(0,et.mg)(n,n),t.modelNormal.setMat(e,n),this._setStateFlags(e,I.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,Z),i.modelOrigin.getVec(e,z),t[0]=Z[0],t[1]=Z[1],t[2]=Z[2],t[3]=0,t[4]=Z[3],t[5]=Z[4],t[6]=Z[5],t[7]=0,t[8]=Z[6],t[9]=Z[7],t[10]=Z[8],t[11]=0,t[12]=z[0],t[13]=z[1],t[14]=z[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(z,this,e),t*=Math.max(z[0],z[1],z[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(z,this,e),t*=function Ot(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}(z[0],z[1],z[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,I.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,I.VISIBLE)}setHighlight(e,t){const{_highlightOptionsMap:i}=this,n=i.get(e);t?t!==n&&(i.set(e,t),this._setStateFlag(e,I.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):n&&(i.delete(e),this._setStateFlag(e,I.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,I.HIGHLIGHT)}geHighlightOptionsPrev(e){const t=this._highlightOptionsMapPrev.get(e)??null;return this._highlightOptionsMapPrev.delete(e),t}getHighlightName(e){const t=this.highlightOptionsMap.get(e)??null;return t?this._highlightOptionsMapPrev.set(e,t):this._highlightOptionsMapPrev.delete(e),t}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(at,Math.floor(this._capacity*M.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new _t(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&I.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};(0,_._)([(0,v.MZ)({constructOnly:!0})],q.prototype,"shaderTransformation",void 0),(0,_._)([(0,v.MZ)()],q.prototype,"_size",void 0),(0,_._)([(0,v.MZ)({readOnly:!0})],q.prototype,"size",null),q=(0,_._)([(0,W.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],q);const z=(0,B.vt)(),Z=(0,nt.vt)(),ft=(0,A.vt)(),ot=(0,A.vt)();var lt=a(83989);class bt extends O.A{constructor(t,i){super(n=>(0,lt.w)(this._instanceData.view.boundingSphere.getVec(n,this._tmpSphere)),{maximumDepth:25}),this._instanceData=t,this._boundingSphere=i,this._tmpSphere=(0,lt.c)(),this._tmpMat4=(0,A.vt)()}addInstance(t){const i=this._instanceData.view.boundingSphere,n=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);(0,H.t)((0,lt.a)(this._tmpSphere),this._boundingSphere.center,n),this._tmpSphere[3]=this._boundingSphere.radius*(0,it.hG)(n),i.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class Dt{constructor(t,i){this._worldSpaceRadius=t,this._minScreenSpaceRadii=i}selectLevel(t,i,n){const l=n.computeScreenPixelSizeAt(t),h=this._worldSpaceRadius*i/l;let d=0;for(let R=1;R<this._minScreenSpaceRadii.length;++R)h>=this._minScreenSpaceRadii[R]&&(d=R);return d}}var st=a(2296),Ft=a(88577),Ht=a(30614);class Nt{constructor(t,i){const n=t.renderContext.rctx,l=i.geometry,h=i.geometry.getRenderGeometry(),d=h.material;this._materials=t.materials,d.setParameters({instancedDoublePrecision:!0}),this.geometry=l,this.material=d,this.glMaterials=new Ft.c(d,this._materials),this.vertexBufferLayout=h.vertexBufferLayout,this.vbo=ut.g.createVertex(n,gt._U.STATIC_DRAW,h.buffer),this.vao=new Ht.Z(n,T.D,new Map([["geometry",(0,o.U)(h.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=h.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(t,i,n,l,h,d,R,g){return this.geometry.intersect(t,i,n,l,h,d,R,g)}}class ct{static create(t,i,n){return(0,w.A)(function*(){const l=yield Promise.allSettled(i.components.map(d=>t.controller.schedule(()=>new Nt(t,d),n))),h=l.map(d=>"fulfilled"===d.status?d.value:null).filter(M.Ru);if((0,F.G4)(n)||h.length!==l.length){h.forEach(d=>d.destroy()),(0,F.Te)(n);for(const d of l)if("rejected"===d.status)throw d.reason}return new ct(i.minScreenSpaceRadius,h)})()}constructor(t,i){this.minScreenSpaceRadius=t,this.components=i}destroy(){this.components.forEach(t=>t.destroy())}intersect(t,i,n,l,h,d,R){this.components.forEach(g=>g.intersect(t,i,n,l,h,d,this.boundingSphere,R))}get boundingBox(){if(null==this._boundingBox){const t=(0,st.Ie)();this.components.forEach(i=>{null!=i.boundingInfo&&((0,st.iT)(t,i.boundingInfo.bbMin),(0,st.iT)(t,i.boundingInfo.bbMax))}),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const t=this.boundingBox,i=(0,B.vt)();(0,st.gX)(t,i),this._boundingSphere={center:i,radius:.5*(0,st._F)(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((t,i)=>t+i.triangleCount,0)}}var Ut=a(3264),Bt=a(58309),wt=a(2301),dt=a(56253),mt=a(34150),pt=a(84757);let G=class extends E.Cc{constructor(e,t){super(e),this.type=S.dz.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new f.A,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[Y.N.OPAQUE_MATERIAL,i=>this._produces(i)],[Y.N.TRANSPARENT_MATERIAL,i=>!!this._hasTransparentLevels()&&this._produces(i)]]),this._instanceData=new q({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(mt.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function Vt(e){let t=(0,c.BP)().vec3f(u.r.INSTANCEMODELORIGINHI).vec3f(u.r.INSTANCEMODELORIGINLO).mat3f(u.r.INSTANCEMODEL).mat3f(u.r.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(u.r.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(u.r.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(u.r.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,o.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)t[0]!==dt.Tv&&e.push(t[1]);return e}hasHighlightOptions(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(e=>e.components.some(t=>t.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((i,n)=>i+n.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((i,n)=>i+n.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((i,n)=>{const l=this._allRenderInstanceData[0][n].size+this._allRenderInstanceData[1][n].size,h=i.triangleCount;t.push({renderedInstances:l,renderedTriangles:l*h,trianglesPerInstance:h})}),{totalInstances:e,renderedInstances:t.reduce((i,n)=>i+n.renderedInstances,0),renderedTriangles:t.reduce((i,n)=>i+n.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(e=[]){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(i=>{e.push(new Ct(t,this._instanceBufferLayout))}),e}initializeRenderContext(e,t){var i=this;return(0,w.A)(function*(){i._context=e,i._createRenderInstanceDataArray(i._defaultRenderInstanceData);const n=yield Promise.allSettled(i.symbol.levels.map(h=>ct.create(e,h,t))),l=n.map(h=>"fulfilled"===h.status?h.value:null).filter(M.Ru);if((0,F.G4)(t)||l.length!==n.length){l.forEach(h=>h.destroy()),(0,F.Te)(t);for(const h of n)if("rejected"===h.status)throw h.reason}i._levels=l,i._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map(n=>n.minScreenSpaceRadius);return new Dt(t,i)})(i)})()}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDataMap.forEach(e=>e.forEach(t=>t.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(t=>t.material.produces.get(Y.N.TRANSPARENT_MATERIAL)?.(p.V.Color)))}hasHighlights(){return(0,U.Bs)(this._highlightRenderInstanceDataMap,e=>e.some(t=>t.size>0))}_produces(e){return(e!==p.V.Highlight||this.hasHighlights())&&(e!==p.V.ShadowHighlight||this.hasHighlightOptions(dt.Tv))}prepareRender(e){if(!r.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(mt.Bb),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const i=new Array,n=this.levels;return t.forEach(l=>n.forEach(({components:h},d)=>h.forEach(R=>i.push(this._beginComponent(e,l[d],R))))),i}render(e,t){const i=this._getInstanceDatas(e);if(!i||null==t)return;let n=0;e.rctx.bindVAO();const l=this.levels;i.forEach(h=>l.forEach(({components:d},R)=>d.forEach(g=>this._renderComponent(e,t[n++],h[R],g,R))))}_getInstanceDatas(e){const{output:t,bind:i}=e,n=t===p.V.Highlight,l=t===p.V.ShadowHighlight,d=t!==p.V.ShadowExcludeHighlight;if(!n&&!l)return d?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(d){if(n){const g=i.highlight?.name;if(!g)return null;const C=this._highlightRenderInstanceDataMap.get(g);return C?[C]:null}const R=this._highlightRenderInstanceDataMap.get(dt.Tv);return l?R?[R]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(e,t,i,n){if(!this.baseMaterial.visible||null==this._octree)return;const l=(0,B.vt)();(0,H.d)(l,n,i);const h=d=>{this._instanceData.getCombinedModelTransform(d,yt),e.transform.set(yt),(0,H.t)(At,i,e.transform.inverse),(0,H.t)(Rt,n,e.transform.inverse);const R=this._instanceData.getState(d),g=this._instanceData.getLodLevel(d),C=this._levels.length;(0,x.vA)(!!(R&I.ACTIVE),"invalid instance state"),(0,x.vA)(g>=0&&g<C,"invaid lod level"),this._levels[g].intersect(e,t,At,Rt,d,this.metadata,C)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(h):this._octree.forEachAlongRay(i,l,h)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new bt(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)t.get(i)&I.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,V.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new m;const t=e.viewForward,i=this._octree.findClosest(t,O.A.DepthOrder.FRONT_TO_BACK,e.frustum),n=this._octree.findClosest(t,O.A.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==i||null==n)return new m;const l=e.eye,h=this._instanceData.view;h.boundingSphere.getVec(i,J),(0,H.d)(J,J,l);const d=(0,H.f)(J,t)-J[3];h.boundingSphere.getVec(n,J),(0,H.d)(J,J,l);const R=(0,H.f)(J,t)+J[3];return new m(d,R)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(t=>t.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:n}=this;this._allRenderInstanceData.forEach(b=>b.forEach(y=>y.beginUpdate()));const l=this._instanceData,h=l.view;let d=l.size;const R=l.capacity;let g=this._instanceIndex;const C=Math.ceil(R/500);for(let b=0;b<d&&!e.done;++b){g===this._cycleStartIndex&&this._startUpdateCycle();const y=h.state.get(g);let $=0;if(!(y&I.ALLOCATED)){g=g+1===R?0:g+1,d++;continue}const P=h.lodLevel.get(g);if(y&I.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[P].freeTail(),y&I.HIGHLIGHT_ACTIVE){const N=l.geHighlightOptionsPrev(g);if(N){const X=this._highlightRenderInstanceDataMap.get(N);if(!X)throw new D.A("Internal error in lodRenderer");X[P].freeTail()}}if(y&I.REMOVE)l.freeInstance(g);else if(y&I.VISIBLE){let N=0;if(t&&(h.modelOrigin.getVec(g,It),N=n.selectLevel(It,l.getCombinedMedianScaleFactor(g),i)),$=y&~(I.ACTIVE|I.TRANSFORM_CHANGED),N>=0)if(y&I.HIGHLIGHT){const X=l.getHighlightName(g);if(X){const Et=(0,U.tE)(this._highlightRenderInstanceDataMap,X,()=>{const St=this._createRenderInstanceDataArray();return St.forEach(jt=>jt.beginUpdate()),St});if(N>=Et.length)throw new D.A(`LodRenderer internal error - missing lodLevel ${N}`);vt(Et[N],h,g)}$|=I.HIGHLIGHT_ACTIVE}else vt(this._defaultRenderInstanceData[N],h,g),$|=I.DEFAULT_ACTIVE;h.state.set(g,$),h.lodLevel.set(g,N)}else $=y&~(I.ACTIVE|I.TRANSFORM_CHANGED),h.state.set(g,$);if(null!=this._octreeCached){const N=!!(y&I.ACTIVE),X=!!($&I.ACTIVE);!N&&X?this._octreeCached.addInstance(g):N&&!X?this._octreeCached.removeInstance(g):N&&X&&y&I.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(g),this._octreeCached.addInstance(g))}g=g+1===R?0:g+1,g%C==0&&e.madeProgress()}this._instanceIndex=g,this._allRenderInstanceData.forEach(b=>b.forEach(y=>y.endUpdate())),this._context.requestRender()}_beginComponent(e,t,i){return 0===t.size?null:i.glMaterials.load(e.rctx,e.bind.slot,e.output)?.beginSlot(e.bind)}_renderComponent(e,t,i,n,l){if(!t)return;const{bind:h,rctx:d}=e;d.runAppleAmdDriverHelper();const R=d.bindTechnique(t,h,n.material.parameters,Wt);d.bindVAO(n.vao),t.ensureAttributeLocations(n.vao),r.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===p.V.Color&&(R.setUniform4fv("externalColor",Tt[Math.min(l,Tt.length-1)]),R.setUniform1i("colorMixMode",Ut.Um.replace));const g=i.capacity,C=i.headIndex,b=i.tailIndex,y=i.firstIndex,$=this._glInstanceBufferLayout,P=(N,X)=>{(0,pt.yu)(d,T.D,i.buffer,$,N),d.drawArraysInstanced(t.primitiveType,0,n.vertexCount,X-N),(0,pt.Hi)(d,T.D,i.buffer,$)};n.material.parameters.transparent&&null!=y?C>b?((0,x.vA)(y>=b&&y<=C,"invalid firstIndex"),P(y,C),P(b,y)):C<b&&(y<=C?((0,x.vA)(y>=0&&y<=C,"invalid firstIndex"),P(y,C),P(b,g),P(0,y)):((0,x.vA)(y>=b&&y<=g,"invalid firstIndex"),P(y,g),P(0,C),P(b,y))):C>b?P(b,C):C<b&&(P(0,C),P(b,g)),d.bindVAO(null)}};function vt(e,t,i){const n=e.allocateHead();!function Pt(e,t,i,n){(0,Bt.Vk)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,n),i.model.copyFrom(n,e.model,t),i.modelNormal.copyFrom(n,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(n,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(n,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(n,e.featureAttribute,t)}(t,i,e.view,n)}(0,_._)([(0,v.MZ)({constructOnly:!0})],G.prototype,"symbol",void 0),(0,_._)([(0,v.MZ)({constructOnly:!0})],G.prototype,"optionalFields",void 0),(0,_._)([(0,v.MZ)({constructOnly:!0})],G.prototype,"metadata",void 0),(0,_._)([(0,v.MZ)({constructOnly:!0})],G.prototype,"shaderTransformation",void 0),(0,_._)([(0,v.MZ)()],G.prototype,"_instanceData",void 0),(0,_._)([(0,v.MZ)()],G.prototype,"_cycleStartIndex",void 0),(0,_._)([(0,v.MZ)({readOnly:!0})],G.prototype,"_enableLevelSelection",null),(0,_._)([(0,v.MZ)()],G.prototype,"_updateCyclesWithStaticCamera",void 0),(0,_._)([(0,v.MZ)({readOnly:!0})],G.prototype,"running",null),G=(0,_._)([(0,W.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],G);const It=(0,B.vt)(),J=(0,s.vt)(),yt=(0,A.vt)(),At=(0,B.vt)(),Rt=(0,B.vt)(),Tt=[(0,s.fA)(1,0,1,1),(0,s.fA)(0,0,1,1),(0,s.fA)(0,1,0,1),(0,s.fA)(1,1,0,1),(0,s.fA)(1,0,0,1)],Wt=new wt.V}}]);