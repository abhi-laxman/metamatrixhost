"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[345],{60345:(Ge,de,y)=>{y.r(de),y.d(de,{default:()=>ze});var j,e,g=y(10467),T=y(8189),ge=y(42139),G=y(31178),Y=y(5922),R=y(35150),q=y(60797),ye=y(39693),U=y(56492),Q=y(48900),v=y(85211),he=(y(3248),y(40707),y(76576)),K=y(26514),ie=y(28067),ne=y(1749),re=y(93615),pe=y(95478),_=y(31732),p=y(62799);(e=j||(j={})).MULTIPLIER="multiplier",e.ABSOLUTE="absolute-value";var I=y(55540),f=y(85574),L=y(43326),D=y(74148),F=y(27783),V=y(93410),we=y(17049),oe=y(33036),Re=y(22329),b=y(63468),Oe=y(4965);let S=class extends((0,we.q)((0,V.dM)((0,oe.j)((0,ye.P)(pe.A))))){constructor(e){if(super(e),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"organic-standard"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(G.A.ofType(f.A)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ie.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(G.A.ofType(f.A)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.initializationInclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.initializationInclusionModeDefinition)throw new Y.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles((0,Q.wB)(()=>this.layers.concat(this.tables),(a,t)=>this._handleSublayersChange(a,t),Q.OH))}normalizeCtorArgs(e){if(!e)return{};const{url:a,title:t,dataPreloadedInLocalCache:r,initializationLinkChartConfig:i}=e;return{url:a,title:t,dataPreloadedInLocalCache:r,initializationLinkChartConfig:i}}_initializeLayerProperties(e){if(!this.title&&this.url){const n=this.url.split("/");this.title=n[n.length-2]}const a=new Set;let t=[],r=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new Y.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(t=e.knowledgeGraph.dataModel.entityTypes??[],r=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,l)=>{const o=this._graphTypeLookup.get(l);if(!o)return R.A.getLogger(this).warn(`A named type, ${l}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(l);"relationship"===o.type?a.has(l)||(a.add(l),r.push(o)):"entity"===o.type?a.has(l)||(a.add(l),t.push(o)):(R.A.getLogger(this).warn(`A named type, ${l}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(l))}):(t=e.knowledgeGraph.dataModel.entityTypes??[],r=e.knowledgeGraph.dataModel.relationshipTypes??[]);const i=new I.P({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=t,this.memberRelationshipTypes=r,this.dataManager=i}load(e){var a=this;const t=function(){var r=(0,g.A)(function*(){const i=[],n=[];a.loadLayerAssumingLocalCache(),a._layersLoadedFromAuthoritativeItem()||(yield(0,L.qN)(a)),a.dataManager.inclusionModeDefinition&&(a.dataManager.inclusionModeDefinition.generateAllSublayers=!1),a.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(l=>{l.useAllData=!1}),yield a._initializeDiagram(),a.layers.forEach(l=>{n.push(l.refreshCachedQueryEngine()),i.push(new Promise(o=>{l.on("layerview-create",()=>{o(null)})}))}),a.tables.forEach(l=>{n.push(l.refreshCachedQueryEngine())}),yield Promise.all(n)});return function(){return r.apply(this,arguments)}}();return this.addResolvingPromise(new Promise(r=>{(0,Oe.fetchKnowledgeGraph)(this.url).then(function(){var i=(0,g.A)(function*(n){n.dataModel.entityTypes?.forEach(o=>{o.name&&a._graphTypeLookup.set(o.name,o)}),n.dataModel.relationshipTypes?.forEach(o=>{o.name&&a._graphTypeLookup.set(o.name,o)});const l=a.linkChart?.linkChartProperties;if(l?.originIdOf("entitiesUrl")===K.Gr.LINK_CHART&&(a.membershipModified=!1,a._originalInclusionList=yield ge.XW.fetchAndConvertSerializedLinkChart({entitiesUrl:l?.entitiesUrl,relationshipsUrl:l?.relationshipsUrl}),a._alignLayersDataModelAndInclusionDefinition(n.dataModel),a.initializationLinkChartConfig={layoutSettings:l?.layoutSettings??void 0,layoutMode:(0,F.k5)(l.layoutType)}),a._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:a._originalInclusionList}),a.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(a.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},a.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&a.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(o.name,{useAllData:!0})}),a.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(o=>{o.name&&a.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(o.name,{useAllData:!0})})),a.dataPreloadedInLocalCache){const o=D.A.getInstance();for(const[M,k]of a.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(const w of k.members?.values()??[]){const C=o.readFromStoreById(`${M}__${w.id}`);C&&(0,q.tE)(a.dataManager.sublayerCaches,M,()=>new Map).set(w.id,C)}yield t()}else a.addResolvingPromise(a.dataManager.refreshCacheContent(void 0,!1,"geographic-organic-standard"===a.initializationLinkChartConfig?.layoutMode,!0).then((0,g.A)(function*(){(0,U.Te)(e),yield t()})));r(null)});return function(n){return i.apply(this,arguments)}}())})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("initializationInclusionModeDefinition",e):R.A.getLogger(this).error("#initializationInclusionModeDefinition","initializationInclusionModeDefinition cannot be changed after the layer is loaded.")}get linkChart(){return this.parent}addRecords(e,a){var t=this;return(0,g.A)(function*(){let r=[];a?.cascadeAddRelationshipEndNodes&&t.dataManager.knowledgeGraph.dataModel&&(r=yield(0,F.aq)(e,t.dataManager.knowledgeGraph));const i=e.concat(r).filter(n=>!t.sublayerIdsCache.get(n.typeName)?.has(n.id));i.length>0&&(t.membershipModified=!0),yield t._handleNewRecords(i,a)})()}removeRecords(e,{cascadeRemoveRelationships:a=!0,recalculateLayout:t=!1,overrideMembershipCheck:r=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){var i=this;return(0,g.A)(function*(){let n=[];for(const o of e)(r||!1===i.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(o.typeName)?.useAllData&&i.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(o.typeName)?.members?.has(o.id))&&n.push(o);if(a){const o=new Set,M=[];for(const k of n)if(i.dataManager.nodeConnectionsLookup.has(k.id))for(const w of i.dataManager.nodeConnectionsLookup.get(k.id))o.add(w);for(const k of o)if(i.dataManager.memberIdTypeLookup.has(k))for(const w of i.dataManager.memberIdTypeLookup.get(k))i.dataManager.relationshipTypeNames.has(w)&&M.push({id:k,typeName:w});n=n.concat(M)}i.dataManager.removeFromLayer(n);for(const o of n)i.sublayerIdsCache.get(o.typeName)?.delete(o.id),i.dataManager.relationshipTypeNames.has(o.typeName)?i.relationshipLinkChartDiagramLookup.delete(o.id):i.entityLinkChartDiagramLookup.delete(o.id);t&&(yield i._calculateLayoutWithSublayerTimeInfo(i._currentLinkChartConfig.layoutMode,{layoutSettings:i._currentLinkChartConfig.layoutSettings})),n.length>0&&(i.membershipModified=!0);const l=[];return i.layers.forEach(o=>{l.push(o.refreshCachedQueryEngine())}),yield Promise.all(l),i._refreshNamedTypes(),n})()}expand(e,a){var t=this;return(0,g.A)(function*(){let r=[];try{const i=yield t.dataManager.getConnectedRecordIds(e,a?.relationshipTypeNames,a);r=i.filter(n=>!t.sublayerIdsCache.get(n.typeName)?.has(n.id)),yield t._handleNewRecords(i,a),i.length>0&&(t.membershipModified=!0),(0,U.Te)(a?.signal)}catch(i){throw(0,U.zf)(i)&&r.length>0&&t.removeRecords(r,{overrideMembershipCheck:!0}),i}return{records:r}})()}loadLayerAssumingLocalCache(){const e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.originIdOf("layers")===K.Gr.DEFAULTS?this._createSublayers(e,this.layers,a=>!!a.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===K.Gr.DEFAULTS?this._createSublayers(e,this.tables,a=>!a.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,t)=>{const r=(0,q.tE)(this.sublayerIdsCache,t,()=>new Set);a.members?.forEach(({id:i,linkChartLocation:n})=>{if(r.add(i),n){const l="coords"in n&&"lengths"in n?n:(0,_.Ux)(n);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(i,l):this.entityLinkChartDiagramLookup.set(i,l)}})})}calculateLinkChartLayout(e="organic-standard",a){var t=this;return(0,g.A)(function*(){const r=[],i=[],n=[];t.dataManager.sublayerCaches.forEach((s,h)=>{t.dataManager.entityTypeNames.has(h)?s.forEach(d=>{r.push({typeName:h,feature:d})}):t.dataManager.relationshipTypeNames.has(h)&&s.forEach(d=>{i.push({typeName:h,feature:d})})}),t.entityLinkChartDiagramLookup=new Map,t.relationshipLinkChartDiagramLookup=new Map;const l=new Map,o=new Map,M=new Map,k=new Map,w=new Uint8Array(r.length),C=new Float64Array(r.length),A=new Float64Array(r.length),W=new Float64Array(r.length),E=new Float64Array(r.length),me=new Uint32Array(i.length),fe=new Uint32Array(i.length),Ae=new Float64Array(i.length),Ie=new Float64Array(i.length),m=[],B=new ie.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let ee,ke="organic-standard",u=0,O=0;const Fe=b.i6.apply;switch(ke="geographic-organic-standard"===e?"organic-standard":e,ke){case"organic-standard":ee=b.pM.apply;break;case"organic-community":ee=b.Tu.apply;break;case"hierarchical-bottom-to-top":ee=b.$C.apply;break;case"radial-root-centric":ee=b.vJ.apply;break;case"tree-left-to-right":ee=b.Xq.apply;break;default:ee=b.Wg.apply}let Le=!1;r.forEach(({typeName:s,feature:h})=>{if("chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e&&a?.lockedNodeLocations?.has(h.attributes[p.dr])){w[u]="geographic-organic-standard"===e&&t.dataManager.geographicLookup.has(s)?b.tx.IsGeographic:b.tx.None;const d=a.lockedNodeLocations.get(h.attributes[p.dr]);C[u]=d.x,A[u]=d.y}else if("geographic-organic-standard"===e&&t.dataManager.geographicLookup.has(s)){w[u]=b.tx.IsGeographic;let d=null;const x=h.attributes[t.dataManager.geographicLookup.get(s).name];switch(t.dataManager.geographicLookup.get(s)?.geometryType){case"esriGeometryPoint":C[u]=x?.x,A[u]=x?.y;break;case"esriGeometryPolygon":d=x?.centroid,null!=d?.x&&null!=d?.y?(C[u]=d.x,A[u]=d.y):w[u]=b.tx.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":d=x?.extent?.center,null!=d?.x&&null!=d?.y?(C[u]=d.x,A[u]=d.y):w[u]=b.tx.IsMovable;break;default:w[u]=b.tx.IsMovable}(null==C[u]||null==A[u]||Number.isNaN(C[u])||Number.isNaN(A[u]))&&(w[u]=b.tx.IsMovable,C[u]=0,A[u]=0)}else if("chronological-mono-timeline"===e||"chronological-multi-timeline"===e){!Le&&a?.lockedNodeLocations?.has(h.attributes[p.dr])&&(Le=!0);const d=a?.timeInfoByTypeName?.get(s),x=d?.startField,$=x&&d?.startField?h.attributes[x]:null;W[u]=$?new Date($).getTime():NaN;const N=d?.endField,P=N&&d?.endField?h.attributes[N]:null;E[u]=P?new Date(P).getTime():NaN,C[u]=0,A[u]=0,w[u]=b.tx.IsMovable}else w[u]=b.tx.IsMovable,C[u]=0,A[u]=0;k.set(h.attributes[p.dr],u),m[u]={feature:h,typeName:s},u++}),Le&&R.A.getLogger(t).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let xe=!1;const Me=new Map;i.forEach(s=>{const h=s.feature.attributes[p.Cz],d=s.feature.attributes[p.KQ],x=k.get(h),$=k.get(d),N=a?.timeInfoByTypeName?.get(s.typeName),P=a?.timeInfoByTypeName?N?.startField:null,J=P?s.feature.attributes[P]:null,ue=N?.endField,te=ue?s.feature.attributes[ue]:null;if(void 0!==x&&void 0!==$){let H=h+"-"+d;"chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e||(H=H+"-"+J+"-"+te);const le=Me.get(H);le?.has(s.typeName)||(me[O]=x,fe[O]=$,"chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e||(Ae[O]=J?new Date(J).getTime():NaN,Ie[O]=te?new Date(te).getTime():NaN),void 0===le?Me.set(H,new Map([[s.typeName,O]])):le.set(s.typeName,O),O++),n.push(s)}else xe=!0,t.relationshipLinkChartDiagramLookup.set(h,null)}),xe&&R.A.getLogger(t).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const Be=t._validateOrganicLayoutSettings(e,a?.layoutSettings?.organicLayoutSettings),Te=t._convertValidatedOrganicSettingsToCalculationSettings(Be);yield(0,b.Hh)();let se=b.JT.Error,z=null;if("chronological-mono-timeline"===e||"chronological-multi-timeline"===e){let s;({status:se,links:z,graphics:s}=Fe(()=>a?.signal?.aborted??!1,w,C,A,W,E,me.subarray(0,O),fe.subarray(0,O),Ae.subarray(0,O),Ie.subarray(0,O),"chronological-multi-timeline"===e,a?.layoutSettings?.chronologicalLayoutSettings)),se===b.JT.Success&&(t.chronologicalAuxiliaryGraphics=s)}else({status:se,links:z}=ee(()=>a?.signal?.aborted??!1,w,C,A,me.subarray(0,O),fe.subarray(0,O),Te.computationBudgetTime,Te.idealEdgeLengthMultiplier,Te.repulsionRadiusMultiplier));if((0,U.Te)(a?.signal),se===b.JT.Error)throw new Y.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(se===b.JT.Canceled)throw(0,U.NK)();for(let s=0;s<m.length;s++){if(A[s]>84.9999?A[s]=84.9999:A[s]<-84.9999&&(A[s]=-84.9999),C[s]>179.9999?C[s]=179.9999:C[s]<-179.9999&&(C[s]=-179.9999),m[s].feature.attributes[p.T1]=new ne.A(C[s],A[s]),l.has(m[s].typeName))l.get(m[s].typeName)?.set(m[s].feature.attributes[p.dr],m[s].feature);else{const x=new Map;x.set(m[s].feature.attributes[p.dr],m[s].feature),l.set(m[s].typeName,x)}M.set(m[s].feature.attributes[p.dr],m[s].feature);const h=(0,_.Ux)(m[s].feature.attributes[p.T1]);t.entityLinkChartDiagramLookup.set(m[s].feature.attributes[p.dr],m[s].feature.attributes[p.T1]?h:null);const d=(0,q.tE)(t.dataManager.inclusionModeDefinition.namedTypeDefinitions,m[s].typeName,()=>({useAllData:!1,members:new Map}));(0,q.tE)(d.members,m[s].feature.attributes[p.dr],()=>({id:m[s].feature.attributes[p.dr],linkChartLocation:void 0})).linkChartLocation=m[s].feature.attributes[p.T1],m[s].feature.attributes[p.T1].x<B.xmin&&(B.xmin=m[s].feature.attributes[p.T1].x),m[s].feature.attributes[p.T1].x>B.xmax&&(B.xmax=m[s].feature.attributes[p.T1].x),m[s].feature.attributes[p.T1].y<B.ymin&&(B.ymin=m[s].feature.attributes[p.T1].y),m[s].feature.attributes[p.T1].y>B.ymax&&(B.ymax=m[s].feature.attributes[p.T1].y)}if(t.linkChartExtent.xmin=B.xmin,t.linkChartExtent.xmax=B.xmax,t.linkChartExtent.ymin=B.ymin,t.linkChartExtent.ymax=B.ymax,!z)throw new Y.A("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const ce=new Map,ve=new Map,be=new Map,Ne=new Set;for(let s=0;s<n.length;s++){const h=[],d=n[s],x=d.feature.attributes[p.Cz],$=d.feature.attributes[p.KQ];let N=x+"-"+$;if("chronological-mono-timeline"===e||"chronological-multi-timeline"===e){const c=a?.timeInfoByTypeName?.get(d.typeName),Z=a?.timeInfoByTypeName?c?.startField:null,X=Z?d.feature.attributes[Z]:null,ae=c?.endField;N+="-"+X+"-"+(ae?d.feature.attributes[ae]:null)}const P=Me.get(N).get(d.typeName),J=0===P?0:z?.vertexEndIndex[P-1];if(!Ne.has(P)){if(Ne.add(P),z.types[P]===b.J.Recursive){const c=[z.vertices[2*J],z.vertices[2*J+1]],Z=[z.vertices[2*(J+1)],z.vertices[2*(J+1)+1]],X=[.5*(c[0]+Z[0]),.5*(c[1]+Z[1])],ae=[X[0]-c[0],X[1]-c[1]],Ze=[X[0]+ae[1],X[1]-ae[0]],We=[X[0]-ae[1],X[1]+ae[0]];h.push(c),h.push(Ze),h.push(Z),h.push(We),h.push(c)}else{if(z.types[P]!==b.J.Regular){R.A.getLogger(t).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let c=J;c<z.vertexEndIndex[P];c++)h.push([z.vertices[2*c],z.vertices[2*c+1]])}if("chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e){const c=m[k.get(x)]?.feature.attributes[p.T1],Z=m[k.get($)]?.feature.attributes[p.T1];h[0][0]===c.x&&h[0][1]===c.y||(h[0]=[c.x,c.y]),h[h.length-1][0]===Z.x&&h[h.length-1][1]===Z.y||(h[h.length-1]=[Z.x,Z.y])}for(let c=1;c<h.length-1;c++)h[c][1]>85.5?h[c][1]=85.5:h[c][1]<-85.5&&(h[c][1]=-85.5),h[c][0]>179.9999?h[c][0]=179.9999:h[c][0]<-179.9999&&(h[c][0]=-179.9999);ce.has(N)?ce.get(N).push(h):ce.set(N,[h])}const ue=ce.get(N);ve.has(N)||(ve.set(N,new Map),be.set(N,new Map));const te=ve.get(N),H=be.get(N);te.has(d.typeName)||(te.set(d.typeName,ue.shift()),H.set(d.typeName,0));const le=te.get(d.typeName);H.set(d.typeName,H.get(d.typeName)+1);const Ee=new re.A({paths:[le]});if(d.feature.attributes[p.T1]=Ee,o.has(d.typeName))o.get(d.typeName)?.set(d.feature.attributes[p.dr],d.feature);else{const c=new Map;c.set(d.feature.attributes[p.dr],d.feature),o.set(d.typeName,c)}M.set(d.feature.attributes[p.dr],d.feature);const De=(0,_.Ux)(d.feature.attributes[p.T1]);t.relationshipLinkChartDiagramLookup.set(d.feature.attributes[p.dr],d.feature.attributes[p.T1]?De:null);const Ue=(0,q.tE)(t.dataManager.inclusionModeDefinition.namedTypeDefinitions,d.typeName,()=>({useAllData:!1,members:new Map}));(0,q.tE)(Ue.members,d.feature.attributes[p.dr],()=>({id:d.feature.attributes[p.dr],linkChartLocation:void 0})).linkChartLocation=De}for(const s of n)s.feature.attributes[p.M1]=be.get(s.feature.attributes[p.Cz]+"-"+s.feature.attributes[p.KQ])?.get(s.typeName)??null;return t._currentLinkChartConfig={layoutMode:e,layoutSettings:a?.layoutSettings?.clone()},{nodes:l,links:o,idMap:M}})()}applyNewLinkChartLayout(e="organic-standard",a){var t=this;return(0,g.A)(function*(){const r=[];yield t._calculateLayoutWithSublayerTimeInfo(e,a),t.layers.forEach(i=>{r.push(i.refreshCachedQueryEngine())}),t.membershipModified=!0,yield Promise.all(r),t._refreshNamedTypes()})()}getCurrentNodeLocations(){const e=new Map;for(const[a,t]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(a)||t?.members?.forEach(r=>{const i=r.linkChartLocation;let n;i&&(n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(r.id,new ne.A({x:n.x,y:n.y})))});return e}refreshLinkChartCache(e){var a=this;return(0,g.A)(function*(){yield a.dataManager.refreshCacheContent(e);const t=[];a.layers.forEach(r=>{t.push(r.refreshCachedQueryEngine())}),yield Promise.all(t),a._refreshNamedTypes()})()}connectBetweenEntities(e,a){var t=this;return(0,g.A)(function*(){if(!e.length)return{records:[]};let r=[];try{let i=[];for(const n of t.dataManager.relationshipTypeNames){const l=t.sublayerIdsCache.get(n);l&&(i=i.concat(Array.from(l.keys())))}r=yield t.dataManager.getRelationshipsBetweenNodes(e,i,a),yield t._handleNewRecords(r,a),(0,U.Te)(a)}catch(i){throw(0,U.zf)(i)&&t.removeRecords(r),i}return{records:r}})()}connectFromEntities(e,a){var t=this;return(0,g.A)(function*(){if(!e.length)return{records:[]};let r=[];try{let i=[];for(const l of t.dataManager.relationshipTypeNames){const o=t.sublayerIdsCache.get(l);o&&(i=i.concat(Array.from(o.keys())))}let n=[];for(const l of t.dataManager.entityTypeNames){const o=t.sublayerIdsCache.get(l);o&&(n=n.concat(Array.from(o)))}r=yield t.dataManager.getRelationshipsFromNodes(e,n,i,a),yield t._handleNewRecords(r,a),r.length>0&&(t.membershipModified=!0),(0,U.Te)(a)}catch(i){throw(0,U.zf)(i)&&t.removeRecords(r),i}return{records:r}})()}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}_calculateLayoutWithSublayerTimeInfo(e="organic-standard",a){var t=this;return(0,g.A)(function*(){const r=new Map;t.layers.forEach(i=>{r.set(i.objectType.name,i.timeInfo)}),yield t.calculateLinkChartLayout(e,{timeInfoByTypeName:r,...a}),t.linkChart?.handleChronologicalOverlay()})()}_handleNewRecords(e,a){var t=this;return(0,g.A)(function*(){const r=[];t.dataManager.addToLayer(e);for(const n of e)t.sublayerIdsCache.has(n.typeName)||(t.sublayerIdsCache.set(n.typeName,new Set),r.push(n.typeName)),t.sublayerIdsCache.get(n.typeName).add(n.id);for(const n of r){const l=t._graphTypeLookup.get(n);if(l){const o=t._createSublayer(l);"entity"===l.type?t.dataManager.entityTypeNames.add(n):t.dataManager.relationshipTypeNames.add(n),o.geometryType?t.layers.push(o):t.tables.push(o),t.dataManager.sublayerCaches.set(n,new Map)}}yield(0,L.qN)(t,r,a),yield t.dataManager.refreshCacheContent(e.map(n=>n.id),void 0,void 0,void 0,a);const i={layoutSettings:t._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(const[n,l]of t.entityLinkChartDiagramLookup.entries())l&&i.lockedNodeLocations.set(n,new ne.A(l.coords[0],l.coords[1]));yield t.applyNewLinkChartLayout(t._currentLinkChartConfig.layoutMode,i)})()}_createSublayers(e,a,t){e.forEach(r=>{const i=this._createSublayer(r);t(i)&&a.push(i),this._updateSublayerCaches(r)})}_updateSublayers(e,a){a.forEach(t=>{t.parentCompositeLayer=this;const r=e.find(i=>i.type===t.graphType&&i.name===t.graphTypeName);r&&(t.objectType=r,t.read({title:r.name},{origin:"service"}),this._updateSublayerCaches(r))})}_updateSublayerCaches(e){const a=this.dataManager.sublayerCaches;a.has(e.name)||a.set(e.name,new Map)}_layersLoadedFromAuthoritativeItem(){const e=this.originIdOf("layers");return e>=K.Gr.PORTAL_ITEM&&e<K.Gr.USER}_initializeDiagram(){var e=this;return(0,g.A)(function*(){e.initializationLinkChartConfig?e.initializationLinkChartConfig.doNotRecalculateLayout?(e.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,t)=>{a?.members?.forEach(r=>{const i=r.linkChartLocation;let n;const l=r.id;if(!i)return;n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const o=(0,_.Ux)(n);e.dataManager.relationshipTypeNames.has(t)?e.relationshipLinkChartDiagramLookup.set(l,o):e.entityLinkChartDiagramLookup.set(l,o),e.linkChartExtent.xmin>n.x&&(e.linkChartExtent.xmin=n.x),e.linkChartExtent.xmax<n.x&&(e.linkChartExtent.xmax=n.x),e.linkChartExtent.ymin>n.y&&(e.linkChartExtent.ymin=n.y),e.linkChartExtent.ymax<n.y&&(e.linkChartExtent.ymax=n.y)})}),e.memberRelationshipTypes.forEach(a=>{a.name&&e.dataManager.sublayerCaches.get(a.name)?.forEach(t=>{const r=e.relationshipLinkChartDiagramLookup.get(t.attributes[p.Cz]),i=e.relationshipLinkChartDiagramLookup.get(t.attributes[p.KQ]);if(r&&i){const n=(0,_.Ux)(new re.A({paths:[[[r.coords[0],r.coords[1]],[i.coords[0],i.coords[1]]]]}));e.relationshipLinkChartDiagramLookup.set(t.attributes[p.dr],n)}else e.relationshipLinkChartDiagramLookup.set(t.attributes[p.dr],null)})})):yield e._calculateLayoutWithSublayerTimeInfo(e.initializationLinkChartConfig.layoutMode,{lockedNodeLocations:e.getCurrentNodeLocations(),...e.initializationLinkChartConfig||{}}):yield e._calculateLayoutWithSublayerTimeInfo("organic-standard",{lockedNodeLocations:e.getCurrentNodeLocations()})})()}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateOrganicLayoutSettings(e,a){const t=E=>"number"==typeof E&&!isNaN(E),l=E=>t(E)&&E>=0,o={};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!a)return o;const{computationBudgetTime:M,autoRepulsionRadius:k,repulsionRadiusMultiplier:w,absoluteIdealEdgeLength:C,multiplicativeIdealEdgeLength:A,idealEdgeLengthType:W}=a;return t(E=M)&&E>=1?o.computationBudgetTime=M:M&&R.A.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),o.autoRepulsionRadius=k,!k&&(E=>t(E)&&E>=1)(w)?o.repulsionRadiusMultiplier=w:k||(o.autoRepulsionRadius=!0,R.A.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting")),"geographic-organic-standard"===e&&((E=>Object.values(j).includes(E))(W)?o.idealEdgeLengthType=W:void 0!==W&&R.A.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),"absolute-value"===W&&l(C)?o.absoluteIdealEdgeLength=C:"absolute-value"===W&&void 0!==C?R.A.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):"multiplier"===W&&l(A)?o.multiplicativeIdealEdgeLength=A:"multiplier"===W&&void 0!==A&&R.A.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),o;var E}_convertValidatedOrganicSettingsToCalculationSettings(e){let a=e.idealEdgeLengthType===j.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===j.ABSOLUTE&&(void 0===a?a=-1:a*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:a}}_createSublayer(e){return new f.A({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,a){a&&(a.forEach(t=>{t.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(t=>{t.parent=this}),this.addHandles([e.on("after-add",({item:t})=>{t.parent=this}),e.on("after-remove",({item:t})=>{t.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){const a=new Set((e.entityTypes??[]).map(i=>i.name).concat((e.relationshipTypes??[]).map(i=>i.name))),t=new Set((e.entityTypes??[]).map(i=>i.name)),r=new Set((e.relationshipTypes??[]).map(i=>i.name));if(this.layers){for(const n of this.layers)!n.graphType&&a.has(n.graphTypeName)&&(n.graphType=t.has(n.graphTypeName)?"entity":"relationship");const i=this.layers.filter(n=>a.has(n.graphTypeName)&&("entity"===n.graphType?t.has(n.graphTypeName):r.has(n.graphTypeName)));this.setAtOrigin("layers",i,(0,K.OL)(this.originIdOf("layers")))}else this.layers=new G.A;if(this.layers&&this._originalInclusionList){const i=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),n=this.tables?.map(M=>M.graphTypeName)??[],l=this.layers.map(M=>M.graphTypeName).concat(n);for(const M of l)i.has(M)||this._originalInclusionList.namedTypeDefinitions.set(M,{useAllData:!1,members:new Map});const o=[];for(const M of this._originalInclusionList.namedTypeDefinitions.keys())l.includes(M)||(R.A.getLogger(this).warn(`A named type, ${M}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),o.push(M));for(const M of o)this._originalInclusionList.namedTypeDefinitions.delete(M)}}};(0,T._)([(0,v.MZ)(Re.OZ)],S.prototype,"url",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"dataPreloadedInLocalCache",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"initializationLinkChartConfig",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"membershipModified",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"dataManager",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"initializationInclusionModeDefinition",null),(0,T._)([(0,v.MZ)()],S.prototype,"knowledgeGraph",void 0),(0,T._)([(0,v.MZ)({type:G.A.ofType(f.A),json:{write:{ignoreOrigin:!0}}})],S.prototype,"layers",void 0),(0,T._)([(0,v.MZ)({readOnly:!0})],S.prototype,"linkChart",null),(0,T._)([(0,v.MZ)()],S.prototype,"entityLinkChartDiagramLookup",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"linkChartExtent",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"memberEntityTypes",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"memberRelationshipTypes",void 0),(0,T._)([(0,v.MZ)({type:["LinkChartLayer"]})],S.prototype,"operationalLayerType",void 0),(0,T._)([(0,v.MZ)()],S.prototype,"sublayerIdsCache",void 0),(0,T._)([(0,v.MZ)({type:G.A.ofType(f.A),json:{write:{ignoreOrigin:!0}}})],S.prototype,"tables",void 0),(0,T._)([(0,v.MZ)({json:{read:!1}})],S.prototype,"type",void 0),(0,T._)([(0,v.MZ)({json:{read:!1}})],S.prototype,"chronologicalAuxiliaryGraphics",void 0),S=(0,T._)([(0,he.$)("esri.layers.LinkChartLayer")],S);const ze=S},17049:(Ge,de,y)=>{y.d(de,{q:()=>_});var g=y(8189),T=y(5922),ge=y(45272),G=y(85211),Y=y(55739),ye=(y(3248),y(40707),y(17221)),U=y(76576),Q=y(50305),v=y(50501),Ce=y(34813),Se=y(56558);const he={ArcGISAnnotationLayer:!0,ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CatalogLayer:!0,CSV:!0,GeoJSON:!0,GeoRSS:!0,GroupLayer:!0,KML:!0,KnowledgeGraphLayer:!0,MediaLayer:!0,OGCFeatureLayer:!0,OrientedImageryLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WCS:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},K={ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,OpenStreetMap:!0,VectorTileLayer:!0,WCS:!0,WMS:!0,WebTiledLayer:!0},ie={ArcGISFeatureLayer:!0,SubtypeGroupTable:!0},ne={"web-scene/operational-layers":{ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,CatalogLayer:!0,CSV:!0,GeoJSON:!0,GroupLayer:!0,IntegratedMesh3DTilesLayer:!0,Object3DTilesLayer:!0,IntegratedMeshLayer:!0,KML:!0,LineOfSightLayer:!0,MediaLayer:!0,OGCFeatureLayer:!0,OrientedImageryLayer:!0,PointCloudLayer:!0,RasterDataLayer:!0,VectorTileLayer:!0,ViewshedLayer:!0,Voxel:!0,WCS:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-scene/basemap":{ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WCS:!0,WMS:!0,WebTiledLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-scene/tables":{ArcGISFeatureLayer:!0},"web-map/operational-layers":he,"web-map/basemap":K,"web-map/tables":ie,"link-chart/operational-layers":{...he,LinkChartLayer:!0},"link-chart/basemap":K,"link-chart/tables":ie,"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,BuildingSceneLayer:!0,IntegratedMesh3DTilesLayer:!0,IntegratedMeshLayer:!0,MediaLayer:!0,OrientedImageryLayer:!0,PointCloudLayer:!0,SubtypeGroupLayer:!0,WCS:!0},"portal-item/tables":{ArcGISFeatureLayer:!0,SubtypeGroupTable:!0}};var re=y(22329),pe=y(17181);const _=j=>{let I=class extends j{constructor(){super(...arguments),this.persistenceEnabled=!0,this.title=null}readId(f,L,D){return"Group Layer"===D?.portalItem?.type?void 0:f}writeListMode(f,L,D,F){(F&&"ground"===F.layerContainerType||f&&(0,Se.R)(this,D,{},F))&&(L[D]=f)}writeOperationalLayerType(f,L,D){f&&(L[D]=f)}writeTitle(f,L){L.title=f??"Layer"}readVisibilityTimeExtent(f){return f?pe.A.fromArray(f):null}writeVisibilityTimeExtent(f,L,D,F){f&&"tables"!==F.layerContainerType&&(f.isEmpty?F?.messages&&F.messages.push(new T.A("layer:invalid-visibilityTimeExtent","visibilityTimeExtent cannot be empty")):L[D]=f.toArray())}read(f,L){L&&(L.layer=this),(0,Ce.t)(this,f,D=>super.read(f,D),L)}write(f,L){if(!this.persistenceEnabled&&!L?.ignorePersistenceEnabled)return null;if(L?.origin){const V=`${L.origin}/${L.layerContainerType||"operational-layers"}`;let oe=!!ne[V]?.[this.operationalLayerType];if("ArcGISTiledElevationServiceLayer"===this.operationalLayerType&&"web-scene/operational-layers"===V&&(oe=!1),"ArcGISDimensionLayer"===this.operationalLayerType&&"web-map/operational-layers"===V&&(oe=!1),!oe)return L.messages?.push(new T.A("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${V}'`,{layer:this})),null}const D=super.write(f,{...L,layer:this}),F=!!L&&!!L.messages&&!!L.messages.filter(V=>V instanceof T.A&&"web-document-write:property-required"===V.name).length;return(0,ge.w8)(D?.url)?(L?.messages?.push(new T.A("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&F?null:D}beforeSave(){}};return(0,g._)([(0,G.MZ)({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],I.prototype,"id",void 0),(0,g._)([(0,ye.w)("id",["id"])],I.prototype,"readId",null),(0,g._)([(0,G.MZ)(re.C1)],I.prototype,"listMode",void 0),(0,g._)([(0,Q.K)("listMode")],I.prototype,"writeListMode",null),(0,g._)([(0,G.MZ)({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1},"web-scene":{name:"layerType",read:!1,write:{enabled:!0,ignoreOrigin:!0,layerContainerTypes:v.K,isRequired:!0}}}}})],I.prototype,"operationalLayerType",void 0),(0,g._)([(0,Q.K)("operationalLayerType")],I.prototype,"writeOperationalLayerType",null),(0,g._)([(0,G.MZ)(re.ke)],I.prototype,"opacity",void 0),(0,g._)([(0,G.MZ)({type:Boolean,readOnly:!1})],I.prototype,"persistenceEnabled",void 0),(0,g._)([(0,G.MZ)({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],I.prototype,"title",void 0),(0,g._)([(0,Q.K)("title"),(0,Q.K)(["web-scene"],"title")],I.prototype,"writeTitle",null),(0,g._)([(0,G.MZ)({type:pe.A,json:{origins:{"web-scene":{write:{layerContainerTypes:v.K}}}}})],I.prototype,"visibilityTimeExtent",void 0),(0,g._)([(0,ye.w)("visibilityTimeExtent")],I.prototype,"readVisibilityTimeExtent",null),(0,g._)([(0,Q.K)(["portal-item","web-map","web-scene"],"visibilityTimeExtent",{visibilityTimeExtent:{type:[[Y.jz,Y.Uv]]}})],I.prototype,"writeVisibilityTimeExtent",null),(0,g._)([(0,G.MZ)({type:Boolean,json:{name:"visibility",write:{layerContainerTypes:v.K}}})],I.prototype,"visible",void 0),I=(0,g._)([(0,U.$)("esri.layers.mixins.OperationalLayer")],I),I}}}]);