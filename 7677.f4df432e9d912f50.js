"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[7677],{63583:(I,O,c)=>{var A,d;c.d(O,{u:()=>A}),(d=A||(A={}))[d.KILOBYTES=1024]="KILOBYTES",d[d.MEGABYTES=1048576]="MEGABYTES",d[d.GIGABYTES=1073741824]="GIGABYTES"},33087:(I,O,c)=>{c.d(O,{q:()=>d});var A=c(60611);class d{constructor(m,w){this._storage=new A.F,this.id="",this.name="",this.size=0,this._storage.maxSize=m,this._storage.register(this),w&&this._storage.registerRemoveFunc("",w)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(m,w,y=1){this._storage.put(this,m,w,y,1)}pop(m){return this._storage.pop(this,m)}get(m){return this._storage.get(this,m)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(m){this._storage.maxSize=m}resetHitRate(){}}},60611:(I,O,c)=>{c.d(O,{F:()=>y,Ti:()=>d});var A=c(12438);const d=-3,R=d-1;var m,b;(b=m||(m={}))[b.ALL=0]="ALL",b[b.SOME=1]="SOME";class y{get size(){return this._size}constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new A.A,this._users=new A.A}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear()}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(t=>t[0]!==e)}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,-1),this._checkSize()}getSize(e,t){return this._db.get(e.id+t)?.size??0}put(e,t,n,s,o){const r=this._db.get(t=e.id+t);if(r&&(this._size-=r.size,e.size-=r.size,this._db.delete(t),r.entry!==n&&this._notifyRemove(t,r.entry,r.size,m.ALL)),s>this._maxSize)return void this._notifyRemove(t,n,s,m.ALL);if(void 0===n)return void console.warn("Refusing to cache undefined entry ");if(!s||s<0)return console.warn(`Refusing to cache entry with size ${s} for key ${t}`),void this._notifyRemove(t,n,0,m.ALL);const _=1+Math.max(o,R)-d;this._db.set(t,new D(n,s,_)),this._size+=s,e.size+=s,this._checkSize()}updateSize(e,t,n,s){const o=this._db.get(t=e.id+t);if(o&&o.entry===n){for(this._size-=o.size,e.size-=o.size;s>this._maxSize;){const r=this._notifyRemove(t,n,s,m.SOME);if(!(null!=r&&r>0))return void this._db.delete(t);s=r}o.size=s,this._size+=s,e.size+=s,this._checkSize()}}pop(e,t){const n=this._db.get(t=e.id+t);if(n)return this._size-=n.size,e.size-=n.size,this._db.delete(t),++this._hit,n.entry;++this._miss}get(e,t){const n=this._db.get(t=e.id+t);if(void 0!==n)return this._db.delete(t),n.lives=n.lifetime,this._db.set(t,n),++this._hit,n.entry;++this._miss}peek(e,t){const n=this._db.get(e.id+t);return n?++this._hit:++this._miss,n?.entry}get performanceInfo(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},n=new Array;this._db.forEach((r,_)=>{const P=r.lifetime;n[P]=(n[P]||0)+r.size,this._users.forAll(C=>{const{id:F,name:U}=C;_.startsWith(F)&&(t[U]=(t[U]||0)+r.size)})});const s={};this._users.forAll(r=>{const _=r.name;"hitRate"in r&&"number"==typeof r.hitRate&&!isNaN(r.hitRate)&&r.hitRate>0?(t[_]=t[_]||0,s[_]=Math.round(100*r.hitRate)+"%"):s[_]="0%"});const o=Object.keys(t);o.sort((r,_)=>t[_]-t[r]),o.forEach(r=>e[r]=Math.round(t[r]/2**20)+"MB / "+s[r]);for(let r=n.length-1;r>=0;--r){const _=n[r];_&&(e["Priority "+(r+d-1)]=Math.round(_/this._size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){const t=e.id;this._db.forEach((n,s)=>{s.startsWith(t)&&(this._size-=n.size,this._db.delete(s),this._notifyRemove(s,n.entry,n.size,m.ALL))}),e.size=0}clearAll(){this._db.forEach((e,t)=>this._notifyRemove(t,e.entry,e.size,m.ALL)),this._users.forAll(e=>e.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,t,n,s){let o;return this._removeFuncs.some(r=>{if(e.startsWith(r[0])){const _=r[1](t,s,n);return"number"==typeof _&&(o=_),!0}return!1}),o}_checkSize(){this._users.forAll(e=>this._checkSizeLimits(e)),this._checkSizeLimits()}_checkSizeLimits(e){const t=e??this;if(t.maxSize<0||t.size<=t.maxSize)return;const n=e?.id;let s=!0;for(;s;){s=!1;for(const[o,r]of this._db)if(0===r.lifetime&&(!n||o.startsWith(n))){if(this._purgeItem(o,r,e),t.size<=.9*t.maxSize)return;s||=this._db.has(o)}}for(const[o,r]of this._db)if((!n||o.startsWith(n))&&(this._purgeItem(o,r,e),t.size<=.9*t.maxSize))return}_purgeItem(e,t,n=this._users.find(s=>e.startsWith(s.id))){if(this._db.delete(e),t.lives<=1){this._size-=t.size,n&&(n.size-=t.size);const s=this._notifyRemove(e,t.entry,t.size,m.SOME);null!=s&&s>0&&(this._size+=s,n&&(n.size+=s),t.lives=t.lifetime,t.size=s,this._db.set(e,t))}else--t.lives,this._db.set(e,t)}}class D{constructor(e,t,n){this.entry=e,this.size=t,this.lifetime=n,this.lives=n}}},11445:(I,O,c)=>{c.d(O,{Qf:()=>D,Qh:()=>w,RS:()=>R,ez:()=>t,i5:()=>n,lM:()=>m,qK:()=>e});var A=c(79139);const R=16;function m(s){if(!s)return 0;let o=e;for(const r in s)s.hasOwnProperty(r)&&(o+=x(s[r],!1));return o}function w(s){if(!s)return 0;if("number"==typeof s[0])return D(s);if(Array.isArray(s))return function y(s){const o=s.length;if(0===o||"number"==typeof s[0])return b(s,8);let r=t;for(let _=0;_<o;_++)r+=x(s[_]);return r}(s);let o=e;for(const r in s)s.hasOwnProperty(r)&&(o+=x(s[r]));return o}function x(s,o=!0){switch(typeof s){case"object":return o?w(s):e;case"string":return function d(s){return 32+s.length}(s);case"number":return R;case"boolean":return 4;default:return 8}}function D(...s){return s.reduce((o,r)=>o+(r?(0,A.iu)(r)?r.byteLength+n:Array.isArray(r)?b(r,R):0:0),0)}function b(s,o){return t+s.length*o}const e=32,t=16,n=145},77677:(I,O,c)=>{c.d(O,{d:()=>M});var E,A=c(10467),d=c(8189),R=c(89563),m=c(98877),w=c(63583),y=c(5922),x=c(17715),b=(c(3248),c(33087)),e=c(12438),t=c(56492),n=c(48900),s=c(3804),o=c(45272),r=c(85211),C=(c(35150),c(40707),c(76576)),F=c(25858),U=c(77806),B=c(11445),W=c(79139);class ${constructor(a){!function N(i){if(!i?.location)throw new y.A("tilemap:missing-location","Location missing from tilemap response");if(!1===i.valid)throw new y.A("tilemap:invalid","Tilemap response was marked as invalid");if(!i.data)throw new y.A("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(i.data))throw new y.A("tilemap:data-mismatch","Data must be an array of numbers");if(i.data.length!==i.location.width*i.location.height)throw new y.A("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}(a);const{location:l,data:h}=a;this.location=Object.freeze((0,U.o8)(l));let v=!0,p=!0;const f=function k(i,a=!1){return i<=W.y9?a?new Array(i).fill(0):new Array(i):new Uint32Array(i)}(Math.ceil(this.location.width*this.location.height/32));let L=0;for(let S=0;S<h.length;S++){const T=S%32;h[S]?(p=!1,f[L]|=1<<T):v=!1,31===T&&++L}p?(this._availability="unavailable",this.byteSize=40):v?(this._availability="available",this.byteSize=40):(this._availability=f,this.byteSize=40+(0,B.Qf)(f))}getAvailability(a,l){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const h=(a-this.location.top)*this.location.width+(l-this.location.left),g=h>>5,v=this._availability;return g<0||g>v.length?"unknown":v[g]&1<<h%32?"available":"unavailable"}static fromDefinition(a,l){const h=a.service.request||R.A,{row:u,col:g,width:v,height:p}=a,z={query:{f:"json"}};return l=l?{...z,...l}:z,h(function Y(i){let a;if(i.service.tileServers?.length){const h=i.service.tileServers;a=`${h&&h.length?h[i.row%h.length]:i.service.url}/tilemap/${i.level}/${i.row}/${i.col}/${i.width}/${i.height}`}else a=`${i.service.url}/tilemap/${i.level}/${i.row}/${i.col}/${i.width}/${i.height}`;const l=i.service.query;return l&&(a=`${a}?${l}`),a}(a),l).then(f=>f.data).catch(f=>{if(422===f?.details?.httpStatus)return{location:{top:u,left:g,width:v,height:p},valid:!0,data:new Array(v*p).fill(0)};throw f}).then(f=>{if(f.location&&(f.location.top!==u||f.location.left!==g||f.location.width!==v||f.location.height!==p))throw new y.A("tilemap:location-mismatch","Tilemap response for different location than requested",{response:f,definition:{top:u,left:g,width:v,height:p}});return $.fromJSON(f)})}static fromJSON(a){return Object.freeze(new $(a))}}function G(i){return`${i.level}/${i.row}/${i.col}/${i.width}/${i.height}`}function H(i,a,l){return new y.A("tile-map:tile-unavailable","Tile is not available",{level:i,row:a,col:l})}let M=E=class extends m.A{constructor(i){super(i),this._pendingTilemapRequests={},this.request=R.A,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new b.q(2*w.u.MEGABYTES),this.addHandles((0,n.wB)(()=>{const{layer:i}=this;return[i?.parsedUrl,i?.tileServers,i?.apiKey,i?.customParameters]},()=>this._initializeTilemapDefinition(),n.Vh))}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}getAvailability(i,a,l){if(!this.layer.tileInfo.lodAt(i)||i<this.effectiveMinLOD||i>this.effectiveMaxLOD)return"unavailable";const h=this._tilemapFromCache(i,a,l,this._tmpTilemapDefinition);return h?h.getAvailability(a,l):"unknown"}fetchAvailability(i,a,l,h){return!this.layer.tileInfo.lodAt(i)||i<this.effectiveMinLOD||i>this.effectiveMaxLOD?Promise.reject(H(i,a,l)):this._fetchTilemap(i,a,l,h).catch(u=>u).then(u=>{if(u instanceof $){const g=u.getAvailability(a,l);if("unavailable"===g)throw H(i,a,l);return g}if((0,t.zf)(u))throw u;return"unknown"})}fetchAvailabilityUpsample(i,a,l,h,u){h.level=i,h.row=a,h.col=l;const g=this.layer.tileInfo;g.updateTileInfo(h);const v=this.fetchAvailability(i,a,l,u).catch(p=>{if((0,t.zf)(p))throw p;if(g.upsampleTile(h))return this.fetchAvailabilityUpsample(h.level,h.row,h.col,h,u);throw p});return this._fetchAvailabilityUpsamplePrefetch(h.id,i,a,l,u,v),v}_fetchAvailabilityUpsamplePrefetch(i,a,l,h,u,g){var v=this;return(0,A.A)(function*(){if(!v._prefetchingEnabled||null==i)return;const p=`prefetch-${i}`;if(v.hasHandles(p))return;const z=new AbortController;g.then(()=>z.abort(),()=>z.abort());let f=!1;const L=(0,x.hA)(()=>{f||(f=!0,z.abort())});if(v.addHandles(L,p),yield(0,s.md)(10,z.signal).catch(()=>{}),f||(f=!0,v.removeHandles(p)),(0,t.G4)(z))return;const S=new F.U(i,a,l,h),T={...u,signal:z.signal},Z=v.layer.tileInfo;for(let Q=0;E._prefetches.length<E._maxPrefetch&&Z.upsampleTile(S);++Q){const j=v.fetchAvailability(S.level,S.row,S.col,T);E._prefetches.push(j);const K=()=>{E._prefetches.removeUnordered(j)};j.then(K,K)}})()}_fetchTilemap(i,a,l,h){if(!this.layer.tileInfo.lodAt(i)||i<this.effectiveMinLOD||i>this.effectiveMaxLOD)return Promise.reject(new y.A("tilemap-cache:level-unavailable",`Level ${i} is unavailable in the service`));const u=this._tmpTilemapDefinition,g=this._tilemapFromCache(i,a,l,u);if(g)return Promise.resolve(g);const v=h?.signal;return h={...h,signal:null},new Promise((p,z)=>{(0,t.u7)(v,()=>z((0,t.NK)()));const f=G(u);let L=this._pendingTilemapRequests[f];if(!L){L=$.fromDefinition(u,h).then(T=>(this._tilemapCache.put(f,T,T.byteSize),T));const S=()=>{delete this._pendingTilemapRequests[f]};this._pendingTilemapRequests[f]=L,L.then(S,S)}L.then(p,z)})}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const{parsedUrl:i,apiKey:a,customParameters:l}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:i.path,query:(0,o.x0)({...i.query,...l,token:a??i.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(i,a,l,h){h.level=i,h.row=a-a%this.size,h.col=l-l%this.size;const u=G(h);return this._tilemapCache.get(u)}get test(){}};M._maxPrefetch=4,M._prefetches=new e.A({initialSize:E._maxPrefetch}),(0,d._)([(0,r.MZ)({constructOnly:!0})],M.prototype,"layer",void 0),(0,d._)([(0,r.MZ)({constructOnly:!0})],M.prototype,"minLOD",void 0),(0,d._)([(0,r.MZ)({constructOnly:!0})],M.prototype,"maxLOD",void 0),(0,d._)([(0,r.MZ)({constructOnly:!0})],M.prototype,"request",void 0),(0,d._)([(0,r.MZ)({constructOnly:!0})],M.prototype,"size",void 0),M=E=(0,d._)([(0,C.$)("esri.layers.support.TilemapCache")],M)}}]);