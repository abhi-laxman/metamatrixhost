"use strict";(self.webpackChunkAngularClient=self.webpackChunkAngularClient||[]).push([[916],{20916:(R,f,a)=>{a.r(f),a.d(f,{default:()=>H});var l=a(10467),n=a(8189),m=a(42139),c=a(31178),D=a(5922),u=a(35150),g=a(60797),P=a(39693),y=a(56492),M=a(48900),L=a(45272),S=a(43085),_=a(85211),U=(a(3248),a(40707),a(17221)),j=a(76576),K=a(50305),p=a(26514),b=a(95478),B=a(55540),E=a(85574),v=a(43326),W=a(25936),w=a(93410),G=a(23e3),N=a(17049),x=a(85551),Z=a(1151),z=a(33036),F=a(22329),$=a(4965),T=a(88135);let r=class extends((0,w.dM)((0,z.j)((0,Z.J)((0,W.b)((0,N.q)((0,x.A)((0,P.P)((0,G.d)(b.A))))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(c.A.ofType(E.A)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(c.A.ofType(E.A)),this.type="knowledge-graph",this.url=null,this.addHandles((0,M.wB)(()=>this.layers.concat(this.tables),(t,s)=>this._handleSublayersChange(t,s),M.OH))}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}_doLoad(e){var t=this;return(0,l.A)(function*(){try{yield t.loadFromPortal({supportedTypes:["Knowledge Graph Layer"]},e)}catch(s){(0,y.QP)(s)}yield t._fetchMetadata(),yield t._initializeLayerProperties(),t.loadLayerAssumingLocalCache(),t._layersLoadedFromAuthoritativeItem()||(yield(0,v.qN)(t))})()}_fetchMetadata(){var e=this;return(0,l.A)(function*(){if(!e.url)throw new D.A("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");const t=yield(0,$.fetchKnowledgeGraph)(e.url);e.knowledgeGraph=t,e._forEachGraphType(s=>{s.name&&e._graphTypeLookup.set(s.name,s)})})()}_initializeLayerProperties(){var e=this;return(0,l.A)(function*(){e.originIdOf("inclusionModeDefinition")===p.Gr.USER?e._validateInclusionModeDefinition():yield e._initializeInclusionModeDefinition(),e._setMemberTypes(),e.dataManager=new B.P({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition})})()}_initializeInclusionModeDefinition(){var e=this;return(0,l.A)(function*(){const t=e.definitionSetMap?yield(0,m.cZ)(e.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...e.layers.toArray(),...e.tables.toArray()].forEach(s=>{const i=e._graphTypeLookup.get(s.graphTypeName);i&&!t.namedTypeDefinitions.has(i.name)&&t.namedTypeDefinitions.set(i.name,{useAllData:!0})}),e.setAtOrigin("inclusionModeDefinition",t,(0,p.OL)(e.originIdOf("definitionSetMap")))})()}_validateInclusionModeDefinition(){const{inclusionModeDefinition:e}=this;if(!e)return;const{namedTypeDefinitions:t}=e;if(t?.size>0)t.forEach((s,i)=>{const o=this._graphTypeLookup.get(i);if(!o)return u.A.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void t.delete(i);"relationship"!==o.type&&"entity"!==o.type&&(u.A.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't properly modeled and will be removed`),t.delete(i))});else if(!e.generateAllSublayers)throw new D.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){let e=[],t=[];const{inclusionModeDefinition:s}=this,i=s?.namedTypeDefinitions;!s||s.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],t=this.knowledgeGraph.dataModel?.relationshipTypes??[]):i&&i.size>0&&i.forEach((o,h)=>{const d=this._graphTypeLookup.get(h);switch(d?.type){case"relationship":t.push(d);break;case"entity":e.push(d)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=t}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(t=>{e(t)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_handleNewRecords(e){var t=this;return(0,l.A)(function*(){const s=[];t.dataManager.addToLayer(e);for(const i of e)t.sublayerIdsCache.has(i.typeName)||(t.sublayerIdsCache.set(i.typeName,new Set),s.push(i.typeName)),t.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of s){const o=t._graphTypeLookup.get(i);o&&(t._addSublayer(o),"entity"===o.type?t.dataManager.entityTypeNames.add(i):t.dataManager.relationshipTypeNames.add(i),t.dataManager.sublayerCaches.set(i,new Map))}yield(0,v.qN)(t,s),t._refreshNamedTypes()})()}_createSublayers(e,t,s){e.forEach(i=>{const o=this._createSublayer(i);s(o)&&t.push(o),this._updateSublayerCaches(i)})}_addSublayer(e){const t=this._createSublayer(e);return t.geometryType?this.layers.push(t):this.tables.push(t),t}_createSublayer(e){return new E.A({objectType:e,parentCompositeLayer:this,graphType:e.type})}_updateSublayers(e,t){t.forEach(s=>{s.parentCompositeLayer=this;const i=e.find(o=>o.type===s.graphType&&o.name===s.graphTypeName);i&&(s.objectType=i,this._updateSublayerCaches(i))})}_updateSublayerCaches(e){const t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}_saveUrlAsNewResource(e,t,s,i){e[t]="<pending>",s.pendingOperations.push(function J(e){return O.apply(this,arguments)}(this.inclusionModeDefinition).then(o=>{const h=function Q(e){const t=`definitionSetMap-${(0,S.lk)()}.dat`,s=(0,L.fj)("knowledgeGraphLayer",t);return e.resourceFromPath(s)}(i);e[t]=h.itemRelativeUrl,s.toAdd.push({resource:h,content:{type:"blob",blob:o},compress:!1,finish:d=>{this.definitionSetMap=d.url}})}))}_displaysAllRecords(e){for(const[,{useAllData:t}]of e.namedTypeDefinitions)if(!t)return!1;return!0}_handleSublayersChange(e,t){t&&(t.forEach(s=>{s.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(s=>{s.parent=this}),this.addHandles([e.on("after-add",({item:s})=>{s.parent=this}),e.on("after-remove",({item:s})=>{s.parent=null})],"sublayers-owner"))}_layersLoadedFromAuthoritativeItem(){const e=this.originIdOf("layers");return e>=p.Gr.PORTAL_ITEM&&e<p.Gr.USER}readDefinitionSetMap(e,t,s){return(0,T.f)(e,s)}writeDefinitionSetMap(e,t,s,i){const o=i?.portalItem,h=i?.resources,d=(0,p.aB)(i?.origin);if(!o||!h||null==d)return void(e&&(t[s]=(0,T.t)(e,i)));const{inclusionModeDefinition:C}=this;if(!C||this._displaysAllRecords(C))return void(this.definitionSetMap=null);const A=this.originIdOf("inclusionModeDefinition");if(A===p.Gr.USER||this._namedTypesModified||d<A)this._saveUrlAsNewResource(t,s,h,o);else if(d===A&&e){const I=(0,T.t)(e,i);(0,L.oP)(I)?this._saveUrlAsNewResource(t,s,h,o):t[s]=I}}set inclusionModeDefinition(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("inclusionModeDefinition",e):u.A.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){const e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===p.Gr.DEFAULTS?this._createSublayers(e,this.layers,t=>!!t.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===p.Gr.DEFAULTS?this._createSublayers(e,this.tables,t=>!t.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,s)=>{const i=(0,g.tE)(this.sublayerIdsCache,s,()=>new Set);t.members?.forEach(o=>{i.add(o.id)})})}addRecords(e){var t=this;return(0,l.A)(function*(){yield t.load(),yield t._handleNewRecords(e)})()}removeRecords(e){var t=this;return(0,l.A)(function*(){yield t.load();const s=[];for(const i of e)!1===t.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.useAllData&&t.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.members?.has(i.id)&&s.push(i);t.dataManager.removeFromLayer(s);for(const i of s)t.sublayerIdsCache.get(i.typeName)?.delete(i.id);return t._refreshNamedTypes(),s})()}};(0,n._)([(0,_.MZ)()],r.prototype,"dataManager",void 0),(0,n._)([(0,_.MZ)({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],r.prototype,"definitionSetMap",void 0),(0,n._)([(0,U.w)("definitionSetMap")],r.prototype,"readDefinitionSetMap",null),(0,n._)([(0,K.K)("definitionSetMap")],r.prototype,"writeDefinitionSetMap",null),(0,n._)([(0,_.MZ)()],r.prototype,"inclusionModeDefinition",null),(0,n._)([(0,_.MZ)()],r.prototype,"knowledgeGraph",void 0),(0,n._)([(0,_.MZ)({type:c.A.ofType(E.A),json:{write:{ignoreOrigin:!0}}})],r.prototype,"layers",void 0),(0,n._)([(0,_.MZ)()],r.prototype,"memberEntityTypes",void 0),(0,n._)([(0,_.MZ)()],r.prototype,"memberRelationshipTypes",void 0),(0,n._)([(0,_.MZ)({type:["KnowledgeGraphLayer"]})],r.prototype,"operationalLayerType",void 0),(0,n._)([(0,_.MZ)()],r.prototype,"sublayerIdsCache",void 0),(0,n._)([(0,_.MZ)({type:c.A.ofType(E.A),json:{write:{ignoreOrigin:!0}}})],r.prototype,"tables",void 0),(0,n._)([(0,_.MZ)({json:{read:!1}})],r.prototype,"type",void 0),(0,n._)([(0,_.MZ)(F.OZ)],r.prototype,"url",void 0),r=(0,n._)([(0,j.$)("esri.layers.KnowledgeGraphLayer")],r);const H=r;function O(){return(O=(0,l.A)(function*(e){const t=yield(0,m.fe)(e);return new Blob([t],{type:"application/x-protobuf"})})).apply(this,arguments)}},23e3:(R,f,a)=>{a.d(f,{d:()=>g});var l=a(8189),n=a(85211),u=(a(3248),a(35150),a(40707),a(76576));const g=P=>{let y=class extends P{constructor(){super(...arguments),this.customParameters=null}};return(0,l._)([(0,n.MZ)({type:Object,json:{write:{overridePolicy:M=>({enabled:!!(M&&Object.keys(M).length>0)})}}})],y.prototype,"customParameters",void 0),y=(0,l._)([(0,u.$)("esri.layers.mixins.CustomParametersMixin")],y),y}}}]);